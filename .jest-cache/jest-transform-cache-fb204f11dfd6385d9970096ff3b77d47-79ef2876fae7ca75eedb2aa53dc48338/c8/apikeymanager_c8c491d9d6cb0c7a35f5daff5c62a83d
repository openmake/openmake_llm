705e6ae8b95bed05f19e3cc33aff3ed9
"use strict";
/**
 * API Key Manager with Automatic Multi-Key Rotation
 * üÜï Î¨¥Ï†úÌïú API ÌÇ§ ÏûêÎèô ÏàúÌôò Î°úÏßÅ (OLLAMA_API_KEY_1, _2, _3, ... _N)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApiKeyManager = void 0;
exports.getApiKeyManager = getApiKeyManager;
exports.resetApiKeyManager = resetApiKeyManager;
class ApiKeyManager {
    constructor(config) {
        this.keys = [];
        this.currentKeyIndex = 0;
        this.failureCount = 0;
        this.maxFailures = 2; // Îçî Îπ†Î•∏ Ïä§ÏôÄÌïë
        this.lastFailoverTime = null;
        this.keyFailures = new Map();
        // üÜï ÌôòÍ≤ΩÎ≥ÄÏàòÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Î™®Îì† API ÌÇ§ Î°úÎìú (OLLAMA_API_KEY_1, _2, _3, ... _N)
        if ((config === null || config === void 0 ? void 0 : config.keys) && config.keys.length > 0) {
            this.keys = config.keys.filter(k => k && k.trim() !== '');
        }
        else {
            this.keys = this.loadKeysFromEnv();
        }
        this.sshKey = (config === null || config === void 0 ? void 0 : config.sshKey) || process.env.OLLAMA_SSH_KEY;
        console.log(`[ApiKeyManager] üîë Ï¥àÍ∏∞ÌôîÎê® - ${this.keys.length}Í∞ú API ÌÇ§ Îì±Î°ù`);
        this.keys.forEach((key, idx) => {
            const masked = key.substring(0, 8) + '...' + key.substring(key.length - 4);
            console.log(`[ApiKeyManager]   Key ${idx + 1}: ${masked}`);
        });
        console.log(`[ApiKeyManager] SSH Key: ${this.sshKey ? 'ÏÑ§Ï†ïÎê®' : 'ÏóÜÏùå'}`);
    }
    /**
     * üÜï ÌôòÍ≤ΩÎ≥ÄÏàòÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú API ÌÇ§ Î°úÎìú
     * OLLAMA_API_KEY_1, OLLAMA_API_KEY_2, ... OLLAMA_API_KEY_N ÏàúÏÑúÎ°ú ÌÉêÏÉâ
     * Î†àÍ±∞Ïãú ÏßÄÏõê: OLLAMA_API_KEY_PRIMARY, OLLAMA_API_KEY_SECONDARY
     */
    loadKeysFromEnv() {
        const keys = [];
        // ÏÉàÎ°úÏö¥ ÌòïÏãù: OLLAMA_API_KEY_1, _2, _3, ... (Î¨¥Ï†úÌïú)
        let index = 1;
        while (true) {
            const key = process.env[`OLLAMA_API_KEY_${index}`];
            if (key && key.trim() !== '') {
                keys.push(key.trim());
                index++;
            }
            else {
                break;
            }
        }
        // Î†àÍ±∞Ïãú ÌòïÏãù ÏßÄÏõê (ÏÉà ÌòïÏãùÏóê ÌÇ§Í∞Ä ÏóÜÏùÑ ÎïåÎßå)
        if (keys.length === 0) {
            const primary = process.env.OLLAMA_API_KEY_PRIMARY || process.env.OLLAMA_API_KEY;
            const secondary = process.env.OLLAMA_API_KEY_SECONDARY;
            if (primary && primary.trim() !== '')
                keys.push(primary.trim());
            if (secondary && secondary.trim() !== '')
                keys.push(secondary.trim());
        }
        return keys;
    }
    /**
     * ÌòÑÏû¨ ÏÇ¨Ïö©Ìï† API ÌÇ§ Î∞òÌôò
     */
    getCurrentKey() {
        if (this.keys.length === 0)
            return '';
        return this.keys[this.currentKeyIndex];
    }
    /**
     * ÌòÑÏû¨ ÌÇ§ Ïù∏Îç±Ïä§ Î∞òÌôò
     */
    getCurrentKeyIndex() {
        return this.currentKeyIndex;
    }
    /**
     * Ï†ÑÏ≤¥ ÌÇ§ Í∞úÏàò Î∞òÌôò
     */
    getTotalKeys() {
        return this.keys.length;
    }
    /**
     * API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
     */
    hasValidKey() {
        return this.keys.length > 0;
    }
    /**
     * SSH ÌÇ§ Î∞òÌôò
     */
    getSshKey() {
        return this.sshKey;
    }
    /**
     * ÏöîÏ≤≠ ÏÑ±Í≥µ Ïãú Ìò∏Ï∂ú
     */
    reportSuccess() {
        this.failureCount = 0;
        // ÌòÑÏû¨ ÌÇ§Ïùò Ïã§Ìå® Í∏∞Î°ù Ï¥àÍ∏∞Ìôî
        this.keyFailures.delete(this.currentKeyIndex);
    }
    /**
     * ÏöîÏ≤≠ Ïã§Ìå® Ïãú Ìò∏Ï∂ú - ÏûêÎèô Î°úÌÖåÏù¥ÏÖò Ï≤òÎ¶¨
     */
    reportFailure(error) {
        var _a;
        this.failureCount++;
        const errorCode = ((_a = error === null || error === void 0 ? void 0 : error.response) === null || _a === void 0 ? void 0 : _a.status) || (error === null || error === void 0 ? void 0 : error.code) || 'unknown';
        // ÌòÑÏû¨ ÌÇ§Ïùò Ïã§Ìå® Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        const currentFailure = this.keyFailures.get(this.currentKeyIndex) || { count: 0, lastFail: new Date() };
        currentFailure.count++;
        currentFailure.lastFail = new Date();
        this.keyFailures.set(this.currentKeyIndex, currentFailure);
        const masked = this.getCurrentKey().substring(0, 8) + '...';
        console.warn(`[ApiKeyManager] ‚ö†Ô∏è Key ${this.currentKeyIndex + 1} (${masked}) Ïã§Ìå® - ÏΩîÎìú: ${errorCode}`);
        // Ïù∏Ï¶ù Í¥ÄÎ†® ÏóêÎü¨Ïù∏ Í≤ΩÏö∞ Ï¶âÏãú Îã§Ïùå ÌÇ§Î°ú Ï†ÑÌôò
        const isAuthError = errorCode === 401 || errorCode === 403 || errorCode === 429;
        if (this.failureCount >= this.maxFailures || isAuthError) {
            return this.rotateToNextKey();
        }
        return false;
    }
    /**
     * Îã§Ïùå ÌÇ§Î°ú ÏàúÌôò
     */
    rotateToNextKey() {
        if (this.keys.length <= 1) {
            console.error(`[ApiKeyManager] ‚ùå ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Îã§Î•∏ ÌÇ§Í∞Ä ÏóÜÏäµÎãàÎã§.`);
            return false;
        }
        const previousIndex = this.currentKeyIndex;
        // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Îã§Ïùå ÌÇ§ Ï∞æÍ∏∞ (ÏµúÍ∑º Ïã§Ìå® Í∏∞Î°ùÏù¥ ÏóÜÎäî ÌÇ§ Ïö∞ÏÑ†)
        let nextIndex = (this.currentKeyIndex + 1) % this.keys.length;
        let attempts = 0;
        while (attempts < this.keys.length) {
            const failureRecord = this.keyFailures.get(nextIndex);
            // Ïã§Ìå® Í∏∞Î°ùÏù¥ ÏóÜÍ±∞ÎÇò 5Î∂Ñ Ïù¥ÏÉÅ ÏßÄÎÇú ÌÇ§ Ï∞æÍ∏∞
            if (!failureRecord || (Date.now() - failureRecord.lastFail.getTime() > 5 * 60 * 1000)) {
                break;
            }
            nextIndex = (nextIndex + 1) % this.keys.length;
            attempts++;
        }
        this.currentKeyIndex = nextIndex;
        this.failureCount = 0;
        this.lastFailoverTime = new Date();
        const previousMasked = this.keys[previousIndex].substring(0, 8) + '...';
        const newMasked = this.getCurrentKey().substring(0, 8) + '...';
        console.log(`[ApiKeyManager] üîÑ ÌÇ§ Ï†ÑÌôò: Key ${previousIndex + 1} (${previousMasked}) ‚Üí Key ${nextIndex + 1} (${newMasked})`);
        return true;
    }
    /**
     * Ï≤´ Î≤àÏß∏ ÌÇ§Î°ú Î¶¨ÏÖã
     */
    reset() {
        this.currentKeyIndex = 0;
        this.failureCount = 0;
        this.lastFailoverTime = null;
        this.keyFailures.clear();
        console.log(`[ApiKeyManager] üîÑ Key 1ÏúºÎ°ú Î¶¨ÏÖãÎê®`);
    }
    /**
     * ÌòÑÏû¨ ÏÉÅÌÉú Ï°∞Ìöå
     */
    getStatus() {
        const keyStatuses = this.keys.map((_, idx) => {
            const failure = this.keyFailures.get(idx);
            return {
                index: idx,
                failCount: (failure === null || failure === void 0 ? void 0 : failure.count) || 0,
                lastFail: (failure === null || failure === void 0 ? void 0 : failure.lastFail) || null
            };
        });
        return {
            activeKeyIndex: this.currentKeyIndex,
            totalKeys: this.keys.length,
            failures: this.failureCount,
            lastFailover: this.lastFailoverTime,
            keyStatuses
        };
    }
    /**
     * Authorization Ìó§Îçî ÏÉùÏÑ±
     */
    getAuthHeaders() {
        const key = this.getCurrentKey();
        if (!key)
            return {};
        return {
            'Authorization': `Bearer ${key}`
        };
    }
}
exports.ApiKeyManager = ApiKeyManager;
// Ïã±Í∏ÄÌÜ§ Ïù∏Ïä§ÌÑ¥Ïä§
let apiKeyManager = null;
function getApiKeyManager() {
    if (!apiKeyManager) {
        apiKeyManager = new ApiKeyManager();
    }
    return apiKeyManager;
}
function resetApiKeyManager() {
    apiKeyManager = null;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL29sbGFtYS9hcGkta2V5LW1hbmFnZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBc09ILDRDQUtDO0FBRUQsZ0RBRUM7QUF4T0QsTUFBYSxhQUFhO0lBU3RCLFlBQVksTUFBOEI7UUFSbEMsU0FBSSxHQUFhLEVBQUUsQ0FBQztRQUNwQixvQkFBZSxHQUFHLENBQUMsQ0FBQztRQUVwQixpQkFBWSxHQUFHLENBQUMsQ0FBQztRQUNSLGdCQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUUsV0FBVztRQUN0QyxxQkFBZ0IsR0FBZ0IsSUFBSSxDQUFDO1FBQ3JDLGdCQUFXLEdBQW1ELElBQUksR0FBRyxFQUFFLENBQUM7UUFHNUUsZ0VBQWdFO1FBQ2hFLElBQUksQ0FBQSxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsSUFBSSxLQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3pDLElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzlELENBQUM7YUFBTSxDQUFDO1lBQ0osSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDdkMsQ0FBQztRQUVELElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQSxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsTUFBTSxLQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDO1FBRTNELE9BQU8sQ0FBQyxHQUFHLENBQUMsNkJBQTZCLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxZQUFZLENBQUMsQ0FBQztRQUN2RSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFH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QUFJLENBQUMsTUFBTTtZQUMzQixRQUFRLEVBQUUsSUFBSSxDQUFDLFlBQVk7WUFDM0IsWUFBWSxFQUFFLElBQUksQ0FBQyxnQkFBZ0I7WUFDbkMsV0FBVztTQUNkLENBQUM7SUFDTixDQUFDO0lBRUQ7O09BRUc7SUFDSCxjQUFjO1FBQ1YsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxHQUFHO1lBQUUsT0FBTyxFQUFFLENBQUM7UUFFcEIsT0FBTztZQUNILGVBQWUsRUFBRSxVQUFVLEdBQUcsRUFBRTtTQUNuQyxDQUFDO0lBQ04sQ0FBQztDQUNKO0FBMU5ELHNDQTBOQztBQUVELFdBQVc7QUFDWCxJQUFJLGFBQWEsR0FBeUIsSUFBSSxDQUFDO0FBRS9DLFNBQWdCLGdCQUFnQjtJQUM1QixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDakIsYUFBYSxHQUFHLElBQUksYUFBYSxFQUFFLENBQUM7SUFDeEMsQ0FBQztJQUNELE9BQU8sYUFBYSxDQUFDO0FBQ3pCLENBQUM7QUFFRCxTQUFnQixrQkFBa0I7SUFDOUIsYUFBYSxHQUFHLElBQUksQ0FBQztBQUN6QixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Wb2x1bWVzL01BQ19BUFAvb3Blbm1ha2VfbGxtL2JhY2tlbmQvYXBpL3NyYy9vbGxhbWEvYXBpLWtleS1tYW5hZ2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQVBJIEtleSBNYW5hZ2VyIHdpdGggQXV0b21hdGljIE11bHRpLUtleSBSb3RhdGlvblxuICog8J+GlSDrrLTsoJztlZwgQVBJIO2CpCDsnpDrj5kg7Iic7ZmYIOuhnOyngSAoT0xMQU1BX0FQSV9LRVlfMSwgXzIsIF8zLCAuLi4gX04pXG4gKi9cblxuZXhwb3J0IGludGVyZmFjZSBBcGlLZXlDb25maWcge1xuICAgIGtleXM6IHN0cmluZ1tdO1xuICAgIHNzaEtleT86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIEFwaUtleU1hbmFnZXIge1xuICAgIHByaXZhdGUga2V5czogc3RyaW5nW10gPSBbXTtcbiAgICBwcml2YXRlIGN1cnJlbnRLZXlJbmRleCA9IDA7XG4gICAgcHJpdmF0ZSBzc2hLZXk6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBwcml2YXRlIGZhaWx1cmVDb3VudCA9IDA7XG4gICAgcHJpdmF0ZSByZWFkb25seSBtYXhGYWlsdXJlcyA9IDI7ICAvLyDrjZQg67mg66W4IOyKpOyZgO2VkVxuICAgIHByaXZhdGUgbGFzdEZhaWxvdmVyVGltZTogRGF0ZSB8IG51bGwgPSBudWxsO1xuICAgIHByaXZhdGUga2V5RmFpbHVyZXM6IE1hcDxudW1iZXIsIHsgY291bnQ6IG51bWJlcjsgbGFzdEZhaWw6IERhdGUgfT4gPSBuZXcgTWFwKCk7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc/OiBQYXJ0aWFsPEFwaUtleUNvbmZpZz4pIHtcbiAgICAgICAgLy8g8J+GlSDtmZjqsr3rs4DsiJjsl5DshJwg64+Z7KCB7Jy866GcIOuqqOuToCBBUEkg7YKkIOuhnOuTnCAoT0xMQU1BX0FQSV9LRVlfMSwgXzIsIF8zLCAuLi4gX04pXG4gICAgICAgIGlmIChjb25maWc/LmtleXMgJiYgY29uZmlnLmtleXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5rZXlzID0gY29uZmlnLmtleXMuZmlsdGVyKGsgPT4gayAmJiBrLnRyaW0oKSAhPT0gJycpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5rZXlzID0gdGhpcy5sb2FkS2V5c0Zyb21FbnYoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc3NoS2V5ID0gY29uZmlnPy5zc2hLZXkgfHwgcHJvY2Vzcy5lbnYuT0xMQU1BX1NTSF9LRVk7XG5cbiAgICAgICAgY29uc29sZS5sb2coYFtBcGlLZXlNYW5hZ2VyXSDwn5SRIOy0iOq4sO2ZlOuQqCAtICR7dGhpcy5rZXlzLmxlbmd0aH3qsJwgQVBJIO2CpCDrk7HroZ1gKTtcbiAgICAgICAgdGhpcy5rZXlzLmZvckVhY2goKGtleSwgaWR4KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtYXNrZWQgPSBrZXkuc3Vic3RyaW5nKDAsIDgpICsgJy4uLicgKyBrZXkuc3Vic3RyaW5nKGtleS5sZW5ndGggLSA0KTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbQXBpS2V5TWFuYWdlcl0gICBLZXkgJHtpZHggKyAxfTogJHttYXNrZWR9YCk7XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zb2xlLmxvZyhgW0FwaUtleU1hbmFnZXJdIFNTSCBLZXk6ICR7dGhpcy5zc2hLZXkgPyAn7ISk7KCV65CoJyA6ICfsl4bsnYwnfWApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIPCfhpUg7ZmY6rK967OA7IiY7JeQ7IScIOuPmeyggeycvOuhnCBBUEkg7YKkIOuhnOuTnFxuICAgICAqIE9MTEFNQV9BUElfS0VZXzEsIE9MTEFNQV9BUElfS0VZXzIsIC4uLiBPTExBTUFfQVBJX0tFWV9OIOyInOyEnOuhnCDtg5Dsg4lcbiAgICAgKiDroIjqsbDsi5wg7KeA7JuQOiBPTExBTUFfQVBJX0tFWV9QUklNQVJZLCBPTExBTUFfQVBJX0tFWV9TRUNPTkRBUllcbiAgICAgKi9cbiAgICBwcml2YXRlIGxvYWRLZXlzRnJvbUVudigpOiBzdHJpbmdbXSB7XG4gICAgICAgIGNvbnN0IGtleXM6IHN0cmluZ1tdID0gW107XG5cbiAgICAgICAgLy8g7IOI66Gc7Jq0IO2YleyLnTogT0xMQU1BX0FQSV9LRVlfMSwgXzIsIF8zLCAuLi4gKOustOygnO2VnClcbiAgICAgICAgbGV0IGluZGV4ID0gMTtcbiAgICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IHByb2Nlc3MuZW52W2BPTExBTUFfQVBJX0tFWV8ke2luZGV4fWBdO1xuICAgICAgICAgICAgaWYgKGtleSAmJiBrZXkudHJpbSgpICE9PSAnJykge1xuICAgICAgICAgICAgICAgIGtleXMucHVzaChrZXkudHJpbSgpKTtcbiAgICAgICAgICAgICAgICBpbmRleCsrO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOugiOqxsOyLnCDtmJXsi50g7KeA7JuQICjsg4gg7ZiV7Iud7JeQIO2CpOqwgCDsl4bsnYQg65WM66eMKVxuICAgICAgICBpZiAoa2V5cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHByaW1hcnkgPSBwcm9jZXNzLmVudi5PTExBTUFfQVBJX0tFWV9QUklNQVJZIHx8IHByb2Nlc3MuZW52Lk9MTEFNQV9BUElfS0VZO1xuICAgICAgICAgICAgY29uc3Qgc2Vjb25kYXJ5ID0gcHJvY2Vzcy5lbnYuT0xMQU1BX0FQSV9LRVlfU0VDT05EQVJZO1xuXG4gICAgICAgICAgICBpZiAocHJpbWFyeSAmJiBwcmltYXJ5LnRyaW0oKSAhPT0gJycpIGtleXMucHVzaChwcmltYXJ5LnRyaW0oKSk7XG4gICAgICAgICAgICBpZiAoc2Vjb25kYXJ5ICYmIHNlY29uZGFyeS50cmltKCkgIT09ICcnKSBrZXlzLnB1c2goc2Vjb25kYXJ5LnRyaW0oKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ga2V5cztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDtmITsnqwg7IKs7Jqp7ZWgIEFQSSDtgqQg67CY7ZmYXG4gICAgICovXG4gICAgZ2V0Q3VycmVudEtleSgpOiBzdHJpbmcge1xuICAgICAgICBpZiAodGhpcy5rZXlzLmxlbmd0aCA9PT0gMCkgcmV0dXJuICcnO1xuICAgICAgICByZXR1cm4gdGhpcy5rZXlzW3RoaXMuY3VycmVudEtleUluZGV4XTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDtmITsnqwg7YKkIOyduOuNseyKpCDrsJjtmZhcbiAgICAgKi9cbiAgICBnZXRDdXJyZW50S2V5SW5kZXgoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEtleUluZGV4O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOyghOyytCDtgqQg6rCc7IiYIOuwmO2ZmFxuICAgICAqL1xuICAgIGdldFRvdGFsS2V5cygpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5rZXlzLmxlbmd0aDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBUEkg7YKk6rCAIOyEpOygleuQmOyWtCDsnojripTsp4Ag7ZmV7J24XG4gICAgICovXG4gICAgaGFzVmFsaWRLZXkoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmtleXMubGVuZ3RoID4gMDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTU0gg7YKkIOuwmO2ZmFxuICAgICAqL1xuICAgIGdldFNzaEtleSgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gdGhpcy5zc2hLZXk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog7JqU7LKtIOyEseqztSDsi5wg7Zi47LacXG4gICAgICovXG4gICAgcmVwb3J0U3VjY2VzcygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5mYWlsdXJlQ291bnQgPSAwO1xuICAgICAgICAvLyDtmITsnqwg7YKk7J2YIOyLpO2MqCDquLDroZ0g7LSI6riw7ZmUXG4gICAgICAgIHRoaXMua2V5RmFpbHVyZXMuZGVsZXRlKHRoaXMuY3VycmVudEtleUluZGV4KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDsmpTssq0g7Iuk7YyoIOyLnCDtmLjstpwgLSDsnpDrj5kg66Gc7YWM7J207IWYIOyymOumrFxuICAgICAqL1xuICAgIHJlcG9ydEZhaWx1cmUoZXJyb3I/OiBhbnkpOiBib29sZWFuIHtcbiAgICAgICAgdGhpcy5mYWlsdXJlQ291bnQrKztcbiAgICAgICAgY29uc3QgZXJyb3JDb2RlID0gZXJyb3I/LnJlc3BvbnNlPy5zdGF0dXMgfHwgZXJyb3I/LmNvZGUgfHwgJ3Vua25vd24nO1xuXG4gICAgICAgIC8vIO2YhOyerCDtgqTsnZgg7Iuk7YyoIOq4sOuhnSDsl4XrjbDsnbTtirhcbiAgICAgICAgY29uc3QgY3VycmVudEZhaWx1cmUgPSB0aGlzLmtleUZhaWx1cmVzLmdldCh0aGlzLmN1cnJlbnRLZXlJbmRleCkgfHwgeyBjb3VudDogMCwgbGFzdEZhaWw6IG5ldyBEYXRlKCkgfTtcbiAgICAgICAgY3VycmVudEZhaWx1cmUuY291bnQrKztcbiAgICAgICAgY3VycmVudEZhaWx1cmUubGFzdEZhaWwgPSBuZXcgRGF0ZSgpO1xuICAgICAgICB0aGlzLmtleUZhaWx1cmVzLnNldCh0aGlzLmN1cnJlbnRLZXlJbmRleCwgY3VycmVudEZhaWx1cmUpO1xuXG4gICAgICAgIGNvbnN0IG1hc2tlZCA9IHRoaXMuZ2V0Q3VycmVudEtleSgpLnN1YnN0cmluZygwLCA4KSArICcuLi4nO1xuICAgICAgICBjb25zb2xlLndhcm4oYFtBcGlLZXlNYW5hZ2VyXSDimqDvuI8gS2V5ICR7dGhpcy5jdXJyZW50S2V5SW5kZXggKyAxfSAoJHttYXNrZWR9KSDsi6TtjKggLSDsvZTrk5w6ICR7ZXJyb3JDb2RlfWApO1xuXG4gICAgICAgIC8vIOyduOymnSDqtIDroKgg7JeQ65+s7J24IOqyveyasCDsponsi5wg64uk7J2MIO2CpOuhnCDsoITtmZhcbiAgICAgICAgY29uc3QgaXNBdXRoRXJyb3IgPSBlcnJvckNvZGUgPT09IDQwMSB8fCBlcnJvckNvZGUgPT09IDQwMyB8fCBlcnJvckNvZGUgPT09IDQyOTtcblxuICAgICAgICBpZiAodGhpcy5mYWlsdXJlQ291bnQgPj0gdGhpcy5tYXhGYWlsdXJlcyB8fCBpc0F1dGhFcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucm90YXRlVG9OZXh0S2V5KCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog64uk7J2MIO2CpOuhnCDsiJztmZhcbiAgICAgKi9cbiAgICBwcml2YXRlIHJvdGF0ZVRvTmV4dEtleSgpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHRoaXMua2V5cy5sZW5ndGggPD0gMSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FwaUtleU1hbmFnZXJdIOKdjCDsgqzsmqkg6rCA64ql7ZWcIOuLpOuluCDtgqTqsIAg7JeG7Iq164uI64ukLmApO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcHJldmlvdXNJbmRleCA9IHRoaXMuY3VycmVudEtleUluZGV4O1xuXG4gICAgICAgIC8vIOyCrOyaqSDqsIDriqXtlZwg64uk7J2MIO2CpCDssL7quLAgKOy1nOq3vCDsi6TtjKgg6riw66Gd7J20IOyXhuuKlCDtgqQg7Jqw7ISgKVxuICAgICAgICBsZXQgbmV4dEluZGV4ID0gKHRoaXMuY3VycmVudEtleUluZGV4ICsgMSkgJSB0aGlzLmtleXMubGVuZ3RoO1xuICAgICAgICBsZXQgYXR0ZW1wdHMgPSAwO1xuXG4gICAgICAgIHdoaWxlIChhdHRlbXB0cyA8IHRoaXMua2V5cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnN0IGZhaWx1cmVSZWNvcmQgPSB0aGlzLmtleUZhaWx1cmVzLmdldChuZXh0SW5kZXgpO1xuXG4gICAgICAgICAgICAvLyDsi6TtjKgg6riw66Gd7J20IOyXhuqxsOuCmCA167aEIOydtOyDgSDsp4Drgpwg7YKkIOywvuq4sFxuICAgICAgICAgICAgaWYgKCFmYWlsdXJlUmVjb3JkIHx8IChEYXRlLm5vdygpIC0gZmFpbHVyZVJlY29yZC5sYXN0RmFpbC5nZXRUaW1lKCkgPiA1ICogNjAgKiAxMDAwKSkge1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBuZXh0SW5kZXggPSAobmV4dEluZGV4ICsgMSkgJSB0aGlzLmtleXMubGVuZ3RoO1xuICAgICAgICAgICAgYXR0ZW1wdHMrKztcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY3VycmVudEtleUluZGV4ID0gbmV4dEluZGV4O1xuICAgICAgICB0aGlzLmZhaWx1cmVDb3VudCA9IDA7XG4gICAgICAgIHRoaXMubGFzdEZhaWxvdmVyVGltZSA9IG5ldyBEYXRlKCk7XG5cbiAgICAgICAgY29uc3QgcHJldmlvdXNNYXNrZWQgPSB0aGlzLmtleXNbcHJldmlvdXNJbmRleF0uc3Vic3RyaW5nKDAsIDgpICsgJy4uLic7XG4gICAgICAgIGNvbnN0IG5ld01hc2tlZCA9IHRoaXMuZ2V0Q3VycmVudEtleSgpLnN1YnN0cmluZygwLCA4KSArICcuLi4nO1xuICAgICAgICBjb25zb2xlLmxvZyhgW0FwaUtleU1hbmFnZXJdIPCflIQg7YKkIOyghO2ZmDogS2V5ICR7cHJldmlvdXNJbmRleCArIDF9ICgke3ByZXZpb3VzTWFza2VkfSkg4oaSIEtleSAke25leHRJbmRleCArIDF9ICgke25ld01hc2tlZH0pYCk7XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog7LKrIOuyiOynuCDtgqTroZwg66as7IWLXG4gICAgICovXG4gICAgcmVzZXQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuY3VycmVudEtleUluZGV4ID0gMDtcbiAgICAgICAgdGhpcy5mYWlsdXJlQ291bnQgPSAwO1xuICAgICAgICB0aGlzLmxhc3RGYWlsb3ZlclRpbWUgPSBudWxsO1xuICAgICAgICB0aGlzLmtleUZhaWx1cmVzLmNsZWFyKCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGBbQXBpS2V5TWFuYWdlcl0g8J+UhCBLZXkgMeycvOuhnCDrpqzshYvrkKhgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDtmITsnqwg7IOB7YOcIOyhsO2ajFxuICAgICAqL1xuICAgIGdldFN0YXR1cygpOiB7XG4gICAgICAgIGFjdGl2ZUtleUluZGV4OiBudW1iZXI7XG4gICAgICAgIHRvdGFsS2V5czogbnVtYmVyO1xuICAgICAgICBmYWlsdXJlczogbnVtYmVyO1xuICAgICAgICBsYXN0RmFpbG92ZXI6IERhdGUgfCBudWxsO1xuICAgICAgICBrZXlTdGF0dXNlczogeyBpbmRleDogbnVtYmVyOyBmYWlsQ291bnQ6IG51bWJlcjsgbGFzdEZhaWw6IERhdGUgfCBudWxsIH1bXTtcbiAgICB9IHtcbiAgICAgICAgY29uc3Qga2V5U3RhdHVzZXMgPSB0aGlzLmtleXMubWFwKChfLCBpZHgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGZhaWx1cmUgPSB0aGlzLmtleUZhaWx1cmVzLmdldChpZHgpO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBpbmRleDogaWR4LFxuICAgICAgICAgICAgICAgIGZhaWxDb3VudDogZmFpbHVyZT8uY291bnQgfHwgMCxcbiAgICAgICAgICAgICAgICBsYXN0RmFpbDogZmFpbHVyZT8ubGFzdEZhaWwgfHwgbnVsbFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGFjdGl2ZUtleUluZGV4OiB0aGlzLmN1cnJlbnRLZXlJbmRleCxcbiAgICAgICAgICAgIHRvdGFsS2V5czogdGhpcy5rZXlzLmxlbmd0aCxcbiAgICAgICAgICAgIGZhaWx1cmVzOiB0aGlzLmZhaWx1cmVDb3VudCxcbiAgICAgICAgICAgIGxhc3RGYWlsb3ZlcjogdGhpcy5sYXN0RmFpbG92ZXJUaW1lLFxuICAgICAgICAgICAga2V5U3RhdHVzZXNcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBdXRob3JpemF0aW9uIO2XpOuNlCDsg53shLFcbiAgICAgKi9cbiAgICBnZXRBdXRoSGVhZGVycygpOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+IHtcbiAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5nZXRDdXJyZW50S2V5KCk7XG4gICAgICAgIGlmICgha2V5KSByZXR1cm4ge307XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2tleX1gXG4gICAgICAgIH07XG4gICAgfVxufVxuXG4vLyDsi7HquIDthqQg7J247Iqk7YS07IqkXG5sZXQgYXBpS2V5TWFuYWdlcjogQXBpS2V5TWFuYWdlciB8IG51bGwgPSBudWxsO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QXBpS2V5TWFuYWdlcigpOiBBcGlLZXlNYW5hZ2VyIHtcbiAgICBpZiAoIWFwaUtleU1hbmFnZXIpIHtcbiAgICAgICAgYXBpS2V5TWFuYWdlciA9IG5ldyBBcGlLZXlNYW5hZ2VyKCk7XG4gICAgfVxuICAgIHJldHVybiBhcGlLZXlNYW5hZ2VyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzZXRBcGlLZXlNYW5hZ2VyKCk6IHZvaWQge1xuICAgIGFwaUtleU1hbmFnZXIgPSBudWxsO1xufVxuIl0sInZlcnNpb24iOjN9