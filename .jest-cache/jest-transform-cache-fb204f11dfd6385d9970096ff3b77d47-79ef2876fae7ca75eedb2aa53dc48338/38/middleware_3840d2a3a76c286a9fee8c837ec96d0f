d4ec9b98fb0ca26ceb94f38159b2069a
"use strict";
/**
 * 인증 미들웨어
 * Express 요청에 대한 인증 처리
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.optionalAuth = optionalAuth;
exports.requireAuth = requireAuth;
exports.requireAdmin = requireAdmin;
exports.requireRole = requireRole;
const index_1 = require("./index");
const user_manager_1 = require("../data/user-manager");
/**
 * 인증 미들웨어 (선택적)
 * 토큰이 있으면 검증하고 사용자 정보를 req.user에 추가
 * 토큰이 없어도 통과 (게스트 허용)
 */
function optionalAuth(req, res, next) {
    const authHeader = req.headers.authorization;
    const token = (0, index_1.extractToken)(authHeader);
    if (token) {
        const payload = (0, index_1.verifyToken)(token);
        if (payload) {
            const userManager = (0, user_manager_1.getUserManager)();
            const user = userManager.getUserById(payload.userId);
            if (user && user.is_active) {
                req.user = user;
                req.token = token;
            }
        }
    }
    next();
}
/**
 * 인증 필수 미들웨어
 * 유효한 토큰이 없으면 401 반환
 */
function requireAuth(req, res, next) {
    const authHeader = req.headers.authorization;
    const token = (0, index_1.extractToken)(authHeader);
    if (!token) {
        res.status(401).json({ error: '인증이 필요합니다' });
        return;
    }
    const payload = (0, index_1.verifyToken)(token);
    if (!payload) {
        res.status(401).json({ error: '유효하지 않은 토큰입니다' });
        return;
    }
    const userManager = (0, user_manager_1.getUserManager)();
    const user = userManager.getUserById(payload.userId);
    if (!user) {
        res.status(401).json({ error: '사용자를 찾을 수 없습니다' });
        return;
    }
    if (!user.is_active) {
        res.status(403).json({ error: '비활성화된 계정입니다' });
        return;
    }
    req.user = user;
    req.token = token;
    next();
}
/**
 * 관리자 권한 필수 미들웨어
 * requireAuth 이후에 사용
 */
function requireAdmin(req, res, next) {
    if (!req.user) {
        res.status(401).json({ error: '인증이 필요합니다' });
        return;
    }
    if (!(0, index_1.isAdmin)(req.user.role)) {
        res.status(403).json({ error: '관리자 권한이 필요합니다' });
        return;
    }
    next();
}
/**
 * 특정 역할 필수 미들웨어 팩토리
 */
function requireRole(role) {
    return (req, res, next) => {
        if (!req.user) {
            res.status(401).json({ error: '인증이 필요합니다' });
            return;
        }
        if (!(0, index_1.hasPermission)(req.user.role, role)) {
            res.status(403).json({ error: `${role} 이상의 권한이 필요합니다` });
            return;
        }
        next();
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL2F1dGgvbWlkZGxld2FyZS50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOztBQXFCSCxvQ0FtQkM7QUFNRCxrQ0FnQ0M7QUFNRCxvQ0FZQztBQUtELGtDQWNDO0FBaEhELG1DQUE0RTtBQUM1RSx1REFBNEU7QUFZNUU7Ozs7R0FJRztBQUNILFNBQWdCLFlBQVksQ0FBQyxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCO0lBQ3hFLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDO0lBQzdDLE1BQU0sS0FBSyxHQUFHLElBQUEsb0JBQVksRUFBQyxVQUFVLENBQUMsQ0FBQztJQUV2QyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQ1IsTUFBTSxPQUFPLEdBQUcsSUFBQSxtQkFBVyxFQUFDLEtBQUssQ0FBQyxDQUFDO1FBRW5DLElBQUksT0FBTyxFQUFFLENBQUM7WUFDVixNQUFNLFdBQVcsR0FBRyxJQUFBLDZCQUFjLEdBQUUsQ0FBQztZQUNyQyxNQUFNLElBQUksR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUVyRCxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ3pCLEdBQUcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO2dCQUNoQixHQUFHLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztZQUN0QixDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFJLEVBQUUsQ0FBQztBQUNYLENBQUM7QUFFRDs7O0dBR0c7QUFDSCxTQUFnQixXQUFXLENBQUMsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQjtJQUN2RSxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQztJQUM3QyxNQUFNLEtBQUssR0FBRyxJQUFBLG9CQUFZLEVBQUMsVUFBVSxDQUFDLENBQUM7SUFFdkMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ1QsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUM3QyxPQUFPO0lBQ1gsQ0FBQztJQUVELE1BQU0sT0FBTyxHQUFHLElBQUEsbUJBQVcsRUFBQyxLQUFLLENBQUMsQ0FBQztJQUVuQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDWCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsQ0FBQyxDQUFDO1FBQ2pELE9BQU87SUFDWCxDQUFDO0lBRUQsTUFBTSxXQUFXLEdBQUcsSUFBQSw2QkFBYyxHQUFFLENBQUM7SUFDckMsTUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFckQsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1IsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELE9BQU87SUFDWCxDQUFDO0lBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNsQixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFDO1FBQy9DLE9BQU87SUFDWCxDQUFDO0lBRUQsR0FBRyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDaEIsR0FBRyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDbEIsSUFBSSxFQUFFLENBQUM7QUFDWCxDQUFDO0FBRUQ7OztHQUdHO0FBQ0gsU0FBZ0IsWUFBWSxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0I7SUFDeEUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNaLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDN0MsT0FBTztJQUNYLENBQUM7SUFFRCxJQUFJLENBQUMsSUFBQSxlQUFPLEVBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQzFCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBRSxDQUFDLENBQUM7UUFDakQsT0FBTztJQUNYLENBQUM7SUFFRCxJQUFJLEVBQUUsQ0FBQztBQUNYLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQWdCLFdBQVcsQ0FBQyxJQUFjO0lBQ3RDLE9BQU8sQ0FBQyxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQVEsRUFBRTtRQUM3RCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1osR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztZQUM3QyxPQUFPO1FBQ1gsQ0FBQztRQUVELElBQUksQ0FBQyxJQUFBLHFCQUFhLEVBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUN0QyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxHQUFHLElBQUksZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1lBQ3pELE9BQU87UUFDWCxDQUFDO1FBRUQsSUFBSSxFQUFFLENBQUM7SUFDWCxDQUFDLENBQUM7QUFDTixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Wb2x1bWVzL01BQ19BUFAvb3Blbm1ha2VfbGxtL2JhY2tlbmQvYXBpL3NyYy9hdXRoL21pZGRsZXdhcmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiDsnbjspp0g66+465Ok7Juo7Ja0XG4gKiBFeHByZXNzIOyalOyyreyXkCDrjIDtlZwg7J247KadIOyymOumrFxuICovXG5cbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IGV4dHJhY3RUb2tlbiwgdmVyaWZ5VG9rZW4sIGhhc1Blcm1pc3Npb24sIGlzQWRtaW4gfSBmcm9tICcuL2luZGV4JztcbmltcG9ydCB7IGdldFVzZXJNYW5hZ2VyLCBQdWJsaWNVc2VyLCBVc2VyUm9sZSB9IGZyb20gJy4uL2RhdGEvdXNlci1tYW5hZ2VyJztcblxuLy8gUmVxdWVzdCDtg4DsnoUg7ZmV7J6lXG5kZWNsYXJlIGdsb2JhbCB7XG4gICAgbmFtZXNwYWNlIEV4cHJlc3Mge1xuICAgICAgICBpbnRlcmZhY2UgUmVxdWVzdCB7XG4gICAgICAgICAgICB1c2VyPzogUHVibGljVXNlcjtcbiAgICAgICAgICAgIHRva2VuPzogc3RyaW5nO1xuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIOyduOymnSDrr7jrk6Tsm6jslrQgKOyEoO2DneyggSlcbiAqIO2GoO2BsOydtCDsnojsnLzrqbQg6rKA7Kad7ZWY6rOgIOyCrOyaqeyekCDsoJXrs7TrpbwgcmVxLnVzZXLsl5Ag7LaU6rCAXG4gKiDthqDtgbDsnbQg7JeG7Ja064+EIO2GteqzvCAo6rKM7Iqk7Yq4IO2XiOyaqSlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG9wdGlvbmFsQXV0aChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQge1xuICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uO1xuICAgIGNvbnN0IHRva2VuID0gZXh0cmFjdFRva2VuKGF1dGhIZWFkZXIpO1xuXG4gICAgaWYgKHRva2VuKSB7XG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSB2ZXJpZnlUb2tlbih0b2tlbik7XG5cbiAgICAgICAgaWYgKHBheWxvYWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXJNYW5hZ2VyID0gZ2V0VXNlck1hbmFnZXIoKTtcbiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSB1c2VyTWFuYWdlci5nZXRVc2VyQnlJZChwYXlsb2FkLnVzZXJJZCk7XG5cbiAgICAgICAgICAgIGlmICh1c2VyICYmIHVzZXIuaXNfYWN0aXZlKSB7XG4gICAgICAgICAgICAgICAgcmVxLnVzZXIgPSB1c2VyO1xuICAgICAgICAgICAgICAgIHJlcS50b2tlbiA9IHRva2VuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmV4dCgpO1xufVxuXG4vKipcbiAqIOyduOymnSDtlYTsiJgg66+465Ok7Juo7Ja0XG4gKiDsnKDtmqjtlZwg7Yag7YGw7J20IOyXhuycvOuptCA0MDEg67CY7ZmYXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlQXV0aChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQge1xuICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uO1xuICAgIGNvbnN0IHRva2VuID0gZXh0cmFjdFRva2VuKGF1dGhIZWFkZXIpO1xuXG4gICAgaWYgKCF0b2tlbikge1xuICAgICAgICByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAn7J247Kad7J20IO2VhOyalO2VqeuLiOuLpCcgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwYXlsb2FkID0gdmVyaWZ5VG9rZW4odG9rZW4pO1xuXG4gICAgaWYgKCFwYXlsb2FkKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICfsnKDtmqjtlZjsp4Ag7JWK7J2AIO2GoO2BsOyeheuLiOuLpCcgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB1c2VyTWFuYWdlciA9IGdldFVzZXJNYW5hZ2VyKCk7XG4gICAgY29uc3QgdXNlciA9IHVzZXJNYW5hZ2VyLmdldFVzZXJCeUlkKHBheWxvYWQudXNlcklkKTtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgICByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAn7IKs7Jqp7J6Q66W8IOywvuydhCDsiJgg7JeG7Iq164uI64ukJyB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdXNlci5pc19hY3RpdmUpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ+u5hO2ZnOyEse2ZlOuQnCDqs4TsoJXsnoXri4jri6QnIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcmVxLnVzZXIgPSB1c2VyO1xuICAgIHJlcS50b2tlbiA9IHRva2VuO1xuICAgIG5leHQoKTtcbn1cblxuLyoqXG4gKiDqtIDrpqzsnpAg6raM7ZWcIO2VhOyImCDrr7jrk6Tsm6jslrRcbiAqIHJlcXVpcmVBdXRoIOydtO2bhOyXkCDsgqzsmqlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVBZG1pbihyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQge1xuICAgIGlmICghcmVxLnVzZXIpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ+yduOymneydtCDtlYTsmpTtlanri4jri6QnIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCFpc0FkbWluKHJlcS51c2VyLnJvbGUpKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICfqtIDrpqzsnpAg6raM7ZWc7J20IO2VhOyalO2VqeuLiOuLpCcgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBuZXh0KCk7XG59XG5cbi8qKlxuICog7Yq57KCVIOyXre2VoCDtlYTsiJgg66+465Ok7Juo7Ja0IO2Mqe2GoOumrFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVxdWlyZVJvbGUocm9sZTogVXNlclJvbGUpIHtcbiAgICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogdm9pZCA9PiB7XG4gICAgICAgIGlmICghcmVxLnVzZXIpIHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICfsnbjspp3snbQg7ZWE7JqU7ZWp64uI64ukJyB9KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghaGFzUGVybWlzc2lvbihyZXEudXNlci5yb2xlLCByb2xlKSkge1xuICAgICAgICAgICAgcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogYCR7cm9sZX0g7J207IOB7J2YIOq2jO2VnOydtCDtlYTsmpTtlanri4jri6RgIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbmV4dCgpO1xuICAgIH07XG59XG4iXSwidmVyc2lvbiI6M30=