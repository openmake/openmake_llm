2fd44bf35f4bc353a71918e4ae7c17d6
"use strict";
/**
 * Auth Module Tests
 * JWT 토큰 생성/검증 및 권한 체크 테스트
 */
Object.defineProperty(exports, "__esModule", { value: true });
// 테스트용 환경변수 설정 (다른 import 전에 설정)
process.env.JWT_SECRET = 'test-secret-key-for-testing-purposes-only';
const auth_1 = require("../auth");
describe('Auth Module', () => {
    // 테스트용 사용자 데이터
    const mockUser = {
        id: 1,
        email: 'test@example.com',
        role: 'user',
        tier: 'free',
        is_active: true,
        created_at: new Date().toISOString()
    };
    const mockAdminUser = {
        id: 2,
        email: 'admin@example.com',
        role: 'admin',
        tier: 'enterprise',
        is_active: true,
        created_at: new Date().toISOString()
    };
    describe('generateToken', () => {
        it('should generate a valid JWT token', () => {
            const token = (0, auth_1.generateToken)(mockUser);
            expect(token).toBeDefined();
            expect(typeof token).toBe('string');
            expect(token.split('.')).toHaveLength(3); // JWT는 3개 세그먼트
        });
        it('should generate different tokens for different users', () => {
            const token1 = (0, auth_1.generateToken)(mockUser);
            const token2 = (0, auth_1.generateToken)(mockAdminUser);
            expect(token1).not.toBe(token2);
        });
    });
    describe('verifyToken', () => {
        it('should verify a valid token', () => {
            const token = (0, auth_1.generateToken)(mockUser);
            const payload = (0, auth_1.verifyToken)(token);
            expect(payload).not.toBeNull();
            expect(payload === null || payload === void 0 ? void 0 : payload.userId).toBe(mockUser.id);
            expect(payload === null || payload === void 0 ? void 0 : payload.email).toBe(mockUser.email);
            expect(payload === null || payload === void 0 ? void 0 : payload.role).toBe(mockUser.role);
        });
        it('should return null for invalid token', () => {
            const payload = (0, auth_1.verifyToken)('invalid-token');
            expect(payload).toBeNull();
        });
        it('should return null for empty token', () => {
            const payload = (0, auth_1.verifyToken)('');
            expect(payload).toBeNull();
        });
        it('should return null for malformed JWT', () => {
            const payload = (0, auth_1.verifyToken)('a.b.c');
            expect(payload).toBeNull();
        });
    });
    describe('extractToken', () => {
        it('should extract token from Bearer header', () => {
            const token = (0, auth_1.extractToken)('Bearer mytoken123');
            expect(token).toBe('mytoken123');
        });
        it('should return raw token if no Bearer prefix', () => {
            const token = (0, auth_1.extractToken)('rawtoken456');
            expect(token).toBe('rawtoken456');
        });
        it('should return null for undefined header', () => {
            const token = (0, auth_1.extractToken)(undefined);
            expect(token).toBeNull();
        });
        it('should return null for empty header', () => {
            const token = (0, auth_1.extractToken)('');
            expect(token).toBeNull();
        });
    });
    describe('hasPermission', () => {
        it('should allow admin to access admin resources', () => {
            expect((0, auth_1.hasPermission)('admin', 'admin')).toBe(true);
        });
        it('should allow admin to access user resources', () => {
            expect((0, auth_1.hasPermission)('admin', 'user')).toBe(true);
        });
        it('should allow admin to access guest resources', () => {
            expect((0, auth_1.hasPermission)('admin', 'guest')).toBe(true);
        });
        it('should allow user to access user resources', () => {
            expect((0, auth_1.hasPermission)('user', 'user')).toBe(true);
        });
        it('should allow user to access guest resources', () => {
            expect((0, auth_1.hasPermission)('user', 'guest')).toBe(true);
        });
        it('should deny user access to admin resources', () => {
            expect((0, auth_1.hasPermission)('user', 'admin')).toBe(false);
        });
        it('should allow guest to access guest resources', () => {
            expect((0, auth_1.hasPermission)('guest', 'guest')).toBe(true);
        });
        it('should deny guest access to user resources', () => {
            expect((0, auth_1.hasPermission)('guest', 'user')).toBe(false);
        });
        it('should deny guest access to admin resources', () => {
            expect((0, auth_1.hasPermission)('guest', 'admin')).toBe(false);
        });
    });
    describe('isAdmin', () => {
        it('should return true for admin role', () => {
            expect((0, auth_1.isAdmin)('admin')).toBe(true);
        });
        it('should return false for user role', () => {
            expect((0, auth_1.isAdmin)('user')).toBe(false);
        });
        it('should return false for guest role', () => {
            expect((0, auth_1.isAdmin)('guest')).toBe(false);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL19fdGVzdHNfXy9hdXRoLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7QUFFSCxpQ0FBaUM7QUFDakMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEdBQUcsMkNBQTJDLENBQUM7QUFFckUsa0NBTWlCO0FBR2pCLFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO0lBQ3pCLGVBQWU7SUFDZixNQUFNLFFBQVEsR0FBZTtRQUN6QixFQUFFLEVBQUUsQ0FBQztRQUNMLEtBQUssRUFBRSxrQkFBa0I7UUFDekIsSUFBSSxFQUFFLE1BQU07UUFDWixJQUFJLEVBQUUsTUFBTTtRQUNaLFNBQVMsRUFBRSxJQUFJO1FBQ2YsVUFBVSxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO0tBQ3ZDLENBQUM7SUFFRixNQUFNLGFBQWEsR0FBZTtRQUM5QixFQUFFLEVBQUUsQ0FBQztRQUNMLEtBQUssRUFBRSxtQkFBbUI7UUFDMUIsSUFBSSxFQUFFLE9BQU87UUFDYixJQUFJLEVBQUUsWUFBWTtRQUNsQixTQUFTLEVBQUUsSUFBSTtRQUNmLFVBQVUsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtLQUN2QyxDQUFDO0lBRUYsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7UUFDM0IsRUFBRSxDQUFDLG1DQUFtQyxFQUFFLEdBQUcsRUFBRTtZQUN6QyxNQUFNLEtBQUssR0FBRyxJQUFBLG9CQUFhLEVBQUMsUUFBUSxDQUFDLENBQUM7WUFFdEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzVCLE1BQU0sQ0FBQyxPQUFPLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNwQyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxD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QSxjQUFPLEVBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsb0NBQW9DLEVBQUUsR0FBRyxFQUFFO1lBQzFDLE1BQU0sQ0FBQyxJQUFBLGNBQU8sRUFBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6QyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL19fdGVzdHNfXy9hdXRoLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBBdXRoIE1vZHVsZSBUZXN0c1xuICogSldUIO2GoO2BsCDsg53shLEv6rKA7KadIOuwjyDqtoztlZwg7LK07YGsIO2FjOyKpO2KuFxuICovXG5cbi8vIO2FjOyKpO2KuOyaqSDtmZjqsr3rs4DsiJgg7ISk7KCVICjri6TrpbggaW1wb3J0IOyghOyXkCDshKTsoJUpXG5wcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gJ3Rlc3Qtc2VjcmV0LWtleS1mb3ItdGVzdGluZy1wdXJwb3Nlcy1vbmx5JztcblxuaW1wb3J0IHtcbiAgICBnZW5lcmF0ZVRva2VuLFxuICAgIHZlcmlmeVRva2VuLFxuICAgIGV4dHJhY3RUb2tlbixcbiAgICBoYXNQZXJtaXNzaW9uLFxuICAgIGlzQWRtaW5cbn0gZnJvbSAnLi4vYXV0aCc7XG5pbXBvcnQgeyBQdWJsaWNVc2VyIH0gZnJvbSAnLi4vZGF0YS91c2VyLW1hbmFnZXInO1xuXG5kZXNjcmliZSgnQXV0aCBNb2R1bGUnLCAoKSA9PiB7XG4gICAgLy8g7YWM7Iqk7Yq47JqpIOyCrOyaqeyekCDrjbDsnbTthLBcbiAgICBjb25zdCBtb2NrVXNlcjogUHVibGljVXNlciA9IHtcbiAgICAgICAgaWQ6IDEsXG4gICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXG4gICAgICAgIHJvbGU6ICd1c2VyJyxcbiAgICAgICAgdGllcjogJ2ZyZWUnLFxuICAgICAgICBpc19hY3RpdmU6IHRydWUsXG4gICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgIH07XG5cbiAgICBjb25zdCBtb2NrQWRtaW5Vc2VyOiBQdWJsaWNVc2VyID0ge1xuICAgICAgICBpZDogMixcbiAgICAgICAgZW1haWw6ICdhZG1pbkBleGFtcGxlLmNvbScsXG4gICAgICAgIHJvbGU6ICdhZG1pbicsXG4gICAgICAgIHRpZXI6ICdlbnRlcnByaXNlJyxcbiAgICAgICAgaXNfYWN0aXZlOiB0cnVlLFxuICAgICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICB9O1xuXG4gICAgZGVzY3JpYmUoJ2dlbmVyYXRlVG9rZW4nLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgYSB2YWxpZCBKV1QgdG9rZW4nLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b2tlbiA9IGdlbmVyYXRlVG9rZW4obW9ja1VzZXIpO1xuXG4gICAgICAgICAgICBleHBlY3QodG9rZW4pLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgICAgICBleHBlY3QodHlwZW9mIHRva2VuKS50b0JlKCdzdHJpbmcnKTtcbiAgICAgICAgICAgIGV4cGVjdCh0b2tlbi5zcGxpdCgnLicpKS50b0hhdmVMZW5ndGgoMyk7IC8vIEpXVOuKlCAz6rCcIOyEuOq3uOuovO2KuFxuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIGRpZmZlcmVudCB0b2tlbnMgZm9yIGRpZmZlcmVudCB1c2VycycsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuMSA9IGdlbmVyYXRlVG9rZW4obW9ja1VzZXIpO1xuICAgICAgICAgICAgY29uc3QgdG9rZW4yID0gZ2VuZXJhdGVUb2tlbihtb2NrQWRtaW5Vc2VyKTtcblxuICAgICAgICAgICAgZXhwZWN0KHRva2VuMSkubm90LnRvQmUodG9rZW4yKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgndmVyaWZ5VG9rZW4nLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgdmVyaWZ5IGEgdmFsaWQgdG9rZW4nLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b2tlbiA9IGdlbmVyYXRlVG9rZW4obW9ja1VzZXIpO1xuICAgICAgICAgICAgY29uc3QgcGF5bG9hZCA9IHZlcmlmeVRva2VuKHRva2VuKTtcblxuICAgICAgICAgICAgZXhwZWN0KHBheWxvYWQpLm5vdC50b0JlTnVsbCgpO1xuICAgICAgICAgICAgZXhwZWN0KHBheWxvYWQ/LnVzZXJJZCkudG9CZShtb2NrVXNlci5pZCk7XG4gICAgICAgICAgICBleHBlY3QocGF5bG9hZD8uZW1haWwpLnRvQmUobW9ja1VzZXIuZW1haWwpO1xuICAgICAgICAgICAgZXhwZWN0KHBheWxvYWQ/LnJvbGUpLnRvQmUobW9ja1VzZXIucm9sZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgZm9yIGludmFsaWQgdG9rZW4nLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwYXlsb2FkID0gdmVyaWZ5VG9rZW4oJ2ludmFsaWQtdG9rZW4nKTtcblxuICAgICAgICAgICAgZXhwZWN0KHBheWxvYWQpLnRvQmVOdWxsKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgZm9yIGVtcHR5IHRva2VuJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcGF5bG9hZCA9IHZlcmlmeVRva2VuKCcnKTtcblxuICAgICAgICAgICAgZXhwZWN0KHBheWxvYWQpLnRvQmVOdWxsKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgZm9yIG1hbGZvcm1lZCBKV1QnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwYXlsb2FkID0gdmVyaWZ5VG9rZW4oJ2EuYi5jJyk7XG5cbiAgICAgICAgICAgIGV4cGVjdChwYXlsb2FkKS50b0JlTnVsbCgpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdleHRyYWN0VG9rZW4nLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgZXh0cmFjdCB0b2tlbiBmcm9tIEJlYXJlciBoZWFkZXInLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b2tlbiA9IGV4dHJhY3RUb2tlbignQmVhcmVyIG15dG9rZW4xMjMnKTtcblxuICAgICAgICAgICAgZXhwZWN0KHRva2VuKS50b0JlKCdteXRva2VuMTIzJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIHJhdyB0b2tlbiBpZiBubyBCZWFyZXIgcHJlZml4JywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBleHRyYWN0VG9rZW4oJ3Jhd3Rva2VuNDU2Jyk7XG5cbiAgICAgICAgICAgIGV4cGVjdCh0b2tlbikudG9CZSgncmF3dG9rZW40NTYnKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gbnVsbCBmb3IgdW5kZWZpbmVkIGhlYWRlcicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuID0gZXh0cmFjdFRva2VuKHVuZGVmaW5lZCk7XG5cbiAgICAgICAgICAgIGV4cGVjdCh0b2tlbikudG9CZU51bGwoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gbnVsbCBmb3IgZW1wdHkgaGVhZGVyJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBleHRyYWN0VG9rZW4oJycpO1xuXG4gICAgICAgICAgICBleHBlY3QodG9rZW4pLnRvQmVOdWxsKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2hhc1Blcm1pc3Npb24nLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgYWxsb3cgYWRtaW4gdG8gYWNjZXNzIGFkbWluIHJlc291cmNlcycsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChoYXNQZXJtaXNzaW9uKCdhZG1pbicsICdhZG1pbicpKS50b0JlKHRydWUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGFsbG93IGFkbWluIHRvIGFjY2VzcyB1c2VyIHJlc291cmNlcycsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChoYXNQZXJtaXNzaW9uKCdhZG1pbicsICd1c2VyJykpLnRvQmUodHJ1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgYWxsb3cgYWRtaW4gdG8gYWNjZXNzIGd1ZXN0IHJlc291cmNlcycsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChoYXNQZXJtaXNzaW9uKCdhZG1pbicsICdndWVzdCcpKS50b0JlKHRydWUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGFsbG93IHVzZXIgdG8gYWNjZXNzIHVzZXIgcmVzb3VyY2VzJywgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGhhc1Blcm1pc3Npb24oJ3VzZXInLCAndXNlcicpKS50b0JlKHRydWUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGFsbG93IHVzZXIgdG8gYWNjZXNzIGd1ZXN0IHJlc291cmNlcycsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChoYXNQZXJtaXNzaW9uKCd1c2VyJywgJ2d1ZXN0JykpLnRvQmUodHJ1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgZGVueSB1c2VyIGFjY2VzcyB0byBhZG1pbiByZXNvdXJjZXMnLCAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoaGFzUGVybWlzc2lvbigndXNlcicsICdhZG1pbicpKS50b0JlKGZhbHNlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBhbGxvdyBndWVzdCB0byBhY2Nlc3MgZ3Vlc3QgcmVzb3VyY2VzJywgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGhhc1Blcm1pc3Npb24oJ2d1ZXN0JywgJ2d1ZXN0JykpLnRvQmUodHJ1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgZGVueSBndWVzdCBhY2Nlc3MgdG8gdXNlciByZXNvdXJjZXMnLCAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoaGFzUGVybWlzc2lvbignZ3Vlc3QnLCAndXNlcicpKS50b0JlKGZhbHNlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBkZW55IGd1ZXN0IGFjY2VzcyB0byBhZG1pbiByZXNvdXJjZXMnLCAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoaGFzUGVybWlzc2lvbignZ3Vlc3QnLCAnYWRtaW4nKSkudG9CZShmYWxzZSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2lzQWRtaW4nLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIHRydWUgZm9yIGFkbWluIHJvbGUnLCAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoaXNBZG1pbignYWRtaW4nKSkudG9CZSh0cnVlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gZmFsc2UgZm9yIHVzZXIgcm9sZScsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChpc0FkbWluKCd1c2VyJykpLnRvQmUoZmFsc2UpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHJldHVybiBmYWxzZSBmb3IgZ3Vlc3Qgcm9sZScsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChpc0FkbWluKCdndWVzdCcpKS50b0JlKGZhbHNlKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==