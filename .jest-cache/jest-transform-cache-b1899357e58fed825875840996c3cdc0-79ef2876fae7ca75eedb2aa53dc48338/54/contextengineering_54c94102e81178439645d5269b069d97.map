{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/chat/context-engineering.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/chat/context-engineering.ts"],"sourcesContent":["/**\n * ============================================================\n * 컨텍스트 엔지니어링 핵심 모듈\n * ============================================================\n * \n * 참조: 차세대 LLM 서비스를 위한 시스템 프롬프트 아키텍처 및 \n *       컨텍스트 엔지니어링 심층 분석 보고서\n * \n * 핵심 원칙:\n * 1. 4-Pillar Framework (역할, 제약, 목표, 출력형식)\n * 2. XML 태깅 및 구획화\n * 3. 메타데이터 동적 주입\n * 4. 위치 공학 (Position Engineering)\n * 5. 소프트 인터락 (Soft Interlock)\n * 6. 인식적 구배 (Epistemic Gradient)\n */\n\n// ============================================================\n// 타입 정의\n// ============================================================\n\n/**\n * 4-Pillar Framework 구조\n */\nexport interface FourPillarPrompt {\n    /** 역할 및 페르소나 */\n    role: RoleDefinition;\n    /** 제약 조건 */\n    constraints: Constraint[];\n    /** 목표 */\n    goal: string;\n    /** 출력 형식 */\n    outputFormat: OutputFormat;\n}\n\nexport interface RoleDefinition {\n    persona: string;\n    expertise: string[];\n    behavioralTraits?: string[];\n    toneStyle?: 'formal' | 'casual' | 'professional' | 'friendly';\n}\n\nexport interface Constraint {\n    rule: string;\n    priority: 'critical' | 'high' | 'medium' | 'low';\n    category: 'security' | 'language' | 'format' | 'content' | 'behavior';\n}\n\nexport interface OutputFormat {\n    type: 'json' | 'markdown' | 'plain' | 'code' | 'table' | 'structured';\n    schema?: object;\n    examples?: string[];\n}\n\n/**\n * 메타데이터 주입을 위한 컨텍스트\n */\nexport interface PromptMetadata {\n    currentDate: string;\n    knowledgeCutoff: string;\n    sessionId?: string;\n    userLanguage: 'ko' | 'en' | 'mixed';\n    requestTimestamp: string;\n    modelName?: string;\n}\n\n/**\n * RAG 컨텍스트 정보\n */\nexport interface RAGContext {\n    documents: RAGDocument[];\n    searchQuery: string;\n    relevanceThreshold: number;\n}\n\nexport interface RAGDocument {\n    content: string;\n    source: string;\n    timestamp?: string;\n    relevanceScore: number;\n}\n\n// ============================================================\n// XML 태그 헬퍼 함수\n// ============================================================\n\nimport { escapeXml } from './xml-escape';\n\n/**\n * XML 태그로 콘텐츠 래핑\n * \n * 🔒 Phase 2 보안 패치 2026-02-07: 프롬프트 인젝션 방어\n * escapeContent=true(기본값)일 때 사용자 입력의 XML 특수문자를 이스케이프하여\n * 프롬프트 인젝션 공격을 방지합니다.\n * \n * @param tagName - XML 태그 이름\n * @param content - 태그 내부 콘텐츠\n * @param attributes - 태그 속성 (선택)\n * @param escapeContent - 콘텐츠 이스케이프 여부 (기본: true). \n *        시스템 프롬프트 등 신뢰할 수 있는 내부 콘텐츠는 false로 설정\n */\nexport function xmlTag(\n    tagName: string, \n    content: string, \n    attributes?: Record<string, string>,\n    escapeContent: boolean = true\n): string {\n    const attrStr = attributes\n        ? ' ' + Object.entries(attributes).map(([k, v]) => `${k}=\"${v}\"`).join(' ')\n        : '';\n    const safeContent = escapeContent ? escapeXml(content) : content;\n    return `<${tagName}${attrStr}>\\n${safeContent}\\n</${tagName}>`;\n}\n\n/**\n * 시스템 규칙 섹션 생성 (내부 콘텐츠 — 이스케이프 불필요)\n */\nexport function systemRulesSection(rules: string[]): string {\n    const content = rules.map((rule, i) => `${i + 1}. ${rule}`).join('\\n');\n    return xmlTag('system_rules', content, undefined, false);\n}\n\n/**\n * 컨텍스트 섹션 생성 (RAG 결과 등)\n * 🔒 사용자 입력이 포함될 수 있으므로 이스케이프 적용\n */\nexport function contextSection(context: string): string {\n    return xmlTag('context', context);\n}\n\n/**\n * 예시 섹션 생성 (Few-shot, 내부 콘텐츠 — 이스케이프 불필요)\n */\nexport function examplesSection(examples: Array<{ input: string; output: string }>): string {\n    const content = examples.map((ex, i) =>\n        `### 예시 ${i + 1}\\n입력: ${ex.input}\\n출력: ${ex.output}`\n    ).join('\\n\\n');\n    return xmlTag('examples', content, undefined, false);\n}\n\n/**\n * 사고 과정 섹션 (Soft Interlock)\n */\nexport function thinkingSection(): string {\n    return `<thinking>\n[이 섹션에서 문제를 분석하고 답변 전략을 수립하세요]\n1. 문제 분석: 사용자가 무엇을 요구하는가?\n2. 접근 전략: 어떤 방법으로 해결할 것인가?\n3. 안전성 검증: 이 답변이 안전한가?\n4. 출력 계획: 어떤 형식으로 제공할 것인가?\n</thinking>`;\n}\n\n// ============================================================\n// 4-Pillar 프롬프트 빌더\n// ============================================================\n\n/**\n * 4-Pillar 프롬프트 빌더 클래스\n */\nexport class ContextEngineeringBuilder {\n    private metadata: PromptMetadata;\n    private pillars: Partial<FourPillarPrompt> = {};\n    private ragContext?: RAGContext;\n    private additionalSections: string[] = [];\n    private enableThinking: boolean = true;\n    private examples: Array<{ input: string; output: string }> = [];\n\n    constructor() {\n        // 기본 메타데이터 설정\n        const now = new Date();\n        this.metadata = {\n            currentDate: now.toISOString().split('T')[0],\n            knowledgeCutoff: '2024-12',\n            userLanguage: 'ko',\n            requestTimestamp: now.toISOString()\n        };\n    }\n\n    /**\n     * 메타데이터 설정\n     */\n    setMetadata(metadata: Partial<PromptMetadata>): this {\n        this.metadata = { ...this.metadata, ...metadata };\n        return this;\n    }\n\n    /**\n     * 역할 정의 (Pillar 1)\n     */\n    setRole(role: RoleDefinition): this {\n        this.pillars.role = role;\n        return this;\n    }\n\n    /**\n     * 제약 조건 추가 (Pillar 2)\n     */\n    addConstraint(constraint: Constraint): this {\n        if (!this.pillars.constraints) {\n            this.pillars.constraints = [];\n        }\n        this.pillars.constraints.push(constraint);\n        return this;\n    }\n\n    /**\n     * 목표 설정 (Pillar 3)\n     */\n    setGoal(goal: string): this {\n        this.pillars.goal = goal;\n        return this;\n    }\n\n    /**\n     * 출력 형식 설정 (Pillar 4)\n     */\n    setOutputFormat(format: OutputFormat): this {\n        this.pillars.outputFormat = format;\n        return this;\n    }\n\n    /**\n     * RAG 컨텍스트 설정\n     */\n    setRAGContext(context: RAGContext): this {\n        this.ragContext = context;\n        return this;\n    }\n\n    /**\n     * Few-shot 예시 추가\n     */\n    addExample(input: string, output: string): this {\n        this.examples.push({ input, output });\n        return this;\n    }\n\n    /**\n     * 추가 섹션 추가\n     */\n    addSection(section: string): this {\n        this.additionalSections.push(section);\n        return this;\n    }\n\n    /**\n     * 사고 과정 활성화/비활성화\n     */\n    setThinkingEnabled(enabled: boolean): this {\n        this.enableThinking = enabled;\n        return this;\n    }\n\n    /**\n     * 최종 프롬프트 빌드\n     * 위치 공학 (Positional Engineering) 적용: \n     * - 시작(Primacy): 페르소나와 핵심 맥락 배치\n     * - 끝(Recency): 절대 규칙, 출력 형식, 최종 리마인더 배치\n     */\n    build(): string {\n        const sections: string[] = [];\n\n        // 1. [Primacy Section] 메타데이터 + 역할 정의 (정체성 확립)\n        sections.push(this.buildMetadataSection());\n        sections.push(this.buildRoleSection());\n\n        // 2. [Context Section] RAG + 예시 + 도구 (사실 기반 지식 주입)\n        if (this.ragContext) {\n            sections.push(this.buildRAGSection());\n        }\n\n        if (this.examples.length > 0) {\n            sections.push(examplesSection(this.examples));\n        }\n\n        // 추가 동적 섹션 (에이전틱 상태 등)\n        sections.push(...this.additionalSections);\n\n        // 과업 목표 (내부 설정 — 이스케이프 불필요)\n        if (this.pillars.goal) {\n            sections.push(xmlTag('goal', this.pillars.goal, undefined, false));\n        }\n\n        // 3. [Recency Section] 🔒 보안/제약 + 출력 형식 + 소프트 인터락 (제어 및 실행)\n        // 중요도가 높은 규칙들을 마지막에 배치하여 지침 준수율 극대화\n        sections.push(this.buildConstraintsSection());\n        sections.push(this.buildOutputFormatSection());\n\n        // 소프트 인터락 (Thinking Process)\n        if (this.enableThinking) {\n            sections.push(this.buildSoftInterlockSection());\n        }\n\n        // 최종 강조 리마인더 (Double Recency)\n        sections.push(this.buildFinalReminder());\n\n        return sections.join('\\n\\n');\n    }\n\n    /**\n     * 메타데이터 섹션 생성\n     */\n    private buildMetadataSection(): string {\n        return `<metadata>\n현재 날짜: ${this.metadata.currentDate}\n지식 기준일: ${this.metadata.knowledgeCutoff}\n응답 언어: ${this.metadata.userLanguage === 'ko' ? '한국어' : '영어'}\n${this.metadata.modelName ? `모델: ${this.metadata.modelName}` : ''}\n</metadata>`;\n    }\n\n    /**\n     * 역할 섹션 생성\n     */\n    private buildRoleSection(): string {\n        if (!this.pillars.role) {\n            return '';\n        }\n\n        const { role } = this.pillars;\n        const traits = role.behavioralTraits?.map(t => `- ${t}`).join('\\n') || '';\n        const expertise = role.expertise.map(e => `- ${e}`).join('\\n');\n\n        return `<role>\n## 페르소나\n${role.persona}\n\n## 전문 분야\n${expertise}\n\n${traits ? `## 행동 특성\\n${traits}` : ''}\n\n## 대화 스타일\n${role.toneStyle === 'formal' ? '격식체 사용' :\n                role.toneStyle === 'casual' ? '반말체, 친근한 어조' :\n                    role.toneStyle === 'professional' ? '전문적이고 객관적인 어조' :\n                        '친근하고 편안한 어조'}\n</role>`;\n    }\n\n    /**\n     * RAG 컨텍스트 섹션 생성\n     */\n    private buildRAGSection(): string {\n        if (!this.ragContext || this.ragContext.documents.length === 0) {\n            return '';\n        }\n\n        const docs = this.ragContext.documents\n            .filter(d => d.relevanceScore >= this.ragContext!.relevanceThreshold)\n            .map((d, i) => `### 문서 ${i + 1} (관련도: ${(d.relevanceScore * 100).toFixed(0)}%)\n출처: ${d.source}\n${d.timestamp ? `날짜: ${d.timestamp}` : ''}\n\n${d.content}`)\n            .join('\\n\\n');\n\n        return `<context>\n## 검색된 참조 문서\n검색어: \"${this.ragContext.searchQuery}\"\n\n${docs}\n\n⚠️ 위 문서의 정보를 우선 참조하되, 최신 정보와 타임스탬프를 확인하세요.\n</context>`;\n    }\n\n    /**\n     * 제약 조건 섹션 생성\n     */\n    private buildConstraintsSection(): string {\n        if (!this.pillars.constraints || this.pillars.constraints.length === 0) {\n            return '';\n        }\n\n        // 우선순위별 정렬\n        const sortedConstraints = [...this.pillars.constraints].sort((a, b) => {\n            const priority = { critical: 0, high: 1, medium: 2, low: 3 };\n            return priority[a.priority] - priority[b.priority];\n        });\n\n        const criticalRules = sortedConstraints\n            .filter(c => c.priority === 'critical')\n            .map(c => `🚫 [필수] ${c.rule}`)\n            .join('\\n');\n\n        const otherRules = sortedConstraints\n            .filter(c => c.priority !== 'critical')\n            .map(c => `⚠️ [${c.priority.toUpperCase()}] ${c.rule}`)\n            .join('\\n');\n\n        return `<constraints>\n## 🔒 절대 규칙 (위반 불가)\n${criticalRules}\n\n## ⚠️ 일반 제약\n${otherRules}\n</constraints>`;\n    }\n\n    /**\n     * 출력 형식 섹션 생성\n     */\n    private buildOutputFormatSection(): string {\n        if (!this.pillars.outputFormat) {\n            return '';\n        }\n\n        const { outputFormat } = this.pillars;\n        let formatDesc = '';\n\n        switch (outputFormat.type) {\n            case 'json':\n                formatDesc = `JSON 형식으로 출력하세요.\n${outputFormat.schema ? `스키마:\\n\\`\\`\\`json\\n${JSON.stringify(outputFormat.schema, null, 2)}\\n\\`\\`\\`` : ''}`;\n                break;\n            case 'markdown':\n                formatDesc = '마크다운 형식으로 구조화하여 출력하세요. 헤더(##), 목록(-), 코드블록(\\`\\`\\`)을 활용하세요.';\n                break;\n            case 'table':\n                formatDesc = '정보를 표 형식으로 정리하세요. | 헤더 | 형식을 사용하세요.';\n                break;\n            case 'code':\n                formatDesc = '코드 블록으로 출력하세요. 언어 태그를 포함하세요.';\n                break;\n            default:\n                formatDesc = '자연스러운 문장으로 답변하세요.';\n        }\n\n        return `<output_format>\n## 출력 형식 지침\n${formatDesc}\n\n${outputFormat.examples?.length ? `### 출력 예시\\n${outputFormat.examples.join('\\n\\n')}` : ''}\n</output_format>`;\n    }\n\n    /**\n     * 소프트 인터락 섹션 (사고 과정 강제)\n     */\n    private buildSoftInterlockSection(): string {\n        return `<instruction>\n## 🧠 답변 전 사고 프로세스 (Soft Interlock)\n\n답변을 생성하기 전에 반드시 다음 과정을 내부적으로 수행하세요:\n\n1. **문제 분석**: 사용자가 정확히 무엇을 원하는가?\n2. **정보 검증**: 내가 알고 있는 정보가 정확한가? 불확실한 부분은 무엇인가?\n3. **접근 전략**: 어떤 방식으로 설명/해결할 것인가?\n4. **안전성 검증**: 이 답변이 안전하고 윤리적인가?\n5. **형식 결정**: 어떤 형식이 가장 효과적인가?\n\n## 📊 인식적 구배 (Epistemic Gradient)\n\n답변 시 정보의 확실성을 명확히 구분하세요:\n- **확실한 사실**: 직접적으로 서술\n- **높은 확신**: \"~입니다\" 또는 \"~합니다\"\n- **중간 확신**: \"제가 알기로는~\" 또는 \"일반적으로~\"\n- **낮은 확신**: \"확인이 필요하지만~\" 또는 \"추측하건대~\"\n- **모름**: \"이 부분은 정확한 정보가 없습니다\"\n\n⚠️ 환각(Hallucination) 방지: 모르는 것은 솔직히 인정하세요.\n</instruction>`;\n    }\n\n    /**\n     * 최종 강조 규칙 (위치 공학: 끝에 반복)\n     */\n    private buildFinalReminder(): string {\n        return `<final_reminder>\n## 🎯 최종 확인 사항 (반드시 준수)\n\n1. **언어 규칙**: ${this.metadata.userLanguage === 'ko' ? '한국어로 답변 (언어 혼용 금지)' : '영어로 답변'}\n2. **환각 금지**: 불확실한 정보는 명시적으로 표현\n3. **구조화**: 복잡한 답변은 헤더와 목록으로 정리\n4. **완전성**: 질문에 대한 완전한 답변 제공\n\n위 규칙을 재확인한 후 답변을 생성하세요.\n</final_reminder>`;\n    }\n}\n\n// ============================================================\n// 프리셋 프롬프트 빌더\n// ============================================================\n\n/**\n * 기본 어시스턴트 프롬프트 빌더\n */\nexport function buildAssistantPrompt(): string {\n    return new ContextEngineeringBuilder()\n        .setRole({\n            persona: '친절하고 똑똑한 AI 어시스턴트',\n            expertise: ['일반 지식', '문제 해결', '정보 정리', '대화'],\n            behavioralTraits: [\n                '친근하고 편안한 어조 사용',\n                '어려운 용어는 쉽게 풀어서 설명',\n                '이모지를 적절히 활용하여 친근감 표현'\n            ],\n            toneStyle: 'friendly'\n        })\n        .addConstraint({\n            rule: '한국어 질문에는 반드시 한국어로 답변',\n            priority: 'critical',\n            category: 'language'\n        })\n        .addConstraint({\n            rule: '언어 혼용(Code Switching) 절대 금지',\n            priority: 'critical',\n            category: 'language'\n        })\n        .addConstraint({\n            rule: '확실하지 않은 정보는 명시적으로 인정',\n            priority: 'high',\n            category: 'content'\n        })\n        .setGoal('사용자의 질문에 친절하고 정확하게 답변하며, 이해하기 쉽게 설명')\n        .setOutputFormat({\n            type: 'markdown',\n            examples: [\n                '질문에 대한 핵심 답변을 먼저 제공한 후, 추가 설명을 덧붙이세요.'\n            ]\n        })\n        .build();\n}\n\n/**\n * 코딩 전문가 프롬프트 빌더\n */\nexport function buildCoderPrompt(): string {\n    return new ContextEngineeringBuilder()\n        .setRole({\n            persona: '15년 경력의 시니어 풀스택 개발자',\n            expertise: [\n                'TypeScript, Python, Go, Rust',\n                'React, Next.js, FastAPI, Express',\n                'Docker, Kubernetes, AWS',\n                'Clean Code, SOLID, TDD'\n            ],\n            behavioralTraits: [\n                '프로덕션 수준의 안전한 코드 작성',\n                '에러 핸들링과 엣지 케이스 고려',\n                '성능 최적화 관점에서 설계'\n            ],\n            toneStyle: 'professional'\n        })\n        .addConstraint({\n            rule: '모든 설명과 주석은 한국어로 작성',\n            priority: 'critical',\n            category: 'language'\n        })\n        .addConstraint({\n            rule: '완전하고 실행 가능한 코드만 제공 (TODO, ... 금지)',\n            priority: 'critical',\n            category: 'content'\n        })\n        .addConstraint({\n            rule: '보안 취약점 없는 코드 작성 (OWASP Top 10 준수)',\n            priority: 'high',\n            category: 'security'\n        })\n        .setGoal('사용자의 요구사항을 분석하고 프로덕션 수준의 완전한 코드 제공')\n        .setOutputFormat({\n            type: 'structured',\n            examples: [\n                '### 1. 요구사항 분석\\n### 2. 설계 방향\\n### 3. 구현 코드\\n### 4. 실행 방법\\n### 5. 테스트'\n            ]\n        })\n        .build();\n}\n\n/**\n * 추론 전문가 프롬프트 빌더\n */\nexport function buildReasoningPrompt(): string {\n    return new ContextEngineeringBuilder()\n        .setRole({\n            persona: '논리적 분석 및 추론 전문가',\n            expertise: [\n                '복잡한 문제 분해 및 분석',\n                '단계별 논리적 추론',\n                '수학적 계산 및 비교',\n                '의사결정 및 트레이드오프 분석'\n            ],\n            behavioralTraits: [\n                '모든 문제에 Chain of Thought 적용',\n                '각 단계의 논리를 명확히 설명',\n                '결론에 도달한 과정을 투명하게 제시'\n            ],\n            toneStyle: 'professional'\n        })\n        .addConstraint({\n            rule: '모든 추론과 답변은 한국어로 작성',\n            priority: 'critical',\n            category: 'language'\n        })\n        .addConstraint({\n            rule: '복잡한 문제는 반드시 단계별로 분해하여 접근',\n            priority: 'high',\n            category: 'behavior'\n        })\n        .setGoal('복잡한 문제를 단계별로 분석하고 논리적인 결론 도출')\n        .setOutputFormat({\n            type: 'structured',\n            examples: [\n                '<think>\\n1단계: 문제 이해\\n2단계: 핵심 정보 파악\\n3단계: 분석 실행\\n4단계: 검증\\n</think>\\n\\n### 결론\\n[최종 답변]'\n            ]\n        })\n        .setThinkingEnabled(true)\n        .build();\n}\n\n/**\n * 유틸리티: 동적 메타데이터 생성\n */\nexport function createDynamicMetadata(): PromptMetadata {\n    const now = new Date();\n    return {\n        currentDate: now.toISOString().split('T')[0],\n        knowledgeCutoff: '2024-12',\n        userLanguage: 'ko',\n        requestTimestamp: now.toISOString(),\n        sessionId: `session_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`\n    };\n}\n\n/**\n * 언어 감지 및 메타데이터 업데이트\n */\nexport function detectLanguageForMetadata(text: string): 'ko' | 'en' | 'mixed' {\n    const koreanRegex = /[가-힣]/g;\n    const englishRegex = /[a-zA-Z]/g;\n\n    const koreanMatches = (text.match(koreanRegex) || []).length;\n    const englishMatches = (text.match(englishRegex) || []).length;\n\n    const total = koreanMatches + englishMatches;\n    if (total === 0) return 'en';\n\n    const koreanRatio = koreanMatches / total;\n\n    if (koreanRatio > 0.7) return 'ko';\n    if (koreanRatio < 0.3) return 'en';\n    return 'mixed';\n}\n\n// 기본 내보내기\nexport default ContextEngineeringBuilder;\n"],"version":3}