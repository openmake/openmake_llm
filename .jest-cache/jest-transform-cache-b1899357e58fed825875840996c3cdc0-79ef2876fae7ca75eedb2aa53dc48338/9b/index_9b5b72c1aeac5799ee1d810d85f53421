55c0b69e4c9d256780f23d51f8334b12
"use strict";
/**
 * Ïù∏Ï¶ù Î™®Îìà
 * JWT ÌÜ†ÌÅ∞ ÏÉùÏÑ±/Í≤ÄÏ¶ù Î∞è Ïù∏Ï¶ù Ïú†Ìã∏Î¶¨Ìã∞
 *
 * #8 Ïó∞Îèô: ÌÜ†ÌÅ∞ Î∏îÎûôÎ¶¨Ïä§Ìä∏ (PostgreSQL-backed) ÌÜµÌï©
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __exportStar = (this && this.__exportStar) || function(m, exports) {
    for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.requireRole = exports.requireAdmin = exports.requireAuth = exports.optionalAuth = void 0;
exports.generateToken = generateToken;
exports.generateRefreshToken = generateRefreshToken;
exports.verifyRefreshToken = verifyRefreshToken;
exports.verifyToken = verifyToken;
exports.blacklistToken = blacklistToken;
exports.extractToken = extractToken;
exports.hasPermission = hasPermission;
exports.isAdmin = isAdmin;
exports.setTokenCookie = setTokenCookie;
exports.setRefreshTokenCookie = setRefreshTokenCookie;
exports.clearTokenCookie = clearTokenCookie;
const jwt = __importStar(require("jsonwebtoken"));
const crypto = __importStar(require("crypto"));
const token_blacklist_1 = require("../data/models/token-blacklist");
const env_1 = require("../config/env");
// JWT ÎπÑÎ∞ÄÌÇ§ (ÌôòÍ≤ΩÎ≥ÄÏàò ÌïÑÏàò)
// Î≥¥Ïïà: Îü∞ÌÉÄÏûÑ ÏãúÌÅ¨Î¶ø ÏÉùÏÑ±ÏùÄ ÏàòÌèâ ÌôïÏû• Ïãú ÎÖ∏Îìú Í∞Ñ Î∂àÏùºÏπòÎ•º Ïú†Î∞úÌïòÎØÄÎ°ú Ï†úÍ±∞
const JWT_SECRET = (0, env_1.getConfig)().jwtSecret;
const JWT_EXPIRES_IN = '15m'; // Access token - short lived for security
const REFRESH_TOKEN_EXPIRES_IN = '7d'; // Refresh token - longer lived
// JWT_SECRET ÎØ∏ÏÑ§Ï†ï Ïãú Î™®Îì† ÌôòÍ≤ΩÏóêÏÑú ÏóêÎü¨ (ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω Ï†úÏô∏)
if (!JWT_SECRET) {
    if ((0, env_1.getConfig)().nodeEnv === 'test') {
        // ÌÖåÏä§Ìä∏ ÌôòÍ≤ΩÏóêÏÑúÎäî Í≤ΩÍ≥†Îßå (ÌÖåÏä§Ìä∏ ÌîÑÎ†àÏûÑÏõåÌÅ¨ÏóêÏÑú ÏûêÏ≤¥ ÏÑ§Ï†ï)
        console.warn('[Auth] ‚ö†Ô∏è JWT_SECRETÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§ (ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω)');
    }
    else {
        console.error('[Auth] ‚ùå JWT_SECRET ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!');
        console.error('[Auth] .env ÌååÏùºÏóê JWT_SECRETÏùÑ Î∞òÎìúÏãú ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.');
        console.error('[Auth] Ïòà: JWT_SECRET=$(openssl rand -hex 32)');
        throw new Error('[Auth] JWT_SECRET ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÌïÑÏàòÏûÖÎãàÎã§. .env ÌååÏùºÏóê ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.');
    }
}
/**
 * JWT Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ ÏÉùÏÑ±
 * #8 Ïó∞Îèô: jti (JWT ID) Ï∂îÍ∞ÄÎ°ú Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÏßÄÏõê
 */
function generateToken(user) {
    const payload = {
        userId: user.id,
        email: user.email,
        role: user.role
    };
    // jti(JWT ID)Î•º Ï∂îÍ∞ÄÌïòÏó¨ ÌÜ†ÌÅ∞ Îã®ÏúÑ Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÏßÄÏõê
    const jti = crypto.randomBytes(16).toString('hex');
    return jwt.sign(payload, JWT_SECRET, {
        expiresIn: JWT_EXPIRES_IN,
        jwtid: jti
    });
}
/**
 * üîí Phase 2 Î≥¥Ïïà Ìå®Ïπò: JWT Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞ ÏÉùÏÑ±
 *
 * Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞(15Î∂Ñ)Ïù¥ ÎßåÎ£åÎêú ÌõÑ ÏÉà Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ÏùÑ Î∞úÍ∏âÎ∞õÍ∏∞ ÏúÑÌïú Ïû•Í∏∞ ÌÜ†ÌÅ∞ÏûÖÎãàÎã§.
 * - ÎßåÎ£å: 7Ïùº
 * - jti Ìè¨Ìï® (Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÏßÄÏõê)
 * - type: 'refresh' ÌïÑÎìúÎ°ú Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞Í≥º Íµ¨Î∂Ñ
 */
function generateRefreshToken(user) {
    const payload = {
        userId: user.id,
        email: user.email,
        role: user.role,
        type: 'refresh'
    };
    const jti = crypto.randomBytes(16).toString('hex');
    return jwt.sign(payload, JWT_SECRET, {
        expiresIn: REFRESH_TOKEN_EXPIRES_IN,
        jwtid: jti
    });
}
/**
 * üîí Phase 2: Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù
 * Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ Í∞±Ïã†Ïö© Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞ÏùÑ Í≤ÄÏ¶ùÌï©ÎãàÎã§.
 *
 * @returns Í≤ÄÏ¶ùÎêú ÌéòÏù¥Î°úÎìú ÎòêÎäî null
 */
function verifyRefreshToken(token) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            // Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÌôïÏù∏
            const preCheck = jwt.decode(token);
            if ((preCheck === null || preCheck === void 0 ? void 0 : preCheck.jti) && typeof preCheck.jti === 'string') {
                try {
                    const blacklist = (0, token_blacklist_1.getTokenBlacklist)();
                    if (yield blacklist.has(preCheck.jti)) {
                        console.warn('[Auth] Î∏îÎûôÎ¶¨Ïä§Ìä∏Îêú Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞ ÏÇ¨Ïö© ÏãúÎèÑ');
                        return null;
                    }
                }
                catch (_a) {
                    // Î∏îÎûôÎ¶¨Ïä§Ìä∏ DB Ï†ëÍ∑º Ïã§Ìå® Ïãú Î¨¥Ïãú (Í∞ÄÏö©ÏÑ± Ïö∞ÏÑ†)
                }
            }
            // typeÏù¥ 'refresh'Ïù∏ÏßÄ ÌôïÏù∏
            if ((preCheck === null || preCheck === void 0 ? void 0 : preCheck.type) !== 'refresh') {
                console.warn('[Auth] Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞Ïù¥ ÏïÑÎãå ÌÜ†ÌÅ∞ÏúºÎ°ú Í∞±Ïã† ÏãúÎèÑ');
                return null;
            }
            const decoded = jwt.verify(token, JWT_SECRET);
            return decoded;
        }
        catch (error) {
            console.error('[Auth] Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù Ïã§Ìå®:', error);
            return null;
        }
    });
}
/**
 * JWT ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù
 * #8 Ïó∞Îèô: Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÌôïÏù∏ Ï∂îÍ∞Ä
 */
function verifyToken(token) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            // Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÌôïÏù∏ (jti Í∏∞Î∞ò)
            const preCheck = jwt.decode(token);
            if ((preCheck === null || preCheck === void 0 ? void 0 : preCheck.jti) && typeof preCheck.jti === 'string') {
                try {
                    const blacklist = (0, token_blacklist_1.getTokenBlacklist)();
                    if (yield blacklist.has(preCheck.jti)) {
                        console.warn('[Auth] Î∏îÎûôÎ¶¨Ïä§Ìä∏Îêú ÌÜ†ÌÅ∞ ÏÇ¨Ïö© ÏãúÎèÑ');
                        return null;
                    }
                }
                catch (_a) {
                    // Î∏îÎûôÎ¶¨Ïä§Ìä∏ DB Ï†ëÍ∑º Ïã§Ìå® Ïãú Î¨¥Ïãú (Í∞ÄÏö©ÏÑ± Ïö∞ÏÑ†)
                }
            }
            const decoded = jwt.verify(token, JWT_SECRET);
            return decoded;
        }
        catch (error) {
            console.error('[Auth] ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù Ïã§Ìå®:', error);
            return null;
        }
    });
}
/**
 * ÌÜ†ÌÅ∞ÏùÑ Î∏îÎûôÎ¶¨Ïä§Ìä∏Ïóê Ï∂îÍ∞Ä (Î°úÍ∑∏ÏïÑÏõÉ Ïãú Ìò∏Ï∂ú)
 * #8 Ïó∞Îèô: PostgreSQL Í∏∞Î∞ò ÏòÅÏÜç Î∏îÎûôÎ¶¨Ïä§Ìä∏
 */
function blacklistToken(token) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            const decoded = jwt.decode(token);
            if (!(decoded === null || decoded === void 0 ? void 0 : decoded.jti) || typeof decoded.jti !== 'string') {
                // jti ÏóÜÎäî Î†àÍ±∞Ïãú ÌÜ†ÌÅ∞ ‚Äî Î∏îÎûôÎ¶¨Ïä§Ìä∏ Î∂àÍ∞Ä
                return false;
            }
            const expiresAt = typeof decoded.exp === 'number'
                ? decoded.exp * 1000
                : Date.now() + 15 * 60 * 1000; // Í∏∞Î≥∏ 15Î∂Ñ
            const blacklist = (0, token_blacklist_1.getTokenBlacklist)();
            yield blacklist.add(decoded.jti, expiresAt);
            console.log(`[Auth] üö´ ÌÜ†ÌÅ∞ Î∏îÎûôÎ¶¨Ïä§Ìä∏ Ï∂îÍ∞Ä: ${decoded.jti.substring(0, 8)}...`);
            return true;
        }
        catch (error) {
            console.error('[Auth] ÌÜ†ÌÅ∞ Î∏îÎûôÎ¶¨Ïä§Ìä∏ Ï∂îÍ∞Ä Ïã§Ìå®:', error);
            return false;
        }
    });
}
/**
 * Authorization Ìó§ÎçîÏóêÏÑú ÌÜ†ÌÅ∞ Ï∂îÏ∂ú
 */
function extractToken(authHeader) {
    if (!authHeader)
        return null;
    // "Bearer <token>" ÌòïÏãù
    if (authHeader.startsWith('Bearer ')) {
        return authHeader.slice(7);
    }
    return authHeader;
}
/**
 * Ïó≠Ìï† Í∂åÌïú Ï≤¥ÌÅ¨
 */
function hasPermission(userRole, requiredRole) {
    const roleHierarchy = {
        'admin': 3,
        'user': 2,
        'guest': 1
    };
    return roleHierarchy[userRole] >= roleHierarchy[requiredRole];
}
/**
 * Í¥ÄÎ¶¨Ïûê Ïó¨Î∂Ä ÌôïÏù∏
 */
function isAdmin(role) {
    return role === 'admin';
}
// Î™®Îìà Ïû¨-export
__exportStar(require("./types"), exports);
var middleware_1 = require("./middleware");
Object.defineProperty(exports, "optionalAuth", { enumerable: true, get: function () { return middleware_1.optionalAuth; } });
Object.defineProperty(exports, "requireAuth", { enumerable: true, get: function () { return middleware_1.requireAuth; } });
Object.defineProperty(exports, "requireAdmin", { enumerable: true, get: function () { return middleware_1.requireAdmin; } });
Object.defineProperty(exports, "requireRole", { enumerable: true, get: function () { return middleware_1.requireRole; } });
/**
 * ÌÜ†ÌÅ∞ÏùÑ httpOnly Ïø†ÌÇ§Ïóê ÏÑ§Ï†ï
 * üîí Phase 2: Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ Ïø†ÌÇ§ (15Î∂Ñ ÎßåÎ£å)
 */
function setTokenCookie(res, token) {
    res.cookie('auth_token', token, {
        httpOnly: true,
        secure: (0, env_1.getConfig)().nodeEnv === 'production',
        sameSite: 'lax',
        maxAge: 15 * 60 * 1000, // 15Î∂Ñ (Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ ÏàòÎ™ÖÍ≥º ÏùºÏπò)
        path: '/'
    });
}
/**
 * üîí Phase 2: Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞ÏùÑ httpOnly Ïø†ÌÇ§Ïóê ÏÑ§Ï†ï (7Ïùº ÎßåÎ£å)
 */
function setRefreshTokenCookie(res, refreshToken) {
    res.cookie('refresh_token', refreshToken, {
        httpOnly: true,
        secure: (0, env_1.getConfig)().nodeEnv === 'production',
        sameSite: 'lax',
        maxAge: 7 * 24 * 60 * 60 * 1000, // 7Ïùº
        path: '/api/auth/refresh' // Î¶¨ÌîÑÎ†àÏãú ÏóîÎìúÌè¨Ïù∏Ìä∏ÏóêÏÑúÎßå Ï†ÑÏÜ°
    });
}
/**
 * ÌÜ†ÌÅ∞ Ïø†ÌÇ§ ÏÇ≠Ï†ú
 * üîí Phase 2: Ïï°ÏÑ∏Ïä§ + Î¶¨ÌîÑÎ†àÏãú Ïø†ÌÇ§ Î™®Îëê ÏÇ≠Ï†ú
 */
function clearTokenCookie(res) {
    res.clearCookie('auth_token', { path: '/' });
    res.clearCookie('refresh_token', { path: '/api/auth/refresh' });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL2F1dGgvaW5kZXgudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFrQ0gsc0NBY0M7QUFVRCxvREFjQztBQVFELGdEQTRCQztBQU1ELGtDQXNCQztBQU1ELHdDQW1CQztBQUtELG9DQVNDO0FBS0Qsc0NBUUM7QUFLRCwwQkFFQztBQVVELHdDQVFDO0FBS0Qsc0RBUUM7QUFNRCw0Q0FHQztBQXpPRCxrREFBb0M7QUFJcEMsK0NBQWlDO0FBQ2pDLG9FQUFtRTtBQUNuRSx1Q0FBMEM7QUFFMUMsb0JBQW9CO0FBQ3BCLDZDQUE2QztBQUM3QyxNQUFNLFVBQVUsR0FBRyxJQUFBLGVBQVMsR0FBRSxDQUFDLFNBQVMsQ0FBQztBQUN6QyxNQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsQ0FBRSwwQ0FBMEM7QUFDekUsTUFBTSx3QkFBd0IsR0FBRyxJQUFJLENBQUMsQ0FBRSwrQkFBK0I7QUFFdkUsMENBQTBDO0FBQzFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUNkLElBQUksSUFBQSxlQUFTLEdBQUUsQ0FBQyxPQUFPLEtBQUssTUFBTSxFQUFFLENBQUM7UUFDakMsb0NBQW9DO1FBQ3BDLE9BQU8sQ0FBQyxJQUFJLENBQUMsMkNBQTJDLENBQUMsQ0FBQztJQUM5RCxDQUFDO1NBQU0sQ0FBQztRQUNKLE9BQU8sQ0FBQyxLQUFLLENBQUMsdUNBQXVDLENBQUMsQ0FBQztRQUN2RCxPQUFPLENBQUMsS0FBSyxDQUFDLHdDQUF3QyxDQUFDLENBQUM7UUFDeEQsT0FBTyxDQUFDLEtBQUssQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO1FBQzlELE1BQU0sSUFBSSxLQUFLLENBQUMsZ0RBQWdELENBQUMsQ0FBQztJQUN0RSxDQUFDO0FBQ0wsQ0FBQztBQUdEOzs7R0FHRztBQUNILFNBQWdCLGFBQWEsQ0FBQyxJQUFnQjtJQUMxQyxN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SUFBSSxFQUFFLG1CQUFtQixFQUFFLENBQUMsQ0FBQztBQUNwRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Wb2x1bWVzL01BQ19BUFAvb3Blbm1ha2VfbGxtL2JhY2tlbmQvYXBpL3NyYy9hdXRoL2luZGV4LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICog7J247KadIOuqqOuTiFxuICogSldUIO2GoO2BsCDsg53shLEv6rKA7KadIOuwjyDsnbjspp0g7Jyg7Yu466as7YuwXG4gKiBcbiAqICM4IOyXsOuPmTog7Yag7YGwIOu4lOuemeumrOyKpO2KuCAoUG9zdGdyZVNRTC1iYWNrZWQpIO2Gte2VqVxuICovXG5cbmltcG9ydCAqIGFzIGp3dCBmcm9tICdqc29ud2VidG9rZW4nO1xuaW1wb3J0IHR5cGUgeyBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgSldUUGF5bG9hZCB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgUHVibGljVXNlciwgVXNlclJvbGUgfSBmcm9tICcuLi9kYXRhL3VzZXItbWFuYWdlcic7XG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCB7IGdldFRva2VuQmxhY2tsaXN0IH0gZnJvbSAnLi4vZGF0YS9tb2RlbHMvdG9rZW4tYmxhY2tsaXN0JztcbmltcG9ydCB7IGdldENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9lbnYnO1xuXG4vLyBKV1Qg67mE67CA7YKkICjtmZjqsr3rs4DsiJgg7ZWE7IiYKVxuLy8g67O07JWIOiDrn7Dtg4DsnoQg7Iuc7YGs66a/IOyDneyEseydgCDsiJjtj4kg7ZmV7J6lIOyLnCDrhbjrk5wg6rCEIOu2iOydvOy5mOulvCDsnKDrsJztlZjrr4DroZwg7KCc6rGwXG5jb25zdCBKV1RfU0VDUkVUID0gZ2V0Q29uZmlnKCkuand0U2VjcmV0O1xuY29uc3QgSldUX0VYUElSRVNfSU4gPSAnMTVtJzsgIC8vIEFjY2VzcyB0b2tlbiAtIHNob3J0IGxpdmVkIGZvciBzZWN1cml0eVxuY29uc3QgUkVGUkVTSF9UT0tFTl9FWFBJUkVTX0lOID0gJzdkJzsgIC8vIFJlZnJlc2ggdG9rZW4gLSBsb25nZXIgbGl2ZWRcblxuLy8gSldUX1NFQ1JFVCDrr7jshKTsoJUg7IucIOuqqOuToCDtmZjqsr3sl5DshJwg7JeQ65+sICjthYzsiqTtirgg7ZmY6rK9IOygnOyZuClcbmlmICghSldUX1NFQ1JFVCkge1xuICAgIGlmIChnZXRDb25maWcoKS5ub2RlRW52ID09PSAndGVzdCcpIHtcbiAgICAgICAgLy8g7YWM7Iqk7Yq4IO2ZmOqyveyXkOyEnOuKlCDqsr3qs6Drp4wgKO2FjOyKpO2KuCDtlITroIjsnoTsm4ztgazsl5DshJwg7J6Q7LK0IOyEpOyglSlcbiAgICAgICAgY29uc29sZS53YXJuKCdbQXV0aF0g4pqg77iPIEpXVF9TRUNSRVTsnbQg7ISk7KCV65CY7KeAIOyViuyVmOyKteuLiOuLpCAo7YWM7Iqk7Yq4IO2ZmOqyvSknKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdbQXV0aF0g4p2MIEpXVF9TRUNSRVQg7ZmY6rK967OA7IiY6rCAIOyEpOygleuQmOyngCDslYrslZjsirXri4jri6QhJyk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tBdXRoXSAuZW52IO2MjOydvOyXkCBKV1RfU0VDUkVU7J2EIOuwmOuTnOyLnCDshKTsoJXtlZjshLjsmpQuJyk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tBdXRoXSDsmIg6IEpXVF9TRUNSRVQ9JChvcGVuc3NsIHJhbmQgLWhleCAzMiknKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdbQXV0aF0gSldUX1NFQ1JFVCDtmZjqsr3rs4DsiJjqsIAg7ZWE7IiY7J6F64uI64ukLiAuZW52IO2MjOydvOyXkCDshKTsoJXtlZjshLjsmpQuJyk7XG4gICAgfVxufVxuXG5cbi8qKlxuICogSldUIOyVoeyEuOyKpCDthqDtgbAg7IOd7ISxXG4gKiAjOCDsl7Drj5k6IGp0aSAoSldUIElEKSDstpTqsIDroZwg67iU656Z66as7Iqk7Yq4IOyngOybkFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVUb2tlbih1c2VyOiBQdWJsaWNVc2VyKTogc3RyaW5nIHtcbiAgICBjb25zdCBwYXlsb2FkOiBKV1RQYXlsb2FkID0ge1xuICAgICAgICB1c2VySWQ6IHVzZXIuaWQsXG4gICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICByb2xlOiB1c2VyLnJvbGVcbiAgICB9O1xuXG4gICAgLy8ganRpKEpXVCBJRCnrpbwg7LaU6rCA7ZWY7JesIO2GoO2BsCDri6jsnIQg67iU656Z66as7Iqk7Yq4IOyngOybkFxuICAgIGNvbnN0IGp0aSA9IGNyeXB0by5yYW5kb21CeXRlcygxNikudG9TdHJpbmcoJ2hleCcpO1xuXG4gICAgcmV0dXJuIGp3dC5zaWduKHBheWxvYWQsIEpXVF9TRUNSRVQsIHsgXG4gICAgICAgIGV4cGlyZXNJbjogSldUX0VYUElSRVNfSU4sXG4gICAgICAgIGp3dGlkOiBqdGlcbiAgICB9KTtcbn1cblxuLyoqXG4gKiDwn5SSIFBoYXNlIDIg67O07JWIIO2MqOy5mDogSldUIOumrO2UhOugiOyLnCDthqDtgbAg7IOd7ISxXG4gKiBcbiAqIOyVoeyEuOyKpCDthqDtgbAoMTXrtoQp7J20IOunjOujjOuQnCDtm4Qg7IOIIOyVoeyEuOyKpCDthqDtgbDsnYQg67Cc6riJ67Cb6riwIOychO2VnCDsnqXquLAg7Yag7YGw7J6F64uI64ukLlxuICogLSDrp4zro4w6IDfsnbxcbiAqIC0ganRpIO2PrO2VqCAo67iU656Z66as7Iqk7Yq4IOyngOybkClcbiAqIC0gdHlwZTogJ3JlZnJlc2gnIO2VhOuTnOuhnCDslaHshLjsiqQg7Yag7YGw6rO8IOq1rOu2hFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVSZWZyZXNoVG9rZW4odXNlcjogUHVibGljVXNlcik6IHN0cmluZyB7XG4gICAgY29uc3QgcGF5bG9hZCA9IHtcbiAgICAgICAgdXNlcklkOiB1c2VyLmlkLFxuICAgICAgICBlbWFpbDogdXNlci5lbWFpbCxcbiAgICAgICAgcm9sZTogdXNlci5yb2xlLFxuICAgICAgICB0eXBlOiAncmVmcmVzaCcgYXMgY29uc3RcbiAgICB9O1xuXG4gICAgY29uc3QganRpID0gY3J5cHRvLnJhbmRvbUJ5dGVzKDE2KS50b1N0cmluZygnaGV4Jyk7XG5cbiAgICByZXR1cm4gand0LnNpZ24ocGF5bG9hZCwgSldUX1NFQ1JFVCwge1xuICAgICAgICBleHBpcmVzSW46IFJFRlJFU0hfVE9LRU5fRVhQSVJFU19JTixcbiAgICAgICAgand0aWQ6IGp0aVxuICAgIH0pO1xufVxuXG4vKipcbiAqIPCflJIgUGhhc2UgMjog66as7ZSE66CI7IucIO2GoO2BsCDqsoDspp1cbiAqIOyVoeyEuOyKpCDthqDtgbAg6rCx7Iug7JqpIOumrO2UhOugiOyLnCDthqDtgbDsnYQg6rKA7Kad7ZWp64uI64ukLlxuICogXG4gKiBAcmV0dXJucyDqsoDspp3rkJwg7Y6Y7J2066Gc65OcIOuYkOuKlCBudWxsXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB2ZXJpZnlSZWZyZXNoVG9rZW4odG9rZW46IHN0cmluZyk6IFByb21pc2U8SldUUGF5bG9hZCB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgICAvLyDruJTrnpnrpqzsiqTtirgg7ZmV7J24XG4gICAgICAgIGNvbnN0IHByZUNoZWNrID0gand0LmRlY29kZSh0b2tlbikgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4gfCBudWxsO1xuICAgICAgICBpZiAocHJlQ2hlY2s/Lmp0aSAmJiB0eXBlb2YgcHJlQ2hlY2suanRpID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBibGFja2xpc3QgPSBnZXRUb2tlbkJsYWNrbGlzdCgpO1xuICAgICAgICAgICAgICAgIGlmIChhd2FpdCBibGFja2xpc3QuaGFzKHByZUNoZWNrLmp0aSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdbQXV0aF0g67iU656Z66as7Iqk7Yq465CcIOumrO2UhOugiOyLnCDthqDtgbAg7IKs7JqpIOyLnOuPhCcpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgICAgICAvLyDruJTrnpnrpqzsiqTtirggREIg7KCR6re8IOyLpO2MqCDsi5wg66y07IucICjqsIDsmqnshLEg7Jqw7ISgKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gdHlwZeydtCAncmVmcmVzaCfsnbjsp4Ag7ZmV7J24XG4gICAgICAgIGlmIChwcmVDaGVjaz8udHlwZSAhPT0gJ3JlZnJlc2gnKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ1tBdXRoXSDrpqztlITroIjsi5wg7Yag7YGw7J20IOyVhOuLjCDthqDtgbDsnLzroZwg6rCx7IugIOyLnOuPhCcpO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkZWNvZGVkID0gand0LnZlcmlmeSh0b2tlbiwgSldUX1NFQ1JFVCkgYXMgdW5rbm93biBhcyBKV1RQYXlsb2FkO1xuICAgICAgICByZXR1cm4gZGVjb2RlZDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdbQXV0aF0g66as7ZSE66CI7IucIO2GoO2BsCDqsoDspp0g7Iuk7YyoOicsIGVycm9yKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxufVxuXG4vKipcbiAqIEpXVCDthqDtgbAg6rKA7KadXG4gKiAjOCDsl7Drj5k6IOu4lOuemeumrOyKpO2KuCDtmZXsnbgg7LaU6rCAXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB2ZXJpZnlUb2tlbih0b2tlbjogc3RyaW5nKTogUHJvbWlzZTxKV1RQYXlsb2FkIHwgbnVsbD4ge1xuICAgIHRyeSB7XG4gICAgICAgIC8vIOu4lOuemeumrOyKpO2KuCDtmZXsnbggKGp0aSDquLDrsJgpXG4gICAgICAgIGNvbnN0IHByZUNoZWNrID0gand0LmRlY29kZSh0b2tlbikgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4gfCBudWxsO1xuICAgICAgICBpZiAocHJlQ2hlY2s/Lmp0aSAmJiB0eXBlb2YgcHJlQ2hlY2suanRpID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBibGFja2xpc3QgPSBnZXRUb2tlbkJsYWNrbGlzdCgpO1xuICAgICAgICAgICAgICAgIGlmIChhd2FpdCBibGFja2xpc3QuaGFzKHByZUNoZWNrLmp0aSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdbQXV0aF0g67iU656Z66as7Iqk7Yq465CcIO2GoO2BsCDsgqzsmqkg7Iuc64+EJyk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgICAgICAgIC8vIOu4lOuemeumrOyKpO2KuCBEQiDsoJHqt7wg7Iuk7YyoIOyLnCDrrLTsi5wgKOqwgOyaqeyEsSDsmrDshKApXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkZWNvZGVkID0gand0LnZlcmlmeSh0b2tlbiwgSldUX1NFQ1JFVCkgYXMgdW5rbm93biBhcyBKV1RQYXlsb2FkO1xuICAgICAgICByZXR1cm4gZGVjb2RlZDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdbQXV0aF0g7Yag7YGwIOqygOymnSDsi6TtjKg6JywgZXJyb3IpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59XG5cbi8qKlxuICog7Yag7YGw7J2EIOu4lOuemeumrOyKpO2KuOyXkCDstpTqsIAgKOuhnOq3uOyVhOybgyDsi5wg7Zi47LacKVxuICogIzgg7Jew64+ZOiBQb3N0Z3JlU1FMIOq4sOuwmCDsmIHsho0g67iU656Z66as7Iqk7Yq4XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBibGFja2xpc3RUb2tlbih0b2tlbjogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZGVjb2RlZCA9IGp3dC5kZWNvZGUodG9rZW4pIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+IHwgbnVsbDtcbiAgICAgICAgaWYgKCFkZWNvZGVkPy5qdGkgfHwgdHlwZW9mIGRlY29kZWQuanRpICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgLy8ganRpIOyXhuuKlCDroIjqsbDsi5wg7Yag7YGwIOKAlCDruJTrnpnrpqzsiqTtirgg67aI6rCAXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZXhwaXJlc0F0ID0gdHlwZW9mIGRlY29kZWQuZXhwID09PSAnbnVtYmVyJyBcbiAgICAgICAgICAgID8gZGVjb2RlZC5leHAgKiAxMDAwIFxuICAgICAgICAgICAgOiBEYXRlLm5vdygpICsgMTUgKiA2MCAqIDEwMDA7IC8vIOq4sOuzuCAxNeu2hFxuICAgICAgICBcbiAgICAgICAgY29uc3QgYmxhY2tsaXN0ID0gZ2V0VG9rZW5CbGFja2xpc3QoKTtcbiAgICAgICAgYXdhaXQgYmxhY2tsaXN0LmFkZChkZWNvZGVkLmp0aSwgZXhwaXJlc0F0KTtcbiAgICAgICAgY29uc29sZS5sb2coYFtBdXRoXSDwn5qrIO2GoO2BsCDruJTrnpnrpqzsiqTtirgg7LaU6rCAOiAke2RlY29kZWQuanRpLnN1YnN0cmluZygwLCA4KX0uLi5gKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignW0F1dGhdIO2GoO2BsCDruJTrnpnrpqzsiqTtirgg7LaU6rCAIOyLpO2MqDonLCBlcnJvcik7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG59XG5cbi8qKlxuICogQXV0aG9yaXphdGlvbiDtl6TrjZTsl5DshJwg7Yag7YGwIOy2lOy2nFxuICovXG5leHBvcnQgZnVuY3Rpb24gZXh0cmFjdFRva2VuKGF1dGhIZWFkZXI/OiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgICBpZiAoIWF1dGhIZWFkZXIpIHJldHVybiBudWxsO1xuXG4gICAgLy8gXCJCZWFyZXIgPHRva2VuPlwiIO2YleyLnVxuICAgIGlmIChhdXRoSGVhZGVyLnN0YXJ0c1dpdGgoJ0JlYXJlciAnKSkge1xuICAgICAgICByZXR1cm4gYXV0aEhlYWRlci5zbGljZSg3KTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXV0aEhlYWRlcjtcbn1cblxuLyoqXG4gKiDsl63tlaAg6raM7ZWcIOyytO2BrFxuICovXG5leHBvcnQgZnVuY3Rpb24gaGFzUGVybWlzc2lvbih1c2VyUm9sZTogVXNlclJvbGUsIHJlcXVpcmVkUm9sZTogVXNlclJvbGUpOiBib29sZWFuIHtcbiAgICBjb25zdCByb2xlSGllcmFyY2h5OiBSZWNvcmQ8VXNlclJvbGUsIG51bWJlcj4gPSB7XG4gICAgICAgICdhZG1pbic6IDMsXG4gICAgICAgICd1c2VyJzogMixcbiAgICAgICAgJ2d1ZXN0JzogMVxuICAgIH07XG5cbiAgICByZXR1cm4gcm9sZUhpZXJhcmNoeVt1c2VyUm9sZV0gPj0gcm9sZUhpZXJhcmNoeVtyZXF1aXJlZFJvbGVdO1xufVxuXG4vKipcbiAqIOq0gOumrOyekCDsl6zrtoAg7ZmV7J24XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc0FkbWluKHJvbGU6IFVzZXJSb2xlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHJvbGUgPT09ICdhZG1pbic7XG59XG5cbi8vIOuqqOuTiCDsnqwtZXhwb3J0XG5leHBvcnQgKiBmcm9tICcuL3R5cGVzJztcbmV4cG9ydCB7IG9wdGlvbmFsQXV0aCwgcmVxdWlyZUF1dGgsIHJlcXVpcmVBZG1pbiwgcmVxdWlyZVJvbGUgfSBmcm9tICcuL21pZGRsZXdhcmUnO1xuXG4vKipcbiAqIO2GoO2BsOydhCBodHRwT25seSDsv6DtgqTsl5Ag7ISk7KCVXG4gKiDwn5SSIFBoYXNlIDI6IOyVoeyEuOyKpCDthqDtgbAg7L+g7YKkICgxNeu2hCDrp4zro4wpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZXRUb2tlbkNvb2tpZShyZXM6IFJlc3BvbnNlLCB0b2tlbjogc3RyaW5nKTogdm9pZCB7XG4gICAgcmVzLmNvb2tpZSgnYXV0aF90b2tlbicsIHRva2VuLCB7XG4gICAgICAgIGh0dHBPbmx5OiB0cnVlLFxuICAgICAgICBzZWN1cmU6IGdldENvbmZpZygpLm5vZGVFbnYgPT09ICdwcm9kdWN0aW9uJyxcbiAgICAgICAgc2FtZVNpdGU6ICdsYXgnLFxuICAgICAgICBtYXhBZ2U6IDE1ICogNjAgKiAxMDAwLCAvLyAxNeu2hCAo7JWh7IS47IqkIO2GoO2BsCDsiJjrqoXqs7wg7J287LmYKVxuICAgICAgICBwYXRoOiAnLydcbiAgICB9KTtcbn1cblxuLyoqXG4gKiDwn5SSIFBoYXNlIDI6IOumrO2UhOugiOyLnCDthqDtgbDsnYQgaHR0cE9ubHkg7L+g7YKk7JeQIOyEpOyglSAoN+ydvCDrp4zro4wpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZXRSZWZyZXNoVG9rZW5Db29raWUocmVzOiBSZXNwb25zZSwgcmVmcmVzaFRva2VuOiBzdHJpbmcpOiB2b2lkIHtcbiAgICByZXMuY29va2llKCdyZWZyZXNoX3Rva2VuJywgcmVmcmVzaFRva2VuLCB7XG4gICAgICAgIGh0dHBPbmx5OiB0cnVlLFxuICAgICAgICBzZWN1cmU6IGdldENvbmZpZygpLm5vZGVFbnYgPT09ICdwcm9kdWN0aW9uJyxcbiAgICAgICAgc2FtZVNpdGU6ICdsYXgnLFxuICAgICAgICBtYXhBZ2U6IDcgKiAyNCAqIDYwICogNjAgKiAxMDAwLCAvLyA37J28XG4gICAgICAgIHBhdGg6ICcvYXBpL2F1dGgvcmVmcmVzaCcgLy8g66as7ZSE66CI7IucIOyXlOuTnO2PrOyduO2KuOyXkOyEnOunjCDsoITshqFcbiAgICB9KTtcbn1cblxuLyoqXG4gKiDthqDtgbAg7L+g7YKkIOyCreygnFxuICog8J+UkiBQaGFzZSAyOiDslaHshLjsiqQgKyDrpqztlITroIjsi5wg7L+g7YKkIOuqqOuRkCDsgq3soJxcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNsZWFyVG9rZW5Db29raWUocmVzOiBSZXNwb25zZSk6IHZvaWQge1xuICAgIHJlcy5jbGVhckNvb2tpZSgnYXV0aF90b2tlbicsIHsgcGF0aDogJy8nIH0pO1xuICAgIHJlcy5jbGVhckNvb2tpZSgncmVmcmVzaF90b2tlbicsIHsgcGF0aDogJy9hcGkvYXV0aC9yZWZyZXNoJyB9KTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==