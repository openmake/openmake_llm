{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/mcp/external-client.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/mcp/external-client.ts"],"sourcesContent":["/**\n * ExternalMCPClient — SDK Client 래퍼\n * 외부 MCP 서버(stdio/SSE/HTTP)에 연결하고 도구를 검색·실행합니다.\n */\n\nimport { Client } from '@modelcontextprotocol/sdk/client/index.js';\nimport { StdioClientTransport } from '@modelcontextprotocol/sdk/client/stdio.js';\nimport { StreamableHTTPClientTransport } from '@modelcontextprotocol/sdk/client/streamableHttp.js';\nimport { SSEClientTransport } from '@modelcontextprotocol/sdk/client/sse.js';\nimport type { MCPServerConfig, MCPConnectionStatus, MCPTool, MCPToolResult } from './types';\n\n/** SDK Tool → MCPTool 변환에 사용하는 SDK 측 도구 타입 */\ninterface SDKTool {\n    name: string;\n    description?: string;\n    inputSchema?: {\n        type: string;\n        properties?: Record<string, unknown>;\n        required?: string[];\n        [key: string]: unknown;\n    };\n}\n\n/** SDK callTool 결과 */\ninterface SDKCallToolResult {\n    content?: Array<{\n        type: string;\n        text?: string;\n        data?: string;\n        mimeType?: string;\n    }>;\n    isError?: boolean;\n}\n\ntype TransportInstance = StdioClientTransport | StreamableHTTPClientTransport | SSEClientTransport;\n\nexport class ExternalMCPClient {\n    private client: Client | null = null;\n    private transport: TransportInstance | null = null;\n    private config: MCPServerConfig;\n    private status: MCPConnectionStatus['status'] = 'disconnected';\n    private discoveredTools: MCPTool[] = [];\n    private lastError: string | undefined;\n    private lastPing: string | undefined;\n\n    constructor(config: MCPServerConfig) {\n        this.config = config;\n    }\n\n    /** 서버에 연결하고 도구 목록을 자동 검색 */\n    async connect(): Promise<void> {\n        if (this.status === 'connected') {\n            return;\n        }\n\n        this.status = 'connecting';\n        this.lastError = undefined;\n\n        try {\n            this.transport = this.createTransport();\n\n            this.client = new Client(\n                { name: 'openmake-llm', version: '1.0.0' },\n                { capabilities: {} }\n            );\n\n            await this.client.connect(this.transport);\n\n            // 도구 목록 검색\n            const toolsResult = await this.client.listTools();\n            this.discoveredTools = (toolsResult.tools || []).map((t: SDKTool) => this.sdkToolToMCPTool(t));\n\n            this.status = 'connected';\n            this.lastPing = new Date().toISOString();\n            console.log(`[ExternalMCP] Connected to \"${this.config.name}\" — ${this.discoveredTools.length} tools discovered`);\n        } catch (error) {\n            this.status = 'error';\n            this.lastError = error instanceof Error ? error.message : String(error);\n            this.discoveredTools = [];\n            console.error(`[ExternalMCP] Failed to connect to \"${this.config.name}\":`, this.lastError);\n            throw error;\n        }\n    }\n\n    /** 연결 해제 및 프로세스 정리 */\n    async disconnect(): Promise<void> {\n        if (this.client) {\n            try {\n                await this.client.close();\n            } catch (error) {\n                console.warn(`[ExternalMCP] Error closing client \"${this.config.name}\":`, error);\n            }\n            this.client = null;\n        }\n        this.transport = null;\n        this.status = 'disconnected';\n        this.discoveredTools = [];\n        console.log(`[ExternalMCP] Disconnected from \"${this.config.name}\"`);\n    }\n\n    /** 검색된 도구 목록 반환 */\n    getTools(): MCPTool[] {\n        return [...this.discoveredTools];\n    }\n\n    /** 도구 실행 (원본 이름 사용 — 네임스페이싱은 ToolRouter가 처리) */\n    async callTool(name: string, args: Record<string, unknown>): Promise<MCPToolResult> {\n        if (!this.client || this.status !== 'connected') {\n            return {\n                content: [{ type: 'text', text: `서버 \"${this.config.name}\"에 연결되어 있지 않습니다.` }],\n                isError: true,\n            };\n        }\n\n        try {\n            const result = await this.client.callTool({ name, arguments: args }) as SDKCallToolResult;\n            return this.sdkResultToMCPToolResult(result);\n        } catch (error) {\n            const message = error instanceof Error ? error.message : String(error);\n            return {\n                content: [{ type: 'text', text: `도구 실행 오류 (${this.config.name}::${name}): ${message}` }],\n                isError: true,\n            };\n        }\n    }\n\n    /** 연결 상태 확인 (ping) */\n    async ping(): Promise<boolean> {\n        if (!this.client || this.status !== 'connected') {\n            return false;\n        }\n\n        try {\n            await this.client.ping();\n            this.lastPing = new Date().toISOString();\n            return true;\n        } catch {\n            this.status = 'error';\n            this.lastError = 'Ping failed';\n            return false;\n        }\n    }\n\n    /** 현재 연결 상태 */\n    getStatus(): MCPConnectionStatus {\n        return {\n            serverId: this.config.id,\n            serverName: this.config.name,\n            status: this.status,\n            toolCount: this.discoveredTools.length,\n            lastPing: this.lastPing,\n            error: this.lastError,\n        };\n    }\n\n    /** 서버 설정 반환 */\n    getConfig(): MCPServerConfig {\n        return { ...this.config };\n    }\n\n    /** transport 생성 헬퍼 */\n    private createTransport(): TransportInstance {\n        switch (this.config.transport_type) {\n            case 'stdio': {\n                if (!this.config.command) {\n                    throw new Error(`stdio transport requires \"command\" for server \"${this.config.name}\"`);\n                }\n                return new StdioClientTransport({\n                    command: this.config.command,\n                    args: this.config.args || [],\n                    env: this.config.env\n                        ? { ...process.env, ...this.config.env } as Record<string, string>\n                        : undefined,\n                    stderr: 'pipe',\n                });\n            }\n            case 'sse': {\n                if (!this.config.url) {\n                    throw new Error(`SSE transport requires \"url\" for server \"${this.config.name}\"`);\n                }\n                return new SSEClientTransport(new URL(this.config.url));\n            }\n            case 'streamable-http': {\n                if (!this.config.url) {\n                    throw new Error(`streamable-http transport requires \"url\" for server \"${this.config.name}\"`);\n                }\n                return new StreamableHTTPClientTransport(new URL(this.config.url));\n            }\n            default:\n                throw new Error(`Unknown transport type: ${this.config.transport_type}`);\n        }\n    }\n\n    /** SDK Tool → MCPTool 변환 */\n    private sdkToolToMCPTool(sdkTool: SDKTool): MCPTool {\n        return {\n            name: sdkTool.name,\n            description: sdkTool.description || '',\n            inputSchema: {\n                type: 'object',\n                properties: (sdkTool.inputSchema?.properties as Record<string, unknown>) || {},\n                required: sdkTool.inputSchema?.required || [],\n            },\n        };\n    }\n\n    /** SDK CallToolResult → MCPToolResult 변환 */\n    private sdkResultToMCPToolResult(result: SDKCallToolResult): MCPToolResult {\n        const content = (result.content || []).map((item) => {\n            const entry: { type: 'text' | 'image' | 'resource'; text?: string; data?: string; mimeType?: string } = {\n                type: item.type === 'image' ? 'image' : item.type === 'resource' ? 'resource' : 'text',\n            };\n            if (item.text !== undefined) entry.text = item.text;\n            if (item.data !== undefined) entry.data = item.data;\n            if (item.mimeType !== undefined) entry.mimeType = item.mimeType;\n            return entry;\n        });\n\n        // 빈 결과 방지\n        if (content.length === 0) {\n            content.push({ type: 'text', text: '(empty result)' });\n        }\n\n        return {\n            content,\n            isError: result.isError || false,\n        };\n    }\n}\n"],"version":3}