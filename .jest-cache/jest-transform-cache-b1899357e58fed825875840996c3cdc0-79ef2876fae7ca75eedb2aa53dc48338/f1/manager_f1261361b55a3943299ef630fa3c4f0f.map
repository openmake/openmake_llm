{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/cluster/manager.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/cluster/manager.ts"],"sourcesContent":["/**\n * @fileoverview Ollama í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ ëª¨ë“ˆ\n * \n * ë¶„ì‚° Ollama ë…¸ë“œë“¤ì„ ê´€ë¦¬í•˜ëŠ” í´ëŸ¬ìŠ¤í„° ë§¤ë‹ˆì €ì…ë‹ˆë‹¤.\n * ë…¸ë“œ ë“±ë¡/ì œê±°, í—¬ìŠ¤ì²´í¬, ë ˆì´í„´ì‹œ ê¸°ë°˜ ìµœì  ë…¸ë“œ ì„ íƒ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.\n * \n * @module cluster/manager\n * \n * @example\n * ```typescript\n * import { getClusterManager } from './manager';\n * \n * const cluster = getClusterManager();\n * await cluster.start();\n * \n * // íŠ¹ì • ëª¨ë¸ì„ ê°€ì§„ ìµœì ì˜ ë…¸ë“œ ì„ íƒ\n * const bestNode = cluster.getBestNode('llama3');\n * if (bestNode) {\n *   const client = cluster.getClient(bestNode.id);\n *   // clientë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì²­ ì²˜ë¦¬\n * }\n * ```\n */\n\nimport { EventEmitter } from 'events';\nimport { v4 as uuidv4 } from 'uuid';\nimport {\n    ClusterNode,\n    ClusterConfig,\n    ClusterStats,\n    ClusterEvent,\n    NodeResources\n} from './types';\nimport { loadClusterConfig } from './config';\nimport { createClient, OllamaClient } from '../ollama/client';\n\n/**\n * Ollama í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ì\n * \n * ì—¬ëŸ¬ Ollama ë…¸ë“œë¥¼ ê´€ë¦¬í•˜ê³  ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.\n * EventEmitterë¥¼ ìƒì†í•˜ì—¬ ë…¸ë“œ ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.\n * \n * @class ClusterManager\n * @extends EventEmitter\n * \n * @fires ClusterManager#event:node:online - ë…¸ë“œê°€ ì˜¨ë¼ì¸ ìƒíƒœê°€ ë¨\n * @fires ClusterManager#event:node:offline - ë…¸ë“œê°€ ì˜¤í”„ë¼ì¸ ìƒíƒœê°€ ë¨\n * @fires ClusterManager#event:node:updated - ë…¸ë“œ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë¨\n * \n * @example\n * ```typescript\n * const cluster = new ClusterManager({ heartbeatInterval: 30000 });\n * cluster.on('event', (event) => {\n *   if (event.type === 'node:offline') {\n *     console.warn(`ë…¸ë“œ ì˜¤í”„ë¼ì¸: ${event.nodeId}`);\n *   }\n * });\n * await cluster.start();\n * ```\n */\nexport class ClusterManager extends EventEmitter {\n    /** ë“±ë¡ëœ ë…¸ë“œ ë§µ (ë…¸ë“œID -> ë…¸ë“œ ì •ë³´) */\n    private nodes: Map<string, ClusterNode> = new Map();\n    \n    /** ë…¸ë“œë³„ Ollama í´ë¼ì´ì–¸íŠ¸ ë§µ */\n    private clients: Map<string, OllamaClient> = new Map();\n    \n    /** í´ëŸ¬ìŠ¤í„° ì„¤ì • */\n    private config: ClusterConfig;\n    \n    /** í—¬ìŠ¤ì²´í¬ ì¸í„°ë²Œ íƒ€ì´ë¨¸ */\n    private healthCheckInterval?: NodeJS.Timeout;\n    \n    /** ì´ ë§¤ë‹ˆì € ì¸ìŠ¤í„´ìŠ¤ì˜ ê³ ìœ  ID */\n    private nodeId: string;\n\n    /**\n     * ClusterManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„±\n     * \n     * @param config - í´ëŸ¬ìŠ¤í„° ì„¤ì • (ì„ íƒì , ê¸°ë³¸ ì„¤ì •ê³¼ ë³‘í•©ë¨)\n     */\n    constructor(config?: Partial<ClusterConfig>) {\n        super();\n        this.config = { ...loadClusterConfig(), ...config };\n        this.nodeId = uuidv4();\n    }\n\n    /**\n     * í´ëŸ¬ìŠ¤í„° ë§¤ë‹ˆì € ì¸ìŠ¤í„´ìŠ¤ ID\n     * @returns ê³ ìœ  UUID ë¬¸ìì—´\n     */\n    get id(): string {\n        return this.nodeId;\n    }\n\n    /**\n     * í´ëŸ¬ìŠ¤í„° ì´ë¦„\n     * @returns ì„¤ì •ëœ í´ëŸ¬ìŠ¤í„° ì´ë¦„\n     */\n    get clusterName(): string {\n        return this.config.name;\n    }\n\r\n    /**\n     * í´ëŸ¬ìŠ¤í„° ì‹œì‘\n     * \n     * ì„¤ì •ì— ì •ì˜ëœ ì •ì  ë…¸ë“œë“¤ì„ ë“±ë¡í•˜ê³  ì£¼ê¸°ì  í—¬ìŠ¤ì²´í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\n     * \n     * @returns Promise<void>\n     * \n     * @example\n     * ```typescript\n     * const cluster = getClusterManager();\n     * await cluster.start();\n     * console.log('í´ëŸ¬ìŠ¤í„° ì‹œì‘ë¨:', cluster.getStats());\n     * ```\n     */\n    async start(): Promise<void> {\n        // ì •ì  ë…¸ë“œë“¤ ë“±ë¡\r\n        for (const staticNode of this.config.nodes) {\r\n            await this.addNode(staticNode.host, staticNode.port, staticNode.name);\r\n        }\r\n\r\n        // ì£¼ê¸°ì  í—¬ìŠ¤ì²´í¬ ì‹œì‘\r\n        this.startHealthCheck();\r\n    }\r\n\r\n    /**\n     * í´ëŸ¬ìŠ¤í„° ì¤‘ì§€\n     * \n     * í—¬ìŠ¤ì²´í¬ë¥¼ ì¤‘ë‹¨í•˜ê³  ëª¨ë“  ë…¸ë“œ ë° í´ë¼ì´ì–¸íŠ¸ ì •ë³´ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.\n     */\n    stop(): void {\n        if (this.healthCheckInterval) {\r\n            clearInterval(this.healthCheckInterval);\r\n            this.healthCheckInterval = undefined;\r\n        }\r\n        this.nodes.clear();\r\n        this.clients.clear();\r\n    }\r\n\r\n    /**\n     * ë…¸ë“œ ì¶”ê°€\n     * \n     * ìƒˆë¡œìš´ Ollama ë…¸ë“œë¥¼ í´ëŸ¬ìŠ¤í„°ì— ì¶”ê°€í•©ë‹ˆë‹¤.\n     * ì—°ê²° í…ŒìŠ¤íŠ¸ í›„ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.\n     * \n     * @param host - ë…¸ë“œ í˜¸ìŠ¤íŠ¸ ì£¼ì†Œ\n     * @param port - ë…¸ë“œ í¬íŠ¸ ë²ˆí˜¸\n     * @param name - ë…¸ë“œ ë³„ì¹­ (ì„ íƒ, ê¸°ë³¸ê°’: \"host:port\")\n     * @returns ì¶”ê°€ëœ ë…¸ë“œ ì •ë³´ ë˜ëŠ” null (ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš°)\n     * \n     * @example\n     * ```typescript\n     * const node = await cluster.addNode('192.168.1.100', 11434, 'gpu-server');\n     * if (node) {\n     *   console.log(`ë…¸ë“œ ì¶”ê°€ë¨: ${node.name} (${node.status})`);\n     * }\n     * ```\n     */\n    async addNode(host: string, port: number, name?: string): Promise<ClusterNode | null> {\n        const nodeId = `${host}:${port}`;\r\n\r\n        if (this.nodes.has(nodeId)) {\r\n            return this.nodes.get(nodeId)!;\r\n        }\r\n\r\n        const client = createClient({\r\n            baseUrl: `http://${host}:${port}`\r\n        });\r\n\r\n        // ì—°ê²° í…ŒìŠ¤íŠ¸\r\n        const isAvailable = await client.isAvailable();\r\n\r\n        const node: ClusterNode = {\r\n            id: nodeId,\r\n            name: name || nodeId,\r\n            host,\r\n            port,\r\n            status: isAvailable ? 'online' : 'offline',\r\n            models: [],\r\n            resources: {},\r\n            lastSeen: new Date()\r\n        };\r\n\r\n        if (isAvailable) {\r\n            // ëª¨ë¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°\r\n            try {\r\n                const response = await client.listModels();\r\n                node.models = response.models.map(m => m.name);\r\n            } catch (e: unknown) {\r\n                // ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ - ë¡œê¹…\r\n                console.debug(`[Cluster] ${nodeId} ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:`, (e instanceof Error ? e.message : String(e)) || e);\r\n            }\r\n\r\n            // ë ˆì´í„´ì‹œ ì¸¡ì •\r\n            node.latency = await this.measureLatency(client);\r\n        }\r\n\r\n        this.nodes.set(nodeId, node);\r\n        this.clients.set(nodeId, client);\r\n\r\n        this.emit('event', { type: 'node:online', node } as ClusterEvent);\r\n\r\n        return node;\r\n    }\r\n\r\n    /**\n     * ë…¸ë“œ ì œê±°\n     * \n     * í´ëŸ¬ìŠ¤í„°ì—ì„œ ë…¸ë“œë¥¼ ì œê±°í•©ë‹ˆë‹¤.\n     * \n     * @param nodeId - ì œê±°í•  ë…¸ë“œ ID (\"host:port\" í˜•ì‹)\n     * @returns ì œê±° ì„±ê³µ ì—¬ë¶€\n     */\n    removeNode(nodeId: string): boolean {\n        const existed = this.nodes.delete(nodeId);\r\n        this.clients.delete(nodeId);\r\n\r\n        if (existed) {\r\n            this.emit('event', { type: 'node:offline', nodeId } as ClusterEvent);\r\n        }\r\n\r\n        return existed;\r\n    }\r\n\r\n    /**\n     * ëª¨ë“  ë…¸ë“œ ì¡°íšŒ\n     * \n     * @returns ë“±ë¡ëœ ëª¨ë“  ë…¸ë“œ ë°°ì—´ (ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ëª¨ë‘ í¬í•¨)\n     */\n    getNodes(): ClusterNode[] {\n        return Array.from(this.nodes.values());\n    }\n\n    /**\n     * ì˜¨ë¼ì¸ ë…¸ë“œë§Œ ì¡°íšŒ\n     * \n     * @returns í˜„ì¬ ì˜¨ë¼ì¸ ìƒíƒœì¸ ë…¸ë“œë“¤ë§Œ ë°˜í™˜\n     */\n    getOnlineNodes(): ClusterNode[] {\n        return this.getNodes().filter(n => n.status === 'online');\n    }\n\n    /**\n     * íŠ¹ì • ëª¨ë¸ì„ ê°€ì§„ ë…¸ë“œ ì¡°íšŒ\n     * \n     * ì§€ì •ëœ ëª¨ë¸ì´ ì„¤ì¹˜ëœ ì˜¨ë¼ì¸ ë…¸ë“œë“¤ì„ ë°˜í™˜í•©ë‹ˆë‹¤.\n     * ëª¨ë¸ëª…ì€ ë¶€ë¶„ ì¼ì¹˜ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤.\n     * \n     * @param modelName - ê²€ìƒ‰í•  ëª¨ë¸ ì´ë¦„ (ë¶€ë¶„ ì¼ì¹˜)\n     * @returns í•´ë‹¹ ëª¨ë¸ì„ ê°€ì§„ ì˜¨ë¼ì¸ ë…¸ë“œ ë°°ì—´\n     * \n     * @example\n     * ```typescript\n     * const llamaNodes = cluster.getNodesWithModel('llama');\n     * // llama3, llama2, codellama ë“± 'llama'ê°€ í¬í•¨ëœ ëª¨ë¸ì„ ê°€ì§„ ë…¸ë“œë“¤ ë°˜í™˜\n     * ```\n     */\n    getNodesWithModel(modelName: string): ClusterNode[] {\n        return this.getOnlineNodes().filter(n =>\n            n.models.some(m => m.includes(modelName))\n        );\n    }\n\n    /**\n     * ë…¸ë“œì˜ Ollama í´ë¼ì´ì–¸íŠ¸ ê°€ì ¸ì˜¤ê¸° (ì‹±ê¸€í†¤ â€” ê³µìœ )\n     * \n     * âš ï¸ ì£¼ì˜: ì´ í´ë¼ì´ì–¸íŠ¸ëŠ” ì‹±ê¸€í†¤ì´ë¯€ë¡œ setModel()ì„ í˜¸ì¶œí•˜ë©´ \n     * ë™ì‹œ ìš”ì²­ ê°„ ëª¨ë¸ì´ ë®ì–´ì“°ì—¬ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n     * ë™ì‹œì„±ì´ í•„ìš”í•œ ê²½ìš° createScopedClient()ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.\n     * \n     * @param nodeId - ë…¸ë“œ ID\n     * @returns í•´ë‹¹ ë…¸ë“œì˜ OllamaClient ë˜ëŠ” undefined\n     */\n    getClient(nodeId: string): OllamaClient | undefined {\n        return this.clients.get(nodeId);\n    }\n\n    /**\n     * ğŸ”’ Phase 2 ë³´ì•ˆ íŒ¨ì¹˜: ìš”ì²­ ê²©ë¦¬ëœ í´ë¼ì´ì–¸íŠ¸ ìƒì„±\n     * \n     * ì‹±ê¸€í†¤ í´ë¼ì´ì–¸íŠ¸ì˜ ì„¤ì •ì„ ë³µì œí•˜ì—¬ ë…ë¦½ì ì¸ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.\n     * ë™ì‹œ ìš”ì²­ ì‹œ setModel() ê²½ìŸ ì¡°ê±´ì„ ë°©ì§€í•©ë‹ˆë‹¤.\n     * \n     * @param nodeId - ë…¸ë“œ ID\n     * @param model - ì´ ìš”ì²­ì—ì„œ ì‚¬ìš©í•  ëª¨ë¸ëª… (ì„ íƒ)\n     * @returns ê²©ë¦¬ëœ ìƒˆ OllamaClient ì¸ìŠ¤í„´ìŠ¤ ë˜ëŠ” undefined\n     * \n     * @example\n     * ```typescript\n     * const client = cluster.createScopedClient(bestNode.id, 'gemma:2b');\n     * // client.setModel()ì€ ë‹¤ë¥¸ ìš”ì²­ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ\n     * ```\n     */\n    createScopedClient(nodeId: string, model?: string): OllamaClient | undefined {\n        const baseClient = this.clients.get(nodeId);\n        const node = this.nodes.get(nodeId);\n        if (!baseClient || !node) return undefined;\n\n        // ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (TCP ì»¤ë„¥ì…˜ í’€ì€ OS ë ˆë²¨ì—ì„œ ì¬ì‚¬ìš©)\n        const scopedClient = createClient({\n            baseUrl: `http://${node.host}:${node.port}`,\n            model: model || baseClient.model,\n        });\n\n        return scopedClient;\n    }\n\n    /**\n     * ìµœì ì˜ ë…¸ë“œ ì„ íƒ (ë ˆì´í„´ì‹œ ê¸°ë°˜)\n     * \n     * ì˜¨ë¼ì¸ ë…¸ë“œ ì¤‘ ë ˆì´í„´ì‹œê°€ ê°€ì¥ ë‚®ì€ ë…¸ë“œë¥¼ ì„ íƒí•©ë‹ˆë‹¤.\n     * ëª¨ë¸ëª…ì´ ì§€ì •ë˜ë©´ í•´ë‹¹ ëª¨ë¸ì„ ê°€ì§„ ë…¸ë“œë“¤ ì¤‘ì—ì„œ ì„ íƒí•©ë‹ˆë‹¤.\n     * \n     * @param modelName - í•„ìš”í•œ ëª¨ë¸ ì´ë¦„ (ì„ íƒ, \"default\"ëŠ” ë¬´ì‹œë¨)\n     * @returns ìµœì ì˜ ë…¸ë“œ ë˜ëŠ” undefined (í›„ë³´ ì—†ìŒ)\n     * \n     * @example\n     * ```typescript\n     * const node = cluster.getBestNode('gemma:2b');\n     * if (node) {\n     *   console.log(`ìµœì  ë…¸ë“œ: ${node.name}, ë ˆì´í„´ì‹œ: ${node.latency}ms`);\n     * }\n     * ```\n     */\n    getBestNode(modelName?: string): ClusterNode | undefined {\n        let candidates = this.getOnlineNodes();\r\n        console.log(`[Cluster] getBestNode í˜¸ì¶œ - model: ${modelName}, online nodes: ${candidates.length}`);\r\n        candidates.forEach(n => console.log(`[Cluster]   - ${n.id}: ${n.status}, models: ${n.models.join(', ')}`));\r\n\r\n        // \"default\"ëŠ” íŠ¹ë³„í•œ ê°’ì´ë¯€ë¡œ ëª¨ë¸ í•„í„°ë§ì„ ê±´ë„ˆëœ€\r\n        if (modelName && modelName !== 'default') {\r\n            candidates = candidates.filter(n =>\r\n                n.models.some(m => m.includes(modelName))\r\n            );\r\n            console.log(`[Cluster] ëª¨ë¸ í•„í„°ë§ í›„ candidates: ${candidates.length}`);\r\n        }\r\n\r\n        if (candidates.length === 0) return undefined;\r\n\r\n        // ë ˆì´í„´ì‹œê°€ ê°€ì¥ ë‚®ì€ ë…¸ë“œ ì„ íƒ\r\n        return candidates.reduce((best, node) => {\r\n            if (!best) return node;\r\n            if ((node.latency || Infinity) < (best.latency || Infinity)) {\r\n                return node;\r\n            }\r\n            return best;\r\n        });\r\n    }\r\n\r\n    /**\n     * í´ëŸ¬ìŠ¤í„° í†µê³„ ì¡°íšŒ\n     * \n     * í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì˜ ì „ì²´ ìƒíƒœ ìš”ì•½ì„ ë°˜í™˜í•©ë‹ˆë‹¤.\n     * \n     * @returns í´ëŸ¬ìŠ¤í„° í†µê³„ ê°ì²´\n     * \n     * @example\n     * ```typescript\n     * const stats = cluster.getStats();\n     * console.log(`ì „ì²´ ë…¸ë“œ: ${stats.totalNodes}, ì˜¨ë¼ì¸: ${stats.onlineNodes}`);\n     * console.log(`ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸: ${stats.uniqueModels.join(', ')}`);\n     * ```\n     */\n    getStats(): ClusterStats {\n        const nodes = this.getNodes();\r\n        const onlineNodes = nodes.filter(n => n.status === 'online');\r\n        const allModels = onlineNodes.flatMap(n => n.models);\r\n        const uniqueModels = [...new Set(allModels)];\r\n\r\n        return {\r\n            totalNodes: nodes.length,\r\n            onlineNodes: onlineNodes.length,\r\n            totalModels: allModels.length,\r\n            uniqueModels\r\n        };\r\n    }\r\n\r\n    /**\n     * ë ˆì´í„´ì‹œ ì¸¡ì •\n     * \n     * ë…¸ë“œê¹Œì§€ì˜ ì™•ë³µ ì‹œê°„ì„ ì¸¡ì •í•©ë‹ˆë‹¤.\n     * \n     * @param client - ì¸¡ì • ëŒ€ìƒ Ollama í´ë¼ì´ì–¸íŠ¸\n     * @returns ë ˆì´í„´ì‹œ(ms) ë˜ëŠ” Infinity (ì—°ê²° ì‹¤íŒ¨ ì‹œ)\n     */\n    private async measureLatency(client: OllamaClient): Promise<number> {\n        const start = Date.now();\r\n        try {\r\n            await client.isAvailable();\r\n            return Date.now() - start;\r\n        } catch {\r\n            return Infinity;\r\n        }\r\n    }\r\n\r\n    /**\n     * ë…¸ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸\n     * \n     * ë…¸ë“œì˜ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ, ëª¨ë¸ ëª©ë¡, ë ˆì´í„´ì‹œë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.\n     * ìƒíƒœ ë³€ê²½ ì‹œ ì ì ˆí•œ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.\n     * \n     * @param nodeId - ì—…ë°ì´íŠ¸í•  ë…¸ë“œ ID\n     * @fires ClusterManager#event:node:online\n     * @fires ClusterManager#event:node:offline\n     * @fires ClusterManager#event:node:updated\n     */\n    private async updateNodeStatus(nodeId: string): Promise<void> {\n        const node = this.nodes.get(nodeId);\r\n        const client = this.clients.get(nodeId);\r\n\r\n        if (!node || !client) return;\r\n\r\n        const wasOnline = node.status === 'online';\r\n        const isAvailable = await client.isAvailable();\r\n\r\n        node.status = isAvailable ? 'online' : 'offline';\r\n        node.lastSeen = isAvailable ? new Date() : node.lastSeen;\r\n\r\n        if (isAvailable) {\r\n            // ëª¨ë¸ ëª©ë¡ ê°±ì‹ \r\n            try {\r\n                const response = await client.listModels();\r\n                node.models = response.models.map(m => m.name);\r\n            } catch (e: unknown) {\r\n                // ëª¨ë¸ ëª©ë¡ ê°±ì‹  ì‹¤íŒ¨ - ë¡œê¹…\r\n                console.debug(`[Cluster] ${nodeId} ëª¨ë¸ ê°±ì‹  ì‹¤íŒ¨:`, (e instanceof Error ? e.message : String(e)) || e);\r\n            }\r\n            node.latency = await this.measureLatency(client);\r\n        }\r\n\r\n        // ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸\r\n        if (wasOnline !== isAvailable) {\r\n            if (isAvailable) {\r\n                this.emit('event', { type: 'node:online', node } as ClusterEvent);\r\n            } else {\r\n                this.emit('event', { type: 'node:offline', nodeId } as ClusterEvent);\r\n            }\r\n        } else {\r\n            this.emit('event', { type: 'node:updated', node } as ClusterEvent);\r\n        }\r\n    }\r\n\r\n    /**\n     * í—¬ìŠ¤ì²´í¬ ì‹œì‘\n     * \n     * ì„¤ì •ëœ ê°„ê²©ìœ¼ë¡œ ëª¨ë“  ë…¸ë“œì˜ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¸í„°ë²Œì„ ì‹œì‘í•©ë‹ˆë‹¤.\n     */\n    private startHealthCheck(): void {\n        this.healthCheckInterval = setInterval(async () => {\r\n            const nodeIds = Array.from(this.nodes.keys());\r\n            await Promise.all(nodeIds.map(id => this.updateNodeStatus(id)));\r\n        }, this.config.heartbeatInterval);\r\n    }\r\n}\r\n\r\n/** ì‹±ê¸€í†¤ ClusterManager ì¸ìŠ¤í„´ìŠ¤ */\nlet clusterInstance: ClusterManager | null = null;\n\n/**\n * ClusterManager ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ íšë“\n * \n * ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì—­ì—ì„œ ë™ì¼í•œ í´ëŸ¬ìŠ¤í„° ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n * \n * @returns ClusterManager ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤\n * \n * @example\n * ```typescript\n * const cluster = getClusterManager();\n * await cluster.start();\n * ```\n */\nexport function getClusterManager(): ClusterManager {\n    if (!clusterInstance) {\n        clusterInstance = new ClusterManager();\n    }\n    return clusterInstance;\n}\n\n/**\n * ìƒˆë¡œìš´ ClusterManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„±\n * \n * ì‹±ê¸€í†¤ì´ ì•„ë‹Œ ë…ë¦½ì ì¸ í´ëŸ¬ìŠ¤í„° ë§¤ë‹ˆì €ê°€ í•„ìš”í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.\n * \n * @param config - í´ëŸ¬ìŠ¤í„° ì„¤ì • (ì„ íƒ)\n * @returns ìƒˆë¡œìš´ ClusterManager ì¸ìŠ¤í„´ìŠ¤\n */\nexport function createClusterManager(config?: Partial<ClusterConfig>): ClusterManager {\n    return new ClusterManager(config);\n}\n"],"version":3}