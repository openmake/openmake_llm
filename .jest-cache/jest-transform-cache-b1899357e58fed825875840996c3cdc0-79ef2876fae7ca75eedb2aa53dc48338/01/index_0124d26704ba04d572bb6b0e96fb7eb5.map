{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/auth/index.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/auth/index.ts"],"sourcesContent":["/**\n * ì¸ì¦ ëª¨ë“ˆ\n * JWT í† í° ìƒì„±/ê²€ì¦ ë° ì¸ì¦ ìœ í‹¸ë¦¬í‹°\n * \n * #8 ì—°ë™: í† í° ë¸”ë™ë¦¬ìŠ¤íŠ¸ (SQLite-backed) í†µí•©\n */\n\nimport * as jwt from 'jsonwebtoken';\nimport { JWTPayload } from './types';\nimport { PublicUser, UserRole } from '../data/user-manager';\nimport * as crypto from 'crypto';\nimport { getTokenBlacklist } from '../data/models/token-blacklist';\n\n// JWT ë¹„ë°€í‚¤ (í™˜ê²½ë³€ìˆ˜ í•„ìˆ˜, ê°œë°œí™˜ê²½ì—ì„œëŠ” ì„¸ì…˜ë³„ ëœë¤ ì‹œí¬ë¦¿ ìƒì„±)\nconst generateDevSecret = () => {\n    return `dev-session-${crypto.randomBytes(32).toString('hex')}`;\n};\n\nconst JWT_SECRET = process.env.JWT_SECRET || generateDevSecret();\nconst JWT_EXPIRES_IN = '15m';  // Access token - short lived for security\nconst REFRESH_TOKEN_EXPIRES_IN = '7d';  // Refresh token - longer lived\n\n// JWT_SECRET ë¯¸ì„¤ì • ê²½ê³ \nif (!process.env.JWT_SECRET) {\n    console.warn('[Auth] âš ï¸ JWT_SECRET í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');\n    console.warn('[Auth] ê°œë°œ í™˜ê²½ìš© ì„¸ì…˜ ì‹œí¬ë¦¿ì´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì„œë²„ ì¬ì‹œì‘ ì‹œ ê¸°ì¡´ í† í°ì´ ë¬´íš¨í™”ë©ë‹ˆë‹¤.');\n    console.warn('[Auth] ë³´ì•ˆì„ ìœ„í•´ .env íŒŒì¼ì— JWT_SECRETì„ ë°˜ë“œì‹œ ì„¤ì •í•˜ì„¸ìš”.');\n    if (process.env.NODE_ENV === 'production') {\n        throw new Error('[Auth] í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” JWT_SECRET í™˜ê²½ë³€ìˆ˜ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤!');\n    }\n}\n\n\n/**\n * JWT í† í° ìƒì„±\n * #8 ì—°ë™: jti (JWT ID) ì¶”ê°€ë¡œ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì§€ì›\n */\nexport function generateToken(user: PublicUser): string {\n    const payload: JWTPayload = {\n        userId: user.id,\n        email: user.email,\n        role: user.role\n    };\n\n    // jti(JWT ID)ë¥¼ ì¶”ê°€í•˜ì—¬ í† í° ë‹¨ìœ„ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì§€ì›\n    const jti = crypto.randomBytes(16).toString('hex');\n\n    return jwt.sign(payload, JWT_SECRET, { \n        expiresIn: JWT_EXPIRES_IN,\n        jwtid: jti\n    });\n}\n\n/**\n * JWT í† í° ê²€ì¦\n * #8 ì—°ë™: ë¸”ë™ë¦¬ìŠ¤íŠ¸ í™•ì¸ ì¶”ê°€\n */\nexport function verifyToken(token: string): JWTPayload | null {\n    try {\n        // ë¸”ë™ë¦¬ìŠ¤íŠ¸ í™•ì¸ (jti ê¸°ë°˜)\n        const preCheck = jwt.decode(token) as Record<string, unknown> | null;\n        if (preCheck?.jti && typeof preCheck.jti === 'string') {\n            try {\n                const blacklist = getTokenBlacklist();\n                if (blacklist.has(preCheck.jti)) {\n                    console.warn('[Auth] ë¸”ë™ë¦¬ìŠ¤íŠ¸ëœ í† í° ì‚¬ìš© ì‹œë„');\n                    return null;\n                }\n            } catch {\n                // ë¸”ë™ë¦¬ìŠ¤íŠ¸ DB ì ‘ê·¼ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ (ê°€ìš©ì„± ìš°ì„ )\n            }\n        }\n\n        const decoded = jwt.verify(token, JWT_SECRET) as unknown as JWTPayload;\n        return decoded;\n    } catch (error) {\n        console.error('[Auth] í† í° ê²€ì¦ ì‹¤íŒ¨:', error);\n        return null;\n    }\n}\n\n/**\n * í† í°ì„ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ (ë¡œê·¸ì•„ì›ƒ ì‹œ í˜¸ì¶œ)\n * #8 ì—°ë™: SQLite ê¸°ë°˜ ì˜ì† ë¸”ë™ë¦¬ìŠ¤íŠ¸\n */\nexport function blacklistToken(token: string): boolean {\n    try {\n        const decoded = jwt.decode(token) as Record<string, unknown> | null;\n        if (!decoded?.jti || typeof decoded.jti !== 'string') {\n            // jti ì—†ëŠ” ë ˆê±°ì‹œ í† í° â€” ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë¶ˆê°€\n            return false;\n        }\n        const expiresAt = typeof decoded.exp === 'number' \n            ? decoded.exp * 1000 \n            : Date.now() + 15 * 60 * 1000; // ê¸°ë³¸ 15ë¶„\n        \n        const blacklist = getTokenBlacklist();\n        blacklist.add(decoded.jti, expiresAt);\n        console.log(`[Auth] ğŸš« í† í° ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¶”ê°€: ${decoded.jti.substring(0, 8)}...`);\n        return true;\n    } catch (error) {\n        console.error('[Auth] í† í° ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ ì‹¤íŒ¨:', error);\n        return false;\n    }\n}\n\n/**\n * Authorization í—¤ë”ì—ì„œ í† í° ì¶”ì¶œ\n */\nexport function extractToken(authHeader?: string): string | null {\n    if (!authHeader) return null;\n\n    // \"Bearer <token>\" í˜•ì‹\n    if (authHeader.startsWith('Bearer ')) {\n        return authHeader.slice(7);\n    }\n\n    return authHeader;\n}\n\n/**\n * ì—­í•  ê¶Œí•œ ì²´í¬\n */\nexport function hasPermission(userRole: UserRole, requiredRole: UserRole): boolean {\n    const roleHierarchy: Record<UserRole, number> = {\n        'admin': 3,\n        'user': 2,\n        'guest': 1\n    };\n\n    return roleHierarchy[userRole] >= roleHierarchy[requiredRole];\n}\n\n/**\n * ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸\n */\nexport function isAdmin(role: UserRole): boolean {\n    return role === 'admin';\n}\n\n// ëª¨ë“ˆ ì¬-export\nexport * from './types';\nexport { optionalAuth, requireAuth, requireAdmin, requireRole } from './middleware';\n"],"version":3}