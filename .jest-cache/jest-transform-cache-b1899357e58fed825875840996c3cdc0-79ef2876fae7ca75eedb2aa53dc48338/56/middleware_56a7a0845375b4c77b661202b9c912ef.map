{"file":"/Volumes/MAC_APP/openmake_llm/infrastructure/security/auth/middleware.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/infrastructure/security/auth/middleware.ts"],"sourcesContent":["/**\n * 인증 미들웨어\n * Express 요청에 대한 인증 처리\n * \n * #5 개선: 역방향 참조 제거 - getUserById를 DI(의존성 주입)로 전환\n */\n\nimport { Request, Response, NextFunction } from 'express';\nimport { extractToken, verifyToken, hasPermission, isAdmin } from './index';\nimport { PublicUser, AuthUser, UserRole } from './types';\n\n// NOTE: Express.Request.user 타입은 backend/api/src/auth/middleware.ts에서\n// declare global로 선언됨. 빌드된 .d.ts와 중복 선언 충돌을 방지하기 위해\n// 이 모듈에서는 global 타입을 재선언하지 않음.\n\n/**\n * 사용자 조회 함수 타입\n * 외부에서 주입하여 역방향 의존성 제거\n */\ntype UserLookupFn = (userId: string) => PublicUser | null;\n\nlet _userLookup: UserLookupFn | null = null;\n\n/**\n * 사용자 조회 함수 등록 (앱 초기화 시 호출)\n * \n * @example\n * ```typescript\n * import { registerUserLookup } from './infrastructure/security/auth/middleware';\n * import { getUserManager } from './data/user-manager';\n * \n * registerUserLookup((userId) => getUserManager().getUserById(userId));\n * ```\n */\nexport function registerUserLookup(fn: UserLookupFn): void {\n    _userLookup = fn;\n    console.log('[Auth Middleware] 사용자 조회 함수 등록됨');\n}\n\nfunction getUserById(userId: string): PublicUser | null {\n    if (!_userLookup) {\n        console.error('[Auth Middleware] 사용자 조회 함수가 등록되지 않았습니다! registerUserLookup()을 호출하세요.');\n        return null;\n    }\n    return _userLookup(userId);\n}\n\n/**\n * 인증 미들웨어 (선택적)\n * 토큰이 있으면 검증하고 사용자 정보를 req.user에 추가\n * 토큰이 없어도 통과 (게스트 허용)\n */\nexport function optionalAuth(req: Request, res: Response, next: NextFunction): void {\n    const authHeader = req.headers.authorization;\n    const token = extractToken(authHeader);\n\n    if (token) {\n        const payload = verifyToken(token);\n\n        if (payload) {\n            const user = getUserById(payload.userId);\n\n            if (user && user.is_active) {\n                req.user = user;\n                req.token = token;\n            }\n        }\n    }\n\n    next();\n}\n\n/**\n * 인증 필수 미들웨어\n * 유효한 토큰이 없으면 401 반환\n */\nexport function requireAuth(req: Request, res: Response, next: NextFunction): void {\n    const authHeader = req.headers.authorization;\n    const token = extractToken(authHeader);\n\n    if (!token) {\n        res.status(401).json({ error: '인증이 필요합니다' });\n        return;\n    }\n\n    const payload = verifyToken(token);\n\n    if (!payload) {\n        res.status(401).json({ error: '유효하지 않은 토큰입니다' });\n        return;\n    }\n\n    const user = getUserById(payload.userId);\n\n    if (!user) {\n        res.status(401).json({ error: '사용자를 찾을 수 없습니다' });\n        return;\n    }\n\n    if (!user.is_active) {\n        res.status(403).json({ error: '비활성화된 계정입니다' });\n        return;\n    }\n\n    req.user = user;\n    req.token = token;\n    next();\n}\n\n/**\n * 관리자 권한 필수 미들웨어\n * requireAuth 이후에 사용\n */\nexport function requireAdmin(req: Request, res: Response, next: NextFunction): void {\n    if (!req.user) {\n        res.status(401).json({ error: '인증이 필요합니다' });\n        return;\n    }\n\n    if (!isAdmin(req.user.role)) {\n        res.status(403).json({ error: '관리자 권한이 필요합니다' });\n        return;\n    }\n\n    next();\n}\n\n/**\n * 특정 역할 필수 미들웨어 팩토리\n */\nexport function requireRole(role: UserRole) {\n    return (req: Request, res: Response, next: NextFunction): void => {\n        if (!req.user) {\n            res.status(401).json({ error: '인증이 필요합니다' });\n            return;\n        }\n\n        if (!hasPermission(req.user.role, role)) {\n            res.status(403).json({ error: `${role} 이상의 권한이 필요합니다` });\n            return;\n        }\n\n        next();\n    };\n}\n"],"version":3}