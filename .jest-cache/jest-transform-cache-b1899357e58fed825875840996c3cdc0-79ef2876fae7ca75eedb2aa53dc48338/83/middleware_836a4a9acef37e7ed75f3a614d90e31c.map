{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/auth/middleware.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/auth/middleware.ts"],"sourcesContent":["/**\n * 인증 미들웨어\n * Express 요청에 대한 인증 처리\n */\n\nimport { Request, Response, NextFunction } from 'express';\nimport { extractToken, verifyToken, hasPermission, isAdmin } from './index';\nimport { getUserManager, PublicUser, UserRole } from '../data/user-manager';\n\n/**\n * JWT 토큰에서 추출된 인증 정보 (미들웨어용)\n * PublicUser보다 간소화된 버전 - JWT 페이로드에서 직접 추출\n */\nexport interface AuthUser {\n    userId: string;\n    id?: string | number;\n    username?: string;\n    email?: string;\n    role: UserRole;\n    tier?: 'free' | 'pro' | 'enterprise';\n    is_active?: boolean;\n    created_at?: string;\n    last_login?: string;\n}\n\n// Request 타입 확장\n// user는 PublicUser (DB 조회) 또는 AuthUser (JWT 직접 추출) 가능\ndeclare global {\n    namespace Express {\n        interface Request {\n            /** 인증된 사용자 정보 - PublicUser(DB) 또는 AuthUser(JWT) */\n            user?: PublicUser | AuthUser;\n            token?: string;\n        }\n    }\n}\n\n/**\n * 인증 미들웨어 (선택적)\n * 토큰이 있으면 검증하고 사용자 정보를 req.user에 추가\n * 토큰이 없어도 통과 (게스트 허용)\n */\nexport function optionalAuth(req: Request, res: Response, next: NextFunction): void {\n    const authHeader = req.headers.authorization;\n    const token = extractToken(authHeader);\n\n    if (token) {\n        const payload = verifyToken(token);\n\n        if (payload) {\n            const userManager = getUserManager();\n            const user = userManager.getUserById(payload.userId);\n\n            if (user && user.is_active) {\n                req.user = user;\n                req.token = token;\n            }\n        }\n    }\n\n    next();\n}\n\n/**\n * 인증 필수 미들웨어\n * 유효한 토큰이 없으면 401 반환\n */\nexport function requireAuth(req: Request, res: Response, next: NextFunction): void {\n    const authHeader = req.headers.authorization;\n    const token = extractToken(authHeader);\n\n    if (!token) {\n        res.status(401).json({ error: '인증이 필요합니다' });\n        return;\n    }\n\n    const payload = verifyToken(token);\n\n    if (!payload) {\n        res.status(401).json({ error: '유효하지 않은 토큰입니다' });\n        return;\n    }\n\n    const userManager = getUserManager();\n    const user = userManager.getUserById(payload.userId);\n\n    if (!user) {\n        res.status(401).json({ error: '사용자를 찾을 수 없습니다' });\n        return;\n    }\n\n    if (!user.is_active) {\n        res.status(403).json({ error: '비활성화된 계정입니다' });\n        return;\n    }\n\n    req.user = user;\n    req.token = token;\n    next();\n}\n\n/**\n * 관리자 권한 필수 미들웨어\n * requireAuth 이후에 사용\n */\nexport function requireAdmin(req: Request, res: Response, next: NextFunction): void {\n    if (!req.user) {\n        res.status(401).json({ error: '인증이 필요합니다' });\n        return;\n    }\n\n    if (!isAdmin(req.user.role)) {\n        res.status(403).json({ error: '관리자 권한이 필요합니다' });\n        return;\n    }\n\n    next();\n}\n\n/**\n * 특정 역할 필수 미들웨어 팩토리\n */\nexport function requireRole(role: UserRole) {\n    return (req: Request, res: Response, next: NextFunction): void => {\n        if (!req.user) {\n            res.status(401).json({ error: '인증이 필요합니다' });\n            return;\n        }\n\n        if (!hasPermission(req.user.role, role)) {\n            res.status(403).json({ error: `${role} 이상의 권한이 필요합니다` });\n            return;\n        }\n\n        next();\n    };\n}\n"],"version":3}