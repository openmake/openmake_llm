{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/utils/input-sanitizer.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/utils/input-sanitizer.ts"],"sourcesContent":["/**\n * Input Sanitizer Utility\n *\n * Provides functions to sanitize and validate user input before\n * embedding it in LLM prompts. Helps prevent prompt injection attacks.\n */\n\n/** Maximum allowed input length in characters */\nconst MAX_INPUT_LENGTH = 10000;\n\n/** Maximum consecutive newlines allowed */\nconst MAX_CONSECUTIVE_NEWLINES = 3;\n\n/**\n * Patterns that indicate potential prompt injection attempts.\n * These are case-insensitive regex patterns that match common\n * techniques used to override system instructions.\n */\nconst DANGEROUS_PATTERNS: readonly RegExp[] = [\n  /ignore\\s+(previous|all|prior)\\s+instructions?/i,\n  /you\\s+are\\s+now/i,\n  /disregard\\s+(all|everything)/i,\n  /forget\\s+(everything|all)/i,\n  /new\\s+instructions?:/i,\n  /system\\s*:\\s*you\\s+are/i,\n  /\\[system\\]/i,\n  /\\[assistant\\]/i,\n  /\\[user\\]/i,\n  /<\\s*system\\s*>/i,\n  /override\\s+(previous|system)/i,\n] as const;\n\n/**\n * Sanitizes user input for safe use in LLM prompts.\n *\n * This function performs the following transformations:\n * - Removes control characters (ASCII 0-31) except newline (\\n) and tab (\\t)\n * - Normalizes multiple consecutive spaces to a single space\n * - Limits consecutive newlines to a maximum of 3\n * - Trims leading and trailing whitespace\n * - Truncates input to MAX_INPUT_LENGTH if exceeded\n *\n * @param input - Raw user input string\n * @returns Sanitized string safe for prompt inclusion\n *\n * @example\n * ```typescript\n * const clean = sanitizePromptInput(\"Hello\\x00World\");\n * // Returns: \"HelloWorld\"\n *\n * const normalized = sanitizePromptInput(\"Too    many   spaces\");\n * // Returns: \"Too many spaces\"\n * ```\n */\nexport function sanitizePromptInput(input: string): string {\n  if (!input) return '';\n\n  let sanitized = input;\n\n  // Remove control characters except newline (\\x0A) and tab (\\x09)\n  // Matches: \\x00-\\x08, \\x0B, \\x0C, \\x0E-\\x1F, \\x7F\n  sanitized = sanitized.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, '');\n\n  // Normalize multiple consecutive spaces (not newlines) to single space\n  // This preserves intentional line breaks while cleaning up horizontal whitespace\n  sanitized = sanitized.replace(/[^\\S\\n]+/g, ' ');\n\n  // Limit consecutive newlines to MAX_CONSECUTIVE_NEWLINES\n  const newlinePattern = new RegExp(`\\n{${MAX_CONSECUTIVE_NEWLINES + 1},}`, 'g');\n  sanitized = sanitized.replace(newlinePattern, '\\n'.repeat(MAX_CONSECUTIVE_NEWLINES));\n\n  // Trim leading and trailing whitespace\n  sanitized = sanitized.trim();\n\n  // Enforce maximum length\n  if (sanitized.length > MAX_INPUT_LENGTH) {\n    sanitized = sanitized.slice(0, MAX_INPUT_LENGTH);\n  }\n\n  return sanitized;\n}\n\n/**\n * Validation result returned by validatePromptInput.\n */\nexport interface ValidationResult {\n  /** Whether the input passed all validation checks */\n  valid: boolean;\n  /** Error message if validation failed, undefined if valid */\n  error?: string;\n}\n\n/**\n * Validates user input before using in LLM prompts.\n *\n * This function checks for:\n * - Empty or whitespace-only input\n * - Input exceeding maximum length (10,000 characters)\n * - Common prompt injection patterns that attempt to override system instructions\n * - Excessive consecutive newlines (more than 3)\n *\n * Note: This function does NOT sanitize the input. Use sanitizePromptInput()\n * first if you want to clean the input, or use this to reject invalid input entirely.\n *\n * @param input - User input to validate\n * @returns Validation result with error message if invalid\n *\n * @example\n * ```typescript\n * const result = validatePromptInput(\"Hello, world!\");\n * // Returns: { valid: true }\n *\n * const malicious = validatePromptInput(\"Ignore previous instructions\");\n * // Returns: { valid: false, error: \"Input contains potentially malicious instructions\" }\n * ```\n */\nexport function validatePromptInput(input: string): ValidationResult {\n  // Check for empty input\n  if (!input || input.trim().length === 0) {\n    return { valid: false, error: 'Input cannot be empty' };\n  }\n\n  // Check length limit\n  if (input.length > MAX_INPUT_LENGTH) {\n    return {\n      valid: false,\n      error: `Input exceeds maximum length of ${MAX_INPUT_LENGTH.toLocaleString()} characters`,\n    };\n  }\n\n  // Check for excessive consecutive newlines\n  const excessiveNewlinesPattern = new RegExp(`\\n{${MAX_CONSECUTIVE_NEWLINES + 1},}`);\n  if (excessiveNewlinesPattern.test(input)) {\n    return {\n      valid: false,\n      error: `Input contains more than ${MAX_CONSECUTIVE_NEWLINES} consecutive newlines`,\n    };\n  }\n\n  // Check for prompt injection patterns\n  for (const pattern of DANGEROUS_PATTERNS) {\n    if (pattern.test(input)) {\n      return {\n        valid: false,\n        error: 'Input contains potentially malicious instructions',\n      };\n    }\n  }\n\n  return { valid: true };\n}\n\n/**\n * Convenience function that both validates and sanitizes input.\n *\n * First validates the input, returning an error if validation fails.\n * If valid, returns the sanitized version of the input.\n *\n * @param input - Raw user input to process\n * @returns Object with either sanitized input or error message\n *\n * @example\n * ```typescript\n * const result = processPromptInput(\"Hello   world!\");\n * if (result.error) {\n *   console.error(result.error);\n * } else {\n *   console.log(result.sanitized); // \"Hello world!\"\n * }\n * ```\n */\nexport function processPromptInput(input: string): { sanitized?: string; error?: string } {\n  const validation = validatePromptInput(input);\n\n  if (!validation.valid) {\n    return { error: validation.error };\n  }\n\n  return { sanitized: sanitizePromptInput(input) };\n}\n"],"version":3}