b2efe961ca69ad88db5474878de27dc9
"use strict";
/**
 * 인증 미들웨어
 * Express 요청에 대한 인증 처리
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.optionalAuth = optionalAuth;
exports.requireAuth = requireAuth;
exports.requireAdmin = requireAdmin;
exports.requireRole = requireRole;
const index_1 = require("./index");
const user_manager_1 = require("../data/user-manager");
/**
 * 인증 미들웨어 (선택적)
 * 토큰이 있으면 검증하고 사용자 정보를 req.user에 추가
 * 토큰이 없어도 통과 (게스트 허용)
 */
function optionalAuth(req, res, next) {
    const authHeader = req.headers.authorization;
    const token = (0, index_1.extractToken)(authHeader);
    if (token) {
        const payload = (0, index_1.verifyToken)(token);
        if (payload) {
            const userManager = (0, user_manager_1.getUserManager)();
            const user = userManager.getUserById(payload.userId);
            if (user && user.is_active) {
                req.user = user;
                req.token = token;
            }
        }
    }
    next();
}
/**
 * 인증 필수 미들웨어
 * 유효한 토큰이 없으면 401 반환
 */
function requireAuth(req, res, next) {
    const authHeader = req.headers.authorization;
    const token = (0, index_1.extractToken)(authHeader);
    if (!token) {
        res.status(401).json({ error: '인증이 필요합니다' });
        return;
    }
    const payload = (0, index_1.verifyToken)(token);
    if (!payload) {
        res.status(401).json({ error: '유효하지 않은 토큰입니다' });
        return;
    }
    const userManager = (0, user_manager_1.getUserManager)();
    const user = userManager.getUserById(payload.userId);
    if (!user) {
        res.status(401).json({ error: '사용자를 찾을 수 없습니다' });
        return;
    }
    if (!user.is_active) {
        res.status(403).json({ error: '비활성화된 계정입니다' });
        return;
    }
    req.user = user;
    req.token = token;
    next();
}
/**
 * 관리자 권한 필수 미들웨어
 * requireAuth 이후에 사용
 */
function requireAdmin(req, res, next) {
    if (!req.user) {
        res.status(401).json({ error: '인증이 필요합니다' });
        return;
    }
    if (!(0, index_1.isAdmin)(req.user.role)) {
        res.status(403).json({ error: '관리자 권한이 필요합니다' });
        return;
    }
    next();
}
/**
 * 특정 역할 필수 미들웨어 팩토리
 */
function requireRole(role) {
    return (req, res, next) => {
        if (!req.user) {
            res.status(401).json({ error: '인증이 필요합니다' });
            return;
        }
        if (!(0, index_1.hasPermission)(req.user.role, role)) {
            res.status(403).json({ error: `${role} 이상의 권한이 필요합니다` });
            return;
        }
        next();
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL2F1dGgvbWlkZGxld2FyZS50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOztBQXVDSCxvQ0FtQkM7QUFNRCxrQ0FnQ0M7QUFNRCxvQ0FZQztBQUtELGtDQWNDO0FBbElELG1DQUE0RTtBQUM1RSx1REFBNEU7QUE4QjVFOzs7O0dBSUc7QUFDSCxTQUFnQixZQUFZLENBQUMsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQjtJQUN4RSxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQztJQUM3QyxNQUFNLEtBQUssR0FBRyxJQUFBLG9CQUFZLEVBQUMsVUFBVSxDQUFDLENBQUM7SUFFdkMsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUNSLE1BQU0sT0FBTyxHQUFHLElBQUEsbUJBQVcsRUFBQyxLQUFLLENBQUMsQ0FBQztRQUVuQyxJQUFJLE9BQU8sRUFBRSxDQUFDO1lBQ1YsTUFBTSxXQUFXLEdBQUcsSUFBQSw2QkFBYyxHQUFFLENBQUM7WUFDckMsTUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFckQsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUN6QixHQUFHLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztnQkFDaEIsR0FBRyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7WUFDdEIsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBSSxFQUFFLENBQUM7QUFDWCxDQUFDO0FBRUQ7OztHQUdHO0FBQ0gsU0FBZ0IsV0FBVyxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0I7SUFDdkUsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUM7SUFDN0MsTUFBTSxLQUFLLEdBQUcsSUFBQSxvQkFBWSxFQUFDLFVBQVUsQ0FBQyxDQUFDO0lBRXZDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNULEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDN0MsT0FBTztJQUNYLENBQUM7SUFFRCxNQUFNLE9BQU8sR0FBRyxJQUFBLG1CQUFXLEVBQUMsS0FBSyxDQUFDLENBQUM7SUFFbkMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ1gsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLENBQUMsQ0FBQztRQUNqRCxPQUFPO0lBQ1gsQ0FBQztJQUVELE1BQU0sV0FBVyxHQUFHLElBQUEsNkJBQWMsR0FBRSxDQUFDO0lBQ3JDLE1BQU0sSUFBSSxHQUFHLFdBQVcsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRXJELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNSLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLGdCQUFnQixFQUFFLENBQUMsQ0FBQztRQUNsRCxPQUFPO0lBQ1gsQ0FBQztJQUVELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDbEIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztRQUMvQyxPQUFPO0lBQ1gsQ0FBQztJQUVELEdBQUcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ2hCLEdBQUcsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ2xCLElBQUksRUFBRSxDQUFDO0FBQ1gsQ0FBQztBQUVEOzs7R0FHRztBQUNILFNBQWdCLFlBQVksQ0FBQyxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCO0lBQ3hFLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDWixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQzdDLE9BQU87SUFDWCxDQUFDO0lBRUQsSUFBSSxDQUFDLElBQUEsZUFBTyxFQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUMxQixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsQ0FBQyxDQUFDO1FBQ2pELE9BQU87SUFDWCxDQUFDO0lBRUQsSUFBSSxFQUFFLENBQUM7QUFDWCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFnQixXQUFXLENBQUMsSUFBYztJQUN0QyxPQUFPLENBQUMsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFRLEVBQUU7UUFDN0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNaLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7WUFDN0MsT0FBTztRQUNYLENBQUM7UUFFRCxJQUFJLENBQUMsSUFBQSxxQkFBYSxFQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDdEMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsR0FBRyxJQUFJLGdCQUFnQixFQUFFLENBQUMsQ0FBQztZQUN6RCxPQUFPO1FBQ1gsQ0FBQztRQUVELElBQUksRUFBRSxDQUFDO0lBQ1gsQ0FBQyxDQUFDO0FBQ04sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVm9sdW1lcy9NQUNfQVBQL29wZW5tYWtlX2xsbS9iYWNrZW5kL2FwaS9zcmMvYXV0aC9taWRkbGV3YXJlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICog7J247KadIOuvuOuTpOybqOyWtFxuICogRXhwcmVzcyDsmpTssq3sl5Ag64yA7ZWcIOyduOymnSDsspjrpqxcbiAqL1xuXG5pbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBleHRyYWN0VG9rZW4sIHZlcmlmeVRva2VuLCBoYXNQZXJtaXNzaW9uLCBpc0FkbWluIH0gZnJvbSAnLi9pbmRleCc7XG5pbXBvcnQgeyBnZXRVc2VyTWFuYWdlciwgUHVibGljVXNlciwgVXNlclJvbGUgfSBmcm9tICcuLi9kYXRhL3VzZXItbWFuYWdlcic7XG5cbi8qKlxuICogSldUIO2GoO2BsOyXkOyEnCDstpTstpzrkJwg7J247KadIOygleuztCAo66+465Ok7Juo7Ja07JqpKVxuICogUHVibGljVXNlcuuztOuLpCDqsITshoztmZTrkJwg67KE7KCEIC0gSldUIO2OmOydtOuhnOuTnOyXkOyEnCDsp4HsoJEg7LaU7LacXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aFVzZXIge1xuICAgIHVzZXJJZDogc3RyaW5nO1xuICAgIGlkPzogc3RyaW5nIHwgbnVtYmVyO1xuICAgIHVzZXJuYW1lPzogc3RyaW5nO1xuICAgIGVtYWlsPzogc3RyaW5nO1xuICAgIHJvbGU6IFVzZXJSb2xlO1xuICAgIHRpZXI/OiAnZnJlZScgfCAncHJvJyB8ICdlbnRlcnByaXNlJztcbiAgICBpc19hY3RpdmU/OiBib29sZWFuO1xuICAgIGNyZWF0ZWRfYXQ/OiBzdHJpbmc7XG4gICAgbGFzdF9sb2dpbj86IHN0cmluZztcbn1cblxuLy8gUmVxdWVzdCDtg4DsnoUg7ZmV7J6lXG4vLyB1c2Vy64qUIFB1YmxpY1VzZXIgKERCIOyhsO2ajCkg65iQ64qUIEF1dGhVc2VyIChKV1Qg7KeB7KCRIOy2lOy2nCkg6rCA64qlXG5kZWNsYXJlIGdsb2JhbCB7XG4gICAgbmFtZXNwYWNlIEV4cHJlc3Mge1xuICAgICAgICBpbnRlcmZhY2UgUmVxdWVzdCB7XG4gICAgICAgICAgICAvKiog7J247Kad65CcIOyCrOyaqeyekCDsoJXrs7QgLSBQdWJsaWNVc2VyKERCKSDrmJDripQgQXV0aFVzZXIoSldUKSAqL1xuICAgICAgICAgICAgdXNlcj86IFB1YmxpY1VzZXIgfCBBdXRoVXNlcjtcbiAgICAgICAgICAgIHRva2VuPzogc3RyaW5nO1xuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIOyduOymnSDrr7jrk6Tsm6jslrQgKOyEoO2DneyggSlcbiAqIO2GoO2BsOydtCDsnojsnLzrqbQg6rKA7Kad7ZWY6rOgIOyCrOyaqeyekCDsoJXrs7TrpbwgcmVxLnVzZXLsl5Ag7LaU6rCAXG4gKiDthqDtgbDsnbQg7JeG7Ja064+EIO2GteqzvCAo6rKM7Iqk7Yq4IO2XiOyaqSlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG9wdGlvbmFsQXV0aChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQge1xuICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uO1xuICAgIGNvbnN0IHRva2VuID0gZXh0cmFjdFRva2VuKGF1dGhIZWFkZXIpO1xuXG4gICAgaWYgKHRva2VuKSB7XG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSB2ZXJpZnlUb2tlbih0b2tlbik7XG5cbiAgICAgICAgaWYgKHBheWxvYWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXJNYW5hZ2VyID0gZ2V0VXNlck1hbmFnZXIoKTtcbiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSB1c2VyTWFuYWdlci5nZXRVc2VyQnlJZChwYXlsb2FkLnVzZXJJZCk7XG5cbiAgICAgICAgICAgIGlmICh1c2VyICYmIHVzZXIuaXNfYWN0aXZlKSB7XG4gICAgICAgICAgICAgICAgcmVxLnVzZXIgPSB1c2VyO1xuICAgICAgICAgICAgICAgIHJlcS50b2tlbiA9IHRva2VuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmV4dCgpO1xufVxuXG4vKipcbiAqIOyduOymnSDtlYTsiJgg66+465Ok7Juo7Ja0XG4gKiDsnKDtmqjtlZwg7Yag7YGw7J20IOyXhuycvOuptCA0MDEg67CY7ZmYXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlQXV0aChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQge1xuICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uO1xuICAgIGNvbnN0IHRva2VuID0gZXh0cmFjdFRva2VuKGF1dGhIZWFkZXIpO1xuXG4gICAgaWYgKCF0b2tlbikge1xuICAgICAgICByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAn7J247Kad7J20IO2VhOyalO2VqeuLiOuLpCcgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwYXlsb2FkID0gdmVyaWZ5VG9rZW4odG9rZW4pO1xuXG4gICAgaWYgKCFwYXlsb2FkKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICfsnKDtmqjtlZjsp4Ag7JWK7J2AIO2GoO2BsOyeheuLiOuLpCcgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB1c2VyTWFuYWdlciA9IGdldFVzZXJNYW5hZ2VyKCk7XG4gICAgY29uc3QgdXNlciA9IHVzZXJNYW5hZ2VyLmdldFVzZXJCeUlkKHBheWxvYWQudXNlcklkKTtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgICByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAn7IKs7Jqp7J6Q66W8IOywvuydhCDsiJgg7JeG7Iq164uI64ukJyB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdXNlci5pc19hY3RpdmUpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ+u5hO2ZnOyEse2ZlOuQnCDqs4TsoJXsnoXri4jri6QnIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcmVxLnVzZXIgPSB1c2VyO1xuICAgIHJlcS50b2tlbiA9IHRva2VuO1xuICAgIG5leHQoKTtcbn1cblxuLyoqXG4gKiDqtIDrpqzsnpAg6raM7ZWcIO2VhOyImCDrr7jrk6Tsm6jslrRcbiAqIHJlcXVpcmVBdXRoIOydtO2bhOyXkCDsgqzsmqlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVBZG1pbihyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQge1xuICAgIGlmICghcmVxLnVzZXIpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ+yduOymneydtCDtlYTsmpTtlanri4jri6QnIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCFpc0FkbWluKHJlcS51c2VyLnJvbGUpKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICfqtIDrpqzsnpAg6raM7ZWc7J20IO2VhOyalO2VqeuLiOuLpCcgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBuZXh0KCk7XG59XG5cbi8qKlxuICog7Yq57KCVIOyXre2VoCDtlYTsiJgg66+465Ok7Juo7Ja0IO2Mqe2GoOumrFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVxdWlyZVJvbGUocm9sZTogVXNlclJvbGUpIHtcbiAgICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogdm9pZCA9PiB7XG4gICAgICAgIGlmICghcmVxLnVzZXIpIHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICfsnbjspp3snbQg7ZWE7JqU7ZWp64uI64ukJyB9KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghaGFzUGVybWlzc2lvbihyZXEudXNlci5yb2xlLCByb2xlKSkge1xuICAgICAgICAgICAgcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogYCR7cm9sZX0g7J207IOB7J2YIOq2jO2VnOydtCDtlYTsmpTtlanri4jri6RgIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbmV4dCgpO1xuICAgIH07XG59XG4iXSwidmVyc2lvbiI6M30=