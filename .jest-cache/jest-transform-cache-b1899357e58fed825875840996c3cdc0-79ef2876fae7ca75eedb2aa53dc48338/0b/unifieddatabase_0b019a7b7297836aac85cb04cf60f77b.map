{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/data/models/unified-database.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/data/models/unified-database.ts"],"sourcesContent":["/**\n * Unified Database Model\n * ÌÜµÌï© Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Î™®Îç∏ - Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Îã®Ïùº SQLite Î°ú Í¥ÄÎ¶¨\n */\n\nimport Database from 'better-sqlite3';\nimport * as path from 'path';\nimport * as fs from 'fs';\n\n// Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§Îßà\nconst SCHEMA = `\n-- ÏÇ¨Ïö©Ïûê ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS users (\n    id TEXT PRIMARY KEY,\n    username TEXT UNIQUE NOT NULL,\n    password_hash TEXT NOT NULL,\n    email TEXT,\n    role TEXT DEFAULT 'user' CHECK(role IN ('admin', 'user', 'guest')),\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    last_login DATETIME,\n    is_active INTEGER DEFAULT 1\n);\n\n-- ÎåÄÌôî ÏÑ∏ÏÖò ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS conversation_sessions (\n    id TEXT PRIMARY KEY,\n    user_id TEXT,\n    title TEXT,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    metadata JSON,\n    FOREIGN KEY (user_id) REFERENCES users(id)\n);\n\n-- ÎåÄÌôî Î©îÏãúÏßÄ ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS conversation_messages (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    session_id TEXT NOT NULL,\n    role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system')),\n    content TEXT NOT NULL,\n    model TEXT,\n    agent_id TEXT,\n    thinking TEXT,\n    tokens INTEGER,\n    response_time_ms INTEGER,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (session_id) REFERENCES conversation_sessions(id) ON DELETE CASCADE\n);\n\n-- API ÏÇ¨Ïö©Îüâ ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS api_usage (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    date TEXT NOT NULL,\n    api_key_id TEXT,\n    requests INTEGER DEFAULT 0,\n    tokens INTEGER DEFAULT 0,\n    errors INTEGER DEFAULT 0,\n    avg_response_time REAL DEFAULT 0,\n    models JSON,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    UNIQUE(date, api_key_id)\n);\n\n-- ÏóêÏù¥Ï†ÑÌä∏ ÏÇ¨Ïö© Î°úÍ∑∏ ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS agent_usage_logs (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,\n    user_id TEXT,\n    session_id TEXT,\n    agent_id TEXT NOT NULL,\n    query TEXT,\n    response_preview TEXT,\n    response_time_ms INTEGER,\n    tokens_used INTEGER,\n    success INTEGER DEFAULT 1,\n    error_message TEXT,\n    FOREIGN KEY (user_id) REFERENCES users(id),\n    FOREIGN KEY (session_id) REFERENCES conversation_sessions(id)\n);\n\n-- ÏóêÏù¥Ï†ÑÌä∏ ÌîºÎìúÎ∞± ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS agent_feedback (\n    id TEXT PRIMARY KEY,\n    agent_id TEXT NOT NULL,\n    user_id TEXT,\n    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),\n    comment TEXT,\n    query TEXT,\n    response TEXT,\n    tags JSON,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (user_id) REFERENCES users(id)\n);\n\n-- Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS custom_agents (\n    id TEXT PRIMARY KEY,\n    name TEXT NOT NULL,\n    description TEXT,\n    system_prompt TEXT NOT NULL,\n    keywords JSON,\n    category TEXT,\n    emoji TEXT DEFAULT 'ü§ñ',\n    temperature REAL,\n    max_tokens INTEGER,\n    created_by TEXT,\n    enabled INTEGER DEFAULT 1,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (created_by) REFERENCES users(id)\n);\n\n-- ÏãúÏä§ÌÖú Í∞êÏÇ¨ Î°úÍ∑∏ ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS audit_logs (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,\n    action TEXT NOT NULL,\n    user_id TEXT,\n    resource_type TEXT,\n    resource_id TEXT,\n    details JSON,\n    ip_address TEXT,\n    user_agent TEXT\n);\n\n-- ÏïåÎ¶º ÌûàÏä§ÌÜ†Î¶¨ ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS alert_history (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    type TEXT NOT NULL,\n    severity TEXT NOT NULL,\n    title TEXT NOT NULL,\n    message TEXT,\n    data JSON,\n    acknowledged INTEGER DEFAULT 0,\n    acknowledged_by TEXT,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    acknowledged_at DATETIME\n);\n\n-- Ïù∏Îç±Ïä§\nCREATE INDEX IF NOT EXISTS idx_messages_session ON conversation_messages(session_id);\nCREATE INDEX IF NOT EXISTS idx_messages_created ON conversation_messages(created_at);\nCREATE INDEX IF NOT EXISTS idx_usage_date ON api_usage(date);\nCREATE INDEX IF NOT EXISTS idx_agent_logs_agent ON agent_usage_logs(agent_id);\nCREATE INDEX IF NOT EXISTS idx_agent_logs_time ON agent_usage_logs(timestamp);\nCREATE INDEX IF NOT EXISTS idx_feedback_agent ON agent_feedback(agent_id);\nCREATE INDEX IF NOT EXISTS idx_audit_action ON audit_logs(action);\nCREATE INDEX IF NOT EXISTS idx_audit_time ON audit_logs(timestamp);\nCREATE INDEX IF NOT EXISTS idx_users_username ON users(username);\nCREATE INDEX IF NOT EXISTS idx_users_email ON users(email);\nCREATE INDEX IF NOT EXISTS idx_sessions_user ON conversation_sessions(user_id);\n\n-- ============================================\n-- üß† Ïû•Í∏∞ Î©îÎ™®Î¶¨ ÏãúÏä§ÌÖú ÌÖåÏù¥Î∏î\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS user_memories (\n    id TEXT PRIMARY KEY,\n    user_id TEXT NOT NULL,\n    category TEXT NOT NULL CHECK(category IN ('preference', 'fact', 'project', 'relationship', 'skill', 'context')),\n    key TEXT NOT NULL,\n    value TEXT NOT NULL,\n    importance REAL DEFAULT 0.5,\n    access_count INTEGER DEFAULT 0,\n    last_accessed DATETIME,\n    source_session_id TEXT,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    expires_at DATETIME,\n    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n    UNIQUE(user_id, category, key)\n);\n\nCREATE TABLE IF NOT EXISTS memory_tags (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    memory_id TEXT NOT NULL,\n    tag TEXT NOT NULL,\n    FOREIGN KEY (memory_id) REFERENCES user_memories(id) ON DELETE CASCADE,\n    UNIQUE(memory_id, tag)\n);\n\nCREATE INDEX IF NOT EXISTS idx_memories_user ON user_memories(user_id);\nCREATE INDEX IF NOT EXISTS idx_memories_category ON user_memories(category);\nCREATE INDEX IF NOT EXISTS idx_memories_importance ON user_memories(importance DESC);\n\n-- ============================================\n-- üîç Deep Research ÌÖåÏù¥Î∏î\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS research_sessions (\n    id TEXT PRIMARY KEY,\n    user_id TEXT,\n    topic TEXT NOT NULL,\n    status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'running', 'completed', 'failed', 'cancelled')),\n    depth TEXT DEFAULT 'standard' CHECK(depth IN ('quick', 'standard', 'deep')),\n    progress INTEGER DEFAULT 0,\n    summary TEXT,\n    key_findings JSON,\n    sources JSON,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    completed_at DATETIME,\n    FOREIGN KEY (user_id) REFERENCES users(id)\n);\n\nCREATE TABLE IF NOT EXISTS research_steps (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    session_id TEXT NOT NULL,\n    step_number INTEGER NOT NULL,\n    step_type TEXT NOT NULL,\n    query TEXT,\n    result TEXT,\n    sources JSON,\n    status TEXT DEFAULT 'pending',\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (session_id) REFERENCES research_sessions(id) ON DELETE CASCADE\n);\n\nCREATE INDEX IF NOT EXISTS idx_research_user ON research_sessions(user_id);\nCREATE INDEX IF NOT EXISTS idx_research_status ON research_sessions(status);\n\n-- ============================================\n-- üè™ Custom Agent ÎßàÏºìÌîåÎ†àÏù¥Ïä§ ÌÖåÏù¥Î∏î\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS agent_marketplace (\n    id TEXT PRIMARY KEY,\n    agent_id TEXT NOT NULL,\n    author_id TEXT NOT NULL,\n    title TEXT NOT NULL,\n    description TEXT,\n    long_description TEXT,\n    category TEXT,\n    tags JSON,\n    icon TEXT DEFAULT 'ü§ñ',\n    price REAL DEFAULT 0,\n    is_free INTEGER DEFAULT 1,\n    is_featured INTEGER DEFAULT 0,\n    is_verified INTEGER DEFAULT 0,\n    downloads INTEGER DEFAULT 0,\n    rating_avg REAL DEFAULT 0,\n    rating_count INTEGER DEFAULT 0,\n    version TEXT DEFAULT '1.0.0',\n    status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'approved', 'rejected', 'suspended')),\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    published_at DATETIME,\n    FOREIGN KEY (agent_id) REFERENCES custom_agents(id),\n    FOREIGN KEY (author_id) REFERENCES users(id)\n);\n\nCREATE TABLE IF NOT EXISTS agent_reviews (\n    id TEXT PRIMARY KEY,\n    marketplace_id TEXT NOT NULL,\n    user_id TEXT NOT NULL,\n    rating INTEGER NOT NULL CHECK(rating >= 1 AND rating <= 5),\n    title TEXT,\n    content TEXT,\n    helpful_count INTEGER DEFAULT 0,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (marketplace_id) REFERENCES agent_marketplace(id) ON DELETE CASCADE,\n    FOREIGN KEY (user_id) REFERENCES users(id),\n    UNIQUE(marketplace_id, user_id)\n);\n\nCREATE TABLE IF NOT EXISTS agent_installations (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    marketplace_id TEXT NOT NULL,\n    user_id TEXT NOT NULL,\n    installed_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (marketplace_id) REFERENCES agent_marketplace(id),\n    FOREIGN KEY (user_id) REFERENCES users(id),\n    UNIQUE(marketplace_id, user_id)\n);\n\nCREATE INDEX IF NOT EXISTS idx_marketplace_category ON agent_marketplace(category);\nCREATE INDEX IF NOT EXISTS idx_marketplace_downloads ON agent_marketplace(downloads DESC);\n\n-- ============================================\n-- üìù Canvas ÌòëÏóÖ ÎèÑÍµ¨ ÌÖåÏù¥Î∏î\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS canvas_documents (\n    id TEXT PRIMARY KEY,\n    user_id TEXT NOT NULL,\n    session_id TEXT,\n    title TEXT NOT NULL,\n    doc_type TEXT DEFAULT 'document' CHECK(doc_type IN ('document', 'code', 'diagram', 'table')),\n    content TEXT,\n    language TEXT,\n    version INTEGER DEFAULT 1,\n    is_shared INTEGER DEFAULT 0,\n    share_token TEXT UNIQUE,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (user_id) REFERENCES users(id),\n    FOREIGN KEY (session_id) REFERENCES conversation_sessions(id)\n);\n\nCREATE TABLE IF NOT EXISTS canvas_versions (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    document_id TEXT NOT NULL,\n    version INTEGER NOT NULL,\n    content TEXT NOT NULL,\n    change_summary TEXT,\n    created_by TEXT,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (document_id) REFERENCES canvas_documents(id) ON DELETE CASCADE\n);\n\nCREATE INDEX IF NOT EXISTS idx_canvas_user ON canvas_documents(user_id);\nCREATE INDEX IF NOT EXISTS idx_canvas_session ON canvas_documents(session_id);\n\n-- ============================================\n-- üîó Ïô∏Î∂Ä ÏÑúÎπÑÏä§ ÌÜµÌï© ÌÖåÏù¥Î∏î\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS external_connections (\n    id TEXT PRIMARY KEY,\n    user_id TEXT NOT NULL,\n    service_type TEXT NOT NULL CHECK(service_type IN ('google_drive', 'notion', 'github', 'slack', 'dropbox')),\n    access_token TEXT,\n    refresh_token TEXT,\n    token_expires_at DATETIME,\n    account_email TEXT,\n    account_name TEXT,\n    metadata JSON,\n    is_active INTEGER DEFAULT 1,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n    UNIQUE(user_id, service_type)\n);\n\nCREATE TABLE IF NOT EXISTS external_files (\n    id TEXT PRIMARY KEY,\n    connection_id TEXT NOT NULL,\n    external_id TEXT NOT NULL,\n    file_name TEXT NOT NULL,\n    file_type TEXT,\n    file_size INTEGER,\n    web_url TEXT,\n    last_synced DATETIME,\n    cached_content TEXT,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (connection_id) REFERENCES external_connections(id) ON DELETE CASCADE,\n    UNIQUE(connection_id, external_id)\n);\n\nCREATE INDEX IF NOT EXISTS idx_connections_user ON external_connections(user_id);\nCREATE INDEX IF NOT EXISTS idx_connections_service ON external_connections(service_type);\n`;\n\nexport interface User {\n    id: string;\n    username: string;\n    password_hash: string;\n    email?: string;\n    role: 'admin' | 'user' | 'guest';\n    created_at: string;\n    updated_at: string;\n    last_login?: string;\n    is_active: boolean;\n}\n\nexport interface ConversationSession {\n    id: string;\n    user_id?: string;\n    title: string;\n    created_at: string;\n    updated_at: string;\n    metadata?: any;\n}\n\nexport interface ConversationMessage {\n    id: number;\n    session_id: string;\n    role: 'user' | 'assistant' | 'system';\n    content: string;\n    model?: string;\n    agent_id?: string;\n    thinking?: string;\n    tokens?: number;\n    response_time_ms?: number;\n    created_at: string;\n}\n\n// ============================================\n// üß† Ïû•Í∏∞ Î©îÎ™®Î¶¨ ÏãúÏä§ÌÖú Ïù∏ÌÑ∞ÌéòÏù¥Ïä§\n// ============================================\n\nexport type MemoryCategory = 'preference' | 'fact' | 'project' | 'relationship' | 'skill' | 'context';\n\nexport interface UserMemory {\n    id: string;\n    user_id: string;\n    category: MemoryCategory;\n    key: string;\n    value: string;\n    importance: number;\n    access_count: number;\n    last_accessed?: string;\n    source_session_id?: string;\n    created_at: string;\n    updated_at: string;\n    expires_at?: string;\n}\n\nexport interface MemoryTag {\n    id: number;\n    memory_id: string;\n    tag: string;\n}\n\n// ============================================\n// üîç Deep Research Ïù∏ÌÑ∞ÌéòÏù¥Ïä§\n// ============================================\n\nexport type ResearchStatus = 'pending' | 'running' | 'completed' | 'failed' | 'cancelled';\nexport type ResearchDepth = 'quick' | 'standard' | 'deep';\n\nexport interface ResearchSession {\n    id: string;\n    user_id?: string;\n    topic: string;\n    status: ResearchStatus;\n    depth: ResearchDepth;\n    progress: number;\n    summary?: string;\n    key_findings?: string[];\n    sources?: string[];\n    created_at: string;\n    updated_at: string;\n    completed_at?: string;\n}\n\nexport interface ResearchStep {\n    id: number;\n    session_id: string;\n    step_number: number;\n    step_type: string;\n    query?: string;\n    result?: string;\n    sources?: string[];\n    status: string;\n    created_at: string;\n}\n\n// ============================================\n// üè™ ÎßàÏºìÌîåÎ†àÏù¥Ïä§ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§\n// ============================================\n\nexport type MarketplaceStatus = 'pending' | 'approved' | 'rejected' | 'suspended';\n\nexport interface MarketplaceAgent {\n    id: string;\n    agent_id: string;\n    author_id: string;\n    title: string;\n    description?: string;\n    long_description?: string;\n    category?: string;\n    tags?: string[];\n    icon: string;\n    price: number;\n    is_free: boolean;\n    is_featured: boolean;\n    is_verified: boolean;\n    downloads: number;\n    rating_avg: number;\n    rating_count: number;\n    version: string;\n    status: MarketplaceStatus;\n    created_at: string;\n    updated_at: string;\n    published_at?: string;\n}\n\nexport interface AgentReview {\n    id: string;\n    marketplace_id: string;\n    user_id: string;\n    rating: number;\n    title?: string;\n    content?: string;\n    helpful_count: number;\n    created_at: string;\n}\n\nexport interface AgentInstallation {\n    id: number;\n    marketplace_id: string;\n    user_id: string;\n    installed_at: string;\n}\n\n// ============================================\n// üìù Canvas Ïù∏ÌÑ∞ÌéòÏù¥Ïä§\n// ============================================\n\nexport type CanvasDocType = 'document' | 'code' | 'diagram' | 'table';\n\nexport interface CanvasDocument {\n    id: string;\n    user_id: string;\n    session_id?: string;\n    title: string;\n    doc_type: CanvasDocType;\n    content?: string;\n    language?: string;\n    version: number;\n    is_shared: boolean;\n    share_token?: string;\n    created_at: string;\n    updated_at: string;\n}\n\nexport interface CanvasVersion {\n    id: number;\n    document_id: string;\n    version: number;\n    content: string;\n    change_summary?: string;\n    created_by?: string;\n    created_at: string;\n}\n\n// ============================================\n// üîó Ïô∏Î∂Ä ÏÑúÎπÑÏä§ ÌÜµÌï© Ïù∏ÌÑ∞ÌéòÏù¥Ïä§\n// ============================================\n\nexport type ExternalServiceType = 'google_drive' | 'notion' | 'github' | 'slack' | 'dropbox';\n\nexport interface ExternalConnection {\n    id: string;\n    user_id: string;\n    service_type: ExternalServiceType;\n    access_token?: string;\n    refresh_token?: string;\n    token_expires_at?: string;\n    account_email?: string;\n    account_name?: string;\n    metadata?: Record<string, any>;\n    is_active: boolean;\n    created_at: string;\n    updated_at: string;\n}\n\nexport interface ExternalFile {\n    id: string;\n    connection_id: string;\n    external_id: string;\n    file_name: string;\n    file_type?: string;\n    file_size?: number;\n    web_url?: string;\n    last_synced?: string;\n    cached_content?: string;\n    created_at: string;\n}\n\n/**\n * ÌÜµÌï© Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌÅ¥ÎûòÏä§\n */\nexport class UnifiedDatabase {\n    private db: Database.Database;\n    private dbPath: string;\n\n    constructor(dataDir: string = './data') {\n        // ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±\n        if (!fs.existsSync(dataDir)) {\n            fs.mkdirSync(dataDir, { recursive: true });\n        }\n\n        this.dbPath = path.join(dataDir, 'unified.db');\n        this.db = new Database(this.dbPath);\n        this.db.pragma('journal_mode = WAL');\n\n        // Ïä§ÌÇ§Îßà Ï¥àÍ∏∞Ìôî\n        this.initSchema();\n\n        console.log(`[UnifiedDB] Ï¥àÍ∏∞Ìôî ÏôÑÎ£å: ${this.dbPath}`);\n    }\n\n    private initSchema(): void {\n        this.db.exec(SCHEMA);\n    }\n\n    getDatabase(): Database.Database {\n        return this.db;\n    }\n\n    // ===== ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ =====\n\n    createUser(id: string, username: string, passwordHash: string, email?: string, role: string = 'user') {\n        const stmt = this.db.prepare(`\n            INSERT INTO users (id, username, password_hash, email, role)\n            VALUES (?, ?, ?, ?, ?)\n        `);\n        return stmt.run(id, username, passwordHash, email, role);\n    }\n\n    getUserByUsername(username: string): User | undefined {\n        const stmt = this.db.prepare('SELECT * FROM users WHERE username = ?');\n        return stmt.get(username) as User | undefined;\n    }\n\n    getUserById(id: string): User | undefined {\n        const stmt = this.db.prepare('SELECT * FROM users WHERE id = ?');\n        return stmt.get(id) as User | undefined;\n    }\n\n    updateLastLogin(userId: string) {\n        const stmt = this.db.prepare('UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?');\n        return stmt.run(userId);\n    }\n\n    getAllUsers(limit: number = 50): User[] {\n        const stmt = this.db.prepare('SELECT * FROM users ORDER BY created_at DESC LIMIT ?');\n        return stmt.all(limit) as User[];\n    }\n\n    // ===== ÎåÄÌôî Í¥ÄÎ¶¨ =====\n\n    createSession(id: string, userId?: string, title?: string, metadata?: any) {\n        const stmt = this.db.prepare(`\n            INSERT INTO conversation_sessions (id, user_id, title, metadata)\n            VALUES (?, ?, ?, ?)\n        `);\n        return stmt.run(id, userId, title || 'ÏÉà ÎåÄÌôî', JSON.stringify(metadata || {}));\n    }\n\n    addMessage(sessionId: string, role: string, content: string, options?: {\n        model?: string;\n        agentId?: string;\n        thinking?: string;\n        tokens?: number;\n        responseTimeMs?: number;\n    }) {\n        const stmt = this.db.prepare(`\n            INSERT INTO conversation_messages \n            (session_id, role, content, model, agent_id, thinking, tokens, response_time_ms)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n        `);\n        return stmt.run(\n            sessionId, role, content,\n            options?.model, options?.agentId, options?.thinking,\n            options?.tokens, options?.responseTimeMs\n        );\n    }\n\n    getSessionMessages(sessionId: string, limit: number = 100): ConversationMessage[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM conversation_messages \n            WHERE session_id = ? \n            ORDER BY created_at ASC \n            LIMIT ?\n        `);\n        return stmt.all(sessionId, limit) as ConversationMessage[];\n    }\n\n    getUserSessions(userId: string, limit: number = 50): ConversationSession[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM conversation_sessions \n            WHERE user_id = ? \n            ORDER BY updated_at DESC \n            LIMIT ?\n        `);\n        return stmt.all(userId, limit) as ConversationSession[];\n    }\n\n    getAllSessions(limit: number = 50): ConversationSession[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM conversation_sessions \n            ORDER BY updated_at DESC \n            LIMIT ?\n        `);\n        return stmt.all(limit) as ConversationSession[];\n    }\n\n    deleteSession(sessionId: string) {\n        const stmt = this.db.prepare('DELETE FROM conversation_sessions WHERE id = ?');\n        return stmt.run(sessionId);\n    }\n\n    // ===== API ÏÇ¨Ïö©Îüâ Í¥ÄÎ¶¨ =====\n\n    recordApiUsage(date: string, apiKeyId: string, requests: number, tokens: number, errors: number, avgResponseTime: number, models: any) {\n        const stmt = this.db.prepare(`\n            INSERT INTO api_usage (date, api_key_id, requests, tokens, errors, avg_response_time, models)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n            ON CONFLICT(date, api_key_id) DO UPDATE SET\n                requests = requests + excluded.requests,\n                tokens = tokens + excluded.tokens,\n                errors = errors + excluded.errors,\n                avg_response_time = (avg_response_time + excluded.avg_response_time) / 2,\n                models = excluded.models,\n                updated_at = CURRENT_TIMESTAMP\n        `);\n        return stmt.run(date, apiKeyId, requests, tokens, errors, avgResponseTime, JSON.stringify(models));\n    }\n\n    getDailyUsage(days: number = 7) {\n        const stmt = this.db.prepare(`\n            SELECT date, SUM(requests) as requests, SUM(tokens) as tokens, SUM(errors) as errors, AVG(avg_response_time) as avg_response_time\n            FROM api_usage\n            WHERE date >= date('now', '-' || ? || ' days')\n            GROUP BY date\n            ORDER BY date DESC\n        `);\n        return stmt.all(days);\n    }\n\n    // ===== ÏóêÏù¥Ï†ÑÌä∏ Î°úÍ∑∏ =====\n\n    logAgentUsage(params: {\n        userId?: string;\n        sessionId?: string;\n        agentId: string;\n        query: string;\n        responsePreview?: string;\n        responseTimeMs?: number;\n        tokensUsed?: number;\n        success?: boolean;\n        errorMessage?: string;\n    }) {\n        const stmt = this.db.prepare(`\n            INSERT INTO agent_usage_logs \n            (user_id, session_id, agent_id, query, response_preview, response_time_ms, tokens_used, success, error_message)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n        `);\n        return stmt.run(\n            params.userId, params.sessionId, params.agentId,\n            params.query, params.responsePreview,\n            params.responseTimeMs, params.tokensUsed,\n            params.success !== false ? 1 : 0,\n            params.errorMessage\n        );\n    }\n\n    getAgentStats(agentId: string) {\n        const stmt = this.db.prepare(`\n            SELECT \n                COUNT(*) as total_requests,\n                SUM(CASE WHEN success = 1 THEN 1 ELSE 0 END) as successful_requests,\n                AVG(response_time_ms) as avg_response_time,\n                AVG(tokens_used) as avg_tokens\n            FROM agent_usage_logs\n            WHERE agent_id = ?\n        `);\n        return stmt.get(agentId);\n    }\n\n    // ===== Í∞êÏÇ¨ Î°úÍ∑∏ =====\n\n    logAudit(params: {\n        action: string;\n        userId?: string;\n        resourceType?: string;\n        resourceId?: string;\n        details?: any;\n        ipAddress?: string;\n        userAgent?: string;\n    }) {\n        const stmt = this.db.prepare(`\n            INSERT INTO audit_logs \n            (action, user_id, resource_type, resource_id, details, ip_address, user_agent)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n        `);\n        return stmt.run(\n            params.action, params.userId, params.resourceType, params.resourceId,\n            JSON.stringify(params.details || {}), params.ipAddress, params.userAgent\n        );\n    }\n\n    getAuditLogs(limit: number = 100) {\n        const stmt = this.db.prepare(`\n            SELECT * FROM audit_logs ORDER BY timestamp DESC LIMIT ?\n        `);\n        return stmt.all(limit);\n    }\n\n    // ===== ÌÜµÍ≥Ñ =====\n\n    getStats() {\n        const tables = ['users', 'conversation_sessions', 'conversation_messages',\n            'api_usage', 'agent_usage_logs', 'agent_feedback',\n            'custom_agents', 'audit_logs', 'alert_history'];\n\n        const stats: Record<string, number> = {};\n\n        for (const table of tables) {\n            const stmt = this.db.prepare(`SELECT COUNT(*) as count FROM ${table}`);\n            const result = stmt.get() as { count: number };\n            stats[table] = result.count;\n        }\n\n        return stats;\n    }\n\n    // ============================================\n    // üß† Ïû•Í∏∞ Î©îÎ™®Î¶¨ ÏãúÏä§ÌÖú Î©îÏÑúÎìú\n    // ============================================\n\n    createMemory(params: {\n        id: string;\n        userId: string;\n        category: MemoryCategory;\n        key: string;\n        value: string;\n        importance?: number;\n        sourceSessionId?: string;\n        tags?: string[];\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO user_memories (id, user_id, category, key, value, importance, source_session_id)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n            ON CONFLICT(user_id, category, key) DO UPDATE SET\n                value = excluded.value,\n                importance = CASE WHEN excluded.importance > importance THEN excluded.importance ELSE importance END,\n                updated_at = CURRENT_TIMESTAMP,\n                access_count = access_count + 1\n        `);\n        stmt.run(\n            params.id, params.userId, params.category,\n            params.key, params.value, params.importance || 0.5,\n            params.sourceSessionId\n        );\n\n        // ÌÉúÍ∑∏ Ï†ÄÏû•\n        if (params.tags && params.tags.length > 0) {\n            const tagStmt = this.db.prepare(`\n                INSERT OR IGNORE INTO memory_tags (memory_id, tag) VALUES (?, ?)\n            `);\n            for (const tag of params.tags) {\n                tagStmt.run(params.id, tag);\n            }\n        }\n    }\n\n    getUserMemories(userId: string, options?: {\n        category?: MemoryCategory;\n        limit?: number;\n        minImportance?: number;\n    }): UserMemory[] {\n        let query = 'SELECT * FROM user_memories WHERE user_id = ?';\n        const params: any[] = [userId];\n\n        if (options?.category) {\n            query += ' AND category = ?';\n            params.push(options.category);\n        }\n        if (options?.minImportance) {\n            query += ' AND importance >= ?';\n            params.push(options.minImportance);\n        }\n\n        query += ' ORDER BY importance DESC, updated_at DESC';\n\n        if (options?.limit) {\n            query += ' LIMIT ?';\n            params.push(options.limit);\n        }\n\n        const stmt = this.db.prepare(query);\n        return stmt.all(...params) as UserMemory[];\n    }\n\n    getRelevantMemories(userId: string, query: string, limit: number = 10): UserMemory[] {\n        // Í∞ÑÎã®Ìïú ÌÇ§ÏõåÎìú Í∏∞Î∞ò Í≤ÄÏÉâ (ÎÇòÏ§ëÏóê Î≤°ÌÑ∞ Í≤ÄÏÉâÏúºÎ°ú ÏóÖÍ∑∏Î†àÏù¥Îìú Í∞ÄÎä•)\n        const keywords = query.toLowerCase().split(/\\s+/).filter(w => w.length > 2);\n        \n        if (keywords.length === 0) {\n            return this.getUserMemories(userId, { limit });\n        }\n\n        // ÌÇ§ÏõåÎìú Îß§Ïπ≠ ÏøºÎ¶¨\n        const conditions = keywords.map(() => '(LOWER(key) LIKE ? OR LOWER(value) LIKE ?)').join(' OR ');\n        const params: any[] = [userId];\n        for (const kw of keywords) {\n            params.push(`%${kw}%`, `%${kw}%`);\n        }\n        params.push(limit);\n\n        const stmt = this.db.prepare(`\n            SELECT * FROM user_memories \n            WHERE user_id = ? AND (${conditions})\n            ORDER BY importance DESC, updated_at DESC\n            LIMIT ?\n        `);\n\n        // access_count ÏóÖÎç∞Ïù¥Ìä∏\n        const result = stmt.all(...params) as UserMemory[];\n        if (result.length > 0) {\n            const ids = result.map(m => `'${m.id}'`).join(',');\n            this.db.exec(`\n                UPDATE user_memories \n                SET access_count = access_count + 1, last_accessed = CURRENT_TIMESTAMP \n                WHERE id IN (${ids})\n            `);\n        }\n\n        return result;\n    }\n\n    updateMemory(memoryId: string, updates: { value?: string; importance?: number }): void {\n        const sets: string[] = ['updated_at = CURRENT_TIMESTAMP'];\n        const params: any[] = [];\n\n        if (updates.value !== undefined) {\n            sets.push('value = ?');\n            params.push(updates.value);\n        }\n        if (updates.importance !== undefined) {\n            sets.push('importance = ?');\n            params.push(updates.importance);\n        }\n\n        params.push(memoryId);\n        const stmt = this.db.prepare(`UPDATE user_memories SET ${sets.join(', ')} WHERE id = ?`);\n        stmt.run(...params);\n    }\n\n    deleteMemory(memoryId: string): void {\n        const stmt = this.db.prepare('DELETE FROM user_memories WHERE id = ?');\n        stmt.run(memoryId);\n    }\n\n    deleteUserMemories(userId: string): void {\n        const stmt = this.db.prepare('DELETE FROM user_memories WHERE user_id = ?');\n        stmt.run(userId);\n    }\n\n    // ============================================\n    // üîç Deep Research Î©îÏÑúÎìú\n    // ============================================\n\n    createResearchSession(params: {\n        id: string;\n        userId?: string;\n        topic: string;\n        depth?: ResearchDepth;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO research_sessions (id, user_id, topic, depth)\n            VALUES (?, ?, ?, ?)\n        `);\n        stmt.run(params.id, params.userId, params.topic, params.depth || 'standard');\n    }\n\n    getResearchSession(sessionId: string): ResearchSession | undefined {\n        const stmt = this.db.prepare('SELECT * FROM research_sessions WHERE id = ?');\n        const row = stmt.get(sessionId) as any;\n        if (!row) return undefined;\n\n        return {\n            ...row,\n            key_findings: row.key_findings ? JSON.parse(row.key_findings) : [],\n            sources: row.sources ? JSON.parse(row.sources) : []\n        };\n    }\n\n    updateResearchSession(sessionId: string, updates: {\n        status?: ResearchStatus;\n        progress?: number;\n        summary?: string;\n        keyFindings?: string[];\n        sources?: string[];\n    }): void {\n        const sets: string[] = ['updated_at = CURRENT_TIMESTAMP'];\n        const params: any[] = [];\n\n        if (updates.status) {\n            sets.push('status = ?');\n            params.push(updates.status);\n            if (updates.status === 'completed' || updates.status === 'failed') {\n                sets.push('completed_at = CURRENT_TIMESTAMP');\n            }\n        }\n        if (updates.progress !== undefined) {\n            sets.push('progress = ?');\n            params.push(updates.progress);\n        }\n        if (updates.summary !== undefined) {\n            sets.push('summary = ?');\n            params.push(updates.summary);\n        }\n        if (updates.keyFindings) {\n            sets.push('key_findings = ?');\n            params.push(JSON.stringify(updates.keyFindings));\n        }\n        if (updates.sources) {\n            sets.push('sources = ?');\n            params.push(JSON.stringify(updates.sources));\n        }\n\n        params.push(sessionId);\n        const stmt = this.db.prepare(`UPDATE research_sessions SET ${sets.join(', ')} WHERE id = ?`);\n        stmt.run(...params);\n    }\n\n    addResearchStep(params: {\n        sessionId: string;\n        stepNumber: number;\n        stepType: string;\n        query?: string;\n        result?: string;\n        sources?: string[];\n        status?: string;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO research_steps (session_id, step_number, step_type, query, result, sources, status)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n        `);\n        stmt.run(\n            params.sessionId, params.stepNumber, params.stepType,\n            params.query, params.result,\n            params.sources ? JSON.stringify(params.sources) : null,\n            params.status || 'pending'\n        );\n    }\n\n    getResearchSteps(sessionId: string): ResearchStep[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM research_steps WHERE session_id = ? ORDER BY step_number ASC\n        `);\n        return (stmt.all(sessionId) as any[]).map(row => ({\n            ...row,\n            sources: row.sources ? JSON.parse(row.sources) : []\n        }));\n    }\n\n    getUserResearchSessions(userId: string, limit: number = 20): ResearchSession[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM research_sessions \n            WHERE user_id = ? \n            ORDER BY created_at DESC \n            LIMIT ?\n        `);\n        return (stmt.all(userId, limit) as any[]).map(row => ({\n            ...row,\n            key_findings: row.key_findings ? JSON.parse(row.key_findings) : [],\n            sources: row.sources ? JSON.parse(row.sources) : []\n        }));\n    }\n\n    // ============================================\n    // üè™ ÎßàÏºìÌîåÎ†àÏù¥Ïä§ Î©îÏÑúÎìú\n    // ============================================\n\n    publishToMarketplace(params: {\n        id: string;\n        agentId: string;\n        authorId: string;\n        title: string;\n        description?: string;\n        longDescription?: string;\n        category?: string;\n        tags?: string[];\n        icon?: string;\n        price?: number;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO agent_marketplace \n            (id, agent_id, author_id, title, description, long_description, category, tags, icon, price, is_free)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n        `);\n        stmt.run(\n            params.id, params.agentId, params.authorId, params.title,\n            params.description, params.longDescription, params.category,\n            params.tags ? JSON.stringify(params.tags) : null,\n            params.icon || 'ü§ñ',\n            params.price || 0,\n            (params.price || 0) === 0 ? 1 : 0\n        );\n    }\n\n    getMarketplaceAgents(options?: {\n        category?: string;\n        status?: MarketplaceStatus;\n        featured?: boolean;\n        search?: string;\n        limit?: number;\n        offset?: number;\n    }): MarketplaceAgent[] {\n        let query = 'SELECT * FROM agent_marketplace WHERE 1=1';\n        const params: any[] = [];\n\n        if (options?.status) {\n            query += ' AND status = ?';\n            params.push(options.status);\n        } else {\n            query += ' AND status = ?';\n            params.push('approved');\n        }\n\n        if (options?.category) {\n            query += ' AND category = ?';\n            params.push(options.category);\n        }\n        if (options?.featured) {\n            query += ' AND is_featured = 1';\n        }\n        if (options?.search) {\n            query += ' AND (LOWER(title) LIKE ? OR LOWER(description) LIKE ?)';\n            params.push(`%${options.search.toLowerCase()}%`, `%${options.search.toLowerCase()}%`);\n        }\n\n        query += ' ORDER BY is_featured DESC, downloads DESC, rating_avg DESC';\n\n        if (options?.limit) {\n            query += ' LIMIT ?';\n            params.push(options.limit);\n        }\n        if (options?.offset) {\n            query += ' OFFSET ?';\n            params.push(options.offset);\n        }\n\n        const stmt = this.db.prepare(query);\n        return (stmt.all(...params) as any[]).map(row => ({\n            ...row,\n            tags: row.tags ? JSON.parse(row.tags) : [],\n            is_free: !!row.is_free,\n            is_featured: !!row.is_featured,\n            is_verified: !!row.is_verified\n        }));\n    }\n\n    getMarketplaceAgent(marketplaceId: string): MarketplaceAgent | undefined {\n        const stmt = this.db.prepare('SELECT * FROM agent_marketplace WHERE id = ?');\n        const row = stmt.get(marketplaceId) as any;\n        if (!row) return undefined;\n\n        return {\n            ...row,\n            tags: row.tags ? JSON.parse(row.tags) : [],\n            is_free: !!row.is_free,\n            is_featured: !!row.is_featured,\n            is_verified: !!row.is_verified\n        };\n    }\n\n    updateMarketplaceStatus(marketplaceId: string, status: MarketplaceStatus): void {\n        const stmt = this.db.prepare(`\n            UPDATE agent_marketplace \n            SET status = ?, updated_at = CURRENT_TIMESTAMP,\n                published_at = CASE WHEN ? = 'approved' THEN CURRENT_TIMESTAMP ELSE published_at END\n            WHERE id = ?\n        `);\n        stmt.run(status, status, marketplaceId);\n    }\n\n    installAgent(marketplaceId: string, userId: string): void {\n        const stmt = this.db.prepare(`\n            INSERT OR IGNORE INTO agent_installations (marketplace_id, user_id)\n            VALUES (?, ?)\n        `);\n        const result = stmt.run(marketplaceId, userId);\n\n        if (result.changes > 0) {\n            this.db.prepare('UPDATE agent_marketplace SET downloads = downloads + 1 WHERE id = ?')\n                .run(marketplaceId);\n        }\n    }\n\n    uninstallAgent(marketplaceId: string, userId: string): void {\n        const stmt = this.db.prepare('DELETE FROM agent_installations WHERE marketplace_id = ? AND user_id = ?');\n        stmt.run(marketplaceId, userId);\n    }\n\n    getUserInstalledAgents(userId: string): MarketplaceAgent[] {\n        const stmt = this.db.prepare(`\n            SELECT m.* FROM agent_marketplace m\n            JOIN agent_installations i ON m.id = i.marketplace_id\n            WHERE i.user_id = ?\n            ORDER BY i.installed_at DESC\n        `);\n        return (stmt.all(userId) as any[]).map(row => ({\n            ...row,\n            tags: row.tags ? JSON.parse(row.tags) : [],\n            is_free: !!row.is_free,\n            is_featured: !!row.is_featured,\n            is_verified: !!row.is_verified\n        }));\n    }\n\n    addAgentReview(params: {\n        id: string;\n        marketplaceId: string;\n        userId: string;\n        rating: number;\n        title?: string;\n        content?: string;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO agent_reviews (id, marketplace_id, user_id, rating, title, content)\n            VALUES (?, ?, ?, ?, ?, ?)\n            ON CONFLICT(marketplace_id, user_id) DO UPDATE SET\n                rating = excluded.rating,\n                title = excluded.title,\n                content = excluded.content\n        `);\n        stmt.run(params.id, params.marketplaceId, params.userId, params.rating, params.title, params.content);\n\n        // ÌèâÍ∑† ÌèâÏ†ê ÏóÖÎç∞Ïù¥Ìä∏\n        this.db.prepare(`\n            UPDATE agent_marketplace SET\n                rating_avg = (SELECT AVG(rating) FROM agent_reviews WHERE marketplace_id = ?),\n                rating_count = (SELECT COUNT(*) FROM agent_reviews WHERE marketplace_id = ?)\n            WHERE id = ?\n        `).run(params.marketplaceId, params.marketplaceId, params.marketplaceId);\n    }\n\n    getAgentReviews(marketplaceId: string, limit: number = 20): AgentReview[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM agent_reviews \n            WHERE marketplace_id = ? \n            ORDER BY created_at DESC \n            LIMIT ?\n        `);\n        return stmt.all(marketplaceId, limit) as AgentReview[];\n    }\n\n    // ============================================\n    // üìù Canvas Î©îÏÑúÎìú\n    // ============================================\n\n    createCanvasDocument(params: {\n        id: string;\n        userId: string;\n        sessionId?: string;\n        title: string;\n        docType?: CanvasDocType;\n        content?: string;\n        language?: string;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO canvas_documents (id, user_id, session_id, title, doc_type, content, language)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n        `);\n        stmt.run(\n            params.id, params.userId, params.sessionId,\n            params.title, params.docType || 'document',\n            params.content, params.language\n        );\n    }\n\n    getCanvasDocument(documentId: string): CanvasDocument | undefined {\n        const stmt = this.db.prepare('SELECT * FROM canvas_documents WHERE id = ?');\n        const row = stmt.get(documentId) as any;\n        if (!row) return undefined;\n\n        return {\n            ...row,\n            is_shared: !!row.is_shared\n        };\n    }\n\n    updateCanvasDocument(documentId: string, updates: {\n        title?: string;\n        content?: string;\n        changeSummary?: string;\n        updatedBy?: string;\n    }): void {\n        // Î≤ÑÏ†Ñ ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•\n        const current = this.getCanvasDocument(documentId);\n        if (current && updates.content !== undefined && updates.content !== current.content) {\n            const versionStmt = this.db.prepare(`\n                INSERT INTO canvas_versions (document_id, version, content, change_summary, created_by)\n                VALUES (?, ?, ?, ?, ?)\n            `);\n            versionStmt.run(\n                documentId, current.version, current.content || '',\n                updates.changeSummary || 'Auto-saved version',\n                updates.updatedBy\n            );\n        }\n\n        const sets: string[] = ['updated_at = CURRENT_TIMESTAMP'];\n        const params: any[] = [];\n\n        if (updates.title !== undefined) {\n            sets.push('title = ?');\n            params.push(updates.title);\n        }\n        if (updates.content !== undefined) {\n            sets.push('content = ?');\n            sets.push('version = version + 1');\n            params.push(updates.content);\n        }\n\n        params.push(documentId);\n        const stmt = this.db.prepare(`UPDATE canvas_documents SET ${sets.join(', ')} WHERE id = ?`);\n        stmt.run(...params);\n    }\n\n    getCanvasVersions(documentId: string): CanvasVersion[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM canvas_versions \n            WHERE document_id = ? \n            ORDER BY version DESC\n        `);\n        return stmt.all(documentId) as CanvasVersion[];\n    }\n\n    getUserCanvasDocuments(userId: string, limit: number = 50): CanvasDocument[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM canvas_documents \n            WHERE user_id = ? \n            ORDER BY updated_at DESC \n            LIMIT ?\n        `);\n        return (stmt.all(userId, limit) as any[]).map(row => ({\n            ...row,\n            is_shared: !!row.is_shared\n        }));\n    }\n\n    shareCanvasDocument(documentId: string, shareToken: string): void {\n        const stmt = this.db.prepare(`\n            UPDATE canvas_documents \n            SET is_shared = 1, share_token = ?, updated_at = CURRENT_TIMESTAMP \n            WHERE id = ?\n        `);\n        stmt.run(shareToken, documentId);\n    }\n\n    getCanvasDocumentByShareToken(shareToken: string): CanvasDocument | undefined {\n        const stmt = this.db.prepare('SELECT * FROM canvas_documents WHERE share_token = ? AND is_shared = 1');\n        const row = stmt.get(shareToken) as any;\n        if (!row) return undefined;\n\n        return {\n            ...row,\n            is_shared: !!row.is_shared\n        };\n    }\n\n    deleteCanvasDocument(documentId: string): void {\n        const stmt = this.db.prepare('DELETE FROM canvas_documents WHERE id = ?');\n        stmt.run(documentId);\n    }\n\n    // ============================================\n    // üîó Ïô∏Î∂Ä ÏÑúÎπÑÏä§ ÌÜµÌï© Î©îÏÑúÎìú\n    // ============================================\n\n    createExternalConnection(params: {\n        id: string;\n        userId: string;\n        serviceType: ExternalServiceType;\n        accessToken?: string;\n        refreshToken?: string;\n        tokenExpiresAt?: string;\n        accountEmail?: string;\n        accountName?: string;\n        metadata?: Record<string, any>;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO external_connections \n            (id, user_id, service_type, access_token, refresh_token, token_expires_at, account_email, account_name, metadata)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n            ON CONFLICT(user_id, service_type) DO UPDATE SET\n                access_token = excluded.access_token,\n                refresh_token = excluded.refresh_token,\n                token_expires_at = excluded.token_expires_at,\n                account_email = excluded.account_email,\n                account_name = excluded.account_name,\n                metadata = excluded.metadata,\n                is_active = 1,\n                updated_at = CURRENT_TIMESTAMP\n        `);\n        stmt.run(\n            params.id, params.userId, params.serviceType,\n            params.accessToken, params.refreshToken, params.tokenExpiresAt,\n            params.accountEmail, params.accountName,\n            params.metadata ? JSON.stringify(params.metadata) : null\n        );\n    }\n\n    getUserConnections(userId: string): ExternalConnection[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM external_connections \n            WHERE user_id = ? AND is_active = 1\n            ORDER BY created_at DESC\n        `);\n        return (stmt.all(userId) as any[]).map(row => ({\n            ...row,\n            is_active: !!row.is_active,\n            metadata: row.metadata ? JSON.parse(row.metadata) : {}\n        }));\n    }\n\n    getExternalConnection(connectionId: string): ExternalConnection | undefined {\n        const stmt = this.db.prepare('SELECT * FROM external_connections WHERE id = ?');\n        const row = stmt.get(connectionId) as any;\n        if (!row) return undefined;\n\n        return {\n            ...row,\n            is_active: !!row.is_active,\n            metadata: row.metadata ? JSON.parse(row.metadata) : {}\n        };\n    }\n\n    getUserConnectionByService(userId: string, serviceType: ExternalServiceType): ExternalConnection | undefined {\n        const stmt = this.db.prepare('SELECT * FROM external_connections WHERE user_id = ? AND service_type = ? AND is_active = 1');\n        const row = stmt.get(userId, serviceType) as any;\n        if (!row) return undefined;\n\n        return {\n            ...row,\n            is_active: !!row.is_active,\n            metadata: row.metadata ? JSON.parse(row.metadata) : {}\n        };\n    }\n\n    updateConnectionTokens(connectionId: string, tokens: {\n        accessToken: string;\n        refreshToken?: string;\n        expiresAt?: string;\n    }): void {\n        const stmt = this.db.prepare(`\n            UPDATE external_connections \n            SET access_token = ?, refresh_token = COALESCE(?, refresh_token), token_expires_at = ?, updated_at = CURRENT_TIMESTAMP\n            WHERE id = ?\n        `);\n        stmt.run(tokens.accessToken, tokens.refreshToken, tokens.expiresAt, connectionId);\n    }\n\n    disconnectService(userId: string, serviceType: ExternalServiceType): void {\n        const stmt = this.db.prepare(`\n            UPDATE external_connections \n            SET is_active = 0, access_token = NULL, refresh_token = NULL, updated_at = CURRENT_TIMESTAMP\n            WHERE user_id = ? AND service_type = ?\n        `);\n        stmt.run(userId, serviceType);\n    }\n\n    // Ïô∏Î∂Ä ÌååÏùº Ï∫êÏãú\n    cacheExternalFile(params: {\n        id: string;\n        connectionId: string;\n        externalId: string;\n        fileName: string;\n        fileType?: string;\n        fileSize?: number;\n        webUrl?: string;\n        cachedContent?: string;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO external_files \n            (id, connection_id, external_id, file_name, file_type, file_size, web_url, cached_content, last_synced)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)\n            ON CONFLICT(connection_id, external_id) DO UPDATE SET\n                file_name = excluded.file_name,\n                file_type = excluded.file_type,\n                file_size = excluded.file_size,\n                web_url = excluded.web_url,\n                cached_content = excluded.cached_content,\n                last_synced = CURRENT_TIMESTAMP\n        `);\n        stmt.run(\n            params.id, params.connectionId, params.externalId,\n            params.fileName, params.fileType, params.fileSize,\n            params.webUrl, params.cachedContent\n        );\n    }\n\n    getConnectionFiles(connectionId: string, limit: number = 100): ExternalFile[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM external_files \n            WHERE connection_id = ? \n            ORDER BY last_synced DESC \n            LIMIT ?\n        `);\n        return stmt.all(connectionId, limit) as ExternalFile[];\n    }\n\n    getCachedFile(connectionId: string, externalId: string): ExternalFile | undefined {\n        const stmt = this.db.prepare('SELECT * FROM external_files WHERE connection_id = ? AND external_id = ?');\n        return stmt.get(connectionId, externalId) as ExternalFile | undefined;\n    }\n\n    // ===== Ïú†Ìã∏Î¶¨Ìã∞ =====\n\n    close(): void {\n        this.db.close();\n        console.log('[UnifiedDB] Ïó∞Í≤∞ Ï¢ÖÎ£å');\n    }\n}\n\n// Ïã±Í∏ÄÌÜ§ Ïù∏Ïä§ÌÑ¥Ïä§\nlet dbInstance: UnifiedDatabase | null = null;\n\nexport function getUnifiedDatabase(dataDir?: string): UnifiedDatabase {\n    if (!dbInstance) {\n        dbInstance = new UnifiedDatabase(dataDir);\n    }\n    return dbInstance;\n}\n\nexport function closeDatabase(): void {\n    if (dbInstance) {\n        dbInstance.close();\n        dbInstance = null;\n    }\n}\n"],"version":3}