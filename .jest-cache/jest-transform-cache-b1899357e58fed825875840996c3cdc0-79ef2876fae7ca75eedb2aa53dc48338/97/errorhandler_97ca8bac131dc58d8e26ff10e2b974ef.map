{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/utils/error-handler.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/utils/error-handler.ts"],"sourcesContent":["/**\n * Unified Error Handler\n * Standardized error handling across all routes\n * \n * #24 연동: api-response 표준 형식 사용\n */\n\nimport { Request, Response, NextFunction } from 'express';\nimport { createLogger } from './logger';\nimport { error as apiError, badRequest as apiBadRequest, ErrorCodes, ApiErrorResponse } from './api-response';\nimport { QuotaExceededError } from '../errors/quota-exceeded.error';\n\nconst logger = createLogger('ErrorHandler');\n\n/**\n * Base application error class\n */\nexport class AppError extends Error {\n    public readonly statusCode: number;\n    public readonly isOperational: boolean;\n    public readonly code?: string;\n\n    constructor(\n        message: string,\n        statusCode: number = 500,\n        isOperational: boolean = true,\n        code?: string\n    ) {\n        super(message);\n        this.statusCode = statusCode;\n        this.isOperational = isOperational;\n        this.code = code;\n        \n        Object.setPrototypeOf(this, new.target.prototype);\n        Error.captureStackTrace(this, this.constructor);\n    }\n}\n\n/**\n * Validation error (400)\n */\nexport class ValidationError extends AppError {\n    constructor(message: string) {\n        super(message, 400, true, 'VALIDATION_ERROR');\n    }\n}\n\n/**\n * Authentication error (401)\n */\nexport class AuthenticationError extends AppError {\n    constructor(message: string = '인증이 필요합니다') {\n        super(message, 401, true, 'AUTHENTICATION_ERROR');\n    }\n}\n\n/**\n * Authorization error (403)\n */\nexport class AuthorizationError extends AppError {\n    constructor(message: string = '권한이 없습니다') {\n        super(message, 403, true, 'AUTHORIZATION_ERROR');\n    }\n}\n\n/**\n * Not found error (404)\n */\nexport class NotFoundError extends AppError {\n    constructor(message: string = '리소스를 찾을 수 없습니다') {\n        super(message, 404, true, 'NOT_FOUND');\n    }\n}\n\n/**\n * Rate limit error (429)\n */\nexport class RateLimitError extends AppError {\n    constructor(message: string = '요청 제한을 초과했습니다') {\n        super(message, 429, true, 'RATE_LIMIT_EXCEEDED');\n    }\n}\n\n/**\n * Database error (500)\n */\nexport class DatabaseError extends AppError {\n    constructor(message: string = '데이터베이스 오류가 발생했습니다') {\n        super(message, 500, true, 'DATABASE_ERROR');\n    }\n}\n\n/**\n * Standard error response interface\n * @deprecated Use ApiErrorResponse from api-response.ts instead\n */\nexport interface ErrorResponse {\n    success: false;\n    error: string;\n    code?: string;\n    details?: string[];\n    timestamp: string;\n    stack?: string;\n}\n\n/**\n * Format error for response (#24 연동: 표준 ApiErrorResponse 형식)\n */\nfunction formatError(err: Error, includeStack: boolean): ApiErrorResponse & { stack?: string } {\n    const code = err instanceof AppError && err.code \n        ? err.code \n        : ErrorCodes.INTERNAL_ERROR;\n    \n    const response = apiError(code, err.message);\n    \n    if (includeStack && err.stack) {\n        return { ...response, stack: err.stack };\n    }\n\n    return response;\n}\n\n/**\n * Global error handler middleware\n * Must be registered LAST after all routes\n * \n * ⚙️ Phase 3 통합 2026-02-07:\n *   - MulterError (파일 업로드) 처리 통합\n *   - QuotaExceededError (API 할당량) 처리 통합\n *   - server.ts 인라인 핸들러 + middlewares/index.ts globalErrorHandler 제거 → 이 함수로 단일화\n * \n * #24 연동: 표준 API 응답 형식 적용\n */\nexport function errorHandler(\n    err: Error & { code?: string; status?: number; name?: string },\n    req: Request,\n    res: Response,\n    _next: NextFunction\n): void {\n    // ── QuotaExceededError → 429 ──\n    if (err instanceof QuotaExceededError) {\n        logger.warn(`Quota exceeded: ${err.message}`, { path: req.path });\n        res.set('Retry-After', String(err.retryAfterSeconds));\n        res.status(429).json(apiError(ErrorCodes.RATE_LIMITED, err.message, {\n            quotaType: err.quotaType,\n            used: err.used,\n            limit: err.limit,\n            retryAfter: err.retryAfterSeconds,\n        }));\n        return;\n    }\n\n    // ── Multer: 파일 크기 초과 → 413 ──\n    if (err.code === 'LIMIT_FILE_SIZE') {\n        logger.warn(`File size limit exceeded: ${req.path}`);\n        res.status(413).json(apiError(ErrorCodes.PAYLOAD_TOO_LARGE, '파일 크기가 너무 큽니다 (최대 100MB)'));\n        return;\n    }\n\n    // ── Multer: 기타 업로드 오류 → 400 ──\n    if (err.name === 'MulterError') {\n        logger.warn(`Multer error: ${err.message}`, { path: req.path });\n        res.status(400).json(apiBadRequest(`업로드 오류: ${err.message}`));\n        return;\n    }\n\n    // ── AppError (커스텀 에러 계층) ──\n    if (err instanceof AppError) {\n        logger.error(`[${req.method}] ${req.path}: ${err.message}`, {\n            stack: err.stack,\n            code: err.code,\n        });\n        // NOTE: Use process.env.NODE_ENV directly (not getConfig()) because\n        // NODE_ENV can change at runtime in test environments\n        const includeStack = process.env.NODE_ENV === 'development';\n        res.status(err.statusCode).json(formatError(err, includeStack));\n        return;\n    }\n\n    // ── 기타 알 수 없는 에러 → 500 ──\n    logger.error(`[${req.method}] ${req.path}: ${err.message}`, {\n        stack: err.stack,\n        body: req.body,\n        query: req.query\n    });\n\n    const statusCode = err.status || 500;\n    // NOTE: Use process.env.NODE_ENV directly (not getConfig()) because\n    // NODE_ENV can change at runtime in test environments\n    const includeStack = process.env.NODE_ENV === 'development';\n    res.status(statusCode).json(formatError(err, includeStack));\n}\n\n/**\n * Async handler wrapper to catch async errors\n * Wraps async route handlers to forward errors to error middleware\n */\nexport function asyncHandler(\n    fn: (req: Request, res: Response, next: NextFunction) => Promise<unknown>\n) {\n    return (req: Request, res: Response, next: NextFunction): void => {\n        Promise.resolve(fn(req, res, next)).catch(next);\n    };\n}\n\n/**\n * Not found handler for undefined routes\n */\nexport function notFoundHandler(req: Request, res: Response, next: NextFunction): void {\n    next(new NotFoundError(`Route not found: ${req.method} ${req.path}`));\n}\n"],"version":3}