3625864c6bb6af7f5b0998465185f3dd
"use strict";
/**
 * Unified Error Handler
 * Standardized error handling across all routes
 *
 * #24 연동: api-response 표준 형식 사용
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.DatabaseError = exports.RateLimitError = exports.NotFoundError = exports.AuthorizationError = exports.AuthenticationError = exports.ValidationError = exports.AppError = void 0;
exports.errorHandler = errorHandler;
exports.asyncHandler = asyncHandler;
exports.notFoundHandler = notFoundHandler;
const logger_1 = require("./logger");
const api_response_1 = require("./api-response");
const quota_exceeded_error_1 = require("../errors/quota-exceeded.error");
const logger = (0, logger_1.createLogger)('ErrorHandler');
/**
 * Base application error class
 */
class AppError extends Error {
    constructor(message, statusCode = 500, isOperational = true, code) {
        super(message);
        this.statusCode = statusCode;
        this.isOperational = isOperational;
        this.code = code;
        Object.setPrototypeOf(this, new.target.prototype);
        Error.captureStackTrace(this, this.constructor);
    }
}
exports.AppError = AppError;
/**
 * Validation error (400)
 */
class ValidationError extends AppError {
    constructor(message) {
        super(message, 400, true, 'VALIDATION_ERROR');
    }
}
exports.ValidationError = ValidationError;
/**
 * Authentication error (401)
 */
class AuthenticationError extends AppError {
    constructor(message = '인증이 필요합니다') {
        super(message, 401, true, 'AUTHENTICATION_ERROR');
    }
}
exports.AuthenticationError = AuthenticationError;
/**
 * Authorization error (403)
 */
class AuthorizationError extends AppError {
    constructor(message = '권한이 없습니다') {
        super(message, 403, true, 'AUTHORIZATION_ERROR');
    }
}
exports.AuthorizationError = AuthorizationError;
/**
 * Not found error (404)
 */
class NotFoundError extends AppError {
    constructor(message = '리소스를 찾을 수 없습니다') {
        super(message, 404, true, 'NOT_FOUND');
    }
}
exports.NotFoundError = NotFoundError;
/**
 * Rate limit error (429)
 */
class RateLimitError extends AppError {
    constructor(message = '요청 제한을 초과했습니다') {
        super(message, 429, true, 'RATE_LIMIT_EXCEEDED');
    }
}
exports.RateLimitError = RateLimitError;
/**
 * Database error (500)
 */
class DatabaseError extends AppError {
    constructor(message = '데이터베이스 오류가 발생했습니다') {
        super(message, 500, true, 'DATABASE_ERROR');
    }
}
exports.DatabaseError = DatabaseError;
/**
 * Format error for response (#24 연동: 표준 ApiErrorResponse 형식)
 */
function formatError(err, includeStack) {
    const code = err instanceof AppError && err.code
        ? err.code
        : api_response_1.ErrorCodes.INTERNAL_ERROR;
    const response = (0, api_response_1.error)(code, err.message);
    if (includeStack && err.stack) {
        return Object.assign(Object.assign({}, response), { stack: err.stack });
    }
    return response;
}
/**
 * Global error handler middleware
 * Must be registered LAST after all routes
 *
 * ⚙️ Phase 3 통합 2026-02-07:
 *   - MulterError (파일 업로드) 처리 통합
 *   - QuotaExceededError (API 할당량) 처리 통합
 *   - server.ts 인라인 핸들러 + middlewares/index.ts globalErrorHandler 제거 → 이 함수로 단일화
 *
 * #24 연동: 표준 API 응답 형식 적용
 */
function errorHandler(err, req, res, _next) {
    // ── QuotaExceededError → 429 ──
    if (err instanceof quota_exceeded_error_1.QuotaExceededError) {
        logger.warn(`Quota exceeded: ${err.message}`, { path: req.path });
        res.set('Retry-After', String(err.retryAfterSeconds));
        res.status(429).json((0, api_response_1.error)(api_response_1.ErrorCodes.RATE_LIMITED, err.message, {
            quotaType: err.quotaType,
            used: err.used,
            limit: err.limit,
            retryAfter: err.retryAfterSeconds,
        }));
        return;
    }
    // ── Multer: 파일 크기 초과 → 413 ──
    if (err.code === 'LIMIT_FILE_SIZE') {
        logger.warn(`File size limit exceeded: ${req.path}`);
        res.status(413).json((0, api_response_1.error)(api_response_1.ErrorCodes.PAYLOAD_TOO_LARGE, '파일 크기가 너무 큽니다 (최대 100MB)'));
        return;
    }
    // ── Multer: 기타 업로드 오류 → 400 ──
    if (err.name === 'MulterError') {
        logger.warn(`Multer error: ${err.message}`, { path: req.path });
        res.status(400).json((0, api_response_1.badRequest)(`업로드 오류: ${err.message}`));
        return;
    }
    // ── AppError (커스텀 에러 계층) ──
    if (err instanceof AppError) {
        logger.error(`[${req.method}] ${req.path}: ${err.message}`, {
            stack: err.stack,
            code: err.code,
        });
        // NOTE: Use process.env.NODE_ENV directly (not getConfig()) because
        // NODE_ENV can change at runtime in test environments
        const includeStack = process.env.NODE_ENV === 'development';
        res.status(err.statusCode).json(formatError(err, includeStack));
        return;
    }
    // ── 기타 알 수 없는 에러 → 500 ──
    logger.error(`[${req.method}] ${req.path}: ${err.message}`, {
        stack: err.stack,
        body: req.body,
        query: req.query
    });
    const statusCode = err.status || 500;
    // NOTE: Use process.env.NODE_ENV directly (not getConfig()) because
    // NODE_ENV can change at runtime in test environments
    const includeStack = process.env.NODE_ENV === 'development';
    res.status(statusCode).json(formatError(err, includeStack));
}
/**
 * Async handler wrapper to catch async errors
 * Wraps async route handlers to forward errors to error middleware
 */
function asyncHandler(fn) {
    return (req, res, next) => {
        Promise.resolve(fn(req, res, next)).catch(next);
    };
}
/**
 * Not found handler for undefined routes
 */
function notFoundHandler(req, res, next) {
    next(new NotFoundError(`Route not found: ${req.method} ${req.path}`));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL3V0aWxzL2Vycm9yLWhhbmRsZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7QUFnSUgsb0NBMERDO0FBTUQsb0NBTUM7QUFLRCwwQ0FFQztBQTFNRCxxQ0FBd0M7QUFDeEMsaURBQThHO0FBQzlHLHlFQUFvRTtBQUVwRSxNQUFNLE1BQU0sR0FBRyxJQUFBLHFCQUFZLEVBQUMsY0FBYyxDQUFDLENBQUM7QUFFNUM7O0dBRUc7QUFDSCxNQUFhLFFBQVMsU0FBUSxLQUFLO0lBSy9CLFlBQ0ksT0FBZSxFQUNmLGFBQXFCLEdBQUcsRUFDeEIsZ0JBQXlCLElBQUksRUFDN0IsSUFBYTtRQUViLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNmLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDO1FBQ25DLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWpCLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbEQsS0FBSyxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDcEQsQ0FBQztDQUNKO0FBbkJELDRCQW1CQztBQUVEOztHQUVHO0FBQ0gsTUFBYSxlQUFnQixTQUFRLFFBQVE7SUFDekMsWUFBWSxPQUFlO1FBQ3ZCLEtBQUssQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO0lBQ2xELENBQUM7Q0FDSjtBQUpELDBDQUlDO0FBRUQ7O0dBRUc7QUFDSCxNQUFhLG1CQUFvQixTQUFRLFFBQVE7SUFDN0MsWUFBWSxVQUFrQixXQUFXO1FBQ3JDLEtBQUssQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0lB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SztRQUNoQixJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUk7UUFDZCxLQUFLLEVBQUUsR0FBRyxDQUFDLEtBQUs7S0FDbkIsQ0FBQyxDQUFDO0lBRUgsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUM7SUFDckMsb0VBQW9FO0lBQ3BFLHNEQUFzRDtJQUN0RCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxhQUFhLENBQUM7SUFDNUQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDO0FBQ2hFLENBQUM7QUFFRDs7O0dBR0c7QUFDSCxTQUFnQixZQUFZLENBQ3hCLEVBQXlFO0lBRXpFLE9BQU8sQ0FBQyxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQVEsRUFBRTtRQUM3RCxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BELENBQUMsQ0FBQztBQUNOLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQWdCLGVBQWUsQ0FBQyxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCO0lBQzNFLElBQUksQ0FBQyxJQUFJLGFBQWEsQ0FBQyxvQkFBb0IsR0FBRyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzFFLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL3V0aWxzL2Vycm9yLWhhbmRsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBVbmlmaWVkIEVycm9yIEhhbmRsZXJcbiAqIFN0YW5kYXJkaXplZCBlcnJvciBoYW5kbGluZyBhY3Jvc3MgYWxsIHJvdXRlc1xuICogXG4gKiAjMjQg7Jew64+ZOiBhcGktcmVzcG9uc2Ug7ZGc7KSAIO2YleyLnSDsgqzsmqlcbiAqL1xuXG5pbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBjcmVhdGVMb2dnZXIgfSBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBlcnJvciBhcyBhcGlFcnJvciwgYmFkUmVxdWVzdCBhcyBhcGlCYWRSZXF1ZXN0LCBFcnJvckNvZGVzLCBBcGlFcnJvclJlc3BvbnNlIH0gZnJvbSAnLi9hcGktcmVzcG9uc2UnO1xuaW1wb3J0IHsgUXVvdGFFeGNlZWRlZEVycm9yIH0gZnJvbSAnLi4vZXJyb3JzL3F1b3RhLWV4Y2VlZGVkLmVycm9yJztcblxuY29uc3QgbG9nZ2VyID0gY3JlYXRlTG9nZ2VyKCdFcnJvckhhbmRsZXInKTtcblxuLyoqXG4gKiBCYXNlIGFwcGxpY2F0aW9uIGVycm9yIGNsYXNzXG4gKi9cbmV4cG9ydCBjbGFzcyBBcHBFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgICBwdWJsaWMgcmVhZG9ubHkgc3RhdHVzQ29kZTogbnVtYmVyO1xuICAgIHB1YmxpYyByZWFkb25seSBpc09wZXJhdGlvbmFsOiBib29sZWFuO1xuICAgIHB1YmxpYyByZWFkb25seSBjb2RlPzogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIG1lc3NhZ2U6IHN0cmluZyxcbiAgICAgICAgc3RhdHVzQ29kZTogbnVtYmVyID0gNTAwLFxuICAgICAgICBpc09wZXJhdGlvbmFsOiBib29sZWFuID0gdHJ1ZSxcbiAgICAgICAgY29kZT86IHN0cmluZ1xuICAgICkge1xuICAgICAgICBzdXBlcihtZXNzYWdlKTtcbiAgICAgICAgdGhpcy5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZTtcbiAgICAgICAgdGhpcy5pc09wZXJhdGlvbmFsID0gaXNPcGVyYXRpb25hbDtcbiAgICAgICAgdGhpcy5jb2RlID0gY29kZTtcbiAgICAgICAgXG4gICAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZih0aGlzLCBuZXcudGFyZ2V0LnByb3RvdHlwZSk7XG4gICAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIHRoaXMuY29uc3RydWN0b3IpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBWYWxpZGF0aW9uIGVycm9yICg0MDApXG4gKi9cbmV4cG9ydCBjbGFzcyBWYWxpZGF0aW9uRXJyb3IgZXh0ZW5kcyBBcHBFcnJvciB7XG4gICAgY29uc3RydWN0b3IobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgICAgIHN1cGVyKG1lc3NhZ2UsIDQwMCwgdHJ1ZSwgJ1ZBTElEQVRJT05fRVJST1InKTtcbiAgICB9XG59XG5cbi8qKlxuICogQXV0aGVudGljYXRpb24gZXJyb3IgKDQwMSlcbiAqL1xuZXhwb3J0IGNsYXNzIEF1dGhlbnRpY2F0aW9uRXJyb3IgZXh0ZW5kcyBBcHBFcnJvciB7XG4gICAgY29uc3RydWN0b3IobWVzc2FnZTogc3RyaW5nID0gJ+yduOymneydtCDtlYTsmpTtlanri4jri6QnKSB7XG4gICAgICAgIHN1cGVyKG1lc3NhZ2UsIDQwMSwgdHJ1ZSwgJ0FVVEhFTlRJQ0FUSU9OX0VSUk9SJyk7XG4gICAgfVxufVxuXG4vKipcbiAqIEF1dGhvcml6YXRpb24gZXJyb3IgKDQwMylcbiAqL1xuZXhwb3J0IGNsYXNzIEF1dGhvcml6YXRpb25FcnJvciBleHRlbmRzIEFwcEVycm9yIHtcbiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlOiBzdHJpbmcgPSAn6raM7ZWc7J20IOyXhuyKteuLiOuLpCcpIHtcbiAgICAgICAgc3VwZXIobWVzc2FnZSwgNDAzLCB0cnVlLCAnQVVUSE9SSVpBVElPTl9FUlJPUicpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBOb3QgZm91bmQgZXJyb3IgKDQwNClcbiAqL1xuZXhwb3J0IGNsYXNzIE5vdEZvdW5kRXJyb3IgZXh0ZW5kcyBBcHBFcnJvciB7XG4gICAgY29uc3RydWN0b3IobWVzc2FnZTogc3RyaW5nID0gJ+umrOyGjOyKpOulvCDssL7snYQg7IiYIOyXhuyKteuLiOuLpCcpIHtcbiAgICAgICAgc3VwZXIobWVzc2FnZSwgNDA0LCB0cnVlLCAnTk9UX0ZPVU5EJyk7XG4gICAgfVxufVxuXG4vKipcbiAqIFJhdGUgbGltaXQgZXJyb3IgKDQyOSlcbiAqL1xuZXhwb3J0IGNsYXNzIFJhdGVMaW1pdEVycm9yIGV4dGVuZHMgQXBwRXJyb3Ige1xuICAgIGNvbnN0cnVjdG9yKG1lc3NhZ2U6IHN0cmluZyA9ICfsmpTssq0g7KCc7ZWc7J2EIOy0iOqzvO2WiOyKteuLiOuLpCcpIHtcbiAgICAgICAgc3VwZXIobWVzc2FnZSwgNDI5LCB0cnVlLCAnUkFURV9MSU1JVF9FWENFRURFRCcpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBEYXRhYmFzZSBlcnJvciAoNTAwKVxuICovXG5leHBvcnQgY2xhc3MgRGF0YWJhc2VFcnJvciBleHRlbmRzIEFwcEVycm9yIHtcbiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlOiBzdHJpbmcgPSAn642w7J207YSw67Kg7J207IqkIOyYpOulmOqwgCDrsJzsg53tlojsirXri4jri6QnKSB7XG4gICAgICAgIHN1cGVyKG1lc3NhZ2UsIDUwMCwgdHJ1ZSwgJ0RBVEFCQVNFX0VSUk9SJyk7XG4gICAgfVxufVxuXG4vKipcbiAqIFN0YW5kYXJkIGVycm9yIHJlc3BvbnNlIGludGVyZmFjZVxuICogQGRlcHJlY2F0ZWQgVXNlIEFwaUVycm9yUmVzcG9uc2UgZnJvbSBhcGktcmVzcG9uc2UudHMgaW5zdGVhZFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEVycm9yUmVzcG9uc2Uge1xuICAgIHN1Y2Nlc3M6IGZhbHNlO1xuICAgIGVycm9yOiBzdHJpbmc7XG4gICAgY29kZT86IHN0cmluZztcbiAgICBkZXRhaWxzPzogc3RyaW5nW107XG4gICAgdGltZXN0YW1wOiBzdHJpbmc7XG4gICAgc3RhY2s/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogRm9ybWF0IGVycm9yIGZvciByZXNwb25zZSAoIzI0IOyXsOuPmTog7ZGc7KSAIEFwaUVycm9yUmVzcG9uc2Ug7ZiV7IudKVxuICovXG5mdW5jdGlvbiBmb3JtYXRFcnJvcihlcnI6IEVycm9yLCBpbmNsdWRlU3RhY2s6IGJvb2xlYW4pOiBBcGlFcnJvclJlc3BvbnNlICYgeyBzdGFjaz86IHN0cmluZyB9IHtcbiAgICBjb25zdCBjb2RlID0gZXJyIGluc3RhbmNlb2YgQXBwRXJyb3IgJiYgZXJyLmNvZGUgXG4gICAgICAgID8gZXJyLmNvZGUgXG4gICAgICAgIDogRXJyb3JDb2Rlcy5JTlRFUk5BTF9FUlJPUjtcbiAgICBcbiAgICBjb25zdCByZXNwb25zZSA9IGFwaUVycm9yKGNvZGUsIGVyci5tZXNzYWdlKTtcbiAgICBcbiAgICBpZiAoaW5jbHVkZVN0YWNrICYmIGVyci5zdGFjaykge1xuICAgICAgICByZXR1cm4geyAuLi5yZXNwb25zZSwgc3RhY2s6IGVyci5zdGFjayB9O1xuICAgIH1cblxuICAgIHJldHVybiByZXNwb25zZTtcbn1cblxuLyoqXG4gKiBHbG9iYWwgZXJyb3IgaGFuZGxlciBtaWRkbGV3YXJlXG4gKiBNdXN0IGJlIHJlZ2lzdGVyZWQgTEFTVCBhZnRlciBhbGwgcm91dGVzXG4gKiBcbiAqIOKame+4jyBQaGFzZSAzIO2Gte2VqSAyMDI2LTAyLTA3OlxuICogICAtIE11bHRlckVycm9yICjtjIzsnbwg7JeF66Gc65OcKSDsspjrpqwg7Ya17ZWpXG4gKiAgIC0gUXVvdGFFeGNlZWRlZEVycm9yIChBUEkg7ZWg64u565+JKSDsspjrpqwg7Ya17ZWpXG4gKiAgIC0gc2VydmVyLnRzIOyduOudvOyduCDtlbjrk6Trn6wgKyBtaWRkbGV3YXJlcy9pbmRleC50cyBnbG9iYWxFcnJvckhhbmRsZXIg7KCc6rGwIOKGkiDsnbQg7ZWo7IiY66GcIOuLqOydvO2ZlFxuICogXG4gKiAjMjQg7Jew64+ZOiDtkZzspIAgQVBJIOydkeuLtSDtmJXsi50g7KCB7JqpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBlcnJvckhhbmRsZXIoXG4gICAgZXJyOiBFcnJvciAmIHsgY29kZT86IHN0cmluZzsgc3RhdHVzPzogbnVtYmVyOyBuYW1lPzogc3RyaW5nIH0sXG4gICAgcmVxOiBSZXF1ZXN0LFxuICAgIHJlczogUmVzcG9uc2UsXG4gICAgX25leHQ6IE5leHRGdW5jdGlvblxuKTogdm9pZCB7XG4gICAgLy8g4pSA4pSAIFF1b3RhRXhjZWVkZWRFcnJvciDihpIgNDI5IOKUgOKUgFxuICAgIGlmIChlcnIgaW5zdGFuY2VvZiBRdW90YUV4Y2VlZGVkRXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oYFF1b3RhIGV4Y2VlZGVkOiAke2Vyci5tZXNzYWdlfWAsIHsgcGF0aDogcmVxLnBhdGggfSk7XG4gICAgICAgIHJlcy5zZXQoJ1JldHJ5LUFmdGVyJywgU3RyaW5nKGVyci5yZXRyeUFmdGVyU2Vjb25kcykpO1xuICAgICAgICByZXMuc3RhdHVzKDQyOSkuanNvbihhcGlFcnJvcihFcnJvckNvZGVzLlJBVEVfTElNSVRFRCwgZXJyLm1lc3NhZ2UsIHtcbiAgICAgICAgICAgIHF1b3RhVHlwZTogZXJyLnF1b3RhVHlwZSxcbiAgICAgICAgICAgIHVzZWQ6IGVyci51c2VkLFxuICAgICAgICAgICAgbGltaXQ6IGVyci5saW1pdCxcbiAgICAgICAgICAgIHJldHJ5QWZ0ZXI6IGVyci5yZXRyeUFmdGVyU2Vjb25kcyxcbiAgICAgICAgfSkpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8g4pSA4pSAIE11bHRlcjog7YyM7J28IO2BrOq4sCDstIjqs7wg4oaSIDQxMyDilIDilIBcbiAgICBpZiAoZXJyLmNvZGUgPT09ICdMSU1JVF9GSUxFX1NJWkUnKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKGBGaWxlIHNpemUgbGltaXQgZXhjZWVkZWQ6ICR7cmVxLnBhdGh9YCk7XG4gICAgICAgIHJlcy5zdGF0dXMoNDEzKS5qc29uKGFwaUVycm9yKEVycm9yQ29kZXMuUEFZTE9BRF9UT09fTEFSR0UsICftjIzsnbwg7YGs6riw6rCAIOuEiOustCDtgb3ri4jri6QgKOy1nOuMgCAxMDBNQiknKSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyDilIDilIAgTXVsdGVyOiDquLDtg4Ag7JeF66Gc65OcIOyYpOulmCDihpIgNDAwIOKUgOKUgFxuICAgIGlmIChlcnIubmFtZSA9PT0gJ011bHRlckVycm9yJykge1xuICAgICAgICBsb2dnZXIud2FybihgTXVsdGVyIGVycm9yOiAke2Vyci5tZXNzYWdlfWAsIHsgcGF0aDogcmVxLnBhdGggfSk7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKGFwaUJhZFJlcXVlc3QoYOyXheuhnOuTnCDsmKTrpZg6ICR7ZXJyLm1lc3NhZ2V9YCkpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8g4pSA4pSAIEFwcEVycm9yICjsu6TsiqTthYAg7JeQ65+sIOqzhOy4tSkg4pSA4pSAXG4gICAgaWYgKGVyciBpbnN0YW5jZW9mIEFwcEVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihgWyR7cmVxLm1ldGhvZH1dICR7cmVxLnBhdGh9OiAke2Vyci5tZXNzYWdlfWAsIHtcbiAgICAgICAgICAgIHN0YWNrOiBlcnIuc3RhY2ssXG4gICAgICAgICAgICBjb2RlOiBlcnIuY29kZSxcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIE5PVEU6IFVzZSBwcm9jZXNzLmVudi5OT0RFX0VOViBkaXJlY3RseSAobm90IGdldENvbmZpZygpKSBiZWNhdXNlXG4gICAgICAgIC8vIE5PREVfRU5WIGNhbiBjaGFuZ2UgYXQgcnVudGltZSBpbiB0ZXN0IGVudmlyb25tZW50c1xuICAgICAgICBjb25zdCBpbmNsdWRlU3RhY2sgPSBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50JztcbiAgICAgICAgcmVzLnN0YXR1cyhlcnIuc3RhdHVzQ29kZSkuanNvbihmb3JtYXRFcnJvcihlcnIsIGluY2x1ZGVTdGFjaykpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8g4pSA4pSAIOq4sO2DgCDslYwg7IiYIOyXhuuKlCDsl5Drn6wg4oaSIDUwMCDilIDilIBcbiAgICBsb2dnZXIuZXJyb3IoYFske3JlcS5tZXRob2R9XSAke3JlcS5wYXRofTogJHtlcnIubWVzc2FnZX1gLCB7XG4gICAgICAgIHN0YWNrOiBlcnIuc3RhY2ssXG4gICAgICAgIGJvZHk6IHJlcS5ib2R5LFxuICAgICAgICBxdWVyeTogcmVxLnF1ZXJ5XG4gICAgfSk7XG5cbiAgICBjb25zdCBzdGF0dXNDb2RlID0gZXJyLnN0YXR1cyB8fCA1MDA7XG4gICAgLy8gTk9URTogVXNlIHByb2Nlc3MuZW52Lk5PREVfRU5WIGRpcmVjdGx5IChub3QgZ2V0Q29uZmlnKCkpIGJlY2F1c2VcbiAgICAvLyBOT0RFX0VOViBjYW4gY2hhbmdlIGF0IHJ1bnRpbWUgaW4gdGVzdCBlbnZpcm9ubWVudHNcbiAgICBjb25zdCBpbmNsdWRlU3RhY2sgPSBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50JztcbiAgICByZXMuc3RhdHVzKHN0YXR1c0NvZGUpLmpzb24oZm9ybWF0RXJyb3IoZXJyLCBpbmNsdWRlU3RhY2spKTtcbn1cblxuLyoqXG4gKiBBc3luYyBoYW5kbGVyIHdyYXBwZXIgdG8gY2F0Y2ggYXN5bmMgZXJyb3JzXG4gKiBXcmFwcyBhc3luYyByb3V0ZSBoYW5kbGVycyB0byBmb3J3YXJkIGVycm9ycyB0byBlcnJvciBtaWRkbGV3YXJlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhc3luY0hhbmRsZXIoXG4gICAgZm46IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4gUHJvbWlzZTx1bmtub3duPlxuKSB7XG4gICAgcmV0dXJuIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQgPT4ge1xuICAgICAgICBQcm9taXNlLnJlc29sdmUoZm4ocmVxLCByZXMsIG5leHQpKS5jYXRjaChuZXh0KTtcbiAgICB9O1xufVxuXG4vKipcbiAqIE5vdCBmb3VuZCBoYW5kbGVyIGZvciB1bmRlZmluZWQgcm91dGVzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBub3RGb3VuZEhhbmRsZXIocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiB2b2lkIHtcbiAgICBuZXh0KG5ldyBOb3RGb3VuZEVycm9yKGBSb3V0ZSBub3QgZm91bmQ6ICR7cmVxLm1ldGhvZH0gJHtyZXEucGF0aH1gKSk7XG59XG4iXSwidmVyc2lvbiI6M30=