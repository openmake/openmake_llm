{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/data/models/unified-database.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/data/models/unified-database.ts"],"sourcesContent":["/**\n * Unified Database Model\n * ÌÜµÌï© Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Î™®Îç∏ - PostgreSQL Í∏∞Î∞ò\n */\n\nimport { Pool, QueryResult } from 'pg';\nimport { withTransaction, withRetry, type TransactionClient } from '../retry-wrapper';\nimport { getConfig } from '../../config/env';\n\n/** Generic DB query parameter type */\ntype QueryParam = string | number | boolean | null | undefined;\n\n/** Generic DB row from pg query result */\ntype DbRow = Record<string, unknown>;\n\n// Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§Îßà (PostgreSQL)\nconst SCHEMA = `\n-- ÏÇ¨Ïö©Ïûê ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS users (\n    id TEXT PRIMARY KEY,\n    username TEXT UNIQUE NOT NULL,\n    password_hash TEXT NOT NULL,\n    email TEXT,\n    role TEXT DEFAULT 'user' CHECK(role IN ('admin', 'user', 'guest')),\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW(),\n    last_login TIMESTAMPTZ,\n    is_active BOOLEAN DEFAULT TRUE\n);\n\n-- ÎåÄÌôî ÏÑ∏ÏÖò ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS conversation_sessions (\n    id TEXT PRIMARY KEY,\n    user_id TEXT,\n    title TEXT,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW(),\n    metadata JSONB,\n    FOREIGN KEY (user_id) REFERENCES users(id)\n);\n\n-- ÎåÄÌôî Î©îÏãúÏßÄ ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS conversation_messages (\n    id SERIAL PRIMARY KEY,\n    session_id TEXT NOT NULL,\n    role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system')),\n    content TEXT NOT NULL,\n    model TEXT,\n    agent_id TEXT,\n    thinking TEXT,\n    tokens INTEGER,\n    response_time_ms INTEGER,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    FOREIGN KEY (session_id) REFERENCES conversation_sessions(id) ON DELETE CASCADE\n);\n\n-- API ÏÇ¨Ïö©Îüâ ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS api_usage (\n    id SERIAL PRIMARY KEY,\n    date TEXT NOT NULL,\n    api_key_id TEXT,\n    requests INTEGER DEFAULT 0,\n    tokens INTEGER DEFAULT 0,\n    errors INTEGER DEFAULT 0,\n    avg_response_time REAL DEFAULT 0,\n    models JSONB,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW(),\n    UNIQUE(date, api_key_id)\n);\n\n-- ÏóêÏù¥Ï†ÑÌä∏ ÏÇ¨Ïö© Î°úÍ∑∏ ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS agent_usage_logs (\n    id SERIAL PRIMARY KEY,\n    timestamp TIMESTAMPTZ DEFAULT NOW(),\n    user_id TEXT,\n    session_id TEXT,\n    agent_id TEXT NOT NULL,\n    query TEXT,\n    response_preview TEXT,\n    response_time_ms INTEGER,\n    tokens_used INTEGER,\n    success BOOLEAN DEFAULT TRUE,\n    error_message TEXT,\n    FOREIGN KEY (user_id) REFERENCES users(id),\n    FOREIGN KEY (session_id) REFERENCES conversation_sessions(id)\n);\n\n-- ÏóêÏù¥Ï†ÑÌä∏ ÌîºÎìúÎ∞± ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS agent_feedback (\n    id TEXT PRIMARY KEY,\n    agent_id TEXT NOT NULL,\n    user_id TEXT,\n    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),\n    comment TEXT,\n    query TEXT,\n    response TEXT,\n    tags JSONB,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    FOREIGN KEY (user_id) REFERENCES users(id)\n);\n\n-- Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS custom_agents (\n    id TEXT PRIMARY KEY,\n    name TEXT NOT NULL,\n    description TEXT,\n    system_prompt TEXT NOT NULL,\n    keywords JSONB,\n    category TEXT,\n    emoji TEXT DEFAULT 'ü§ñ',\n    temperature REAL,\n    max_tokens INTEGER,\n    created_by TEXT,\n    enabled BOOLEAN DEFAULT TRUE,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW(),\n    FOREIGN KEY (created_by) REFERENCES users(id)\n);\n\n-- ÏãúÏä§ÌÖú Í∞êÏÇ¨ Î°úÍ∑∏ ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS audit_logs (\n    id SERIAL PRIMARY KEY,\n    timestamp TIMESTAMPTZ DEFAULT NOW(),\n    action TEXT NOT NULL,\n    user_id TEXT,\n    resource_type TEXT,\n    resource_id TEXT,\n    details JSONB,\n    ip_address TEXT,\n    user_agent TEXT\n);\n\n-- ÏïåÎ¶º ÌûàÏä§ÌÜ†Î¶¨ ÌÖåÏù¥Î∏î\nCREATE TABLE IF NOT EXISTS alert_history (\n    id SERIAL PRIMARY KEY,\n    type TEXT NOT NULL,\n    severity TEXT NOT NULL,\n    title TEXT NOT NULL,\n    message TEXT,\n    data JSONB,\n    acknowledged BOOLEAN DEFAULT FALSE,\n    acknowledged_by TEXT,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    acknowledged_at TIMESTAMPTZ\n);\n\n-- Ïù∏Îç±Ïä§\nCREATE INDEX IF NOT EXISTS idx_messages_session ON conversation_messages(session_id);\nCREATE INDEX IF NOT EXISTS idx_messages_created ON conversation_messages(created_at);\nCREATE INDEX IF NOT EXISTS idx_usage_date ON api_usage(date);\nCREATE INDEX IF NOT EXISTS idx_agent_logs_agent ON agent_usage_logs(agent_id);\nCREATE INDEX IF NOT EXISTS idx_agent_logs_time ON agent_usage_logs(timestamp);\nCREATE INDEX IF NOT EXISTS idx_feedback_agent ON agent_feedback(agent_id);\nCREATE INDEX IF NOT EXISTS idx_audit_action ON audit_logs(action);\nCREATE INDEX IF NOT EXISTS idx_audit_time ON audit_logs(timestamp);\nCREATE INDEX IF NOT EXISTS idx_users_username ON users(username);\nCREATE INDEX IF NOT EXISTS idx_users_email ON users(email);\nCREATE INDEX IF NOT EXISTS idx_sessions_user ON conversation_sessions(user_id);\n\n-- ============================================\n-- üß† Ïû•Í∏∞ Î©îÎ™®Î¶¨ ÏãúÏä§ÌÖú ÌÖåÏù¥Î∏î\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS user_memories (\n    id TEXT PRIMARY KEY,\n    user_id TEXT NOT NULL,\n    category TEXT NOT NULL CHECK(category IN ('preference', 'fact', 'project', 'relationship', 'skill', 'context')),\n    key TEXT NOT NULL,\n    value TEXT NOT NULL,\n    importance REAL DEFAULT 0.5,\n    access_count INTEGER DEFAULT 0,\n    last_accessed TIMESTAMPTZ,\n    source_session_id TEXT,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW(),\n    expires_at TIMESTAMPTZ,\n    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n    UNIQUE(user_id, category, key)\n);\n\nCREATE TABLE IF NOT EXISTS memory_tags (\n    id SERIAL PRIMARY KEY,\n    memory_id TEXT NOT NULL,\n    tag TEXT NOT NULL,\n    FOREIGN KEY (memory_id) REFERENCES user_memories(id) ON DELETE CASCADE,\n    UNIQUE(memory_id, tag)\n);\n\nCREATE INDEX IF NOT EXISTS idx_memories_user ON user_memories(user_id);\nCREATE INDEX IF NOT EXISTS idx_memories_category ON user_memories(category);\nCREATE INDEX IF NOT EXISTS idx_memories_importance ON user_memories(importance DESC);\n\n-- ============================================\n-- üîç Deep Research ÌÖåÏù¥Î∏î\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS research_sessions (\n    id TEXT PRIMARY KEY,\n    user_id TEXT,\n    topic TEXT NOT NULL,\n    status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'running', 'completed', 'failed', 'cancelled')),\n    depth TEXT DEFAULT 'standard' CHECK(depth IN ('quick', 'standard', 'deep')),\n    progress INTEGER DEFAULT 0,\n    summary TEXT,\n    key_findings JSONB,\n    sources JSONB,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW(),\n    completed_at TIMESTAMPTZ,\n    FOREIGN KEY (user_id) REFERENCES users(id)\n);\n\nCREATE TABLE IF NOT EXISTS research_steps (\n    id SERIAL PRIMARY KEY,\n    session_id TEXT NOT NULL,\n    step_number INTEGER NOT NULL,\n    step_type TEXT NOT NULL,\n    query TEXT,\n    result TEXT,\n    sources JSONB,\n    status TEXT DEFAULT 'pending',\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    FOREIGN KEY (session_id) REFERENCES research_sessions(id) ON DELETE CASCADE\n);\n\nCREATE INDEX IF NOT EXISTS idx_research_user ON research_sessions(user_id);\nCREATE INDEX IF NOT EXISTS idx_research_status ON research_sessions(status);\n\n-- ============================================\n-- üè™ Custom Agent ÎßàÏºìÌîåÎ†àÏù¥Ïä§ ÌÖåÏù¥Î∏î\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS agent_marketplace (\n    id TEXT PRIMARY KEY,\n    agent_id TEXT NOT NULL,\n    author_id TEXT NOT NULL,\n    title TEXT NOT NULL,\n    description TEXT,\n    long_description TEXT,\n    category TEXT,\n    tags JSONB,\n    icon TEXT DEFAULT 'ü§ñ',\n    price REAL DEFAULT 0,\n    is_free BOOLEAN DEFAULT TRUE,\n    is_featured BOOLEAN DEFAULT FALSE,\n    is_verified BOOLEAN DEFAULT FALSE,\n    downloads INTEGER DEFAULT 0,\n    rating_avg REAL DEFAULT 0,\n    rating_count INTEGER DEFAULT 0,\n    version TEXT DEFAULT '1.0.0',\n    status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'approved', 'rejected', 'suspended')),\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW(),\n    published_at TIMESTAMPTZ,\n    FOREIGN KEY (agent_id) REFERENCES custom_agents(id),\n    FOREIGN KEY (author_id) REFERENCES users(id)\n);\n\nCREATE TABLE IF NOT EXISTS agent_reviews (\n    id TEXT PRIMARY KEY,\n    marketplace_id TEXT NOT NULL,\n    user_id TEXT NOT NULL,\n    rating INTEGER NOT NULL CHECK(rating >= 1 AND rating <= 5),\n    title TEXT,\n    content TEXT,\n    helpful_count INTEGER DEFAULT 0,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    FOREIGN KEY (marketplace_id) REFERENCES agent_marketplace(id) ON DELETE CASCADE,\n    FOREIGN KEY (user_id) REFERENCES users(id),\n    UNIQUE(marketplace_id, user_id)\n);\n\nCREATE TABLE IF NOT EXISTS agent_installations (\n    id SERIAL PRIMARY KEY,\n    marketplace_id TEXT NOT NULL,\n    user_id TEXT NOT NULL,\n    installed_at TIMESTAMPTZ DEFAULT NOW(),\n    FOREIGN KEY (marketplace_id) REFERENCES agent_marketplace(id),\n    FOREIGN KEY (user_id) REFERENCES users(id),\n    UNIQUE(marketplace_id, user_id)\n);\n\nCREATE INDEX IF NOT EXISTS idx_marketplace_category ON agent_marketplace(category);\nCREATE INDEX IF NOT EXISTS idx_marketplace_downloads ON agent_marketplace(downloads DESC);\n\n-- ============================================\n-- üìù Canvas ÌòëÏóÖ ÎèÑÍµ¨ ÌÖåÏù¥Î∏î\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS canvas_documents (\n    id TEXT PRIMARY KEY,\n    user_id TEXT NOT NULL,\n    session_id TEXT,\n    title TEXT NOT NULL,\n    doc_type TEXT DEFAULT 'document' CHECK(doc_type IN ('document', 'code', 'diagram', 'table')),\n    content TEXT,\n    language TEXT,\n    version INTEGER DEFAULT 1,\n    is_shared BOOLEAN DEFAULT FALSE,\n    share_token TEXT UNIQUE,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW(),\n    FOREIGN KEY (user_id) REFERENCES users(id),\n    FOREIGN KEY (session_id) REFERENCES conversation_sessions(id)\n);\n\nCREATE TABLE IF NOT EXISTS canvas_versions (\n    id SERIAL PRIMARY KEY,\n    document_id TEXT NOT NULL,\n    version INTEGER NOT NULL,\n    content TEXT NOT NULL,\n    change_summary TEXT,\n    created_by TEXT,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    FOREIGN KEY (document_id) REFERENCES canvas_documents(id) ON DELETE CASCADE\n);\n\nCREATE INDEX IF NOT EXISTS idx_canvas_user ON canvas_documents(user_id);\nCREATE INDEX IF NOT EXISTS idx_canvas_session ON canvas_documents(session_id);\n\n-- ============================================\n-- üîó Ïô∏Î∂Ä ÏÑúÎπÑÏä§ ÌÜµÌï© ÌÖåÏù¥Î∏î\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS external_connections (\n    id TEXT PRIMARY KEY,\n    user_id TEXT NOT NULL,\n    service_type TEXT NOT NULL CHECK(service_type IN ('google_drive', 'notion', 'github', 'slack', 'dropbox')),\n    access_token TEXT,\n    refresh_token TEXT,\n    token_expires_at TIMESTAMPTZ,\n    account_email TEXT,\n    account_name TEXT,\n    metadata JSONB,\n    is_active BOOLEAN DEFAULT TRUE,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW(),\n    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n    UNIQUE(user_id, service_type)\n);\n\nCREATE TABLE IF NOT EXISTS external_files (\n    id TEXT PRIMARY KEY,\n    connection_id TEXT NOT NULL,\n    external_id TEXT NOT NULL,\n    file_name TEXT NOT NULL,\n    file_type TEXT,\n    file_size INTEGER,\n    web_url TEXT,\n    last_synced TIMESTAMPTZ,\n    cached_content TEXT,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    FOREIGN KEY (connection_id) REFERENCES external_connections(id) ON DELETE CASCADE,\n    UNIQUE(connection_id, external_id)\n);\n\nCREATE INDEX IF NOT EXISTS idx_connections_user ON external_connections(user_id);\nCREATE INDEX IF NOT EXISTS idx_connections_service ON external_connections(service_type);\n\n-- ============================================\n-- üîå MCP Ïô∏Î∂Ä ÏÑúÎ≤Ñ ÏÑ§Ï†ï ÌÖåÏù¥Î∏î\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS mcp_servers (\n    id TEXT PRIMARY KEY,\n    name TEXT NOT NULL UNIQUE,\n    transport_type TEXT NOT NULL CHECK(transport_type IN ('stdio', 'sse', 'streamable-http')),\n    command TEXT,\n    args JSONB,\n    env JSONB,\n    url TEXT,\n    enabled BOOLEAN DEFAULT TRUE,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\nCREATE INDEX IF NOT EXISTS idx_mcp_servers_name ON mcp_servers(name);\nCREATE INDEX IF NOT EXISTS idx_mcp_servers_enabled ON mcp_servers(enabled);\n`;\n\nexport interface User {\n    id: string;\n    username: string;\n    password_hash: string;\n    email?: string;\n    role: 'admin' | 'user' | 'guest';\n    created_at: string;\n    updated_at: string;\n    last_login?: string;\n    is_active: boolean;\n}\n\nexport interface ConversationSession {\n    id: string;\n    user_id?: string;\n    title: string;\n    created_at: string;\n    updated_at: string;\n    metadata?: Record<string, unknown> | null;\n}\n\nexport interface ConversationMessage {\n    id: number;\n    session_id: string;\n    role: 'user' | 'assistant' | 'system';\n    content: string;\n    model?: string;\n    agent_id?: string;\n    thinking?: string;\n    tokens?: number;\n    response_time_ms?: number;\n    created_at: string;\n}\n\n// ============================================\n// üß† Ïû•Í∏∞ Î©îÎ™®Î¶¨ ÏãúÏä§ÌÖú Ïù∏ÌÑ∞ÌéòÏù¥Ïä§\n// ============================================\n\nexport type MemoryCategory = 'preference' | 'fact' | 'project' | 'relationship' | 'skill' | 'context';\n\nexport interface UserMemory {\n    id: string;\n    user_id: string;\n    category: MemoryCategory;\n    key: string;\n    value: string;\n    importance: number;\n    access_count: number;\n    last_accessed?: string;\n    source_session_id?: string;\n    created_at: string;\n    updated_at: string;\n    expires_at?: string;\n}\n\nexport interface MemoryTag {\n    id: number;\n    memory_id: string;\n    tag: string;\n}\n\n// ============================================\n// üîç Deep Research Ïù∏ÌÑ∞ÌéòÏù¥Ïä§\n// ============================================\n\nexport type ResearchStatus = 'pending' | 'running' | 'completed' | 'failed' | 'cancelled';\nexport type ResearchDepth = 'quick' | 'standard' | 'deep';\n\nexport interface ResearchSession {\n    id: string;\n    user_id?: string;\n    topic: string;\n    status: ResearchStatus;\n    depth: ResearchDepth;\n    progress: number;\n    summary?: string;\n    key_findings?: string[];\n    sources?: string[];\n    created_at: string;\n    updated_at: string;\n    completed_at?: string;\n}\n\nexport interface ResearchStep {\n    id: number;\n    session_id: string;\n    step_number: number;\n    step_type: string;\n    query?: string;\n    result?: string;\n    sources?: string[];\n    status: string;\n    created_at: string;\n}\n\n// ============================================\n// üè™ ÎßàÏºìÌîåÎ†àÏù¥Ïä§ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§\n// ============================================\n\nexport type MarketplaceStatus = 'pending' | 'approved' | 'rejected' | 'suspended';\n\nexport interface MarketplaceAgent {\n    id: string;\n    agent_id: string;\n    author_id: string;\n    title: string;\n    description?: string;\n    long_description?: string;\n    category?: string;\n    tags?: string[];\n    icon: string;\n    price: number;\n    is_free: boolean;\n    is_featured: boolean;\n    is_verified: boolean;\n    downloads: number;\n    rating_avg: number;\n    rating_count: number;\n    version: string;\n    status: MarketplaceStatus;\n    created_at: string;\n    updated_at: string;\n    published_at?: string;\n}\n\nexport interface AgentReview {\n    id: string;\n    marketplace_id: string;\n    user_id: string;\n    rating: number;\n    title?: string;\n    content?: string;\n    helpful_count: number;\n    created_at: string;\n}\n\nexport interface AgentInstallation {\n    id: number;\n    marketplace_id: string;\n    user_id: string;\n    installed_at: string;\n}\n\n// ============================================\n// üìù Canvas Ïù∏ÌÑ∞ÌéòÏù¥Ïä§\n// ============================================\n\nexport type CanvasDocType = 'document' | 'code' | 'diagram' | 'table';\n\nexport interface CanvasDocument {\n    id: string;\n    user_id: string;\n    session_id?: string;\n    title: string;\n    doc_type: CanvasDocType;\n    content?: string;\n    language?: string;\n    version: number;\n    is_shared: boolean;\n    share_token?: string;\n    created_at: string;\n    updated_at: string;\n}\n\nexport interface CanvasVersion {\n    id: number;\n    document_id: string;\n    version: number;\n    content: string;\n    change_summary?: string;\n    created_by?: string;\n    created_at: string;\n}\n\n// ============================================\n// üîó Ïô∏Î∂Ä ÏÑúÎπÑÏä§ ÌÜµÌï© Ïù∏ÌÑ∞ÌéòÏù¥Ïä§\n// ============================================\n\nexport type ExternalServiceType = 'google_drive' | 'notion' | 'github' | 'slack' | 'dropbox';\n\nexport interface ExternalConnection {\n    id: string;\n    user_id: string;\n    service_type: ExternalServiceType;\n    access_token?: string;\n    refresh_token?: string;\n    token_expires_at?: string;\n    account_email?: string;\n    account_name?: string;\n    metadata?: Record<string, any>;\n    is_active: boolean;\n    created_at: string;\n    updated_at: string;\n}\n\nexport interface ExternalFile {\n    id: string;\n    connection_id: string;\n    external_id: string;\n    file_name: string;\n    file_type?: string;\n    file_size?: number;\n    web_url?: string;\n    last_synced?: string;\n    cached_content?: string;\n    created_at: string;\n}\n\n// ============================================\n// üîå MCP Ïô∏Î∂Ä ÏÑúÎ≤Ñ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§\n// ============================================\n\nexport interface MCPServerRow {\n    id: string;\n    name: string;\n    transport_type: string;\n    command: string | null;\n    args: string[] | null;\n    env: Record<string, string> | null;\n    url: string | null;\n    enabled: boolean;\n    created_at: string;\n    updated_at: string;\n}\n\n/**\n * ÌÜµÌï© Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌÅ¥ÎûòÏä§ (PostgreSQL)\n */\nexport class UnifiedDatabase {\n    private pool: Pool;\n\n    private schemaReady: Promise<void>;\n\n    constructor() {\n        this.pool = new Pool({\n            connectionString: getConfig().databaseUrl\n        });\n\n        // Ïä§ÌÇ§Îßà Ï¥àÍ∏∞Ìôî ‚Äî PromiseÎ•º Î≥¥Í¥ÄÌïòÏó¨ Ï¥àÍ∏∞ ÏøºÎ¶¨Í∞Ä Ïä§ÌÇ§Îßà ÏôÑÎ£åÎ•º ÎåÄÍ∏∞Ìï† Ïàò ÏûàÎèÑÎ°ù Ìï®\n        this.schemaReady = this.initSchema().catch(err => {\n            console.error('[UnifiedDB] Schema init failed:', err);\n        }) as Promise<void>;\n\n        console.log(`[UnifiedDB] PostgreSQL Pool Ï¥àÍ∏∞Ìôî ÏôÑÎ£å`);\n    }\n\n    private async initSchema(): Promise<void> {\n        await this.retryQuery(SCHEMA);\n    }\n\n    /**\n     * Ïä§ÌÇ§Îßà Ï¥àÍ∏∞Ìôî ÏôÑÎ£åÎ•º Î≥¥Ïû•ÌïòÎäî Ìó¨Ìçº\n     * Ïô∏Î∂ÄÏóêÏÑú DBÎ•º ÏÇ¨Ïö©ÌïòÍ∏∞ Ï†ÑÏóê Ìò∏Ï∂úÌïòÏó¨ race condition Î∞©ÏßÄ\n     */\n    async ensureReady(): Promise<void> {\n        await this.schemaReady;\n    }\n\n    /**\n     * Pool ÏßÅÏ†ë Ï†ëÍ∑º (raw SQL ÏÜåÎπÑÏûêÏö©)\n     */\n    getPool(): Pool {\n        return this.pool;\n    }\n\n    /**\n     * Ïû¨ÏãúÎèÑ Í∞ÄÎä•Ìïú ÏøºÎ¶¨ ÎûòÌçº\n     * ÏùºÏãúÏ†Å Ïó∞Í≤∞ Ïò§Î•ò Ïãú ÏûêÎèô Ïû¨ÏãúÎèÑ (ÏßÄÏàò Î∞±Ïò§ÌîÑ)\n     */\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    private retryQuery(text: string, params?: QueryParam[]): Promise<QueryResult<any>> {\n        return withRetry(\n            () => this.pool.query(text, params),\n            { operation: text.substring(0, 50) }\n        );\n    }\n\n    // ===== ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ =====\n\n    async createUser(id: string, username: string, passwordHash: string, email?: string, role: string = 'user') {\n        const result = await this.retryQuery(\n            `INSERT INTO users (id, username, password_hash, email, role) VALUES ($1, $2, $3, $4, $5)`,\n            [id, username, passwordHash, email, role]\n        );\n        return result;\n    }\n\n    async getUserByUsername(username: string): Promise<User | undefined> {\n        const result = await this.retryQuery('SELECT * FROM users WHERE username = $1', [username]);\n        return result.rows[0] as User | undefined;\n    }\n\n    async getUserById(id: string): Promise<User | undefined> {\n        const result = await this.retryQuery('SELECT * FROM users WHERE id = $1', [id]);\n        return result.rows[0] as User | undefined;\n    }\n\n    async updateLastLogin(userId: string) {\n        const result = await this.retryQuery('UPDATE users SET last_login = NOW() WHERE id = $1', [userId]);\n        return result;\n    }\n\n    async getAllUsers(limit: number = 50): Promise<User[]> {\n        const result = await this.retryQuery('SELECT * FROM users ORDER BY created_at DESC LIMIT $1', [limit]);\n        return result.rows as User[];\n    }\n\n    // ===== ÎåÄÌôî Í¥ÄÎ¶¨ =====\n\n    async createSession(id: string, userId?: string, title?: string, metadata?: Record<string, unknown> | null) {\n        const result = await this.retryQuery(\n            `INSERT INTO conversation_sessions (id, user_id, title, metadata) VALUES ($1, $2, $3, $4)`,\n            [id, userId, title || 'ÏÉà ÎåÄÌôî', JSON.stringify(metadata || {})]\n        );\n        return result;\n    }\n\n    async addMessage(sessionId: string, role: string, content: string, options?: {\n        model?: string;\n        agentId?: string;\n        thinking?: string;\n        tokens?: number;\n        responseTimeMs?: number;\n    }) {\n        const result = await this.retryQuery(\n            `INSERT INTO conversation_messages \n            (session_id, role, content, model, agent_id, thinking, tokens, response_time_ms)\n            VALUES ($1, $2, $3, $4, $5, $6, $7, $8)`,\n            [\n                sessionId, role, content,\n                options?.model, options?.agentId, options?.thinking,\n                options?.tokens, options?.responseTimeMs\n            ]\n        );\n        return result;\n    }\n\n    async getSessionMessages(sessionId: string, limit: number = 100): Promise<ConversationMessage[]> {\n        const result = await this.retryQuery(\n            `SELECT * FROM conversation_messages WHERE session_id = $1 ORDER BY created_at ASC LIMIT $2`,\n            [sessionId, limit]\n        );\n        return result.rows as ConversationMessage[];\n    }\n\n    async getUserSessions(userId: string, limit: number = 50): Promise<ConversationSession[]> {\n        const result = await this.retryQuery(\n            `SELECT * FROM conversation_sessions WHERE user_id = $1 ORDER BY updated_at DESC LIMIT $2`,\n            [userId, limit]\n        );\n        return result.rows as ConversationSession[];\n    }\n\n    async getAllSessions(limit: number = 50): Promise<ConversationSession[]> {\n        const result = await this.retryQuery(\n            `SELECT * FROM conversation_sessions ORDER BY updated_at DESC LIMIT $1`,\n            [limit]\n        );\n        return result.rows as ConversationSession[];\n    }\n\n    async deleteSession(sessionId: string) {\n        const result = await this.retryQuery('DELETE FROM conversation_sessions WHERE id = $1', [sessionId]);\n        return { changes: result.rowCount || 0 };\n    }\n\n    // ===== API ÏÇ¨Ïö©Îüâ Í¥ÄÎ¶¨ =====\n\n    async recordApiUsage(date: string, apiKeyId: string, requests: number, tokens: number, errors: number, avgResponseTime: number, models: Record<string, unknown>) {\n        const result = await this.retryQuery(\n            `INSERT INTO api_usage (date, api_key_id, requests, tokens, errors, avg_response_time, models)\n            VALUES ($1, $2, $3, $4, $5, $6, $7)\n            ON CONFLICT(date, api_key_id) DO UPDATE SET\n                requests = api_usage.requests + EXCLUDED.requests,\n                tokens = api_usage.tokens + EXCLUDED.tokens,\n                errors = api_usage.errors + EXCLUDED.errors,\n                avg_response_time = (api_usage.avg_response_time + EXCLUDED.avg_response_time) / 2,\n                models = EXCLUDED.models,\n                updated_at = NOW()`,\n            [date, apiKeyId, requests, tokens, errors, avgResponseTime, JSON.stringify(models)]\n        );\n        return result;\n    }\n\n    async getDailyUsage(days: number = 7) {\n        const result = await this.retryQuery(\n            `SELECT date, SUM(requests) as requests, SUM(tokens) as tokens, SUM(errors) as errors, AVG(avg_response_time) as avg_response_time\n            FROM api_usage\n            WHERE date >= (CURRENT_DATE - $1 * INTERVAL '1 day')::text\n            GROUP BY date\n            ORDER BY date DESC`,\n            [days]\n        );\n        return result.rows;\n    }\n\n    // ===== ÏóêÏù¥Ï†ÑÌä∏ Î°úÍ∑∏ =====\n\n    async logAgentUsage(params: {\n        userId?: string;\n        sessionId?: string;\n        agentId: string;\n        query: string;\n        responsePreview?: string;\n        responseTimeMs?: number;\n        tokensUsed?: number;\n        success?: boolean;\n        errorMessage?: string;\n    }) {\n        const result = await this.retryQuery(\n            `INSERT INTO agent_usage_logs \n            (user_id, session_id, agent_id, query, response_preview, response_time_ms, tokens_used, success, error_message)\n            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`,\n            [\n                params.userId, params.sessionId, params.agentId,\n                params.query, params.responsePreview,\n                params.responseTimeMs, params.tokensUsed,\n                params.success !== false,\n                params.errorMessage\n            ]\n        );\n        return result;\n    }\n\n    async getAgentStats(agentId: string) {\n        const result = await this.retryQuery(\n            `SELECT \n                COUNT(*) as total_requests,\n                SUM(CASE WHEN success = TRUE THEN 1 ELSE 0 END) as successful_requests,\n                AVG(response_time_ms) as avg_response_time,\n                AVG(tokens_used) as avg_tokens\n            FROM agent_usage_logs\n            WHERE agent_id = $1`,\n            [agentId]\n        );\n        return result.rows[0];\n    }\n\n    // ===== Í∞êÏÇ¨ Î°úÍ∑∏ =====\n\n    async logAudit(params: {\n        action: string;\n        userId?: string;\n        resourceType?: string;\n        resourceId?: string;\n        details?: Record<string, unknown>;\n        ipAddress?: string;\n        userAgent?: string;\n    }) {\n        const result = await this.retryQuery(\n            `INSERT INTO audit_logs \n            (action, user_id, resource_type, resource_id, details, ip_address, user_agent)\n            VALUES ($1, $2, $3, $4, $5, $6, $7)`,\n            [\n                params.action, params.userId, params.resourceType, params.resourceId,\n                JSON.stringify(params.details || {}), params.ipAddress, params.userAgent\n            ]\n        );\n        return result;\n    }\n\n    async getAuditLogs(limit: number = 100) {\n        const result = await this.retryQuery(\n            `SELECT * FROM audit_logs ORDER BY timestamp DESC LIMIT $1`,\n            [limit]\n        );\n        return result.rows;\n    }\n\n    // ===== ÌÜµÍ≥Ñ =====\n\n    async getStats() {\n        const tables = ['users', 'conversation_sessions', 'conversation_messages',\n            'api_usage', 'agent_usage_logs', 'agent_feedback',\n            'custom_agents', 'audit_logs', 'alert_history'];\n\n        const stats: Record<string, number> = {};\n\n        for (const table of tables) {\n            const result = await this.retryQuery(`SELECT COUNT(*) as count FROM ${table}`);\n            stats[table] = parseInt(result.rows[0].count, 10);\n        }\n\n        return stats;\n    }\n\n    // ============================================\n    // üß† Ïû•Í∏∞ Î©îÎ™®Î¶¨ ÏãúÏä§ÌÖú Î©îÏÑúÎìú\n    // ============================================\n\n    async createMemory(params: {\n        id: string;\n        userId: string;\n        category: MemoryCategory;\n        key: string;\n        value: string;\n        importance?: number;\n        sourceSessionId?: string;\n        tags?: string[];\n    }): Promise<void> {\n        await withTransaction(this.pool, async (client) => {\n            await client.query(\n                `INSERT INTO user_memories (id, user_id, category, key, value, importance, source_session_id)\n                VALUES ($1, $2, $3, $4, $5, $6, $7)\n                ON CONFLICT(user_id, category, key) DO UPDATE SET\n                    value = EXCLUDED.value,\n                    importance = CASE WHEN EXCLUDED.importance > user_memories.importance THEN EXCLUDED.importance ELSE user_memories.importance END,\n                    updated_at = NOW(),\n                    access_count = user_memories.access_count + 1`,\n                [\n                    params.id, params.userId, params.category,\n                    params.key, params.value, params.importance || 0.5,\n                    params.sourceSessionId\n                ]\n            );\n\n            // ÌÉúÍ∑∏ Ï†ÄÏû• (Î©ÄÌã∞ Î°úÏö∞ INSERTÎ°ú N+1 ÏøºÎ¶¨ Î∞©ÏßÄ)\n            if (params.tags && params.tags.length > 0) {\n                const tagValues = params.tags.map((_, i) => `($1, $${i + 2})`).join(', ');\n                await client.query(\n                    `INSERT INTO memory_tags (memory_id, tag) VALUES ${tagValues} ON CONFLICT DO NOTHING`,\n                    [params.id, ...params.tags]\n                );\n            }\n        });\n    }\n\n    async getUserMemories(userId: string, options?: {\n        category?: MemoryCategory;\n        limit?: number;\n        minImportance?: number;\n    }): Promise<UserMemory[]> {\n        let query = 'SELECT * FROM user_memories WHERE user_id = $1';\n        const params: QueryParam[] = [userId];\n        let paramIdx = 2;\n\n        if (options?.category) {\n            query += ` AND category = $${paramIdx++}`;\n            params.push(options.category);\n        }\n        if (options?.minImportance) {\n            query += ` AND importance >= $${paramIdx++}`;\n            params.push(options.minImportance);\n        }\n\n        query += ' ORDER BY importance DESC, updated_at DESC';\n\n        if (options?.limit) {\n            query += ` LIMIT $${paramIdx++}`;\n            params.push(options.limit);\n        }\n\n        const result = await this.retryQuery(query, params);\n        return result.rows as UserMemory[];\n    }\n\n    async getRelevantMemories(userId: string, query: string, limit: number = 10): Promise<UserMemory[]> {\n        // Í∞ÑÎã®Ìïú ÌÇ§ÏõåÎìú Í∏∞Î∞ò Í≤ÄÏÉâ (ÎÇòÏ§ëÏóê Î≤°ÌÑ∞ Í≤ÄÏÉâÏúºÎ°ú ÏóÖÍ∑∏Î†àÏù¥Îìú Í∞ÄÎä•)\n        const keywords = query.toLowerCase().split(/\\s+/).filter(w => w.length > 2);\n        \n        if (keywords.length === 0) {\n            return this.getUserMemories(userId, { limit });\n        }\n\n        // ÌÇ§ÏõåÎìú Îß§Ïπ≠ ÏøºÎ¶¨\n        const params: QueryParam[] = [userId];\n        let paramIdx = 2;\n        const conditions = keywords.map(kw => {\n            const p1 = paramIdx++;\n            const p2 = paramIdx++;\n            params.push(`%${kw}%`, `%${kw}%`);\n            return `(LOWER(key) LIKE $${p1} OR LOWER(value) LIKE $${p2})`;\n        }).join(' OR ');\n        \n        params.push(limit);\n        const limitParam = paramIdx++;\n\n        const sqlQuery = `\n            SELECT * FROM user_memories \n            WHERE user_id = $1 AND (${conditions})\n            ORDER BY importance DESC, updated_at DESC\n            LIMIT $${limitParam}\n        `;\n\n        // access_count ÏóÖÎç∞Ïù¥Ìä∏\n        const result = await this.retryQuery(sqlQuery, params);\n        const rows = result.rows as UserMemory[];\n        \n        if (rows.length > 0) {\n            const ids = rows.map(m => m.id);\n            const idPlaceholders = ids.map((_, i) => `$${i + 1}`).join(',');\n            await this.retryQuery(\n                `UPDATE user_memories \n                SET access_count = access_count + 1, last_accessed = NOW() \n                WHERE id IN (${idPlaceholders})`,\n                ids\n            );\n        }\n\n        return rows;\n    }\n\n    async updateMemory(memoryId: string, updates: { value?: string; importance?: number }): Promise<void> {\n        const sets: string[] = ['updated_at = NOW()'];\n        const params: QueryParam[] = [];\n        let paramIdx = 1;\n\n        if (updates.value !== undefined) {\n            sets.push(`value = $${paramIdx++}`);\n            params.push(updates.value);\n        }\n        if (updates.importance !== undefined) {\n            sets.push(`importance = $${paramIdx++}`);\n            params.push(updates.importance);\n        }\n\n        params.push(memoryId);\n        await this.retryQuery(`UPDATE user_memories SET ${sets.join(', ')} WHERE id = $${paramIdx}`, params);\n    }\n\n    async deleteMemory(memoryId: string): Promise<void> {\n        await this.retryQuery('DELETE FROM user_memories WHERE id = $1', [memoryId]);\n    }\n\n    async deleteUserMemories(userId: string): Promise<void> {\n        await this.retryQuery('DELETE FROM user_memories WHERE user_id = $1', [userId]);\n    }\n\n    // ============================================\n    // üîç Deep Research Î©îÏÑúÎìú\n    // ============================================\n\n    async createResearchSession(params: {\n        id: string;\n        userId?: string;\n        topic: string;\n        depth?: ResearchDepth;\n    }): Promise<void> {\n        await this.retryQuery(\n            `INSERT INTO research_sessions (id, user_id, topic, depth) VALUES ($1, $2, $3, $4)`,\n            [params.id, params.userId, params.topic, params.depth || 'standard']\n        );\n    }\n\n    async getResearchSession(sessionId: string): Promise<ResearchSession | undefined> {\n        const result = await this.retryQuery('SELECT * FROM research_sessions WHERE id = $1', [sessionId]);\n        const row = result.rows[0];\n        if (!row) return undefined;\n\n        return {\n            ...row,\n            key_findings: row.key_findings || [],\n            sources: row.sources || []\n        };\n    }\n\n    async updateResearchSession(sessionId: string, updates: {\n        status?: ResearchStatus;\n        progress?: number;\n        summary?: string;\n        keyFindings?: string[];\n        sources?: string[];\n    }): Promise<void> {\n        const sets: string[] = ['updated_at = NOW()'];\n        const params: QueryParam[] = [];\n        let paramIdx = 1;\n\n        if (updates.status) {\n            sets.push(`status = $${paramIdx++}`);\n            params.push(updates.status);\n            if (updates.status === 'completed' || updates.status === 'failed') {\n                sets.push('completed_at = NOW()');\n            }\n        }\n        if (updates.progress !== undefined) {\n            sets.push(`progress = $${paramIdx++}`);\n            params.push(updates.progress);\n        }\n        if (updates.summary !== undefined) {\n            sets.push(`summary = $${paramIdx++}`);\n            params.push(updates.summary);\n        }\n        if (updates.keyFindings) {\n            sets.push(`key_findings = $${paramIdx++}`);\n            params.push(JSON.stringify(updates.keyFindings));\n        }\n        if (updates.sources) {\n            sets.push(`sources = $${paramIdx++}`);\n            params.push(JSON.stringify(updates.sources));\n        }\n\n        params.push(sessionId);\n        await this.retryQuery(`UPDATE research_sessions SET ${sets.join(', ')} WHERE id = $${paramIdx}`, params);\n    }\n\n    async addResearchStep(params: {\n        sessionId: string;\n        stepNumber: number;\n        stepType: string;\n        query?: string;\n        result?: string;\n        sources?: string[];\n        status?: string;\n    }): Promise<void> {\n        await this.retryQuery(\n            `INSERT INTO research_steps (session_id, step_number, step_type, query, result, sources, status)\n            VALUES ($1, $2, $3, $4, $5, $6, $7)`,\n            [\n                params.sessionId, params.stepNumber, params.stepType,\n                params.query, params.result,\n                params.sources ? JSON.stringify(params.sources) : null,\n                params.status || 'pending'\n            ]\n        );\n    }\n\n    async getResearchSteps(sessionId: string): Promise<ResearchStep[]> {\n        const result = await this.retryQuery(\n            `SELECT * FROM research_steps WHERE session_id = $1 ORDER BY step_number ASC`,\n            [sessionId]\n        );\n        return result.rows.map((row) => ({\n            ...row,\n            sources: row.sources || []\n        }));\n    }\n\n    async getUserResearchSessions(userId: string, limit: number = 20): Promise<ResearchSession[]> {\n        const result = await this.retryQuery(\n            `SELECT * FROM research_sessions WHERE user_id = $1 ORDER BY created_at DESC LIMIT $2`,\n            [userId, limit]\n        );\n        return result.rows.map((row) => ({\n            ...row,\n            key_findings: row.key_findings || [],\n            sources: row.sources || []\n        }));\n    }\n\n    // ============================================\n    // üè™ ÎßàÏºìÌîåÎ†àÏù¥Ïä§ Î©îÏÑúÎìú\n    // ============================================\n\n    async publishToMarketplace(params: {\n        id: string;\n        agentId: string;\n        authorId: string;\n        title: string;\n        description?: string;\n        longDescription?: string;\n        category?: string;\n        tags?: string[];\n        icon?: string;\n        price?: number;\n    }): Promise<void> {\n        await this.retryQuery(\n            `INSERT INTO agent_marketplace \n            (id, agent_id, author_id, title, description, long_description, category, tags, icon, price, is_free)\n            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)`,\n            [\n                params.id, params.agentId, params.authorId, params.title,\n                params.description, params.longDescription, params.category,\n                params.tags ? JSON.stringify(params.tags) : null,\n                params.icon || 'ü§ñ',\n                params.price || 0,\n                (params.price || 0) === 0\n            ]\n        );\n    }\n\n    async getMarketplaceAgents(options?: {\n        category?: string;\n        status?: MarketplaceStatus;\n        featured?: boolean;\n        search?: string;\n        limit?: number;\n        offset?: number;\n    }): Promise<MarketplaceAgent[]> {\n        let query = 'SELECT * FROM agent_marketplace WHERE 1=1';\n        const params: QueryParam[] = [];\n        let paramIdx = 1;\n\n        if (options?.status) {\n            query += ` AND status = $${paramIdx++}`;\n            params.push(options.status);\n        } else {\n            query += ` AND status = $${paramIdx++}`;\n            params.push('approved');\n        }\n\n        if (options?.category) {\n            query += ` AND category = $${paramIdx++}`;\n            params.push(options.category);\n        }\n        if (options?.featured) {\n            query += ' AND is_featured = TRUE';\n        }\n        if (options?.search) {\n            query += ` AND (LOWER(title) LIKE $${paramIdx} OR LOWER(description) LIKE $${paramIdx})`;\n            params.push(`%${options.search.toLowerCase()}%`);\n            paramIdx++;\n        }\n\n        query += ' ORDER BY is_featured DESC, downloads DESC, rating_avg DESC';\n\n        if (options?.limit) {\n            query += ` LIMIT $${paramIdx++}`;\n            params.push(options.limit);\n        }\n        if (options?.offset) {\n            query += ` OFFSET $${paramIdx++}`;\n            params.push(options.offset);\n        }\n\n        const result = await this.retryQuery(query, params);\n        return result.rows.map((row) => ({\n            ...row,\n            tags: row.tags || [],\n            is_free: !!row.is_free,\n            is_featured: !!row.is_featured,\n            is_verified: !!row.is_verified\n        }));\n    }\n\n    async getMarketplaceAgent(marketplaceId: string): Promise<MarketplaceAgent | undefined> {\n        const result = await this.retryQuery('SELECT * FROM agent_marketplace WHERE id = $1', [marketplaceId]);\n        const row = result.rows[0];\n        if (!row) return undefined;\n\n        return {\n            ...row,\n            tags: row.tags || [],\n            is_free: !!row.is_free,\n            is_featured: !!row.is_featured,\n            is_verified: !!row.is_verified\n        };\n    }\n\n    async updateMarketplaceStatus(marketplaceId: string, status: MarketplaceStatus): Promise<void> {\n        await this.retryQuery(\n            `UPDATE agent_marketplace \n            SET status = $1, updated_at = NOW(),\n                published_at = CASE WHEN $1 = 'approved' THEN NOW() ELSE published_at END\n            WHERE id = $2`,\n            [status, marketplaceId]\n        );\n    }\n\n    async installAgent(marketplaceId: string, userId: string): Promise<void> {\n        await withTransaction(this.pool, async (client) => {\n            const result = await client.query(\n                `INSERT INTO agent_installations (marketplace_id, user_id)\n                VALUES ($1, $2) ON CONFLICT DO NOTHING`,\n                [marketplaceId, userId]\n            );\n\n            if ((result.rowCount || 0) > 0) {\n                await client.query(\n                    'UPDATE agent_marketplace SET downloads = downloads + 1 WHERE id = $1',\n                    [marketplaceId]\n                );\n            }\n        });\n    }\n\n    async uninstallAgent(marketplaceId: string, userId: string): Promise<void> {\n        await this.retryQuery(\n            'DELETE FROM agent_installations WHERE marketplace_id = $1 AND user_id = $2',\n            [marketplaceId, userId]\n        );\n    }\n\n    async getUserInstalledAgents(userId: string): Promise<MarketplaceAgent[]> {\n        const result = await this.retryQuery(\n            `SELECT m.* FROM agent_marketplace m\n            JOIN agent_installations i ON m.id = i.marketplace_id\n            WHERE i.user_id = $1\n            ORDER BY i.installed_at DESC`,\n            [userId]\n        );\n        return result.rows.map((row) => ({\n            ...row,\n            tags: row.tags || [],\n            is_free: !!row.is_free,\n            is_featured: !!row.is_featured,\n            is_verified: !!row.is_verified\n        }));\n    }\n\n    async addAgentReview(params: {\n        id: string;\n        marketplaceId: string;\n        userId: string;\n        rating: number;\n        title?: string;\n        content?: string;\n    }): Promise<void> {\n        await withTransaction(this.pool, async (client) => {\n            await client.query(\n                `INSERT INTO agent_reviews (id, marketplace_id, user_id, rating, title, content)\n                VALUES ($1, $2, $3, $4, $5, $6)\n                ON CONFLICT(marketplace_id, user_id) DO UPDATE SET\n                    rating = EXCLUDED.rating,\n                    title = EXCLUDED.title,\n                    content = EXCLUDED.content`,\n                [params.id, params.marketplaceId, params.userId, params.rating, params.title, params.content]\n            );\n\n            // ÌèâÍ∑† ÌèâÏ†ê ÏóÖÎç∞Ïù¥Ìä∏\n            await client.query(\n                `UPDATE agent_marketplace SET\n                    rating_avg = (SELECT AVG(rating) FROM agent_reviews WHERE marketplace_id = $1),\n                    rating_count = (SELECT COUNT(*) FROM agent_reviews WHERE marketplace_id = $1)\n                WHERE id = $1`,\n                [params.marketplaceId]\n            );\n        });\n    }\n\n    async getAgentReviews(marketplaceId: string, limit: number = 20): Promise<AgentReview[]> {\n        const result = await this.retryQuery(\n            `SELECT * FROM agent_reviews WHERE marketplace_id = $1 ORDER BY created_at DESC LIMIT $2`,\n            [marketplaceId, limit]\n        );\n        return result.rows as AgentReview[];\n    }\n\n    // ============================================\n    // üìù Canvas Î©îÏÑúÎìú\n    // ============================================\n\n    async createCanvasDocument(params: {\n        id: string;\n        userId: string;\n        sessionId?: string;\n        title: string;\n        docType?: CanvasDocType;\n        content?: string;\n        language?: string;\n    }): Promise<void> {\n        await this.retryQuery(\n            `INSERT INTO canvas_documents (id, user_id, session_id, title, doc_type, content, language)\n            VALUES ($1, $2, $3, $4, $5, $6, $7)`,\n            [\n                params.id, params.userId, params.sessionId,\n                params.title, params.docType || 'document',\n                params.content, params.language\n            ]\n        );\n    }\n\n    async getCanvasDocument(documentId: string): Promise<CanvasDocument | undefined> {\n        const result = await this.retryQuery('SELECT * FROM canvas_documents WHERE id = $1', [documentId]);\n        const row = result.rows[0];\n        if (!row) return undefined;\n\n        return {\n            ...row,\n            is_shared: !!row.is_shared\n        };\n    }\n\n    async updateCanvasDocument(documentId: string, updates: {\n        title?: string;\n        content?: string;\n        changeSummary?: string;\n        updatedBy?: string;\n    }): Promise<void> {\n        await withTransaction(this.pool, async (client) => {\n            // Î≤ÑÏ†Ñ ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•\n            const current = await this.getCanvasDocument(documentId);\n            if (current && updates.content !== undefined && updates.content !== current.content) {\n                await client.query(\n                    `INSERT INTO canvas_versions (document_id, version, content, change_summary, created_by)\n                    VALUES ($1, $2, $3, $4, $5)`,\n                    [\n                        documentId, current.version, current.content || '',\n                        updates.changeSummary || 'Auto-saved version',\n                        updates.updatedBy\n                    ]\n                );\n            }\n\n            const sets: string[] = ['updated_at = NOW()'];\n            const params: QueryParam[] = [];\n            let paramIdx = 1;\n\n            if (updates.title !== undefined) {\n                sets.push(`title = $${paramIdx++}`);\n                params.push(updates.title);\n            }\n            if (updates.content !== undefined) {\n                sets.push(`content = $${paramIdx++}`);\n                sets.push('version = version + 1');\n                params.push(updates.content);\n            }\n\n            params.push(documentId);\n            await client.query(`UPDATE canvas_documents SET ${sets.join(', ')} WHERE id = $${paramIdx}`, params);\n        });\n    }\n\n    async getCanvasVersions(documentId: string): Promise<CanvasVersion[]> {\n        const result = await this.retryQuery(\n            `SELECT * FROM canvas_versions WHERE document_id = $1 ORDER BY version DESC`,\n            [documentId]\n        );\n        return result.rows as CanvasVersion[];\n    }\n\n    async getUserCanvasDocuments(userId: string, limit: number = 50): Promise<CanvasDocument[]> {\n        const result = await this.retryQuery(\n            `SELECT * FROM canvas_documents WHERE user_id = $1 ORDER BY updated_at DESC LIMIT $2`,\n            [userId, limit]\n        );\n        return result.rows.map((row) => ({\n            ...row,\n            is_shared: !!row.is_shared\n        }));\n    }\n\n    async shareCanvasDocument(documentId: string, shareToken: string): Promise<void> {\n        await this.retryQuery(\n            `UPDATE canvas_documents SET is_shared = TRUE, share_token = $1, updated_at = NOW() WHERE id = $2`,\n            [shareToken, documentId]\n        );\n    }\n\n    async getCanvasDocumentByShareToken(shareToken: string): Promise<CanvasDocument | undefined> {\n        const result = await this.retryQuery(\n            'SELECT * FROM canvas_documents WHERE share_token = $1 AND is_shared = TRUE',\n            [shareToken]\n        );\n        const row = result.rows[0];\n        if (!row) return undefined;\n\n        return {\n            ...row,\n            is_shared: !!row.is_shared\n        };\n    }\n\n    async deleteCanvasDocument(documentId: string): Promise<void> {\n        await this.retryQuery('DELETE FROM canvas_documents WHERE id = $1', [documentId]);\n    }\n\n    // ============================================\n    // üîó Ïô∏Î∂Ä ÏÑúÎπÑÏä§ ÌÜµÌï© Î©îÏÑúÎìú\n    // ============================================\n\n    async createExternalConnection(params: {\n        id: string;\n        userId: string;\n        serviceType: ExternalServiceType;\n        accessToken?: string;\n        refreshToken?: string;\n        tokenExpiresAt?: string;\n        accountEmail?: string;\n        accountName?: string;\n        metadata?: Record<string, any>;\n    }): Promise<void> {\n        await this.retryQuery(\n            `INSERT INTO external_connections \n            (id, user_id, service_type, access_token, refresh_token, token_expires_at, account_email, account_name, metadata)\n            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\n            ON CONFLICT(user_id, service_type) DO UPDATE SET\n                access_token = EXCLUDED.access_token,\n                refresh_token = EXCLUDED.refresh_token,\n                token_expires_at = EXCLUDED.token_expires_at,\n                account_email = EXCLUDED.account_email,\n                account_name = EXCLUDED.account_name,\n                metadata = EXCLUDED.metadata,\n                is_active = TRUE,\n                updated_at = NOW()`,\n            [\n                params.id, params.userId, params.serviceType,\n                params.accessToken, params.refreshToken, params.tokenExpiresAt,\n                params.accountEmail, params.accountName,\n                params.metadata ? JSON.stringify(params.metadata) : null\n            ]\n        );\n    }\n\n    async getUserConnections(userId: string): Promise<ExternalConnection[]> {\n        const result = await this.retryQuery(\n            `SELECT * FROM external_connections WHERE user_id = $1 AND is_active = TRUE ORDER BY created_at DESC`,\n            [userId]\n        );\n        return result.rows.map((row) => ({\n            ...row,\n            is_active: !!row.is_active,\n            metadata: row.metadata || {}\n        }));\n    }\n\n    async getExternalConnection(connectionId: string): Promise<ExternalConnection | undefined> {\n        const result = await this.retryQuery('SELECT * FROM external_connections WHERE id = $1', [connectionId]);\n        const row = result.rows[0];\n        if (!row) return undefined;\n\n        return {\n            ...row,\n            is_active: !!row.is_active,\n            metadata: row.metadata || {}\n        };\n    }\n\n    async getUserConnectionByService(userId: string, serviceType: ExternalServiceType): Promise<ExternalConnection | undefined> {\n        const result = await this.retryQuery(\n            'SELECT * FROM external_connections WHERE user_id = $1 AND service_type = $2 AND is_active = TRUE',\n            [userId, serviceType]\n        );\n        const row = result.rows[0];\n        if (!row) return undefined;\n\n        return {\n            ...row,\n            is_active: !!row.is_active,\n            metadata: row.metadata || {}\n        };\n    }\n\n    async updateConnectionTokens(connectionId: string, tokens: {\n        accessToken: string;\n        refreshToken?: string;\n        expiresAt?: string;\n    }): Promise<void> {\n        await this.retryQuery(\n            `UPDATE external_connections \n            SET access_token = $1, refresh_token = COALESCE($2, refresh_token), token_expires_at = $3, updated_at = NOW()\n            WHERE id = $4`,\n            [tokens.accessToken, tokens.refreshToken, tokens.expiresAt, connectionId]\n        );\n    }\n\n    async disconnectService(userId: string, serviceType: ExternalServiceType): Promise<void> {\n        await this.retryQuery(\n            `UPDATE external_connections \n            SET is_active = FALSE, access_token = NULL, refresh_token = NULL, updated_at = NOW()\n            WHERE user_id = $1 AND service_type = $2`,\n            [userId, serviceType]\n        );\n    }\n\n    // Ïô∏Î∂Ä ÌååÏùº Ï∫êÏãú\n    async cacheExternalFile(params: {\n        id: string;\n        connectionId: string;\n        externalId: string;\n        fileName: string;\n        fileType?: string;\n        fileSize?: number;\n        webUrl?: string;\n        cachedContent?: string;\n    }): Promise<void> {\n        await this.retryQuery(\n            `INSERT INTO external_files \n            (id, connection_id, external_id, file_name, file_type, file_size, web_url, cached_content, last_synced)\n            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, NOW())\n            ON CONFLICT(connection_id, external_id) DO UPDATE SET\n                file_name = EXCLUDED.file_name,\n                file_type = EXCLUDED.file_type,\n                file_size = EXCLUDED.file_size,\n                web_url = EXCLUDED.web_url,\n                cached_content = EXCLUDED.cached_content,\n                last_synced = NOW()`,\n            [\n                params.id, params.connectionId, params.externalId,\n                params.fileName, params.fileType, params.fileSize,\n                params.webUrl, params.cachedContent\n            ]\n        );\n    }\n\n    async getConnectionFiles(connectionId: string, limit: number = 100): Promise<ExternalFile[]> {\n        const result = await this.retryQuery(\n            `SELECT * FROM external_files WHERE connection_id = $1 ORDER BY last_synced DESC LIMIT $2`,\n            [connectionId, limit]\n        );\n        return result.rows as ExternalFile[];\n    }\n\n    async getCachedFile(connectionId: string, externalId: string): Promise<ExternalFile | undefined> {\n        const result = await this.retryQuery(\n            'SELECT * FROM external_files WHERE connection_id = $1 AND external_id = $2',\n            [connectionId, externalId]\n        );\n        return result.rows[0] as ExternalFile | undefined;\n    }\n\n    // ============================================\n    // üîå MCP Ïô∏Î∂Ä ÏÑúÎ≤Ñ Î©îÏÑúÎìú\n    // ============================================\n\n    async getMcpServers(): Promise<MCPServerRow[]> {\n        const result = await this.retryQuery(\n            'SELECT * FROM mcp_servers ORDER BY created_at DESC'\n        );\n        return result.rows.map((row: DbRow) => ({\n            ...row,\n            args: (row.args as string[] | null) || null,\n            env: (row.env as Record<string, string> | null) || null,\n            enabled: !!row.enabled,\n        })) as MCPServerRow[];\n    }\n\n    async getMcpServerById(id: string): Promise<MCPServerRow | null> {\n        const result = await this.retryQuery(\n            'SELECT * FROM mcp_servers WHERE id = $1',\n            [id]\n        );\n        const row = result.rows[0] as DbRow | undefined;\n        if (!row) return null;\n\n        return {\n            ...row,\n            args: (row.args as string[] | null) || null,\n            env: (row.env as Record<string, string> | null) || null,\n            enabled: !!row.enabled,\n        } as MCPServerRow;\n    }\n\n    async createMcpServer(server: Omit<MCPServerRow, 'created_at' | 'updated_at'>): Promise<MCPServerRow> {\n        const result = await this.retryQuery(\n            `INSERT INTO mcp_servers (id, name, transport_type, command, args, env, url, enabled)\n            VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\n            RETURNING *`,\n            [\n                server.id, server.name, server.transport_type,\n                server.command, server.args ? JSON.stringify(server.args) : null,\n                server.env ? JSON.stringify(server.env) : null,\n                server.url, server.enabled\n            ]\n        );\n        const row = result.rows[0] as DbRow;\n        return {\n            ...row,\n            args: (row.args as string[] | null) || null,\n            env: (row.env as Record<string, string> | null) || null,\n            enabled: !!row.enabled,\n        } as MCPServerRow;\n    }\n\n    async updateMcpServer(id: string, updates: Partial<Pick<MCPServerRow, 'name' | 'transport_type' | 'command' | 'args' | 'env' | 'url' | 'enabled'>>): Promise<MCPServerRow | null> {\n        const sets: string[] = ['updated_at = NOW()'];\n        const params: QueryParam[] = [];\n        let paramIdx = 1;\n\n        if (updates.name !== undefined) {\n            sets.push(`name = $${paramIdx++}`);\n            params.push(updates.name);\n        }\n        if (updates.transport_type !== undefined) {\n            sets.push(`transport_type = $${paramIdx++}`);\n            params.push(updates.transport_type);\n        }\n        if (updates.command !== undefined) {\n            sets.push(`command = $${paramIdx++}`);\n            params.push(updates.command);\n        }\n        if (updates.args !== undefined) {\n            sets.push(`args = $${paramIdx++}`);\n            params.push(updates.args ? JSON.stringify(updates.args) : null);\n        }\n        if (updates.env !== undefined) {\n            sets.push(`env = $${paramIdx++}`);\n            params.push(updates.env ? JSON.stringify(updates.env) : null);\n        }\n        if (updates.url !== undefined) {\n            sets.push(`url = $${paramIdx++}`);\n            params.push(updates.url);\n        }\n        if (updates.enabled !== undefined) {\n            sets.push(`enabled = $${paramIdx++}`);\n            params.push(updates.enabled);\n        }\n\n        params.push(id);\n        const result = await this.retryQuery(\n            `UPDATE mcp_servers SET ${sets.join(', ')} WHERE id = $${paramIdx} RETURNING *`,\n            params\n        );\n\n        const row = result.rows[0] as DbRow | undefined;\n        if (!row) return null;\n\n        return {\n            ...row,\n            args: (row.args as string[] | null) || null,\n            env: (row.env as Record<string, string> | null) || null,\n            enabled: !!row.enabled,\n        } as MCPServerRow;\n    }\n\n    async deleteMcpServer(id: string): Promise<boolean> {\n        const result = await this.retryQuery(\n            'DELETE FROM mcp_servers WHERE id = $1',\n            [id]\n        );\n        return (result.rowCount || 0) > 0;\n    }\n\n    // ===== Ïú†Ìã∏Î¶¨Ìã∞ =====\n\n    async close(): Promise<void> {\n        await this.pool.end();\n        console.log('[UnifiedDB] Ïó∞Í≤∞ Ï¢ÖÎ£å');\n    }\n}\n\n// Ïã±Í∏ÄÌÜ§ Ïù∏Ïä§ÌÑ¥Ïä§\nlet dbInstance: UnifiedDatabase | null = null;\n\nexport function getUnifiedDatabase(): UnifiedDatabase {\n    if (!dbInstance) {\n        dbInstance = new UnifiedDatabase();\n    }\n    return dbInstance;\n}\n\n/**\n * Pool ÏßÅÏ†ë Ï†ëÍ∑º (raw SQL ÏÜåÎπÑÏûêÏö©)\n */\nexport function getPool(): Pool {\n    return getUnifiedDatabase().getPool();\n}\n\nexport async function closeDatabase(): Promise<void> {\n    if (dbInstance) {\n        await dbInstance.close();\n        dbInstance = null;\n    }\n}\n"],"version":3}