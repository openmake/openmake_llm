{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/ollama/api-key-manager.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/ollama/api-key-manager.ts"],"sourcesContent":["/**\n * API Key Manager with Automatic Multi-Key Rotation\n * üÜï Î¨¥Ï†úÌïú API ÌÇ§ ÏûêÎèô ÏàúÌôò Î°úÏßÅ (OLLAMA_API_KEY_1, _2, _3, ... _N)\n * üÜï A2A Î≥ëÎ†¨ Î™®Îç∏ ÏßÄÏõê: Í∞Å ÌÇ§Î≥Ñ Í∞úÎ≥Ñ Î™®Îç∏ ÏÑ§Ï†ï (OLLAMA_MODEL_1, _2, ... _N)\n */\n\nimport { getConfig } from '../config/env';\n\n/**\n * ÌÇ§-Î™®Îç∏ Ïåç Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ (A2A Î≥ëÎ†¨ Ï≤òÎ¶¨Ïö©)\n */\nexport interface KeyModelPair {\n    key: string;\n    model: string;\n    index: number;\n}\n\nexport interface ApiKeyConfig {\n    keys: string[];\n    models?: string[];  // Í∞Å ÌÇ§Ïóê ÎåÄÏùëÌïòÎäî Î™®Îç∏ Î∞∞Ïó¥\n    sshKey?: string;\n}\n\nexport class ApiKeyManager {\n    private keys: string[] = [];\n    private models: string[] = [];  // üÜï Í∞Å ÌÇ§Ïóê ÎåÄÏùëÌïòÎäî Î™®Îç∏\n    private currentKeyIndex = 0;\n    private sshKey: string | undefined;\n    private failureCount = 0;\n    private readonly maxFailures = 2;  // Îçî Îπ†Î•∏ Ïä§ÏôÄÌïë\n    private lastFailoverTime: Date | null = null;\n    private keyFailures: Map<number, { count: number; lastFail: Date }> = new Map();\n\n    constructor(config?: Partial<ApiKeyConfig>) {\n        const envConfig = getConfig();\n        \n        // üÜï ÌôòÍ≤ΩÎ≥ÄÏàòÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Î™®Îì† API ÌÇ§ Î°úÎìú (OLLAMA_API_KEY_1, _2, _3, ... _N)\n        if (config?.keys && config.keys.length > 0) {\n            this.keys = config.keys.filter(k => k && k.trim() !== '');\n        } else {\n            this.keys = this.loadKeysFromEnv();\n        }\n\n        // üÜï Í∞Å ÌÇ§Ïóê ÎåÄÏùëÌïòÎäî Î™®Îç∏ Î°úÎìú\n        if (config?.models && config.models.length > 0) {\n            this.models = config.models;\n        } else {\n            this.models = envConfig.ollamaModels || [];\n        }\n\n        this.sshKey = config?.sshKey || envConfig.ollamaSshKey || undefined;\n\n        console.log(`[ApiKeyManager] üîë Ï¥àÍ∏∞ÌôîÎê® - ${this.keys.length}Í∞ú API ÌÇ§, ${this.models.length}Í∞ú Î™®Îç∏ Îì±Î°ù`);\n        this.keys.forEach((key, idx) => {\n            const masked = key.substring(0, 8) + '...' + key.substring(key.length - 4);\n            const model = this.models[idx] || envConfig.ollamaDefaultModel || 'default';\n            console.log(`[ApiKeyManager]   Key ${idx + 1}: ${masked} ‚Üí Model: ${model}`);\n        });\n        console.log(`[ApiKeyManager] SSH Key: ${this.sshKey ? 'ÏÑ§Ï†ïÎê®' : 'ÏóÜÏùå'}`);\n    }\n\n    /**\n     * üÜï ÌôòÍ≤ΩÎ≥ÄÏàòÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú API ÌÇ§ Î°úÎìú\n     * OLLAMA_API_KEY_1, OLLAMA_API_KEY_2, ... OLLAMA_API_KEY_N ÏàúÏÑúÎ°ú ÌÉêÏÉâ\n     * Î†àÍ±∞Ïãú ÏßÄÏõê: OLLAMA_API_KEY_PRIMARY, OLLAMA_API_KEY_SECONDARY\n     */\n    private loadKeysFromEnv(): string[] {\n        const keys: string[] = [];\n\n        // ÏÉàÎ°úÏö¥ ÌòïÏãù: OLLAMA_API_KEY_1, _2, _3, ... (Î¨¥Ï†úÌïú)\n        let index = 1;\n        while (true) {\n            const key = process.env[`OLLAMA_API_KEY_${index}`];\n            if (key && key.trim() !== '') {\n                keys.push(key.trim());\n                index++;\n            } else {\n                break;\n            }\n        }\n\n        // Î†àÍ±∞Ïãú ÌòïÏãù ÏßÄÏõê (ÏÉà ÌòïÏãùÏóê ÌÇ§Í∞Ä ÏóÜÏùÑ ÎïåÎßå)\n        if (keys.length === 0) {\n            const cfg = getConfig();\n            const primary = cfg.ollamaApiKeyPrimary || cfg.ollamaApiKey;\n            const secondary = cfg.ollamaApiKeySecondary;\n\n            if (primary && primary.trim() !== '') keys.push(primary.trim());\n            if (secondary && secondary.trim() !== '') keys.push(secondary.trim());\n        }\n\n        return keys;\n    }\n\n    /**\n     * ÌòÑÏû¨ ÏÇ¨Ïö©Ìï† API ÌÇ§ Î∞òÌôò\n     */\n    getCurrentKey(): string {\n        if (this.keys.length === 0) return '';\n        return this.keys[this.currentKeyIndex];\n    }\n\n    /**\n     * üÜï ÌòÑÏû¨ ÌÇ§Ïóê ÎåÄÏùëÌïòÎäî Î™®Îç∏ Î∞òÌôò\n     */\n    getCurrentModel(): string {\n        if (this.models.length === 0 || this.currentKeyIndex >= this.models.length) {\n            return getConfig().ollamaDefaultModel;\n        }\n        return this.models[this.currentKeyIndex];\n    }\n\n    /**\n     * ÌòÑÏû¨ ÌÇ§ Ïù∏Îç±Ïä§ Î∞òÌôò\n     */\n    getCurrentKeyIndex(): number {\n        return this.currentKeyIndex;\n    }\n\n    /**\n     * Ï†ÑÏ≤¥ ÌÇ§ Í∞úÏàò Î∞òÌôò\n     */\n    getTotalKeys(): number {\n        return this.keys.length;\n    }\n\n    /**\n     * API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏\n     */\n    hasValidKey(): boolean {\n        return this.keys.length > 0;\n    }\n\n    /**\n     * SSH ÌÇ§ Î∞òÌôò\n     */\n    getSshKey(): string | undefined {\n        return this.sshKey;\n    }\n\n    /**\n     * üÜï ÌäπÏ†ï Ïù∏Îç±Ïä§Ïùò ÌÇ§-Î™®Îç∏ Ïåç Î∞òÌôò (A2A Î≥ëÎ†¨ Ï≤òÎ¶¨Ïö©)\n     */\n    getKeyModelPair(index: number): KeyModelPair | null {\n        if (index < 0 || index >= this.keys.length) return null;\n        \n        return {\n            key: this.keys[index],\n            model: this.models[index] || getConfig().ollamaDefaultModel,\n            index\n        };\n    }\n\n    /**\n     * üÜï Î™®Îì† ÌÇ§-Î™®Îç∏ Ïåç Î∞òÌôò (A2A Î≥ëÎ†¨ Ï≤òÎ¶¨Ïö©)\n     */\n    getAllKeyModelPairs(): KeyModelPair[] {\n        const defaultModel = getConfig().ollamaDefaultModel;\n        return this.keys.map((key, index) => ({\n            key,\n            model: this.models[index] || defaultModel,\n            index\n        }));\n    }\n\n    /**\n     * üÜï ÌäπÏ†ï Ïù∏Îç±Ïä§Ïùò Authorization Ìó§Îçî ÏÉùÏÑ± (A2A Î≥ëÎ†¨ Ï≤òÎ¶¨Ïö©)\n     */\n    getAuthHeadersForIndex(index: number): Record<string, string> {\n        if (index < 0 || index >= this.keys.length) return {};\n        return {\n            'Authorization': `Bearer ${this.keys[index]}`\n        };\n    }\n\n    /**\n     * ÏöîÏ≤≠ ÏÑ±Í≥µ Ïãú Ìò∏Ï∂ú\n     */\n    reportSuccess(): void {\n        this.failureCount = 0;\n        // ÌòÑÏû¨ ÌÇ§Ïùò Ïã§Ìå® Í∏∞Î°ù Ï¥àÍ∏∞Ìôî\n        this.keyFailures.delete(this.currentKeyIndex);\n    }\n\n    /**\n     * ÏöîÏ≤≠ Ïã§Ìå® Ïãú Ìò∏Ï∂ú - ÏûêÎèô Î°úÌÖåÏù¥ÏÖò Ï≤òÎ¶¨\n     */\n    reportFailure(error?: unknown): boolean {\n        this.failureCount++;\n        const err = error as { response?: { status?: number }; code?: string } | undefined;\n        const errorCode = err?.response?.status || err?.code || 'unknown';\n\n        // ÌòÑÏû¨ ÌÇ§Ïùò Ïã§Ìå® Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏\n        const currentFailure = this.keyFailures.get(this.currentKeyIndex) || { count: 0, lastFail: new Date() };\n        currentFailure.count++;\n        currentFailure.lastFail = new Date();\n        this.keyFailures.set(this.currentKeyIndex, currentFailure);\n\n        const masked = this.getCurrentKey().substring(0, 8) + '...';\n        console.warn(`[ApiKeyManager] ‚ö†Ô∏è Key ${this.currentKeyIndex + 1} (${masked}) Ïã§Ìå® - ÏΩîÎìú: ${errorCode}`);\n\n        // Ïù∏Ï¶ù Í¥ÄÎ†® ÏóêÎü¨Ïù∏ Í≤ΩÏö∞ Ï¶âÏãú Îã§Ïùå ÌÇ§Î°ú Ï†ÑÌôò\n        const isAuthError = errorCode === 401 || errorCode === 403 || errorCode === 429;\n\n        if (this.failureCount >= this.maxFailures || isAuthError) {\n            return this.rotateToNextKey();\n        }\n\n        return false;\n    }\n\n    /**\n     * Îã§Ïùå ÌÇ§Î°ú ÏàúÌôò\n     */\n    private rotateToNextKey(): boolean {\n        if (this.keys.length <= 1) {\n            console.error(`[ApiKeyManager] ‚ùå ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Îã§Î•∏ ÌÇ§Í∞Ä ÏóÜÏäµÎãàÎã§.`);\n            return false;\n        }\n\n        const previousIndex = this.currentKeyIndex;\n\n        // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Îã§Ïùå ÌÇ§ Ï∞æÍ∏∞ (ÏµúÍ∑º Ïã§Ìå® Í∏∞Î°ùÏù¥ ÏóÜÎäî ÌÇ§ Ïö∞ÏÑ†)\n        let nextIndex = (this.currentKeyIndex + 1) % this.keys.length;\n        let attempts = 0;\n\n        while (attempts < this.keys.length) {\n            const failureRecord = this.keyFailures.get(nextIndex);\n\n            // Ïã§Ìå® Í∏∞Î°ùÏù¥ ÏóÜÍ±∞ÎÇò 5Î∂Ñ Ïù¥ÏÉÅ ÏßÄÎÇú ÌÇ§ Ï∞æÍ∏∞\n            if (!failureRecord || (Date.now() - failureRecord.lastFail.getTime() > 5 * 60 * 1000)) {\n                break;\n            }\n\n            nextIndex = (nextIndex + 1) % this.keys.length;\n            attempts++;\n        }\n\n        this.currentKeyIndex = nextIndex;\n        this.failureCount = 0;\n        this.lastFailoverTime = new Date();\n\n        const previousMasked = this.keys[previousIndex].substring(0, 8) + '...';\n        const newMasked = this.getCurrentKey().substring(0, 8) + '...';\n        const newModel = this.getCurrentModel();\n        console.log(`[ApiKeyManager] üîÑ ÌÇ§ Ï†ÑÌôò: Key ${previousIndex + 1} (${previousMasked}) ‚Üí Key ${nextIndex + 1} (${newMasked}) [Model: ${newModel}]`);\n\n        return true;\n    }\n\n    /**\n     * Ï≤´ Î≤àÏß∏ ÌÇ§Î°ú Î¶¨ÏÖã\n     */\n    reset(): void {\n        this.currentKeyIndex = 0;\n        this.failureCount = 0;\n        this.lastFailoverTime = null;\n        this.keyFailures.clear();\n        console.log(`[ApiKeyManager] üîÑ Key 1ÏúºÎ°ú Î¶¨ÏÖãÎê®`);\n    }\n\n    /**\n     * üÜï ÌäπÏ†ï Ïù∏Îç±Ïä§Î°ú Í∞ïÏ†ú Ï†ÑÌôò (A2AÏö©)\n     */\n    setKeyIndex(index: number): boolean {\n        if (index < 0 || index >= this.keys.length) {\n            console.error(`[ApiKeyManager] ‚ùå Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïù∏Îç±Ïä§: ${index}`);\n            return false;\n        }\n        this.currentKeyIndex = index;\n        this.failureCount = 0;\n        const masked = this.getCurrentKey().substring(0, 8) + '...';\n        const model = this.getCurrentModel();\n        console.log(`[ApiKeyManager] üéØ Key ${index + 1} (${masked}) Í∞ïÏ†ú ÏÑ†ÌÉù [Model: ${model}]`);\n        return true;\n    }\n\n    /**\n     * üÜï Î™®Îì† ÌÇ§Í∞Ä Ïø®Îã§Ïö¥ ÏÉÅÌÉúÏù∏ÏßÄ ÌôïÏù∏ÌïòÍ≥†, Í∞ÄÏû• Îπ®Î¶¨ ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏãúÍ∞Ñ Î∞òÌôò\n     * @returns null if at least one key is available, or the earliest reset time if all keys are in cooldown\n     */\n    getNextResetTime(): Date | null {\n        if (this.keys.length === 0) {\n            return null; // ÌÇ§Í∞Ä ÏóÜÏúºÎ©¥ null Î∞òÌôò\n        }\n\n        const now = Date.now();\n        const cooldownMs = 5 * 60 * 1000; // 5Î∂Ñ Ïø®Îã§Ïö¥ (rotateToNextKeyÏôÄ ÎèôÏùº)\n        let allKeysInCooldown = true;\n        let earliestResetTime: number = Infinity;\n\n        for (let i = 0; i < this.keys.length; i++) {\n            const failureRecord = this.keyFailures.get(i);\n            \n            if (!failureRecord) {\n                // Ïã§Ìå® Í∏∞Î°ùÏù¥ ÏóÜÏúºÎ©¥ ÏÇ¨Ïö© Í∞ÄÎä•\n                allKeysInCooldown = false;\n                break;\n            }\n\n            const resetTime = failureRecord.lastFail.getTime() + cooldownMs;\n            \n            if (resetTime <= now) {\n                // Ïø®Îã§Ïö¥Ïù¥ ÎÅùÎÇ¨ÏúºÎ©¥ ÏÇ¨Ïö© Í∞ÄÎä•\n                allKeysInCooldown = false;\n                break;\n            }\n\n            // Í∞ÄÏû• Îπ†Î•∏ Î¶¨ÏÖã ÏãúÍ∞Ñ Ï∂îÏ†Å\n            if (resetTime < earliestResetTime) {\n                earliestResetTime = resetTime;\n            }\n        }\n\n        if (allKeysInCooldown && earliestResetTime !== Infinity) {\n            return new Date(earliestResetTime);\n        }\n\n        return null;\n    }\n\n    /**\n     * üÜï ÌòÑÏû¨ Ïø®Îã§Ïö¥ Ï§ëÏù∏ ÌÇ§ Í∞úÏàò Î∞òÌôò\n     */\n    getKeysInCooldownCount(): number {\n        const now = Date.now();\n        const cooldownMs = 5 * 60 * 1000;\n        let count = 0;\n\n        for (let i = 0; i < this.keys.length; i++) {\n            const failureRecord = this.keyFailures.get(i);\n            if (failureRecord) {\n                const resetTime = failureRecord.lastFail.getTime() + cooldownMs;\n                if (resetTime > now) {\n                    count++;\n                }\n            }\n        }\n\n        return count;\n    }\n\n    /**\n     * üÜï Î™®Îì† ÌÇ§Í∞Ä ÏÜåÏßÑÎêòÏóàÎäîÏßÄ ÌôïÏù∏\n     */\n    isAllKeysExhausted(): boolean {\n        return this.getNextResetTime() !== null;\n    }\n\n    /**\n     * ÌòÑÏû¨ ÏÉÅÌÉú Ï°∞Ìöå\n     */\n    getStatus(): {\n        activeKeyIndex: number;\n        totalKeys: number;\n        failures: number;\n        lastFailover: Date | null;\n        keyStatuses: { index: number; model: string; failCount: number; lastFail: Date | null }[];\n    } {\n        const defaultModel = getConfig().ollamaDefaultModel;\n        const keyStatuses = this.keys.map((_, idx) => {\n            const failure = this.keyFailures.get(idx);\n            return {\n                index: idx,\n                model: this.models[idx] || defaultModel,\n                failCount: failure?.count || 0,\n                lastFail: failure?.lastFail || null\n            };\n        });\n\n        return {\n            activeKeyIndex: this.currentKeyIndex,\n            totalKeys: this.keys.length,\n            failures: this.failureCount,\n            lastFailover: this.lastFailoverTime,\n            keyStatuses\n        };\n    }\n\n    /**\n     * Authorization Ìó§Îçî ÏÉùÏÑ±\n     */\n    getAuthHeaders(): Record<string, string> {\n        const key = this.getCurrentKey();\n        if (!key) return {};\n\n        return {\n            'Authorization': `Bearer ${key}`\n        };\n    }\n}\n\n// Ïã±Í∏ÄÌÜ§ Ïù∏Ïä§ÌÑ¥Ïä§\nlet apiKeyManager: ApiKeyManager | null = null;\n\nexport function getApiKeyManager(): ApiKeyManager {\n    if (!apiKeyManager) {\n        apiKeyManager = new ApiKeyManager();\n    }\n    return apiKeyManager;\n}\n\nexport function resetApiKeyManager(): void {\n    apiKeyManager = null;\n}\n"],"version":3}