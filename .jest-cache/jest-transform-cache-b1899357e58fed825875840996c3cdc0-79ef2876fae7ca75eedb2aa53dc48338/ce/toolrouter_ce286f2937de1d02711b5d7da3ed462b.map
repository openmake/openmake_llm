{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/mcp/tool-router.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/mcp/tool-router.ts"],"sourcesContent":["/**\n * ToolRouter — 통합 도구 레지스트리\n * 내장 도구(builtInTools)와 외부 MCP 서버 도구를 하나의 인터페이스로 통합합니다.\n */\n\nimport type { MCPTool, MCPToolResult, ExternalToolEntry } from './types';\nimport { MCP_NAMESPACE_SEPARATOR } from './types';\nimport type { MCPToolDefinition } from './types';\nimport { builtInTools } from './tools';\nimport type { UserTier } from '../data/user-manager';\nimport { canUseTool } from './tool-tiers';\nimport type { UserContext } from './user-sandbox';\n\n/** 외부 도구 실행기 함수 타입 */\ntype ExternalToolExecutor = (name: string, args: Record<string, unknown>) => Promise<MCPToolResult>;\n\n/** Ollama 호환 도구 형식 */\ninterface OllamaTool {\n    type: 'function';\n    function: {\n        name: string;\n        description: string;\n        parameters: {\n            type: string;\n            properties: Record<string, unknown>;\n            required?: string[];\n        };\n    };\n}\n\nexport class ToolRouter {\n    /** 외부 도구 레지스트리: namespacedName → ExternalToolEntry */\n    private externalTools: Map<string, ExternalToolEntry> = new Map();\n\n    /** 외부 도구 실행기: serverId → executor function */\n    private externalExecutors: Map<string, ExternalToolExecutor> = new Map();\n\n    /** 모든 도구(내장+외부) MCPTool 목록 반환 */\n    getAllTools(): MCPTool[] {\n        const tools: MCPTool[] = [];\n\n        // 내장 도구\n        for (const def of builtInTools) {\n            tools.push(def.tool);\n        }\n\n        // 외부 도구 (네임스페이스 적용된 이름 사용)\n        for (const entry of this.externalTools.values()) {\n            tools.push({\n                ...entry.tool,\n                name: entry.namespacedName,\n            });\n        }\n\n        return tools;\n    }\n\n    /** 사용자 등급별 필터링된 도구 목록 */\n    getToolsForTier(tier: UserTier): MCPTool[] {\n        return this.getAllTools().filter(tool => canUseTool(tier, tool.name));\n    }\n\n    /**\n     * 도구 실행 — 내장이면 직접 handler, 외부면 ExternalMCPClient로 라우팅\n     * \n     * ⚙️ Phase 3: UserContext 전달 추가 (2026-02-07)\n     * 내장 도구 handler에 context를 전달하여, 도구가 사용자 정보를 참조할 수 있도록 합니다.\n     */\n    async executeTool(name: string, args: Record<string, unknown>, context?: UserContext): Promise<MCPToolResult> {\n        // 1. 외부 도구 확인 (:: 네임스페이스)\n        if (name.includes(MCP_NAMESPACE_SEPARATOR)) {\n            const externalEntry = this.externalTools.get(name);\n            if (!externalEntry) {\n                return {\n                    content: [{ type: 'text', text: `외부 도구를 찾을 수 없습니다: ${name}` }],\n                    isError: true,\n                };\n            }\n\n            const executor = this.externalExecutors.get(externalEntry.serverId);\n            if (!executor) {\n                return {\n                    content: [{ type: 'text', text: `서버 \"${externalEntry.serverName}\"의 실행기를 찾을 수 없습니다.` }],\n                    isError: true,\n                };\n            }\n\n            // 외부 서버에는 원본 이름으로 호출\n            return executor(externalEntry.originalName, args);\n        }\n\n        // 2. 내장 도구 확인\n        const builtIn = builtInTools.find((def: MCPToolDefinition) => def.tool.name === name);\n        if (builtIn) {\n            try {\n                return await builtIn.handler(args, context);\n            } catch (error) {\n                const message = error instanceof Error ? error.message : String(error);\n                return {\n                    content: [{ type: 'text', text: `도구 실행 오류 (${name}): ${message}` }],\n                    isError: true,\n                };\n            }\n        }\n\n        return {\n            content: [{ type: 'text', text: `도구를 찾을 수 없습니다: ${name}` }],\n            isError: true,\n        };\n    }\n\n    /** Ollama 호환 도구 형식으로 변환 */\n    getOllamaTools(tier: UserTier): OllamaTool[] {\n        const tools = this.getToolsForTier(tier);\n        return tools.map(tool => ({\n            type: 'function' as const,\n            function: {\n                name: tool.name,\n                description: tool.description,\n                parameters: {\n                    type: tool.inputSchema.type,\n                    properties: tool.inputSchema.properties,\n                    required: tool.inputSchema.required,\n                },\n            },\n        }));\n    }\n\n    /** 외부 서버의 도구 일괄 등록 */\n    registerExternalTools(\n        serverId: string,\n        serverName: string,\n        tools: MCPTool[],\n        executor: ExternalToolExecutor\n    ): void {\n        // 기존 도구 먼저 해제\n        this.unregisterExternalTools(serverId);\n\n        // 실행기 등록\n        this.externalExecutors.set(serverId, executor);\n\n        // 도구 등록 (네임스페이스 적용)\n        for (const tool of tools) {\n            const namespacedName = `${serverName}${MCP_NAMESPACE_SEPARATOR}${tool.name}`;\n            const entry: ExternalToolEntry = {\n                serverId,\n                serverName,\n                originalName: tool.name,\n                namespacedName,\n                tool,\n            };\n            this.externalTools.set(namespacedName, entry);\n        }\n\n        console.log(`[ToolRouter] Registered ${tools.length} tools from \"${serverName}\" (serverId: ${serverId})`);\n    }\n\n    /** 외부 서버의 도구 일괄 해제 */\n    unregisterExternalTools(serverId: string): void {\n        const keysToRemove: string[] = [];\n        for (const [key, entry] of this.externalTools) {\n            if (entry.serverId === serverId) {\n                keysToRemove.push(key);\n            }\n        }\n\n        for (const key of keysToRemove) {\n            this.externalTools.delete(key);\n        }\n\n        this.externalExecutors.delete(serverId);\n\n        if (keysToRemove.length > 0) {\n            console.log(`[ToolRouter] Unregistered ${keysToRemove.length} tools for serverId: ${serverId}`);\n        }\n    }\n\n    /** 등록된 외부 도구 수 */\n    getExternalToolCount(): number {\n        return this.externalTools.size;\n    }\n\n    /** 내장 도구 수 */\n    getBuiltInToolCount(): number {\n        return builtInTools.length;\n    }\n\n    /** 특정 도구가 외부 도구인지 확인 */\n    isExternalTool(name: string): boolean {\n        return name.includes(MCP_NAMESPACE_SEPARATOR);\n    }\n}\n"],"version":3}