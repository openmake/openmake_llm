2631000aa3805eb4bb6f72a38afb021c
"use strict";
/**
 * ToolRouter — 통합 도구 레지스트리
 * 내장 도구(builtInTools)와 외부 MCP 서버 도구를 하나의 인터페이스로 통합합니다.
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ToolRouter = void 0;
const types_1 = require("./types");
const tools_1 = require("./tools");
const tool_tiers_1 = require("./tool-tiers");
class ToolRouter {
    constructor() {
        /** 외부 도구 레지스트리: namespacedName → ExternalToolEntry */
        this.externalTools = new Map();
        /** 외부 도구 실행기: serverId → executor function */
        this.externalExecutors = new Map();
    }
    /** 모든 도구(내장+외부) MCPTool 목록 반환 */
    getAllTools() {
        const tools = [];
        // 내장 도구
        for (const def of tools_1.builtInTools) {
            tools.push(def.tool);
        }
        // 외부 도구 (네임스페이스 적용된 이름 사용)
        for (const entry of this.externalTools.values()) {
            tools.push(Object.assign(Object.assign({}, entry.tool), { name: entry.namespacedName }));
        }
        return tools;
    }
    /** 사용자 등급별 필터링된 도구 목록 */
    getToolsForTier(tier) {
        return this.getAllTools().filter(tool => (0, tool_tiers_1.canUseTool)(tier, tool.name));
    }
    /**
     * 도구 실행 — 내장이면 직접 handler, 외부면 ExternalMCPClient로 라우팅
     *
     * ⚙️ Phase 3: UserContext 전달 추가 (2026-02-07)
     * 내장 도구 handler에 context를 전달하여, 도구가 사용자 정보를 참조할 수 있도록 합니다.
     */
    executeTool(name, args, context) {
        return __awaiter(this, void 0, void 0, function* () {
            // 1. 외부 도구 확인 (:: 네임스페이스)
            if (name.includes(types_1.MCP_NAMESPACE_SEPARATOR)) {
                const externalEntry = this.externalTools.get(name);
                if (!externalEntry) {
                    return {
                        content: [{ type: 'text', text: `외부 도구를 찾을 수 없습니다: ${name}` }],
                        isError: true,
                    };
                }
                const executor = this.externalExecutors.get(externalEntry.serverId);
                if (!executor) {
                    return {
                        content: [{ type: 'text', text: `서버 "${externalEntry.serverName}"의 실행기를 찾을 수 없습니다.` }],
                        isError: true,
                    };
                }
                // 외부 서버에는 원본 이름으로 호출
                return executor(externalEntry.originalName, args);
            }
            // 2. 내장 도구 확인
            const builtIn = tools_1.builtInTools.find((def) => def.tool.name === name);
            if (builtIn) {
                try {
                    return yield builtIn.handler(args, context);
                }
                catch (error) {
                    const message = error instanceof Error ? error.message : String(error);
                    return {
                        content: [{ type: 'text', text: `도구 실행 오류 (${name}): ${message}` }],
                        isError: true,
                    };
                }
            }
            return {
                content: [{ type: 'text', text: `도구를 찾을 수 없습니다: ${name}` }],
                isError: true,
            };
        });
    }
    /** Ollama 호환 도구 형식으로 변환 */
    getOllamaTools(tier) {
        const tools = this.getToolsForTier(tier);
        return tools.map(tool => ({
            type: 'function',
            function: {
                name: tool.name,
                description: tool.description,
                parameters: {
                    type: tool.inputSchema.type,
                    properties: tool.inputSchema.properties,
                    required: tool.inputSchema.required,
                },
            },
        }));
    }
    /** 외부 서버의 도구 일괄 등록 */
    registerExternalTools(serverId, serverName, tools, executor) {
        // 기존 도구 먼저 해제
        this.unregisterExternalTools(serverId);
        // 실행기 등록
        this.externalExecutors.set(serverId, executor);
        // 도구 등록 (네임스페이스 적용)
        for (const tool of tools) {
            const namespacedName = `${serverName}${types_1.MCP_NAMESPACE_SEPARATOR}${tool.name}`;
            const entry = {
                serverId,
                serverName,
                originalName: tool.name,
                namespacedName,
                tool,
            };
            this.externalTools.set(namespacedName, entry);
        }
        console.log(`[ToolRouter] Registered ${tools.length} tools from "${serverName}" (serverId: ${serverId})`);
    }
    /** 외부 서버의 도구 일괄 해제 */
    unregisterExternalTools(serverId) {
        const keysToRemove = [];
        for (const [key, entry] of this.externalTools) {
            if (entry.serverId === serverId) {
                keysToRemove.push(key);
            }
        }
        for (const key of keysToRemove) {
            this.externalTools.delete(key);
        }
        this.externalExecutors.delete(serverId);
        if (keysToRemove.length > 0) {
            console.log(`[ToolRouter] Unregistered ${keysToRemove.length} tools for serverId: ${serverId}`);
        }
    }
    /** 등록된 외부 도구 수 */
    getExternalToolCount() {
        return this.externalTools.size;
    }
    /** 내장 도구 수 */
    getBuiltInToolCount() {
        return tools_1.builtInTools.length;
    }
    /** 특정 도구가 외부 도구인지 확인 */
    isExternalTool(name) {
        return name.includes(types_1.MCP_NAMESPACE_SEPARATOR);
    }
}
exports.ToolRouter = ToolRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL21jcC90b29sLXJvdXRlci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7Ozs7Ozs7Ozs7QUFHSCxtQ0FBa0Q7QUFFbEQsbUNBQXVDO0FBRXZDLDZDQUEwQztBQW9CMUMsTUFBYSxVQUFVO0lBQXZCO1FBQ0ksc0RBQXNEO1FBQzlDLGtCQUFhLEdBQW1DLElBQUksR0FBRyxFQUFFLENBQUM7UUFFbEUsOENBQThDO1FBQ3RDLHNCQUFpQixHQUFzQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBNEo3RSxDQUFDO0lBMUpHLGlDQUFpQztJQUNqQyxXQUFXO1FBQ1AsTUFBTSxLQUFLLEdBQWMsRUFBRSxDQUFDO1FBRTVCLFFBQVE7UUFDUixLQUFLLE1BQU0sR0FBRyxJQUFJLG9CQUFZLEVBQUUsQ0FBQztZQUM3QixLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QixDQUFDO1FBRUQsMkJBQTJCO1FBQzNCLEtBQUssTUFBTSxLQUFLLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDO1lBQzlDLEtBQUssQ0FBQyxJQUFJLGlDQUNILEtBQUssQ0FBQyxJQUFJLEtBQ2IsSUFBSSxFQUFFLEtBQUssQ0FBQyxjQUFjLElBQzVCLENBQUM7UUFDUCxDQUFDO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVELHlCQUF5QjtJQUN6QixlQUFlLENBQUMsSUFBYztRQUMxQixPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFBLHVCQUFVLEVBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzFFLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNHLFdBQVcsQ0FBQyxJQUFZLEVBQUUsSUFBNkIsRUFBRSxPQUFxQjs7WUFDaEYsMEJBQTBCO1lBQzFCLElB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TUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXhDLElBQUksWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUMxQixPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixZQUFZLENBQUMsTUFBTSx3QkFBd0IsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUNwRyxDQUFDO0lBQ0wsQ0FBQztJQUVELGtCQUFrQjtJQUNsQixvQkFBb0I7UUFDaEIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQztJQUNuQyxDQUFDO0lBRUQsY0FBYztJQUNkLG1CQUFtQjtRQUNmLE9BQU8sb0JBQVksQ0FBQyxNQUFNLENBQUM7SUFDL0IsQ0FBQztJQUVELHdCQUF3QjtJQUN4QixjQUFjLENBQUMsSUFBWTtRQUN2QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsK0JBQXVCLENBQUMsQ0FBQztJQUNsRCxDQUFDO0NBQ0o7QUFqS0QsZ0NBaUtDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Wb2x1bWVzL01BQ19BUFAvb3Blbm1ha2VfbGxtL2JhY2tlbmQvYXBpL3NyYy9tY3AvdG9vbC1yb3V0ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBUb29sUm91dGVyIOKAlCDthrXtlakg64+E6rWsIOugiOyngOyKpO2KuOumrFxuICog64K07J6lIOuPhOq1rChidWlsdEluVG9vbHMp7JmAIOyZuOu2gCBNQ1Ag7ISc67KEIOuPhOq1rOulvCDtlZjrgpjsnZgg7J247YSw7Y6Y7J207Iqk66GcIO2Gte2Vqe2VqeuLiOuLpC5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7IE1DUFRvb2wsIE1DUFRvb2xSZXN1bHQsIEV4dGVybmFsVG9vbEVudHJ5IH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBNQ1BfTkFNRVNQQUNFX1NFUEFSQVRPUiB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHR5cGUgeyBNQ1BUb29sRGVmaW5pdGlvbiB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgYnVpbHRJblRvb2xzIH0gZnJvbSAnLi90b29scyc7XG5pbXBvcnQgdHlwZSB7IFVzZXJUaWVyIH0gZnJvbSAnLi4vZGF0YS91c2VyLW1hbmFnZXInO1xuaW1wb3J0IHsgY2FuVXNlVG9vbCB9IGZyb20gJy4vdG9vbC10aWVycyc7XG5pbXBvcnQgdHlwZSB7IFVzZXJDb250ZXh0IH0gZnJvbSAnLi91c2VyLXNhbmRib3gnO1xuXG4vKiog7Jm467aAIOuPhOq1rCDsi6TtlonquLAg7ZWo7IiYIO2DgOyehSAqL1xudHlwZSBFeHRlcm5hbFRvb2xFeGVjdXRvciA9IChuYW1lOiBzdHJpbmcsIGFyZ3M6IFJlY29yZDxzdHJpbmcsIHVua25vd24+KSA9PiBQcm9taXNlPE1DUFRvb2xSZXN1bHQ+O1xuXG4vKiogT2xsYW1hIO2YuO2ZmCDrj4Tqtawg7ZiV7IudICovXG5pbnRlcmZhY2UgT2xsYW1hVG9vbCB7XG4gICAgdHlwZTogJ2Z1bmN0aW9uJztcbiAgICBmdW5jdGlvbjoge1xuICAgICAgICBuYW1lOiBzdHJpbmc7XG4gICAgICAgIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gICAgICAgIHBhcmFtZXRlcnM6IHtcbiAgICAgICAgICAgIHR5cGU6IHN0cmluZztcbiAgICAgICAgICAgIHByb3BlcnRpZXM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgICAgICAgICAgcmVxdWlyZWQ/OiBzdHJpbmdbXTtcbiAgICAgICAgfTtcbiAgICB9O1xufVxuXG5leHBvcnQgY2xhc3MgVG9vbFJvdXRlciB7XG4gICAgLyoqIOyZuOu2gCDrj4Tqtawg66CI7KeA7Iqk7Yq466asOiBuYW1lc3BhY2VkTmFtZSDihpIgRXh0ZXJuYWxUb29sRW50cnkgKi9cbiAgICBwcml2YXRlIGV4dGVybmFsVG9vbHM6IE1hcDxzdHJpbmcsIEV4dGVybmFsVG9vbEVudHJ5PiA9IG5ldyBNYXAoKTtcblxuICAgIC8qKiDsmbjrtoAg64+E6rWsIOyLpO2Wieq4sDogc2VydmVySWQg4oaSIGV4ZWN1dG9yIGZ1bmN0aW9uICovXG4gICAgcHJpdmF0ZSBleHRlcm5hbEV4ZWN1dG9yczogTWFwPHN0cmluZywgRXh0ZXJuYWxUb29sRXhlY3V0b3I+ID0gbmV3IE1hcCgpO1xuXG4gICAgLyoqIOuqqOuToCDrj4Tqtawo64K07J6lK+yZuOu2gCkgTUNQVG9vbCDrqqnroZ0g67CY7ZmYICovXG4gICAgZ2V0QWxsVG9vbHMoKTogTUNQVG9vbFtdIHtcbiAgICAgICAgY29uc3QgdG9vbHM6IE1DUFRvb2xbXSA9IFtdO1xuXG4gICAgICAgIC8vIOuCtOyepSDrj4TqtaxcbiAgICAgICAgZm9yIChjb25zdCBkZWYgb2YgYnVpbHRJblRvb2xzKSB7XG4gICAgICAgICAgICB0b29scy5wdXNoKGRlZi50b29sKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOyZuOu2gCDrj4TqtawgKOuEpOyehOyKpO2OmOydtOyKpCDsoIHsmqnrkJwg7J2066aEIOyCrOyaqSlcbiAgICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiB0aGlzLmV4dGVybmFsVG9vbHMudmFsdWVzKCkpIHtcbiAgICAgICAgICAgIHRvb2xzLnB1c2goe1xuICAgICAgICAgICAgICAgIC4uLmVudHJ5LnRvb2wsXG4gICAgICAgICAgICAgICAgbmFtZTogZW50cnkubmFtZXNwYWNlZE5hbWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0b29scztcbiAgICB9XG5cbiAgICAvKiog7IKs7Jqp7J6QIOuTseq4ieuzhCDtlYTthLDrp4HrkJwg64+E6rWsIOuqqeuhnSAqL1xuICAgIGdldFRvb2xzRm9yVGllcih0aWVyOiBVc2VyVGllcik6IE1DUFRvb2xbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEFsbFRvb2xzKCkuZmlsdGVyKHRvb2wgPT4gY2FuVXNlVG9vbCh0aWVyLCB0b29sLm5hbWUpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDrj4Tqtawg7Iuk7ZaJIOKAlCDrgrTsnqXsnbTrqbQg7KeB7KCRIGhhbmRsZXIsIOyZuOu2gOuptCBFeHRlcm5hbE1DUENsaWVudOuhnCDrnbzsmrDtjIVcbiAgICAgKiBcbiAgICAgKiDimpnvuI8gUGhhc2UgMzogVXNlckNvbnRleHQg7KCE64usIOy2lOqwgCAoMjAyNi0wMi0wNylcbiAgICAgKiDrgrTsnqUg64+E6rWsIGhhbmRsZXLsl5AgY29udGV4dOulvCDsoITri6ztlZjsl6wsIOuPhOq1rOqwgCDsgqzsmqnsnpAg7KCV67O066W8IOywuOyhsO2VoCDsiJgg7J6I64+E66GdIO2VqeuLiOuLpC5cbiAgICAgKi9cbiAgICBhc3luYyBleGVjdXRlVG9vbChuYW1lOiBzdHJpbmcsIGFyZ3M6IFJlY29yZDxzdHJpbmcsIHVua25vd24+LCBjb250ZXh0PzogVXNlckNvbnRleHQpOiBQcm9taXNlPE1DUFRvb2xSZXN1bHQ+IHtcbiAgICAgICAgLy8gMS4g7Jm467aAIOuPhOq1rCDtmZXsnbggKDo6IOuEpOyehOyKpO2OmOydtOyKpClcbiAgICAgICAgaWYgKG5hbWUuaW5jbHVkZXMoTUNQX05BTUVTUEFDRV9TRVBBUkFUT1IpKSB7XG4gICAgICAgICAgICBjb25zdCBleHRlcm5hbEVudHJ5ID0gdGhpcy5leHRlcm5hbFRvb2xzLmdldChuYW1lKTtcbiAgICAgICAgICAgIGlmICghZXh0ZXJuYWxFbnRyeSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IFt7IHR5cGU6ICd0ZXh0JywgdGV4dDogYOyZuOu2gCDrj4Tqtazrpbwg7LC+7J2EIOyImCDsl4bsirXri4jri6Q6ICR7bmFtZX1gIH1dLFxuICAgICAgICAgICAgICAgICAgICBpc0Vycm9yOiB0cnVlLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGV4ZWN1dG9yID0gdGhpcy5leHRlcm5hbEV4ZWN1dG9ycy5nZXQoZXh0ZXJuYWxFbnRyeS5zZXJ2ZXJJZCk7XG4gICAgICAgICAgICBpZiAoIWV4ZWN1dG9yKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudDogW3sgdHlwZTogJ3RleHQnLCB0ZXh0OiBg7ISc67KEIFwiJHtleHRlcm5hbEVudHJ5LnNlcnZlck5hbWV9XCLsnZgg7Iuk7ZaJ6riw66W8IOywvuydhCDsiJgg7JeG7Iq164uI64ukLmAgfV0sXG4gICAgICAgICAgICAgICAgICAgIGlzRXJyb3I6IHRydWUsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8g7Jm467aAIOyEnOuyhOyXkOuKlCDsm5Drs7gg7J2066aE7Jy866GcIO2YuOy2nFxuICAgICAgICAgICAgcmV0dXJuIGV4ZWN1dG9yKGV4dGVybmFsRW50cnkub3JpZ2luYWxOYW1lLCBhcmdzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIDIuIOuCtOyepSDrj4Tqtawg7ZmV7J24XG4gICAgICAgIGNvbnN0IGJ1aWx0SW4gPSBidWlsdEluVG9vbHMuZmluZCgoZGVmOiBNQ1BUb29sRGVmaW5pdGlvbikgPT4gZGVmLnRvb2wubmFtZSA9PT0gbmFtZSk7XG4gICAgICAgIGlmIChidWlsdEluKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBidWlsdEluLmhhbmRsZXIoYXJncywgY29udGV4dCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudDogW3sgdHlwZTogJ3RleHQnLCB0ZXh0OiBg64+E6rWsIOyLpO2WiSDsmKTrpZggKCR7bmFtZX0pOiAke21lc3NhZ2V9YCB9XSxcbiAgICAgICAgICAgICAgICAgICAgaXNFcnJvcjogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvbnRlbnQ6IFt7IHR5cGU6ICd0ZXh0JywgdGV4dDogYOuPhOq1rOulvCDssL7snYQg7IiYIOyXhuyKteuLiOuLpDogJHtuYW1lfWAgfV0sXG4gICAgICAgICAgICBpc0Vycm9yOiB0cnVlLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8qKiBPbGxhbWEg7Zi47ZmYIOuPhOq1rCDtmJXsi53snLzroZwg67OA7ZmYICovXG4gICAgZ2V0T2xsYW1hVG9vbHModGllcjogVXNlclRpZXIpOiBPbGxhbWFUb29sW10ge1xuICAgICAgICBjb25zdCB0b29scyA9IHRoaXMuZ2V0VG9vbHNGb3JUaWVyKHRpZXIpO1xuICAgICAgICByZXR1cm4gdG9vbHMubWFwKHRvb2wgPT4gKHtcbiAgICAgICAgICAgIHR5cGU6ICdmdW5jdGlvbicgYXMgY29uc3QsXG4gICAgICAgICAgICBmdW5jdGlvbjoge1xuICAgICAgICAgICAgICAgIG5hbWU6IHRvb2wubmFtZSxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdG9vbC5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IHRvb2wuaW5wdXRTY2hlbWEudHlwZSxcbiAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllczogdG9vbC5pbnB1dFNjaGVtYS5wcm9wZXJ0aWVzLFxuICAgICAgICAgICAgICAgICAgICByZXF1aXJlZDogdG9vbC5pbnB1dFNjaGVtYS5yZXF1aXJlZCxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8qKiDsmbjrtoAg7ISc67KE7J2YIOuPhOq1rCDsnbzqtIQg65Ox66GdICovXG4gICAgcmVnaXN0ZXJFeHRlcm5hbFRvb2xzKFxuICAgICAgICBzZXJ2ZXJJZDogc3RyaW5nLFxuICAgICAgICBzZXJ2ZXJOYW1lOiBzdHJpbmcsXG4gICAgICAgIHRvb2xzOiBNQ1BUb29sW10sXG4gICAgICAgIGV4ZWN1dG9yOiBFeHRlcm5hbFRvb2xFeGVjdXRvclxuICAgICk6IHZvaWQge1xuICAgICAgICAvLyDquLDsobQg64+E6rWsIOuovOyggCDtlbTsoJxcbiAgICAgICAgdGhpcy51bnJlZ2lzdGVyRXh0ZXJuYWxUb29scyhzZXJ2ZXJJZCk7XG5cbiAgICAgICAgLy8g7Iuk7ZaJ6riwIOuTseuhnVxuICAgICAgICB0aGlzLmV4dGVybmFsRXhlY3V0b3JzLnNldChzZXJ2ZXJJZCwgZXhlY3V0b3IpO1xuXG4gICAgICAgIC8vIOuPhOq1rCDrk7HroZ0gKOuEpOyehOyKpO2OmOydtOyKpCDsoIHsmqkpXG4gICAgICAgIGZvciAoY29uc3QgdG9vbCBvZiB0b29scykge1xuICAgICAgICAgICAgY29uc3QgbmFtZXNwYWNlZE5hbWUgPSBgJHtzZXJ2ZXJOYW1lfSR7TUNQX05BTUVTUEFDRV9TRVBBUkFUT1J9JHt0b29sLm5hbWV9YDtcbiAgICAgICAgICAgIGNvbnN0IGVudHJ5OiBFeHRlcm5hbFRvb2xFbnRyeSA9IHtcbiAgICAgICAgICAgICAgICBzZXJ2ZXJJZCxcbiAgICAgICAgICAgICAgICBzZXJ2ZXJOYW1lLFxuICAgICAgICAgICAgICAgIG9yaWdpbmFsTmFtZTogdG9vbC5uYW1lLFxuICAgICAgICAgICAgICAgIG5hbWVzcGFjZWROYW1lLFxuICAgICAgICAgICAgICAgIHRvb2wsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5leHRlcm5hbFRvb2xzLnNldChuYW1lc3BhY2VkTmFtZSwgZW50cnkpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc29sZS5sb2coYFtUb29sUm91dGVyXSBSZWdpc3RlcmVkICR7dG9vbHMubGVuZ3RofSB0b29scyBmcm9tIFwiJHtzZXJ2ZXJOYW1lfVwiIChzZXJ2ZXJJZDogJHtzZXJ2ZXJJZH0pYCk7XG4gICAgfVxuXG4gICAgLyoqIOyZuOu2gCDshJzrsoTsnZgg64+E6rWsIOydvOq0hCDtlbTsoJwgKi9cbiAgICB1bnJlZ2lzdGVyRXh0ZXJuYWxUb29scyhzZXJ2ZXJJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGtleXNUb1JlbW92ZTogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCBba2V5LCBlbnRyeV0gb2YgdGhpcy5leHRlcm5hbFRvb2xzKSB7XG4gICAgICAgICAgICBpZiAoZW50cnkuc2VydmVySWQgPT09IHNlcnZlcklkKSB7XG4gICAgICAgICAgICAgICAga2V5c1RvUmVtb3ZlLnB1c2goa2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXNUb1JlbW92ZSkge1xuICAgICAgICAgICAgdGhpcy5leHRlcm5hbFRvb2xzLmRlbGV0ZShrZXkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5leHRlcm5hbEV4ZWN1dG9ycy5kZWxldGUoc2VydmVySWQpO1xuXG4gICAgICAgIGlmIChrZXlzVG9SZW1vdmUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYFtUb29sUm91dGVyXSBVbnJlZ2lzdGVyZWQgJHtrZXlzVG9SZW1vdmUubGVuZ3RofSB0b29scyBmb3Igc2VydmVySWQ6ICR7c2VydmVySWR9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiog65Ox66Gd65CcIOyZuOu2gCDrj4Tqtawg7IiYICovXG4gICAgZ2V0RXh0ZXJuYWxUb29sQ291bnQoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXh0ZXJuYWxUb29scy5zaXplO1xuICAgIH1cblxuICAgIC8qKiDrgrTsnqUg64+E6rWsIOyImCAqL1xuICAgIGdldEJ1aWx0SW5Ub29sQ291bnQoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIGJ1aWx0SW5Ub29scy5sZW5ndGg7XG4gICAgfVxuXG4gICAgLyoqIO2KueyglSDrj4TqtazqsIAg7Jm467aAIOuPhOq1rOyduOyngCDtmZXsnbggKi9cbiAgICBpc0V4dGVybmFsVG9vbChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIG5hbWUuaW5jbHVkZXMoTUNQX05BTUVTUEFDRV9TRVBBUkFUT1IpO1xuICAgIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==