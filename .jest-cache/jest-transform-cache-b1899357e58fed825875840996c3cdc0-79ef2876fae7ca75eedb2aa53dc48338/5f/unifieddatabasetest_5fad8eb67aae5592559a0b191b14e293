034be958370c84f21d4aea6b8c4a2369
"use strict";
/**
 * #20 개선: UnifiedDatabase 기초 단위 테스트
 *
 * 메모리 내 SQLite로 실제 DB 로직을 테스트합니다.
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const unified_database_1 = require("../../../database/models/unified-database");
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const os = __importStar(require("os"));
describe('UnifiedDatabase', () => {
    let db;
    let tempDir;
    beforeEach(() => {
        // 임시 디렉토리에 테스트 DB 생성
        tempDir = fs.mkdtempSync(path.join(os.tmpdir(), 'openmake-test-'));
        db = new unified_database_1.UnifiedDatabase(tempDir);
    });
    afterEach(() => {
        try {
            db.close();
        }
        catch (e) {
            // already closed
        }
        // 임시 파일 정리
        fs.rmSync(tempDir, { recursive: true, force: true });
    });
    // ===== User CRUD =====
    describe('User Management', () => {
        it('should create and retrieve a user by username', () => {
            db.createUser('user-1', 'testuser', 'hashed123', 'test@example.com', 'user');
            const user = db.getUserByUsername('testuser');
            expect(user).toBeDefined();
            expect(user.id).toBe('user-1');
            expect(user.username).toBe('testuser');
            expect(user.email).toBe('test@example.com');
            expect(user.role).toBe('user');
        });
        it('should retrieve a user by id', () => {
            db.createUser('user-2', 'admin', 'hashed456', 'admin@test.com', 'admin');
            const user = db.getUserById('user-2');
            expect(user).toBeDefined();
            expect(user.username).toBe('admin');
            expect(user.role).toBe('admin');
        });
        it('should return undefined for non-existent user', () => {
            expect(db.getUserByUsername('nobody')).toBeUndefined();
            expect(db.getUserById('no-id')).toBeUndefined();
        });
        it('should update last login timestamp', () => {
            db.createUser('user-3', 'loginuser', 'hash', 'login@test.com');
            db.updateLastLogin('user-3');
            const user = db.getUserById('user-3');
            expect(user).toBeDefined();
            expect(user.last_login).toBeTruthy();
        });
        it('should list all users with optional limit', () => {
            db.createUser('u1', 'user1', 'h1');
            db.createUser('u2', 'user2', 'h2');
            db.createUser('u3', 'user3', 'h3');
            const all = db.getAllUsers();
            expect(all.length).toBe(3);
            const limited = db.getAllUsers(2);
            expect(limited.length).toBe(2);
        });
    });
    // ===== Conversation Sessions =====
    describe('Conversation Sessions', () => {
        beforeEach(() => {
            db.createUser('user-conv', 'convuser', 'hash', 'conv@test.com');
        });
        it('should create a session and add messages', () => {
            db.createSession('sess-1', 'user-conv', 'Test Chat');
            db.addMessage('sess-1', 'user', 'Hello');
            db.addMessage('sess-1', 'assistant', 'Hi there!', {
                model: 'test-model',
                tokens: 10,
                responseTimeMs: 200
            });
            const messages = db.getSessionMessages('sess-1');
            expect(messages.length).toBe(2);
            expect(messages[0].role).toBe('user');
            expect(messages[0].content).toBe('Hello');
            expect(messages[1].role).toBe('assistant');
            expect(messages[1].model).toBe('test-model');
        });
        it('should list user sessions', () => {
            db.createSession('s1', 'user-conv', 'Chat 1');
            db.createSession('s2', 'user-conv', 'Chat 2');
            const sessions = db.getUserSessions('user-conv');
            expect(sessions.length).toBe(2);
        });
        it('should delete a session and its messages', () => {
            db.createSession('del-sess', 'user-conv', 'Delete Me');
            db.addMessage('del-sess', 'user', 'Will be deleted');
            db.deleteSession('del-sess');
            const messages = db.getSessionMessages('del-sess');
            expect(messages.length).toBe(0);
        });
    });
    // ===== Memory System =====
    describe('Memory System', () => {
        beforeEach(() => {
            db.createUser('mem-user', 'memuser', 'hash');
        });
        it('should create and retrieve user memories', () => {
            db.createMemory({
                id: 'mem-1',
                userId: 'mem-user',
                category: 'preference',
                key: 'language',
                value: 'TypeScript',
                importance: 8
            });
            const memories = db.getUserMemories('mem-user');
            expect(memories.length).toBe(1);
            expect(memories[0].key).toBe('language');
            expect(memories[0].value).toBe('TypeScript');
            expect(memories[0].importance).toBe(8);
        });
        it('should filter memories by category', () => {
            db.createMemory({
                id: 'mem-a', userId: 'mem-user', category: 'preference',
                key: 'theme', value: 'dark'
            });
            db.createMemory({
                id: 'mem-b', userId: 'mem-user', category: 'fact',
                key: 'name', value: 'John'
            });
            const prefs = db.getUserMemories('mem-user', { category: 'preference' });
            expect(prefs.length).toBe(1);
            expect(prefs[0].category).toBe('preference');
        });
        it('should delete specific memory', () => {
            db.createMemory({
                id: 'del-mem', userId: 'mem-user', category: 'preference',
                key: 'test', value: 'delete me'
            });
            db.deleteMemory('del-mem');
            const memories = db.getUserMemories('mem-user');
            expect(memories.length).toBe(0);
        });
    });
    // ===== Stats =====
    describe('Database Stats', () => {
        it('should return stats object with table row counts', () => {
            const stats = db.getStats();
            expect(stats).toBeDefined();
            // getStats()는 Record<string, number> 형태로 각 테이블의 행 수를 반환
            expect(typeof stats).toBe('object');
            expect(typeof stats.users).toBe('number');
            expect(typeof stats.conversation_sessions).toBe('number');
            expect(typeof stats.conversation_messages).toBe('number');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vdGVzdHMvdW5pdC9fX3Rlc3RzX18vdW5pZmllZC1kYXRhYmFzZS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVILGdGQUE0RTtBQUM1RSx1Q0FBeUI7QUFDekIsMkNBQTZCO0FBQzdCLHVDQUF5QjtBQUV6QixRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQzdCLElBQUksRUFBbUIsQ0FBQztJQUN4QixJQUFJLE9BQWUsQ0FBQztJQUVwQixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ1oscUJBQXFCO1FBQ3JCLE9BQU8sR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FBQztRQUNuRSxFQUFFLEdBQUcsSUFBSSxrQ0FBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3RDLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNYLElBQUksQ0FBQztZQUNELEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNmLENBQUM7UUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ1QsaUJBQWlCO1FBQ3JCLENBQUM7UUFDRCxXQUFXO1FBQ1gsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3pELENBQUMsQ0FBQyxDQUFDO0lBRUgsd0JBQXdCO0lBQ3hCLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7UUFDN0IsRUFBRSxDQUFDLCtDQUErQyxFQUFFLEdBQUcsRUFBRTtZQUNyRCxFQUFFLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sQ0FB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SyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sQ0FBQyxPQUFPLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUMxRCxNQUFNLENBQUMsT0FBTyxLQUFLLENBQUMscUJBQXFCLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDOUQsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Wb2x1bWVzL01BQ19BUFAvb3Blbm1ha2VfbGxtL3Rlc3RzL3VuaXQvX190ZXN0c19fL3VuaWZpZWQtZGF0YWJhc2UudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqICMyMCDqsJzshKA6IFVuaWZpZWREYXRhYmFzZSDquLDstIgg64uo7JyEIO2FjOyKpO2KuFxuICogXG4gKiDrqZTrqqjrpqwg64K0IFNRTGl0ZeuhnCDsi6TsoJwgREIg66Gc7KeB7J2EIO2FjOyKpO2KuO2VqeuLiOuLpC5cbiAqL1xuXG5pbXBvcnQgeyBVbmlmaWVkRGF0YWJhc2UgfSBmcm9tICcuLi8uLi8uLi9kYXRhYmFzZS9tb2RlbHMvdW5pZmllZC1kYXRhYmFzZSc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgb3MgZnJvbSAnb3MnO1xuXG5kZXNjcmliZSgnVW5pZmllZERhdGFiYXNlJywgKCkgPT4ge1xuICAgIGxldCBkYjogVW5pZmllZERhdGFiYXNlO1xuICAgIGxldCB0ZW1wRGlyOiBzdHJpbmc7XG5cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgICAgLy8g7J6E7IucIOuUlOugie2GoOumrOyXkCDthYzsiqTtirggREIg7IOd7ISxXG4gICAgICAgIHRlbXBEaXIgPSBmcy5ta2R0ZW1wU3luYyhwYXRoLmpvaW4ob3MudG1wZGlyKCksICdvcGVubWFrZS10ZXN0LScpKTtcbiAgICAgICAgZGIgPSBuZXcgVW5pZmllZERhdGFiYXNlKHRlbXBEaXIpO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIC8vIGFscmVhZHkgY2xvc2VkXG4gICAgICAgIH1cbiAgICAgICAgLy8g7J6E7IucIO2MjOydvCDsoJXrpqxcbiAgICAgICAgZnMucm1TeW5jKHRlbXBEaXIsIHsgcmVjdXJzaXZlOiB0cnVlLCBmb3JjZTogdHJ1ZSB9KTtcbiAgICB9KTtcblxuICAgIC8vID09PT09IFVzZXIgQ1JVRCA9PT09PVxuICAgIGRlc2NyaWJlKCdVc2VyIE1hbmFnZW1lbnQnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgY3JlYXRlIGFuZCByZXRyaWV2ZSBhIHVzZXIgYnkgdXNlcm5hbWUnLCAoKSA9PiB7XG4gICAgICAgICAgICBkYi5jcmVhdGVVc2VyKCd1c2VyLTEnLCAndGVzdHVzZXInLCAnaGFzaGVkMTIzJywgJ3Rlc3RAZXhhbXBsZS5jb20nLCAndXNlcicpO1xuICAgICAgICAgICAgY29uc3QgdXNlciA9IGRiLmdldFVzZXJCeVVzZXJuYW1lKCd0ZXN0dXNlcicpO1xuXG4gICAgICAgICAgICBleHBlY3QodXNlcikudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdCh1c2VyIS5pZCkudG9CZSgndXNlci0xJyk7XG4gICAgICAgICAgICBleHBlY3QodXNlciEudXNlcm5hbWUpLnRvQmUoJ3Rlc3R1c2VyJyk7XG4gICAgICAgICAgICBleHBlY3QodXNlciEuZW1haWwpLnRvQmUoJ3Rlc3RAZXhhbXBsZS5jb20nKTtcbiAgICAgICAgICAgIGV4cGVjdCh1c2VyIS5yb2xlKS50b0JlKCd1c2VyJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0cmlldmUgYSB1c2VyIGJ5IGlkJywgKCkgPT4ge1xuICAgICAgICAgICAgZGIuY3JlYXRlVXNlcigndXNlci0yJywgJ2FkbWluJywgJ2hhc2hlZDQ1NicsICdhZG1pbkB0ZXN0LmNvbScsICdhZG1pbicpO1xuICAgICAgICAgICAgY29uc3QgdXNlciA9IGRiLmdldFVzZXJCeUlkKCd1c2VyLTInKTtcblxuICAgICAgICAgICAgZXhwZWN0KHVzZXIpLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgICAgICBleHBlY3QodXNlciEudXNlcm5hbWUpLnRvQmUoJ2FkbWluJyk7XG4gICAgICAgICAgICBleHBlY3QodXNlciEucm9sZSkudG9CZSgnYWRtaW4nKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gdW5kZWZpbmVkIGZvciBub24tZXhpc3RlbnQgdXNlcicsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChkYi5nZXRVc2VyQnlVc2VybmFtZSgnbm9ib2R5JykpLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdChkYi5nZXRVc2VyQnlJZCgnbm8taWQnKSkudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZSBsYXN0IGxvZ2luIHRpbWVzdGFtcCcsICgpID0+IHtcbiAgICAgICAgICAgIGRiLmNyZWF0ZVVzZXIoJ3VzZXItMycsICdsb2dpbnVzZXInLCAnaGFzaCcsICdsb2dpbkB0ZXN0LmNvbScpO1xuICAgICAgICAgICAgZGIudXBkYXRlTGFzdExvZ2luKCd1c2VyLTMnKTtcblxuICAgICAgICAgICAgY29uc3QgdXNlciA9IGRiLmdldFVzZXJCeUlkKCd1c2VyLTMnKTtcbiAgICAgICAgICAgIGV4cGVjdCh1c2VyKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICAgICAgZXhwZWN0KHVzZXIhLmxhc3RfbG9naW4pLnRvQmVUcnV0aHkoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBsaXN0IGFsbCB1c2VycyB3aXRoIG9wdGlvbmFsIGxpbWl0JywgKCkgPT4ge1xuICAgICAgICAgICAgZGIuY3JlYXRlVXNlcigndTEnLCAndXNlcjEnLCAnaDEnKTtcbiAgICAgICAgICAgIGRiLmNyZWF0ZVVzZXIoJ3UyJywgJ3VzZXIyJywgJ2gyJyk7XG4gICAgICAgICAgICBkYi5jcmVhdGVVc2VyKCd1MycsICd1c2VyMycsICdoMycpO1xuXG4gICAgICAgICAgICBjb25zdCBhbGwgPSBkYi5nZXRBbGxVc2VycygpO1xuICAgICAgICAgICAgZXhwZWN0KGFsbC5sZW5ndGgpLnRvQmUoMyk7XG5cbiAgICAgICAgICAgIGNvbnN0IGxpbWl0ZWQgPSBkYi5nZXRBbGxVc2VycygyKTtcbiAgICAgICAgICAgIGV4cGVjdChsaW1pdGVkLmxlbmd0aCkudG9CZSgyKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyA9PT09PSBDb252ZXJzYXRpb24gU2Vzc2lvbnMgPT09PT1cbiAgICBkZXNjcmliZSgnQ29udmVyc2F0aW9uIFNlc3Npb25zJywgKCkgPT4ge1xuICAgICAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgICAgICAgIGRiLmNyZWF0ZVVzZXIoJ3VzZXItY29udicsICdjb252dXNlcicsICdoYXNoJywgJ2NvbnZAdGVzdC5jb20nKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBjcmVhdGUgYSBzZXNzaW9uIGFuZCBhZGQgbWVzc2FnZXMnLCAoKSA9PiB7XG4gICAgICAgICAgICBkYi5jcmVhdGVTZXNzaW9uKCdzZXNzLTEnLCAndXNlci1jb252JywgJ1Rlc3QgQ2hhdCcpO1xuXG4gICAgICAgICAgICBkYi5hZGRNZXNzYWdlKCdzZXNzLTEnLCAndXNlcicsICdIZWxsbycpO1xuICAgICAgICAgICAgZGIuYWRkTWVzc2FnZSgnc2Vzcy0xJywgJ2Fzc2lzdGFudCcsICdIaSB0aGVyZSEnLCB7XG4gICAgICAgICAgICAgICAgbW9kZWw6ICd0ZXN0LW1vZGVsJyxcbiAgICAgICAgICAgICAgICB0b2tlbnM6IDEwLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlVGltZU1zOiAyMDBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlcyA9IGRiLmdldFNlc3Npb25NZXNzYWdlcygnc2Vzcy0xJyk7XG4gICAgICAgICAgICBleHBlY3QobWVzc2FnZXMubGVuZ3RoKS50b0JlKDIpO1xuICAgICAgICAgICAgZXhwZWN0KG1lc3NhZ2VzWzBdLnJvbGUpLnRvQmUoJ3VzZXInKTtcbiAgICAgICAgICAgIGV4cGVjdChtZXNzYWdlc1swXS5jb250ZW50KS50b0JlKCdIZWxsbycpO1xuICAgICAgICAgICAgZXhwZWN0KG1lc3NhZ2VzWzFdLnJvbGUpLnRvQmUoJ2Fzc2lzdGFudCcpO1xuICAgICAgICAgICAgZXhwZWN0KG1lc3NhZ2VzWzFdLm1vZGVsKS50b0JlKCd0ZXN0LW1vZGVsJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgbGlzdCB1c2VyIHNlc3Npb25zJywgKCkgPT4ge1xuICAgICAgICAgICAgZGIuY3JlYXRlU2Vzc2lvbignczEnLCAndXNlci1jb252JywgJ0NoYXQgMScpO1xuICAgICAgICAgICAgZGIuY3JlYXRlU2Vzc2lvbignczInLCAndXNlci1jb252JywgJ0NoYXQgMicpO1xuXG4gICAgICAgICAgICBjb25zdCBzZXNzaW9ucyA9IGRiLmdldFVzZXJTZXNzaW9ucygndXNlci1jb252Jyk7XG4gICAgICAgICAgICBleHBlY3Qoc2Vzc2lvbnMubGVuZ3RoKS50b0JlKDIpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGRlbGV0ZSBhIHNlc3Npb24gYW5kIGl0cyBtZXNzYWdlcycsICgpID0+IHtcbiAgICAgICAgICAgIGRiLmNyZWF0ZVNlc3Npb24oJ2RlbC1zZXNzJywgJ3VzZXItY29udicsICdEZWxldGUgTWUnKTtcbiAgICAgICAgICAgIGRiLmFkZE1lc3NhZ2UoJ2RlbC1zZXNzJywgJ3VzZXInLCAnV2lsbCBiZSBkZWxldGVkJyk7XG5cbiAgICAgICAgICAgIGRiLmRlbGV0ZVNlc3Npb24oJ2RlbC1zZXNzJyk7XG5cbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2VzID0gZGIuZ2V0U2Vzc2lvbk1lc3NhZ2VzKCdkZWwtc2VzcycpO1xuICAgICAgICAgICAgZXhwZWN0KG1lc3NhZ2VzLmxlbmd0aCkudG9CZSgwKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyA9PT09PSBNZW1vcnkgU3lzdGVtID09PT09XG4gICAgZGVzY3JpYmUoJ01lbW9yeSBTeXN0ZW0nLCAoKSA9PiB7XG4gICAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICAgICAgZGIuY3JlYXRlVXNlcignbWVtLXVzZXInLCAnbWVtdXNlcicsICdoYXNoJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgY3JlYXRlIGFuZCByZXRyaWV2ZSB1c2VyIG1lbW9yaWVzJywgKCkgPT4ge1xuICAgICAgICAgICAgZGIuY3JlYXRlTWVtb3J5KHtcbiAgICAgICAgICAgICAgICBpZDogJ21lbS0xJyxcbiAgICAgICAgICAgICAgICB1c2VySWQ6ICdtZW0tdXNlcicsXG4gICAgICAgICAgICAgICAgY2F0ZWdvcnk6ICdwcmVmZXJlbmNlJyxcbiAgICAgICAgICAgICAgICBrZXk6ICdsYW5ndWFnZScsXG4gICAgICAgICAgICAgICAgdmFsdWU6ICdUeXBlU2NyaXB0JyxcbiAgICAgICAgICAgICAgICBpbXBvcnRhbmNlOiA4XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY29uc3QgbWVtb3JpZXMgPSBkYi5nZXRVc2VyTWVtb3JpZXMoJ21lbS11c2VyJyk7XG4gICAgICAgICAgICBleHBlY3QobWVtb3JpZXMubGVuZ3RoKS50b0JlKDEpO1xuICAgICAgICAgICAgZXhwZWN0KG1lbW9yaWVzWzBdLmtleSkudG9CZSgnbGFuZ3VhZ2UnKTtcbiAgICAgICAgICAgIGV4cGVjdChtZW1vcmllc1swXS52YWx1ZSkudG9CZSgnVHlwZVNjcmlwdCcpO1xuICAgICAgICAgICAgZXhwZWN0KG1lbW9yaWVzWzBdLmltcG9ydGFuY2UpLnRvQmUoOCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgZmlsdGVyIG1lbW9yaWVzIGJ5IGNhdGVnb3J5JywgKCkgPT4ge1xuICAgICAgICAgICAgZGIuY3JlYXRlTWVtb3J5KHtcbiAgICAgICAgICAgICAgICBpZDogJ21lbS1hJywgdXNlcklkOiAnbWVtLXVzZXInLCBjYXRlZ29yeTogJ3ByZWZlcmVuY2UnLFxuICAgICAgICAgICAgICAgIGtleTogJ3RoZW1lJywgdmFsdWU6ICdkYXJrJ1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBkYi5jcmVhdGVNZW1vcnkoe1xuICAgICAgICAgICAgICAgIGlkOiAnbWVtLWInLCB1c2VySWQ6ICdtZW0tdXNlcicsIGNhdGVnb3J5OiAnZmFjdCcsXG4gICAgICAgICAgICAgICAga2V5OiAnbmFtZScsIHZhbHVlOiAnSm9obidcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjb25zdCBwcmVmcyA9IGRiLmdldFVzZXJNZW1vcmllcygnbWVtLXVzZXInLCB7IGNhdGVnb3J5OiAncHJlZmVyZW5jZScgfSk7XG4gICAgICAgICAgICBleHBlY3QocHJlZnMubGVuZ3RoKS50b0JlKDEpO1xuICAgICAgICAgICAgZXhwZWN0KHByZWZzWzBdLmNhdGVnb3J5KS50b0JlKCdwcmVmZXJlbmNlJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgZGVsZXRlIHNwZWNpZmljIG1lbW9yeScsICgpID0+IHtcbiAgICAgICAgICAgIGRiLmNyZWF0ZU1lbW9yeSh7XG4gICAgICAgICAgICAgICAgaWQ6ICdkZWwtbWVtJywgdXNlcklkOiAnbWVtLXVzZXInLCBjYXRlZ29yeTogJ3ByZWZlcmVuY2UnLFxuICAgICAgICAgICAgICAgIGtleTogJ3Rlc3QnLCB2YWx1ZTogJ2RlbGV0ZSBtZSdcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBkYi5kZWxldGVNZW1vcnkoJ2RlbC1tZW0nKTtcbiAgICAgICAgICAgIGNvbnN0IG1lbW9yaWVzID0gZGIuZ2V0VXNlck1lbW9yaWVzKCdtZW0tdXNlcicpO1xuICAgICAgICAgICAgZXhwZWN0KG1lbW9yaWVzLmxlbmd0aCkudG9CZSgwKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyA9PT09PSBTdGF0cyA9PT09PVxuICAgIGRlc2NyaWJlKCdEYXRhYmFzZSBTdGF0cycsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gc3RhdHMgb2JqZWN0IHdpdGggdGFibGUgcm93IGNvdW50cycsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHN0YXRzID0gZGIuZ2V0U3RhdHMoKTtcbiAgICAgICAgICAgIGV4cGVjdChzdGF0cykudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIC8vIGdldFN0YXRzKCnripQgUmVjb3JkPHN0cmluZywgbnVtYmVyPiDtmJXtg5zroZwg6rCBIO2FjOydtOu4lOydmCDtlokg7IiY66W8IOuwmO2ZmFxuICAgICAgICAgICAgZXhwZWN0KHR5cGVvZiBzdGF0cykudG9CZSgnb2JqZWN0Jyk7XG4gICAgICAgICAgICBleHBlY3QodHlwZW9mIHN0YXRzLnVzZXJzKS50b0JlKCdudW1iZXInKTtcbiAgICAgICAgICAgIGV4cGVjdCh0eXBlb2Ygc3RhdHMuY29udmVyc2F0aW9uX3Nlc3Npb25zKS50b0JlKCdudW1iZXInKTtcbiAgICAgICAgICAgIGV4cGVjdCh0eXBlb2Ygc3RhdHMuY29udmVyc2F0aW9uX21lc3NhZ2VzKS50b0JlKCdudW1iZXInKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==