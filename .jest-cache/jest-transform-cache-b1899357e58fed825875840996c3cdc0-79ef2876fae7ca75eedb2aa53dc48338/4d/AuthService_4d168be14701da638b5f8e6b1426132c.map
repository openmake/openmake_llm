{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/services/AuthService.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/services/AuthService.ts"],"sourcesContent":["/**\n * ============================================================\n * Auth Service\n * ============================================================\n * 인증 관련 비즈니스 로직\n */\n\nimport { getUserManager, PublicUser } from '../data/user-manager';\nimport { generateToken } from '../auth';\nimport { createLogger } from '../utils/logger';\nimport { getConfig } from '../config/env';\n\nconst log = createLogger('AuthService');\n\nexport interface RegisterRequest {\n    email: string;\n    password: string;\n    role?: 'admin' | 'user' | 'guest';\n}\n\nexport interface LoginRequest {\n    email: string;\n    password: string;\n}\n\nexport interface ChangePasswordRequest {\n    userId: number;\n    currentEmail: string;\n    currentPassword: string;\n    newPassword: string;\n}\n\nexport interface AuthResult {\n    success: boolean;\n    error?: string;\n    user?: PublicUser;\n    token?: string;\n}\n\n/**\n * Validate password complexity requirements\n * - Minimum 8 characters\n * - At least one uppercase letter\n * - At least one lowercase letter  \n * - At least one number\n * - At least one special character\n */\nfunction validatePasswordComplexity(password: string): { valid: boolean; errors: string[] } {\n    const errors: string[] = [];\n    \n    if (password.length < 8) {\n        errors.push('비밀번호는 8자 이상이어야 합니다');\n    }\n    if (!/[A-Z]/.test(password)) {\n        errors.push('대문자를 1개 이상 포함해야 합니다');\n    }\n    if (!/[a-z]/.test(password)) {\n        errors.push('소문자를 1개 이상 포함해야 합니다');\n    }\n    if (!/[0-9]/.test(password)) {\n        errors.push('숫자를 1개 이상 포함해야 합니다');\n    }\n    if (!/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password)) {\n        errors.push('특수문자를 1개 이상 포함해야 합니다');\n    }\n    \n    return { valid: errors.length === 0, errors };\n}\n\nexport class AuthService {\n    private userManager = getUserManager();\n\n    /**\n     * 회원가입\n     */\n    async register(data: RegisterRequest): Promise<AuthResult> {\n        const { email, password, role } = data;\n\n        // 유효성 검사\n        if (!email || !password) {\n            return { success: false, error: '이메일과 비밀번호를 입력하세요' };\n        }\n\n        const passwordValidation = validatePasswordComplexity(password);\n        if (!passwordValidation.valid) {\n            return { success: false, error: passwordValidation.errors.join(', ') };\n        }\n\n        const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n        if (!emailRegex.test(email)) {\n            return { success: false, error: '유효한 이메일 주소를 입력하세요' };\n        }\n\n        const user = await this.userManager.createUser({ email, password, role });\n\n        if (!user) {\n            return { success: false, error: '이미 등록된 이메일입니다' };\n        }\n\n        log.info(`회원가입 완료: ${email}`);\n        return { success: true, user };\n    }\n\n    /**\n     * 로그인\n     */\n    async login(data: LoginRequest): Promise<AuthResult> {\n        const { email, password } = data;\n\n        if (!email || !password) {\n            return { success: false, error: '이메일과 비밀번호를 입력하세요' };\n        }\n\n        const user = await this.userManager.authenticate(email, password);\n\n        if (!user) {\n            return { success: false, error: '이메일 또는 비밀번호가 올바르지 않습니다' };\n        }\n\n        const token = generateToken(user);\n        log.info(`로그인 성공: ${email}`);\n\n        return { success: true, token, user };\n    }\n\n    /**\n     * 비밀번호 변경\n     */\n    async changePassword(data: ChangePasswordRequest): Promise<AuthResult> {\n        const { userId, currentEmail, currentPassword, newPassword } = data;\n\n        if (!currentPassword || !newPassword) {\n            return { success: false, error: '현재 비밀번호와 새 비밀번호를 입력하세요' };\n        }\n\n        const passwordValidation = validatePasswordComplexity(newPassword);\n        if (!passwordValidation.valid) {\n            return { success: false, error: passwordValidation.errors.join(', ') };\n        }\n\n        // 현재 비밀번호 확인\n        const user = await this.userManager.authenticate(currentEmail, currentPassword);\n        if (!user) {\n            return { success: false, error: '현재 비밀번호가 올바르지 않습니다' };\n        }\n\n        const success = await this.userManager.changePassword(userId, newPassword);\n        return { success };\n    }\n\n    /**\n     * OAuth 사용자 생성 또는 반환\n     */\n    async findOrCreateOAuthUser(email: string, provider: 'google' | 'github'): Promise<AuthResult> {\n        let user = await this.userManager.getUserByEmail(email);\n        let publicUser = user ? await this.userManager.getUserById(user.id) : null;\n\n        if (!publicUser) {\n            // OAuth 사용자는 랜덤 비밀번호로 생성\n            const randomPassword = Math.random().toString(36).substring(2, 15);\n\n            // 관리자 이메일 목록 확인\n            const adminEmails = getConfig().adminEmails\n                .split(',')\n                .map(e => e.toLowerCase().trim())\n                .filter(e => e);\n            const role = adminEmails.includes(email.toLowerCase()) ? 'admin' : 'user';\n\n            publicUser = await this.userManager.createUser({\n                email,\n                password: randomPassword,\n                role\n            });\n\n            if (!publicUser) {\n                return { success: false, error: '사용자 생성 실패' };\n            }\n\n            log.info(`[OAuth] ${provider} 신규 사용자 생성: ${email}`);\n        } else {\n            // 기존 계정 관리자 승격 체크\n            const adminEmails = getConfig().adminEmails\n                .split(',')\n                .map(e => e.toLowerCase().trim())\n                .filter(e => e);\n\n            if (adminEmails.includes(email.toLowerCase()) && publicUser.role !== 'admin') {\n                await this.userManager.changeRole(publicUser.id, 'admin');\n                publicUser.role = 'admin';\n            }\n        }\n\n        const token = generateToken(publicUser);\n        log.info(`[OAuth] ${provider} 로그인 성공: ${email}`);\n\n        return { success: true, token, user: publicUser };\n    }\n\n    /**\n     * 사용 가능한 OAuth 프로바이더 목록\n     */\n    getAvailableProviders(): string[] {\n        const providers: string[] = [];\n\n        const config = getConfig();\n        if (config.googleClientId && config.googleClientSecret) {\n            providers.push('google');\n        }\n        if (config.githubClientId && config.githubClientSecret) {\n            providers.push('github');\n        }\n\n        return providers;\n    }\n}\n\n// 싱글톤 인스턴스\nlet authService: AuthService | null = null;\n\nexport function getAuthService(): AuthService {\n    if (!authService) {\n        authService = new AuthService();\n    }\n    return authService;\n}\n"],"version":3}