1ad5a53c3408b584198d3da3ce9bf71d
"use strict";
/**
 * Token Blacklist - SQLite-backed implementation
 * Pluggable interface allows future Redis migration
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SQLiteTokenBlacklist = void 0;
exports.getTokenBlacklist = getTokenBlacklist;
exports.resetTokenBlacklist = resetTokenBlacklist;
const better_sqlite3_1 = __importDefault(require("better-sqlite3"));
const path_1 = __importDefault(require("path"));
/**
 * SQLite-backed Token Blacklist Implementation
 */
class SQLiteTokenBlacklist {
    constructor(dbPath) {
        this.cleanupInterval = null;
        const dbFile = dbPath || path_1.default.join(__dirname, '../../../../data/unified.db');
        this.db = new better_sqlite3_1.default(dbFile);
        this.initTable();
        this.startCleanupScheduler();
    }
    initTable() {
        this.db.exec(`
            CREATE TABLE IF NOT EXISTS token_blacklist (
                jti TEXT PRIMARY KEY,
                expires_at INTEGER NOT NULL,
                created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
            )
        `);
        this.db.exec('CREATE INDEX IF NOT EXISTS idx_blacklist_expires ON token_blacklist(expires_at)');
        console.log('[TokenBlacklist] üìã SQLite ÌÖåÏù¥Î∏î Ï¥àÍ∏∞ÌôîÎê®');
    }
    add(jti, expiresAt) {
        const stmt = this.db.prepare('INSERT OR REPLACE INTO token_blacklist (jti, expires_at) VALUES (?, ?)');
        stmt.run(jti, expiresAt);
    }
    has(jti) {
        const stmt = this.db.prepare('SELECT 1 FROM token_blacklist WHERE jti = ? AND expires_at > ?');
        const result = stmt.get(jti, Date.now());
        return result !== undefined;
    }
    cleanup() {
        const stmt = this.db.prepare('DELETE FROM token_blacklist WHERE expires_at < ?');
        const result = stmt.run(Date.now());
        return result.changes;
    }
    getStats() {
        const stmt = this.db.prepare('SELECT COUNT(*) as count FROM token_blacklist WHERE expires_at > ?');
        const result = stmt.get(Date.now());
        return { count: result.count };
    }
    startCleanupScheduler() {
        // Clean up every hour
        this.cleanupInterval = setInterval(() => {
            const cleaned = this.cleanup();
            if (cleaned > 0) {
                console.log(`[TokenBlacklist] üßπ ${cleaned}Í∞ú ÎßåÎ£åÎêú ÌÜ†ÌÅ∞ Ï†ïÎ¶¨Îê®`);
            }
        }, 60 * 60 * 1000);
    }
    destroy() {
        if (this.cleanupInterval) {
            clearInterval(this.cleanupInterval);
        }
        this.db.close();
    }
}
exports.SQLiteTokenBlacklist = SQLiteTokenBlacklist;
// Singleton instance
let instance = null;
function getTokenBlacklist() {
    if (!instance) {
        instance = new SQLiteTokenBlacklist();
    }
    return instance;
}
function resetTokenBlacklist() {
    if (instance && instance instanceof SQLiteTokenBlacklist) {
        instance.destroy();
    }
    instance = null;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL2RhdGEvbW9kZWxzL3Rva2VuLWJsYWNrbGlzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7Ozs7QUFxRkgsOENBS0M7QUFFRCxrREFLQztBQS9GRCxvRUFBc0M7QUFDdEMsZ0RBQXdCO0FBWXhCOztHQUVHO0FBQ0gsTUFBYSxvQkFBb0I7SUFJN0IsWUFBWSxNQUFlO1FBRm5CLG9CQUFlLEdBQTBCLElBQUksQ0FBQztRQUdsRCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksY0FBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsNkJBQTZCLENBQUMsQ0FBQztRQUM3RSxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksd0JBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDakIsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVPLFNBQVM7UUFDYixJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQzs7Ozs7O1NBTVosQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsaUZBQWlGLENBQUMsQ0FBQztRQUNoRyxPQUFPLENBQUMsR0FBRyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVELEdBQUcsQ0FBQyxHQUFXLEVBQUUsU0FBaUI7UUFDOUIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsd0VBQXdFLENBQUMsQ0FBQztRQUN2RyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRUQsR0FBRyxDQUFDLEdBQVc7UUFDWCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxnRUFBZ0UsQ0FBQyxDQUFDO1FBQy9GLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ3pDLE9BQU8sTUFBTSxLQUFLLFNBQVMsQ0FBQztJQUNoQyxDQUFDO0lBRUQsT0FBTztRQUNILE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLGtEQUFrRCxDQUFDLENBQUM7UUFDakYsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNwQyxPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUM7SUFDMUIsQ0FBQztJQUVELFFBQVE7UUFDSixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxvRUFBb0UsQ0FBQyxDQUFDO1FBQ25HLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFzQixDQUFDO1FBQ3pELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ25DLENBQUM7SUFFTyxxQkFBcUI7UUFDekIsc0JBQXNCO1FBQ3RCLElBQUksQ0FBQyxlQUFlLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRTtZQUNwQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDL0IsSUFBSSxPQUFPLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ2QsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsT0FBTyxjQUFjLENBQUMsQ0FBQztZQUM5RCxDQUFDO1FBQ0wsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUVELE9BQU87UUFDSCxJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN2QixhQUFhLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ3hDLENBQUM7UUFDRCxJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3BCLENBQUM7Q0FDSjtBQTlERCxvREE4REM7QUFFRCxxQkFBcUI7QUFDckIsSUFBSSxRQUFRLEdBQTJCLElBQUksQ0FBQztBQUU1QyxTQUFnQixpQkFBaUI7SUFDN0IsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ1osUUFBUSxHQUFHLElBQUksb0JBQW9CLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0lBQ0QsT0FBTyxRQUFRLENBQUM7QUFDcEIsQ0FBQztBQUVELFNBQWdCLG1CQUFtQjtJQUMvQixJQUFJLFFBQVEsSUFBSSxRQUFRLFlBQVksb0JBQW9CLEVBQUUsQ0FBQztRQUN0RCxRQUFpQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2pELENBQUM7SUFDRCxRQUFRLEdBQUcsSUFBSSxDQUFDO0FBQ3BCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL2RhdGEvbW9kZWxzL3Rva2VuLWJsYWNrbGlzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRva2VuIEJsYWNrbGlzdCAtIFNRTGl0ZS1iYWNrZWQgaW1wbGVtZW50YXRpb25cbiAqIFBsdWdnYWJsZSBpbnRlcmZhY2UgYWxsb3dzIGZ1dHVyZSBSZWRpcyBtaWdyYXRpb25cbiAqL1xuXG5pbXBvcnQgRGF0YWJhc2UgZnJvbSAnYmV0dGVyLXNxbGl0ZTMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbi8qKlxuICogUGx1Z2dhYmxlIFRva2VuIEJsYWNrbGlzdCBJbnRlcmZhY2VcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJVG9rZW5CbGFja2xpc3Qge1xuICAgIGFkZChqdGk6IHN0cmluZywgZXhwaXJlc0F0OiBudW1iZXIpOiB2b2lkO1xuICAgIGhhcyhqdGk6IHN0cmluZyk6IGJvb2xlYW47XG4gICAgY2xlYW51cCgpOiBudW1iZXI7XG4gICAgZ2V0U3RhdHMoKTogeyBjb3VudDogbnVtYmVyIH07XG59XG5cbi8qKlxuICogU1FMaXRlLWJhY2tlZCBUb2tlbiBCbGFja2xpc3QgSW1wbGVtZW50YXRpb25cbiAqL1xuZXhwb3J0IGNsYXNzIFNRTGl0ZVRva2VuQmxhY2tsaXN0IGltcGxlbWVudHMgSVRva2VuQmxhY2tsaXN0IHtcbiAgICBwcml2YXRlIGRiOiBEYXRhYmFzZS5EYXRhYmFzZTtcbiAgICBwcml2YXRlIGNsZWFudXBJbnRlcnZhbDogTm9kZUpTLlRpbWVvdXQgfCBudWxsID0gbnVsbDtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihkYlBhdGg/OiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgZGJGaWxlID0gZGJQYXRoIHx8IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi8uLi8uLi9kYXRhL3VuaWZpZWQuZGInKTtcbiAgICAgICAgdGhpcy5kYiA9IG5ldyBEYXRhYmFzZShkYkZpbGUpO1xuICAgICAgICB0aGlzLmluaXRUYWJsZSgpO1xuICAgICAgICB0aGlzLnN0YXJ0Q2xlYW51cFNjaGVkdWxlcigpO1xuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIGluaXRUYWJsZSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5kYi5leGVjKGBcbiAgICAgICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHRva2VuX2JsYWNrbGlzdCAoXG4gICAgICAgICAgICAgICAganRpIFRFWFQgUFJJTUFSWSBLRVksXG4gICAgICAgICAgICAgICAgZXhwaXJlc19hdCBJTlRFR0VSIE5PVCBOVUxMLFxuICAgICAgICAgICAgICAgIGNyZWF0ZWRfYXQgSU5URUdFUiBERUZBVUxUIChzdHJmdGltZSgnJXMnLCAnbm93JykgKiAxMDAwKVxuICAgICAgICAgICAgKVxuICAgICAgICBgKTtcbiAgICAgICAgdGhpcy5kYi5leGVjKCdDUkVBVEUgSU5ERVggSUYgTk9UIEVYSVNUUyBpZHhfYmxhY2tsaXN0X2V4cGlyZXMgT04gdG9rZW5fYmxhY2tsaXN0KGV4cGlyZXNfYXQpJyk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdbVG9rZW5CbGFja2xpc3RdIPCfk4sgU1FMaXRlIO2FjOydtOu4lCDstIjquLDtmZTrkKgnKTtcbiAgICB9XG4gICAgXG4gICAgYWRkKGp0aTogc3RyaW5nLCBleHBpcmVzQXQ6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBjb25zdCBzdG10ID0gdGhpcy5kYi5wcmVwYXJlKCdJTlNFUlQgT1IgUkVQTEFDRSBJTlRPIHRva2VuX2JsYWNrbGlzdCAoanRpLCBleHBpcmVzX2F0KSBWQUxVRVMgKD8sID8pJyk7XG4gICAgICAgIHN0bXQucnVuKGp0aSwgZXhwaXJlc0F0KTtcbiAgICB9XG4gICAgXG4gICAgaGFzKGp0aTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IHN0bXQgPSB0aGlzLmRiLnByZXBhcmUoJ1NFTEVDVCAxIEZST00gdG9rZW5fYmxhY2tsaXN0IFdIRVJFIGp0aSA9ID8gQU5EIGV4cGlyZXNfYXQgPiA/Jyk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHN0bXQuZ2V0KGp0aSwgRGF0ZS5ub3coKSk7XG4gICAgICAgIHJldHVybiByZXN1bHQgIT09IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgXG4gICAgY2xlYW51cCgpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBzdG10ID0gdGhpcy5kYi5wcmVwYXJlKCdERUxFVEUgRlJPTSB0b2tlbl9ibGFja2xpc3QgV0hFUkUgZXhwaXJlc19hdCA8ID8nKTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gc3RtdC5ydW4oRGF0ZS5ub3coKSk7XG4gICAgICAgIHJldHVybiByZXN1bHQuY2hhbmdlcztcbiAgICB9XG4gICAgXG4gICAgZ2V0U3RhdHMoKTogeyBjb3VudDogbnVtYmVyIH0ge1xuICAgICAgICBjb25zdCBzdG10ID0gdGhpcy5kYi5wcmVwYXJlKCdTRUxFQ1QgQ09VTlQoKikgYXMgY291bnQgRlJPTSB0b2tlbl9ibGFja2xpc3QgV0hFUkUgZXhwaXJlc19hdCA+ID8nKTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gc3RtdC5nZXQoRGF0ZS5ub3coKSkgYXMgeyBjb3VudDogbnVtYmVyIH07XG4gICAgICAgIHJldHVybiB7IGNvdW50OiByZXN1bHQuY291bnQgfTtcbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBzdGFydENsZWFudXBTY2hlZHVsZXIoKTogdm9pZCB7XG4gICAgICAgIC8vIENsZWFuIHVwIGV2ZXJ5IGhvdXJcbiAgICAgICAgdGhpcy5jbGVhbnVwSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjbGVhbmVkID0gdGhpcy5jbGVhbnVwKCk7XG4gICAgICAgICAgICBpZiAoY2xlYW5lZCA+IDApIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW1Rva2VuQmxhY2tsaXN0XSDwn6e5ICR7Y2xlYW5lZH3qsJwg66eM66OM65CcIO2GoO2BsCDsoJXrpqzrkKhgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgNjAgKiA2MCAqIDEwMDApO1xuICAgIH1cbiAgICBcbiAgICBkZXN0cm95KCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5jbGVhbnVwSW50ZXJ2YWwpIHtcbiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5jbGVhbnVwSW50ZXJ2YWwpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGIuY2xvc2UoKTtcbiAgICB9XG59XG5cbi8vIFNpbmdsZXRvbiBpbnN0YW5jZVxubGV0IGluc3RhbmNlOiBJVG9rZW5CbGFja2xpc3QgfCBudWxsID0gbnVsbDtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldFRva2VuQmxhY2tsaXN0KCk6IElUb2tlbkJsYWNrbGlzdCB7XG4gICAgaWYgKCFpbnN0YW5jZSkge1xuICAgICAgICBpbnN0YW5jZSA9IG5ldyBTUUxpdGVUb2tlbkJsYWNrbGlzdCgpO1xuICAgIH1cbiAgICByZXR1cm4gaW5zdGFuY2U7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXNldFRva2VuQmxhY2tsaXN0KCk6IHZvaWQge1xuICAgIGlmIChpbnN0YW5jZSAmJiBpbnN0YW5jZSBpbnN0YW5jZW9mIFNRTGl0ZVRva2VuQmxhY2tsaXN0KSB7XG4gICAgICAgIChpbnN0YW5jZSBhcyBTUUxpdGVUb2tlbkJsYWNrbGlzdCkuZGVzdHJveSgpO1xuICAgIH1cbiAgICBpbnN0YW5jZSA9IG51bGw7XG59XG4iXSwidmVyc2lvbiI6M30=