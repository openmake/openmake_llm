{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/data/user-manager.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/data/user-manager.ts"],"sourcesContent":["/**\n * User Manager\n * backend/apiÏóêÏÑú ÏÇ¨Ïö©ÌïòÎäî UserManager ÎûòÌçº\n * \n * üîí Î≥¥Ïïà Í∞ïÌôî: bcryptÎ•º ÏÇ¨Ïö©Ìïú ÎπÑÎ∞ÄÎ≤àÌò∏ Ìï¥Ïã± Ï†ÅÏö©\n * üì¶ SQLite Í∏∞Î∞ò (unified-database ÏÇ¨Ïö©)\n */\n\nimport * as bcrypt from 'bcryptjs';\nimport { getUnifiedDatabase } from './models/unified-database';\n\n// ÎπÑÎ∞ÄÎ≤àÌò∏ Ìï¥Ïã± ÎùºÏö¥Îìú (ÎÜíÏùÑÏàòÎ°ù ÏïàÏ†ÑÌïòÏßÄÎßå ÎäêÎ¶º)\nconst BCRYPT_ROUNDS = 12;\n\nexport type UserRole = 'admin' | 'user' | 'guest';\n\n// MCP ÎèÑÍµ¨ Ï†ëÍ∑º Îì±Í∏â\nexport type UserTier = 'free' | 'pro' | 'enterprise';\n\nexport interface PublicUser {\n    id: number;\n    email: string;\n    role: UserRole;\n    tier: UserTier;\n    created_at: string;\n    last_login?: string;\n    is_active: boolean;\n}\n\nexport interface CreateUserInput {\n    email: string;\n    password: string;\n    role?: UserRole;\n    tier?: UserTier;\n}\n\ninterface UserRow {\n    id: string;\n    username: string;\n    password_hash: string;\n    email: string | null;\n    role: string;\n    tier: string | null;\n    is_active: number;\n    created_at: string;\n    updated_at: string;\n    last_login: string | null;\n}\n\n/**\n * SQLite Í∏∞Î∞ò UserManager\n */\nclass UserManagerImpl {\n    constructor() {\n        this.ensureSchema();\n        this.ensureAdminUser();\n    }\n\n    private ensureSchema(): void {\n        const db = getUnifiedDatabase().getDatabase();\n        try {\n            db.prepare('ALTER TABLE users ADD COLUMN tier TEXT DEFAULT \\'free\\'').run();\n        } catch (_e: unknown) {\n            // \"duplicate column name\" ‚Äî Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Í≤ΩÏö∞ Î¨¥Ïãú\n        }\n    }\n\n    private ensureAdminUser(): void {\n        const db = getUnifiedDatabase().getDatabase();\n        const existing = db.prepare('SELECT id FROM users WHERE username = ?').get('admin') as { id: string } | undefined;\n        if (existing) return;\n\n        // üîí Î≥¥Ïïà Í∞ïÌôî: ÌôòÍ≤ΩÎ≥ÄÏàò ÌïÑÏàòÌôî, Í∏∞Î≥∏ ÎπÑÎ∞ÄÎ≤àÌò∏ Ï†úÍ±∞\n        const adminPassword = process.env.ADMIN_PASSWORD;\n        if (!adminPassword) {\n            console.warn('[UserManager] ‚ö†Ô∏è ADMIN_PASSWORD ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!');\n            console.warn('[UserManager] Í∏∞Î≥∏ Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ïÏù¥ ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏäµÎãàÎã§. .env ÌååÏùºÏóê ADMIN_PASSWORDÎ•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.');\n            if (process.env.NODE_ENV === 'production') {\n                throw new Error('[UserManager] ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤ΩÏóêÏÑúÎäî ADMIN_PASSWORD ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÌïÑÏàòÏûÖÎãàÎã§!');\n            }\n            // Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÏÑúÎßå ÏûÑÏãú ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÉùÏÑ± (ÎûúÎç§)\n            const tempPassword = require('crypto').randomBytes(16).toString('hex');\n            console.warn(`[UserManager] Í∞úÎ∞ú ÌôòÍ≤Ω ÏûÑÏãú ÎπÑÎ∞ÄÎ≤àÌò∏: ${tempPassword}`);\n            this.createUser({\n                email: 'admin',\n                password: tempPassword,\n                role: 'admin'\n            });\n        } else {\n            this.createUser({\n                email: 'admin',\n                password: adminPassword,\n                role: 'admin'\n            });\n        }\n    }\n\n    private getNextId(): number {\n        const db = getUnifiedDatabase().getDatabase();\n        const row = db.prepare('SELECT MAX(CAST(id AS INTEGER)) as maxId FROM users').get() as { maxId: number | null };\n        return (row?.maxId || 0) + 1;\n    }\n\n    private rowToPublicUser(row: UserRow): PublicUser {\n        return {\n            id: parseInt(row.id, 10),\n            email: row.username,\n            role: row.role as UserRole,\n            tier: (row.tier || 'free') as UserTier,\n            is_active: !!row.is_active,\n            created_at: row.created_at,\n            last_login: row.last_login || undefined\n        };\n    }\n\n    createUser(input: CreateUserInput): PublicUser | null {\n        const db = getUnifiedDatabase().getDatabase();\n\n        // Ï§ëÎ≥µ username Ï≤¥ÌÅ¨\n        const existing = db.prepare('SELECT id FROM users WHERE username = ?').get(input.email);\n        if (existing) return null;\n\n        const id = this.getNextId();\n        // admin Ïó≠Ìï†ÏùÄ ÏûêÎèôÏúºÎ°ú enterprise tier\n        const tier = input.tier || (input.role === 'admin' ? 'enterprise' : 'free');\n\n        // üîí bcryptÎ°ú ÎπÑÎ∞ÄÎ≤àÌò∏ Ìï¥Ïã±\n        const passwordHash = bcrypt.hashSync(input.password, BCRYPT_ROUNDS);\n        const now = new Date().toISOString();\n        const role = input.role || 'user';\n\n        db.prepare(\n            `INSERT INTO users (id, username, password_hash, email, role, tier, is_active, created_at, updated_at)\n             VALUES (?, ?, ?, ?, ?, ?, 1, ?, ?)`\n        ).run(String(id), input.email, passwordHash, input.email, role, tier, now, now);\n\n        const row = db.prepare('SELECT * FROM users WHERE id = ?').get(String(id)) as UserRow | undefined;\n        return row ? this.rowToPublicUser(row) : null;\n    }\n\n    authenticate(email: string, password: string): PublicUser | null {\n        const db = getUnifiedDatabase().getDatabase();\n        const row = db.prepare('SELECT * FROM users WHERE username = ? AND is_active = 1').get(email) as UserRow | undefined;\n        if (!row) return null;\n\n        // üîí bcryptÎ°ú ÎπÑÎ∞ÄÎ≤àÌò∏ ÎπÑÍµê (Ìï¥Ïãú ÎπÑÍµê)\n        if (!bcrypt.compareSync(password, row.password_hash)) return null;\n\n        // last_login ÏóÖÎç∞Ïù¥Ìä∏\n        const now = new Date().toISOString();\n        db.prepare('UPDATE users SET last_login = ? WHERE id = ?').run(now, row.id);\n\n        row.last_login = now;\n        return this.rowToPublicUser(row);\n    }\n\n    getUserById(id: number): PublicUser | null {\n        const db = getUnifiedDatabase().getDatabase();\n        const row = db.prepare('SELECT * FROM users WHERE id = ?').get(String(id)) as UserRow | undefined;\n        return row ? this.rowToPublicUser(row) : null;\n    }\n\n    getUserByEmail(email: string): { id: number; email: string; password: string; role: UserRole } | null {\n        const db = getUnifiedDatabase().getDatabase();\n        const row = db.prepare('SELECT * FROM users WHERE username = ?').get(email) as UserRow | undefined;\n        if (!row) return null;\n        return {\n            id: parseInt(row.id, 10),\n            email: row.username,\n            password: row.password_hash,\n            role: row.role as UserRole\n        };\n    }\n\n    getAllUsers(options?: { page?: number; limit?: number; role?: UserRole; search?: string }): { users: PublicUser[]; total: number; page: number; limit: number } {\n        const db = getUnifiedDatabase().getDatabase();\n        const conditions: string[] = [];\n        const params: (string | number)[] = [];\n\n        if (options?.role) {\n            conditions.push('role = ?');\n            params.push(options.role);\n        }\n        if (options?.search) {\n            conditions.push('LOWER(username) LIKE ?');\n            params.push(`%${options.search.toLowerCase()}%`);\n        }\n\n        const whereClause = conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : '';\n\n        // Ï¥ù Í∞úÏàò\n        const countRow = db.prepare(`SELECT COUNT(*) as total FROM users ${whereClause}`).get(...params) as { total: number };\n        const total = countRow.total;\n\n        const page = options?.page || 1;\n        const limit = options?.limit || 20;\n        const offset = (page - 1) * limit;\n\n        const rows = db.prepare(\n            `SELECT * FROM users ${whereClause} LIMIT ? OFFSET ?`\n        ).all(...params, limit, offset) as UserRow[];\n\n        return {\n            users: rows.map(r => this.rowToPublicUser(r)),\n            total,\n            page,\n            limit\n        };\n    }\n\n    changePassword(userId: number, newPassword: string): boolean {\n        const db = getUnifiedDatabase().getDatabase();\n        // üîí ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ÎèÑ Ìï¥Ïã±ÌïòÏó¨ Ï†ÄÏû•\n        const passwordHash = bcrypt.hashSync(newPassword, BCRYPT_ROUNDS);\n        const result = db.prepare('UPDATE users SET password_hash = ?, updated_at = ? WHERE id = ?')\n            .run(passwordHash, new Date().toISOString(), String(userId));\n        return result.changes > 0;\n    }\n\n    changeRole(userId: number, newRole: UserRole): PublicUser | null {\n        const db = getUnifiedDatabase().getDatabase();\n        const result = db.prepare('UPDATE users SET role = ?, updated_at = ? WHERE id = ?')\n            .run(newRole, new Date().toISOString(), String(userId));\n        if (result.changes === 0) return null;\n\n        const row = db.prepare('SELECT * FROM users WHERE id = ?').get(String(userId)) as UserRow | undefined;\n        return row ? this.rowToPublicUser(row) : null;\n    }\n\n    updateUser(userId: number, updates: { email?: string; role?: UserRole; is_active?: boolean }): PublicUser | null {\n        const db = getUnifiedDatabase().getDatabase();\n        const sets: string[] = ['updated_at = ?'];\n        const params: (string | number)[] = [new Date().toISOString()];\n\n        if (updates.email !== undefined) {\n            sets.push('username = ?');\n            params.push(updates.email);\n            sets.push('email = ?');\n            params.push(updates.email);\n        }\n        if (updates.role !== undefined) {\n            sets.push('role = ?');\n            params.push(updates.role);\n        }\n        if (updates.is_active !== undefined) {\n            sets.push('is_active = ?');\n            params.push(updates.is_active ? 1 : 0);\n        }\n\n        params.push(String(userId));\n        const result = db.prepare(`UPDATE users SET ${sets.join(', ')} WHERE id = ?`).run(...params);\n        if (result.changes === 0) return null;\n\n        const row = db.prepare('SELECT * FROM users WHERE id = ?').get(String(userId)) as UserRow | undefined;\n        return row ? this.rowToPublicUser(row) : null;\n    }\n\n    deleteUser(userId: number): boolean {\n        const db = getUnifiedDatabase().getDatabase();\n        const row = db.prepare('SELECT * FROM users WHERE id = ?').get(String(userId)) as UserRow | undefined;\n        if (!row) return false;\n\n        if (row.role === 'admin') {\n            const countRow = db.prepare('SELECT COUNT(*) as cnt FROM users WHERE role = \\'admin\\'').get() as { cnt: number };\n            if (countRow.cnt <= 1) return false;\n        }\n\n        const result = db.prepare('DELETE FROM users WHERE id = ?').run(String(userId));\n        return result.changes > 0;\n    }\n\n    getStats() {\n        const db = getUnifiedDatabase().getDatabase();\n        const totalRow = db.prepare('SELECT COUNT(*) as cnt FROM users').get() as { cnt: number };\n        const activeRow = db.prepare('SELECT COUNT(*) as cnt FROM users WHERE is_active = 1').get() as { cnt: number };\n        const adminRow = db.prepare('SELECT COUNT(*) as cnt FROM users WHERE role = \\'admin\\'').get() as { cnt: number };\n        const userRow = db.prepare('SELECT COUNT(*) as cnt FROM users WHERE role = \\'user\\'').get() as { cnt: number };\n        const guestRow = db.prepare('SELECT COUNT(*) as cnt FROM users WHERE role = \\'guest\\'').get() as { cnt: number };\n        return {\n            totalUsers: totalRow.cnt,\n            activeUsers: activeRow.cnt,\n            adminCount: adminRow.cnt,\n            userCount: userRow.cnt,\n            guestCount: guestRow.cnt\n        };\n    }\n\n    // ÏÇ¨Ïö©Ïûê tier Î≥ÄÍ≤Ω\n    changeTier(userId: number, newTier: UserTier): PublicUser | null {\n        const db = getUnifiedDatabase().getDatabase();\n        const result = db.prepare('UPDATE users SET tier = ?, updated_at = ? WHERE id = ?')\n            .run(newTier, new Date().toISOString(), String(userId));\n        if (result.changes === 0) return null;\n\n        const row = db.prepare('SELECT * FROM users WHERE id = ?').get(String(userId)) as UserRow | undefined;\n        return row ? this.rowToPublicUser(row) : null;\n    }\n}\n\nlet userManagerInstance: UserManagerImpl | null = null;\n\nexport function getUserManager(): UserManagerImpl {\n    if (!userManagerInstance) userManagerInstance = new UserManagerImpl();\n    return userManagerInstance;\n}\n"],"version":3}