fd287a353e8d3f4a0e47a699bb6d9228
"use strict";
/**
 * User Manager
 * backend/apiÏóêÏÑú ÏÇ¨Ïö©ÌïòÎäî UserManager ÎûòÌçº
 *
 * üîí Î≥¥Ïïà Í∞ïÌôî: bcryptÎ•º ÏÇ¨Ïö©Ìïú ÎπÑÎ∞ÄÎ≤àÌò∏ Ìï¥Ïã± Ï†ÅÏö©
 * üì¶ SQLite Í∏∞Î∞ò (unified-database ÏÇ¨Ïö©)
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.getUserManager = getUserManager;
const bcrypt = __importStar(require("bcryptjs"));
const unified_database_1 = require("./models/unified-database");
// ÎπÑÎ∞ÄÎ≤àÌò∏ Ìï¥Ïã± ÎùºÏö¥Îìú (ÎÜíÏùÑÏàòÎ°ù ÏïàÏ†ÑÌïòÏßÄÎßå ÎäêÎ¶º)
const BCRYPT_ROUNDS = 12;
/**
 * SQLite Í∏∞Î∞ò UserManager
 */
class UserManagerImpl {
    constructor() {
        this.ensureSchema();
        this.ensureAdminUser();
    }
    ensureSchema() {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        try {
            db.prepare('ALTER TABLE users ADD COLUMN tier TEXT DEFAULT \'free\'').run();
        }
        catch (_e) {
            // "duplicate column name" ‚Äî Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Í≤ΩÏö∞ Î¨¥Ïãú
        }
    }
    ensureAdminUser() {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        const existing = db.prepare('SELECT id FROM users WHERE username = ?').get('admin');
        if (existing)
            return;
        // üîí Î≥¥Ïïà Í∞ïÌôî: ÌôòÍ≤ΩÎ≥ÄÏàò ÌïÑÏàòÌôî, Í∏∞Î≥∏ ÎπÑÎ∞ÄÎ≤àÌò∏ Ï†úÍ±∞
        const adminPassword = process.env.ADMIN_PASSWORD;
        if (!adminPassword) {
            console.warn('[UserManager] ‚ö†Ô∏è ADMIN_PASSWORD ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!');
            console.warn('[UserManager] Í∏∞Î≥∏ Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ïÏù¥ ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏäµÎãàÎã§. .env ÌååÏùºÏóê ADMIN_PASSWORDÎ•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.');
            if (process.env.NODE_ENV === 'production') {
                throw new Error('[UserManager] ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤ΩÏóêÏÑúÎäî ADMIN_PASSWORD ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÌïÑÏàòÏûÖÎãàÎã§!');
            }
            // Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÏÑúÎßå ÏûÑÏãú ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÉùÏÑ± (ÎûúÎç§)
            const tempPassword = require('crypto').randomBytes(16).toString('hex');
            console.warn(`[UserManager] Í∞úÎ∞ú ÌôòÍ≤Ω ÏûÑÏãú ÎπÑÎ∞ÄÎ≤àÌò∏: ${tempPassword}`);
            this.createUser({
                email: 'admin',
                password: tempPassword,
                role: 'admin'
            });
        }
        else {
            this.createUser({
                email: 'admin',
                password: adminPassword,
                role: 'admin'
            });
        }
    }
    getNextId() {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        const row = db.prepare('SELECT MAX(CAST(id AS INTEGER)) as maxId FROM users').get();
        return ((row === null || row === void 0 ? void 0 : row.maxId) || 0) + 1;
    }
    rowToPublicUser(row) {
        return {
            id: parseInt(row.id, 10),
            email: row.username,
            role: row.role,
            tier: (row.tier || 'free'),
            is_active: !!row.is_active,
            created_at: row.created_at,
            last_login: row.last_login || undefined
        };
    }
    createUser(input) {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        // Ï§ëÎ≥µ username Ï≤¥ÌÅ¨
        const existing = db.prepare('SELECT id FROM users WHERE username = ?').get(input.email);
        if (existing)
            return null;
        const id = this.getNextId();
        // admin Ïó≠Ìï†ÏùÄ ÏûêÎèôÏúºÎ°ú enterprise tier
        const tier = input.tier || (input.role === 'admin' ? 'enterprise' : 'free');
        // üîí bcryptÎ°ú ÎπÑÎ∞ÄÎ≤àÌò∏ Ìï¥Ïã±
        const passwordHash = bcrypt.hashSync(input.password, BCRYPT_ROUNDS);
        const now = new Date().toISOString();
        const role = input.role || 'user';
        db.prepare(`INSERT INTO users (id, username, password_hash, email, role, tier, is_active, created_at, updated_at)
             VALUES (?, ?, ?, ?, ?, ?, 1, ?, ?)`).run(String(id), input.email, passwordHash, input.email, role, tier, now, now);
        const row = db.prepare('SELECT * FROM users WHERE id = ?').get(String(id));
        return row ? this.rowToPublicUser(row) : null;
    }
    authenticate(email, password) {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        const row = db.prepare('SELECT * FROM users WHERE username = ? AND is_active = 1').get(email);
        if (!row)
            return null;
        // üîí bcryptÎ°ú ÎπÑÎ∞ÄÎ≤àÌò∏ ÎπÑÍµê (Ìï¥Ïãú ÎπÑÍµê)
        if (!bcrypt.compareSync(password, row.password_hash))
            return null;
        // last_login ÏóÖÎç∞Ïù¥Ìä∏
        const now = new Date().toISOString();
        db.prepare('UPDATE users SET last_login = ? WHERE id = ?').run(now, row.id);
        row.last_login = now;
        return this.rowToPublicUser(row);
    }
    getUserById(id) {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        const row = db.prepare('SELECT * FROM users WHERE id = ?').get(String(id));
        return row ? this.rowToPublicUser(row) : null;
    }
    getUserByEmail(email) {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        const row = db.prepare('SELECT * FROM users WHERE username = ?').get(email);
        if (!row)
            return null;
        return {
            id: parseInt(row.id, 10),
            email: row.username,
            password: row.password_hash,
            role: row.role
        };
    }
    getAllUsers(options) {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        const conditions = [];
        const params = [];
        if (options === null || options === void 0 ? void 0 : options.role) {
            conditions.push('role = ?');
            params.push(options.role);
        }
        if (options === null || options === void 0 ? void 0 : options.search) {
            conditions.push('LOWER(username) LIKE ?');
            params.push(`%${options.search.toLowerCase()}%`);
        }
        const whereClause = conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : '';
        // Ï¥ù Í∞úÏàò
        const countRow = db.prepare(`SELECT COUNT(*) as total FROM users ${whereClause}`).get(...params);
        const total = countRow.total;
        const page = (options === null || options === void 0 ? void 0 : options.page) || 1;
        const limit = (options === null || options === void 0 ? void 0 : options.limit) || 20;
        const offset = (page - 1) * limit;
        const rows = db.prepare(`SELECT * FROM users ${whereClause} LIMIT ? OFFSET ?`).all(...params, limit, offset);
        return {
            users: rows.map(r => this.rowToPublicUser(r)),
            total,
            page,
            limit
        };
    }
    changePassword(userId, newPassword) {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        // üîí ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ÎèÑ Ìï¥Ïã±ÌïòÏó¨ Ï†ÄÏû•
        const passwordHash = bcrypt.hashSync(newPassword, BCRYPT_ROUNDS);
        const result = db.prepare('UPDATE users SET password_hash = ?, updated_at = ? WHERE id = ?')
            .run(passwordHash, new Date().toISOString(), String(userId));
        return result.changes > 0;
    }
    changeRole(userId, newRole) {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        const result = db.prepare('UPDATE users SET role = ?, updated_at = ? WHERE id = ?')
            .run(newRole, new Date().toISOString(), String(userId));
        if (result.changes === 0)
            return null;
        const row = db.prepare('SELECT * FROM users WHERE id = ?').get(String(userId));
        return row ? this.rowToPublicUser(row) : null;
    }
    updateUser(userId, updates) {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        const sets = ['updated_at = ?'];
        const params = [new Date().toISOString()];
        if (updates.email !== undefined) {
            sets.push('username = ?');
            params.push(updates.email);
            sets.push('email = ?');
            params.push(updates.email);
        }
        if (updates.role !== undefined) {
            sets.push('role = ?');
            params.push(updates.role);
        }
        if (updates.is_active !== undefined) {
            sets.push('is_active = ?');
            params.push(updates.is_active ? 1 : 0);
        }
        params.push(String(userId));
        const result = db.prepare(`UPDATE users SET ${sets.join(', ')} WHERE id = ?`).run(...params);
        if (result.changes === 0)
            return null;
        const row = db.prepare('SELECT * FROM users WHERE id = ?').get(String(userId));
        return row ? this.rowToPublicUser(row) : null;
    }
    deleteUser(userId) {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        const row = db.prepare('SELECT * FROM users WHERE id = ?').get(String(userId));
        if (!row)
            return false;
        if (row.role === 'admin') {
            const countRow = db.prepare('SELECT COUNT(*) as cnt FROM users WHERE role = \'admin\'').get();
            if (countRow.cnt <= 1)
                return false;
        }
        const result = db.prepare('DELETE FROM users WHERE id = ?').run(String(userId));
        return result.changes > 0;
    }
    getStats() {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        const totalRow = db.prepare('SELECT COUNT(*) as cnt FROM users').get();
        const activeRow = db.prepare('SELECT COUNT(*) as cnt FROM users WHERE is_active = 1').get();
        const adminRow = db.prepare('SELECT COUNT(*) as cnt FROM users WHERE role = \'admin\'').get();
        const userRow = db.prepare('SELECT COUNT(*) as cnt FROM users WHERE role = \'user\'').get();
        const guestRow = db.prepare('SELECT COUNT(*) as cnt FROM users WHERE role = \'guest\'').get();
        return {
            totalUsers: totalRow.cnt,
            activeUsers: activeRow.cnt,
            adminCount: adminRow.cnt,
            userCount: userRow.cnt,
            guestCount: guestRow.cnt
        };
    }
    // ÏÇ¨Ïö©Ïûê tier Î≥ÄÍ≤Ω
    changeTier(userId, newTier) {
        const db = (0, unified_database_1.getUnifiedDatabase)().getDatabase();
        const result = db.prepare('UPDATE users SET tier = ?, updated_at = ? WHERE id = ?')
            .run(newTier, new Date().toISOString(), String(userId));
        if (result.changes === 0)
            return null;
        const row = db.prepare('SELECT * FROM users WHERE id = ?').get(String(userId));
        return row ? this.rowToPublicUser(row) : null;
    }
}
let userManagerInstance = null;
function getUserManager() {
    if (!userManagerInstance)
        userManagerInstance = new UserManagerImpl();
    return userManagerInstance;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL2RhdGEvdXNlci1tYW5hZ2VyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBdVNILHdDQUdDO0FBeFNELGlEQUFtQztBQUNuQyxnRUFBK0Q7QUFFL0QsOEJBQThCO0FBQzlCLE1BQU0sYUFBYSxHQUFHLEVBQUUsQ0FBQztBQXFDekI7O0dBRUc7QUFDSCxNQUFNLGVBQWU7SUFDakI7UUFDSSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFTyxZQUFZO1FBQ2hCLE1BQU0sRUFBRSxHQUFHLElBQUEscUNBQWtCLEdBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM5QyxJQUFJLENBQUM7WUFDRCxFQUFFLENBQUMsT0FBTyxDQUFDLHlEQUF5RCxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDaEYsQ0FBQztRQUFDLE9BQU8sRUFBVyxFQUFFLENBQUM7WUFDbkIsMENBQTBDO1FBQzlDLENBQUM7SUFDTCxDQUFDO0lBRU8sZUFBZTtRQUNuQixNQUFNLEVBQUUsR0FBRyxJQUFBLHFDQUFrQixHQUFFLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDOUMsTUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQStCLENBQUM7UUFDbEgsSUFBSSxRQUFRO1lBQUUsT0FBTztRQUVyQixpQ0FBaUM7UUFDakMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7UUFDakQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ2pCLE9BQU8sQ0FBQyxJQUFJLENBQUMsbURBQW1ELENBQUMsQ0FBQztZQUNsRSxPQUFPLENBQUMsSUFBSSxDQUFDLHFFQUFxRSxDQUFDLENBQUM7WUFD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LENBQUMsa0NBQWtDLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUF3QixDQUFDO1FBQ3RHLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDbEQsQ0FBQztDQUNKO0FBRUQsSUFBSSxtQkFBbUIsR0FBMkIsSUFBSSxDQUFDO0FBRXZELFNBQWdCLGNBQWM7SUFDMUIsSUFBSSxDQUFDLG1CQUFtQjtRQUFFLG1CQUFtQixHQUFHLElBQUksZUFBZSxFQUFFLENBQUM7SUFDdEUsT0FBTyxtQkFBbUIsQ0FBQztBQUMvQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Wb2x1bWVzL01BQ19BUFAvb3Blbm1ha2VfbGxtL2JhY2tlbmQvYXBpL3NyYy9kYXRhL3VzZXItbWFuYWdlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFVzZXIgTWFuYWdlclxuICogYmFja2VuZC9hcGnsl5DshJwg7IKs7Jqp7ZWY64qUIFVzZXJNYW5hZ2VyIOuemO2NvFxuICogXG4gKiDwn5SSIOuztOyViCDqsJXtmZQ6IGJjcnlwdOulvCDsgqzsmqntlZwg67mE67CA67KI7Zi4IO2VtOyLsSDsoIHsmqlcbiAqIPCfk6YgU1FMaXRlIOq4sOuwmCAodW5pZmllZC1kYXRhYmFzZSDsgqzsmqkpXG4gKi9cblxuaW1wb3J0ICogYXMgYmNyeXB0IGZyb20gJ2JjcnlwdGpzJztcbmltcG9ydCB7IGdldFVuaWZpZWREYXRhYmFzZSB9IGZyb20gJy4vbW9kZWxzL3VuaWZpZWQtZGF0YWJhc2UnO1xuXG4vLyDruYTrsIDrsojtmLgg7ZW07IuxIOudvOyatOuTnCAo64aS7J2E7IiY66GdIOyViOyghO2VmOyngOunjCDripDrprwpXG5jb25zdCBCQ1JZUFRfUk9VTkRTID0gMTI7XG5cbmV4cG9ydCB0eXBlIFVzZXJSb2xlID0gJ2FkbWluJyB8ICd1c2VyJyB8ICdndWVzdCc7XG5cbi8vIE1DUCDrj4Tqtawg7KCR6re8IOuTseq4iVxuZXhwb3J0IHR5cGUgVXNlclRpZXIgPSAnZnJlZScgfCAncHJvJyB8ICdlbnRlcnByaXNlJztcblxuZXhwb3J0IGludGVyZmFjZSBQdWJsaWNVc2VyIHtcbiAgICBpZDogbnVtYmVyO1xuICAgIGVtYWlsOiBzdHJpbmc7XG4gICAgcm9sZTogVXNlclJvbGU7XG4gICAgdGllcjogVXNlclRpZXI7XG4gICAgY3JlYXRlZF9hdDogc3RyaW5nO1xuICAgIGxhc3RfbG9naW4/OiBzdHJpbmc7XG4gICAgaXNfYWN0aXZlOiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENyZWF0ZVVzZXJJbnB1dCB7XG4gICAgZW1haWw6IHN0cmluZztcbiAgICBwYXNzd29yZDogc3RyaW5nO1xuICAgIHJvbGU/OiBVc2VyUm9sZTtcbiAgICB0aWVyPzogVXNlclRpZXI7XG59XG5cbmludGVyZmFjZSBVc2VyUm93IHtcbiAgICBpZDogc3RyaW5nO1xuICAgIHVzZXJuYW1lOiBzdHJpbmc7XG4gICAgcGFzc3dvcmRfaGFzaDogc3RyaW5nO1xuICAgIGVtYWlsOiBzdHJpbmcgfCBudWxsO1xuICAgIHJvbGU6IHN0cmluZztcbiAgICB0aWVyOiBzdHJpbmcgfCBudWxsO1xuICAgIGlzX2FjdGl2ZTogbnVtYmVyO1xuICAgIGNyZWF0ZWRfYXQ6IHN0cmluZztcbiAgICB1cGRhdGVkX2F0OiBzdHJpbmc7XG4gICAgbGFzdF9sb2dpbjogc3RyaW5nIHwgbnVsbDtcbn1cblxuLyoqXG4gKiBTUUxpdGUg6riw67CYIFVzZXJNYW5hZ2VyXG4gKi9cbmNsYXNzIFVzZXJNYW5hZ2VySW1wbCB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuZW5zdXJlU2NoZW1hKCk7XG4gICAgICAgIHRoaXMuZW5zdXJlQWRtaW5Vc2VyKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBlbnN1cmVTY2hlbWEoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGRiID0gZ2V0VW5pZmllZERhdGFiYXNlKCkuZ2V0RGF0YWJhc2UoKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiLnByZXBhcmUoJ0FMVEVSIFRBQkxFIHVzZXJzIEFERCBDT0xVTU4gdGllciBURVhUIERFRkFVTFQgXFwnZnJlZVxcJycpLnJ1bigpO1xuICAgICAgICB9IGNhdGNoIChfZTogdW5rbm93bikge1xuICAgICAgICAgICAgLy8gXCJkdXBsaWNhdGUgY29sdW1uIG5hbWVcIiDigJQg7J2066+4IOyhtOyerO2VmOuKlCDqsr3smrAg66y07IucXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGVuc3VyZUFkbWluVXNlcigpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZGIgPSBnZXRVbmlmaWVkRGF0YWJhc2UoKS5nZXREYXRhYmFzZSgpO1xuICAgICAgICBjb25zdCBleGlzdGluZyA9IGRiLnByZXBhcmUoJ1NFTEVDVCBpZCBGUk9NIHVzZXJzIFdIRVJFIHVzZXJuYW1lID0gPycpLmdldCgnYWRtaW4nKSBhcyB7IGlkOiBzdHJpbmcgfSB8IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKGV4aXN0aW5nKSByZXR1cm47XG5cbiAgICAgICAgLy8g8J+UkiDrs7TslYgg6rCV7ZmUOiDtmZjqsr3rs4DsiJgg7ZWE7IiY7ZmULCDquLDrs7gg67mE67CA67KI7Zi4IOygnOqxsFxuICAgICAgICBjb25zdCBhZG1pblBhc3N3b3JkID0gcHJvY2Vzcy5lbnYuQURNSU5fUEFTU1dPUkQ7XG4gICAgICAgIGlmICghYWRtaW5QYXNzd29yZCkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdbVXNlck1hbmFnZXJdIOKaoO+4jyBBRE1JTl9QQVNTV09SRCDtmZjqsr3rs4DsiJjqsIAg7ISk7KCV65CY7KeAIOyViuyVmOyKteuLiOuLpCEnKTtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybignW1VzZXJNYW5hZ2VyXSDquLDrs7gg6rSA66as7J6QIOqzhOygleydtCDsg53shLHrkJjsp4Ag7JWK7Iq164uI64ukLiAuZW52IO2MjOydvOyXkCBBRE1JTl9QQVNTV09SROulvCDshKTsoJXtlZjshLjsmpQuJyk7XG4gICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignW1VzZXJNYW5hZ2VyXSDtlITroZzrjZXshZgg7ZmY6rK97JeQ7ISc64qUIEFETUlOX1BBU1NXT1JEIO2ZmOqyveuzgOyImOqwgCDtlYTsiJjsnoXri4jri6QhJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyDqsJzrsJwg7ZmY6rK97JeQ7ISc66eMIOyehOyLnCDruYTrsIDrsojtmLgg7IOd7ISxICjrnpzrjaQpXG4gICAgICAgICAgICBjb25zdCB0ZW1wUGFzc3dvcmQgPSByZXF1aXJlKCdjcnlwdG8nKS5yYW5kb21CeXRlcygxNikudG9TdHJpbmcoJ2hleCcpO1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBbVXNlck1hbmFnZXJdIOqwnOuwnCDtmZjqsr0g7J6E7IucIOu5hOuwgOuyiO2YuDogJHt0ZW1wUGFzc3dvcmR9YCk7XG4gICAgICAgICAgICB0aGlzLmNyZWF0ZVVzZXIoe1xuICAgICAgICAgICAgICAgIGVtYWlsOiAnYWRtaW4nLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB0ZW1wUGFzc3dvcmQsXG4gICAgICAgICAgICAgICAgcm9sZTogJ2FkbWluJ1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNyZWF0ZVVzZXIoe1xuICAgICAgICAgICAgICAgIGVtYWlsOiAnYWRtaW4nLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBhZG1pblBhc3N3b3JkLFxuICAgICAgICAgICAgICAgIHJvbGU6ICdhZG1pbidcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXROZXh0SWQoKTogbnVtYmVyIHtcbiAgICAgICAgY29uc3QgZGIgPSBnZXRVbmlmaWVkRGF0YWJhc2UoKS5nZXREYXRhYmFzZSgpO1xuICAgICAgICBjb25zdCByb3cgPSBkYi5wcmVwYXJlKCdTRUxFQ1QgTUFYKENBU1QoaWQgQVMgSU5URUdFUikpIGFzIG1heElkIEZST00gdXNlcnMnKS5nZXQoKSBhcyB7IG1heElkOiBudW1iZXIgfCBudWxsIH07XG4gICAgICAgIHJldHVybiAocm93Py5tYXhJZCB8fCAwKSArIDE7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByb3dUb1B1YmxpY1VzZXIocm93OiBVc2VyUm93KTogUHVibGljVXNlciB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpZDogcGFyc2VJbnQocm93LmlkLCAxMCksXG4gICAgICAgICAgICBlbWFpbDogcm93LnVzZXJuYW1lLFxuICAgICAgICAgICAgcm9sZTogcm93LnJvbGUgYXMgVXNlclJvbGUsXG4gICAgICAgICAgICB0aWVyOiAocm93LnRpZXIgfHwgJ2ZyZWUnKSBhcyBVc2VyVGllcixcbiAgICAgICAgICAgIGlzX2FjdGl2ZTogISFyb3cuaXNfYWN0aXZlLFxuICAgICAgICAgICAgY3JlYXRlZF9hdDogcm93LmNyZWF0ZWRfYXQsXG4gICAgICAgICAgICBsYXN0X2xvZ2luOiByb3cubGFzdF9sb2dpbiB8fCB1bmRlZmluZWRcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBjcmVhdGVVc2VyKGlucHV0OiBDcmVhdGVVc2VySW5wdXQpOiBQdWJsaWNVc2VyIHwgbnVsbCB7XG4gICAgICAgIGNvbnN0IGRiID0gZ2V0VW5pZmllZERhdGFiYXNlKCkuZ2V0RGF0YWJhc2UoKTtcblxuICAgICAgICAvLyDspJHrs7UgdXNlcm5hbWUg7LK07YGsXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nID0gZGIucHJlcGFyZSgnU0VMRUNUIGlkIEZST00gdXNlcnMgV0hFUkUgdXNlcm5hbWUgPSA/JykuZ2V0KGlucHV0LmVtYWlsKTtcbiAgICAgICAgaWYgKGV4aXN0aW5nKSByZXR1cm4gbnVsbDtcblxuICAgICAgICBjb25zdCBpZCA9IHRoaXMuZ2V0TmV4dElkKCk7XG4gICAgICAgIC8vIGFkbWluIOyXre2VoOydgCDsnpDrj5nsnLzroZwgZW50ZXJwcmlzZSB0aWVyXG4gICAgICAgIGNvbnN0IHRpZXIgPSBpbnB1dC50aWVyIHx8IChpbnB1dC5yb2xlID09PSAnYWRtaW4nID8gJ2VudGVycHJpc2UnIDogJ2ZyZWUnKTtcblxuICAgICAgICAvLyDwn5SSIGJjcnlwdOuhnCDruYTrsIDrsojtmLgg7ZW07IuxXG4gICAgICAgIGNvbnN0IHBhc3N3b3JkSGFzaCA9IGJjcnlwdC5oYXNoU3luYyhpbnB1dC5wYXNzd29yZCwgQkNSWVBUX1JPVU5EUyk7XG4gICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICAgICAgY29uc3Qgcm9sZSA9IGlucHV0LnJvbGUgfHwgJ3VzZXInO1xuXG4gICAgICAgIGRiLnByZXBhcmUoXG4gICAgICAgICAgICBgSU5TRVJUIElOVE8gdXNlcnMgKGlkLCB1c2VybmFtZSwgcGFzc3dvcmRfaGFzaCwgZW1haWwsIHJvbGUsIHRpZXIsIGlzX2FjdGl2ZSwgY3JlYXRlZF9hdCwgdXBkYXRlZF9hdClcbiAgICAgICAgICAgICBWQUxVRVMgKD8sID8sID8sID8sID8sID8sIDEsID8sID8pYFxuICAgICAgICApLnJ1bihTdHJpbmcoaWQpLCBpbnB1dC5lbWFpbCwgcGFzc3dvcmRIYXNoLCBpbnB1dC5lbWFpbCwgcm9sZSwgdGllciwgbm93LCBub3cpO1xuXG4gICAgICAgIGNvbnN0IHJvdyA9IGRiLnByZXBhcmUoJ1NFTEVDVCAqIEZST00gdXNlcnMgV0hFUkUgaWQgPSA/JykuZ2V0KFN0cmluZyhpZCkpIGFzIFVzZXJSb3cgfCB1bmRlZmluZWQ7XG4gICAgICAgIHJldHVybiByb3cgPyB0aGlzLnJvd1RvUHVibGljVXNlcihyb3cpIDogbnVsbDtcbiAgICB9XG5cbiAgICBhdXRoZW50aWNhdGUoZW1haWw6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZyk6IFB1YmxpY1VzZXIgfCBudWxsIHtcbiAgICAgICAgY29uc3QgZGIgPSBnZXRVbmlmaWVkRGF0YWJhc2UoKS5nZXREYXRhYmFzZSgpO1xuICAgICAgICBjb25zdCByb3cgPSBkYi5wcmVwYXJlKCdTRUxFQ1QgKiBGUk9NIHVzZXJzIFdIRVJFIHVzZXJuYW1lID0gPyBBTkQgaXNfYWN0aXZlID0gMScpLmdldChlbWFpbCkgYXMgVXNlclJvdyB8IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKCFyb3cpIHJldHVybiBudWxsO1xuXG4gICAgICAgIC8vIPCflJIgYmNyeXB066GcIOu5hOuwgOuyiO2YuCDruYTqtZAgKO2VtOyLnCDruYTqtZApXG4gICAgICAgIGlmICghYmNyeXB0LmNvbXBhcmVTeW5jKHBhc3N3b3JkLCByb3cucGFzc3dvcmRfaGFzaCkpIHJldHVybiBudWxsO1xuXG4gICAgICAgIC8vIGxhc3RfbG9naW4g7JeF642w7J207Yq4XG4gICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICAgICAgZGIucHJlcGFyZSgnVVBEQVRFIHVzZXJzIFNFVCBsYXN0X2xvZ2luID0gPyBXSEVSRSBpZCA9ID8nKS5ydW4obm93LCByb3cuaWQpO1xuXG4gICAgICAgIHJvdy5sYXN0X2xvZ2luID0gbm93O1xuICAgICAgICByZXR1cm4gdGhpcy5yb3dUb1B1YmxpY1VzZXIocm93KTtcbiAgICB9XG5cbiAgICBnZXRVc2VyQnlJZChpZDogbnVtYmVyKTogUHVibGljVXNlciB8IG51bGwge1xuICAgICAgICBjb25zdCBkYiA9IGdldFVuaWZpZWREYXRhYmFzZSgpLmdldERhdGFiYXNlKCk7XG4gICAgICAgIGNvbnN0IHJvdyA9IGRiLnByZXBhcmUoJ1NFTEVDVCAqIEZST00gdXNlcnMgV0hFUkUgaWQgPSA/JykuZ2V0KFN0cmluZyhpZCkpIGFzIFVzZXJSb3cgfCB1bmRlZmluZWQ7XG4gICAgICAgIHJldHVybiByb3cgPyB0aGlzLnJvd1RvUHVibGljVXNlcihyb3cpIDogbnVsbDtcbiAgICB9XG5cbiAgICBnZXRVc2VyQnlFbWFpbChlbWFpbDogc3RyaW5nKTogeyBpZDogbnVtYmVyOyBlbWFpbDogc3RyaW5nOyBwYXNzd29yZDogc3RyaW5nOyByb2xlOiBVc2VyUm9sZSB9IHwgbnVsbCB7XG4gICAgICAgIGNvbnN0IGRiID0gZ2V0VW5pZmllZERhdGFiYXNlKCkuZ2V0RGF0YWJhc2UoKTtcbiAgICAgICAgY29uc3Qgcm93ID0gZGIucHJlcGFyZSgnU0VMRUNUICogRlJPTSB1c2VycyBXSEVSRSB1c2VybmFtZSA9ID8nKS5nZXQoZW1haWwpIGFzIFVzZXJSb3cgfCB1bmRlZmluZWQ7XG4gICAgICAgIGlmICghcm93KSByZXR1cm4gbnVsbDtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGlkOiBwYXJzZUludChyb3cuaWQsIDEwKSxcbiAgICAgICAgICAgIGVtYWlsOiByb3cudXNlcm5hbWUsXG4gICAgICAgICAgICBwYXNzd29yZDogcm93LnBhc3N3b3JkX2hhc2gsXG4gICAgICAgICAgICByb2xlOiByb3cucm9sZSBhcyBVc2VyUm9sZVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGdldEFsbFVzZXJzKG9wdGlvbnM/OiB7IHBhZ2U/OiBudW1iZXI7IGxpbWl0PzogbnVtYmVyOyByb2xlPzogVXNlclJvbGU7IHNlYXJjaD86IHN0cmluZyB9KTogeyB1c2VyczogUHVibGljVXNlcltdOyB0b3RhbDogbnVtYmVyOyBwYWdlOiBudW1iZXI7IGxpbWl0OiBudW1iZXIgfSB7XG4gICAgICAgIGNvbnN0IGRiID0gZ2V0VW5pZmllZERhdGFiYXNlKCkuZ2V0RGF0YWJhc2UoKTtcbiAgICAgICAgY29uc3QgY29uZGl0aW9uczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgY29uc3QgcGFyYW1zOiAoc3RyaW5nIHwgbnVtYmVyKVtdID0gW107XG5cbiAgICAgICAgaWYgKG9wdGlvbnM/LnJvbGUpIHtcbiAgICAgICAgICAgIGNvbmRpdGlvbnMucHVzaCgncm9sZSA9ID8nKTtcbiAgICAgICAgICAgIHBhcmFtcy5wdXNoKG9wdGlvbnMucm9sZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG9wdGlvbnM/LnNlYXJjaCkge1xuICAgICAgICAgICAgY29uZGl0aW9ucy5wdXNoKCdMT1dFUih1c2VybmFtZSkgTElLRSA/Jyk7XG4gICAgICAgICAgICBwYXJhbXMucHVzaChgJSR7b3B0aW9ucy5zZWFyY2gudG9Mb3dlckNhc2UoKX0lYCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB3aGVyZUNsYXVzZSA9IGNvbmRpdGlvbnMubGVuZ3RoID4gMCA/IGBXSEVSRSAke2NvbmRpdGlvbnMuam9pbignIEFORCAnKX1gIDogJyc7XG5cbiAgICAgICAgLy8g7LSdIOqwnOyImFxuICAgICAgICBjb25zdCBjb3VudFJvdyA9IGRiLnByZXBhcmUoYFNFTEVDVCBDT1VOVCgqKSBhcyB0b3RhbCBGUk9NIHVzZXJzICR7d2hlcmVDbGF1c2V9YCkuZ2V0KC4uLnBhcmFtcykgYXMgeyB0b3RhbDogbnVtYmVyIH07XG4gICAgICAgIGNvbnN0IHRvdGFsID0gY291bnRSb3cudG90YWw7XG5cbiAgICAgICAgY29uc3QgcGFnZSA9IG9wdGlvbnM/LnBhZ2UgfHwgMTtcbiAgICAgICAgY29uc3QgbGltaXQgPSBvcHRpb25zPy5saW1pdCB8fCAyMDtcbiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gKHBhZ2UgLSAxKSAqIGxpbWl0O1xuXG4gICAgICAgIGNvbnN0IHJvd3MgPSBkYi5wcmVwYXJlKFxuICAgICAgICAgICAgYFNFTEVDVCAqIEZST00gdXNlcnMgJHt3aGVyZUNsYXVzZX0gTElNSVQgPyBPRkZTRVQgP2BcbiAgICAgICAgKS5hbGwoLi4ucGFyYW1zLCBsaW1pdCwgb2Zmc2V0KSBhcyBVc2VyUm93W107XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHVzZXJzOiByb3dzLm1hcChyID0+IHRoaXMucm93VG9QdWJsaWNVc2VyKHIpKSxcbiAgICAgICAgICAgIHRvdGFsLFxuICAgICAgICAgICAgcGFnZSxcbiAgICAgICAgICAgIGxpbWl0XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgY2hhbmdlUGFzc3dvcmQodXNlcklkOiBudW1iZXIsIG5ld1Bhc3N3b3JkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgZGIgPSBnZXRVbmlmaWVkRGF0YWJhc2UoKS5nZXREYXRhYmFzZSgpO1xuICAgICAgICAvLyDwn5SSIOyDiCDruYTrsIDrsojtmLjrj4Qg7ZW07Iux7ZWY7JesIOyggOyepVxuICAgICAgICBjb25zdCBwYXNzd29yZEhhc2ggPSBiY3J5cHQuaGFzaFN5bmMobmV3UGFzc3dvcmQsIEJDUllQVF9ST1VORFMpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSBkYi5wcmVwYXJlKCdVUERBVEUgdXNlcnMgU0VUIHBhc3N3b3JkX2hhc2ggPSA/LCB1cGRhdGVkX2F0ID0gPyBXSEVSRSBpZCA9ID8nKVxuICAgICAgICAgICAgLnJ1bihwYXNzd29yZEhhc2gsIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwgU3RyaW5nKHVzZXJJZCkpO1xuICAgICAgICByZXR1cm4gcmVzdWx0LmNoYW5nZXMgPiAwO1xuICAgIH1cblxuICAgIGNoYW5nZVJvbGUodXNlcklkOiBudW1iZXIsIG5ld1JvbGU6IFVzZXJSb2xlKTogUHVibGljVXNlciB8IG51bGwge1xuICAgICAgICBjb25zdCBkYiA9IGdldFVuaWZpZWREYXRhYmFzZSgpLmdldERhdGFiYXNlKCk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGRiLnByZXBhcmUoJ1VQREFURSB1c2VycyBTRVQgcm9sZSA9ID8sIHVwZGF0ZWRfYXQgPSA/IFdIRVJFIGlkID0gPycpXG4gICAgICAgICAgICAucnVuKG5ld1JvbGUsIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwgU3RyaW5nKHVzZXJJZCkpO1xuICAgICAgICBpZiAocmVzdWx0LmNoYW5nZXMgPT09IDApIHJldHVybiBudWxsO1xuXG4gICAgICAgIGNvbnN0IHJvdyA9IGRiLnByZXBhcmUoJ1NFTEVDVCAqIEZST00gdXNlcnMgV0hFUkUgaWQgPSA/JykuZ2V0KFN0cmluZyh1c2VySWQpKSBhcyBVc2VyUm93IHwgdW5kZWZpbmVkO1xuICAgICAgICByZXR1cm4gcm93ID8gdGhpcy5yb3dUb1B1YmxpY1VzZXIocm93KSA6IG51bGw7XG4gICAgfVxuXG4gICAgdXBkYXRlVXNlcih1c2VySWQ6IG51bWJlciwgdXBkYXRlczogeyBlbWFpbD86IHN0cmluZzsgcm9sZT86IFVzZXJSb2xlOyBpc19hY3RpdmU/OiBib29sZWFuIH0pOiBQdWJsaWNVc2VyIHwgbnVsbCB7XG4gICAgICAgIGNvbnN0IGRiID0gZ2V0VW5pZmllZERhdGFiYXNlKCkuZ2V0RGF0YWJhc2UoKTtcbiAgICAgICAgY29uc3Qgc2V0czogc3RyaW5nW10gPSBbJ3VwZGF0ZWRfYXQgPSA/J107XG4gICAgICAgIGNvbnN0IHBhcmFtczogKHN0cmluZyB8IG51bWJlcilbXSA9IFtuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCldO1xuXG4gICAgICAgIGlmICh1cGRhdGVzLmVtYWlsICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHNldHMucHVzaCgndXNlcm5hbWUgPSA/Jyk7XG4gICAgICAgICAgICBwYXJhbXMucHVzaCh1cGRhdGVzLmVtYWlsKTtcbiAgICAgICAgICAgIHNldHMucHVzaCgnZW1haWwgPSA/Jyk7XG4gICAgICAgICAgICBwYXJhbXMucHVzaCh1cGRhdGVzLmVtYWlsKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodXBkYXRlcy5yb2xlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHNldHMucHVzaCgncm9sZSA9ID8nKTtcbiAgICAgICAgICAgIHBhcmFtcy5wdXNoKHVwZGF0ZXMucm9sZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHVwZGF0ZXMuaXNfYWN0aXZlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHNldHMucHVzaCgnaXNfYWN0aXZlID0gPycpO1xuICAgICAgICAgICAgcGFyYW1zLnB1c2godXBkYXRlcy5pc19hY3RpdmUgPyAxIDogMCk7XG4gICAgICAgIH1cblxuICAgICAgICBwYXJhbXMucHVzaChTdHJpbmcodXNlcklkKSk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGRiLnByZXBhcmUoYFVQREFURSB1c2VycyBTRVQgJHtzZXRzLmpvaW4oJywgJyl9IFdIRVJFIGlkID0gP2ApLnJ1biguLi5wYXJhbXMpO1xuICAgICAgICBpZiAocmVzdWx0LmNoYW5nZXMgPT09IDApIHJldHVybiBudWxsO1xuXG4gICAgICAgIGNvbnN0IHJvdyA9IGRiLnByZXBhcmUoJ1NFTEVDVCAqIEZST00gdXNlcnMgV0hFUkUgaWQgPSA/JykuZ2V0KFN0cmluZyh1c2VySWQpKSBhcyBVc2VyUm93IHwgdW5kZWZpbmVkO1xuICAgICAgICByZXR1cm4gcm93ID8gdGhpcy5yb3dUb1B1YmxpY1VzZXIocm93KSA6IG51bGw7XG4gICAgfVxuXG4gICAgZGVsZXRlVXNlcih1c2VySWQ6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBkYiA9IGdldFVuaWZpZWREYXRhYmFzZSgpLmdldERhdGFiYXNlKCk7XG4gICAgICAgIGNvbnN0IHJvdyA9IGRiLnByZXBhcmUoJ1NFTEVDVCAqIEZST00gdXNlcnMgV0hFUkUgaWQgPSA/JykuZ2V0KFN0cmluZyh1c2VySWQpKSBhcyBVc2VyUm93IHwgdW5kZWZpbmVkO1xuICAgICAgICBpZiAoIXJvdykgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgIGlmIChyb3cucm9sZSA9PT0gJ2FkbWluJykge1xuICAgICAgICAgICAgY29uc3QgY291bnRSb3cgPSBkYi5wcmVwYXJlKCdTRUxFQ1QgQ09VTlQoKikgYXMgY250IEZST00gdXNlcnMgV0hFUkUgcm9sZSA9IFxcJ2FkbWluXFwnJykuZ2V0KCkgYXMgeyBjbnQ6IG51bWJlciB9O1xuICAgICAgICAgICAgaWYgKGNvdW50Um93LmNudCA8PSAxKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXN1bHQgPSBkYi5wcmVwYXJlKCdERUxFVEUgRlJPTSB1c2VycyBXSEVSRSBpZCA9ID8nKS5ydW4oU3RyaW5nKHVzZXJJZCkpO1xuICAgICAgICByZXR1cm4gcmVzdWx0LmNoYW5nZXMgPiAwO1xuICAgIH1cblxuICAgIGdldFN0YXRzKCkge1xuICAgICAgICBjb25zdCBkYiA9IGdldFVuaWZpZWREYXRhYmFzZSgpLmdldERhdGFiYXNlKCk7XG4gICAgICAgIGNvbnN0IHRvdGFsUm93ID0gZGIucHJlcGFyZSgnU0VMRUNUIENPVU5UKCopIGFzIGNudCBGUk9NIHVzZXJzJykuZ2V0KCkgYXMgeyBjbnQ6IG51bWJlciB9O1xuICAgICAgICBjb25zdCBhY3RpdmVSb3cgPSBkYi5wcmVwYXJlKCdTRUxFQ1QgQ09VTlQoKikgYXMgY250IEZST00gdXNlcnMgV0hFUkUgaXNfYWN0aXZlID0gMScpLmdldCgpIGFzIHsgY250OiBudW1iZXIgfTtcbiAgICAgICAgY29uc3QgYWRtaW5Sb3cgPSBkYi5wcmVwYXJlKCdTRUxFQ1QgQ09VTlQoKikgYXMgY250IEZST00gdXNlcnMgV0hFUkUgcm9sZSA9IFxcJ2FkbWluXFwnJykuZ2V0KCkgYXMgeyBjbnQ6IG51bWJlciB9O1xuICAgICAgICBjb25zdCB1c2VyUm93ID0gZGIucHJlcGFyZSgnU0VMRUNUIENPVU5UKCopIGFzIGNudCBGUk9NIHVzZXJzIFdIRVJFIHJvbGUgPSBcXCd1c2VyXFwnJykuZ2V0KCkgYXMgeyBjbnQ6IG51bWJlciB9O1xuICAgICAgICBjb25zdCBndWVzdFJvdyA9IGRiLnByZXBhcmUoJ1NFTEVDVCBDT1VOVCgqKSBhcyBjbnQgRlJPTSB1c2VycyBXSEVSRSByb2xlID0gXFwnZ3Vlc3RcXCcnKS5nZXQoKSBhcyB7IGNudDogbnVtYmVyIH07XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0b3RhbFVzZXJzOiB0b3RhbFJvdy5jbnQsXG4gICAgICAgICAgICBhY3RpdmVVc2VyczogYWN0aXZlUm93LmNudCxcbiAgICAgICAgICAgIGFkbWluQ291bnQ6IGFkbWluUm93LmNudCxcbiAgICAgICAgICAgIHVzZXJDb3VudDogdXNlclJvdy5jbnQsXG4gICAgICAgICAgICBndWVzdENvdW50OiBndWVzdFJvdy5jbnRcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyDsgqzsmqnsnpAgdGllciDrs4Dqsr1cbiAgICBjaGFuZ2VUaWVyKHVzZXJJZDogbnVtYmVyLCBuZXdUaWVyOiBVc2VyVGllcik6IFB1YmxpY1VzZXIgfCBudWxsIHtcbiAgICAgICAgY29uc3QgZGIgPSBnZXRVbmlmaWVkRGF0YWJhc2UoKS5nZXREYXRhYmFzZSgpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSBkYi5wcmVwYXJlKCdVUERBVEUgdXNlcnMgU0VUIHRpZXIgPSA/LCB1cGRhdGVkX2F0ID0gPyBXSEVSRSBpZCA9ID8nKVxuICAgICAgICAgICAgLnJ1bihuZXdUaWVyLCBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksIFN0cmluZyh1c2VySWQpKTtcbiAgICAgICAgaWYgKHJlc3VsdC5jaGFuZ2VzID09PSAwKSByZXR1cm4gbnVsbDtcblxuICAgICAgICBjb25zdCByb3cgPSBkYi5wcmVwYXJlKCdTRUxFQ1QgKiBGUk9NIHVzZXJzIFdIRVJFIGlkID0gPycpLmdldChTdHJpbmcodXNlcklkKSkgYXMgVXNlclJvdyB8IHVuZGVmaW5lZDtcbiAgICAgICAgcmV0dXJuIHJvdyA/IHRoaXMucm93VG9QdWJsaWNVc2VyKHJvdykgOiBudWxsO1xuICAgIH1cbn1cblxubGV0IHVzZXJNYW5hZ2VySW5zdGFuY2U6IFVzZXJNYW5hZ2VySW1wbCB8IG51bGwgPSBudWxsO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VXNlck1hbmFnZXIoKTogVXNlck1hbmFnZXJJbXBsIHtcbiAgICBpZiAoIXVzZXJNYW5hZ2VySW5zdGFuY2UpIHVzZXJNYW5hZ2VySW5zdGFuY2UgPSBuZXcgVXNlck1hbmFnZXJJbXBsKCk7XG4gICAgcmV0dXJuIHVzZXJNYW5hZ2VySW5zdGFuY2U7XG59XG4iXSwidmVyc2lvbiI6M30=