0f8e2fa334e8cbe22c42adfd17db878b
"use strict";
/**
 * Auth Module Tests
 * JWT í† í° ìƒì„±/ê²€ì¦ ë° ê¶Œí•œ ì²´í¬ í…ŒìŠ¤íŠ¸
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
// í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ë³€ìˆ˜ ì„¤ì • (ë‹¤ë¥¸ import ì „ì— ì„¤ì •)
process.env.JWT_SECRET = 'test-secret-key-for-testing-purposes-only';
// ðŸ”’ ë³´ì•ˆ íŒ¨ì¹˜ 2026-02-07: í•˜ë“œì½”ë”©ëœ DB ì¸ì¦ì •ë³´ ì œê±° â€” í™˜ê²½ë³€ìˆ˜ í•„ìˆ˜
if (!process.env.DATABASE_URL) {
    process.env.DATABASE_URL = `postgresql://${process.env.POSTGRES_USER || 'openmake'}:${process.env.POSTGRES_PASSWORD || 'test'}@localhost:5432/${process.env.POSTGRES_DB || 'openmake_llm'}`;
}
const auth_1 = require("../auth");
describe('Auth Module', () => {
    // í…ŒìŠ¤íŠ¸ìš© ì‚¬ìš©ìž ë°ì´í„°
    const mockUser = {
        id: 1,
        email: 'test@example.com',
        role: 'user',
        tier: 'free',
        is_active: true,
        created_at: new Date().toISOString()
    };
    const mockAdminUser = {
        id: 2,
        email: 'admin@example.com',
        role: 'admin',
        tier: 'enterprise',
        is_active: true,
        created_at: new Date().toISOString()
    };
    describe('generateToken', () => {
        it('should generate a valid JWT token', () => {
            const token = (0, auth_1.generateToken)(mockUser);
            expect(token).toBeDefined();
            expect(typeof token).toBe('string');
            expect(token.split('.')).toHaveLength(3); // JWTëŠ” 3ê°œ ì„¸ê·¸ë¨¼íŠ¸
        });
        it('should generate different tokens for different users', () => {
            const token1 = (0, auth_1.generateToken)(mockUser);
            const token2 = (0, auth_1.generateToken)(mockAdminUser);
            expect(token1).not.toBe(token2);
        });
    });
    describe('verifyToken', () => {
        it('should verify a valid token', () => __awaiter(void 0, void 0, void 0, function* () {
            const token = (0, auth_1.generateToken)(mockUser);
            const payload = yield (0, auth_1.verifyToken)(token);
            expect(payload).not.toBeNull();
            expect(payload === null || payload === void 0 ? void 0 : payload.userId).toBe(mockUser.id);
            expect(payload === null || payload === void 0 ? void 0 : payload.email).toBe(mockUser.email);
            expect(payload === null || payload === void 0 ? void 0 : payload.role).toBe(mockUser.role);
        }));
        it('should return null for invalid token', () => __awaiter(void 0, void 0, void 0, function* () {
            const payload = yield (0, auth_1.verifyToken)('invalid-token');
            expect(payload).toBeNull();
        }));
        it('should return null for empty token', () => __awaiter(void 0, void 0, void 0, function* () {
            const payload = yield (0, auth_1.verifyToken)('');
            expect(payload).toBeNull();
        }));
        it('should return null for malformed JWT', () => __awaiter(void 0, void 0, void 0, function* () {
            const payload = yield (0, auth_1.verifyToken)('a.b.c');
            expect(payload).toBeNull();
        }));
    });
    describe('extractToken', () => {
        it('should extract token from Bearer header', () => {
            const token = (0, auth_1.extractToken)('Bearer mytoken123');
            expect(token).toBe('mytoken123');
        });
        it('should return raw token if no Bearer prefix', () => {
            const token = (0, auth_1.extractToken)('rawtoken456');
            expect(token).toBe('rawtoken456');
        });
        it('should return null for undefined header', () => {
            const token = (0, auth_1.extractToken)(undefined);
            expect(token).toBeNull();
        });
        it('should return null for empty header', () => {
            const token = (0, auth_1.extractToken)('');
            expect(token).toBeNull();
        });
    });
    describe('hasPermission', () => {
        it('should allow admin to access admin resources', () => {
            expect((0, auth_1.hasPermission)('admin', 'admin')).toBe(true);
        });
        it('should allow admin to access user resources', () => {
            expect((0, auth_1.hasPermission)('admin', 'user')).toBe(true);
        });
        it('should allow admin to access guest resources', () => {
            expect((0, auth_1.hasPermission)('admin', 'guest')).toBe(true);
        });
        it('should allow user to access user resources', () => {
            expect((0, auth_1.hasPermission)('user', 'user')).toBe(true);
        });
        it('should allow user to access guest resources', () => {
            expect((0, auth_1.hasPermission)('user', 'guest')).toBe(true);
        });
        it('should deny user access to admin resources', () => {
            expect((0, auth_1.hasPermission)('user', 'admin')).toBe(false);
        });
        it('should allow guest to access guest resources', () => {
            expect((0, auth_1.hasPermission)('guest', 'guest')).toBe(true);
        });
        it('should deny guest access to user resources', () => {
            expect((0, auth_1.hasPermission)('guest', 'user')).toBe(false);
        });
        it('should deny guest access to admin resources', () => {
            expect((0, auth_1.hasPermission)('guest', 'admin')).toBe(false);
        });
    });
    describe('isAdmin', () => {
        it('should return true for admin role', () => {
            expect((0, auth_1.isAdmin)('admin')).toBe(true);
        });
        it('should return false for user role', () => {
            expect((0, auth_1.isAdmin)('user')).toBe(false);
        });
        it('should return false for guest role', () => {
            expect((0, auth_1.isAdmin)('guest')).toBe(false);
        });
    });
});
// Add at the end of the file, after existing tests
const AuthService_1 = require("../services/AuthService");
describe('Password Policy', () => {
    const authService = new AuthService_1.AuthService();
    it('should reject password shorter than 8 characters', () => __awaiter(void 0, void 0, void 0, function* () {
        const result = yield authService.register({ email: 'test@test.com', password: 'Aa1!' });
        expect(result.success).toBe(false);
        expect(result.error).toContain('8ìž');
    }));
    it('should reject password without uppercase', () => __awaiter(void 0, void 0, void 0, function* () {
        const result = yield authService.register({ email: 'test@test.com', password: 'abcd1234!' });
        expect(result.success).toBe(false);
        expect(result.error).toContain('ëŒ€ë¬¸ìž');
    }));
    it('should reject password without lowercase', () => __awaiter(void 0, void 0, void 0, function* () {
        const result = yield authService.register({ email: 'test@test.com', password: 'ABCD1234!' });
        expect(result.success).toBe(false);
        expect(result.error).toContain('ì†Œë¬¸ìž');
    }));
    it('should reject password without number', () => __awaiter(void 0, void 0, void 0, function* () {
        const result = yield authService.register({ email: 'test@test.com', password: 'Abcdefgh!' });
        expect(result.success).toBe(false);
        expect(result.error).toContain('ìˆ«ìž');
    }));
    it('should reject password without special character', () => __awaiter(void 0, void 0, void 0, function* () {
        const result = yield authService.register({ email: 'test@test.com', password: 'Abcd1234' });
        expect(result.success).toBe(false);
        expect(result.error).toContain('íŠ¹ìˆ˜ë¬¸ìž');
    }));
    it('should accept valid password', () => __awaiter(void 0, void 0, void 0, function* () {
        const result = yield authService.register({ email: 'newuser@test.com', password: 'ValidPass1!' });
        // Success depends on whether user already exists, but should NOT fail on password
        if (!result.success) {
            expect(result.error).not.toContain('ë¹„ë°€ë²ˆí˜¸');
        }
    }));
});
describe('Token Blacklist', () => {
    let store;
    const blacklist = {
        add: (jti, expiresAt) => __awaiter(void 0, void 0, void 0, function* () {
            const idx = store.findIndex(e => e.jti === jti);
            if (idx >= 0) {
                store[idx].expiresAt = expiresAt;
            }
            else {
                store.push({ jti, expiresAt });
            }
        }),
        has: (jti) => __awaiter(void 0, void 0, void 0, function* () {
            return store.some(e => e.jti === jti && e.expiresAt > Date.now());
        }),
        cleanup: () => __awaiter(void 0, void 0, void 0, function* () {
            const now = Date.now();
            const before = store.length;
            store = store.filter(e => e.expiresAt >= now);
            return before - store.length;
        }),
        getStats: () => __awaiter(void 0, void 0, void 0, function* () {
            const now = Date.now();
            return { count: store.filter(e => e.expiresAt > now).length };
        }),
    };
    beforeEach(() => {
        store = [];
    });
    it('should add token to blacklist', () => __awaiter(void 0, void 0, void 0, function* () {
        yield blacklist.add('test-jti-1', Date.now() + 60000);
        expect(yield blacklist.has('test-jti-1')).toBe(true);
    }));
    it('should return false for non-existent token', () => __awaiter(void 0, void 0, void 0, function* () {
        expect(yield blacklist.has('non-existent')).toBe(false);
    }));
    it('should return false for expired token', () => __awaiter(void 0, void 0, void 0, function* () {
        yield blacklist.add('expired-jti', Date.now() - 1000);
        expect(yield blacklist.has('expired-jti')).toBe(false);
    }));
    it('should cleanup expired tokens', () => __awaiter(void 0, void 0, void 0, function* () {
        yield blacklist.add('expired-1', Date.now() - 1000);
        yield blacklist.add('expired-2', Date.now() - 2000);
        yield blacklist.add('valid', Date.now() + 60000);
        const cleaned = yield blacklist.cleanup();
        expect(cleaned).toBe(2);
        const stats = yield blacklist.getStats();
        expect(stats.count).toBe(1);
    }));
    it('should return correct stats', () => __awaiter(void 0, void 0, void 0, function* () {
        yield blacklist.add('jti-1', Date.now() + 60000);
        yield blacklist.add('jti-2', Date.now() + 60000);
        const stats = yield blacklist.getStats();
        expect(stats.count).toBe(2);
    }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL19fdGVzdHNfXy9hdXRoLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7Ozs7Ozs7Ozs7QUFFSCxpQ0FBaUM7QUFDakMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEdBQUcsMkNBQTJDLENBQUM7QUFDckUsa0RBQWtEO0FBQ2xELElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxHQUFHLGdCQUFnQixPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsSUFBSSxVQUFVLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxNQUFNLG1CQUFtQixPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSxjQUFjLEVBQUUsQ0FBQztBQUNoTSxDQUFDO0FBRUQsa0NBTWlCO0FBR2pCLFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO0lBQ3pCLGVBQWU7SUFDZixNQUFNLFFBQVEsR0FBZTtRQUN6QixFQUFFLEVBQUUsQ0FBQztRQUNMLEtBQUssRUFBRSxrQkFBa0I7UUFDekIsSUFBSSxFQUFFLE1BQU07UUFDWixJQUFJLEVBQUUsTUFBTTtRQUNaLFNBQVMsRUFBRSxJQUFJO1FBQ2YsVUFBVSxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO0tBQ3ZDLENBQUM7SUFFRixNQUFNLGFBQWEsR0FBZTtRQUM5QixFQUFFLEVBQUUsQ0FBQztRQUNMLEtBQUssRUFBRSxtQkFBbUI7UUFDMUIsSUFBSSxFQUFFLE9BQU87UUFDYixJQUFJLEVBQUUsWUFBWTtRQUNsQixTQUFTLEVBQUUsSUFBSTtRQUNmLFVBQVUsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtLQUN2QyxDQUFDO0lBRUYsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7UUFDM0IsRUFBRSxDQUFDLG1DQUFtQyxFQUFFLEdBQUcsRUFBRTtZQUN6QyxNQUFNLEtBQUssR0FBRyxJQUFBLG9CQUFhLEVBQUMsUUFBUSxDQUFDLENBQUM7WUFFdEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzVCLE1BQU0sQ0FBQyxPQUFPLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNwQyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGVBQWU7UUFDN0QsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsc0RBQXNELEVBQUUsR0FBRyxFQUFFO1lBQzVELE1BQU0sTUFBTSxHQUFHLElBQUEsb0JBQWEsRUFBQyxRQUFRLENBQUMsQ0FBQztZQUN2QyxNQUFNLE1BQU0sR0FBRyxJQUFBLG9CQUFhLEVBQUMsYUFBYSxDQUFDLENBQUM7WUFFNUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO1FBQ3pCLEVBQUUsQ0FBQyw2QkFBNkIsRUFBRSxHQUFTLEVBQUU7WUFDekMsTUFBTSxLQUFLLEdBQUcsSUFBQSxvQkFBYSxFQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3RDLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBQSxrQkFBVyxFQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXpDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDL0IsTUFBTSxDQUFDLE9BQU8sYUFBUCxPQUFPLHVCQUFQLE9BQU8sQ0FBRSxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sQ0FBQyxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUM1QyxNQUFNLENBQUMsT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFFLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUMsQ0FBQyxDQUFBLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxzQ0FBc0MsRUFBRSxHQUFTLEVBQUU7WUFDbEQsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFBLGtCQUFXLEVBQUMsZUFBZSxDQUFDLENBQUM7WUFFbkQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQy9CLENBQUMsQ0FBQSxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsb0NBQW9DLEVBQUUsR0FBUyxFQUFFO1lBQ2hELE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBQSxrQkFBVyxFQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRXRDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUMvQixDQUFDLENBQUEsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHNDQUFzQyxFQUFFLEdBQVMsRUFBRTtZQUNsRCxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUEsa0JBQVcsRUFBQyxPQUFPLENBQUMsQ0FBQztZQUUzQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDL0IsQ0FBQyxDQUFBLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUU7UUFDMUIsRUFBRSxDQUFDLHlDQUF5QyxFQUFFLEdBQUcsRUFBRTtZQUMvQyxNQUFNLEtBQUssR0FBRyxJQUFBLG1CQUFZLEVBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUVoRCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3JDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDZDQUE2QyxFQUFFLEdBQUcsRUFBRTtZQUNuRCxNQUFNLEtBQUssR0FBRyxJQUFBLG1CQUFZLEVBQUMsYUFBYSxDQUFDLENBQUM7WUFFMUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN0QyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx5Q0FBeUMsRUFBRSxHQUFHLEVBQUU7WUFDL0MsTUFBTSxLQUFLLEdBQUcsSUFBQSxtQkFBWSxFQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRXRDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxxQ0FBcUMsRUFBRSxHQUFHLEVBQUU7WUFDM0MsTUFBTSxLQUFLLEdBQUcsSUFBQSxtQkFBWSxFQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRS9CLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7UUFDM0IsRUFBRSxDQUFDLDhDQUE4QyxFQUFFLEdBQUcsRUFBRTtZQUNwRCxNQUFNLENBQUMsSUFBQSxvQkFBYSxFQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2RCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw2Q0FBNkMsRUFBRSxHQUFHLEVBQUU7WUFDbkQsTUFBTSxDQUFDLElBQUEsb0JBQWEsRUFBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsOENBQThDLEVBQUUsR0FBRyxFQUFFO1lBQ3BELE1BQU0sQ0FBQyxJQUFBLG9CQUFhLEVBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZELENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDRDQUE0QyxFQUFFLEdBQUcsRUFBRTtZQUNsRCxNQUFNLENBQUMsSUFBQSxvQkFBYSxFQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNyRCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw2Q0FBNkMsRUFBRSxHQUFHLEVBQUU7WUFDbkQsTUFBTSxDQUFDLElBQUEsb0JBQWEsRUFBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsNENBQTRDLEVBQUUsR0FBRyxFQUFFO1lBQ2xELE1BQU0sQ0FBQyxJQUFBLG9CQUFhLEVBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3ZELENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDhDQUE4QyxFQUFFLEdBQUcsRUFBRTtZQUNwRCxNQUFNLENBQUMsSUFBQSxvQkFBYSxFQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2RCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw0Q0FBNEMsRUFBRSxHQUFHLEVBQUU7WUFDbEQsTUFBTSxDQUFDLElBQUEsb0JBQWEsRUFBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsNkNBQTZDLEVBQUUsR0FBRyxFQUFFO1lBQ25ELE1BQU0sQ0FBQyxJQUFBLG9CQUFhLEVBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3hELENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsU0FBUyxFQUFFLEdBQUcsRUFBRTtRQUNyQixFQUFFLENBQUMsbUNBQW1DLEVBQUUsR0FBRyxFQUFFO1lBQ3pDLE1BQU0sQ0FBQyxJQUFBLGNBQU8sRUFBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4QyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxtQ0FBbUMsRUFBRSxHQUFHLEVBQUU7WUFDekMsTUFBTSxDQUFDLElBQUEsY0FBTyxFQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLG9DQUFvQyxFQUFFLEdBQUcsRUFBRTtZQUMxQyxNQUFNLENBQUMsSUFBQSxjQUFPLEVBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDekMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyxDQUFDO0FBRUgsbURBQW1EO0FBQ25ELHlEQUFzRDtBQUV0RCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQzdCLE1BQU0sV0FBVyxHQUFHLElBQUkseUJBQVcsRUFBRSxDQUFDO0lBRXRDLEVBQUUsQ0FBQyxrREFBa0QsRUFBRSxHQUFTLEVBQUU7UUFDOUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxXQUFXLENBQUMsUUFBUSxDQUFDLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUN4RixNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN6QyxDQUFDLENBQUEsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLDBDQUEwQyxFQUFFLEdBQVMsRUFBRTtRQUN0RCxNQUFNLE1BQU0sR0FBRyxNQUFNLFdBQVcsQ0FBQyxRQUFRLENBQUMsRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQzdGLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25DLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzFDLENBQUMsQ0FBQSxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsMENBQTBDLEVBQUUsR0FBUyxFQUFFO1FBQ3RELE1BQU0sTUFBTSxHQUFHLE1BQU0sV0FBVyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDN0YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDMUMsQ0FBQyxDQUFBLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyx1Q0FBdUMsRUFBRSxHQUFTLEVBQUU7UUFDbkQsTUFBTSxNQUFNLEdBQUcsTUFBTSxXQUFXLENBQUMsUUFBUSxDQUFDLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUM3RixNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN6QyxDQUFDLENBQUEsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLGtEQUFrRCxFQUFFLEdBQVMsRUFBRTtRQUM5RCxNQUFNLE1BQU0sR0FBRyxNQUFNLFdBQVcsQ0FBQyxRQUFRLENBQUMsRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBQzVGLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25DLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzNDLENBQUMsQ0FBQSxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsOEJBQThCLEVBQUUsR0FBUyxFQUFFO1FBQzFDLE1BQU0sTUFBTSxHQUFHLE1BQU0sV0FBVyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxrQkFBa0IsRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztRQUNsRyxrRkFBa0Y7UUFDbEYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNsQixNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDL0MsQ0FBQztJQUNMLENBQUMsQ0FBQSxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7SUFHN0IsSUFBSSxLQUF1QixDQUFDO0lBRTVCLE1BQU0sU0FBUyxHQUFHO1FBQ2QsR0FBRyxFQUFFLENBQU8sR0FBVyxFQUFFLFNBQWlCLEVBQUUsRUFBRTtZQUMxQyxNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQztZQUNoRCxJQUFJLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQztnQkFBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztZQUFDLENBQUM7aUJBQzlDLENBQUM7Z0JBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1lBQUMsQ0FBQztRQUM1QyxDQUFDLENBQUE7UUFDRCxHQUFHLEVBQUUsQ0FBTyxHQUFXLEVBQUUsRUFBRTtZQUN2QixPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ3RFLENBQUMsQ0FBQTtRQUNELE9BQU8sRUFBRSxHQUFTLEVBQUU7WUFDaEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3ZCLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7WUFDNUIsS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1lBQzlDLE9BQU8sTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDakMsQ0FBQyxDQUFBO1FBQ0QsUUFBUSxFQUFFLEdBQVMsRUFBRTtZQUNqQixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDdkIsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNsRSxDQUFDLENBQUE7S0FDSixDQUFDO0lBRUYsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNaLEtBQUssR0FBRyxFQUFFLENBQUM7SUFDZixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQywrQkFBK0IsRUFBRSxHQUFTLEVBQUU7UUFDM0MsTUFBTSxTQUFTLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFDdEQsTUFBTSxDQUFDLE1BQU0sU0FBUyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN6RCxDQUFDLENBQUEsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLDRDQUE0QyxFQUFFLEdBQVMsRUFBRTtRQUN4RCxNQUFNLENBQUMsTUFBTSxTQUFTLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzVELENBQUMsQ0FBQSxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsdUNBQXVDLEVBQUUsR0FBUyxFQUFFO1FBQ25ELE1BQU0sU0FBUyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ3RELE1BQU0sQ0FBQyxNQUFNLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDM0QsQ0FBQyxDQUFBLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQywrQkFBK0IsRUFBRSxHQUFTLEVBQUU7UUFDM0MsTUFBTSxTQUFTLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDcEQsTUFBTSxTQUFTLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDcEQsTUFBTSxTQUFTLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFFakQsTUFBTSxPQUFPLEdBQUcsTUFBTSxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDMUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QixNQUFNLEtBQUssR0FBRyxNQUFNLFNBQVMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN6QyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoQyxDQUFDLENBQUEsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLDZCQUE2QixFQUFFLEdBQVMsRUFBRTtRQUN6QyxNQUFNLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxLQUFLLENBQUMsQ0FBQztRQUNqRCxNQUFNLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxLQUFLLENBQUMsQ0FBQztRQUVqRCxNQUFNLEtBQUssR0FBRyxNQUFNLFNBQVMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN6QyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoQyxDQUFDLENBQUEsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL19fdGVzdHNfXy9hdXRoLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBBdXRoIE1vZHVsZSBUZXN0c1xuICogSldUIO2GoO2BsCDsg53shLEv6rKA7KadIOuwjyDqtoztlZwg7LK07YGsIO2FjOyKpO2KuFxuICovXG5cbi8vIO2FjOyKpO2KuOyaqSDtmZjqsr3rs4DsiJgg7ISk7KCVICjri6TrpbggaW1wb3J0IOyghOyXkCDshKTsoJUpXG5wcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gJ3Rlc3Qtc2VjcmV0LWtleS1mb3ItdGVzdGluZy1wdXJwb3Nlcy1vbmx5Jztcbi8vIPCflJIg67O07JWIIO2MqOy5mCAyMDI2LTAyLTA3OiDtlZjrk5zsvZTrlKnrkJwgREIg7J247Kad7KCV67O0IOygnOqxsCDigJQg7ZmY6rK967OA7IiYIO2VhOyImFxuaWYgKCFwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwpIHtcbiAgICBwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwgPSBgcG9zdGdyZXNxbDovLyR7cHJvY2Vzcy5lbnYuUE9TVEdSRVNfVVNFUiB8fCAnb3Blbm1ha2UnfToke3Byb2Nlc3MuZW52LlBPU1RHUkVTX1BBU1NXT1JEIHx8ICd0ZXN0J31AbG9jYWxob3N0OjU0MzIvJHtwcm9jZXNzLmVudi5QT1NUR1JFU19EQiB8fCAnb3Blbm1ha2VfbGxtJ31gO1xufVxuXG5pbXBvcnQge1xuICAgIGdlbmVyYXRlVG9rZW4sXG4gICAgdmVyaWZ5VG9rZW4sXG4gICAgZXh0cmFjdFRva2VuLFxuICAgIGhhc1Blcm1pc3Npb24sXG4gICAgaXNBZG1pblxufSBmcm9tICcuLi9hdXRoJztcbmltcG9ydCB7IFB1YmxpY1VzZXIgfSBmcm9tICcuLi9kYXRhL3VzZXItbWFuYWdlcic7XG5cbmRlc2NyaWJlKCdBdXRoIE1vZHVsZScsICgpID0+IHtcbiAgICAvLyDthYzsiqTtirjsmqkg7IKs7Jqp7J6QIOuNsOydtO2EsFxuICAgIGNvbnN0IG1vY2tVc2VyOiBQdWJsaWNVc2VyID0ge1xuICAgICAgICBpZDogMSxcbiAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgcm9sZTogJ3VzZXInLFxuICAgICAgICB0aWVyOiAnZnJlZScsXG4gICAgICAgIGlzX2FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgfTtcblxuICAgIGNvbnN0IG1vY2tBZG1pblVzZXI6IFB1YmxpY1VzZXIgPSB7XG4gICAgICAgIGlkOiAyLFxuICAgICAgICBlbWFpbDogJ2FkbWluQGV4YW1wbGUuY29tJyxcbiAgICAgICAgcm9sZTogJ2FkbWluJyxcbiAgICAgICAgdGllcjogJ2VudGVycHJpc2UnLFxuICAgICAgICBpc19hY3RpdmU6IHRydWUsXG4gICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgIH07XG5cbiAgICBkZXNjcmliZSgnZ2VuZXJhdGVUb2tlbicsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCBnZW5lcmF0ZSBhIHZhbGlkIEpXVCB0b2tlbicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVUb2tlbihtb2NrVXNlcik7XG5cbiAgICAgICAgICAgIGV4cGVjdCh0b2tlbikudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdCh0eXBlb2YgdG9rZW4pLnRvQmUoJ3N0cmluZycpO1xuICAgICAgICAgICAgZXhwZWN0KHRva2VuLnNwbGl0KCcuJykpLnRvSGF2ZUxlbmd0aCgzKTsgLy8gSldU64qUIDPqsJwg7IS46re466i87Yq4XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgZGlmZmVyZW50IHRva2VucyBmb3IgZGlmZmVyZW50IHVzZXJzJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdG9rZW4xID0gZ2VuZXJhdGVUb2tlbihtb2NrVXNlcik7XG4gICAgICAgICAgICBjb25zdCB0b2tlbjIgPSBnZW5lcmF0ZVRva2VuKG1vY2tBZG1pblVzZXIpO1xuXG4gICAgICAgICAgICBleHBlY3QodG9rZW4xKS5ub3QudG9CZSh0b2tlbjIpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCd2ZXJpZnlUb2tlbicsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCB2ZXJpZnkgYSB2YWxpZCB0b2tlbicsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVUb2tlbihtb2NrVXNlcik7XG4gICAgICAgICAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgdmVyaWZ5VG9rZW4odG9rZW4pO1xuXG4gICAgICAgICAgICBleHBlY3QocGF5bG9hZCkubm90LnRvQmVOdWxsKCk7XG4gICAgICAgICAgICBleHBlY3QocGF5bG9hZD8udXNlcklkKS50b0JlKG1vY2tVc2VyLmlkKTtcbiAgICAgICAgICAgIGV4cGVjdChwYXlsb2FkPy5lbWFpbCkudG9CZShtb2NrVXNlci5lbWFpbCk7XG4gICAgICAgICAgICBleHBlY3QocGF5bG9hZD8ucm9sZSkudG9CZShtb2NrVXNlci5yb2xlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gbnVsbCBmb3IgaW52YWxpZCB0b2tlbicsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCB2ZXJpZnlUb2tlbignaW52YWxpZC10b2tlbicpO1xuXG4gICAgICAgICAgICBleHBlY3QocGF5bG9hZCkudG9CZU51bGwoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gbnVsbCBmb3IgZW1wdHkgdG9rZW4nLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgdmVyaWZ5VG9rZW4oJycpO1xuXG4gICAgICAgICAgICBleHBlY3QocGF5bG9hZCkudG9CZU51bGwoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gbnVsbCBmb3IgbWFsZm9ybWVkIEpXVCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCB2ZXJpZnlUb2tlbignYS5iLmMnKTtcblxuICAgICAgICAgICAgZXhwZWN0KHBheWxvYWQpLnRvQmVOdWxsKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2V4dHJhY3RUb2tlbicsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCBleHRyYWN0IHRva2VuIGZyb20gQmVhcmVyIGhlYWRlcicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuID0gZXh0cmFjdFRva2VuKCdCZWFyZXIgbXl0b2tlbjEyMycpO1xuXG4gICAgICAgICAgICBleHBlY3QodG9rZW4pLnRvQmUoJ215dG9rZW4xMjMnKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gcmF3IHRva2VuIGlmIG5vIEJlYXJlciBwcmVmaXgnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b2tlbiA9IGV4dHJhY3RUb2tlbigncmF3dG9rZW40NTYnKTtcblxuICAgICAgICAgICAgZXhwZWN0KHRva2VuKS50b0JlKCdyYXd0b2tlbjQ1NicpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIGZvciB1bmRlZmluZWQgaGVhZGVyJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBleHRyYWN0VG9rZW4odW5kZWZpbmVkKTtcblxuICAgICAgICAgICAgZXhwZWN0KHRva2VuKS50b0JlTnVsbCgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIGZvciBlbXB0eSBoZWFkZXInLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b2tlbiA9IGV4dHJhY3RUb2tlbignJyk7XG5cbiAgICAgICAgICAgIGV4cGVjdCh0b2tlbikudG9CZU51bGwoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnaGFzUGVybWlzc2lvbicsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCBhbGxvdyBhZG1pbiB0byBhY2Nlc3MgYWRtaW4gcmVzb3VyY2VzJywgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGhhc1Blcm1pc3Npb24oJ2FkbWluJywgJ2FkbWluJykpLnRvQmUodHJ1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgYWxsb3cgYWRtaW4gdG8gYWNjZXNzIHVzZXIgcmVzb3VyY2VzJywgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGhhc1Blcm1pc3Npb24oJ2FkbWluJywgJ3VzZXInKSkudG9CZSh0cnVlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBhbGxvdyBhZG1pbiB0byBhY2Nlc3MgZ3Vlc3QgcmVzb3VyY2VzJywgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGhhc1Blcm1pc3Npb24oJ2FkbWluJywgJ2d1ZXN0JykpLnRvQmUodHJ1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgYWxsb3cgdXNlciB0byBhY2Nlc3MgdXNlciByZXNvdXJjZXMnLCAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoaGFzUGVybWlzc2lvbigndXNlcicsICd1c2VyJykpLnRvQmUodHJ1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgYWxsb3cgdXNlciB0byBhY2Nlc3MgZ3Vlc3QgcmVzb3VyY2VzJywgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGhhc1Blcm1pc3Npb24oJ3VzZXInLCAnZ3Vlc3QnKSkudG9CZSh0cnVlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBkZW55IHVzZXIgYWNjZXNzIHRvIGFkbWluIHJlc291cmNlcycsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChoYXNQZXJtaXNzaW9uKCd1c2VyJywgJ2FkbWluJykpLnRvQmUoZmFsc2UpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGFsbG93IGd1ZXN0IHRvIGFjY2VzcyBndWVzdCByZXNvdXJjZXMnLCAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoaGFzUGVybWlzc2lvbignZ3Vlc3QnLCAnZ3Vlc3QnKSkudG9CZSh0cnVlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBkZW55IGd1ZXN0IGFjY2VzcyB0byB1c2VyIHJlc291cmNlcycsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChoYXNQZXJtaXNzaW9uKCdndWVzdCcsICd1c2VyJykpLnRvQmUoZmFsc2UpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGRlbnkgZ3Vlc3QgYWNjZXNzIHRvIGFkbWluIHJlc291cmNlcycsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChoYXNQZXJtaXNzaW9uKCdndWVzdCcsICdhZG1pbicpKS50b0JlKGZhbHNlKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnaXNBZG1pbicsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gdHJ1ZSBmb3IgYWRtaW4gcm9sZScsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChpc0FkbWluKCdhZG1pbicpKS50b0JlKHRydWUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHJldHVybiBmYWxzZSBmb3IgdXNlciByb2xlJywgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGlzQWRtaW4oJ3VzZXInKSkudG9CZShmYWxzZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIGZvciBndWVzdCByb2xlJywgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGlzQWRtaW4oJ2d1ZXN0JykpLnRvQmUoZmFsc2UpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuXG4vLyBBZGQgYXQgdGhlIGVuZCBvZiB0aGUgZmlsZSwgYWZ0ZXIgZXhpc3RpbmcgdGVzdHNcbmltcG9ydCB7IEF1dGhTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvQXV0aFNlcnZpY2UnO1xuXG5kZXNjcmliZSgnUGFzc3dvcmQgUG9saWN5JywgKCkgPT4ge1xuICAgIGNvbnN0IGF1dGhTZXJ2aWNlID0gbmV3IEF1dGhTZXJ2aWNlKCk7XG4gICAgXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgcGFzc3dvcmQgc2hvcnRlciB0aGFuIDggY2hhcmFjdGVycycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXV0aFNlcnZpY2UucmVnaXN0ZXIoeyBlbWFpbDogJ3Rlc3RAdGVzdC5jb20nLCBwYXNzd29yZDogJ0FhMSEnIH0pO1xuICAgICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUoZmFsc2UpO1xuICAgICAgICBleHBlY3QocmVzdWx0LmVycm9yKS50b0NvbnRhaW4oJzjsnpAnKTtcbiAgICB9KTtcbiAgICBcbiAgICBpdCgnc2hvdWxkIHJlamVjdCBwYXNzd29yZCB3aXRob3V0IHVwcGVyY2FzZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXV0aFNlcnZpY2UucmVnaXN0ZXIoeyBlbWFpbDogJ3Rlc3RAdGVzdC5jb20nLCBwYXNzd29yZDogJ2FiY2QxMjM0IScgfSk7XG4gICAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZShmYWxzZSk7XG4gICAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3IpLnRvQ29udGFpbign64yA66y47J6QJyk7XG4gICAgfSk7XG4gICAgXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgcGFzc3dvcmQgd2l0aG91dCBsb3dlcmNhc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGF1dGhTZXJ2aWNlLnJlZ2lzdGVyKHsgZW1haWw6ICd0ZXN0QHRlc3QuY29tJywgcGFzc3dvcmQ6ICdBQkNEMTIzNCEnIH0pO1xuICAgICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUoZmFsc2UpO1xuICAgICAgICBleHBlY3QocmVzdWx0LmVycm9yKS50b0NvbnRhaW4oJ+yGjOusuOyekCcpO1xuICAgIH0pO1xuICAgIFxuICAgIGl0KCdzaG91bGQgcmVqZWN0IHBhc3N3b3JkIHdpdGhvdXQgbnVtYmVyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhdXRoU2VydmljZS5yZWdpc3Rlcih7IGVtYWlsOiAndGVzdEB0ZXN0LmNvbScsIHBhc3N3b3JkOiAnQWJjZGVmZ2ghJyB9KTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKGZhbHNlKTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcikudG9Db250YWluKCfsiKvsnpAnKTtcbiAgICB9KTtcbiAgICBcbiAgICBpdCgnc2hvdWxkIHJlamVjdCBwYXNzd29yZCB3aXRob3V0IHNwZWNpYWwgY2hhcmFjdGVyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhdXRoU2VydmljZS5yZWdpc3Rlcih7IGVtYWlsOiAndGVzdEB0ZXN0LmNvbScsIHBhc3N3b3JkOiAnQWJjZDEyMzQnIH0pO1xuICAgICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUoZmFsc2UpO1xuICAgICAgICBleHBlY3QocmVzdWx0LmVycm9yKS50b0NvbnRhaW4oJ+2KueyImOusuOyekCcpO1xuICAgIH0pO1xuICAgIFxuICAgIGl0KCdzaG91bGQgYWNjZXB0IHZhbGlkIHBhc3N3b3JkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhdXRoU2VydmljZS5yZWdpc3Rlcih7IGVtYWlsOiAnbmV3dXNlckB0ZXN0LmNvbScsIHBhc3N3b3JkOiAnVmFsaWRQYXNzMSEnIH0pO1xuICAgICAgICAvLyBTdWNjZXNzIGRlcGVuZHMgb24gd2hldGhlciB1c2VyIGFscmVhZHkgZXhpc3RzLCBidXQgc2hvdWxkIE5PVCBmYWlsIG9uIHBhc3N3b3JkXG4gICAgICAgIGlmICghcmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3IpLm5vdC50b0NvbnRhaW4oJ+u5hOuwgOuyiO2YuCcpO1xuICAgICAgICB9XG4gICAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ1Rva2VuIEJsYWNrbGlzdCcsICgpID0+IHtcbiAgICAvLyBJbi1tZW1vcnkg6rWs7ZiE7Jy866GcIFBvc3RncmVTUUwg7JeG7J20IElUb2tlbkJsYWNrbGlzdCDsnbjthLDtjpjsnbTsiqQg64+Z7J6RIOqygOymnVxuICAgIHR5cGUgQmxhY2tsaXN0RW50cnkgPSB7IGp0aTogc3RyaW5nOyBleHBpcmVzQXQ6IG51bWJlciB9O1xuICAgIGxldCBzdG9yZTogQmxhY2tsaXN0RW50cnlbXTtcblxuICAgIGNvbnN0IGJsYWNrbGlzdCA9IHtcbiAgICAgICAgYWRkOiBhc3luYyAoanRpOiBzdHJpbmcsIGV4cGlyZXNBdDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpZHggPSBzdG9yZS5maW5kSW5kZXgoZSA9PiBlLmp0aSA9PT0ganRpKTtcbiAgICAgICAgICAgIGlmIChpZHggPj0gMCkgeyBzdG9yZVtpZHhdLmV4cGlyZXNBdCA9IGV4cGlyZXNBdDsgfVxuICAgICAgICAgICAgZWxzZSB7IHN0b3JlLnB1c2goeyBqdGksIGV4cGlyZXNBdCB9KTsgfVxuICAgICAgICB9LFxuICAgICAgICBoYXM6IGFzeW5jIChqdGk6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHN0b3JlLnNvbWUoZSA9PiBlLmp0aSA9PT0ganRpICYmIGUuZXhwaXJlc0F0ID4gRGF0ZS5ub3coKSk7XG4gICAgICAgIH0sXG4gICAgICAgIGNsZWFudXA6IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgICAgICAgICBjb25zdCBiZWZvcmUgPSBzdG9yZS5sZW5ndGg7XG4gICAgICAgICAgICBzdG9yZSA9IHN0b3JlLmZpbHRlcihlID0+IGUuZXhwaXJlc0F0ID49IG5vdyk7XG4gICAgICAgICAgICByZXR1cm4gYmVmb3JlIC0gc3RvcmUubGVuZ3RoO1xuICAgICAgICB9LFxuICAgICAgICBnZXRTdGF0czogYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAgIHJldHVybiB7IGNvdW50OiBzdG9yZS5maWx0ZXIoZSA9PiBlLmV4cGlyZXNBdCA+IG5vdykubGVuZ3RoIH07XG4gICAgICAgIH0sXG4gICAgfTtcblxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICBzdG9yZSA9IFtdO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBhZGQgdG9rZW4gdG8gYmxhY2tsaXN0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCBibGFja2xpc3QuYWRkKCd0ZXN0LWp0aS0xJywgRGF0ZS5ub3coKSArIDYwMDAwKTtcbiAgICAgICAgZXhwZWN0KGF3YWl0IGJsYWNrbGlzdC5oYXMoJ3Rlc3QtanRpLTEnKSkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIGZvciBub24tZXhpc3RlbnQgdG9rZW4nLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGV4cGVjdChhd2FpdCBibGFja2xpc3QuaGFzKCdub24tZXhpc3RlbnQnKSkudG9CZShmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBmYWxzZSBmb3IgZXhwaXJlZCB0b2tlbicsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgYmxhY2tsaXN0LmFkZCgnZXhwaXJlZC1qdGknLCBEYXRlLm5vdygpIC0gMTAwMCk7XG4gICAgICAgIGV4cGVjdChhd2FpdCBibGFja2xpc3QuaGFzKCdleHBpcmVkLWp0aScpKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgY2xlYW51cCBleHBpcmVkIHRva2VucycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgYmxhY2tsaXN0LmFkZCgnZXhwaXJlZC0xJywgRGF0ZS5ub3coKSAtIDEwMDApO1xuICAgICAgICBhd2FpdCBibGFja2xpc3QuYWRkKCdleHBpcmVkLTInLCBEYXRlLm5vdygpIC0gMjAwMCk7XG4gICAgICAgIGF3YWl0IGJsYWNrbGlzdC5hZGQoJ3ZhbGlkJywgRGF0ZS5ub3coKSArIDYwMDAwKTtcblxuICAgICAgICBjb25zdCBjbGVhbmVkID0gYXdhaXQgYmxhY2tsaXN0LmNsZWFudXAoKTtcbiAgICAgICAgZXhwZWN0KGNsZWFuZWQpLnRvQmUoMik7XG4gICAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgYmxhY2tsaXN0LmdldFN0YXRzKCk7XG4gICAgICAgIGV4cGVjdChzdGF0cy5jb3VudCkudG9CZSgxKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGNvcnJlY3Qgc3RhdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IGJsYWNrbGlzdC5hZGQoJ2p0aS0xJywgRGF0ZS5ub3coKSArIDYwMDAwKTtcbiAgICAgICAgYXdhaXQgYmxhY2tsaXN0LmFkZCgnanRpLTInLCBEYXRlLm5vdygpICsgNjAwMDApO1xuXG4gICAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgYmxhY2tsaXN0LmdldFN0YXRzKCk7XG4gICAgICAgIGV4cGVjdChzdGF0cy5jb3VudCkudG9CZSgyKTtcbiAgICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9