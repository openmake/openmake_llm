{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/agents/__tests__/custom-builder.test.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/agents/__tests__/custom-builder.test.ts"],"sourcesContent":["/**\n * Unit tests for custom-builder path traversal protection\n * Tests sanitizeAgentId() and validatePathWithinDir()\n */\n\nimport * as path from 'path';\nimport { sanitizeAgentId, validatePathWithinDir } from '../custom-builder';\n\ndescribe('sanitizeAgentId', () => {\n    // Normal inputs\n    it('should convert normal name to lowercase kebab-case', () => {\n        expect(sanitizeAgentId('My Agent')).toBe('my-agent');\n    });\n\n    it('should allow simple alphanumeric names', () => {\n        expect(sanitizeAgentId('agent1')).toBe('agent1');\n    });\n\n    it('should allow hyphens and underscores', () => {\n        expect(sanitizeAgentId('my-agent_v2')).toBe('my-agent_v2');\n    });\n\n    it('should allow Korean characters', () => {\n        const result = sanitizeAgentId('한국어에이전트');\n        expect(result).toBe('한국어에이전트');\n    });\n\n    it('should collapse multiple hyphens', () => {\n        expect(sanitizeAgentId('my---agent')).toBe('my-agent');\n    });\n\n    it('should trim leading and trailing hyphens', () => {\n        expect(sanitizeAgentId('-agent-')).toBe('agent');\n    });\n\n    it('should limit length to 50 characters', () => {\n        const longName = 'a'.repeat(100);\n        expect(sanitizeAgentId(longName).length).toBeLessThanOrEqual(50);\n    });\n\n    // Path traversal attempts\n    it('should strip ../ path traversal sequences', () => {\n        const result = sanitizeAgentId('../../../etc/passwd');\n        expect(result).not.toContain('..');\n        expect(result).not.toContain('/');\n    });\n\n    it('should strip absolute path attempts', () => {\n        const result = sanitizeAgentId('/etc/passwd');\n        expect(result).not.toContain('/');\n    });\n\n    it('should strip backslash path traversal', () => {\n        const result = sanitizeAgentId('..\\\\..\\\\windows\\\\system32');\n        expect(result).not.toContain('\\\\');\n        expect(result).not.toContain('..');\n    });\n\n    it('should strip special characters used in injection', () => {\n        const result = sanitizeAgentId('agent;rm -rf /');\n        expect(result).not.toContain(';');\n        expect(result).not.toContain(' ');\n    });\n\n    it('should strip null bytes', () => {\n        const result = sanitizeAgentId('agent\\x00.md');\n        expect(result).not.toContain('\\x00');\n    });\n\n    it('should strip URL-encoded traversal', () => {\n        const result = sanitizeAgentId('%2e%2e%2f%2e%2e%2f');\n        // % gets stripped, dots get stripped\n        expect(result).not.toContain('/');\n        expect(result).not.toContain('%');\n    });\n\n    // Edge cases\n    it('should throw on empty string', () => {\n        expect(() => sanitizeAgentId('')).toThrow('Invalid agent name');\n    });\n\n    it('should throw on string that becomes empty after sanitization', () => {\n        expect(() => sanitizeAgentId('...')).toThrow('Invalid agent name');\n    });\n\n    it('should throw on only special characters', () => {\n        expect(() => sanitizeAgentId('!@#$%^&*()')).toThrow('Invalid agent name');\n    });\n\n    it('should handle mixed valid and invalid characters', () => {\n        const result = sanitizeAgentId('my<script>agent');\n        expect(result).not.toContain('<');\n        expect(result).not.toContain('>');\n        expect(result).toContain('my');\n        expect(result).toContain('agent');\n    });\n});\n\ndescribe('validatePathWithinDir', () => {\n    const baseDir = '/tmp/test-prompts';\n\n    // Valid paths\n    it('should accept path within base directory', () => {\n        expect(() => {\n            validatePathWithinDir(path.join(baseDir, 'agent.md'), baseDir);\n        }).not.toThrow();\n    });\n\n    it('should accept nested path within base directory', () => {\n        expect(() => {\n            validatePathWithinDir(path.join(baseDir, 'sub', 'agent.md'), baseDir);\n        }).not.toThrow();\n    });\n\n    // Path traversal attacks\n    it('should reject ../ traversal outside base directory', () => {\n        expect(() => {\n            validatePathWithinDir(path.join(baseDir, '..', 'etc', 'passwd'), baseDir);\n        }).toThrow('Path traversal attempt detected');\n    });\n\n    it('should reject multiple ../ traversals', () => {\n        expect(() => {\n            validatePathWithinDir(path.join(baseDir, '..', '..', '..', 'etc', 'passwd'), baseDir);\n        }).toThrow('Path traversal attempt detected');\n    });\n\n    it('should reject absolute path outside base directory', () => {\n        expect(() => {\n            validatePathWithinDir('/etc/passwd', baseDir);\n        }).toThrow('Path traversal attempt detected');\n    });\n\n    it('should reject path that starts with base dir name but is different directory', () => {\n        // e.g., baseDir is /tmp/test-prompts, attack path is /tmp/test-prompts-evil/file\n        expect(() => {\n            validatePathWithinDir(baseDir + '-evil/agent.md', baseDir);\n        }).toThrow('Path traversal attempt detected');\n    });\n\n    it('should accept the base directory itself', () => {\n        expect(() => {\n            validatePathWithinDir(baseDir, baseDir);\n        }).not.toThrow();\n    });\n\n    it('should handle relative base directory', () => {\n        expect(() => {\n            validatePathWithinDir('./data/../data/prompts/agent.md', './data/prompts');\n        }).not.toThrow();\n    });\n\n    it('should reject relative traversal out of relative base', () => {\n        expect(() => {\n            validatePathWithinDir('./data/prompts/../../etc/passwd', './data/prompts');\n        }).toThrow('Path traversal attempt detected');\n    });\n});\n"],"version":3}