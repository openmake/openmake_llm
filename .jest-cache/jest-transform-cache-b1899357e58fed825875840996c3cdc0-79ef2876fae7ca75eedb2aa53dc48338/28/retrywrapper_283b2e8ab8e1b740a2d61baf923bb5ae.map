{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/data/retry-wrapper.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/data/retry-wrapper.ts"],"sourcesContent":["/**\n * ⚙️ Phase 3: DB 쿼리 재시도 래퍼\n * 일시적 연결 오류(ETIMEDOUT, ECONNREFUSED, ECONNRESET)에 대한 자동 재시도\n * \n * @module data/retry-wrapper\n * @since 2026-02-07\n */\n\nimport { createLogger } from '../utils/logger';\n\nconst logger = createLogger('RetryWrapper');\n\n/** 재시도 가능한 PostgreSQL 에러 코드 */\nconst RETRYABLE_ERROR_CODES = new Set([\n    'ETIMEDOUT',\n    'ECONNREFUSED',\n    'ECONNRESET',\n    'EPIPE',\n    '57P01',     // admin_shutdown\n    '57P02',     // crash_shutdown\n    '57P03',     // cannot_connect_now\n    '08000',     // connection_exception\n    '08003',     // connection_does_not_exist\n    '08006',     // connection_failure\n    '40001',     // serialization_failure (deadlock 재시도)\n    '40P01',     // deadlock_detected\n]);\n\n/**\n * 에러가 재시도 가능한지 판단\n */\nfunction isRetryableError(err: unknown): boolean {\n    if (!err || typeof err !== 'object') return false;\n\n    const error = err as Record<string, unknown>;\n\n    // Node.js 네트워크 에러 코드\n    if (typeof error.code === 'string' && RETRYABLE_ERROR_CODES.has(error.code)) {\n        return true;\n    }\n\n    // PostgreSQL 에러 코드 (error.code가 5자리 문자열인 경우)\n    if (typeof error.code === 'string' && error.code.length === 5 && RETRYABLE_ERROR_CODES.has(error.code)) {\n        return true;\n    }\n\n    return false;\n}\n\n/**\n * 재시도 래퍼 옵션\n */\nexport interface RetryOptions {\n    /** 최대 재시도 횟수 (기본값: 3) */\n    maxRetries?: number;\n    /** 초기 대기 시간(ms) — 지수 백오프 적용 (기본값: 500) */\n    baseDelayMs?: number;\n    /** 최대 대기 시간(ms) (기본값: 5000) */\n    maxDelayMs?: number;\n    /** 작업 설명 (로그용) */\n    operation?: string;\n}\n\n/**\n * DB 쿼리를 재시도 가능하게 래핑\n * \n * 일시적 연결 오류 시 지수 백오프로 자동 재시도합니다.\n * 재시도 불가능한 에러(SQL 구문 오류, 제약 조건 위반 등)는 즉시 throw합니다.\n * \n * @example\n * ```typescript\n * const result = await withRetry(\n *   () => pool.query('SELECT * FROM users WHERE id = $1', [userId]),\n *   { operation: 'getUserById', maxRetries: 3 }\n * );\n * ```\n */\nexport async function withRetry<T>(\n    fn: () => Promise<T>,\n    options: RetryOptions = {}\n): Promise<T> {\n    const {\n        maxRetries = 3,\n        baseDelayMs = 500,\n        maxDelayMs = 5000,\n        operation = 'unknown',\n    } = options;\n\n    let lastError: unknown;\n\n    for (let attempt = 0; attempt <= maxRetries; attempt++) {\n        try {\n            return await fn();\n        } catch (err) {\n            lastError = err;\n\n            // 마지막 시도였으면 throw\n            if (attempt >= maxRetries) {\n                break;\n            }\n\n            // 재시도 불가능한 에러면 즉시 throw\n            if (!isRetryableError(err)) {\n                throw err;\n            }\n\n            // 지수 백오프 + jitter\n            const delay = Math.min(\n                baseDelayMs * Math.pow(2, attempt) + Math.random() * 100,\n                maxDelayMs\n            );\n\n            logger.warn(\n                `[${operation}] 재시도 ${attempt + 1}/${maxRetries} (${delay.toFixed(0)}ms 후)`,\n                { error: err instanceof Error ? err.message : String(err) }\n            );\n\n            await new Promise(resolve => setTimeout(resolve, delay));\n        }\n    }\n\n    throw lastError;\n}\n\n/**\n * 트랜잭션 래퍼\n * \n * BEGIN → 작업 → COMMIT (실패 시 ROLLBACK) 패턴을 추상화합니다.\n * Pool에서 client를 가져와 트랜잭션 블록을 실행합니다.\n * \n * @example\n * ```typescript\n * import { Pool } from 'pg';\n * \n * await withTransaction(pool, async (client) => {\n *   await client.query('INSERT INTO users ...', [...]);\n *   await client.query('INSERT INTO user_settings ...', [...]);\n * });\n * ```\n */\nexport async function withTransaction<T>(\n    pool: { connect: () => Promise<TransactionClient> },\n    fn: (client: TransactionClient) => Promise<T>\n): Promise<T> {\n    const client = await pool.connect();\n    try {\n        await client.query('BEGIN');\n        const result = await fn(client);\n        await client.query('COMMIT');\n        return result;\n    } catch (err) {\n        await client.query('ROLLBACK');\n        throw err;\n    } finally {\n        client.release();\n    }\n}\n\n/**\n * pg Client 인터페이스 (트랜잭션용)\n * pg.PoolClient의 서브셋\n */\nexport interface TransactionClient {\n    query(text: string, values?: unknown[]): Promise<{ rows: unknown[]; rowCount: number | null }>;\n    release(): void;\n}\n"],"version":3}