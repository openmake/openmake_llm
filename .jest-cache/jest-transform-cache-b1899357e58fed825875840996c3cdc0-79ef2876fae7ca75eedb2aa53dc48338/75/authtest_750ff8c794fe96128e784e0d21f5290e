a39cca7e284f23271162e5734b414f6c
"use strict";
/**
 * #20 개선: Auth 모듈 기초 단위 테스트
 *
 * JWT 토큰 생성/검증, 권한 체크, 블랙리스트를 테스트합니다.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../../infrastructure/security/auth/index");
const testUser = {
    id: 'user-test-1',
    username: 'testuser',
    email: 'test@example.com',
    role: 'user',
    created_at: new Date().toISOString(),
    is_active: true
};
const adminUser = {
    id: 'admin-test-1',
    username: 'admin',
    email: 'admin@example.com',
    role: 'admin',
    created_at: new Date().toISOString(),
    is_active: true
};
describe('Auth Module', () => {
    // ===== Token Generation =====
    describe('generateToken', () => {
        it('should generate a valid JWT string', () => {
            const token = (0, index_1.generateToken)(testUser);
            expect(typeof token).toBe('string');
            expect(token.split('.').length).toBe(3); // header.payload.signature
        });
        it('should generate different tokens for different users', () => {
            const token1 = (0, index_1.generateToken)(testUser);
            const token2 = (0, index_1.generateToken)(adminUser);
            expect(token1).not.toBe(token2);
        });
        it('should generate unique tokens (jti) for same user', () => {
            const token1 = (0, index_1.generateToken)(testUser);
            const token2 = (0, index_1.generateToken)(testUser);
            expect(token1).not.toBe(token2);
        });
    });
    // ===== Token Verification =====
    describe('verifyToken', () => {
        it('should verify a valid token and return payload', () => {
            const token = (0, index_1.generateToken)(testUser);
            const payload = (0, index_1.verifyToken)(token);
            expect(payload).not.toBeNull();
            expect(payload.userId).toBe('user-test-1');
            expect(payload.email).toBe('test@example.com');
            expect(payload.role).toBe('user');
        });
        it('should return null for invalid token', () => {
            const payload = (0, index_1.verifyToken)('invalid.token.here');
            expect(payload).toBeNull();
        });
        it('should return null for empty string', () => {
            const payload = (0, index_1.verifyToken)('');
            expect(payload).toBeNull();
        });
    });
    // ===== Refresh Token =====
    describe('Refresh Token', () => {
        it('should generate and verify a refresh token', () => {
            const refreshToken = (0, index_1.generateRefreshToken)(testUser);
            expect(typeof refreshToken).toBe('string');
            const result = (0, index_1.verifyRefreshToken)(refreshToken);
            expect(result).not.toBeNull();
            expect(result.userId).toBe('user-test-1');
        });
        it('should reject a regular access token as refresh token', () => {
            const accessToken = (0, index_1.generateToken)(testUser);
            const result = (0, index_1.verifyRefreshToken)(accessToken);
            expect(result).toBeNull();
        });
    });
    // ===== Token Extraction =====
    describe('extractToken', () => {
        it('should extract token from Bearer header', () => {
            const token = (0, index_1.extractToken)('Bearer abc123');
            expect(token).toBe('abc123');
        });
        it('should return raw string if no Bearer prefix', () => {
            const token = (0, index_1.extractToken)('raw-token');
            expect(token).toBe('raw-token');
        });
        it('should return null for undefined input', () => {
            expect((0, index_1.extractToken)(undefined)).toBeNull();
        });
    });
    // ===== Role Permissions =====
    describe('Role Permissions', () => {
        it('should allow admin access to all roles', () => {
            expect((0, index_1.hasPermission)('admin', 'admin')).toBe(true);
            expect((0, index_1.hasPermission)('admin', 'user')).toBe(true);
            expect((0, index_1.hasPermission)('admin', 'guest')).toBe(true);
        });
        it('should allow user access to user and guest', () => {
            expect((0, index_1.hasPermission)('user', 'user')).toBe(true);
            expect((0, index_1.hasPermission)('user', 'guest')).toBe(true);
            expect((0, index_1.hasPermission)('user', 'admin')).toBe(false);
        });
        it('should allow guest access only to guest', () => {
            expect((0, index_1.hasPermission)('guest', 'guest')).toBe(true);
            expect((0, index_1.hasPermission)('guest', 'user')).toBe(false);
            expect((0, index_1.hasPermission)('guest', 'admin')).toBe(false);
        });
        it('should correctly identify admin role', () => {
            expect((0, index_1.isAdmin)('admin')).toBe(true);
            expect((0, index_1.isAdmin)('user')).toBe(false);
            expect((0, index_1.isAdmin)('guest')).toBe(false);
        });
    });
    // ===== Token Blacklist =====
    describe('Token Blacklist', () => {
        it('should blacklist a token and detect it', () => {
            const token = (0, index_1.generateToken)(testUser);
            expect((0, index_1.isTokenBlacklisted)(token)).toBe(false);
            (0, index_1.blacklistToken)(token);
            expect((0, index_1.isTokenBlacklisted)(token)).toBe(true);
        });
        it('should reject blacklisted token in verifyToken', () => {
            const token = (0, index_1.generateToken)(testUser);
            (0, index_1.blacklistToken)(token);
            const payload = (0, index_1.verifyToken)(token);
            expect(payload).toBeNull();
        });
        it('should report blacklist stats', () => {
            const stats = (0, index_1.getBlacklistStats)();
            expect(typeof stats.count).toBe('number');
            expect(typeof stats.persisted).toBe('boolean');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vdGVzdHMvdW5pdC9fX3Rlc3RzX18vYXV0aC50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOztBQUVILHVFQVdxRDtBQUlyRCxNQUFNLFFBQVEsR0FBZTtJQUN6QixFQUFFLEVBQUUsYUFBYTtJQUNqQixRQUFRLEVBQUUsVUFBVTtJQUNwQixLQUFLLEVBQUUsa0JBQWtCO0lBQ3pCLElBQUksRUFBRSxNQUFNO0lBQ1osVUFBVSxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO0lBQ3BDLFNBQVMsRUFBRSxJQUFJO0NBQ2xCLENBQUM7QUFFRixNQUFNLFNBQVMsR0FBZTtJQUMxQixFQUFFLEVBQUUsY0FBYztJQUNsQixRQUFRLEVBQUUsT0FBTztJQUNqQixLQUFLLEVBQUUsbUJBQW1CO0lBQzFCLElBQUksRUFBRSxPQUFPO0lBQ2IsVUFBVSxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO0lBQ3BDLFNBQVMsRUFBRSxJQUFJO0NBQ2xCLENBQUM7QUFFRixRQUFRLENBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRTtJQUN6QiwrQkFBK0I7SUFDL0IsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7UUFDM0IsRUFBRSxDQUFDLG9DQUFvQyxFQUFFLEdBQUcsRUFBRTtZQUMxQyxNQUFNLEtBQUssR0FBRyxJQUFBLHFCQUFhLEVBQUMsUUFBUSxDQUFDLENBQUM7WUFDdEMsTUFBTSxDQUFDLE9BQU8sS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLDJCQUEyQjtRQUN4RSxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxzREFBc0QsRUFBRSxHQUFHLEVBQUU7WUFDNUQsTUFBTSxNQUFNLEdBQUcsSUFB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QztRQUNuRCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vdGVzdHMvdW5pdC9fX3Rlc3RzX18vYXV0aC50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogIzIwIOqwnOyEoDogQXV0aCDrqqjrk4gg6riw7LSIIOuLqOychCDthYzsiqTtirhcbiAqIFxuICogSldUIO2GoO2BsCDsg53shLEv6rKA7KadLCDqtoztlZwg7LK07YGsLCDruJTrnpnrpqzsiqTtirjrpbwg7YWM7Iqk7Yq47ZWp64uI64ukLlxuICovXG5cbmltcG9ydCB7XG4gICAgZ2VuZXJhdGVUb2tlbixcbiAgICB2ZXJpZnlUb2tlbixcbiAgICBnZW5lcmF0ZVJlZnJlc2hUb2tlbixcbiAgICB2ZXJpZnlSZWZyZXNoVG9rZW4sXG4gICAgZXh0cmFjdFRva2VuLFxuICAgIGhhc1Blcm1pc3Npb24sXG4gICAgaXNBZG1pbixcbiAgICBibGFja2xpc3RUb2tlbixcbiAgICBpc1Rva2VuQmxhY2tsaXN0ZWQsXG4gICAgZ2V0QmxhY2tsaXN0U3RhdHNcbn0gZnJvbSAnLi4vLi4vLi4vaW5mcmFzdHJ1Y3R1cmUvc2VjdXJpdHkvYXV0aC9pbmRleCc7XG5cbmltcG9ydCB0eXBlIHsgUHVibGljVXNlciB9IGZyb20gJy4uLy4uLy4uL2luZnJhc3RydWN0dXJlL3NlY3VyaXR5L2F1dGgvdHlwZXMnO1xuXG5jb25zdCB0ZXN0VXNlcjogUHVibGljVXNlciA9IHtcbiAgICBpZDogJ3VzZXItdGVzdC0xJyxcbiAgICB1c2VybmFtZTogJ3Rlc3R1c2VyJyxcbiAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgIHJvbGU6ICd1c2VyJyxcbiAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgaXNfYWN0aXZlOiB0cnVlXG59O1xuXG5jb25zdCBhZG1pblVzZXI6IFB1YmxpY1VzZXIgPSB7XG4gICAgaWQ6ICdhZG1pbi10ZXN0LTEnLFxuICAgIHVzZXJuYW1lOiAnYWRtaW4nLFxuICAgIGVtYWlsOiAnYWRtaW5AZXhhbXBsZS5jb20nLFxuICAgIHJvbGU6ICdhZG1pbicsXG4gICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgIGlzX2FjdGl2ZTogdHJ1ZVxufTtcblxuZGVzY3JpYmUoJ0F1dGggTW9kdWxlJywgKCkgPT4ge1xuICAgIC8vID09PT09IFRva2VuIEdlbmVyYXRpb24gPT09PT1cbiAgICBkZXNjcmliZSgnZ2VuZXJhdGVUb2tlbicsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCBnZW5lcmF0ZSBhIHZhbGlkIEpXVCBzdHJpbmcnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b2tlbiA9IGdlbmVyYXRlVG9rZW4odGVzdFVzZXIpO1xuICAgICAgICAgICAgZXhwZWN0KHR5cGVvZiB0b2tlbikudG9CZSgnc3RyaW5nJyk7XG4gICAgICAgICAgICBleHBlY3QodG9rZW4uc3BsaXQoJy4nKS5sZW5ndGgpLnRvQmUoMyk7IC8vIGhlYWRlci5wYXlsb2FkLnNpZ25hdHVyZVxuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIGRpZmZlcmVudCB0b2tlbnMgZm9yIGRpZmZlcmVudCB1c2VycycsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuMSA9IGdlbmVyYXRlVG9rZW4odGVzdFVzZXIpO1xuICAgICAgICAgICAgY29uc3QgdG9rZW4yID0gZ2VuZXJhdGVUb2tlbihhZG1pblVzZXIpO1xuICAgICAgICAgICAgZXhwZWN0KHRva2VuMSkubm90LnRvQmUodG9rZW4yKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBnZW5lcmF0ZSB1bmlxdWUgdG9rZW5zIChqdGkpIGZvciBzYW1lIHVzZXInLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b2tlbjEgPSBnZW5lcmF0ZVRva2VuKHRlc3RVc2VyKTtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuMiA9IGdlbmVyYXRlVG9rZW4odGVzdFVzZXIpO1xuICAgICAgICAgICAgZXhwZWN0KHRva2VuMSkubm90LnRvQmUodG9rZW4yKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyA9PT09PSBUb2tlbiBWZXJpZmljYXRpb24gPT09PT1cbiAgICBkZXNjcmliZSgndmVyaWZ5VG9rZW4nLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgdmVyaWZ5IGEgdmFsaWQgdG9rZW4gYW5kIHJldHVybiBwYXlsb2FkJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBnZW5lcmF0ZVRva2VuKHRlc3RVc2VyKTtcbiAgICAgICAgICAgIGNvbnN0IHBheWxvYWQgPSB2ZXJpZnlUb2tlbih0b2tlbik7XG5cbiAgICAgICAgICAgIGV4cGVjdChwYXlsb2FkKS5ub3QudG9CZU51bGwoKTtcbiAgICAgICAgICAgIGV4cGVjdChwYXlsb2FkIS51c2VySWQpLnRvQmUoJ3VzZXItdGVzdC0xJyk7XG4gICAgICAgICAgICBleHBlY3QocGF5bG9hZCEuZW1haWwpLnRvQmUoJ3Rlc3RAZXhhbXBsZS5jb20nKTtcbiAgICAgICAgICAgIGV4cGVjdChwYXlsb2FkIS5yb2xlKS50b0JlKCd1c2VyJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgZm9yIGludmFsaWQgdG9rZW4nLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwYXlsb2FkID0gdmVyaWZ5VG9rZW4oJ2ludmFsaWQudG9rZW4uaGVyZScpO1xuICAgICAgICAgICAgZXhwZWN0KHBheWxvYWQpLnRvQmVOdWxsKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgZm9yIGVtcHR5IHN0cmluZycsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBheWxvYWQgPSB2ZXJpZnlUb2tlbignJyk7XG4gICAgICAgICAgICBleHBlY3QocGF5bG9hZCkudG9CZU51bGwoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyA9PT09PSBSZWZyZXNoIFRva2VuID09PT09XG4gICAgZGVzY3JpYmUoJ1JlZnJlc2ggVG9rZW4nLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgYW5kIHZlcmlmeSBhIHJlZnJlc2ggdG9rZW4nLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZWZyZXNoVG9rZW4gPSBnZW5lcmF0ZVJlZnJlc2hUb2tlbih0ZXN0VXNlcik7XG4gICAgICAgICAgICBleHBlY3QodHlwZW9mIHJlZnJlc2hUb2tlbikudG9CZSgnc3RyaW5nJyk7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHZlcmlmeVJlZnJlc2hUb2tlbihyZWZyZXNoVG9rZW4pO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdCkubm90LnRvQmVOdWxsKCk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0IS51c2VySWQpLnRvQmUoJ3VzZXItdGVzdC0xJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmVqZWN0IGEgcmVndWxhciBhY2Nlc3MgdG9rZW4gYXMgcmVmcmVzaCB0b2tlbicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gZ2VuZXJhdGVUb2tlbih0ZXN0VXNlcik7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSB2ZXJpZnlSZWZyZXNoVG9rZW4oYWNjZXNzVG9rZW4pO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZU51bGwoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyA9PT09PSBUb2tlbiBFeHRyYWN0aW9uID09PT09XG4gICAgZGVzY3JpYmUoJ2V4dHJhY3RUb2tlbicsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCBleHRyYWN0IHRva2VuIGZyb20gQmVhcmVyIGhlYWRlcicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuID0gZXh0cmFjdFRva2VuKCdCZWFyZXIgYWJjMTIzJyk7XG4gICAgICAgICAgICBleHBlY3QodG9rZW4pLnRvQmUoJ2FiYzEyMycpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHJldHVybiByYXcgc3RyaW5nIGlmIG5vIEJlYXJlciBwcmVmaXgnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b2tlbiA9IGV4dHJhY3RUb2tlbigncmF3LXRva2VuJyk7XG4gICAgICAgICAgICBleHBlY3QodG9rZW4pLnRvQmUoJ3Jhdy10b2tlbicpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIGZvciB1bmRlZmluZWQgaW5wdXQnLCAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoZXh0cmFjdFRva2VuKHVuZGVmaW5lZCkpLnRvQmVOdWxsKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgLy8gPT09PT0gUm9sZSBQZXJtaXNzaW9ucyA9PT09PVxuICAgIGRlc2NyaWJlKCdSb2xlIFBlcm1pc3Npb25zJywgKCkgPT4ge1xuICAgICAgICBpdCgnc2hvdWxkIGFsbG93IGFkbWluIGFjY2VzcyB0byBhbGwgcm9sZXMnLCAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoaGFzUGVybWlzc2lvbignYWRtaW4nLCAnYWRtaW4nKSkudG9CZSh0cnVlKTtcbiAgICAgICAgICAgIGV4cGVjdChoYXNQZXJtaXNzaW9uKCdhZG1pbicsICd1c2VyJykpLnRvQmUodHJ1ZSk7XG4gICAgICAgICAgICBleHBlY3QoaGFzUGVybWlzc2lvbignYWRtaW4nLCAnZ3Vlc3QnKSkudG9CZSh0cnVlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBhbGxvdyB1c2VyIGFjY2VzcyB0byB1c2VyIGFuZCBndWVzdCcsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChoYXNQZXJtaXNzaW9uKCd1c2VyJywgJ3VzZXInKSkudG9CZSh0cnVlKTtcbiAgICAgICAgICAgIGV4cGVjdChoYXNQZXJtaXNzaW9uKCd1c2VyJywgJ2d1ZXN0JykpLnRvQmUodHJ1ZSk7XG4gICAgICAgICAgICBleHBlY3QoaGFzUGVybWlzc2lvbigndXNlcicsICdhZG1pbicpKS50b0JlKGZhbHNlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBhbGxvdyBndWVzdCBhY2Nlc3Mgb25seSB0byBndWVzdCcsICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChoYXNQZXJtaXNzaW9uKCdndWVzdCcsICdndWVzdCcpKS50b0JlKHRydWUpO1xuICAgICAgICAgICAgZXhwZWN0KGhhc1Blcm1pc3Npb24oJ2d1ZXN0JywgJ3VzZXInKSkudG9CZShmYWxzZSk7XG4gICAgICAgICAgICBleHBlY3QoaGFzUGVybWlzc2lvbignZ3Vlc3QnLCAnYWRtaW4nKSkudG9CZShmYWxzZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgY29ycmVjdGx5IGlkZW50aWZ5IGFkbWluIHJvbGUnLCAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoaXNBZG1pbignYWRtaW4nKSkudG9CZSh0cnVlKTtcbiAgICAgICAgICAgIGV4cGVjdChpc0FkbWluKCd1c2VyJykpLnRvQmUoZmFsc2UpO1xuICAgICAgICAgICAgZXhwZWN0KGlzQWRtaW4oJ2d1ZXN0JykpLnRvQmUoZmFsc2UpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIC8vID09PT09IFRva2VuIEJsYWNrbGlzdCA9PT09PVxuICAgIGRlc2NyaWJlKCdUb2tlbiBCbGFja2xpc3QnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgYmxhY2tsaXN0IGEgdG9rZW4gYW5kIGRldGVjdCBpdCcsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVUb2tlbih0ZXN0VXNlcik7XG4gICAgICAgICAgICBleHBlY3QoaXNUb2tlbkJsYWNrbGlzdGVkKHRva2VuKSkudG9CZShmYWxzZSk7XG5cbiAgICAgICAgICAgIGJsYWNrbGlzdFRva2VuKHRva2VuKTtcbiAgICAgICAgICAgIGV4cGVjdChpc1Rva2VuQmxhY2tsaXN0ZWQodG9rZW4pKS50b0JlKHRydWUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHJlamVjdCBibGFja2xpc3RlZCB0b2tlbiBpbiB2ZXJpZnlUb2tlbicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVUb2tlbih0ZXN0VXNlcik7XG4gICAgICAgICAgICBibGFja2xpc3RUb2tlbih0b2tlbik7XG5cbiAgICAgICAgICAgIGNvbnN0IHBheWxvYWQgPSB2ZXJpZnlUb2tlbih0b2tlbik7XG4gICAgICAgICAgICBleHBlY3QocGF5bG9hZCkudG9CZU51bGwoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXBvcnQgYmxhY2tsaXN0IHN0YXRzJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc3RhdHMgPSBnZXRCbGFja2xpc3RTdGF0cygpO1xuICAgICAgICAgICAgZXhwZWN0KHR5cGVvZiBzdGF0cy5jb3VudCkudG9CZSgnbnVtYmVyJyk7XG4gICAgICAgICAgICBleHBlY3QodHlwZW9mIHN0YXRzLnBlcnNpc3RlZCkudG9CZSgnYm9vbGVhbicpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9