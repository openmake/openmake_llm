978d29a91db4deb662325ad28cc2a6d8
"use strict";
/**
 * 인증 미들웨어
 * Express 요청에 대한 인증 처리
 *
 * #5 개선: 역방향 참조 제거 - getUserById를 DI(의존성 주입)로 전환
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerUserLookup = registerUserLookup;
exports.optionalAuth = optionalAuth;
exports.requireAuth = requireAuth;
exports.requireAdmin = requireAdmin;
exports.requireRole = requireRole;
const index_1 = require("./index");
let _userLookup = null;
/**
 * 사용자 조회 함수 등록 (앱 초기화 시 호출)
 *
 * @example
 * ```typescript
 * import { registerUserLookup } from './infrastructure/security/auth/middleware';
 * import { getUserManager } from './data/user-manager';
 *
 * registerUserLookup((userId) => getUserManager().getUserById(userId));
 * ```
 */
function registerUserLookup(fn) {
    _userLookup = fn;
    console.log('[Auth Middleware] 사용자 조회 함수 등록됨');
}
function getUserById(userId) {
    if (!_userLookup) {
        console.error('[Auth Middleware] 사용자 조회 함수가 등록되지 않았습니다! registerUserLookup()을 호출하세요.');
        return null;
    }
    return _userLookup(userId);
}
/**
 * 인증 미들웨어 (선택적)
 * 토큰이 있으면 검증하고 사용자 정보를 req.user에 추가
 * 토큰이 없어도 통과 (게스트 허용)
 */
function optionalAuth(req, res, next) {
    const authHeader = req.headers.authorization;
    const token = (0, index_1.extractToken)(authHeader);
    if (token) {
        const payload = (0, index_1.verifyToken)(token);
        if (payload) {
            const user = getUserById(payload.userId);
            if (user && user.is_active) {
                req.user = user;
                req.token = token;
            }
        }
    }
    next();
}
/**
 * 인증 필수 미들웨어
 * 유효한 토큰이 없으면 401 반환
 */
function requireAuth(req, res, next) {
    const authHeader = req.headers.authorization;
    const token = (0, index_1.extractToken)(authHeader);
    if (!token) {
        res.status(401).json({ error: '인증이 필요합니다' });
        return;
    }
    const payload = (0, index_1.verifyToken)(token);
    if (!payload) {
        res.status(401).json({ error: '유효하지 않은 토큰입니다' });
        return;
    }
    const user = getUserById(payload.userId);
    if (!user) {
        res.status(401).json({ error: '사용자를 찾을 수 없습니다' });
        return;
    }
    if (!user.is_active) {
        res.status(403).json({ error: '비활성화된 계정입니다' });
        return;
    }
    req.user = user;
    req.token = token;
    next();
}
/**
 * 관리자 권한 필수 미들웨어
 * requireAuth 이후에 사용
 */
function requireAdmin(req, res, next) {
    if (!req.user) {
        res.status(401).json({ error: '인증이 필요합니다' });
        return;
    }
    if (!(0, index_1.isAdmin)(req.user.role)) {
        res.status(403).json({ error: '관리자 권한이 필요합니다' });
        return;
    }
    next();
}
/**
 * 특정 역할 필수 미들웨어 팩토리
 */
function requireRole(role) {
    return (req, res, next) => {
        if (!req.user) {
            res.status(401).json({ error: '인증이 필요합니다' });
            return;
        }
        if (!(0, index_1.hasPermission)(req.user.role, role)) {
            res.status(403).json({ error: `${role} 이상의 권한이 필요합니다` });
            return;
        }
        next();
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vaW5mcmFzdHJ1Y3R1cmUvc2VjdXJpdHkvYXV0aC9taWRkbGV3YXJlLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7QUE2QkgsZ0RBR0M7QUFlRCxvQ0FrQkM7QUFNRCxrQ0ErQkM7QUFNRCxvQ0FZQztBQUtELGtDQWNDO0FBeElELG1DQUE0RTtBQWE1RSxJQUFJLFdBQVcsR0FBd0IsSUFBSSxDQUFDO0FBRTVDOzs7Ozs7Ozs7O0dBVUc7QUFDSCxTQUFnQixrQkFBa0IsQ0FBQyxFQUFnQjtJQUMvQyxXQUFXLEdBQUcsRUFBRSxDQUFDO0lBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUNBQWlDLENBQUMsQ0FBQztBQUNuRCxDQUFDO0FBRUQsU0FBUyxXQUFXLENBQUMsTUFBYztJQUMvQixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHVFQUF1RSxDQUFDLENBQUM7UUFDdkYsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUNELE9BQU8sV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQy9CLENBQUM7QUFFRDs7OztHQUlHO0FBQ0gsU0FBZ0IsWUFBWSxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0I7SUFDeEUsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUM7SUFDN0MsTUFBTSxLQUFLLEdBQUcsSUFBQSxvQkFBWSxFQUFDLFVBQVUsQ0FBQyxDQUFDO0lBRXZDLElBQUksS0FBSyxFQUFFLENBQUM7UUFDUixNQUFNLE9BQU8sR0FBRyxJQUFBLG1CQUFXLEVBQUMsS0FBSyxDQUFDLENBQUM7UUFFbkMsSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUNWLE1BQU0sSUFBSSxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFekMsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUN6QixHQUFHLENB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TSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxHQUFHLElBQUksZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1lBQ3pELE9BQU87UUFDWCxDQUFDO1FBRUQsSUFBSSxFQUFFLENBQUM7SUFDWCxDQUFDLENBQUM7QUFDTixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Wb2x1bWVzL01BQ19BUFAvb3Blbm1ha2VfbGxtL2luZnJhc3RydWN0dXJlL3NlY3VyaXR5L2F1dGgvbWlkZGxld2FyZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIOyduOymnSDrr7jrk6Tsm6jslrRcbiAqIEV4cHJlc3Mg7JqU7LKt7JeQIOuMgO2VnCDsnbjspp0g7LKY66asXG4gKiBcbiAqICM1IOqwnOyEoDog7Jet67Cp7ZalIOywuOyhsCDsoJzqsbAgLSBnZXRVc2VyQnlJZOulvCBESSjsnZjsobTshLEg7KO87J6FKeuhnCDsoITtmZhcbiAqL1xuXG5pbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBleHRyYWN0VG9rZW4sIHZlcmlmeVRva2VuLCBoYXNQZXJtaXNzaW9uLCBpc0FkbWluIH0gZnJvbSAnLi9pbmRleCc7XG5pbXBvcnQgeyBQdWJsaWNVc2VyLCBBdXRoVXNlciwgVXNlclJvbGUgfSBmcm9tICcuL3R5cGVzJztcblxuLy8gTk9URTogRXhwcmVzcy5SZXF1ZXN0LnVzZXIg7YOA7J6F7J2AIGJhY2tlbmQvYXBpL3NyYy9hdXRoL21pZGRsZXdhcmUudHPsl5DshJxcbi8vIGRlY2xhcmUgZ2xvYmFs66GcIOyEoOyWuOuQqC4g67mM65Oc65CcIC5kLnRz7JmAIOykkeuztSDshKDslrgg7Lap64+M7J2EIOuwqeyngO2VmOq4sCDsnITtlbRcbi8vIOydtCDrqqjrk4jsl5DshJzripQgZ2xvYmFsIO2DgOyeheydhCDsnqzshKDslrjtlZjsp4Ag7JWK7J2MLlxuXG4vKipcbiAqIOyCrOyaqeyekCDsobDtmowg7ZWo7IiYIO2DgOyehVxuICog7Jm467aA7JeQ7IScIOyjvOyehe2VmOyXrCDsl63rsKntlqUg7J2Y7KG07ISxIOygnOqxsFxuICovXG50eXBlIFVzZXJMb29rdXBGbiA9ICh1c2VySWQ6IHN0cmluZykgPT4gUHVibGljVXNlciB8IG51bGw7XG5cbmxldCBfdXNlckxvb2t1cDogVXNlckxvb2t1cEZuIHwgbnVsbCA9IG51bGw7XG5cbi8qKlxuICog7IKs7Jqp7J6QIOyhsO2ajCDtlajsiJgg65Ox66GdICjslbEg7LSI6riw7ZmUIOyLnCDtmLjstpwpXG4gKiBcbiAqIEBleGFtcGxlXG4gKiBgYGB0eXBlc2NyaXB0XG4gKiBpbXBvcnQgeyByZWdpc3RlclVzZXJMb29rdXAgfSBmcm9tICcuL2luZnJhc3RydWN0dXJlL3NlY3VyaXR5L2F1dGgvbWlkZGxld2FyZSc7XG4gKiBpbXBvcnQgeyBnZXRVc2VyTWFuYWdlciB9IGZyb20gJy4vZGF0YS91c2VyLW1hbmFnZXInO1xuICogXG4gKiByZWdpc3RlclVzZXJMb29rdXAoKHVzZXJJZCkgPT4gZ2V0VXNlck1hbmFnZXIoKS5nZXRVc2VyQnlJZCh1c2VySWQpKTtcbiAqIGBgYFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXJVc2VyTG9va3VwKGZuOiBVc2VyTG9va3VwRm4pOiB2b2lkIHtcbiAgICBfdXNlckxvb2t1cCA9IGZuO1xuICAgIGNvbnNvbGUubG9nKCdbQXV0aCBNaWRkbGV3YXJlXSDsgqzsmqnsnpAg7KGw7ZqMIO2VqOyImCDrk7HroZ3rkKgnKTtcbn1cblxuZnVuY3Rpb24gZ2V0VXNlckJ5SWQodXNlcklkOiBzdHJpbmcpOiBQdWJsaWNVc2VyIHwgbnVsbCB7XG4gICAgaWYgKCFfdXNlckxvb2t1cCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdbQXV0aCBNaWRkbGV3YXJlXSDsgqzsmqnsnpAg7KGw7ZqMIO2VqOyImOqwgCDrk7HroZ3rkJjsp4Ag7JWK7JWY7Iq164uI64ukISByZWdpc3RlclVzZXJMb29rdXAoKeydhCDtmLjstpztlZjshLjsmpQuJyk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gX3VzZXJMb29rdXAodXNlcklkKTtcbn1cblxuLyoqXG4gKiDsnbjspp0g66+465Ok7Juo7Ja0ICjshKDtg53soIEpXG4gKiDthqDtgbDsnbQg7J6I7Jy866m0IOqygOymne2VmOqzoCDsgqzsmqnsnpAg7KCV67O066W8IHJlcS51c2Vy7JeQIOy2lOqwgFxuICog7Yag7YGw7J20IOyXhuyWtOuPhCDthrXqs7wgKOqyjOyKpO2KuCDtl4jsmqkpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBvcHRpb25hbEF1dGgocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiB2b2lkIHtcbiAgICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbjtcbiAgICBjb25zdCB0b2tlbiA9IGV4dHJhY3RUb2tlbihhdXRoSGVhZGVyKTtcblxuICAgIGlmICh0b2tlbikge1xuICAgICAgICBjb25zdCBwYXlsb2FkID0gdmVyaWZ5VG9rZW4odG9rZW4pO1xuXG4gICAgICAgIGlmIChwYXlsb2FkKSB7XG4gICAgICAgICAgICBjb25zdCB1c2VyID0gZ2V0VXNlckJ5SWQocGF5bG9hZC51c2VySWQpO1xuXG4gICAgICAgICAgICBpZiAodXNlciAmJiB1c2VyLmlzX2FjdGl2ZSkge1xuICAgICAgICAgICAgICAgIHJlcS51c2VyID0gdXNlcjtcbiAgICAgICAgICAgICAgICByZXEudG9rZW4gPSB0b2tlbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5leHQoKTtcbn1cblxuLyoqXG4gKiDsnbjspp0g7ZWE7IiYIOuvuOuTpOybqOyWtFxuICog7Jyg7Zqo7ZWcIO2GoO2BsOydtCDsl4bsnLzrqbQgNDAxIOuwmO2ZmFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVxdWlyZUF1dGgocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiB2b2lkIHtcbiAgICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbjtcbiAgICBjb25zdCB0b2tlbiA9IGV4dHJhY3RUb2tlbihhdXRoSGVhZGVyKTtcblxuICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ+yduOymneydtCDtlYTsmpTtlanri4jri6QnIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcGF5bG9hZCA9IHZlcmlmeVRva2VuKHRva2VuKTtcblxuICAgIGlmICghcGF5bG9hZCkge1xuICAgICAgICByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAn7Jyg7Zqo7ZWY7KeAIOyViuydgCDthqDtgbDsnoXri4jri6QnIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdXNlciA9IGdldFVzZXJCeUlkKHBheWxvYWQudXNlcklkKTtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgICByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAn7IKs7Jqp7J6Q66W8IOywvuydhCDsiJgg7JeG7Iq164uI64ukJyB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdXNlci5pc19hY3RpdmUpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ+u5hO2ZnOyEse2ZlOuQnCDqs4TsoJXsnoXri4jri6QnIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcmVxLnVzZXIgPSB1c2VyO1xuICAgIHJlcS50b2tlbiA9IHRva2VuO1xuICAgIG5leHQoKTtcbn1cblxuLyoqXG4gKiDqtIDrpqzsnpAg6raM7ZWcIO2VhOyImCDrr7jrk6Tsm6jslrRcbiAqIHJlcXVpcmVBdXRoIOydtO2bhOyXkCDsgqzsmqlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVBZG1pbihyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQge1xuICAgIGlmICghcmVxLnVzZXIpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ+yduOymneydtCDtlYTsmpTtlanri4jri6QnIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCFpc0FkbWluKHJlcS51c2VyLnJvbGUpKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICfqtIDrpqzsnpAg6raM7ZWc7J20IO2VhOyalO2VqeuLiOuLpCcgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBuZXh0KCk7XG59XG5cbi8qKlxuICog7Yq57KCVIOyXre2VoCDtlYTsiJgg66+465Ok7Juo7Ja0IO2Mqe2GoOumrFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVxdWlyZVJvbGUocm9sZTogVXNlclJvbGUpIHtcbiAgICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogdm9pZCA9PiB7XG4gICAgICAgIGlmICghcmVxLnVzZXIpIHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICfsnbjspp3snbQg7ZWE7JqU7ZWp64uI64ukJyB9KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghaGFzUGVybWlzc2lvbihyZXEudXNlci5yb2xlLCByb2xlKSkge1xuICAgICAgICAgICAgcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogYCR7cm9sZX0g7J207IOB7J2YIOq2jO2VnOydtCDtlYTsmpTtlanri4jri6RgIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbmV4dCgpO1xuICAgIH07XG59XG4iXSwidmVyc2lvbiI6M30=