{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/agents/custom-builder.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/agents/custom-builder.ts"],"sourcesContent":["/**\n * üÜï Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ ÎπåÎçî\n * ÏÇ¨Ïö©Ïûê Ï†ïÏùò ÏóêÏù¥Ï†ÑÌä∏ ÏÉùÏÑ±, Î≥µÏ†ú, A/B ÌÖåÏä§Ìä∏\n */\n\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { createLogger } from '../utils/logger';\nimport { Agent } from './types';\n\n/**\n * Sanitize agent ID to prevent path traversal attacks.\n * Only allows alphanumeric characters, hyphens, and underscores.\n */\nexport function sanitizeAgentId(name: string): string {\n    const sanitized = name\n        .toLowerCase()\n        .replace(/[^a-z0-9Í∞Ä-Ìû£_-]/g, '-')  // Allow Korean chars, alphanumeric, hyphens, underscores\n        .replace(/-+/g, '-')                   // Collapse multiple hyphens\n        .replace(/^-|-$/g, '')                 // Trim leading/trailing hyphens\n        .substring(0, 50);                     // Length limit\n\n    if (!sanitized || sanitized.length === 0) {\n        throw new Error('Invalid agent name: results in empty ID after sanitization');\n    }\n\n    return sanitized;\n}\n\n/**\n * Validate that a resolved file path stays within the expected base directory.\n * Prevents path traversal attacks (e.g., ../../etc/passwd).\n */\nexport function validatePathWithinDir(filePath: string, baseDir: string): void {\n    const resolved = path.resolve(filePath);\n    const base = path.resolve(baseDir);\n    if (!resolved.startsWith(base + path.sep) && resolved !== base) {\n        throw new Error('Path traversal attempt detected');\n    }\n}\n\nconst logger = createLogger('CustomAgentBuilder');\n\n// Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ ÏÑ§Ï†ï\ninterface CustomAgentConfig {\n    id: string;\n    name: string;\n    description: string;\n    systemPrompt: string;\n    keywords: string[];\n    category: string;\n    emoji?: string;\n    temperature?: number;\n    maxTokens?: number;\n    createdBy?: string;\n    createdAt: Date;\n    updatedAt: Date;\n    enabled: boolean;\n}\n\n// A/B ÌÖåÏä§Ìä∏ Í≤∞Í≥º\ninterface ABTestResult {\n    testId: string;\n    agentA: string;\n    agentB: string;\n    totalQueries: number;\n    results: {\n        agentAWins: number;\n        agentBWins: number;\n        ties: number;\n    };\n    metrics: {\n        agentAAvgTime: number;\n        agentBAvgTime: number;\n        agentAAvgRating: number;\n        agentBAvgRating: number;\n    };\n    winner: 'A' | 'B' | 'tie';\n    startedAt: Date;\n    completedAt?: Date;\n}\n\n/**\n * Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ ÎπåÎçî\n */\nexport class CustomAgentBuilder {\n    private customAgents: Map<string, CustomAgentConfig> = new Map();\n    private abTests: Map<string, ABTestResult> = new Map();\n    private dataPath: string;\n    private promptsDir: string;\n\n    constructor(dataDir: string = './data', promptsDir: string = './src/agents/prompts') {\n        this.dataPath = path.join(dataDir, 'custom-agents.json');\n        this.promptsDir = promptsDir;\n        this.loadCustomAgents();\n        logger.info('Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ ÎπåÎçî Ï¥àÍ∏∞ÌôîÎê®');\n    }\n\n    /**\n     * Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ Î°úÎìú\n     */\n    private loadCustomAgents(): void {\n        try {\n            if (fs.existsSync(this.dataPath)) {\n                const data = JSON.parse(fs.readFileSync(this.dataPath, 'utf-8'));\n                for (const agent of data.agents || []) {\n                    this.customAgents.set(agent.id, agent);\n                }\n                logger.info(`Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ ${this.customAgents.size}Í∞ú Î°úÎìúÎê®`);\n            }\n        } catch (error) {\n            logger.warn('Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ Î°úÎìú Ïã§Ìå®:', error);\n        }\n    }\n\n    /**\n     * Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ Ï†ÄÏû•\n     */\n    private saveCustomAgents(): void {\n        try {\n            const dir = path.dirname(this.dataPath);\n            if (!fs.existsSync(dir)) {\n                fs.mkdirSync(dir, { recursive: true });\n            }\n            fs.writeFileSync(this.dataPath, JSON.stringify({\n                agents: Array.from(this.customAgents.values()),\n                lastUpdated: new Date().toISOString()\n            }, null, 2));\n        } catch (error) {\n            logger.error('Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ Ï†ÄÏû• Ïã§Ìå®:', error);\n        }\n    }\n\n    /**\n     * ÏÉà Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ ÏÉùÏÑ±\n     */\n    createAgent(config: {\n        name: string;\n        description: string;\n        systemPrompt: string;\n        keywords: string[];\n        category: string;\n        emoji?: string;\n        temperature?: number;\n        maxTokens?: number;\n        createdBy?: string;\n    }): CustomAgentConfig {\n        // Í≥†Ïú† ID ÏÉùÏÑ±\n        const id = `custom-${sanitizeAgentId(config.name)}-${Date.now()}`;\n\n        const agent: CustomAgentConfig = {\n            id,\n            name: config.name,\n            description: config.description,\n            systemPrompt: config.systemPrompt,\n            keywords: config.keywords,\n            category: config.category,\n            emoji: config.emoji || 'ü§ñ',\n            temperature: config.temperature,\n            maxTokens: config.maxTokens,\n            createdBy: config.createdBy,\n            createdAt: new Date(),\n            updatedAt: new Date(),\n            enabled: true\n        };\n\n        this.customAgents.set(id, agent);\n\n        // ÌîÑÎ°¨ÌîÑÌä∏ ÌååÏùºÎèÑ ÏÉùÏÑ±\n        this.savePromptFile(id, config.systemPrompt);\n\n        this.saveCustomAgents();\n        logger.info(`Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ ÏÉùÏÑ±Îê®: ${id}`);\n\n        return agent;\n    }\n\n    /**\n     * Í∏∞Ï°¥ ÏóêÏù¥Ï†ÑÌä∏ Î≥µÏ†ú\n     */\n    cloneAgent(sourceAgentId: string, modifications: Partial<CustomAgentConfig>): CustomAgentConfig | null {\n        // ÏãúÏä§ÌÖú ÏóêÏù¥Ï†ÑÌä∏ÏóêÏÑú ÌîÑÎ°¨ÌîÑÌä∏ Î°úÎìú\n        let sourcePrompt = '';\n        const promptPath = path.join(this.promptsDir, `${sanitizeAgentId(sourceAgentId)}.md`);\n        validatePathWithinDir(promptPath, this.promptsDir);\n\n        if (fs.existsSync(promptPath)) {\n            sourcePrompt = fs.readFileSync(promptPath, 'utf-8');\n        } else {\n            logger.warn(`ÏõêÎ≥∏ ÏóêÏù¥Ï†ÑÌä∏ ÌîÑÎ°¨ÌîÑÌä∏ ÏóÜÏùå: ${sourceAgentId}`);\n        }\n\n        const newName = modifications.name || `${sourceAgentId}-clone`;\n\n        return this.createAgent({\n            name: newName,\n            description: modifications.description || `${sourceAgentId}Ïùò Î≥µÏ†úÎ≥∏`,\n            systemPrompt: modifications.systemPrompt || sourcePrompt,\n            keywords: modifications.keywords || [],\n            category: modifications.category || 'custom',\n            emoji: modifications.emoji,\n            temperature: modifications.temperature,\n            maxTokens: modifications.maxTokens,\n            createdBy: modifications.createdBy\n        });\n    }\n\n    /**\n     * ÏóêÏù¥Ï†ÑÌä∏ ÏàòÏ†ï\n     */\n    updateAgent(agentId: string, updates: Partial<CustomAgentConfig>): CustomAgentConfig | null {\n        const agent = this.customAgents.get(agentId);\n        if (!agent) {\n            logger.warn(`ÏóêÏù¥Ï†ÑÌä∏ ÏóÜÏùå: ${agentId}`);\n            return null;\n        }\n\n        const updated: CustomAgentConfig = {\n            ...agent,\n            ...updates,\n            id: agent.id, // IDÎäî Î≥ÄÍ≤Ω Î∂àÍ∞Ä\n            createdAt: agent.createdAt,\n            updatedAt: new Date()\n        };\n\n        this.customAgents.set(agentId, updated);\n\n        // ÌîÑÎ°¨ÌîÑÌä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ïãú ÌååÏùºÎèÑ Í∞±Ïã†\n        if (updates.systemPrompt) {\n            this.savePromptFile(agentId, updates.systemPrompt);\n        }\n\n        this.saveCustomAgents();\n        logger.info(`ÏóêÏù¥Ï†ÑÌä∏ ÏóÖÎç∞Ïù¥Ìä∏Îê®: ${agentId}`);\n\n        return updated;\n    }\n\n    /**\n     * ÏóêÏù¥Ï†ÑÌä∏ ÏÇ≠Ï†ú\n     */\n    deleteAgent(agentId: string): boolean {\n        if (!this.customAgents.has(agentId)) {\n            return false;\n        }\n\n        this.customAgents.delete(agentId);\n\n        // ÌîÑÎ°¨ÌîÑÌä∏ ÌååÏùºÎèÑ ÏÇ≠Ï†ú\n        const safeDeleteId = sanitizeAgentId(agentId);\n        const promptPath = path.join(this.promptsDir, `${safeDeleteId}.md`);\n        validatePathWithinDir(promptPath, this.promptsDir);\n        if (fs.existsSync(promptPath)) {\n            fs.unlinkSync(promptPath);\n        }\n\n        this.saveCustomAgents();\n        logger.info(`ÏóêÏù¥Ï†ÑÌä∏ ÏÇ≠Ï†úÎê®: ${agentId}`);\n\n        return true;\n    }\n\n    /**\n     * ÌîÑÎ°¨ÌîÑÌä∏ ÌååÏùº Ï†ÄÏû•\n     */\n    private savePromptFile(agentId: string, prompt: string): void {\n        try {\n            if (!fs.existsSync(this.promptsDir)) {\n                fs.mkdirSync(this.promptsDir, { recursive: true });\n            }\n            const safeId = sanitizeAgentId(agentId);\n            const promptPath = path.join(this.promptsDir, `${safeId}.md`);\n            validatePathWithinDir(promptPath, this.promptsDir);\n            fs.writeFileSync(promptPath, prompt);\n        } catch (error) {\n            logger.error(`ÌîÑÎ°¨ÌîÑÌä∏ ÌååÏùº Ï†ÄÏû• Ïã§Ìå®: ${agentId}`, error);\n        }\n    }\n\n    /**\n     * A/B ÌÖåÏä§Ìä∏ ÏãúÏûë\n     */\n    startABTest(agentA: string, agentB: string): ABTestResult {\n        const testId = `ab-${Date.now()}`;\n\n        const test: ABTestResult = {\n            testId,\n            agentA,\n            agentB,\n            totalQueries: 0,\n            results: {\n                agentAWins: 0,\n                agentBWins: 0,\n                ties: 0\n            },\n            metrics: {\n                agentAAvgTime: 0,\n                agentBAvgTime: 0,\n                agentAAvgRating: 0,\n                agentBAvgRating: 0\n            },\n            winner: 'tie',\n            startedAt: new Date()\n        };\n\n        this.abTests.set(testId, test);\n        logger.info(`A/B ÌÖåÏä§Ìä∏ ÏãúÏûë: ${testId} (${agentA} vs ${agentB})`);\n\n        return test;\n    }\n\n    /**\n     * A/B ÌÖåÏä§Ìä∏ Í≤∞Í≥º Í∏∞Î°ù\n     */\n    recordABTestResult(\n        testId: string,\n        winner: 'A' | 'B' | 'tie',\n        metrics: { responseTimeA: number; responseTimeB: number; ratingA?: number; ratingB?: number }\n    ): void {\n        const test = this.abTests.get(testId);\n        if (!test) return;\n\n        test.totalQueries++;\n\n        switch (winner) {\n            case 'A': test.results.agentAWins++; break;\n            case 'B': test.results.agentBWins++; break;\n            case 'tie': test.results.ties++; break;\n        }\n\n        // Ïù¥Îèô ÌèâÍ∑† Í≥ÑÏÇ∞\n        const n = test.totalQueries;\n        test.metrics.agentAAvgTime = ((test.metrics.agentAAvgTime * (n - 1)) + metrics.responseTimeA) / n;\n        test.metrics.agentBAvgTime = ((test.metrics.agentBAvgTime * (n - 1)) + metrics.responseTimeB) / n;\n\n        if (metrics.ratingA) {\n            test.metrics.agentAAvgRating = ((test.metrics.agentAAvgRating * (n - 1)) + metrics.ratingA) / n;\n        }\n        if (metrics.ratingB) {\n            test.metrics.agentBAvgRating = ((test.metrics.agentBAvgRating * (n - 1)) + metrics.ratingB) / n;\n        }\n\n        // ÏäπÏûê ÌåêÏ†ï\n        if (test.results.agentAWins > test.results.agentBWins * 1.2) {\n            test.winner = 'A';\n        } else if (test.results.agentBWins > test.results.agentAWins * 1.2) {\n            test.winner = 'B';\n        } else {\n            test.winner = 'tie';\n        }\n    }\n\n    /**\n     * A/B ÌÖåÏä§Ìä∏ ÏôÑÎ£å\n     */\n    completeABTest(testId: string): ABTestResult | null {\n        const test = this.abTests.get(testId);\n        if (!test) return null;\n\n        test.completedAt = new Date();\n        logger.info(`A/B ÌÖåÏä§Ìä∏ ÏôÑÎ£å: ${testId} - ÏäπÏûê: ${test.winner}`);\n\n        return test;\n    }\n\n    /**\n     * Î™®Îì† Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ Ï°∞Ìöå\n     */\n    getAllCustomAgents(): CustomAgentConfig[] {\n        return Array.from(this.customAgents.values());\n    }\n\n    /**\n     * Îã®Ïùº Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏ Ï°∞Ìöå\n     */\n    getCustomAgent(agentId: string): CustomAgentConfig | undefined {\n        return this.customAgents.get(agentId);\n    }\n\n    /**\n     * ÌôúÏÑ±ÌôîÎêú Ïª§Ïä§ÌÖÄ ÏóêÏù¥Ï†ÑÌä∏Î•º Agent ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò\n     */\n    getEnabledAgentsAsAgents(): Agent[] {\n        return Array.from(this.customAgents.values())\n            .filter(a => a.enabled)\n            .map(a => ({\n                id: a.id,\n                name: a.name,\n                description: a.description,\n                keywords: a.keywords,\n                emoji: a.emoji || 'ü§ñ',\n                category: a.category\n            }));\n    }\n\n    /**\n     * A/B ÌÖåÏä§Ìä∏ Í≤∞Í≥º Ï°∞Ìöå\n     */\n    getABTestResult(testId: string): ABTestResult | undefined {\n        return this.abTests.get(testId);\n    }\n\n    /**\n     * Î™®Îì† A/B ÌÖåÏä§Ìä∏ Ï°∞Ìöå\n     */\n    getAllABTests(): ABTestResult[] {\n        return Array.from(this.abTests.values());\n    }\n}\n\n// Ïã±Í∏ÄÌÜ§ Ïù∏Ïä§ÌÑ¥Ïä§\nlet builderInstance: CustomAgentBuilder | null = null;\n\nexport function getCustomAgentBuilder(): CustomAgentBuilder {\n    if (!builderInstance) {\n        builderInstance = new CustomAgentBuilder();\n    }\n    return builderInstance;\n}\n"],"version":3}