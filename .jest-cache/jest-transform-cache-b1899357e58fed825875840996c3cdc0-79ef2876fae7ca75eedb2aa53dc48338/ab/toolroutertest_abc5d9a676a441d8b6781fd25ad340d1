d7df705d23d1d0a9a66f239bf27351e3
"use strict";
/**
 * ToolRouter Unit Tests
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const tool_router_1 = require("../tool-router");
const types_1 = require("../types");
describe('ToolRouter', () => {
    let router;
    beforeEach(() => {
        router = new tool_router_1.ToolRouter();
    });
    describe('getAllTools', () => {
        it('should include built-in tools', () => {
            const tools = router.getAllTools();
            expect(tools.length).toBeGreaterThan(0);
            // ðŸ”’ ë³´ì•ˆ íŒ¨ì¹˜ 2026-02-07: run_command ì œê±°ë¨ â€” vision_ocrê°€ ë‚¨ì•„ìžˆì–´ì•¼ í•¨
            const visionOcr = tools.find(t => t.name === 'vision_ocr');
            expect(visionOcr).toBeDefined();
            // run_commandëŠ” ë³´ì•ˆìƒ ì œê±°ë˜ì–´ ì¡´ìž¬í•˜ì§€ ì•Šì•„ì•¼ í•¨
            const runCommand = tools.find(t => t.name === 'run_command');
            expect(runCommand).toBeUndefined();
        });
        it('should include external tools after registration', () => {
            const mockTool = {
                name: 'list_tables',
                description: 'List database tables',
                inputSchema: { type: 'object', properties: {}, required: [] }
            };
            const mockExecutor = (_name, _args) => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: 'ok' }]
                });
            });
            router.registerExternalTools('server1', 'postgres', [mockTool], mockExecutor);
            const tools = router.getAllTools();
            const external = tools.find(t => t.name === `postgres${types_1.MCP_NAMESPACE_SEPARATOR}list_tables`);
            expect(external).toBeDefined();
            expect(external.description).toBe('List database tables');
        });
    });
    describe('getToolsForTier', () => {
        it('should filter tools for free tier', () => {
            const tools = router.getToolsForTier('free');
            // free tier has web_search, vision_ocr, analyze_image
            const names = tools.map(t => t.name);
            expect(names).toContain('web_search');
        });
        it('should exclude external tools for free tier', () => {
            const mockTool = {
                name: 'query',
                description: 'Run SQL',
                inputSchema: { type: 'object', properties: {}, required: [] }
            };
            router.registerExternalTools('s1', 'db', [mockTool], () => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: 'ok' }]
                });
            }));
            const freeTools = router.getToolsForTier('free');
            const hasExternal = freeTools.some(t => t.name.includes(types_1.MCP_NAMESPACE_SEPARATOR));
            expect(hasExternal).toBe(false);
        });
        it('should include external tools for enterprise tier', () => {
            const mockTool = {
                name: 'query',
                description: 'Run SQL',
                inputSchema: { type: 'object', properties: {}, required: [] }
            };
            router.registerExternalTools('s1', 'db', [mockTool], () => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: 'ok' }]
                });
            }));
            const entTools = router.getToolsForTier('enterprise');
            const external = entTools.find(t => t.name === `db${types_1.MCP_NAMESPACE_SEPARATOR}query`);
            expect(external).toBeDefined();
        });
    });
    describe('executeTool', () => {
        it('should execute a built-in tool', () => __awaiter(void 0, void 0, void 0, function* () {
            // run_command is a built-in tool
            const result = yield router.executeTool('run_command', { command: 'echo hello' });
            expect(result).toBeDefined();
            expect(result.content).toBeDefined();
            expect(result.content.length).toBeGreaterThan(0);
        }));
        it('should execute an external tool', () => __awaiter(void 0, void 0, void 0, function* () {
            const mockTool = {
                name: 'ping',
                description: 'Ping service',
                inputSchema: { type: 'object', properties: {}, required: [] }
            };
            const mockExecutor = (name, _args) => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: `pong from ${name}` }]
                });
            });
            router.registerExternalTools('srv1', 'myserver', [mockTool], mockExecutor);
            const result = yield router.executeTool(`myserver${types_1.MCP_NAMESPACE_SEPARATOR}ping`, {});
            expect(result.isError).toBeFalsy();
            expect(result.content[0].text).toBe('pong from ping');
        }));
        it('should return error for unknown tool', () => __awaiter(void 0, void 0, void 0, function* () {
            const result = yield router.executeTool('nonexistent_tool', {});
            expect(result.isError).toBe(true);
        }));
        it('should return error for unknown external tool', () => __awaiter(void 0, void 0, void 0, function* () {
            const result = yield router.executeTool(`unknown${types_1.MCP_NAMESPACE_SEPARATOR}tool`, {});
            expect(result.isError).toBe(true);
        }));
    });
    describe('registerExternalTools / unregisterExternalTools', () => {
        it('should register and count external tools', () => {
            const tools = [
                { name: 'a', description: 'A', inputSchema: { type: 'object', properties: {}, required: [] } },
                { name: 'b', description: 'B', inputSchema: { type: 'object', properties: {}, required: [] } },
            ];
            router.registerExternalTools('s1', 'ext', tools, () => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: 'ok' }]
                });
            }));
            expect(router.getExternalToolCount()).toBe(2);
        });
        it('should unregister tools by serverId', () => {
            const tools = [
                { name: 'x', description: 'X', inputSchema: { type: 'object', properties: {}, required: [] } },
            ];
            router.registerExternalTools('s1', 'ext', tools, () => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: 'ok' }]
                });
            }));
            expect(router.getExternalToolCount()).toBe(1);
            router.unregisterExternalTools('s1');
            expect(router.getExternalToolCount()).toBe(0);
        });
        it('should replace tools on re-registration', () => {
            const executor = () => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: 'ok' }]
                });
            });
            router.registerExternalTools('s1', 'ext', [
                { name: 'a', description: 'A', inputSchema: { type: 'object', properties: {}, required: [] } },
                { name: 'b', description: 'B', inputSchema: { type: 'object', properties: {}, required: [] } },
            ], executor);
            expect(router.getExternalToolCount()).toBe(2);
            // Re-register with different tools
            router.registerExternalTools('s1', 'ext', [
                { name: 'c', description: 'C', inputSchema: { type: 'object', properties: {}, required: [] } },
            ], executor);
            expect(router.getExternalToolCount()).toBe(1);
        });
    });
    describe('getOllamaTools', () => {
        it('should return Ollama-compatible format', () => {
            const tools = router.getOllamaTools('enterprise');
            expect(tools.length).toBeGreaterThan(0);
            const first = tools[0];
            expect(first.type).toBe('function');
            expect(first.function).toBeDefined();
            expect(first.function.name).toBeDefined();
            expect(first.function.description).toBeDefined();
            expect(first.function.parameters).toBeDefined();
        });
    });
    describe('isExternalTool', () => {
        it('should identify external tools by namespace separator', () => {
            expect(router.isExternalTool(`server${types_1.MCP_NAMESPACE_SEPARATOR}tool`)).toBe(true);
            expect(router.isExternalTool('run_command')).toBe(false);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL21jcC9fX3Rlc3RzX18vdG9vbC1yb3V0ZXIudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7Ozs7Ozs7Ozs7O0FBRUgsZ0RBQTRDO0FBRTVDLG9DQUFtRDtBQUVuRCxRQUFRLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRTtJQUN4QixJQUFJLE1BQWtCLENBQUM7SUFFdkIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNaLE1BQU0sR0FBRyxJQUFJLHdCQUFVLEVBQUUsQ0FBQztJQUM5QixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO1FBQ3pCLEVBQUUsQ0FBQywrQkFBK0IsRUFBRSxHQUFHLEVBQUU7WUFDckMsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ25DLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXhDLDZEQUE2RDtZQUM3RCxNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxZQUFZLENBQUMsQ0FBQztZQUMzRCxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDaEMsbUNBQW1DO1lBQ25DLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLGFBQWEsQ0FBQyxDQUFDO1lBQzdELE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN2QyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxrREFBa0QsRUFBRSxHQUFHLEVBQUU7WUFDeEQsTUFBTSxRQUFRLEdBQVk7Z0JBQ3RCLElBQUksRUFBRSxhQUFhO2dCQUNuQixXQUFXLEVB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QUFFLENBQUM7WUFDckMsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDMUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDakQsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDcEQsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7UUFDNUIsRUFBRSxDQUFDLHVEQUF1RCxFQUFFLEdBQUcsRUFBRTtZQUM3RCxNQUFNLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxTQUFTLCtCQUF1QixNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNqRixNQUFNLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3RCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL21jcC9fX3Rlc3RzX18vdG9vbC1yb3V0ZXIudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRvb2xSb3V0ZXIgVW5pdCBUZXN0c1xuICovXG5cbmltcG9ydCB7IFRvb2xSb3V0ZXIgfSBmcm9tICcuLi90b29sLXJvdXRlcic7XG5pbXBvcnQgdHlwZSB7IE1DUFRvb2wsIE1DUFRvb2xSZXN1bHQgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBNQ1BfTkFNRVNQQUNFX1NFUEFSQVRPUiB9IGZyb20gJy4uL3R5cGVzJztcblxuZGVzY3JpYmUoJ1Rvb2xSb3V0ZXInLCAoKSA9PiB7XG4gICAgbGV0IHJvdXRlcjogVG9vbFJvdXRlcjtcblxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICByb3V0ZXIgPSBuZXcgVG9vbFJvdXRlcigpO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2dldEFsbFRvb2xzJywgKCkgPT4ge1xuICAgICAgICBpdCgnc2hvdWxkIGluY2x1ZGUgYnVpbHQtaW4gdG9vbHMnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b29scyA9IHJvdXRlci5nZXRBbGxUb29scygpO1xuICAgICAgICAgICAgZXhwZWN0KHRvb2xzLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuXG4gICAgICAgICAgICAvLyDwn5SSIOuztOyViCDtjKjsuZggMjAyNi0wMi0wNzogcnVuX2NvbW1hbmQg7KCc6rGw65CoIOKAlCB2aXNpb25fb2Ny6rCAIOuCqOyVhOyeiOyWtOyVvCDtlahcbiAgICAgICAgICAgIGNvbnN0IHZpc2lvbk9jciA9IHRvb2xzLmZpbmQodCA9PiB0Lm5hbWUgPT09ICd2aXNpb25fb2NyJyk7XG4gICAgICAgICAgICBleHBlY3QodmlzaW9uT2NyKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICAgICAgLy8gcnVuX2NvbW1hbmTripQg67O07JWI7IOBIOygnOqxsOuQmOyWtCDsobTsnqztlZjsp4Ag7JWK7JWE7JW8IO2VqFxuICAgICAgICAgICAgY29uc3QgcnVuQ29tbWFuZCA9IHRvb2xzLmZpbmQodCA9PiB0Lm5hbWUgPT09ICdydW5fY29tbWFuZCcpO1xuICAgICAgICAgICAgZXhwZWN0KHJ1bkNvbW1hbmQpLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBpbmNsdWRlIGV4dGVybmFsIHRvb2xzIGFmdGVyIHJlZ2lzdHJhdGlvbicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1vY2tUb29sOiBNQ1BUb29sID0ge1xuICAgICAgICAgICAgICAgIG5hbWU6ICdsaXN0X3RhYmxlcycsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdMaXN0IGRhdGFiYXNlIHRhYmxlcycsXG4gICAgICAgICAgICAgICAgaW5wdXRTY2hlbWE6IHsgdHlwZTogJ29iamVjdCcsIHByb3BlcnRpZXM6IHt9LCByZXF1aXJlZDogW10gfVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgY29uc3QgbW9ja0V4ZWN1dG9yID0gYXN5bmMgKF9uYW1lOiBzdHJpbmcsIF9hcmdzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPik6IFByb21pc2U8TUNQVG9vbFJlc3VsdD4gPT4gKHtcbiAgICAgICAgICAgICAgICBjb250ZW50OiBbeyB0eXBlOiAndGV4dCcsIHRleHQ6ICdvaycgfV1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByb3V0ZXIucmVnaXN0ZXJFeHRlcm5hbFRvb2xzKCdzZXJ2ZXIxJywgJ3Bvc3RncmVzJywgW21vY2tUb29sXSwgbW9ja0V4ZWN1dG9yKTtcblxuICAgICAgICAgICAgY29uc3QgdG9vbHMgPSByb3V0ZXIuZ2V0QWxsVG9vbHMoKTtcbiAgICAgICAgICAgIGNvbnN0IGV4dGVybmFsID0gdG9vbHMuZmluZCh0ID0+IHQubmFtZSA9PT0gYHBvc3RncmVzJHtNQ1BfTkFNRVNQQUNFX1NFUEFSQVRPUn1saXN0X3RhYmxlc2ApO1xuICAgICAgICAgICAgZXhwZWN0KGV4dGVybmFsKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICAgICAgZXhwZWN0KGV4dGVybmFsIS5kZXNjcmlwdGlvbikudG9CZSgnTGlzdCBkYXRhYmFzZSB0YWJsZXMnKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZ2V0VG9vbHNGb3JUaWVyJywgKCkgPT4ge1xuICAgICAgICBpdCgnc2hvdWxkIGZpbHRlciB0b29scyBmb3IgZnJlZSB0aWVyJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdG9vbHMgPSByb3V0ZXIuZ2V0VG9vbHNGb3JUaWVyKCdmcmVlJyk7XG4gICAgICAgICAgICAvLyBmcmVlIHRpZXIgaGFzIHdlYl9zZWFyY2gsIHZpc2lvbl9vY3IsIGFuYWx5emVfaW1hZ2VcbiAgICAgICAgICAgIGNvbnN0IG5hbWVzID0gdG9vbHMubWFwKHQgPT4gdC5uYW1lKTtcbiAgICAgICAgICAgIGV4cGVjdChuYW1lcykudG9Db250YWluKCd3ZWJfc2VhcmNoJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgZXhjbHVkZSBleHRlcm5hbCB0b29scyBmb3IgZnJlZSB0aWVyJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbW9ja1Rvb2w6IE1DUFRvb2wgPSB7XG4gICAgICAgICAgICAgICAgbmFtZTogJ3F1ZXJ5JyxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1J1biBTUUwnLFxuICAgICAgICAgICAgICAgIGlucHV0U2NoZW1hOiB7IHR5cGU6ICdvYmplY3QnLCBwcm9wZXJ0aWVzOiB7fSwgcmVxdWlyZWQ6IFtdIH1cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHJvdXRlci5yZWdpc3RlckV4dGVybmFsVG9vbHMoJ3MxJywgJ2RiJywgW21vY2tUb29sXSwgYXN5bmMgKCkgPT4gKHtcbiAgICAgICAgICAgICAgICBjb250ZW50OiBbeyB0eXBlOiAndGV4dCcsIHRleHQ6ICdvaycgfV1cbiAgICAgICAgICAgIH0pKTtcblxuICAgICAgICAgICAgY29uc3QgZnJlZVRvb2xzID0gcm91dGVyLmdldFRvb2xzRm9yVGllcignZnJlZScpO1xuICAgICAgICAgICAgY29uc3QgaGFzRXh0ZXJuYWwgPSBmcmVlVG9vbHMuc29tZSh0ID0+IHQubmFtZS5pbmNsdWRlcyhNQ1BfTkFNRVNQQUNFX1NFUEFSQVRPUikpO1xuICAgICAgICAgICAgZXhwZWN0KGhhc0V4dGVybmFsKS50b0JlKGZhbHNlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBpbmNsdWRlIGV4dGVybmFsIHRvb2xzIGZvciBlbnRlcnByaXNlIHRpZXInLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtb2NrVG9vbDogTUNQVG9vbCA9IHtcbiAgICAgICAgICAgICAgICBuYW1lOiAncXVlcnknLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnUnVuIFNRTCcsXG4gICAgICAgICAgICAgICAgaW5wdXRTY2hlbWE6IHsgdHlwZTogJ29iamVjdCcsIHByb3BlcnRpZXM6IHt9LCByZXF1aXJlZDogW10gfVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgcm91dGVyLnJlZ2lzdGVyRXh0ZXJuYWxUb29scygnczEnLCAnZGInLCBbbW9ja1Rvb2xdLCBhc3luYyAoKSA9PiAoe1xuICAgICAgICAgICAgICAgIGNvbnRlbnQ6IFt7IHR5cGU6ICd0ZXh0JywgdGV4dDogJ29rJyB9XVxuICAgICAgICAgICAgfSkpO1xuXG4gICAgICAgICAgICBjb25zdCBlbnRUb29scyA9IHJvdXRlci5nZXRUb29sc0ZvclRpZXIoJ2VudGVycHJpc2UnKTtcbiAgICAgICAgICAgIGNvbnN0IGV4dGVybmFsID0gZW50VG9vbHMuZmluZCh0ID0+IHQubmFtZSA9PT0gYGRiJHtNQ1BfTkFNRVNQQUNFX1NFUEFSQVRPUn1xdWVyeWApO1xuICAgICAgICAgICAgZXhwZWN0KGV4dGVybmFsKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdleGVjdXRlVG9vbCcsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIGEgYnVpbHQtaW4gdG9vbCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIC8vIHJ1bl9jb21tYW5kIGlzIGEgYnVpbHQtaW4gdG9vbFxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcm91dGVyLmV4ZWN1dGVUb29sKCdydW5fY29tbWFuZCcsIHsgY29tbWFuZDogJ2VjaG8gaGVsbG8nIH0pO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuY29udGVudCkudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuY29udGVudC5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIGFuIGV4dGVybmFsIHRvb2wnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtb2NrVG9vbDogTUNQVG9vbCA9IHtcbiAgICAgICAgICAgICAgICBuYW1lOiAncGluZycsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdQaW5nIHNlcnZpY2UnLFxuICAgICAgICAgICAgICAgIGlucHV0U2NoZW1hOiB7IHR5cGU6ICdvYmplY3QnLCBwcm9wZXJ0aWVzOiB7fSwgcmVxdWlyZWQ6IFtdIH1cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGNvbnN0IG1vY2tFeGVjdXRvciA9IGFzeW5jIChuYW1lOiBzdHJpbmcsIF9hcmdzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPik6IFByb21pc2U8TUNQVG9vbFJlc3VsdD4gPT4gKHtcbiAgICAgICAgICAgICAgICBjb250ZW50OiBbeyB0eXBlOiAndGV4dCcsIHRleHQ6IGBwb25nIGZyb20gJHtuYW1lfWAgfV1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByb3V0ZXIucmVnaXN0ZXJFeHRlcm5hbFRvb2xzKCdzcnYxJywgJ215c2VydmVyJywgW21vY2tUb29sXSwgbW9ja0V4ZWN1dG9yKTtcblxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcm91dGVyLmV4ZWN1dGVUb29sKGBteXNlcnZlciR7TUNQX05BTUVTUEFDRV9TRVBBUkFUT1J9cGluZ2AsIHt9KTtcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuaXNFcnJvcikudG9CZUZhbHN5KCk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmNvbnRlbnRbMF0udGV4dCkudG9CZSgncG9uZyBmcm9tIHBpbmcnKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gZXJyb3IgZm9yIHVua25vd24gdG9vbCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJvdXRlci5leGVjdXRlVG9vbCgnbm9uZXhpc3RlbnRfdG9vbCcsIHt9KTtcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuaXNFcnJvcikudG9CZSh0cnVlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gZXJyb3IgZm9yIHVua25vd24gZXh0ZXJuYWwgdG9vbCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJvdXRlci5leGVjdXRlVG9vbChgdW5rbm93biR7TUNQX05BTUVTUEFDRV9TRVBBUkFUT1J9dG9vbGAsIHt9KTtcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuaXNFcnJvcikudG9CZSh0cnVlKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgncmVnaXN0ZXJFeHRlcm5hbFRvb2xzIC8gdW5yZWdpc3RlckV4dGVybmFsVG9vbHMnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgcmVnaXN0ZXIgYW5kIGNvdW50IGV4dGVybmFsIHRvb2xzJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdG9vbHM6IE1DUFRvb2xbXSA9IFtcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdhJywgZGVzY3JpcHRpb246ICdBJywgaW5wdXRTY2hlbWE6IHsgdHlwZTogJ29iamVjdCcsIHByb3BlcnRpZXM6IHt9LCByZXF1aXJlZDogW10gfSB9LFxuICAgICAgICAgICAgICAgIHsgbmFtZTogJ2InLCBkZXNjcmlwdGlvbjogJ0InLCBpbnB1dFNjaGVtYTogeyB0eXBlOiAnb2JqZWN0JywgcHJvcGVydGllczoge30sIHJlcXVpcmVkOiBbXSB9IH0sXG4gICAgICAgICAgICBdO1xuXG4gICAgICAgICAgICByb3V0ZXIucmVnaXN0ZXJFeHRlcm5hbFRvb2xzKCdzMScsICdleHQnLCB0b29scywgYXN5bmMgKCkgPT4gKHtcbiAgICAgICAgICAgICAgICBjb250ZW50OiBbeyB0eXBlOiAndGV4dCcsIHRleHQ6ICdvaycgfV1cbiAgICAgICAgICAgIH0pKTtcblxuICAgICAgICAgICAgZXhwZWN0KHJvdXRlci5nZXRFeHRlcm5hbFRvb2xDb3VudCgpKS50b0JlKDIpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHVucmVnaXN0ZXIgdG9vbHMgYnkgc2VydmVySWQnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b29sczogTUNQVG9vbFtdID0gW1xuICAgICAgICAgICAgICAgIHsgbmFtZTogJ3gnLCBkZXNjcmlwdGlvbjogJ1gnLCBpbnB1dFNjaGVtYTogeyB0eXBlOiAnb2JqZWN0JywgcHJvcGVydGllczoge30sIHJlcXVpcmVkOiBbXSB9IH0sXG4gICAgICAgICAgICBdO1xuXG4gICAgICAgICAgICByb3V0ZXIucmVnaXN0ZXJFeHRlcm5hbFRvb2xzKCdzMScsICdleHQnLCB0b29scywgYXN5bmMgKCkgPT4gKHtcbiAgICAgICAgICAgICAgICBjb250ZW50OiBbeyB0eXBlOiAndGV4dCcsIHRleHQ6ICdvaycgfV1cbiAgICAgICAgICAgIH0pKTtcblxuICAgICAgICAgICAgZXhwZWN0KHJvdXRlci5nZXRFeHRlcm5hbFRvb2xDb3VudCgpKS50b0JlKDEpO1xuXG4gICAgICAgICAgICByb3V0ZXIudW5yZWdpc3RlckV4dGVybmFsVG9vbHMoJ3MxJyk7XG4gICAgICAgICAgICBleHBlY3Qocm91dGVyLmdldEV4dGVybmFsVG9vbENvdW50KCkpLnRvQmUoMCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmVwbGFjZSB0b29scyBvbiByZS1yZWdpc3RyYXRpb24nLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBleGVjdXRvciA9IGFzeW5jICgpOiBQcm9taXNlPE1DUFRvb2xSZXN1bHQ+ID0+ICh7XG4gICAgICAgICAgICAgICAgY29udGVudDogW3sgdHlwZTogJ3RleHQnLCB0ZXh0OiAnb2snIH1dXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcm91dGVyLnJlZ2lzdGVyRXh0ZXJuYWxUb29scygnczEnLCAnZXh0JywgW1xuICAgICAgICAgICAgICAgIHsgbmFtZTogJ2EnLCBkZXNjcmlwdGlvbjogJ0EnLCBpbnB1dFNjaGVtYTogeyB0eXBlOiAnb2JqZWN0JywgcHJvcGVydGllczoge30sIHJlcXVpcmVkOiBbXSB9IH0sXG4gICAgICAgICAgICAgICAgeyBuYW1lOiAnYicsIGRlc2NyaXB0aW9uOiAnQicsIGlucHV0U2NoZW1hOiB7IHR5cGU6ICdvYmplY3QnLCBwcm9wZXJ0aWVzOiB7fSwgcmVxdWlyZWQ6IFtdIH0gfSxcbiAgICAgICAgICAgIF0sIGV4ZWN1dG9yKTtcblxuICAgICAgICAgICAgZXhwZWN0KHJvdXRlci5nZXRFeHRlcm5hbFRvb2xDb3VudCgpKS50b0JlKDIpO1xuXG4gICAgICAgICAgICAvLyBSZS1yZWdpc3RlciB3aXRoIGRpZmZlcmVudCB0b29sc1xuICAgICAgICAgICAgcm91dGVyLnJlZ2lzdGVyRXh0ZXJuYWxUb29scygnczEnLCAnZXh0JywgW1xuICAgICAgICAgICAgICAgIHsgbmFtZTogJ2MnLCBkZXNjcmlwdGlvbjogJ0MnLCBpbnB1dFNjaGVtYTogeyB0eXBlOiAnb2JqZWN0JywgcHJvcGVydGllczoge30sIHJlcXVpcmVkOiBbXSB9IH0sXG4gICAgICAgICAgICBdLCBleGVjdXRvcik7XG5cbiAgICAgICAgICAgIGV4cGVjdChyb3V0ZXIuZ2V0RXh0ZXJuYWxUb29sQ291bnQoKSkudG9CZSgxKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZ2V0T2xsYW1hVG9vbHMnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIE9sbGFtYS1jb21wYXRpYmxlIGZvcm1hdCcsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRvb2xzID0gcm91dGVyLmdldE9sbGFtYVRvb2xzKCdlbnRlcnByaXNlJyk7XG4gICAgICAgICAgICBleHBlY3QodG9vbHMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGZpcnN0ID0gdG9vbHNbMF07XG4gICAgICAgICAgICBleHBlY3QoZmlyc3QudHlwZSkudG9CZSgnZnVuY3Rpb24nKTtcbiAgICAgICAgICAgIGV4cGVjdChmaXJzdC5mdW5jdGlvbikudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdChmaXJzdC5mdW5jdGlvbi5uYW1lKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICAgICAgZXhwZWN0KGZpcnN0LmZ1bmN0aW9uLmRlc2NyaXB0aW9uKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICAgICAgZXhwZWN0KGZpcnN0LmZ1bmN0aW9uLnBhcmFtZXRlcnMpLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2lzRXh0ZXJuYWxUb29sJywgKCkgPT4ge1xuICAgICAgICBpdCgnc2hvdWxkIGlkZW50aWZ5IGV4dGVybmFsIHRvb2xzIGJ5IG5hbWVzcGFjZSBzZXBhcmF0b3InLCAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3Qocm91dGVyLmlzRXh0ZXJuYWxUb29sKGBzZXJ2ZXIke01DUF9OQU1FU1BBQ0VfU0VQQVJBVE9SfXRvb2xgKSkudG9CZSh0cnVlKTtcbiAgICAgICAgICAgIGV4cGVjdChyb3V0ZXIuaXNFeHRlcm5hbFRvb2woJ3J1bl9jb21tYW5kJykpLnRvQmUoZmFsc2UpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9