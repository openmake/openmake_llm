{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/data/models/token-blacklist.ts","mappings":";AAAA;;;GAGG;;;;;;AAqFH,8CAKC;AAED,kDAKC;AA/FD,oEAAsC;AACtC,gDAAwB;AAYxB;;GAEG;AACH,MAAa,oBAAoB;IAI7B,YAAY,MAAe;QAFnB,oBAAe,GAA0B,IAAI,CAAC;QAGlD,MAAM,MAAM,GAAG,MAAM,IAAI,cAAI,CAAC,IAAI,CAAC,SAAS,EAAE,6BAA6B,CAAC,CAAC;QAC7E,IAAI,CAAC,EAAE,GAAG,IAAI,wBAAQ,CAAC,MAAM,CAAC,CAAC;QAC/B,IAAI,CAAC,SAAS,EAAE,CAAC;QACjB,IAAI,CAAC,qBAAqB,EAAE,CAAC;IACjC,CAAC;IAEO,SAAS;QACb,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC;;;;;;SAMZ,CAAC,CAAC;QACH,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,iFAAiF,CAAC,CAAC;QAChG,OAAO,CAAC,GAAG,CAAC,qCAAqC,CAAC,CAAC;IACvD,CAAC;IAED,GAAG,CAAC,GAAW,EAAE,SAAiB;QAC9B,MAAM,IAAI,GAAG,IAAI,CAAC,EAAE,CAAC,OAAO,CAAC,wEAAwE,CAAC,CAAC;QACvG,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,SAAS,CAAC,CAAC;IAC7B,CAAC;IAED,GAAG,CAAC,GAAW;QACX,MAAM,IAAI,GAAG,IAAI,CAAC,EAAE,CAAC,OAAO,CAAC,gEAAgE,CAAC,CAAC;QAC/F,MAAM,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC;QACzC,OAAO,MAAM,KAAK,SAAS,CAAC;IAChC,CAAC;IAED,OAAO;QACH,MAAM,IAAI,GAAG,IAAI,CAAC,EAAE,CAAC,OAAO,CAAC,kDAAkD,CAAC,CAAC;QACjF,MAAM,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC;QACpC,OAAO,MAAM,CAAC,OAAO,CAAC;IAC1B,CAAC;IAED,QAAQ;QACJ,MAAM,IAAI,GAAG,IAAI,CAAC,EAAE,CAAC,OAAO,CAAC,oEAAoE,CAAC,CAAC;QACnG,MAAM,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,EAAE,CAAsB,CAAC;QACzD,OAAO,EAAE,KAAK,EAAE,MAAM,CAAC,KAAK,EAAE,CAAC;IACnC,CAAC;IAEO,qBAAqB;QACzB,sBAAsB;QACtB,IAAI,CAAC,eAAe,GAAG,WAAW,CAAC,GAAG,EAAE;YACpC,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,EAAE,CAAC;YAC/B,IAAI,OAAO,GAAG,CAAC,EAAE,CAAC;gBACd,OAAO,CAAC,GAAG,CAAC,uBAAuB,OAAO,cAAc,CAAC,CAAC;YAC9D,CAAC;QACL,CAAC,EAAE,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC;IACvB,CAAC;IAED,OAAO;QACH,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;YACvB,aAAa,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;QACxC,CAAC;QACD,IAAI,CAAC,EAAE,CAAC,KAAK,EAAE,CAAC;IACpB,CAAC;CACJ;AA9DD,oDA8DC;AAED,qBAAqB;AACrB,IAAI,QAAQ,GAA2B,IAAI,CAAC;AAE5C,SAAgB,iBAAiB;IAC7B,IAAI,CAAC,QAAQ,EAAE,CAAC;QACZ,QAAQ,GAAG,IAAI,oBAAoB,EAAE,CAAC;IAC1C,CAAC;IACD,OAAO,QAAQ,CAAC;AACpB,CAAC;AAED,SAAgB,mBAAmB;IAC/B,IAAI,QAAQ,IAAI,QAAQ,YAAY,oBAAoB,EAAE,CAAC;QACtD,QAAiC,CAAC,OAAO,EAAE,CAAC;IACjD,CAAC;IACD,QAAQ,GAAG,IAAI,CAAC;AACpB,CAAC","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/data/models/token-blacklist.ts"],"sourcesContent":["/**\n * Token Blacklist - SQLite-backed implementation\n * Pluggable interface allows future Redis migration\n */\n\nimport Database from 'better-sqlite3';\nimport path from 'path';\n\n/**\n * Pluggable Token Blacklist Interface\n */\nexport interface ITokenBlacklist {\n    add(jti: string, expiresAt: number): void;\n    has(jti: string): boolean;\n    cleanup(): number;\n    getStats(): { count: number };\n}\n\n/**\n * SQLite-backed Token Blacklist Implementation\n */\nexport class SQLiteTokenBlacklist implements ITokenBlacklist {\n    private db: Database.Database;\n    private cleanupInterval: NodeJS.Timeout | null = null;\n    \n    constructor(dbPath?: string) {\n        const dbFile = dbPath || path.join(__dirname, '../../../../data/unified.db');\n        this.db = new Database(dbFile);\n        this.initTable();\n        this.startCleanupScheduler();\n    }\n    \n    private initTable(): void {\n        this.db.exec(`\n            CREATE TABLE IF NOT EXISTS token_blacklist (\n                jti TEXT PRIMARY KEY,\n                expires_at INTEGER NOT NULL,\n                created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)\n            )\n        `);\n        this.db.exec('CREATE INDEX IF NOT EXISTS idx_blacklist_expires ON token_blacklist(expires_at)');\n        console.log('[TokenBlacklist] ğŸ“‹ SQLite í…Œì´ë¸” ì´ˆê¸°í™”ë¨');\n    }\n    \n    add(jti: string, expiresAt: number): void {\n        const stmt = this.db.prepare('INSERT OR REPLACE INTO token_blacklist (jti, expires_at) VALUES (?, ?)');\n        stmt.run(jti, expiresAt);\n    }\n    \n    has(jti: string): boolean {\n        const stmt = this.db.prepare('SELECT 1 FROM token_blacklist WHERE jti = ? AND expires_at > ?');\n        const result = stmt.get(jti, Date.now());\n        return result !== undefined;\n    }\n    \n    cleanup(): number {\n        const stmt = this.db.prepare('DELETE FROM token_blacklist WHERE expires_at < ?');\n        const result = stmt.run(Date.now());\n        return result.changes;\n    }\n    \n    getStats(): { count: number } {\n        const stmt = this.db.prepare('SELECT COUNT(*) as count FROM token_blacklist WHERE expires_at > ?');\n        const result = stmt.get(Date.now()) as { count: number };\n        return { count: result.count };\n    }\n    \n    private startCleanupScheduler(): void {\n        // Clean up every hour\n        this.cleanupInterval = setInterval(() => {\n            const cleaned = this.cleanup();\n            if (cleaned > 0) {\n                console.log(`[TokenBlacklist] ğŸ§¹ ${cleaned}ê°œ ë§Œë£Œëœ í† í° ì •ë¦¬ë¨`);\n            }\n        }, 60 * 60 * 1000);\n    }\n    \n    destroy(): void {\n        if (this.cleanupInterval) {\n            clearInterval(this.cleanupInterval);\n        }\n        this.db.close();\n    }\n}\n\n// Singleton instance\nlet instance: ITokenBlacklist | null = null;\n\nexport function getTokenBlacklist(): ITokenBlacklist {\n    if (!instance) {\n        instance = new SQLiteTokenBlacklist();\n    }\n    return instance;\n}\n\nexport function resetTokenBlacklist(): void {\n    if (instance && instance instanceof SQLiteTokenBlacklist) {\n        (instance as SQLiteTokenBlacklist).destroy();\n    }\n    instance = null;\n}\n"],"version":3}