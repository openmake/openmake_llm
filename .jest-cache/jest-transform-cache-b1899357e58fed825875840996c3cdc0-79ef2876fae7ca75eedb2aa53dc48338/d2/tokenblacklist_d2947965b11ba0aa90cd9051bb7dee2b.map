{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/data/models/token-blacklist.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/data/models/token-blacklist.ts"],"sourcesContent":["/**\n * Token Blacklist - PostgreSQL-backed implementation\n * Pluggable interface allows future migration\n */\n\nimport { Pool } from 'pg';\nimport { getConfig } from '../../config/env';\n\n/**\n * Pluggable Token Blacklist Interface\n */\nexport interface ITokenBlacklist {\n    add(jti: string, expiresAt: number): Promise<void>;\n    has(jti: string): Promise<boolean>;\n    cleanup(): Promise<number>;\n    getStats(): Promise<{ count: number }>;\n}\n\n/**\n * PostgreSQL-backed Token Blacklist Implementation\n */\nexport class PostgresTokenBlacklist implements ITokenBlacklist {\n    private pool: Pool;\n    private cleanupInterval: NodeJS.Timeout | null = null;\n    private initialized = false;\n    \n    constructor() {\n        this.pool = new Pool({\n            connectionString: getConfig().databaseUrl\n        });\n        this.startCleanupScheduler();\n    }\n    \n    private async ensureTable(): Promise<void> {\n        if (this.initialized) return;\n        await this.pool.query(`\n            CREATE TABLE IF NOT EXISTS token_blacklist (\n                jti TEXT PRIMARY KEY,\n                expires_at BIGINT NOT NULL,\n                created_at BIGINT DEFAULT (EXTRACT(EPOCH FROM NOW()) * 1000)\n            )\n        `);\n        await this.pool.query('CREATE INDEX IF NOT EXISTS idx_blacklist_expires ON token_blacklist(expires_at)');\n        this.initialized = true;\n        console.log('[TokenBlacklist] üìã PostgreSQL ÌÖåÏù¥Î∏î Ï¥àÍ∏∞ÌôîÎê®');\n    }\n    \n    async add(jti: string, expiresAt: number): Promise<void> {\n        await this.ensureTable();\n        await this.pool.query(\n            'INSERT INTO token_blacklist (jti, expires_at) VALUES ($1, $2) ON CONFLICT (jti) DO UPDATE SET expires_at = $2',\n            [jti, expiresAt]\n        );\n    }\n    \n    async has(jti: string): Promise<boolean> {\n        await this.ensureTable();\n        const result = await this.pool.query(\n            'SELECT 1 FROM token_blacklist WHERE jti = $1 AND expires_at > $2',\n            [jti, Date.now()]\n        );\n        return result.rows.length > 0;\n    }\n    \n    async cleanup(): Promise<number> {\n        await this.ensureTable();\n        const result = await this.pool.query(\n            'DELETE FROM token_blacklist WHERE expires_at < $1',\n            [Date.now()]\n        );\n        return result.rowCount || 0;\n    }\n    \n    async getStats(): Promise<{ count: number }> {\n        await this.ensureTable();\n        const result = await this.pool.query(\n            'SELECT COUNT(*) as count FROM token_blacklist WHERE expires_at > $1',\n            [Date.now()]\n        );\n        return { count: parseInt(result.rows[0].count, 10) };\n    }\n    \n    private startCleanupScheduler(): void {\n        this.cleanupInterval = setInterval(async () => {\n            try {\n                const cleaned = await this.cleanup();\n                if (cleaned > 0) {\n                    console.log(`[TokenBlacklist] üßπ ${cleaned}Í∞ú ÎßåÎ£åÎêú ÌÜ†ÌÅ∞ Ï†ïÎ¶¨Îê®`);\n                }\n            } catch (err) {\n                console.error('[TokenBlacklist] Cleanup error:', err);\n            }\n        }, 60 * 60 * 1000);\n    }\n    \n    async destroy(): Promise<void> {\n        if (this.cleanupInterval) {\n            clearInterval(this.cleanupInterval);\n        }\n        await this.pool.end();\n    }\n}\n\n// Singleton instance\nlet instance: ITokenBlacklist | null = null;\n\nexport function getTokenBlacklist(): ITokenBlacklist {\n    if (!instance) {\n        instance = new PostgresTokenBlacklist();\n    }\n    return instance;\n}\n\nexport function resetTokenBlacklist(): void {\n    if (instance && instance instanceof PostgresTokenBlacklist) {\n        (instance as PostgresTokenBlacklist).destroy();\n    }\n    instance = null;\n}\n"],"version":3}