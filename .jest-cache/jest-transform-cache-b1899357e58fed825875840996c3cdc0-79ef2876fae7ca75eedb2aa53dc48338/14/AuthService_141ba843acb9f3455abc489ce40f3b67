54cf15e2aa6da080b557851d901b39ce
"use strict";
/**
 * ============================================================
 * Auth Service
 * ============================================================
 * 인증 관련 비즈니스 로직
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthService = void 0;
exports.getAuthService = getAuthService;
const user_manager_1 = require("../data/user-manager");
const auth_1 = require("../auth");
const logger_1 = require("../utils/logger");
const env_1 = require("../config/env");
const log = (0, logger_1.createLogger)('AuthService');
/**
 * Validate password complexity requirements
 * - Minimum 8 characters
 * - At least one uppercase letter
 * - At least one lowercase letter
 * - At least one number
 * - At least one special character
 */
function validatePasswordComplexity(password) {
    const errors = [];
    if (password.length < 8) {
        errors.push('비밀번호는 8자 이상이어야 합니다');
    }
    if (!/[A-Z]/.test(password)) {
        errors.push('대문자를 1개 이상 포함해야 합니다');
    }
    if (!/[a-z]/.test(password)) {
        errors.push('소문자를 1개 이상 포함해야 합니다');
    }
    if (!/[0-9]/.test(password)) {
        errors.push('숫자를 1개 이상 포함해야 합니다');
    }
    if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
        errors.push('특수문자를 1개 이상 포함해야 합니다');
    }
    return { valid: errors.length === 0, errors };
}
class AuthService {
    constructor() {
        this.userManager = (0, user_manager_1.getUserManager)();
    }
    /**
     * 회원가입
     */
    register(data) {
        return __awaiter(this, void 0, void 0, function* () {
            const { email, password, role } = data;
            // 유효성 검사
            if (!email || !password) {
                return { success: false, error: '이메일과 비밀번호를 입력하세요' };
            }
            const passwordValidation = validatePasswordComplexity(password);
            if (!passwordValidation.valid) {
                return { success: false, error: passwordValidation.errors.join(', ') };
            }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return { success: false, error: '유효한 이메일 주소를 입력하세요' };
            }
            const user = yield this.userManager.createUser({ email, password, role });
            if (!user) {
                return { success: false, error: '이미 등록된 이메일입니다' };
            }
            log.info(`회원가입 완료: ${email}`);
            return { success: true, user };
        });
    }
    /**
     * 로그인
     */
    login(data) {
        return __awaiter(this, void 0, void 0, function* () {
            const { email, password } = data;
            if (!email || !password) {
                return { success: false, error: '이메일과 비밀번호를 입력하세요' };
            }
            const user = yield this.userManager.authenticate(email, password);
            if (!user) {
                return { success: false, error: '이메일 또는 비밀번호가 올바르지 않습니다' };
            }
            const token = (0, auth_1.generateToken)(user);
            log.info(`로그인 성공: ${email}`);
            return { success: true, token, user };
        });
    }
    /**
     * 비밀번호 변경
     */
    changePassword(data) {
        return __awaiter(this, void 0, void 0, function* () {
            const { userId, currentEmail, currentPassword, newPassword } = data;
            if (!currentPassword || !newPassword) {
                return { success: false, error: '현재 비밀번호와 새 비밀번호를 입력하세요' };
            }
            const passwordValidation = validatePasswordComplexity(newPassword);
            if (!passwordValidation.valid) {
                return { success: false, error: passwordValidation.errors.join(', ') };
            }
            // 현재 비밀번호 확인
            const user = yield this.userManager.authenticate(currentEmail, currentPassword);
            if (!user) {
                return { success: false, error: '현재 비밀번호가 올바르지 않습니다' };
            }
            const success = yield this.userManager.changePassword(userId, newPassword);
            return { success };
        });
    }
    /**
     * OAuth 사용자 생성 또는 반환
     */
    findOrCreateOAuthUser(email, provider) {
        return __awaiter(this, void 0, void 0, function* () {
            let user = yield this.userManager.getUserByEmail(email);
            let publicUser = user ? yield this.userManager.getUserById(user.id) : null;
            if (!publicUser) {
                // OAuth 사용자는 랜덤 비밀번호로 생성
                const randomPassword = Math.random().toString(36).substring(2, 15);
                // 관리자 이메일 목록 확인
                const adminEmails = (0, env_1.getConfig)().adminEmails
                    .split(',')
                    .map(e => e.toLowerCase().trim())
                    .filter(e => e);
                const role = adminEmails.includes(email.toLowerCase()) ? 'admin' : 'user';
                publicUser = yield this.userManager.createUser({
                    email,
                    password: randomPassword,
                    role
                });
                if (!publicUser) {
                    return { success: false, error: '사용자 생성 실패' };
                }
                log.info(`[OAuth] ${provider} 신규 사용자 생성: ${email}`);
            }
            else {
                // 기존 계정 관리자 승격 체크
                const adminEmails = (0, env_1.getConfig)().adminEmails
                    .split(',')
                    .map(e => e.toLowerCase().trim())
                    .filter(e => e);
                if (adminEmails.includes(email.toLowerCase()) && publicUser.role !== 'admin') {
                    yield this.userManager.changeRole(publicUser.id, 'admin');
                    publicUser.role = 'admin';
                }
            }
            const token = (0, auth_1.generateToken)(publicUser);
            log.info(`[OAuth] ${provider} 로그인 성공: ${email}`);
            return { success: true, token, user: publicUser };
        });
    }
    /**
     * 사용 가능한 OAuth 프로바이더 목록
     */
    getAvailableProviders() {
        const providers = [];
        const config = (0, env_1.getConfig)();
        if (config.googleClientId && config.googleClientSecret) {
            providers.push('google');
        }
        if (config.githubClientId && config.githubClientSecret) {
            providers.push('github');
        }
        return providers;
    }
}
exports.AuthService = AuthService;
// 싱글톤 인스턴스
let authService = null;
function getAuthService() {
    if (!authService) {
        authService = new AuthService();
    }
    return authService;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL3NlcnZpY2VzL0F1dGhTZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7Ozs7Ozs7Ozs7O0FBc05ILHdDQUtDO0FBek5ELHVEQUFrRTtBQUNsRSxrQ0FBd0M7QUFDeEMsNENBQStDO0FBQy9DLHVDQUEwQztBQUUxQyxNQUFNLEdBQUcsR0FBRyxJQUFBLHFCQUFZLEVBQUMsYUFBYSxDQUFDLENBQUM7QUEyQnhDOzs7Ozs7O0dBT0c7QUFDSCxTQUFTLDBCQUEwQixDQUFDLFFBQWdCO0lBQ2hELE1BQU0sTUFBTSxHQUFhLEVBQUUsQ0FBQztJQUU1QixJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDdEIsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1FBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztRQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUNELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7UUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFDRCxJQUFJLENBQUMsdUNBQXVDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7UUFDMUQsTUFBTSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxF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V0FBVyxDQUFDO0FBQ3ZCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL3NlcnZpY2VzL0F1dGhTZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gKiBBdXRoIFNlcnZpY2VcbiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICog7J247KadIOq0gOugqCDruYTspojri4jsiqQg66Gc7KeBXG4gKi9cblxuaW1wb3J0IHsgZ2V0VXNlck1hbmFnZXIsIFB1YmxpY1VzZXIgfSBmcm9tICcuLi9kYXRhL3VzZXItbWFuYWdlcic7XG5pbXBvcnQgeyBnZW5lcmF0ZVRva2VuIH0gZnJvbSAnLi4vYXV0aCc7XG5pbXBvcnQgeyBjcmVhdGVMb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuaW1wb3J0IHsgZ2V0Q29uZmlnIH0gZnJvbSAnLi4vY29uZmlnL2Vudic7XG5cbmNvbnN0IGxvZyA9IGNyZWF0ZUxvZ2dlcignQXV0aFNlcnZpY2UnKTtcblxuZXhwb3J0IGludGVyZmFjZSBSZWdpc3RlclJlcXVlc3Qge1xuICAgIGVtYWlsOiBzdHJpbmc7XG4gICAgcGFzc3dvcmQ6IHN0cmluZztcbiAgICByb2xlPzogJ2FkbWluJyB8ICd1c2VyJyB8ICdndWVzdCc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTG9naW5SZXF1ZXN0IHtcbiAgICBlbWFpbDogc3RyaW5nO1xuICAgIHBhc3N3b3JkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2hhbmdlUGFzc3dvcmRSZXF1ZXN0IHtcbiAgICB1c2VySWQ6IG51bWJlcjtcbiAgICBjdXJyZW50RW1haWw6IHN0cmluZztcbiAgICBjdXJyZW50UGFzc3dvcmQ6IHN0cmluZztcbiAgICBuZXdQYXNzd29yZDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhSZXN1bHQge1xuICAgIHN1Y2Nlc3M6IGJvb2xlYW47XG4gICAgZXJyb3I/OiBzdHJpbmc7XG4gICAgdXNlcj86IFB1YmxpY1VzZXI7XG4gICAgdG9rZW4/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogVmFsaWRhdGUgcGFzc3dvcmQgY29tcGxleGl0eSByZXF1aXJlbWVudHNcbiAqIC0gTWluaW11bSA4IGNoYXJhY3RlcnNcbiAqIC0gQXQgbGVhc3Qgb25lIHVwcGVyY2FzZSBsZXR0ZXJcbiAqIC0gQXQgbGVhc3Qgb25lIGxvd2VyY2FzZSBsZXR0ZXIgIFxuICogLSBBdCBsZWFzdCBvbmUgbnVtYmVyXG4gKiAtIEF0IGxlYXN0IG9uZSBzcGVjaWFsIGNoYXJhY3RlclxuICovXG5mdW5jdGlvbiB2YWxpZGF0ZVBhc3N3b3JkQ29tcGxleGl0eShwYXNzd29yZDogc3RyaW5nKTogeyB2YWxpZDogYm9vbGVhbjsgZXJyb3JzOiBzdHJpbmdbXSB9IHtcbiAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG4gICAgXG4gICAgaWYgKHBhc3N3b3JkLmxlbmd0aCA8IDgpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ+u5hOuwgOuyiO2YuOuKlCA47J6QIOydtOyDgeydtOyWtOyVvCDtlanri4jri6QnKTtcbiAgICB9XG4gICAgaWYgKCEvW0EtWl0vLnRlc3QocGFzc3dvcmQpKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCfrjIDrrLjsnpDrpbwgMeqwnCDsnbTsg4Eg7Y+s7ZWo7ZW07JW8IO2VqeuLiOuLpCcpO1xuICAgIH1cbiAgICBpZiAoIS9bYS16XS8udGVzdChwYXNzd29yZCkpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ+yGjOusuOyekOulvCAx6rCcIOydtOyDgSDtj6ztlajtlbTslbwg7ZWp64uI64ukJyk7XG4gICAgfVxuICAgIGlmICghL1swLTldLy50ZXN0KHBhc3N3b3JkKSkge1xuICAgICAgICBlcnJvcnMucHVzaCgn7Iir7J6Q66W8IDHqsJwg7J207IOBIO2PrO2VqO2VtOyVvCDtlanri4jri6QnKTtcbiAgICB9XG4gICAgaWYgKCEvWyFAIyQlXiYqKClfK1xcLT1cXFtcXF17fTsnOlwiXFxcXHwsLjw+XFwvP10vLnRlc3QocGFzc3dvcmQpKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCftirnsiJjrrLjsnpDrpbwgMeqwnCDsnbTsg4Eg7Y+s7ZWo7ZW07JW8IO2VqeuLiOuLpCcpO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4geyB2YWxpZDogZXJyb3JzLmxlbmd0aCA9PT0gMCwgZXJyb3JzIH07XG59XG5cbmV4cG9ydCBjbGFzcyBBdXRoU2VydmljZSB7XG4gICAgcHJpdmF0ZSB1c2VyTWFuYWdlciA9IGdldFVzZXJNYW5hZ2VyKCk7XG5cbiAgICAvKipcbiAgICAgKiDtmozsm5DqsIDsnoVcbiAgICAgKi9cbiAgICBhc3luYyByZWdpc3RlcihkYXRhOiBSZWdpc3RlclJlcXVlc3QpOiBQcm9taXNlPEF1dGhSZXN1bHQ+IHtcbiAgICAgICAgY29uc3QgeyBlbWFpbCwgcGFzc3dvcmQsIHJvbGUgfSA9IGRhdGE7XG5cbiAgICAgICAgLy8g7Jyg7Zqo7ISxIOqygOyCrFxuICAgICAgICBpZiAoIWVtYWlsIHx8ICFwYXNzd29yZCkge1xuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAn7J2066mU7J286rO8IOu5hOuwgOuyiO2YuOulvCDsnoXroKXtlZjshLjsmpQnIH07XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwYXNzd29yZFZhbGlkYXRpb24gPSB2YWxpZGF0ZVBhc3N3b3JkQ29tcGxleGl0eShwYXNzd29yZCk7XG4gICAgICAgIGlmICghcGFzc3dvcmRWYWxpZGF0aW9uLnZhbGlkKSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IHBhc3N3b3JkVmFsaWRhdGlvbi5lcnJvcnMuam9pbignLCAnKSB9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZW1haWxSZWdleCA9IC9eW15cXHNAXStAW15cXHNAXStcXC5bXlxcc0BdKyQvO1xuICAgICAgICBpZiAoIWVtYWlsUmVnZXgudGVzdChlbWFpbCkpIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ+ycoO2aqO2VnCDsnbTrqZTsnbwg7KO87IaM66W8IOyeheugpe2VmOyEuOyalCcgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNYW5hZ2VyLmNyZWF0ZVVzZXIoeyBlbWFpbCwgcGFzc3dvcmQsIHJvbGUgfSk7XG5cbiAgICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICfsnbTrr7gg65Ox66Gd65CcIOydtOuplOydvOyeheuLiOuLpCcgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxvZy5pbmZvKGDtmozsm5DqsIDsnoUg7JmE66OMOiAke2VtYWlsfWApO1xuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCB1c2VyIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog66Gc6re47J24XG4gICAgICovXG4gICAgYXN5bmMgbG9naW4oZGF0YTogTG9naW5SZXF1ZXN0KTogUHJvbWlzZTxBdXRoUmVzdWx0PiB7XG4gICAgICAgIGNvbnN0IHsgZW1haWwsIHBhc3N3b3JkIH0gPSBkYXRhO1xuXG4gICAgICAgIGlmICghZW1haWwgfHwgIXBhc3N3b3JkKSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICfsnbTrqZTsnbzqs7wg67mE67CA67KI7Zi466W8IOyeheugpe2VmOyEuOyalCcgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNYW5hZ2VyLmF1dGhlbnRpY2F0ZShlbWFpbCwgcGFzc3dvcmQpO1xuXG4gICAgICAgIGlmICghdXNlcikge1xuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAn7J2066mU7J28IOuYkOuKlCDruYTrsIDrsojtmLjqsIAg7Jis67CU66W07KeAIOyViuyKteuLiOuLpCcgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVUb2tlbih1c2VyKTtcbiAgICAgICAgbG9nLmluZm8oYOuhnOq3uOyduCDshLHqs7U6ICR7ZW1haWx9YCk7XG5cbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgdG9rZW4sIHVzZXIgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDruYTrsIDrsojtmLgg67OA6rK9XG4gICAgICovXG4gICAgYXN5bmMgY2hhbmdlUGFzc3dvcmQoZGF0YTogQ2hhbmdlUGFzc3dvcmRSZXF1ZXN0KTogUHJvbWlzZTxBdXRoUmVzdWx0PiB7XG4gICAgICAgIGNvbnN0IHsgdXNlcklkLCBjdXJyZW50RW1haWwsIGN1cnJlbnRQYXNzd29yZCwgbmV3UGFzc3dvcmQgfSA9IGRhdGE7XG5cbiAgICAgICAgaWYgKCFjdXJyZW50UGFzc3dvcmQgfHwgIW5ld1Bhc3N3b3JkKSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICftmITsnqwg67mE67CA67KI7Zi47JmAIOyDiCDruYTrsIDrsojtmLjrpbwg7J6F66Cl7ZWY7IS47JqUJyB9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcGFzc3dvcmRWYWxpZGF0aW9uID0gdmFsaWRhdGVQYXNzd29yZENvbXBsZXhpdHkobmV3UGFzc3dvcmQpO1xuICAgICAgICBpZiAoIXBhc3N3b3JkVmFsaWRhdGlvbi52YWxpZCkge1xuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBwYXNzd29yZFZhbGlkYXRpb24uZXJyb3JzLmpvaW4oJywgJykgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIO2YhOyerCDruYTrsIDrsojtmLgg7ZmV7J24XG4gICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNYW5hZ2VyLmF1dGhlbnRpY2F0ZShjdXJyZW50RW1haWwsIGN1cnJlbnRQYXNzd29yZCk7XG4gICAgICAgIGlmICghdXNlcikge1xuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAn7ZiE7J6sIOu5hOuwgOuyiO2YuOqwgCDsmKzrsJTrpbTsp4Ag7JWK7Iq164uI64ukJyB9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IHRoaXMudXNlck1hbmFnZXIuY2hhbmdlUGFzc3dvcmQodXNlcklkLCBuZXdQYXNzd29yZCk7XG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3MgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPQXV0aCDsgqzsmqnsnpAg7IOd7ISxIOuYkOuKlCDrsJjtmZhcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kT3JDcmVhdGVPQXV0aFVzZXIoZW1haWw6IHN0cmluZywgcHJvdmlkZXI6ICdnb29nbGUnIHwgJ2dpdGh1YicpOiBQcm9taXNlPEF1dGhSZXN1bHQ+IHtcbiAgICAgICAgbGV0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNYW5hZ2VyLmdldFVzZXJCeUVtYWlsKGVtYWlsKTtcbiAgICAgICAgbGV0IHB1YmxpY1VzZXIgPSB1c2VyID8gYXdhaXQgdGhpcy51c2VyTWFuYWdlci5nZXRVc2VyQnlJZCh1c2VyLmlkKSA6IG51bGw7XG5cbiAgICAgICAgaWYgKCFwdWJsaWNVc2VyKSB7XG4gICAgICAgICAgICAvLyBPQXV0aCDsgqzsmqnsnpDripQg656c642kIOu5hOuwgOuyiO2YuOuhnCDsg53shLFcbiAgICAgICAgICAgIGNvbnN0IHJhbmRvbVBhc3N3b3JkID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDE1KTtcblxuICAgICAgICAgICAgLy8g6rSA66as7J6QIOydtOuplOydvCDrqqnroZ0g7ZmV7J24XG4gICAgICAgICAgICBjb25zdCBhZG1pbkVtYWlscyA9IGdldENvbmZpZygpLmFkbWluRW1haWxzXG4gICAgICAgICAgICAgICAgLnNwbGl0KCcsJylcbiAgICAgICAgICAgICAgICAubWFwKGUgPT4gZS50b0xvd2VyQ2FzZSgpLnRyaW0oKSlcbiAgICAgICAgICAgICAgICAuZmlsdGVyKGUgPT4gZSk7XG4gICAgICAgICAgICBjb25zdCByb2xlID0gYWRtaW5FbWFpbHMuaW5jbHVkZXMoZW1haWwudG9Mb3dlckNhc2UoKSkgPyAnYWRtaW4nIDogJ3VzZXInO1xuXG4gICAgICAgICAgICBwdWJsaWNVc2VyID0gYXdhaXQgdGhpcy51c2VyTWFuYWdlci5jcmVhdGVVc2VyKHtcbiAgICAgICAgICAgICAgICBlbWFpbCxcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogcmFuZG9tUGFzc3dvcmQsXG4gICAgICAgICAgICAgICAgcm9sZVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmICghcHVibGljVXNlcikge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ+yCrOyaqeyekCDsg53shLEg7Iuk7YyoJyB9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsb2cuaW5mbyhgW09BdXRoXSAke3Byb3ZpZGVyfSDsi6Dqt5wg7IKs7Jqp7J6QIOyDneyEsTogJHtlbWFpbH1gKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIOq4sOyhtCDqs4TsoJUg6rSA66as7J6QIOyKueqyqSDssrTtgaxcbiAgICAgICAgICAgIGNvbnN0IGFkbWluRW1haWxzID0gZ2V0Q29uZmlnKCkuYWRtaW5FbWFpbHNcbiAgICAgICAgICAgICAgICAuc3BsaXQoJywnKVxuICAgICAgICAgICAgICAgIC5tYXAoZSA9PiBlLnRvTG93ZXJDYXNlKCkudHJpbSgpKVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoZSA9PiBlKTtcblxuICAgICAgICAgICAgaWYgKGFkbWluRW1haWxzLmluY2x1ZGVzKGVtYWlsLnRvTG93ZXJDYXNlKCkpICYmIHB1YmxpY1VzZXIucm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMudXNlck1hbmFnZXIuY2hhbmdlUm9sZShwdWJsaWNVc2VyLmlkLCAnYWRtaW4nKTtcbiAgICAgICAgICAgICAgICBwdWJsaWNVc2VyLnJvbGUgPSAnYWRtaW4nO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdG9rZW4gPSBnZW5lcmF0ZVRva2VuKHB1YmxpY1VzZXIpO1xuICAgICAgICBsb2cuaW5mbyhgW09BdXRoXSAke3Byb3ZpZGVyfSDroZzqt7jsnbgg7ISx6rO1OiAke2VtYWlsfWApO1xuXG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHRva2VuLCB1c2VyOiBwdWJsaWNVc2VyIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog7IKs7JqpIOqwgOuKpe2VnCBPQXV0aCDtlITroZzrsJTsnbTrjZQg66qp66GdXG4gICAgICovXG4gICAgZ2V0QXZhaWxhYmxlUHJvdmlkZXJzKCk6IHN0cmluZ1tdIHtcbiAgICAgICAgY29uc3QgcHJvdmlkZXJzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgICAgIGNvbnN0IGNvbmZpZyA9IGdldENvbmZpZygpO1xuICAgICAgICBpZiAoY29uZmlnLmdvb2dsZUNsaWVudElkICYmIGNvbmZpZy5nb29nbGVDbGllbnRTZWNyZXQpIHtcbiAgICAgICAgICAgIHByb3ZpZGVycy5wdXNoKCdnb29nbGUnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY29uZmlnLmdpdGh1YkNsaWVudElkICYmIGNvbmZpZy5naXRodWJDbGllbnRTZWNyZXQpIHtcbiAgICAgICAgICAgIHByb3ZpZGVycy5wdXNoKCdnaXRodWInKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwcm92aWRlcnM7XG4gICAgfVxufVxuXG4vLyDsi7HquIDthqQg7J247Iqk7YS07IqkXG5sZXQgYXV0aFNlcnZpY2U6IEF1dGhTZXJ2aWNlIHwgbnVsbCA9IG51bGw7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRBdXRoU2VydmljZSgpOiBBdXRoU2VydmljZSB7XG4gICAgaWYgKCFhdXRoU2VydmljZSkge1xuICAgICAgICBhdXRoU2VydmljZSA9IG5ldyBBdXRoU2VydmljZSgpO1xuICAgIH1cbiAgICByZXR1cm4gYXV0aFNlcnZpY2U7XG59XG4iXSwidmVyc2lvbiI6M30=