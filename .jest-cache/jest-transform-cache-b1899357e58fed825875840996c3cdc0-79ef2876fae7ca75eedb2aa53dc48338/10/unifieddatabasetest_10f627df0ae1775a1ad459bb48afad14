fe76ec1cd6be1b0e428d30ad711964dd
"use strict";
/**
 * #20 개선: UnifiedDatabase 기초 단위 테스트
 *
 * 메모리 내 SQLite로 실제 DB 로직을 테스트합니다.
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const unified_database_1 = require("../../../database/models/unified-database");
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const os = __importStar(require("os"));
describe('UnifiedDatabase', () => {
    let db;
    let tempDir;
    beforeEach(() => {
        // 임시 디렉토리에 테스트 DB 생성
        tempDir = fs.mkdtempSync(path.join(os.tmpdir(), 'openmake-test-'));
        db = new unified_database_1.UnifiedDatabase(tempDir);
    });
    afterEach(() => {
        try {
            db.close();
        }
        catch (e) {
            // already closed
        }
        // 임시 파일 정리
        fs.rmSync(tempDir, { recursive: true, force: true });
    });
    // ===== User CRUD =====
    describe('User Management', () => {
        it('should create and retrieve a user by username', () => {
            db.createUser('user-1', 'testuser', 'hashed123', 'test@example.com', 'user');
            const user = db.getUserByUsername('testuser');
            expect(user).toBeDefined();
            expect(user.id).toBe('user-1');
            expect(user.username).toBe('testuser');
            expect(user.email).toBe('test@example.com');
            expect(user.role).toBe('user');
        });
        it('should retrieve a user by id', () => {
            db.createUser('user-2', 'admin', 'hashed456', 'admin@test.com', 'admin');
            const user = db.getUserById('user-2');
            expect(user).toBeDefined();
            expect(user.username).toBe('admin');
            expect(user.role).toBe('admin');
        });
        it('should return undefined for non-existent user', () => {
            expect(db.getUserByUsername('nobody')).toBeUndefined();
            expect(db.getUserById('no-id')).toBeUndefined();
        });
        it('should update last login timestamp', () => {
            db.createUser('user-3', 'loginuser', 'hash', 'login@test.com');
            db.updateLastLogin('user-3');
            const user = db.getUserById('user-3');
            expect(user).toBeDefined();
            expect(user.last_login).toBeTruthy();
        });
        it('should list all users with optional limit', () => {
            db.createUser('u1', 'user1', 'h1');
            db.createUser('u2', 'user2', 'h2');
            db.createUser('u3', 'user3', 'h3');
            const all = db.getAllUsers();
            expect(all.length).toBe(3);
            const limited = db.getAllUsers(2);
            expect(limited.length).toBe(2);
        });
    });
    // ===== Conversation Sessions =====
    describe('Conversation Sessions', () => {
        beforeEach(() => {
            db.createUser('user-conv', 'convuser', 'hash', 'conv@test.com');
        });
        it('should create a session and add messages', () => {
            db.createSession('sess-1', 'user-conv', 'Test Chat');
            db.addMessage('sess-1', 'user', 'Hello');
            db.addMessage('sess-1', 'assistant', 'Hi there!', {
                model: 'test-model',
                tokens: 10,
                responseTimeMs: 200
            });
            const messages = db.getSessionMessages('sess-1');
            expect(messages.length).toBe(2);
            expect(messages[0].role).toBe('user');
            expect(messages[0].content).toBe('Hello');
            expect(messages[1].role).toBe('assistant');
            expect(messages[1].model).toBe('test-model');
        });
        it('should list user sessions', () => {
            db.createSession('s1', 'user-conv', 'Chat 1');
            db.createSession('s2', 'user-conv', 'Chat 2');
            const sessions = db.getUserSessions('user-conv');
            expect(sessions.length).toBe(2);
        });
        it('should delete a session and its messages', () => {
            db.createSession('del-sess', 'user-conv', 'Delete Me');
            db.addMessage('del-sess', 'user', 'Will be deleted');
            db.deleteSession('del-sess');
            const messages = db.getSessionMessages('del-sess');
            expect(messages.length).toBe(0);
        });
    });
    // ===== Memory System =====
    describe('Memory System', () => {
        beforeEach(() => {
            db.createUser('mem-user', 'memuser', 'hash');
        });
        it('should create and retrieve user memories', () => {
            db.createMemory({
                id: 'mem-1',
                userId: 'mem-user',
                category: 'preference',
                key: 'language',
                value: 'TypeScript',
                importance: 8
            });
            const memories = db.getUserMemories('mem-user');
            expect(memories.length).toBe(1);
            expect(memories[0].key).toBe('language');
            expect(memories[0].value).toBe('TypeScript');
            expect(memories[0].importance).toBe(8);
        });
        it('should filter memories by category', () => {
            db.createMemory({
                id: 'mem-a', userId: 'mem-user', category: 'preference',
                key: 'theme', value: 'dark'
            });
            db.createMemory({
                id: 'mem-b', userId: 'mem-user', category: 'fact',
                key: 'name', value: 'John'
            });
            const prefs = db.getUserMemories('mem-user', { category: 'preference' });
            expect(prefs.length).toBe(1);
            expect(prefs[0].category).toBe('preference');
        });
        it('should delete specific memory', () => {
            db.createMemory({
                id: 'del-mem', userId: 'mem-user', category: 'preference',
                key: 'test', value: 'delete me'
            });
            db.deleteMemory('del-mem');
            const memories = db.getUserMemories('mem-user');
            expect(memories.length).toBe(0);
        });
    });
    // ===== Stats =====
    describe('Database Stats', () => {
        it('should return stats object with table row counts', () => {
            const stats = db.getStats();
            expect(stats).toBeDefined();
            expect(typeof stats.total_rows).toBe('number');
            expect(typeof stats.tables).toBe('object');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vdGVzdHMvdW5pdC9fX3Rlc3RzX18vdW5pZmllZC1kYXRhYmFzZS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVILGdGQUE0RTtBQUM1RSx1Q0FBeUI7QUFDekIsMkNBQTZCO0FBQzdCLHVDQUF5QjtBQUV6QixRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQzdCLElBQUksRUFBbUIsQ0FBQztJQUN4QixJQUFJLE9BQWUsQ0FBQztJQUVwQixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ1oscUJBQXFCO1FBQ3JCLE9BQU8sR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FBQztRQUNuRSxFQUFFLEdBQUcsSUFBSSxrQ0FBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3RDLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNYLElBQUksQ0FBQztZQUNELEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNmLENBQUM7UUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ1QsaUJBQWlCO1FBQ3JCLENBQUM7UUFDRCxXQUFXO1FBQ1gsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3pELENBQUMsQ0FBQyxDQUFDO0lBRUgsd0JBQXdCO0lBQ3hCLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7UUFDN0IsRUFBRSxDQUFDLCtDQUErQyxFQUFFLEdBQUcsRUFBRTtZQUNyRCxFQUFFLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sQ0FB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QUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQy9DLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVm9sdW1lcy9NQUNfQVBQL29wZW5tYWtlX2xsbS90ZXN0cy91bml0L19fdGVzdHNfXy91bmlmaWVkLWRhdGFiYXNlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiAjMjAg6rCc7ISgOiBVbmlmaWVkRGF0YWJhc2Ug6riw7LSIIOuLqOychCDthYzsiqTtirhcbiAqIFxuICog66mU66qo66asIOuCtCBTUUxpdGXroZwg7Iuk7KCcIERCIOuhnOyngeydhCDthYzsiqTtirjtlanri4jri6QuXG4gKi9cblxuaW1wb3J0IHsgVW5pZmllZERhdGFiYXNlIH0gZnJvbSAnLi4vLi4vLi4vZGF0YWJhc2UvbW9kZWxzL3VuaWZpZWQtZGF0YWJhc2UnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIG9zIGZyb20gJ29zJztcblxuZGVzY3JpYmUoJ1VuaWZpZWREYXRhYmFzZScsICgpID0+IHtcbiAgICBsZXQgZGI6IFVuaWZpZWREYXRhYmFzZTtcbiAgICBsZXQgdGVtcERpcjogc3RyaW5nO1xuXG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAgIC8vIOyehOyLnCDrlJTroInthqDrpqzsl5Ag7YWM7Iqk7Yq4IERCIOyDneyEsVxuICAgICAgICB0ZW1wRGlyID0gZnMubWtkdGVtcFN5bmMocGF0aC5qb2luKG9zLnRtcGRpcigpLCAnb3Blbm1ha2UtdGVzdC0nKSk7XG4gICAgICAgIGRiID0gbmV3IFVuaWZpZWREYXRhYmFzZSh0ZW1wRGlyKTtcbiAgICB9KTtcblxuICAgIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAvLyBhbHJlYWR5IGNsb3NlZFxuICAgICAgICB9XG4gICAgICAgIC8vIOyehOyLnCDtjIzsnbwg7KCV66asXG4gICAgICAgIGZzLnJtU3luYyh0ZW1wRGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSwgZm9yY2U6IHRydWUgfSk7XG4gICAgfSk7XG5cbiAgICAvLyA9PT09PSBVc2VyIENSVUQgPT09PT1cbiAgICBkZXNjcmliZSgnVXNlciBNYW5hZ2VtZW50JywgKCkgPT4ge1xuICAgICAgICBpdCgnc2hvdWxkIGNyZWF0ZSBhbmQgcmV0cmlldmUgYSB1c2VyIGJ5IHVzZXJuYW1lJywgKCkgPT4ge1xuICAgICAgICAgICAgZGIuY3JlYXRlVXNlcigndXNlci0xJywgJ3Rlc3R1c2VyJywgJ2hhc2hlZDEyMycsICd0ZXN0QGV4YW1wbGUuY29tJywgJ3VzZXInKTtcbiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBkYi5nZXRVc2VyQnlVc2VybmFtZSgndGVzdHVzZXInKTtcblxuICAgICAgICAgICAgZXhwZWN0KHVzZXIpLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgICAgICBleHBlY3QodXNlciEuaWQpLnRvQmUoJ3VzZXItMScpO1xuICAgICAgICAgICAgZXhwZWN0KHVzZXIhLnVzZXJuYW1lKS50b0JlKCd0ZXN0dXNlcicpO1xuICAgICAgICAgICAgZXhwZWN0KHVzZXIhLmVtYWlsKS50b0JlKCd0ZXN0QGV4YW1wbGUuY29tJyk7XG4gICAgICAgICAgICBleHBlY3QodXNlciEucm9sZSkudG9CZSgndXNlcicpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHJldHJpZXZlIGEgdXNlciBieSBpZCcsICgpID0+IHtcbiAgICAgICAgICAgIGRiLmNyZWF0ZVVzZXIoJ3VzZXItMicsICdhZG1pbicsICdoYXNoZWQ0NTYnLCAnYWRtaW5AdGVzdC5jb20nLCAnYWRtaW4nKTtcbiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBkYi5nZXRVc2VyQnlJZCgndXNlci0yJyk7XG5cbiAgICAgICAgICAgIGV4cGVjdCh1c2VyKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICAgICAgZXhwZWN0KHVzZXIhLnVzZXJuYW1lKS50b0JlKCdhZG1pbicpO1xuICAgICAgICAgICAgZXhwZWN0KHVzZXIhLnJvbGUpLnRvQmUoJ2FkbWluJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIHVuZGVmaW5lZCBmb3Igbm9uLWV4aXN0ZW50IHVzZXInLCAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoZGIuZ2V0VXNlckJ5VXNlcm5hbWUoJ25vYm9keScpKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICAgICAgICBleHBlY3QoZGIuZ2V0VXNlckJ5SWQoJ25vLWlkJykpLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgbGFzdCBsb2dpbiB0aW1lc3RhbXAnLCAoKSA9PiB7XG4gICAgICAgICAgICBkYi5jcmVhdGVVc2VyKCd1c2VyLTMnLCAnbG9naW51c2VyJywgJ2hhc2gnLCAnbG9naW5AdGVzdC5jb20nKTtcbiAgICAgICAgICAgIGRiLnVwZGF0ZUxhc3RMb2dpbigndXNlci0zJyk7XG5cbiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBkYi5nZXRVc2VyQnlJZCgndXNlci0zJyk7XG4gICAgICAgICAgICBleHBlY3QodXNlcikudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdCh1c2VyIS5sYXN0X2xvZ2luKS50b0JlVHJ1dGh5KCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgbGlzdCBhbGwgdXNlcnMgd2l0aCBvcHRpb25hbCBsaW1pdCcsICgpID0+IHtcbiAgICAgICAgICAgIGRiLmNyZWF0ZVVzZXIoJ3UxJywgJ3VzZXIxJywgJ2gxJyk7XG4gICAgICAgICAgICBkYi5jcmVhdGVVc2VyKCd1MicsICd1c2VyMicsICdoMicpO1xuICAgICAgICAgICAgZGIuY3JlYXRlVXNlcigndTMnLCAndXNlcjMnLCAnaDMnKTtcblxuICAgICAgICAgICAgY29uc3QgYWxsID0gZGIuZ2V0QWxsVXNlcnMoKTtcbiAgICAgICAgICAgIGV4cGVjdChhbGwubGVuZ3RoKS50b0JlKDMpO1xuXG4gICAgICAgICAgICBjb25zdCBsaW1pdGVkID0gZGIuZ2V0QWxsVXNlcnMoMik7XG4gICAgICAgICAgICBleHBlY3QobGltaXRlZC5sZW5ndGgpLnRvQmUoMik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgLy8gPT09PT0gQ29udmVyc2F0aW9uIFNlc3Npb25zID09PT09XG4gICAgZGVzY3JpYmUoJ0NvbnZlcnNhdGlvbiBTZXNzaW9ucycsICgpID0+IHtcbiAgICAgICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAgICAgICBkYi5jcmVhdGVVc2VyKCd1c2VyLWNvbnYnLCAnY29udnVzZXInLCAnaGFzaCcsICdjb252QHRlc3QuY29tJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgY3JlYXRlIGEgc2Vzc2lvbiBhbmQgYWRkIG1lc3NhZ2VzJywgKCkgPT4ge1xuICAgICAgICAgICAgZGIuY3JlYXRlU2Vzc2lvbignc2Vzcy0xJywgJ3VzZXItY29udicsICdUZXN0IENoYXQnKTtcblxuICAgICAgICAgICAgZGIuYWRkTWVzc2FnZSgnc2Vzcy0xJywgJ3VzZXInLCAnSGVsbG8nKTtcbiAgICAgICAgICAgIGRiLmFkZE1lc3NhZ2UoJ3Nlc3MtMScsICdhc3Npc3RhbnQnLCAnSGkgdGhlcmUhJywge1xuICAgICAgICAgICAgICAgIG1vZGVsOiAndGVzdC1tb2RlbCcsXG4gICAgICAgICAgICAgICAgdG9rZW5zOiAxMCxcbiAgICAgICAgICAgICAgICByZXNwb25zZVRpbWVNczogMjAwXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZXMgPSBkYi5nZXRTZXNzaW9uTWVzc2FnZXMoJ3Nlc3MtMScpO1xuICAgICAgICAgICAgZXhwZWN0KG1lc3NhZ2VzLmxlbmd0aCkudG9CZSgyKTtcbiAgICAgICAgICAgIGV4cGVjdChtZXNzYWdlc1swXS5yb2xlKS50b0JlKCd1c2VyJyk7XG4gICAgICAgICAgICBleHBlY3QobWVzc2FnZXNbMF0uY29udGVudCkudG9CZSgnSGVsbG8nKTtcbiAgICAgICAgICAgIGV4cGVjdChtZXNzYWdlc1sxXS5yb2xlKS50b0JlKCdhc3Npc3RhbnQnKTtcbiAgICAgICAgICAgIGV4cGVjdChtZXNzYWdlc1sxXS5tb2RlbCkudG9CZSgndGVzdC1tb2RlbCcpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGxpc3QgdXNlciBzZXNzaW9ucycsICgpID0+IHtcbiAgICAgICAgICAgIGRiLmNyZWF0ZVNlc3Npb24oJ3MxJywgJ3VzZXItY29udicsICdDaGF0IDEnKTtcbiAgICAgICAgICAgIGRiLmNyZWF0ZVNlc3Npb24oJ3MyJywgJ3VzZXItY29udicsICdDaGF0IDInKTtcblxuICAgICAgICAgICAgY29uc3Qgc2Vzc2lvbnMgPSBkYi5nZXRVc2VyU2Vzc2lvbnMoJ3VzZXItY29udicpO1xuICAgICAgICAgICAgZXhwZWN0KHNlc3Npb25zLmxlbmd0aCkudG9CZSgyKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBkZWxldGUgYSBzZXNzaW9uIGFuZCBpdHMgbWVzc2FnZXMnLCAoKSA9PiB7XG4gICAgICAgICAgICBkYi5jcmVhdGVTZXNzaW9uKCdkZWwtc2VzcycsICd1c2VyLWNvbnYnLCAnRGVsZXRlIE1lJyk7XG4gICAgICAgICAgICBkYi5hZGRNZXNzYWdlKCdkZWwtc2VzcycsICd1c2VyJywgJ1dpbGwgYmUgZGVsZXRlZCcpO1xuXG4gICAgICAgICAgICBkYi5kZWxldGVTZXNzaW9uKCdkZWwtc2VzcycpO1xuXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlcyA9IGRiLmdldFNlc3Npb25NZXNzYWdlcygnZGVsLXNlc3MnKTtcbiAgICAgICAgICAgIGV4cGVjdChtZXNzYWdlcy5sZW5ndGgpLnRvQmUoMCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgLy8gPT09PT0gTWVtb3J5IFN5c3RlbSA9PT09PVxuICAgIGRlc2NyaWJlKCdNZW1vcnkgU3lzdGVtJywgKCkgPT4ge1xuICAgICAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgICAgICAgIGRiLmNyZWF0ZVVzZXIoJ21lbS11c2VyJywgJ21lbXVzZXInLCAnaGFzaCcpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGNyZWF0ZSBhbmQgcmV0cmlldmUgdXNlciBtZW1vcmllcycsICgpID0+IHtcbiAgICAgICAgICAgIGRiLmNyZWF0ZU1lbW9yeSh7XG4gICAgICAgICAgICAgICAgaWQ6ICdtZW0tMScsXG4gICAgICAgICAgICAgICAgdXNlcklkOiAnbWVtLXVzZXInLFxuICAgICAgICAgICAgICAgIGNhdGVnb3J5OiAncHJlZmVyZW5jZScsXG4gICAgICAgICAgICAgICAga2V5OiAnbGFuZ3VhZ2UnLFxuICAgICAgICAgICAgICAgIHZhbHVlOiAnVHlwZVNjcmlwdCcsXG4gICAgICAgICAgICAgICAgaW1wb3J0YW5jZTogOFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IG1lbW9yaWVzID0gZGIuZ2V0VXNlck1lbW9yaWVzKCdtZW0tdXNlcicpO1xuICAgICAgICAgICAgZXhwZWN0KG1lbW9yaWVzLmxlbmd0aCkudG9CZSgxKTtcbiAgICAgICAgICAgIGV4cGVjdChtZW1vcmllc1swXS5rZXkpLnRvQmUoJ2xhbmd1YWdlJyk7XG4gICAgICAgICAgICBleHBlY3QobWVtb3JpZXNbMF0udmFsdWUpLnRvQmUoJ1R5cGVTY3JpcHQnKTtcbiAgICAgICAgICAgIGV4cGVjdChtZW1vcmllc1swXS5pbXBvcnRhbmNlKS50b0JlKDgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGZpbHRlciBtZW1vcmllcyBieSBjYXRlZ29yeScsICgpID0+IHtcbiAgICAgICAgICAgIGRiLmNyZWF0ZU1lbW9yeSh7XG4gICAgICAgICAgICAgICAgaWQ6ICdtZW0tYScsIHVzZXJJZDogJ21lbS11c2VyJywgY2F0ZWdvcnk6ICdwcmVmZXJlbmNlJyxcbiAgICAgICAgICAgICAgICBrZXk6ICd0aGVtZScsIHZhbHVlOiAnZGFyaydcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZGIuY3JlYXRlTWVtb3J5KHtcbiAgICAgICAgICAgICAgICBpZDogJ21lbS1iJywgdXNlcklkOiAnbWVtLXVzZXInLCBjYXRlZ29yeTogJ2ZhY3QnLFxuICAgICAgICAgICAgICAgIGtleTogJ25hbWUnLCB2YWx1ZTogJ0pvaG4nXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY29uc3QgcHJlZnMgPSBkYi5nZXRVc2VyTWVtb3JpZXMoJ21lbS11c2VyJywgeyBjYXRlZ29yeTogJ3ByZWZlcmVuY2UnIH0pO1xuICAgICAgICAgICAgZXhwZWN0KHByZWZzLmxlbmd0aCkudG9CZSgxKTtcbiAgICAgICAgICAgIGV4cGVjdChwcmVmc1swXS5jYXRlZ29yeSkudG9CZSgncHJlZmVyZW5jZScpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGRlbGV0ZSBzcGVjaWZpYyBtZW1vcnknLCAoKSA9PiB7XG4gICAgICAgICAgICBkYi5jcmVhdGVNZW1vcnkoe1xuICAgICAgICAgICAgICAgIGlkOiAnZGVsLW1lbScsIHVzZXJJZDogJ21lbS11c2VyJywgY2F0ZWdvcnk6ICdwcmVmZXJlbmNlJyxcbiAgICAgICAgICAgICAgICBrZXk6ICd0ZXN0JywgdmFsdWU6ICdkZWxldGUgbWUnXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgZGIuZGVsZXRlTWVtb3J5KCdkZWwtbWVtJyk7XG4gICAgICAgICAgICBjb25zdCBtZW1vcmllcyA9IGRiLmdldFVzZXJNZW1vcmllcygnbWVtLXVzZXInKTtcbiAgICAgICAgICAgIGV4cGVjdChtZW1vcmllcy5sZW5ndGgpLnRvQmUoMCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgLy8gPT09PT0gU3RhdHMgPT09PT1cbiAgICBkZXNjcmliZSgnRGF0YWJhc2UgU3RhdHMnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIHN0YXRzIG9iamVjdCB3aXRoIHRhYmxlIHJvdyBjb3VudHMnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBzdGF0cyA9IGRiLmdldFN0YXRzKCk7XG4gICAgICAgICAgICBleHBlY3Qoc3RhdHMpLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgICAgICBleHBlY3QodHlwZW9mIHN0YXRzLnRvdGFsX3Jvd3MpLnRvQmUoJ251bWJlcicpO1xuICAgICAgICAgICAgZXhwZWN0KHR5cGVvZiBzdGF0cy50YWJsZXMpLnRvQmUoJ29iamVjdCcpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9