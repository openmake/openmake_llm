{"file":"/Volumes/MAC_APP/openmake_llm/tests/unit/__tests__/unified-database.test.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/tests/unit/__tests__/unified-database.test.ts"],"sourcesContent":["/**\n * #20 개선: UnifiedDatabase 기초 단위 테스트\n * \n * 메모리 내 SQLite로 실제 DB 로직을 테스트합니다.\n */\n\nimport { UnifiedDatabase } from '../../../database/models/unified-database';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport * as os from 'os';\n\ndescribe('UnifiedDatabase', () => {\n    let db: UnifiedDatabase;\n    let tempDir: string;\n\n    beforeEach(() => {\n        // 임시 디렉토리에 테스트 DB 생성\n        tempDir = fs.mkdtempSync(path.join(os.tmpdir(), 'openmake-test-'));\n        db = new UnifiedDatabase(tempDir);\n    });\n\n    afterEach(() => {\n        try {\n            db.close();\n        } catch (e) {\n            // already closed\n        }\n        // 임시 파일 정리\n        fs.rmSync(tempDir, { recursive: true, force: true });\n    });\n\n    // ===== User CRUD =====\n    describe('User Management', () => {\n        it('should create and retrieve a user by username', () => {\n            db.createUser('user-1', 'testuser', 'hashed123', 'test@example.com', 'user');\n            const user = db.getUserByUsername('testuser');\n\n            expect(user).toBeDefined();\n            expect(user!.id).toBe('user-1');\n            expect(user!.username).toBe('testuser');\n            expect(user!.email).toBe('test@example.com');\n            expect(user!.role).toBe('user');\n        });\n\n        it('should retrieve a user by id', () => {\n            db.createUser('user-2', 'admin', 'hashed456', 'admin@test.com', 'admin');\n            const user = db.getUserById('user-2');\n\n            expect(user).toBeDefined();\n            expect(user!.username).toBe('admin');\n            expect(user!.role).toBe('admin');\n        });\n\n        it('should return undefined for non-existent user', () => {\n            expect(db.getUserByUsername('nobody')).toBeUndefined();\n            expect(db.getUserById('no-id')).toBeUndefined();\n        });\n\n        it('should update last login timestamp', () => {\n            db.createUser('user-3', 'loginuser', 'hash', 'login@test.com');\n            db.updateLastLogin('user-3');\n\n            const user = db.getUserById('user-3');\n            expect(user).toBeDefined();\n            expect(user!.last_login).toBeTruthy();\n        });\n\n        it('should list all users with optional limit', () => {\n            db.createUser('u1', 'user1', 'h1');\n            db.createUser('u2', 'user2', 'h2');\n            db.createUser('u3', 'user3', 'h3');\n\n            const all = db.getAllUsers();\n            expect(all.length).toBe(3);\n\n            const limited = db.getAllUsers(2);\n            expect(limited.length).toBe(2);\n        });\n    });\n\n    // ===== Conversation Sessions =====\n    describe('Conversation Sessions', () => {\n        beforeEach(() => {\n            db.createUser('user-conv', 'convuser', 'hash', 'conv@test.com');\n        });\n\n        it('should create a session and add messages', () => {\n            db.createSession('sess-1', 'user-conv', 'Test Chat');\n\n            db.addMessage('sess-1', 'user', 'Hello');\n            db.addMessage('sess-1', 'assistant', 'Hi there!', {\n                model: 'test-model',\n                tokens: 10,\n                responseTimeMs: 200\n            });\n\n            const messages = db.getSessionMessages('sess-1');\n            expect(messages.length).toBe(2);\n            expect(messages[0].role).toBe('user');\n            expect(messages[0].content).toBe('Hello');\n            expect(messages[1].role).toBe('assistant');\n            expect(messages[1].model).toBe('test-model');\n        });\n\n        it('should list user sessions', () => {\n            db.createSession('s1', 'user-conv', 'Chat 1');\n            db.createSession('s2', 'user-conv', 'Chat 2');\n\n            const sessions = db.getUserSessions('user-conv');\n            expect(sessions.length).toBe(2);\n        });\n\n        it('should delete a session and its messages', () => {\n            db.createSession('del-sess', 'user-conv', 'Delete Me');\n            db.addMessage('del-sess', 'user', 'Will be deleted');\n\n            db.deleteSession('del-sess');\n\n            const messages = db.getSessionMessages('del-sess');\n            expect(messages.length).toBe(0);\n        });\n    });\n\n    // ===== Memory System =====\n    describe('Memory System', () => {\n        beforeEach(() => {\n            db.createUser('mem-user', 'memuser', 'hash');\n        });\n\n        it('should create and retrieve user memories', () => {\n            db.createMemory({\n                id: 'mem-1',\n                userId: 'mem-user',\n                category: 'preference',\n                key: 'language',\n                value: 'TypeScript',\n                importance: 8\n            });\n\n            const memories = db.getUserMemories('mem-user');\n            expect(memories.length).toBe(1);\n            expect(memories[0].key).toBe('language');\n            expect(memories[0].value).toBe('TypeScript');\n            expect(memories[0].importance).toBe(8);\n        });\n\n        it('should filter memories by category', () => {\n            db.createMemory({\n                id: 'mem-a', userId: 'mem-user', category: 'preference',\n                key: 'theme', value: 'dark'\n            });\n            db.createMemory({\n                id: 'mem-b', userId: 'mem-user', category: 'fact',\n                key: 'name', value: 'John'\n            });\n\n            const prefs = db.getUserMemories('mem-user', { category: 'preference' });\n            expect(prefs.length).toBe(1);\n            expect(prefs[0].category).toBe('preference');\n        });\n\n        it('should delete specific memory', () => {\n            db.createMemory({\n                id: 'del-mem', userId: 'mem-user', category: 'preference',\n                key: 'test', value: 'delete me'\n            });\n\n            db.deleteMemory('del-mem');\n            const memories = db.getUserMemories('mem-user');\n            expect(memories.length).toBe(0);\n        });\n    });\n\n    // ===== Stats =====\n    describe('Database Stats', () => {\n        it('should return stats object with table row counts', () => {\n            const stats = db.getStats();\n            expect(stats).toBeDefined();\n            expect(typeof stats.total_rows).toBe('number');\n            expect(typeof stats.tables).toBe('object');\n        });\n    });\n});\n"],"version":3}