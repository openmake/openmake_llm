{"file":"/Volumes/MAC_APP/openmake_llm/infrastructure/security/auth/index.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/infrastructure/security/auth/index.ts"],"sourcesContent":["/**\n * Ïù∏Ï¶ù Î™®Îìà\n * JWT ÌÜ†ÌÅ∞ ÏÉùÏÑ±/Í≤ÄÏ¶ù Î∞è Ïù∏Ï¶ù Ïú†Ìã∏Î¶¨Ìã∞\n * \n * üîí Í∞úÏÑ†: ÌÜ†ÌÅ∞ Î∏îÎûôÎ¶¨Ïä§Ìä∏ Î∞è Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞ Î©îÏª§ÎãàÏ¶ò Ï∂îÍ∞Ä\n */\n\nimport * as jwt from 'jsonwebtoken';\nimport { JWTPayload, PublicUser, UserRole } from './types';\nimport * as crypto from 'crypto';\n\n// ============================================\n// üîí ÌÜ†ÌÅ∞ Î∏îÎûôÎ¶¨Ïä§Ìä∏ (Î°úÍ∑∏ÏïÑÏõÉ/Í∞ïÏ†ú ÎßåÎ£å)\n// #8 Í∞úÏÑ†: Ïù∏Î©îÎ™®Î¶¨ + SQLite ÏòÅÏÜçÌôî (ÏÑúÎ≤Ñ Ïû¨ÏãúÏûë ÏãúÏóêÎèÑ Ïú†ÏßÄ)\n// ============================================\n\n// Ïù∏Î©îÎ™®Î¶¨ Ï∫êÏãú (Îπ†Î•∏ Ï°∞ÌöåÏö©)\nconst tokenBlacklist = new Map<string, number>();\nconst BLACKLIST_CLEANUP_INTERVAL = 60 * 60 * 1000; // 1ÏãúÍ∞ÑÎßàÎã§ Ï†ïÎ¶¨\n\n// #8: SQLite ÏòÅÏÜçÌôî ÏΩúÎ∞± (Ïï± Ï¥àÍ∏∞Ìôî Ïãú Îì±Î°ù)\ntype BlacklistPersistFn = {\n    save: (jti: string, expiresAt: number) => void;\n    has: (jti: string) => boolean;\n    loadAll: () => Array<{ jti: string; expires_at: number }>;\n    cleanup: () => number;\n};\nlet _blacklistPersist: BlacklistPersistFn | null = null;\n\n/**\n * #8: Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÏòÅÏÜçÌôî Ìï®Ïàò Îì±Î°ù\n * SQLite Îì± Ïô∏Î∂Ä Ïä§ÌÜ†Î¶¨ÏßÄ Ïó∞ÎèôÏùÑ ÏúÑÌïú DI\n */\nexport function registerBlacklistPersistence(fns: BlacklistPersistFn): void {\n    _blacklistPersist = fns;\n    // Í∏∞Ï°¥ ÏòÅÏÜç Îç∞Ïù¥ÌÑ∞ Î°úÎìú\n    try {\n        const entries = fns.loadAll();\n        const now = Date.now();\n        let loaded = 0;\n        for (const entry of entries) {\n            if (entry.expires_at > now) {\n                tokenBlacklist.set(entry.jti, entry.expires_at);\n                loaded++;\n            }\n        }\n        console.log(`[Auth] üîí ÏòÅÏÜçÌôîÎêú Î∏îÎûôÎ¶¨Ïä§Ìä∏ ${loaded}Í∞ú Î°úÎìúÎê®`);\n    } catch (e) {\n        console.error('[Auth] Î∏îÎûôÎ¶¨Ïä§Ìä∏ Î°úÎìú Ïã§Ìå®:', e);\n    }\n}\n\n// Î∏îÎûôÎ¶¨Ïä§Ìä∏ Ï†ïÎ¶¨ Ïä§ÏºÄÏ§ÑÎü¨\nsetInterval(() => {\n    const now = Date.now();\n    let cleaned = 0;\n    for (const [tokenId, expTime] of tokenBlacklist.entries()) {\n        if (expTime < now) {\n            tokenBlacklist.delete(tokenId);\n            cleaned++;\n        }\n    }\n    // #8: ÏòÅÏÜç Ïä§ÌÜ†Î¶¨ÏßÄÎèÑ Ï†ïÎ¶¨\n    if (_blacklistPersist) {\n        cleaned += _blacklistPersist.cleanup();\n    }\n    if (cleaned > 0) {\n        console.log(`[Auth] üßπ ÎßåÎ£åÎêú Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÌÜ†ÌÅ∞ ${cleaned}Í∞ú Ï†ïÎ¶¨Îê®`);\n    }\n}, BLACKLIST_CLEANUP_INTERVAL);\n\n/**\n * üîí ÌÜ†ÌÅ∞ÏùÑ Î∏îÎûôÎ¶¨Ïä§Ìä∏Ïóê Ï∂îÍ∞Ä (Î°úÍ∑∏ÏïÑÏõÉ Ïãú)\n * #8 Í∞úÏÑ†: Ïù∏Î©îÎ™®Î¶¨ + ÏòÅÏÜç Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•\n */\nexport function blacklistToken(token: string): void {\n    try {\n        const decoded = jwt.decode(token) as any;\n        if (decoded?.jti && decoded?.exp) {\n            const expiresAt = decoded.exp * 1000;\n            tokenBlacklist.set(decoded.jti, expiresAt);\n            // #8: ÏòÅÏÜç Ïä§ÌÜ†Î¶¨ÏßÄÏóêÎèÑ Ï†ÄÏû•\n            _blacklistPersist?.save(decoded.jti, expiresAt);\n            console.log(`[Auth] üö´ ÌÜ†ÌÅ∞ Î∏îÎûôÎ¶¨Ïä§Ìä∏ Ï∂îÍ∞Ä: ${decoded.jti.substring(0, 8)}...`);\n        }\n    } catch (e) {\n        console.error('[Auth] ÌÜ†ÌÅ∞ Î∏îÎûôÎ¶¨Ïä§Ìä∏ Ï∂îÍ∞Ä Ïã§Ìå®:', e);\n    }\n}\n\n/**\n * üîí ÌÜ†ÌÅ∞Ïù¥ Î∏îÎûôÎ¶¨Ïä§Ìä∏Ïóê ÏûàÎäîÏßÄ ÌôïÏù∏\n * #8 Í∞úÏÑ†: Ïù∏Î©îÎ™®Î¶¨ Ï∫êÏãú ‚Üí ÏòÅÏÜç Ïä§ÌÜ†Î¶¨ÏßÄ ÏàúÏúºÎ°ú ÌôïÏù∏\n */\nexport function isTokenBlacklisted(token: string): boolean {\n    try {\n        const decoded = jwt.decode(token) as any;\n        if (decoded?.jti) {\n            // Ïù∏Î©îÎ™®Î¶¨ Ï∫êÏãú Î®ºÏ†Ä ÌôïÏù∏ (Îπ†Î¶Ñ)\n            if (tokenBlacklist.has(decoded.jti)) {\n                return true;\n            }\n            // #8: ÏòÅÏÜç Ïä§ÌÜ†Î¶¨ÏßÄ ÌôïÏù∏ (Ïù∏Î©îÎ™®Î¶¨Ïóê ÏóÜÏùÑ Í≤ΩÏö∞ - ÏÑúÎ≤Ñ Ïû¨ÏãúÏûë ÌõÑ)\n            if (_blacklistPersist?.has(decoded.jti)) {\n                // Ïù∏Î©îÎ™®Î¶¨ Ï∫êÏãúÏóê Îã§Ïãú Ï∂îÍ∞Ä\n                if (decoded.exp) {\n                    tokenBlacklist.set(decoded.jti, decoded.exp * 1000);\n                }\n                return true;\n            }\n        }\n    } catch (e) {\n        // ÎîîÏΩîÎî© Ïã§Ìå® Ïãú false Î∞òÌôò\n    }\n    return false;\n}\n\n/**\n * üîí Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÌÜµÍ≥Ñ\n */\nexport function getBlacklistStats(): { count: number; persisted: boolean } {\n    return { count: tokenBlacklist.size, persisted: !!_blacklistPersist };\n}\n\n// üîí Î≥¥Ïïà Í∞ïÌôî: JWT ÎπÑÎ∞ÄÌÇ§ Í≤ÄÏ¶ù Î∞è Í¥ÄÎ¶¨\nconst MIN_JWT_SECRET_LENGTH = 32; // ÏµúÏÜå 256ÎπÑÌä∏\n\nconst generateDevSecret = () => {\n    return `dev-session-${crypto.randomBytes(32).toString('hex')}`;\n};\n\n// JWT Secret Í≤ÄÏ¶ù Î∞è ÏÑ§Ï†ï\nlet JWT_SECRET: string;\nconst JWT_EXPIRES_IN = '7d';\n\nif (process.env.JWT_SECRET) {\n    // üîí Secret Í∏∏Ïù¥ Í≤ÄÏ¶ù\n    if (process.env.JWT_SECRET.length < MIN_JWT_SECRET_LENGTH) {\n        console.error(`[Auth] ‚ùå JWT_SECRETÏù¥ ÎÑàÎ¨¥ ÏßßÏäµÎãàÎã§! (ÌòÑÏû¨: ${process.env.JWT_SECRET.length}Ïûê, ÏµúÏÜå: ${MIN_JWT_SECRET_LENGTH}Ïûê)`);\n        console.error('[Auth] Î≥¥ÏïàÏùÑ ÏúÑÌï¥ 32Ïûê Ïù¥ÏÉÅÏùò ÎûúÎç§ Î¨∏ÏûêÏó¥ÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.');\n        console.error('[Auth] ÏÉùÏÑ± Î∞©Î≤ï: node -e \"console.log(require(\\'crypto\\').randomBytes(32).toString(\\'hex\\'))\"');\n        if (process.env.NODE_ENV === 'production') {\n            throw new Error('[Auth] ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤ΩÏóêÏÑúÎäî Ï∂©Î∂ÑÌûà Í∏¥ JWT_SECRETÏù¥ ÌïÑÏàòÏûÖÎãàÎã§!');\n        }\n    }\n    JWT_SECRET = process.env.JWT_SECRET;\n    console.log('[Auth] ‚úÖ JWT_SECRET ÏÑ§Ï†ï ÏôÑÎ£å');\n} else {\n    // Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÏÑúÎßå ÏûÑÏãú ÏãúÌÅ¨Î¶ø ÏÉùÏÑ±\n    if (process.env.NODE_ENV === 'production') {\n        throw new Error('[Auth] ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤ΩÏóêÏÑúÎäî JWT_SECRET ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÌïÑÏàòÏûÖÎãàÎã§!');\n    }\n    \n    JWT_SECRET = generateDevSecret();\n    console.warn('[Auth] ‚ö†Ô∏è ========================================');\n    console.warn('[Auth] ‚ö†Ô∏è JWT_SECRET ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!');\n    console.warn('[Auth] ‚ö†Ô∏è Í∞úÎ∞ú ÌôòÍ≤ΩÏö© ÏûÑÏãú ÏãúÌÅ¨Î¶øÏù¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.');\n    console.warn('[Auth] ‚ö†Ô∏è ÏÑúÎ≤Ñ Ïû¨ÏãúÏûë Ïãú Î™®Îì† Í∏∞Ï°¥ ÌÜ†ÌÅ∞Ïù¥ Î¨¥Ìö®ÌôîÎê©ÎãàÎã§!');\n    console.warn('[Auth] ‚ö†Ô∏è .env ÌååÏùºÏóê JWT_SECRETÏùÑ Î∞òÎìúÏãú ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.');\n    console.warn('[Auth] ‚ö†Ô∏è ========================================');\n}\n\n\n/**\n * JWT ÌÜ†ÌÅ∞ ÏÉùÏÑ±\n * üîí jti (JWT ID) Ï∂îÍ∞ÄÎ°ú Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÏßÄÏõê\n */\nexport function generateToken(user: PublicUser): string {\n    const payload: JWTPayload = {\n        userId: user.id,\n        email: user.email || '',\n        role: user.role\n    };\n\n    // üîí Í≥†Ïú† ÌÜ†ÌÅ∞ ID Ï∂îÍ∞Ä (Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÏßÄÏõê)\n    const jti = crypto.randomBytes(16).toString('hex');\n    \n    return jwt.sign(payload, JWT_SECRET, { \n        expiresIn: JWT_EXPIRES_IN,\n        jwtid: jti\n    });\n}\n\n/**\n * üîí Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞ ÏÉùÏÑ± (Ïû•Í∏∞ ÌÜ†ÌÅ∞)\n * - Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ ÎßåÎ£å Ïãú ÏÉà ÌÜ†ÌÅ∞ Î∞úÍ∏âÏóê ÏÇ¨Ïö©\n * - 30Ïùº ÎßåÎ£å\n */\nexport function generateRefreshToken(user: PublicUser): string {\n    const payload = {\n        userId: user.id,\n        type: 'refresh'\n    };\n\n    const jti = crypto.randomBytes(16).toString('hex');\n    \n    return jwt.sign(payload, JWT_SECRET, { \n        expiresIn: '30d',\n        jwtid: jti\n    });\n}\n\n/**\n * üîí Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù\n */\nexport function verifyRefreshToken(token: string): { userId: string } | null {\n    try {\n        if (isTokenBlacklisted(token)) {\n            console.warn('[Auth] Î∏îÎûôÎ¶¨Ïä§Ìä∏Îêú Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞');\n            return null;\n        }\n        \n        const decoded = jwt.verify(token, JWT_SECRET) as any;\n        if (decoded.type !== 'refresh') {\n            return null;\n        }\n        return { userId: decoded.userId };\n    } catch (error) {\n        console.error('[Auth] Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù Ïã§Ìå®:', error);\n        return null;\n    }\n}\n\n/**\n * JWT ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù\n * üîí Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÌôïÏù∏ Ï∂îÍ∞Ä\n */\nexport function verifyToken(token: string): JWTPayload | null {\n    try {\n        // üîí Î∏îÎûôÎ¶¨Ïä§Ìä∏ ÌôïÏù∏\n        if (isTokenBlacklisted(token)) {\n            console.warn('[Auth] Î∏îÎûôÎ¶¨Ïä§Ìä∏Îêú ÌÜ†ÌÅ∞ ÏÇ¨Ïö© ÏãúÎèÑ');\n            return null;\n        }\n        \n        const decoded = jwt.verify(token, JWT_SECRET) as unknown as JWTPayload;\n        return decoded;\n    } catch (error) {\n        console.error('[Auth] ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù Ïã§Ìå®:', error);\n        return null;\n    }\n}\n\n/**\n * Authorization Ìó§ÎçîÏóêÏÑú ÌÜ†ÌÅ∞ Ï∂îÏ∂ú\n */\nexport function extractToken(authHeader?: string): string | null {\n    if (!authHeader) return null;\n\n    // \"Bearer <token>\" ÌòïÏãù\n    if (authHeader.startsWith('Bearer ')) {\n        return authHeader.slice(7);\n    }\n\n    return authHeader;\n}\n\n/**\n * Ïó≠Ìï† Í∂åÌïú Ï≤¥ÌÅ¨\n */\nexport function hasPermission(userRole: UserRole, requiredRole: UserRole): boolean {\n    const roleHierarchy: Record<UserRole, number> = {\n        'admin': 3,\n        'user': 2,\n        'guest': 1\n    };\n\n    return roleHierarchy[userRole] >= roleHierarchy[requiredRole];\n}\n\n/**\n * Í¥ÄÎ¶¨Ïûê Ïó¨Î∂Ä ÌôïÏù∏\n */\nexport function isAdmin(role: UserRole): boolean {\n    return role === 'admin';\n}\n\n// Î™®Îìà Ïû¨-export\nexport * from './types';\nexport { optionalAuth, requireAuth, requireAdmin, requireRole, registerUserLookup } from './middleware';\n"],"version":3}