53fa7d7c08b50ee9f8cfc50be9960e9e
"use strict";
/**
 * ============================================================
 * Auth Service
 * ============================================================
 * 인증 관련 비즈니스 로직
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthService = void 0;
exports.getAuthService = getAuthService;
const user_manager_1 = require("../data/user-manager");
const auth_1 = require("../auth");
const logger_1 = require("../utils/logger");
const log = (0, logger_1.createLogger)('AuthService');
/**
 * Validate password complexity requirements
 * - Minimum 8 characters
 * - At least one uppercase letter
 * - At least one lowercase letter
 * - At least one number
 * - At least one special character
 */
function validatePasswordComplexity(password) {
    const errors = [];
    if (password.length < 8) {
        errors.push('비밀번호는 8자 이상이어야 합니다');
    }
    if (!/[A-Z]/.test(password)) {
        errors.push('대문자를 1개 이상 포함해야 합니다');
    }
    if (!/[a-z]/.test(password)) {
        errors.push('소문자를 1개 이상 포함해야 합니다');
    }
    if (!/[0-9]/.test(password)) {
        errors.push('숫자를 1개 이상 포함해야 합니다');
    }
    if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
        errors.push('특수문자를 1개 이상 포함해야 합니다');
    }
    return { valid: errors.length === 0, errors };
}
class AuthService {
    constructor() {
        this.userManager = (0, user_manager_1.getUserManager)();
    }
    /**
     * 회원가입
     */
    register(data) {
        const { email, password, role } = data;
        // 유효성 검사
        if (!email || !password) {
            return { success: false, error: '이메일과 비밀번호를 입력하세요' };
        }
        const passwordValidation = validatePasswordComplexity(password);
        if (!passwordValidation.valid) {
            return { success: false, error: passwordValidation.errors.join(', ') };
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            return { success: false, error: '유효한 이메일 주소를 입력하세요' };
        }
        const user = this.userManager.createUser({ email, password, role });
        if (!user) {
            return { success: false, error: '이미 등록된 이메일입니다' };
        }
        log.info(`회원가입 완료: ${email}`);
        return { success: true, user };
    }
    /**
     * 로그인
     */
    login(data) {
        const { email, password } = data;
        if (!email || !password) {
            return { success: false, error: '이메일과 비밀번호를 입력하세요' };
        }
        const user = this.userManager.authenticate(email, password);
        if (!user) {
            return { success: false, error: '이메일 또는 비밀번호가 올바르지 않습니다' };
        }
        const token = (0, auth_1.generateToken)(user);
        log.info(`로그인 성공: ${email}`);
        return { success: true, token, user };
    }
    /**
     * 비밀번호 변경
     */
    changePassword(data) {
        const { userId, currentEmail, currentPassword, newPassword } = data;
        if (!currentPassword || !newPassword) {
            return { success: false, error: '현재 비밀번호와 새 비밀번호를 입력하세요' };
        }
        const passwordValidation = validatePasswordComplexity(newPassword);
        if (!passwordValidation.valid) {
            return { success: false, error: passwordValidation.errors.join(', ') };
        }
        // 현재 비밀번호 확인
        const user = this.userManager.authenticate(currentEmail, currentPassword);
        if (!user) {
            return { success: false, error: '현재 비밀번호가 올바르지 않습니다' };
        }
        const success = this.userManager.changePassword(userId, newPassword);
        return { success };
    }
    /**
     * OAuth 사용자 생성 또는 반환
     */
    findOrCreateOAuthUser(email, provider) {
        let user = this.userManager.getUserByEmail(email);
        let publicUser = user ? this.userManager.getUserById(user.id) : null;
        if (!publicUser) {
            // OAuth 사용자는 랜덤 비밀번호로 생성
            const randomPassword = Math.random().toString(36).substring(2, 15);
            // 관리자 이메일 목록 확인
            const adminEmails = (process.env.ADMIN_EMAILS || '')
                .split(',')
                .map(e => e.toLowerCase().trim())
                .filter(e => e);
            const role = adminEmails.includes(email.toLowerCase()) ? 'admin' : 'user';
            publicUser = this.userManager.createUser({
                email,
                password: randomPassword,
                role
            });
            if (!publicUser) {
                return { success: false, error: '사용자 생성 실패' };
            }
            log.info(`[OAuth] ${provider} 신규 사용자 생성: ${email}`);
        }
        else {
            // 기존 계정 관리자 승격 체크
            const adminEmails = (process.env.ADMIN_EMAILS || '')
                .split(',')
                .map(e => e.toLowerCase().trim())
                .filter(e => e);
            if (adminEmails.includes(email.toLowerCase()) && publicUser.role !== 'admin') {
                this.userManager.changeRole(publicUser.id, 'admin');
                publicUser.role = 'admin';
            }
        }
        const token = (0, auth_1.generateToken)(publicUser);
        log.info(`[OAuth] ${provider} 로그인 성공: ${email}`);
        return { success: true, token, user: publicUser };
    }
    /**
     * 사용 가능한 OAuth 프로바이더 목록
     */
    getAvailableProviders() {
        const providers = [];
        if (process.env.GOOGLE_CLIENT_ID && process.env.GOOGLE_CLIENT_SECRET) {
            providers.push('google');
        }
        if (process.env.GITHUB_CLIENT_ID && process.env.GITHUB_CLIENT_SECRET) {
            providers.push('github');
        }
        return providers;
    }
}
exports.AuthService = AuthService;
// 싱글톤 인스턴스
let authService = null;
function getAuthService() {
    if (!authService) {
        authService = new AuthService();
    }
    return authService;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL3NlcnZpY2VzL0F1dGhTZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7O0FBb05ILHdDQUtDO0FBdk5ELHVEQUFzRDtBQUN0RCxrQ0FBd0M7QUFDeEMsNENBQStDO0FBRS9DLE1BQU0sR0FBRyxHQUFHLElBQUEscUJBQVksRUFBQyxhQUFhLENBQUMsQ0FBQztBQTJCeEM7Ozs7Ozs7R0FPRztBQUNILFNBQVMsMEJBQTBCLENBQUMsUUFBZ0I7SUFDaEQsTUFBTSxNQUFNLEdBQWEsRUFBRSxDQUFDO0lBRTVCLElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUN0QixNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUNELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7UUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1FBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztRQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUNELElBQUksQ0FBQyx1Q0FBdUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztRQUMxRCxNQUFNLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUM7QUFD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YWtlX2xsbS9iYWNrZW5kL2FwaS9zcmMvc2VydmljZXMvQXV0aFNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAqIEF1dGggU2VydmljZVxuICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gKiDsnbjspp0g6rSA66CoIOu5hOymiOuLiOyKpCDroZzsp4FcbiAqL1xuXG5pbXBvcnQgeyBnZXRVc2VyTWFuYWdlciB9IGZyb20gJy4uL2RhdGEvdXNlci1tYW5hZ2VyJztcbmltcG9ydCB7IGdlbmVyYXRlVG9rZW4gfSBmcm9tICcuLi9hdXRoJztcbmltcG9ydCB7IGNyZWF0ZUxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5cbmNvbnN0IGxvZyA9IGNyZWF0ZUxvZ2dlcignQXV0aFNlcnZpY2UnKTtcblxuZXhwb3J0IGludGVyZmFjZSBSZWdpc3RlclJlcXVlc3Qge1xuICAgIGVtYWlsOiBzdHJpbmc7XG4gICAgcGFzc3dvcmQ6IHN0cmluZztcbiAgICByb2xlPzogJ2FkbWluJyB8ICd1c2VyJyB8ICdndWVzdCc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTG9naW5SZXF1ZXN0IHtcbiAgICBlbWFpbDogc3RyaW5nO1xuICAgIHBhc3N3b3JkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2hhbmdlUGFzc3dvcmRSZXF1ZXN0IHtcbiAgICB1c2VySWQ6IG51bWJlcjtcbiAgICBjdXJyZW50RW1haWw6IHN0cmluZztcbiAgICBjdXJyZW50UGFzc3dvcmQ6IHN0cmluZztcbiAgICBuZXdQYXNzd29yZDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhSZXN1bHQge1xuICAgIHN1Y2Nlc3M6IGJvb2xlYW47XG4gICAgZXJyb3I/OiBzdHJpbmc7XG4gICAgdXNlcj86IGFueTtcbiAgICB0b2tlbj86IHN0cmluZztcbn1cblxuLyoqXG4gKiBWYWxpZGF0ZSBwYXNzd29yZCBjb21wbGV4aXR5IHJlcXVpcmVtZW50c1xuICogLSBNaW5pbXVtIDggY2hhcmFjdGVyc1xuICogLSBBdCBsZWFzdCBvbmUgdXBwZXJjYXNlIGxldHRlclxuICogLSBBdCBsZWFzdCBvbmUgbG93ZXJjYXNlIGxldHRlciAgXG4gKiAtIEF0IGxlYXN0IG9uZSBudW1iZXJcbiAqIC0gQXQgbGVhc3Qgb25lIHNwZWNpYWwgY2hhcmFjdGVyXG4gKi9cbmZ1bmN0aW9uIHZhbGlkYXRlUGFzc3dvcmRDb21wbGV4aXR5KHBhc3N3b3JkOiBzdHJpbmcpOiB7IHZhbGlkOiBib29sZWFuOyBlcnJvcnM6IHN0cmluZ1tdIH0ge1xuICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgICBcbiAgICBpZiAocGFzc3dvcmQubGVuZ3RoIDwgOCkge1xuICAgICAgICBlcnJvcnMucHVzaCgn67mE67CA67KI7Zi464qUIDjsnpAg7J207IOB7J207Ja07JW8IO2VqeuLiOuLpCcpO1xuICAgIH1cbiAgICBpZiAoIS9bQS1aXS8udGVzdChwYXNzd29yZCkpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ+uMgOusuOyekOulvCAx6rCcIOydtOyDgSDtj6ztlajtlbTslbwg7ZWp64uI64ukJyk7XG4gICAgfVxuICAgIGlmICghL1thLXpdLy50ZXN0KHBhc3N3b3JkKSkge1xuICAgICAgICBlcnJvcnMucHVzaCgn7IaM66y47J6Q66W8IDHqsJwg7J207IOBIO2PrO2VqO2VtOyVvCDtlanri4jri6QnKTtcbiAgICB9XG4gICAgaWYgKCEvWzAtOV0vLnRlc3QocGFzc3dvcmQpKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCfsiKvsnpDrpbwgMeqwnCDsnbTsg4Eg7Y+s7ZWo7ZW07JW8IO2VqeuLiOuLpCcpO1xuICAgIH1cbiAgICBpZiAoIS9bIUAjJCVeJiooKV8rXFwtPVxcW1xcXXt9Oyc6XCJcXFxcfCwuPD5cXC8/XS8udGVzdChwYXNzd29yZCkpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ+2KueyImOusuOyekOulvCAx6rCcIOydtOyDgSDtj6ztlajtlbTslbwg7ZWp64uI64ukJyk7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiB7IHZhbGlkOiBlcnJvcnMubGVuZ3RoID09PSAwLCBlcnJvcnMgfTtcbn1cblxuZXhwb3J0IGNsYXNzIEF1dGhTZXJ2aWNlIHtcbiAgICBwcml2YXRlIHVzZXJNYW5hZ2VyID0gZ2V0VXNlck1hbmFnZXIoKTtcblxuICAgIC8qKlxuICAgICAqIO2ajOybkOqwgOyehVxuICAgICAqL1xuICAgIHJlZ2lzdGVyKGRhdGE6IFJlZ2lzdGVyUmVxdWVzdCk6IEF1dGhSZXN1bHQge1xuICAgICAgICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCwgcm9sZSB9ID0gZGF0YTtcblxuICAgICAgICAvLyDsnKDtmqjshLEg6rKA7IKsXG4gICAgICAgIGlmICghZW1haWwgfHwgIXBhc3N3b3JkKSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICfsnbTrqZTsnbzqs7wg67mE67CA67KI7Zi466W8IOyeheugpe2VmOyEuOyalCcgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHBhc3N3b3JkVmFsaWRhdGlvbiA9IHZhbGlkYXRlUGFzc3dvcmRDb21wbGV4aXR5KHBhc3N3b3JkKTtcbiAgICAgICAgaWYgKCFwYXNzd29yZFZhbGlkYXRpb24udmFsaWQpIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogcGFzc3dvcmRWYWxpZGF0aW9uLmVycm9ycy5qb2luKCcsICcpIH07XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBlbWFpbFJlZ2V4ID0gL15bXlxcc0BdK0BbXlxcc0BdK1xcLlteXFxzQF0rJC87XG4gICAgICAgIGlmICghZW1haWxSZWdleC50ZXN0KGVtYWlsKSkge1xuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAn7Jyg7Zqo7ZWcIOydtOuplOydvCDso7zshozrpbwg7J6F66Cl7ZWY7IS47JqUJyB9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdXNlciA9IHRoaXMudXNlck1hbmFnZXIuY3JlYXRlVXNlcih7IGVtYWlsLCBwYXNzd29yZCwgcm9sZSB9KTtcblxuICAgICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ+ydtOuvuCDrk7HroZ3rkJwg7J2066mU7J287J6F64uI64ukJyB9O1xuICAgICAgICB9XG5cbiAgICAgICAgbG9nLmluZm8oYO2ajOybkOqwgOyehSDsmYTro4w6ICR7ZW1haWx9YCk7XG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHVzZXIgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDroZzqt7jsnbhcbiAgICAgKi9cbiAgICBsb2dpbihkYXRhOiBMb2dpblJlcXVlc3QpOiBBdXRoUmVzdWx0IHtcbiAgICAgICAgY29uc3QgeyBlbWFpbCwgcGFzc3dvcmQgfSA9IGRhdGE7XG5cbiAgICAgICAgaWYgKCFlbWFpbCB8fCAhcGFzc3dvcmQpIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ+ydtOuplOydvOqzvCDruYTrsIDrsojtmLjrpbwg7J6F66Cl7ZWY7IS47JqUJyB9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdXNlciA9IHRoaXMudXNlck1hbmFnZXIuYXV0aGVudGljYXRlKGVtYWlsLCBwYXNzd29yZCk7XG5cbiAgICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICfsnbTrqZTsnbwg65iQ64qUIOu5hOuwgOuyiO2YuOqwgCDsmKzrsJTrpbTsp4Ag7JWK7Iq164uI64ukJyB9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdG9rZW4gPSBnZW5lcmF0ZVRva2VuKHVzZXIpO1xuICAgICAgICBsb2cuaW5mbyhg66Gc6re47J24IOyEseqztTogJHtlbWFpbH1gKTtcblxuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCB0b2tlbiwgdXNlciB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOu5hOuwgOuyiO2YuCDrs4Dqsr1cbiAgICAgKi9cbiAgICBjaGFuZ2VQYXNzd29yZChkYXRhOiBDaGFuZ2VQYXNzd29yZFJlcXVlc3QpOiBBdXRoUmVzdWx0IHtcbiAgICAgICAgY29uc3QgeyB1c2VySWQsIGN1cnJlbnRFbWFpbCwgY3VycmVudFBhc3N3b3JkLCBuZXdQYXNzd29yZCB9ID0gZGF0YTtcblxuICAgICAgICBpZiAoIWN1cnJlbnRQYXNzd29yZCB8fCAhbmV3UGFzc3dvcmQpIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ+2YhOyerCDruYTrsIDrsojtmLjsmYAg7IOIIOu5hOuwgOuyiO2YuOulvCDsnoXroKXtlZjshLjsmpQnIH07XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwYXNzd29yZFZhbGlkYXRpb24gPSB2YWxpZGF0ZVBhc3N3b3JkQ29tcGxleGl0eShuZXdQYXNzd29yZCk7XG4gICAgICAgIGlmICghcGFzc3dvcmRWYWxpZGF0aW9uLnZhbGlkKSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IHBhc3N3b3JkVmFsaWRhdGlvbi5lcnJvcnMuam9pbignLCAnKSB9O1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g7ZiE7J6sIOu5hOuwgOuyiO2YuCDtmZXsnbhcbiAgICAgICAgY29uc3QgdXNlciA9IHRoaXMudXNlck1hbmFnZXIuYXV0aGVudGljYXRlKGN1cnJlbnRFbWFpbCwgY3VycmVudFBhc3N3b3JkKTtcbiAgICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICftmITsnqwg67mE67CA67KI7Zi46rCAIOyYrOuwlOultOyngCDslYrsirXri4jri6QnIH07XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzdWNjZXNzID0gdGhpcy51c2VyTWFuYWdlci5jaGFuZ2VQYXNzd29yZCh1c2VySWQsIG5ld1Bhc3N3b3JkKTtcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzcyB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9BdXRoIOyCrOyaqeyekCDsg53shLEg65iQ64qUIOuwmO2ZmFxuICAgICAqL1xuICAgIGZpbmRPckNyZWF0ZU9BdXRoVXNlcihlbWFpbDogc3RyaW5nLCBwcm92aWRlcjogJ2dvb2dsZScgfCAnZ2l0aHViJyk6IEF1dGhSZXN1bHQge1xuICAgICAgICBsZXQgdXNlciA9IHRoaXMudXNlck1hbmFnZXIuZ2V0VXNlckJ5RW1haWwoZW1haWwpO1xuICAgICAgICBsZXQgcHVibGljVXNlciA9IHVzZXIgPyB0aGlzLnVzZXJNYW5hZ2VyLmdldFVzZXJCeUlkKHVzZXIuaWQpIDogbnVsbDtcblxuICAgICAgICBpZiAoIXB1YmxpY1VzZXIpIHtcbiAgICAgICAgICAgIC8vIE9BdXRoIOyCrOyaqeyekOuKlCDrnpzrjaQg67mE67CA67KI7Zi466GcIOyDneyEsVxuICAgICAgICAgICAgY29uc3QgcmFuZG9tUGFzc3dvcmQgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoMiwgMTUpO1xuXG4gICAgICAgICAgICAvLyDqtIDrpqzsnpAg7J2066mU7J28IOuqqeuhnSDtmZXsnbhcbiAgICAgICAgICAgIGNvbnN0IGFkbWluRW1haWxzID0gKHByb2Nlc3MuZW52LkFETUlOX0VNQUlMUyB8fCAnJylcbiAgICAgICAgICAgICAgICAuc3BsaXQoJywnKVxuICAgICAgICAgICAgICAgIC5tYXAoZSA9PiBlLnRvTG93ZXJDYXNlKCkudHJpbSgpKVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoZSA9PiBlKTtcbiAgICAgICAgICAgIGNvbnN0IHJvbGUgPSBhZG1pbkVtYWlscy5pbmNsdWRlcyhlbWFpbC50b0xvd2VyQ2FzZSgpKSA/ICdhZG1pbicgOiAndXNlcic7XG5cbiAgICAgICAgICAgIHB1YmxpY1VzZXIgPSB0aGlzLnVzZXJNYW5hZ2VyLmNyZWF0ZVVzZXIoe1xuICAgICAgICAgICAgICAgIGVtYWlsLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiByYW5kb21QYXNzd29yZCxcbiAgICAgICAgICAgICAgICByb2xlXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKCFwdWJsaWNVc2VyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAn7IKs7Jqp7J6QIOyDneyEsSDsi6TtjKgnIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxvZy5pbmZvKGBbT0F1dGhdICR7cHJvdmlkZXJ9IOyLoOq3nCDsgqzsmqnsnpAg7IOd7ISxOiAke2VtYWlsfWApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8g6riw7KG0IOqzhOyglSDqtIDrpqzsnpAg7Iq56rKpIOyytO2BrFxuICAgICAgICAgICAgY29uc3QgYWRtaW5FbWFpbHMgPSAocHJvY2Vzcy5lbnYuQURNSU5fRU1BSUxTIHx8ICcnKVxuICAgICAgICAgICAgICAgIC5zcGxpdCgnLCcpXG4gICAgICAgICAgICAgICAgLm1hcChlID0+IGUudG9Mb3dlckNhc2UoKS50cmltKCkpXG4gICAgICAgICAgICAgICAgLmZpbHRlcihlID0+IGUpO1xuXG4gICAgICAgICAgICBpZiAoYWRtaW5FbWFpbHMuaW5jbHVkZXMoZW1haWwudG9Mb3dlckNhc2UoKSkgJiYgcHVibGljVXNlci5yb2xlICE9PSAnYWRtaW4nKSB7XG4gICAgICAgICAgICAgICAgdGhpcy51c2VyTWFuYWdlci5jaGFuZ2VSb2xlKHB1YmxpY1VzZXIuaWQsICdhZG1pbicpO1xuICAgICAgICAgICAgICAgIHB1YmxpY1VzZXIucm9sZSA9ICdhZG1pbic7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB0b2tlbiA9IGdlbmVyYXRlVG9rZW4ocHVibGljVXNlcik7XG4gICAgICAgIGxvZy5pbmZvKGBbT0F1dGhdICR7cHJvdmlkZXJ9IOuhnOq3uOyduCDshLHqs7U6ICR7ZW1haWx9YCk7XG5cbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgdG9rZW4sIHVzZXI6IHB1YmxpY1VzZXIgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDsgqzsmqkg6rCA64ql7ZWcIE9BdXRoIO2UhOuhnOuwlOydtOuNlCDrqqnroZ1cbiAgICAgKi9cbiAgICBnZXRBdmFpbGFibGVQcm92aWRlcnMoKTogc3RyaW5nW10ge1xuICAgICAgICBjb25zdCBwcm92aWRlcnM6IHN0cmluZ1tdID0gW107XG5cbiAgICAgICAgaWYgKHByb2Nlc3MuZW52LkdPT0dMRV9DTElFTlRfSUQgJiYgcHJvY2Vzcy5lbnYuR09PR0xFX0NMSUVOVF9TRUNSRVQpIHtcbiAgICAgICAgICAgIHByb3ZpZGVycy5wdXNoKCdnb29nbGUnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocHJvY2Vzcy5lbnYuR0lUSFVCX0NMSUVOVF9JRCAmJiBwcm9jZXNzLmVudi5HSVRIVUJfQ0xJRU5UX1NFQ1JFVCkge1xuICAgICAgICAgICAgcHJvdmlkZXJzLnB1c2goJ2dpdGh1YicpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHByb3ZpZGVycztcbiAgICB9XG59XG5cbi8vIOyLseq4gO2GpCDsnbjsiqTthLTsiqRcbmxldCBhdXRoU2VydmljZTogQXV0aFNlcnZpY2UgfCBudWxsID0gbnVsbDtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldEF1dGhTZXJ2aWNlKCk6IEF1dGhTZXJ2aWNlIHtcbiAgICBpZiAoIWF1dGhTZXJ2aWNlKSB7XG4gICAgICAgIGF1dGhTZXJ2aWNlID0gbmV3IEF1dGhTZXJ2aWNlKCk7XG4gICAgfVxuICAgIHJldHVybiBhdXRoU2VydmljZTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==