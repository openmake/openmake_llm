{"file":"/Volumes/MAC_APP/openmake_llm/tests/unit/__tests__/mcp-routing.test.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/tests/unit/__tests__/mcp-routing.test.ts"],"sourcesContent":["/**\n * Dynamic MCP Routing 기능 테스트\n * \n * 테스트 항목:\n * 1. UserTier 연계\n * 2. tool-tiers (등급별 도구 접근)\n * 3. user-sandbox (사용자 데이터 격리)\n */\n\nimport { UserTier, PublicUser } from '../../../backend/api/src/data/user-manager';\nimport { TOOL_TIERS, canUseTool, getToolsForTier, getDefaultTierForRole } from '../../../backend/api/src/mcp/tool-tiers';\nimport { UserSandbox, UserContext, createUserContext } from '../../../backend/api/src/mcp/user-sandbox';\n\n// ============================================\n// 1. Tool Tiers 테스트\n// ============================================\n\ndescribe('Tool Tiers', () => {\n    describe('TOOL_TIERS 설정', () => {\n        it('free 등급은 기본 도구만 포함', () => {\n            expect(TOOL_TIERS.free).toContain('web_search');\n            expect(TOOL_TIERS.free).toContain('vision_ocr');\n            expect(TOOL_TIERS.free).not.toContain('run_command');\n        });\n\n        it('pro 등급은 고급 도구 포함', () => {\n            expect(TOOL_TIERS.pro).toContain('run_command');\n            expect(TOOL_TIERS.pro).toContain('firecrawl_*');\n        });\n\n        it('enterprise 등급은 모든 도구 허용', () => {\n            expect(TOOL_TIERS.enterprise).toContain('*');\n        });\n    });\n\n    describe('canUseTool', () => {\n        it('free 사용자는 web_search 사용 가능', () => {\n            expect(canUseTool('free', 'web_search')).toBe(true);\n        });\n\n        it('free 사용자는 run_command 사용 불가', () => {\n            expect(canUseTool('free', 'run_command')).toBe(false);\n        });\n\n        it('pro 사용자는 run_command 사용 가능', () => {\n            expect(canUseTool('pro', 'run_command')).toBe(true);\n        });\n\n        it('pro 사용자는 firecrawl_* 와일드카드 매칭', () => {\n            expect(canUseTool('pro', 'firecrawl_scrape')).toBe(true);\n            expect(canUseTool('pro', 'firecrawl_crawl')).toBe(true);\n        });\n\n        it('enterprise 사용자는 모든 도구 사용 가능', () => {\n            expect(canUseTool('enterprise', 'web_search')).toBe(true);\n            expect(canUseTool('enterprise', 'run_command')).toBe(true);\n            expect(canUseTool('enterprise', 'any_random_tool')).toBe(true);\n        });\n    });\n\n    describe('getToolsForTier', () => {\n        const allTools = ['web_search', 'vision_ocr', 'run_command', 'firecrawl_scrape', 'secret_tool'];\n\n        it('free 등급은 허용된 도구만 반환', () => {\n            const tools = getToolsForTier('free', allTools);\n            expect(tools).toContain('web_search');\n            expect(tools).toContain('vision_ocr');\n            expect(tools).not.toContain('run_command');\n        });\n\n        it('enterprise 등급은 모든 도구 반환', () => {\n            const tools = getToolsForTier('enterprise', allTools);\n            expect(tools).toEqual(allTools);\n        });\n    });\n\n    describe('getDefaultTierForRole', () => {\n        it('admin은 enterprise tier', () => {\n            expect(getDefaultTierForRole('admin')).toBe('enterprise');\n        });\n\n        it('user는 free tier', () => {\n            expect(getDefaultTierForRole('user')).toBe('free');\n        });\n\n        it('guest는 free tier', () => {\n            expect(getDefaultTierForRole('guest')).toBe('free');\n        });\n    });\n});\n\n// ============================================\n// 2. User Sandbox 테스트\n// ============================================\n\ndescribe('User Sandbox', () => {\n    const testUserId = 'test_user_123';\n\n    describe('경로 생성', () => {\n        it('작업 디렉토리 경로 생성', () => {\n            const workDir = UserSandbox.getWorkDir(testUserId);\n            expect(workDir).toContain(testUserId);\n            expect(workDir).toContain('workspace');\n        });\n\n        it('데이터 디렉토리 경로 생성', () => {\n            const dataDir = UserSandbox.getDataDir(testUserId);\n            expect(dataDir).toContain(testUserId);\n            expect(dataDir).toContain('data');\n        });\n\n        it('SQLite DB 경로 생성', () => {\n            const dbPath = UserSandbox.getUserDbPath(testUserId);\n            expect(dbPath).toContain(testUserId);\n            expect(dbPath).toContain('user.db');\n        });\n\n        it('대화 DB 경로 생성', () => {\n            const dbPath = UserSandbox.getUserConversationDbPath(testUserId);\n            expect(dbPath).toContain('conversations.db');\n        });\n    });\n\n    describe('경로 검증 (보안)', () => {\n        it('사용자 디렉토리 내 경로는 허용', () => {\n            const userRoot = UserSandbox.getWorkDir(testUserId);\n            const validPath = `${userRoot}/test.txt`;\n            expect(UserSandbox.validatePath(testUserId, validPath)).toBe(true);\n        });\n\n        it('사용자 디렉토리 외부 접근 차단', () => {\n            expect(UserSandbox.validatePath(testUserId, '/etc/passwd')).toBe(false);\n            expect(UserSandbox.validatePath(testUserId, '/root/.ssh')).toBe(false);\n        });\n\n        it('상대 경로 탈출 시도 차단', () => {\n            const result = UserSandbox.resolvePath(testUserId, '../../../etc/passwd');\n            // 경로 탈출 시 null 반환\n            expect(result === null || !result.includes('/etc/passwd')).toBe(true);\n        });\n    });\n\n    describe('사용자 컨텍스트', () => {\n        it('컨텍스트 생성', () => {\n            const context = createUserContext(1, 'pro', 'user', 'org123');\n            expect(context.userId).toBe(1);\n            expect(context.tier).toBe('pro');\n            expect(context.role).toBe('user');\n            expect(context.orgId).toBe('org123');\n        });\n    });\n});\n\n// ============================================\n// 테스트 실행\n// ============================================\n\nconsole.log('테스트 시작...');\n"],"version":3}