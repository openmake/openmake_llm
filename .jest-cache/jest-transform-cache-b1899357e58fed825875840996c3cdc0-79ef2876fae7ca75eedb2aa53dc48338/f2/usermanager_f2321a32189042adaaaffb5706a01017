4be6490fa98cce31bddae57a2d3c8a82
"use strict";
/**
 * User Manager
 * backend/apiÏóêÏÑú ÏÇ¨Ïö©ÌïòÎäî UserManager ÎûòÌçº
 *
 * üîí Î≥¥Ïïà Í∞ïÌôî: bcryptÎ•º ÏÇ¨Ïö©Ìïú ÎπÑÎ∞ÄÎ≤àÌò∏ Ìï¥Ïã± Ï†ÅÏö©
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.getUserManager = getUserManager;
const bcrypt = require("bcryptjs");
// ÎπÑÎ∞ÄÎ≤àÌò∏ Ìï¥Ïã± ÎùºÏö¥Îìú (ÎÜíÏùÑÏàòÎ°ù ÏïàÏ†ÑÌïòÏßÄÎßå ÎäêÎ¶º)
const BCRYPT_ROUNDS = 12;
/**
 * Ïù∏Î©îÎ™®Î¶¨ UserManager
 */
class UserManagerImpl {
    constructor() {
        this.users = new Map();
        this.nextId = 1;
        // üîí Î≥¥Ïïà Í∞ïÌôî: ÌôòÍ≤ΩÎ≥ÄÏàò ÌïÑÏàòÌôî, Í∏∞Î≥∏ ÎπÑÎ∞ÄÎ≤àÌò∏ Ï†úÍ±∞
        const adminPassword = process.env.ADMIN_PASSWORD;
        if (!adminPassword) {
            console.warn('[UserManager] ‚ö†Ô∏è ADMIN_PASSWORD ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!');
            console.warn('[UserManager] Í∏∞Î≥∏ Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ïÏù¥ ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏäµÎãàÎã§. .env ÌååÏùºÏóê ADMIN_PASSWORDÎ•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.');
            if (process.env.NODE_ENV === 'production') {
                throw new Error('[UserManager] ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤ΩÏóêÏÑúÎäî ADMIN_PASSWORD ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÌïÑÏàòÏûÖÎãàÎã§!');
            }
            // Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÏÑúÎßå ÏûÑÏãú ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÉùÏÑ± (ÎûúÎç§)
            const tempPassword = require('crypto').randomBytes(16).toString('hex');
            console.warn(`[UserManager] Í∞úÎ∞ú ÌôòÍ≤Ω ÏûÑÏãú ÎπÑÎ∞ÄÎ≤àÌò∏: ${tempPassword}`);
            this.createUserSync({
                email: 'admin',
                password: tempPassword,
                role: 'admin'
            });
        }
        else {
            this.createUserSync({
                email: 'admin',
                password: adminPassword,
                role: 'admin'
            });
        }
    }
    // ÎèôÍ∏∞ Î≤ÑÏ†Ñ (ÏÉùÏÑ±ÏûêÏóêÏÑú ÏÇ¨Ïö©)
    createUserSync(input) {
        for (const user of this.users.values()) {
            if (user.email === input.email)
                return null;
        }
        const id = this.nextId++;
        const tier = input.tier || (input.role === 'admin' ? 'enterprise' : 'free');
        // üîí bcryptÎ°ú ÎπÑÎ∞ÄÎ≤àÌò∏ Ìï¥Ïã± (ÎèôÍ∏∞ Î≤ÑÏ†Ñ)
        const passwordHash = bcrypt.hashSync(input.password, BCRYPT_ROUNDS);
        const user = {
            id,
            email: input.email,
            password: passwordHash,
            role: input.role || 'user',
            tier,
            is_active: true,
            created_at: new Date().toISOString()
        };
        this.users.set(id, user);
        return this.toPublicUser(user);
    }
    createUser(input) {
        for (const user of this.users.values()) {
            if (user.email === input.email)
                return null;
        }
        const id = this.nextId++;
        // admin Ïó≠Ìï†ÏùÄ ÏûêÎèôÏúºÎ°ú enterprise tier
        const tier = input.tier || (input.role === 'admin' ? 'enterprise' : 'free');
        // üîí bcryptÎ°ú ÎπÑÎ∞ÄÎ≤àÌò∏ Ìï¥Ïã±
        const passwordHash = bcrypt.hashSync(input.password, BCRYPT_ROUNDS);
        const user = {
            id,
            email: input.email,
            password: passwordHash, // Ìï¥Ïã±Îêú ÎπÑÎ∞ÄÎ≤àÌò∏ Ï†ÄÏû•
            role: input.role || 'user',
            tier,
            is_active: true,
            created_at: new Date().toISOString()
        };
        this.users.set(id, user);
        return this.toPublicUser(user);
    }
    authenticate(email, password) {
        for (const user of this.users.values()) {
            // üîí bcryptÎ°ú ÎπÑÎ∞ÄÎ≤àÌò∏ ÎπÑÍµê (Ìï¥Ïãú ÎπÑÍµê)
            if (user.email === email && bcrypt.compareSync(password, user.password) && user.is_active) {
                user.last_login = new Date().toISOString();
                return this.toPublicUser(user);
            }
        }
        return null;
    }
    getUserById(id) {
        const user = this.users.get(id);
        return user ? this.toPublicUser(user) : null;
    }
    getUserByEmail(email) {
        for (const user of this.users.values()) {
            if (user.email === email)
                return user;
        }
        return null;
    }
    getAllUsers(options) {
        let users = Array.from(this.users.values());
        if (options === null || options === void 0 ? void 0 : options.role)
            users = users.filter(u => u.role === options.role);
        if (options === null || options === void 0 ? void 0 : options.search) {
            const search = options.search.toLowerCase();
            users = users.filter(u => u.email.toLowerCase().includes(search));
        }
        const total = users.length;
        const page = (options === null || options === void 0 ? void 0 : options.page) || 1;
        const limit = (options === null || options === void 0 ? void 0 : options.limit) || 20;
        const start = (page - 1) * limit;
        return { users: users.slice(start, start + limit).map(u => this.toPublicUser(u)), total, page, limit };
    }
    changePassword(userId, newPassword) {
        const user = this.users.get(userId);
        if (!user)
            return false;
        // üîí ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ÎèÑ Ìï¥Ïã±ÌïòÏó¨ Ï†ÄÏû•
        user.password = bcrypt.hashSync(newPassword, BCRYPT_ROUNDS);
        return true;
    }
    changeRole(userId, newRole) {
        const user = this.users.get(userId);
        if (!user)
            return null;
        user.role = newRole;
        return this.toPublicUser(user);
    }
    updateUser(userId, updates) {
        const user = this.users.get(userId);
        if (!user)
            return null;
        if (updates.email !== undefined)
            user.email = updates.email;
        if (updates.role !== undefined)
            user.role = updates.role;
        if (updates.is_active !== undefined)
            user.is_active = updates.is_active;
        return this.toPublicUser(user);
    }
    deleteUser(userId) {
        const user = this.users.get(userId);
        if (!user)
            return false;
        if (user.role === 'admin') {
            const adminCount = Array.from(this.users.values()).filter(u => u.role === 'admin').length;
            if (adminCount <= 1)
                return false;
        }
        return this.users.delete(userId);
    }
    getStats() {
        const users = Array.from(this.users.values());
        return {
            totalUsers: users.length,
            activeUsers: users.filter(u => u.is_active).length,
            adminCount: users.filter(u => u.role === 'admin').length,
            userCount: users.filter(u => u.role === 'user').length,
            guestCount: users.filter(u => u.role === 'guest').length
        };
    }
    toPublicUser(user) {
        return { id: user.id, email: user.email, role: user.role, tier: user.tier, is_active: user.is_active, created_at: user.created_at, last_login: user.last_login };
    }
    // ÏÇ¨Ïö©Ïûê tier Î≥ÄÍ≤Ω
    changeTier(userId, newTier) {
        const user = this.users.get(userId);
        if (!user)
            return null;
        user.tier = newTier;
        return this.toPublicUser(user);
    }
}
let userManagerInstance = null;
function getUserManager() {
    if (!userManagerInstance)
        userManagerInstance = new UserManagerImpl();
    return userManagerInstance;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL2RhdGEvdXNlci1tYW5hZ2VyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7QUErTUgsd0NBR0M7QUFoTkQsbUNBQW1DO0FBRW5DLDhCQUE4QjtBQUM5QixNQUFNLGFBQWEsR0FBRyxFQUFFLENBQUM7QUF3QnpCOztHQUVHO0FBQ0gsTUFBTSxlQUFlO0lBSWpCO1FBSFEsVUFBSyxHQUE4SixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzdLLFdBQU0sR0FBRyxDQUFDLENBQUM7UUFHZixpQ0FBaUM7UUFDakMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7UUFDakQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ2pCLE9BQU8sQ0FBQyxJQUFJLENBQUMsbURBQW1ELENBQUMsQ0FBQztZQUNsRSxPQUFPLENBQUMsSUFBSSxDQUFDLHFFQUFxRSxDQUFDLENBQUM7WUFDcEYsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxZQUFZLEVBQUUsQ0FBQztnQkFDeEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxzREFBc0QsQ0FBQyxDQUFDO1lBQzVFLENBQUM7WUFDRCwyQkFBMkI7WUFDM0IsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDdkUsT0FBTyxDQUFDLElBQUksQ0FBQyxnQ0FBZ0MsWUFBWSxFQUFFLENBQUMsQ0FBQztZQUM3RCxJQUFJLENBQUMsY0FBYyxDQUFDO2dCQUNoQixLQUFLLEVBQUUsT0FBTztnQkFDZCxRQUFRLEVBQUUsWUFBWTtnQkFDdEIsSUFBSSxFQUFFLE9BQU87YUFDaEIsQ0FBQyxDQUFDO1FBQ1AsQ0FBQzthQUFNLENBQUM7WUFDSixJQUFJLENBQUMsY0FBYyxDQUFDO2dCQUNoQixLQUFLLEVBQUUsT0FBTztnQkFD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VUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUNySyxDQUFDO0lBRUQsY0FBYztJQUNkLFVBQVUsQ0FBQyxNQUFjLEVBQUUsT0FBaUI7UUFDeEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLElBQUk7WUFBRSxPQUFPLElBQUksQ0FBQztRQUN2QixJQUFJLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztRQUNwQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkMsQ0FBQztDQUNKO0FBRUQsSUFBSSxtQkFBbUIsR0FBMkIsSUFBSSxDQUFDO0FBRXZELFNBQWdCLGNBQWM7SUFDMUIsSUFBSSxDQUFDLG1CQUFtQjtRQUFFLG1CQUFtQixHQUFHLElBQUksZUFBZSxFQUFFLENBQUM7SUFDdEUsT0FBTyxtQkFBbUIsQ0FBQztBQUMvQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Wb2x1bWVzL01BQ19BUFAvb3Blbm1ha2VfbGxtL2JhY2tlbmQvYXBpL3NyYy9kYXRhL3VzZXItbWFuYWdlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFVzZXIgTWFuYWdlclxuICogYmFja2VuZC9hcGnsl5DshJwg7IKs7Jqp7ZWY64qUIFVzZXJNYW5hZ2VyIOuemO2NvFxuICogXG4gKiDwn5SSIOuztOyViCDqsJXtmZQ6IGJjcnlwdOulvCDsgqzsmqntlZwg67mE67CA67KI7Zi4IO2VtOyLsSDsoIHsmqlcbiAqL1xuXG5pbXBvcnQgKiBhcyBiY3J5cHQgZnJvbSAnYmNyeXB0anMnO1xuXG4vLyDruYTrsIDrsojtmLgg7ZW07IuxIOudvOyatOuTnCAo64aS7J2E7IiY66GdIOyViOyghO2VmOyngOunjCDripDrprwpXG5jb25zdCBCQ1JZUFRfUk9VTkRTID0gMTI7XG5cbmV4cG9ydCB0eXBlIFVzZXJSb2xlID0gJ2FkbWluJyB8ICd1c2VyJyB8ICdndWVzdCc7XG5cbi8vIE1DUCDrj4Tqtawg7KCR6re8IOuTseq4iVxuZXhwb3J0IHR5cGUgVXNlclRpZXIgPSAnZnJlZScgfCAncHJvJyB8ICdlbnRlcnByaXNlJztcblxuZXhwb3J0IGludGVyZmFjZSBQdWJsaWNVc2VyIHtcbiAgICBpZDogbnVtYmVyO1xuICAgIGVtYWlsOiBzdHJpbmc7XG4gICAgcm9sZTogVXNlclJvbGU7XG4gICAgdGllcjogVXNlclRpZXI7XG4gICAgY3JlYXRlZF9hdDogc3RyaW5nO1xuICAgIGxhc3RfbG9naW4/OiBzdHJpbmc7XG4gICAgaXNfYWN0aXZlOiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENyZWF0ZVVzZXJJbnB1dCB7XG4gICAgZW1haWw6IHN0cmluZztcbiAgICBwYXNzd29yZDogc3RyaW5nO1xuICAgIHJvbGU/OiBVc2VyUm9sZTtcbiAgICB0aWVyPzogVXNlclRpZXI7XG59XG5cbi8qKlxuICog7J2466mU66qo66asIFVzZXJNYW5hZ2VyXG4gKi9cbmNsYXNzIFVzZXJNYW5hZ2VySW1wbCB7XG4gICAgcHJpdmF0ZSB1c2VyczogTWFwPG51bWJlciwgeyBpZDogbnVtYmVyOyBlbWFpbDogc3RyaW5nOyBwYXNzd29yZDogc3RyaW5nOyByb2xlOiBVc2VyUm9sZTsgdGllcjogVXNlclRpZXI7IGlzX2FjdGl2ZTogYm9vbGVhbjsgY3JlYXRlZF9hdDogc3RyaW5nOyBsYXN0X2xvZ2luPzogc3RyaW5nIH0+ID0gbmV3IE1hcCgpO1xuICAgIHByaXZhdGUgbmV4dElkID0gMTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICAvLyDwn5SSIOuztOyViCDqsJXtmZQ6IO2ZmOqyveuzgOyImCDtlYTsiJjtmZQsIOq4sOuzuCDruYTrsIDrsojtmLgg7KCc6rGwXG4gICAgICAgIGNvbnN0IGFkbWluUGFzc3dvcmQgPSBwcm9jZXNzLmVudi5BRE1JTl9QQVNTV09SRDtcbiAgICAgICAgaWYgKCFhZG1pblBhc3N3b3JkKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ1tVc2VyTWFuYWdlcl0g4pqg77iPIEFETUlOX1BBU1NXT1JEIO2ZmOqyveuzgOyImOqwgCDshKTsoJXrkJjsp4Ag7JWK7JWY7Iq164uI64ukIScpO1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdbVXNlck1hbmFnZXJdIOq4sOuzuCDqtIDrpqzsnpAg6rOE7KCV7J20IOyDneyEseuQmOyngCDslYrsirXri4jri6QuIC5lbnYg7YyM7J287JeQIEFETUlOX1BBU1NXT1JE66W8IOyEpOygle2VmOyEuOyalC4nKTtcbiAgICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdbVXNlck1hbmFnZXJdIO2UhOuhnOuNleyFmCDtmZjqsr3sl5DshJzripQgQURNSU5fUEFTU1dPUkQg7ZmY6rK967OA7IiY6rCAIO2VhOyImOyeheuLiOuLpCEnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIOqwnOuwnCDtmZjqsr3sl5DshJzrp4wg7J6E7IucIOu5hOuwgOuyiO2YuCDsg53shLEgKOuenOuNpClcbiAgICAgICAgICAgIGNvbnN0IHRlbXBQYXNzd29yZCA9IHJlcXVpcmUoJ2NyeXB0bycpLnJhbmRvbUJ5dGVzKDE2KS50b1N0cmluZygnaGV4Jyk7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYFtVc2VyTWFuYWdlcl0g6rCc67CcIO2ZmOqyvSDsnoTsi5wg67mE67CA67KI7Zi4OiAke3RlbXBQYXNzd29yZH1gKTtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlVXNlclN5bmMoe1xuICAgICAgICAgICAgICAgIGVtYWlsOiAnYWRtaW4nLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB0ZW1wUGFzc3dvcmQsXG4gICAgICAgICAgICAgICAgcm9sZTogJ2FkbWluJ1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNyZWF0ZVVzZXJTeW5jKHtcbiAgICAgICAgICAgICAgICBlbWFpbDogJ2FkbWluJyxcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogYWRtaW5QYXNzd29yZCxcbiAgICAgICAgICAgICAgICByb2xlOiAnYWRtaW4nXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIOuPmeq4sCDrsoTsoIQgKOyDneyEseyekOyXkOyEnCDsgqzsmqkpXG4gICAgcHJpdmF0ZSBjcmVhdGVVc2VyU3luYyhpbnB1dDogQ3JlYXRlVXNlcklucHV0KTogUHVibGljVXNlciB8IG51bGwge1xuICAgICAgICBmb3IgKGNvbnN0IHVzZXIgb2YgdGhpcy51c2Vycy52YWx1ZXMoKSkge1xuICAgICAgICAgICAgaWYgKHVzZXIuZW1haWwgPT09IGlucHV0LmVtYWlsKSByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBpZCA9IHRoaXMubmV4dElkKys7XG4gICAgICAgIGNvbnN0IHRpZXIgPSBpbnB1dC50aWVyIHx8IChpbnB1dC5yb2xlID09PSAnYWRtaW4nID8gJ2VudGVycHJpc2UnIDogJ2ZyZWUnKTtcbiAgICAgICAgXG4gICAgICAgIC8vIPCflJIgYmNyeXB066GcIOu5hOuwgOuyiO2YuCDtlbTsi7EgKOuPmeq4sCDrsoTsoIQpXG4gICAgICAgIGNvbnN0IHBhc3N3b3JkSGFzaCA9IGJjcnlwdC5oYXNoU3luYyhpbnB1dC5wYXNzd29yZCwgQkNSWVBUX1JPVU5EUyk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCB1c2VyID0ge1xuICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICBlbWFpbDogaW5wdXQuZW1haWwsXG4gICAgICAgICAgICBwYXNzd29yZDogcGFzc3dvcmRIYXNoLFxuICAgICAgICAgICAgcm9sZTogaW5wdXQucm9sZSB8fCAndXNlcicgYXMgVXNlclJvbGUsXG4gICAgICAgICAgICB0aWVyLFxuICAgICAgICAgICAgaXNfYWN0aXZlOiB0cnVlLFxuICAgICAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMudXNlcnMuc2V0KGlkLCB1c2VyKTtcbiAgICAgICAgcmV0dXJuIHRoaXMudG9QdWJsaWNVc2VyKHVzZXIpO1xuICAgIH1cblxuICAgIGNyZWF0ZVVzZXIoaW5wdXQ6IENyZWF0ZVVzZXJJbnB1dCk6IFB1YmxpY1VzZXIgfCBudWxsIHtcbiAgICAgICAgZm9yIChjb25zdCB1c2VyIG9mIHRoaXMudXNlcnMudmFsdWVzKCkpIHtcbiAgICAgICAgICAgIGlmICh1c2VyLmVtYWlsID09PSBpbnB1dC5lbWFpbCkgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgaWQgPSB0aGlzLm5leHRJZCsrO1xuICAgICAgICAvLyBhZG1pbiDsl63tlaDsnYAg7J6Q64+Z7Jy866GcIGVudGVycHJpc2UgdGllclxuICAgICAgICBjb25zdCB0aWVyID0gaW5wdXQudGllciB8fCAoaW5wdXQucm9sZSA9PT0gJ2FkbWluJyA/ICdlbnRlcnByaXNlJyA6ICdmcmVlJyk7XG4gICAgICAgIFxuICAgICAgICAvLyDwn5SSIGJjcnlwdOuhnCDruYTrsIDrsojtmLgg7ZW07IuxXG4gICAgICAgIGNvbnN0IHBhc3N3b3JkSGFzaCA9IGJjcnlwdC5oYXNoU3luYyhpbnB1dC5wYXNzd29yZCwgQkNSWVBUX1JPVU5EUyk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCB1c2VyID0ge1xuICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICBlbWFpbDogaW5wdXQuZW1haWwsXG4gICAgICAgICAgICBwYXNzd29yZDogcGFzc3dvcmRIYXNoLCAgLy8g7ZW07Iux65CcIOu5hOuwgOuyiO2YuCDsoIDsnqVcbiAgICAgICAgICAgIHJvbGU6IGlucHV0LnJvbGUgfHwgJ3VzZXInIGFzIFVzZXJSb2xlLFxuICAgICAgICAgICAgdGllcixcbiAgICAgICAgICAgIGlzX2FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnVzZXJzLnNldChpZCwgdXNlcik7XG4gICAgICAgIHJldHVybiB0aGlzLnRvUHVibGljVXNlcih1c2VyKTtcbiAgICB9XG5cbiAgICBhdXRoZW50aWNhdGUoZW1haWw6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZyk6IFB1YmxpY1VzZXIgfCBudWxsIHtcbiAgICAgICAgZm9yIChjb25zdCB1c2VyIG9mIHRoaXMudXNlcnMudmFsdWVzKCkpIHtcbiAgICAgICAgICAgIC8vIPCflJIgYmNyeXB066GcIOu5hOuwgOuyiO2YuCDruYTqtZAgKO2VtOyLnCDruYTqtZApXG4gICAgICAgICAgICBpZiAodXNlci5lbWFpbCA9PT0gZW1haWwgJiYgYmNyeXB0LmNvbXBhcmVTeW5jKHBhc3N3b3JkLCB1c2VyLnBhc3N3b3JkKSAmJiB1c2VyLmlzX2FjdGl2ZSkge1xuICAgICAgICAgICAgICAgIHVzZXIubGFzdF9sb2dpbiA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50b1B1YmxpY1VzZXIodXNlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgZ2V0VXNlckJ5SWQoaWQ6IG51bWJlcik6IFB1YmxpY1VzZXIgfCBudWxsIHtcbiAgICAgICAgY29uc3QgdXNlciA9IHRoaXMudXNlcnMuZ2V0KGlkKTtcbiAgICAgICAgcmV0dXJuIHVzZXIgPyB0aGlzLnRvUHVibGljVXNlcih1c2VyKSA6IG51bGw7XG4gICAgfVxuXG4gICAgZ2V0VXNlckJ5RW1haWwoZW1haWw6IHN0cmluZyk6IHsgaWQ6IG51bWJlcjsgZW1haWw6IHN0cmluZzsgcGFzc3dvcmQ6IHN0cmluZzsgcm9sZTogVXNlclJvbGUgfSB8IG51bGwge1xuICAgICAgICBmb3IgKGNvbnN0IHVzZXIgb2YgdGhpcy51c2Vycy52YWx1ZXMoKSkge1xuICAgICAgICAgICAgaWYgKHVzZXIuZW1haWwgPT09IGVtYWlsKSByZXR1cm4gdXNlcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBnZXRBbGxVc2VycyhvcHRpb25zPzogeyBwYWdlPzogbnVtYmVyOyBsaW1pdD86IG51bWJlcjsgcm9sZT86IFVzZXJSb2xlOyBzZWFyY2g/OiBzdHJpbmcgfSk6IHsgdXNlcnM6IFB1YmxpY1VzZXJbXTsgdG90YWw6IG51bWJlcjsgcGFnZTogbnVtYmVyOyBsaW1pdDogbnVtYmVyIH0ge1xuICAgICAgICBsZXQgdXNlcnMgPSBBcnJheS5mcm9tKHRoaXMudXNlcnMudmFsdWVzKCkpO1xuICAgICAgICBpZiAob3B0aW9ucz8ucm9sZSkgdXNlcnMgPSB1c2Vycy5maWx0ZXIodSA9PiB1LnJvbGUgPT09IG9wdGlvbnMucm9sZSk7XG4gICAgICAgIGlmIChvcHRpb25zPy5zZWFyY2gpIHtcbiAgICAgICAgICAgIGNvbnN0IHNlYXJjaCA9IG9wdGlvbnMuc2VhcmNoLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICB1c2VycyA9IHVzZXJzLmZpbHRlcih1ID0+IHUuZW1haWwudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhzZWFyY2gpKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB0b3RhbCA9IHVzZXJzLmxlbmd0aDtcbiAgICAgICAgY29uc3QgcGFnZSA9IG9wdGlvbnM/LnBhZ2UgfHwgMTtcbiAgICAgICAgY29uc3QgbGltaXQgPSBvcHRpb25zPy5saW1pdCB8fCAyMDtcbiAgICAgICAgY29uc3Qgc3RhcnQgPSAocGFnZSAtIDEpICogbGltaXQ7XG4gICAgICAgIHJldHVybiB7IHVzZXJzOiB1c2Vycy5zbGljZShzdGFydCwgc3RhcnQgKyBsaW1pdCkubWFwKHUgPT4gdGhpcy50b1B1YmxpY1VzZXIodSkpLCB0b3RhbCwgcGFnZSwgbGltaXQgfTtcbiAgICB9XG5cbiAgICBjaGFuZ2VQYXNzd29yZCh1c2VySWQ6IG51bWJlciwgbmV3UGFzc3dvcmQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCB1c2VyID0gdGhpcy51c2Vycy5nZXQodXNlcklkKTtcbiAgICAgICAgaWYgKCF1c2VyKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIC8vIPCflJIg7IOIIOu5hOuwgOuyiO2YuOuPhCDtlbTsi7HtlZjsl6wg7KCA7J6lXG4gICAgICAgIHVzZXIucGFzc3dvcmQgPSBiY3J5cHQuaGFzaFN5bmMobmV3UGFzc3dvcmQsIEJDUllQVF9ST1VORFMpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBjaGFuZ2VSb2xlKHVzZXJJZDogbnVtYmVyLCBuZXdSb2xlOiBVc2VyUm9sZSk6IFB1YmxpY1VzZXIgfCBudWxsIHtcbiAgICAgICAgY29uc3QgdXNlciA9IHRoaXMudXNlcnMuZ2V0KHVzZXJJZCk7XG4gICAgICAgIGlmICghdXNlcikgcmV0dXJuIG51bGw7XG4gICAgICAgIHVzZXIucm9sZSA9IG5ld1JvbGU7XG4gICAgICAgIHJldHVybiB0aGlzLnRvUHVibGljVXNlcih1c2VyKTtcbiAgICB9XG5cbiAgICB1cGRhdGVVc2VyKHVzZXJJZDogbnVtYmVyLCB1cGRhdGVzOiB7IGVtYWlsPzogc3RyaW5nOyByb2xlPzogVXNlclJvbGU7IGlzX2FjdGl2ZT86IGJvb2xlYW4gfSk6IFB1YmxpY1VzZXIgfCBudWxsIHtcbiAgICAgICAgY29uc3QgdXNlciA9IHRoaXMudXNlcnMuZ2V0KHVzZXJJZCk7XG4gICAgICAgIGlmICghdXNlcikgcmV0dXJuIG51bGw7XG4gICAgICAgIGlmICh1cGRhdGVzLmVtYWlsICE9PSB1bmRlZmluZWQpIHVzZXIuZW1haWwgPSB1cGRhdGVzLmVtYWlsO1xuICAgICAgICBpZiAodXBkYXRlcy5yb2xlICE9PSB1bmRlZmluZWQpIHVzZXIucm9sZSA9IHVwZGF0ZXMucm9sZTtcbiAgICAgICAgaWYgKHVwZGF0ZXMuaXNfYWN0aXZlICE9PSB1bmRlZmluZWQpIHVzZXIuaXNfYWN0aXZlID0gdXBkYXRlcy5pc19hY3RpdmU7XG4gICAgICAgIHJldHVybiB0aGlzLnRvUHVibGljVXNlcih1c2VyKTtcbiAgICB9XG5cbiAgICBkZWxldGVVc2VyKHVzZXJJZDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IHVzZXIgPSB0aGlzLnVzZXJzLmdldCh1c2VySWQpO1xuICAgICAgICBpZiAoIXVzZXIpIHJldHVybiBmYWxzZTtcbiAgICAgICAgaWYgKHVzZXIucm9sZSA9PT0gJ2FkbWluJykge1xuICAgICAgICAgICAgY29uc3QgYWRtaW5Db3VudCA9IEFycmF5LmZyb20odGhpcy51c2Vycy52YWx1ZXMoKSkuZmlsdGVyKHUgPT4gdS5yb2xlID09PSAnYWRtaW4nKS5sZW5ndGg7XG4gICAgICAgICAgICBpZiAoYWRtaW5Db3VudCA8PSAxKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMudXNlcnMuZGVsZXRlKHVzZXJJZCk7XG4gICAgfVxuXG4gICAgZ2V0U3RhdHMoKSB7XG4gICAgICAgIGNvbnN0IHVzZXJzID0gQXJyYXkuZnJvbSh0aGlzLnVzZXJzLnZhbHVlcygpKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRvdGFsVXNlcnM6IHVzZXJzLmxlbmd0aCxcbiAgICAgICAgICAgIGFjdGl2ZVVzZXJzOiB1c2Vycy5maWx0ZXIodSA9PiB1LmlzX2FjdGl2ZSkubGVuZ3RoLFxuICAgICAgICAgICAgYWRtaW5Db3VudDogdXNlcnMuZmlsdGVyKHUgPT4gdS5yb2xlID09PSAnYWRtaW4nKS5sZW5ndGgsXG4gICAgICAgICAgICB1c2VyQ291bnQ6IHVzZXJzLmZpbHRlcih1ID0+IHUucm9sZSA9PT0gJ3VzZXInKS5sZW5ndGgsXG4gICAgICAgICAgICBndWVzdENvdW50OiB1c2Vycy5maWx0ZXIodSA9PiB1LnJvbGUgPT09ICdndWVzdCcpLmxlbmd0aFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgdG9QdWJsaWNVc2VyKHVzZXI6IGFueSk6IFB1YmxpY1VzZXIge1xuICAgICAgICByZXR1cm4geyBpZDogdXNlci5pZCwgZW1haWw6IHVzZXIuZW1haWwsIHJvbGU6IHVzZXIucm9sZSwgdGllcjogdXNlci50aWVyLCBpc19hY3RpdmU6IHVzZXIuaXNfYWN0aXZlLCBjcmVhdGVkX2F0OiB1c2VyLmNyZWF0ZWRfYXQsIGxhc3RfbG9naW46IHVzZXIubGFzdF9sb2dpbiB9O1xuICAgIH1cblxuICAgIC8vIOyCrOyaqeyekCB0aWVyIOuzgOqyvVxuICAgIGNoYW5nZVRpZXIodXNlcklkOiBudW1iZXIsIG5ld1RpZXI6IFVzZXJUaWVyKTogUHVibGljVXNlciB8IG51bGwge1xuICAgICAgICBjb25zdCB1c2VyID0gdGhpcy51c2Vycy5nZXQodXNlcklkKTtcbiAgICAgICAgaWYgKCF1c2VyKSByZXR1cm4gbnVsbDtcbiAgICAgICAgdXNlci50aWVyID0gbmV3VGllcjtcbiAgICAgICAgcmV0dXJuIHRoaXMudG9QdWJsaWNVc2VyKHVzZXIpO1xuICAgIH1cbn1cblxubGV0IHVzZXJNYW5hZ2VySW5zdGFuY2U6IFVzZXJNYW5hZ2VySW1wbCB8IG51bGwgPSBudWxsO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VXNlck1hbmFnZXIoKTogVXNlck1hbmFnZXJJbXBsIHtcbiAgICBpZiAoIXVzZXJNYW5hZ2VySW5zdGFuY2UpIHVzZXJNYW5hZ2VySW5zdGFuY2UgPSBuZXcgVXNlck1hbmFnZXJJbXBsKCk7XG4gICAgcmV0dXJuIHVzZXJNYW5hZ2VySW5zdGFuY2U7XG59XG4iXSwidmVyc2lvbiI6M30=