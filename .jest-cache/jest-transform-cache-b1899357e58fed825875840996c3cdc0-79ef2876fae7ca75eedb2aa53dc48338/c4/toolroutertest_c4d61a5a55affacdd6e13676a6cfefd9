86e0ce775b2299d137f70688bb05fb29
"use strict";
/**
 * ToolRouter Unit Tests
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const bun_test_1 = require("bun:test");
const tool_router_1 = require("../tool-router");
const types_1 = require("../types");
(0, bun_test_1.describe)('ToolRouter', () => {
    let router;
    (0, bun_test_1.beforeEach)(() => {
        router = new tool_router_1.ToolRouter();
    });
    (0, bun_test_1.describe)('getAllTools', () => {
        (0, bun_test_1.it)('should include built-in tools', () => {
            const tools = router.getAllTools();
            (0, bun_test_1.expect)(tools.length).toBeGreaterThan(0);
            // ðŸ”’ ë³´ì•ˆ íŒ¨ì¹˜ 2026-02-07: run_command ì œê±°ë¨ â€” vision_ocrê°€ ë‚¨ì•„ìžˆì–´ì•¼ í•¨
            const visionOcr = tools.find(t => t.name === 'vision_ocr');
            (0, bun_test_1.expect)(visionOcr).toBeDefined();
            // run_commandëŠ” ë³´ì•ˆìƒ ì œê±°ë˜ì–´ ì¡´ìž¬í•˜ì§€ ì•Šì•„ì•¼ í•¨
            const runCommand = tools.find(t => t.name === 'run_command');
            (0, bun_test_1.expect)(runCommand).toBeUndefined();
        });
        (0, bun_test_1.it)('should include external tools after registration', () => {
            const mockTool = {
                name: 'list_tables',
                description: 'List database tables',
                inputSchema: { type: 'object', properties: {}, required: [] }
            };
            const mockExecutor = (_name, _args) => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: 'ok' }]
                });
            });
            router.registerExternalTools('server1', 'postgres', [mockTool], mockExecutor);
            const tools = router.getAllTools();
            const external = tools.find(t => t.name === `postgres${types_1.MCP_NAMESPACE_SEPARATOR}list_tables`);
            (0, bun_test_1.expect)(external).toBeDefined();
            (0, bun_test_1.expect)(external.description).toBe('List database tables');
        });
    });
    (0, bun_test_1.describe)('getToolsForTier', () => {
        (0, bun_test_1.it)('should filter tools for free tier', () => {
            const tools = router.getToolsForTier('free');
            // free tier has web_search, vision_ocr, analyze_image
            const names = tools.map(t => t.name);
            (0, bun_test_1.expect)(names).toContain('web_search');
        });
        (0, bun_test_1.it)('should exclude external tools for free tier', () => {
            const mockTool = {
                name: 'query',
                description: 'Run SQL',
                inputSchema: { type: 'object', properties: {}, required: [] }
            };
            router.registerExternalTools('s1', 'db', [mockTool], () => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: 'ok' }]
                });
            }));
            const freeTools = router.getToolsForTier('free');
            const hasExternal = freeTools.some(t => t.name.includes(types_1.MCP_NAMESPACE_SEPARATOR));
            (0, bun_test_1.expect)(hasExternal).toBe(false);
        });
        (0, bun_test_1.it)('should include external tools for enterprise tier', () => {
            const mockTool = {
                name: 'query',
                description: 'Run SQL',
                inputSchema: { type: 'object', properties: {}, required: [] }
            };
            router.registerExternalTools('s1', 'db', [mockTool], () => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: 'ok' }]
                });
            }));
            const entTools = router.getToolsForTier('enterprise');
            const external = entTools.find(t => t.name === `db${types_1.MCP_NAMESPACE_SEPARATOR}query`);
            (0, bun_test_1.expect)(external).toBeDefined();
        });
    });
    (0, bun_test_1.describe)('executeTool', () => {
        (0, bun_test_1.it)('should execute a built-in tool', () => __awaiter(void 0, void 0, void 0, function* () {
            // run_command is a built-in tool
            const result = yield router.executeTool('run_command', { command: 'echo hello' });
            (0, bun_test_1.expect)(result).toBeDefined();
            (0, bun_test_1.expect)(result.content).toBeDefined();
            (0, bun_test_1.expect)(result.content.length).toBeGreaterThan(0);
        }));
        (0, bun_test_1.it)('should execute an external tool', () => __awaiter(void 0, void 0, void 0, function* () {
            const mockTool = {
                name: 'ping',
                description: 'Ping service',
                inputSchema: { type: 'object', properties: {}, required: [] }
            };
            const mockExecutor = (name, _args) => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: `pong from ${name}` }]
                });
            });
            router.registerExternalTools('srv1', 'myserver', [mockTool], mockExecutor);
            const result = yield router.executeTool(`myserver${types_1.MCP_NAMESPACE_SEPARATOR}ping`, {});
            (0, bun_test_1.expect)(result.isError).toBeFalsy();
            (0, bun_test_1.expect)(result.content[0].text).toBe('pong from ping');
        }));
        (0, bun_test_1.it)('should return error for unknown tool', () => __awaiter(void 0, void 0, void 0, function* () {
            const result = yield router.executeTool('nonexistent_tool', {});
            (0, bun_test_1.expect)(result.isError).toBe(true);
        }));
        (0, bun_test_1.it)('should return error for unknown external tool', () => __awaiter(void 0, void 0, void 0, function* () {
            const result = yield router.executeTool(`unknown${types_1.MCP_NAMESPACE_SEPARATOR}tool`, {});
            (0, bun_test_1.expect)(result.isError).toBe(true);
        }));
    });
    (0, bun_test_1.describe)('registerExternalTools / unregisterExternalTools', () => {
        (0, bun_test_1.it)('should register and count external tools', () => {
            const tools = [
                { name: 'a', description: 'A', inputSchema: { type: 'object', properties: {}, required: [] } },
                { name: 'b', description: 'B', inputSchema: { type: 'object', properties: {}, required: [] } },
            ];
            router.registerExternalTools('s1', 'ext', tools, () => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: 'ok' }]
                });
            }));
            (0, bun_test_1.expect)(router.getExternalToolCount()).toBe(2);
        });
        (0, bun_test_1.it)('should unregister tools by serverId', () => {
            const tools = [
                { name: 'x', description: 'X', inputSchema: { type: 'object', properties: {}, required: [] } },
            ];
            router.registerExternalTools('s1', 'ext', tools, () => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: 'ok' }]
                });
            }));
            (0, bun_test_1.expect)(router.getExternalToolCount()).toBe(1);
            router.unregisterExternalTools('s1');
            (0, bun_test_1.expect)(router.getExternalToolCount()).toBe(0);
        });
        (0, bun_test_1.it)('should replace tools on re-registration', () => {
            const executor = () => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    content: [{ type: 'text', text: 'ok' }]
                });
            });
            router.registerExternalTools('s1', 'ext', [
                { name: 'a', description: 'A', inputSchema: { type: 'object', properties: {}, required: [] } },
                { name: 'b', description: 'B', inputSchema: { type: 'object', properties: {}, required: [] } },
            ], executor);
            (0, bun_test_1.expect)(router.getExternalToolCount()).toBe(2);
            // Re-register with different tools
            router.registerExternalTools('s1', 'ext', [
                { name: 'c', description: 'C', inputSchema: { type: 'object', properties: {}, required: [] } },
            ], executor);
            (0, bun_test_1.expect)(router.getExternalToolCount()).toBe(1);
        });
    });
    (0, bun_test_1.describe)('getOllamaTools', () => {
        (0, bun_test_1.it)('should return Ollama-compatible format', () => {
            const tools = router.getOllamaTools('enterprise');
            (0, bun_test_1.expect)(tools.length).toBeGreaterThan(0);
            const first = tools[0];
            (0, bun_test_1.expect)(first.type).toBe('function');
            (0, bun_test_1.expect)(first.function).toBeDefined();
            (0, bun_test_1.expect)(first.function.name).toBeDefined();
            (0, bun_test_1.expect)(first.function.description).toBeDefined();
            (0, bun_test_1.expect)(first.function.parameters).toBeDefined();
        });
    });
    (0, bun_test_1.describe)('isExternalTool', () => {
        (0, bun_test_1.it)('should identify external tools by namespace separator', () => {
            (0, bun_test_1.expect)(router.isExternalTool(`server${types_1.MCP_NAMESPACE_SEPARATOR}tool`)).toBe(true);
            (0, bun_test_1.expect)(router.isExternalTool('run_command')).toBe(false);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1ZvbHVtZXMvTUFDX0FQUC9vcGVubWFrZV9sbG0vYmFja2VuZC9hcGkvc3JjL21jcC9fX3Rlc3RzX18vdG9vbC1yb3V0ZXIudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7Ozs7Ozs7Ozs7O0FBRUgsdUNBQTREO0FBQzVELGdEQUE0QztBQUU1QyxvQ0FBbUQ7QUFFbkQsSUFBQSxtQkFBUSxFQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7SUFDeEIsSUFBSSxNQUFrQixDQUFDO0lBRXZCLElBQUEscUJBQVUsRUFBQyxHQUFHLEVBQUU7UUFDWixNQUFNLEdBQUcsSUFBSSx3QkFBVSxFQUFFLENBQUM7SUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFBLG1CQUFRLEVBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRTtRQUN6QixJQUFBLGFBQUUsRUFBQywrQkFBK0IsRUFBRSxHQUFHLEVBQUU7WUFDckMsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ25DLElBQUEsaUJBQU0sRUFBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXhDLDZEQUE2RDtZQUM3RCxNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxZQUFZLENBQUMsQ0FBQztZQUMzRCxJQUFBLGlCQUFNLEVBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDaEMsbUNBQW1DO1lBQ25DLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLGFBQWEsQ0FBQyxDQUFDO1lBQzdELElBQUEsaUJBQU0sRUFBQyxVQUFVLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN2QyxDQUFDLENBQUMsQ0FBQztRQUVILElBQUEsYUFBRSxFQUFDLGtEQUFrRCxFQUFFLEdBQUcsRUFB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ZW5tYWtlX2xsbS9iYWNrZW5kL2FwaS9zcmMvbWNwL19fdGVzdHNfXy90b29sLXJvdXRlci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVG9vbFJvdXRlciBVbml0IFRlc3RzXG4gKi9cblxuaW1wb3J0IHsgZGVzY3JpYmUsIGl0LCBleHBlY3QsIGJlZm9yZUVhY2ggfSBmcm9tICdidW46dGVzdCc7XG5pbXBvcnQgeyBUb29sUm91dGVyIH0gZnJvbSAnLi4vdG9vbC1yb3V0ZXInO1xuaW1wb3J0IHR5cGUgeyBNQ1BUb29sLCBNQ1BUb29sUmVzdWx0IH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgTUNQX05BTUVTUEFDRV9TRVBBUkFUT1IgfSBmcm9tICcuLi90eXBlcyc7XG5cbmRlc2NyaWJlKCdUb29sUm91dGVyJywgKCkgPT4ge1xuICAgIGxldCByb3V0ZXI6IFRvb2xSb3V0ZXI7XG5cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgICAgcm91dGVyID0gbmV3IFRvb2xSb3V0ZXIoKTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdnZXRBbGxUb29scycsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCBpbmNsdWRlIGJ1aWx0LWluIHRvb2xzJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdG9vbHMgPSByb3V0ZXIuZ2V0QWxsVG9vbHMoKTtcbiAgICAgICAgICAgIGV4cGVjdCh0b29scy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcblxuICAgICAgICAgICAgLy8g8J+UkiDrs7TslYgg7Yyo7LmYIDIwMjYtMDItMDc6IHJ1bl9jb21tYW5kIOygnOqxsOuQqCDigJQgdmlzaW9uX29jcuqwgCDrgqjslYTsnojslrTslbwg7ZWoXG4gICAgICAgICAgICBjb25zdCB2aXNpb25PY3IgPSB0b29scy5maW5kKHQgPT4gdC5uYW1lID09PSAndmlzaW9uX29jcicpO1xuICAgICAgICAgICAgZXhwZWN0KHZpc2lvbk9jcikudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIC8vIHJ1bl9jb21tYW5k64qUIOuztOyViOyDgSDsoJzqsbDrkJjslrQg7KG07J6s7ZWY7KeAIOyViuyVhOyVvCDtlahcbiAgICAgICAgICAgIGNvbnN0IHJ1bkNvbW1hbmQgPSB0b29scy5maW5kKHQgPT4gdC5uYW1lID09PSAncnVuX2NvbW1hbmQnKTtcbiAgICAgICAgICAgIGV4cGVjdChydW5Db21tYW5kKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgaW5jbHVkZSBleHRlcm5hbCB0b29scyBhZnRlciByZWdpc3RyYXRpb24nLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtb2NrVG9vbDogTUNQVG9vbCA9IHtcbiAgICAgICAgICAgICAgICBuYW1lOiAnbGlzdF90YWJsZXMnLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnTGlzdCBkYXRhYmFzZSB0YWJsZXMnLFxuICAgICAgICAgICAgICAgIGlucHV0U2NoZW1hOiB7IHR5cGU6ICdvYmplY3QnLCBwcm9wZXJ0aWVzOiB7fSwgcmVxdWlyZWQ6IFtdIH1cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGNvbnN0IG1vY2tFeGVjdXRvciA9IGFzeW5jIChfbmFtZTogc3RyaW5nLCBfYXJnczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4pOiBQcm9taXNlPE1DUFRvb2xSZXN1bHQ+ID0+ICh7XG4gICAgICAgICAgICAgICAgY29udGVudDogW3sgdHlwZTogJ3RleHQnLCB0ZXh0OiAnb2snIH1dXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcm91dGVyLnJlZ2lzdGVyRXh0ZXJuYWxUb29scygnc2VydmVyMScsICdwb3N0Z3JlcycsIFttb2NrVG9vbF0sIG1vY2tFeGVjdXRvcik7XG5cbiAgICAgICAgICAgIGNvbnN0IHRvb2xzID0gcm91dGVyLmdldEFsbFRvb2xzKCk7XG4gICAgICAgICAgICBjb25zdCBleHRlcm5hbCA9IHRvb2xzLmZpbmQodCA9PiB0Lm5hbWUgPT09IGBwb3N0Z3JlcyR7TUNQX05BTUVTUEFDRV9TRVBBUkFUT1J9bGlzdF90YWJsZXNgKTtcbiAgICAgICAgICAgIGV4cGVjdChleHRlcm5hbCkudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdChleHRlcm5hbCEuZGVzY3JpcHRpb24pLnRvQmUoJ0xpc3QgZGF0YWJhc2UgdGFibGVzJyk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2dldFRvb2xzRm9yVGllcicsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCBmaWx0ZXIgdG9vbHMgZm9yIGZyZWUgdGllcicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRvb2xzID0gcm91dGVyLmdldFRvb2xzRm9yVGllcignZnJlZScpO1xuICAgICAgICAgICAgLy8gZnJlZSB0aWVyIGhhcyB3ZWJfc2VhcmNoLCB2aXNpb25fb2NyLCBhbmFseXplX2ltYWdlXG4gICAgICAgICAgICBjb25zdCBuYW1lcyA9IHRvb2xzLm1hcCh0ID0+IHQubmFtZSk7XG4gICAgICAgICAgICBleHBlY3QobmFtZXMpLnRvQ29udGFpbignd2ViX3NlYXJjaCcpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGV4Y2x1ZGUgZXh0ZXJuYWwgdG9vbHMgZm9yIGZyZWUgdGllcicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1vY2tUb29sOiBNQ1BUb29sID0ge1xuICAgICAgICAgICAgICAgIG5hbWU6ICdxdWVyeScsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdSdW4gU1FMJyxcbiAgICAgICAgICAgICAgICBpbnB1dFNjaGVtYTogeyB0eXBlOiAnb2JqZWN0JywgcHJvcGVydGllczoge30sIHJlcXVpcmVkOiBbXSB9XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICByb3V0ZXIucmVnaXN0ZXJFeHRlcm5hbFRvb2xzKCdzMScsICdkYicsIFttb2NrVG9vbF0sIGFzeW5jICgpID0+ICh7XG4gICAgICAgICAgICAgICAgY29udGVudDogW3sgdHlwZTogJ3RleHQnLCB0ZXh0OiAnb2snIH1dXG4gICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGZyZWVUb29scyA9IHJvdXRlci5nZXRUb29sc0ZvclRpZXIoJ2ZyZWUnKTtcbiAgICAgICAgICAgIGNvbnN0IGhhc0V4dGVybmFsID0gZnJlZVRvb2xzLnNvbWUodCA9PiB0Lm5hbWUuaW5jbHVkZXMoTUNQX05BTUVTUEFDRV9TRVBBUkFUT1IpKTtcbiAgICAgICAgICAgIGV4cGVjdChoYXNFeHRlcm5hbCkudG9CZShmYWxzZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgaW5jbHVkZSBleHRlcm5hbCB0b29scyBmb3IgZW50ZXJwcmlzZSB0aWVyJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbW9ja1Rvb2w6IE1DUFRvb2wgPSB7XG4gICAgICAgICAgICAgICAgbmFtZTogJ3F1ZXJ5JyxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1J1biBTUUwnLFxuICAgICAgICAgICAgICAgIGlucHV0U2NoZW1hOiB7IHR5cGU6ICdvYmplY3QnLCBwcm9wZXJ0aWVzOiB7fSwgcmVxdWlyZWQ6IFtdIH1cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHJvdXRlci5yZWdpc3RlckV4dGVybmFsVG9vbHMoJ3MxJywgJ2RiJywgW21vY2tUb29sXSwgYXN5bmMgKCkgPT4gKHtcbiAgICAgICAgICAgICAgICBjb250ZW50OiBbeyB0eXBlOiAndGV4dCcsIHRleHQ6ICdvaycgfV1cbiAgICAgICAgICAgIH0pKTtcblxuICAgICAgICAgICAgY29uc3QgZW50VG9vbHMgPSByb3V0ZXIuZ2V0VG9vbHNGb3JUaWVyKCdlbnRlcnByaXNlJyk7XG4gICAgICAgICAgICBjb25zdCBleHRlcm5hbCA9IGVudFRvb2xzLmZpbmQodCA9PiB0Lm5hbWUgPT09IGBkYiR7TUNQX05BTUVTUEFDRV9TRVBBUkFUT1J9cXVlcnlgKTtcbiAgICAgICAgICAgIGV4cGVjdChleHRlcm5hbCkudG9CZURlZmluZWQoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZXhlY3V0ZVRvb2wnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBhIGJ1aWx0LWluIHRvb2wnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAvLyBydW5fY29tbWFuZCBpcyBhIGJ1aWx0LWluIHRvb2xcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJvdXRlci5leGVjdXRlVG9vbCgncnVuX2NvbW1hbmQnLCB7IGNvbW1hbmQ6ICdlY2hvIGhlbGxvJyB9KTtcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmNvbnRlbnQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmNvbnRlbnQubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBhbiBleHRlcm5hbCB0b29sJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbW9ja1Rvb2w6IE1DUFRvb2wgPSB7XG4gICAgICAgICAgICAgICAgbmFtZTogJ3BpbmcnLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnUGluZyBzZXJ2aWNlJyxcbiAgICAgICAgICAgICAgICBpbnB1dFNjaGVtYTogeyB0eXBlOiAnb2JqZWN0JywgcHJvcGVydGllczoge30sIHJlcXVpcmVkOiBbXSB9XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zdCBtb2NrRXhlY3V0b3IgPSBhc3luYyAobmFtZTogc3RyaW5nLCBfYXJnczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4pOiBQcm9taXNlPE1DUFRvb2xSZXN1bHQ+ID0+ICh7XG4gICAgICAgICAgICAgICAgY29udGVudDogW3sgdHlwZTogJ3RleHQnLCB0ZXh0OiBgcG9uZyBmcm9tICR7bmFtZX1gIH1dXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcm91dGVyLnJlZ2lzdGVyRXh0ZXJuYWxUb29scygnc3J2MScsICdteXNlcnZlcicsIFttb2NrVG9vbF0sIG1vY2tFeGVjdXRvcik7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJvdXRlci5leGVjdXRlVG9vbChgbXlzZXJ2ZXIke01DUF9OQU1FU1BBQ0VfU0VQQVJBVE9SfXBpbmdgLCB7fSk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmlzRXJyb3IpLnRvQmVGYWxzeSgpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5jb250ZW50WzBdLnRleHQpLnRvQmUoJ3BvbmcgZnJvbSBwaW5nJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIGVycm9yIGZvciB1bmtub3duIHRvb2wnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByb3V0ZXIuZXhlY3V0ZVRvb2woJ25vbmV4aXN0ZW50X3Rvb2wnLCB7fSk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmlzRXJyb3IpLnRvQmUodHJ1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIGVycm9yIGZvciB1bmtub3duIGV4dGVybmFsIHRvb2wnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByb3V0ZXIuZXhlY3V0ZVRvb2woYHVua25vd24ke01DUF9OQU1FU1BBQ0VfU0VQQVJBVE9SfXRvb2xgLCB7fSk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmlzRXJyb3IpLnRvQmUodHJ1ZSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ3JlZ2lzdGVyRXh0ZXJuYWxUb29scyAvIHVucmVnaXN0ZXJFeHRlcm5hbFRvb2xzJywgKCkgPT4ge1xuICAgICAgICBpdCgnc2hvdWxkIHJlZ2lzdGVyIGFuZCBjb3VudCBleHRlcm5hbCB0b29scycsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRvb2xzOiBNQ1BUb29sW10gPSBbXG4gICAgICAgICAgICAgICAgeyBuYW1lOiAnYScsIGRlc2NyaXB0aW9uOiAnQScsIGlucHV0U2NoZW1hOiB7IHR5cGU6ICdvYmplY3QnLCBwcm9wZXJ0aWVzOiB7fSwgcmVxdWlyZWQ6IFtdIH0gfSxcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdiJywgZGVzY3JpcHRpb246ICdCJywgaW5wdXRTY2hlbWE6IHsgdHlwZTogJ29iamVjdCcsIHByb3BlcnRpZXM6IHt9LCByZXF1aXJlZDogW10gfSB9LFxuICAgICAgICAgICAgXTtcblxuICAgICAgICAgICAgcm91dGVyLnJlZ2lzdGVyRXh0ZXJuYWxUb29scygnczEnLCAnZXh0JywgdG9vbHMsIGFzeW5jICgpID0+ICh7XG4gICAgICAgICAgICAgICAgY29udGVudDogW3sgdHlwZTogJ3RleHQnLCB0ZXh0OiAnb2snIH1dXG4gICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgIGV4cGVjdChyb3V0ZXIuZ2V0RXh0ZXJuYWxUb29sQ291bnQoKSkudG9CZSgyKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCB1bnJlZ2lzdGVyIHRvb2xzIGJ5IHNlcnZlcklkJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdG9vbHM6IE1DUFRvb2xbXSA9IFtcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICd4JywgZGVzY3JpcHRpb246ICdYJywgaW5wdXRTY2hlbWE6IHsgdHlwZTogJ29iamVjdCcsIHByb3BlcnRpZXM6IHt9LCByZXF1aXJlZDogW10gfSB9LFxuICAgICAgICAgICAgXTtcblxuICAgICAgICAgICAgcm91dGVyLnJlZ2lzdGVyRXh0ZXJuYWxUb29scygnczEnLCAnZXh0JywgdG9vbHMsIGFzeW5jICgpID0+ICh7XG4gICAgICAgICAgICAgICAgY29udGVudDogW3sgdHlwZTogJ3RleHQnLCB0ZXh0OiAnb2snIH1dXG4gICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgIGV4cGVjdChyb3V0ZXIuZ2V0RXh0ZXJuYWxUb29sQ291bnQoKSkudG9CZSgxKTtcblxuICAgICAgICAgICAgcm91dGVyLnVucmVnaXN0ZXJFeHRlcm5hbFRvb2xzKCdzMScpO1xuICAgICAgICAgICAgZXhwZWN0KHJvdXRlci5nZXRFeHRlcm5hbFRvb2xDb3VudCgpKS50b0JlKDApO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHJlcGxhY2UgdG9vbHMgb24gcmUtcmVnaXN0cmF0aW9uJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZXhlY3V0b3IgPSBhc3luYyAoKTogUHJvbWlzZTxNQ1BUb29sUmVzdWx0PiA9PiAoe1xuICAgICAgICAgICAgICAgIGNvbnRlbnQ6IFt7IHR5cGU6ICd0ZXh0JywgdGV4dDogJ29rJyB9XVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJvdXRlci5yZWdpc3RlckV4dGVybmFsVG9vbHMoJ3MxJywgJ2V4dCcsIFtcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdhJywgZGVzY3JpcHRpb246ICdBJywgaW5wdXRTY2hlbWE6IHsgdHlwZTogJ29iamVjdCcsIHByb3BlcnRpZXM6IHt9LCByZXF1aXJlZDogW10gfSB9LFxuICAgICAgICAgICAgICAgIHsgbmFtZTogJ2InLCBkZXNjcmlwdGlvbjogJ0InLCBpbnB1dFNjaGVtYTogeyB0eXBlOiAnb2JqZWN0JywgcHJvcGVydGllczoge30sIHJlcXVpcmVkOiBbXSB9IH0sXG4gICAgICAgICAgICBdLCBleGVjdXRvcik7XG5cbiAgICAgICAgICAgIGV4cGVjdChyb3V0ZXIuZ2V0RXh0ZXJuYWxUb29sQ291bnQoKSkudG9CZSgyKTtcblxuICAgICAgICAgICAgLy8gUmUtcmVnaXN0ZXIgd2l0aCBkaWZmZXJlbnQgdG9vbHNcbiAgICAgICAgICAgIHJvdXRlci5yZWdpc3RlckV4dGVybmFsVG9vbHMoJ3MxJywgJ2V4dCcsIFtcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdjJywgZGVzY3JpcHRpb246ICdDJywgaW5wdXRTY2hlbWE6IHsgdHlwZTogJ29iamVjdCcsIHByb3BlcnRpZXM6IHt9LCByZXF1aXJlZDogW10gfSB9LFxuICAgICAgICAgICAgXSwgZXhlY3V0b3IpO1xuXG4gICAgICAgICAgICBleHBlY3Qocm91dGVyLmdldEV4dGVybmFsVG9vbENvdW50KCkpLnRvQmUoMSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2dldE9sbGFtYVRvb2xzJywgKCkgPT4ge1xuICAgICAgICBpdCgnc2hvdWxkIHJldHVybiBPbGxhbWEtY29tcGF0aWJsZSBmb3JtYXQnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b29scyA9IHJvdXRlci5nZXRPbGxhbWFUb29scygnZW50ZXJwcmlzZScpO1xuICAgICAgICAgICAgZXhwZWN0KHRvb2xzLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuXG4gICAgICAgICAgICBjb25zdCBmaXJzdCA9IHRvb2xzWzBdO1xuICAgICAgICAgICAgZXhwZWN0KGZpcnN0LnR5cGUpLnRvQmUoJ2Z1bmN0aW9uJyk7XG4gICAgICAgICAgICBleHBlY3QoZmlyc3QuZnVuY3Rpb24pLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgICAgICBleHBlY3QoZmlyc3QuZnVuY3Rpb24ubmFtZSkudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdChmaXJzdC5mdW5jdGlvbi5kZXNjcmlwdGlvbikudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdChmaXJzdC5mdW5jdGlvbi5wYXJhbWV0ZXJzKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdpc0V4dGVybmFsVG9vbCcsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCBpZGVudGlmeSBleHRlcm5hbCB0b29scyBieSBuYW1lc3BhY2Ugc2VwYXJhdG9yJywgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KHJvdXRlci5pc0V4dGVybmFsVG9vbChgc2VydmVyJHtNQ1BfTkFNRVNQQUNFX1NFUEFSQVRPUn10b29sYCkpLnRvQmUodHJ1ZSk7XG4gICAgICAgICAgICBleHBlY3Qocm91dGVyLmlzRXh0ZXJuYWxUb29sKCdydW5fY29tbWFuZCcpKS50b0JlKGZhbHNlKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==