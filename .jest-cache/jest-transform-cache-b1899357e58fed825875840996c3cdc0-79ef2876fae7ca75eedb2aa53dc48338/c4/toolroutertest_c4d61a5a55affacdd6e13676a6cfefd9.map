{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/mcp/__tests__/tool-router.test.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/mcp/__tests__/tool-router.test.ts"],"sourcesContent":["/**\n * ToolRouter Unit Tests\n */\n\nimport { describe, it, expect, beforeEach } from 'bun:test';\nimport { ToolRouter } from '../tool-router';\nimport type { MCPTool, MCPToolResult } from '../types';\nimport { MCP_NAMESPACE_SEPARATOR } from '../types';\n\ndescribe('ToolRouter', () => {\n    let router: ToolRouter;\n\n    beforeEach(() => {\n        router = new ToolRouter();\n    });\n\n    describe('getAllTools', () => {\n        it('should include built-in tools', () => {\n            const tools = router.getAllTools();\n            expect(tools.length).toBeGreaterThan(0);\n\n            // ðŸ”’ ë³´ì•ˆ íŒ¨ì¹˜ 2026-02-07: run_command ì œê±°ë¨ â€” vision_ocrê°€ ë‚¨ì•„ìžˆì–´ì•¼ í•¨\n            const visionOcr = tools.find(t => t.name === 'vision_ocr');\n            expect(visionOcr).toBeDefined();\n            // run_commandëŠ” ë³´ì•ˆìƒ ì œê±°ë˜ì–´ ì¡´ìž¬í•˜ì§€ ì•Šì•„ì•¼ í•¨\n            const runCommand = tools.find(t => t.name === 'run_command');\n            expect(runCommand).toBeUndefined();\n        });\n\n        it('should include external tools after registration', () => {\n            const mockTool: MCPTool = {\n                name: 'list_tables',\n                description: 'List database tables',\n                inputSchema: { type: 'object', properties: {}, required: [] }\n            };\n\n            const mockExecutor = async (_name: string, _args: Record<string, unknown>): Promise<MCPToolResult> => ({\n                content: [{ type: 'text', text: 'ok' }]\n            });\n\n            router.registerExternalTools('server1', 'postgres', [mockTool], mockExecutor);\n\n            const tools = router.getAllTools();\n            const external = tools.find(t => t.name === `postgres${MCP_NAMESPACE_SEPARATOR}list_tables`);\n            expect(external).toBeDefined();\n            expect(external!.description).toBe('List database tables');\n        });\n    });\n\n    describe('getToolsForTier', () => {\n        it('should filter tools for free tier', () => {\n            const tools = router.getToolsForTier('free');\n            // free tier has web_search, vision_ocr, analyze_image\n            const names = tools.map(t => t.name);\n            expect(names).toContain('web_search');\n        });\n\n        it('should exclude external tools for free tier', () => {\n            const mockTool: MCPTool = {\n                name: 'query',\n                description: 'Run SQL',\n                inputSchema: { type: 'object', properties: {}, required: [] }\n            };\n\n            router.registerExternalTools('s1', 'db', [mockTool], async () => ({\n                content: [{ type: 'text', text: 'ok' }]\n            }));\n\n            const freeTools = router.getToolsForTier('free');\n            const hasExternal = freeTools.some(t => t.name.includes(MCP_NAMESPACE_SEPARATOR));\n            expect(hasExternal).toBe(false);\n        });\n\n        it('should include external tools for enterprise tier', () => {\n            const mockTool: MCPTool = {\n                name: 'query',\n                description: 'Run SQL',\n                inputSchema: { type: 'object', properties: {}, required: [] }\n            };\n\n            router.registerExternalTools('s1', 'db', [mockTool], async () => ({\n                content: [{ type: 'text', text: 'ok' }]\n            }));\n\n            const entTools = router.getToolsForTier('enterprise');\n            const external = entTools.find(t => t.name === `db${MCP_NAMESPACE_SEPARATOR}query`);\n            expect(external).toBeDefined();\n        });\n    });\n\n    describe('executeTool', () => {\n        it('should execute a built-in tool', async () => {\n            // run_command is a built-in tool\n            const result = await router.executeTool('run_command', { command: 'echo hello' });\n            expect(result).toBeDefined();\n            expect(result.content).toBeDefined();\n            expect(result.content.length).toBeGreaterThan(0);\n        });\n\n        it('should execute an external tool', async () => {\n            const mockTool: MCPTool = {\n                name: 'ping',\n                description: 'Ping service',\n                inputSchema: { type: 'object', properties: {}, required: [] }\n            };\n\n            const mockExecutor = async (name: string, _args: Record<string, unknown>): Promise<MCPToolResult> => ({\n                content: [{ type: 'text', text: `pong from ${name}` }]\n            });\n\n            router.registerExternalTools('srv1', 'myserver', [mockTool], mockExecutor);\n\n            const result = await router.executeTool(`myserver${MCP_NAMESPACE_SEPARATOR}ping`, {});\n            expect(result.isError).toBeFalsy();\n            expect(result.content[0].text).toBe('pong from ping');\n        });\n\n        it('should return error for unknown tool', async () => {\n            const result = await router.executeTool('nonexistent_tool', {});\n            expect(result.isError).toBe(true);\n        });\n\n        it('should return error for unknown external tool', async () => {\n            const result = await router.executeTool(`unknown${MCP_NAMESPACE_SEPARATOR}tool`, {});\n            expect(result.isError).toBe(true);\n        });\n    });\n\n    describe('registerExternalTools / unregisterExternalTools', () => {\n        it('should register and count external tools', () => {\n            const tools: MCPTool[] = [\n                { name: 'a', description: 'A', inputSchema: { type: 'object', properties: {}, required: [] } },\n                { name: 'b', description: 'B', inputSchema: { type: 'object', properties: {}, required: [] } },\n            ];\n\n            router.registerExternalTools('s1', 'ext', tools, async () => ({\n                content: [{ type: 'text', text: 'ok' }]\n            }));\n\n            expect(router.getExternalToolCount()).toBe(2);\n        });\n\n        it('should unregister tools by serverId', () => {\n            const tools: MCPTool[] = [\n                { name: 'x', description: 'X', inputSchema: { type: 'object', properties: {}, required: [] } },\n            ];\n\n            router.registerExternalTools('s1', 'ext', tools, async () => ({\n                content: [{ type: 'text', text: 'ok' }]\n            }));\n\n            expect(router.getExternalToolCount()).toBe(1);\n\n            router.unregisterExternalTools('s1');\n            expect(router.getExternalToolCount()).toBe(0);\n        });\n\n        it('should replace tools on re-registration', () => {\n            const executor = async (): Promise<MCPToolResult> => ({\n                content: [{ type: 'text', text: 'ok' }]\n            });\n\n            router.registerExternalTools('s1', 'ext', [\n                { name: 'a', description: 'A', inputSchema: { type: 'object', properties: {}, required: [] } },\n                { name: 'b', description: 'B', inputSchema: { type: 'object', properties: {}, required: [] } },\n            ], executor);\n\n            expect(router.getExternalToolCount()).toBe(2);\n\n            // Re-register with different tools\n            router.registerExternalTools('s1', 'ext', [\n                { name: 'c', description: 'C', inputSchema: { type: 'object', properties: {}, required: [] } },\n            ], executor);\n\n            expect(router.getExternalToolCount()).toBe(1);\n        });\n    });\n\n    describe('getOllamaTools', () => {\n        it('should return Ollama-compatible format', () => {\n            const tools = router.getOllamaTools('enterprise');\n            expect(tools.length).toBeGreaterThan(0);\n\n            const first = tools[0];\n            expect(first.type).toBe('function');\n            expect(first.function).toBeDefined();\n            expect(first.function.name).toBeDefined();\n            expect(first.function.description).toBeDefined();\n            expect(first.function.parameters).toBeDefined();\n        });\n    });\n\n    describe('isExternalTool', () => {\n        it('should identify external tools by namespace separator', () => {\n            expect(router.isExternalTool(`server${MCP_NAMESPACE_SEPARATOR}tool`)).toBe(true);\n            expect(router.isExternalTool('run_command')).toBe(false);\n        });\n    });\n});\n"],"version":3}