{"file":"/Volumes/MAC_APP/openmake_llm/database/models/unified-database.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/database/models/unified-database.ts"],"sourcesContent":["/**\n * @fileoverview í†µí•© ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸\n * \n * OpenMake LLM í”Œë«í¼ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ë‹¨ì¼ SQLite ë°ì´í„°ë² ì´ìŠ¤ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.\n * \n * ## ì£¼ìš” ê¸°ëŠ¥\n * - ì‚¬ìš©ì ê´€ë¦¬ (ì¸ì¦, ê¶Œí•œ)\n * - ëŒ€í™” ì„¸ì…˜ ë° ë©”ì‹œì§€ ê´€ë¦¬\n * - API ì‚¬ìš©ëŸ‰ ì¶”ì \n * - ì—ì´ì „íŠ¸ ì‚¬ìš© ë¡œê·¸ ë° í”¼ë“œë°±\n * - ì¥ê¸° ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œ (ì‚¬ìš©ìë³„ ì»¨í…ìŠ¤íŠ¸ ì €ì¥)\n * - Deep Research ì„¸ì…˜ ê´€ë¦¬\n * - ì—ì´ì „íŠ¸ ë§ˆì¼“í”Œë ˆì´ìŠ¤\n * - Canvas í˜‘ì—… ë¬¸ì„œ\n * - ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™ (Google Drive, Notion, GitHub ë“±)\n * \n * @module database/unified-database\n * \n * @example\n * ```typescript\n * import { getUnifiedDatabase, closeDatabase } from './unified-database';\n * \n * const db = getUnifiedDatabase('./data');\n * \n * // ì‚¬ìš©ì ìƒì„±\n * db.createUser('user-1', 'john', 'hashedPassword', 'john@example.com');\n * \n * // ëŒ€í™” ì„¸ì…˜ ìƒì„±\n * db.createSession('session-1', 'user-1', 'ì²« ë²ˆì§¸ ëŒ€í™”');\n * db.addMessage('session-1', 'user', 'ì•ˆë…•í•˜ì„¸ìš”');\n * \n * // ì¢…ë£Œ ì‹œ\n * closeDatabase();\n * ```\n */\n\nimport Database from 'better-sqlite3';\nimport * as path from 'path';\nimport * as fs from 'fs';\nimport { encrypt, decrypt } from './crypto-utils';\n\n// ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ\nconst SCHEMA = `\n-- ì‚¬ìš©ì í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS users (\n    id TEXT PRIMARY KEY,\n    username TEXT UNIQUE NOT NULL,\n    password_hash TEXT NOT NULL,\n    email TEXT,\n    role TEXT DEFAULT 'user' CHECK(role IN ('admin', 'user', 'guest')),\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    last_login DATETIME,\n    is_active INTEGER DEFAULT 1\n);\n\n-- ëŒ€í™” ì„¸ì…˜ í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS conversation_sessions (\n    id TEXT PRIMARY KEY,\n    user_id TEXT,\n    title TEXT,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    metadata JSON,\n    FOREIGN KEY (user_id) REFERENCES users(id)\n);\n\n-- ëŒ€í™” ë©”ì‹œì§€ í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS conversation_messages (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    session_id TEXT NOT NULL,\n    role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system')),\n    content TEXT NOT NULL,\n    model TEXT,\n    agent_id TEXT,\n    thinking TEXT,\n    tokens INTEGER,\n    response_time_ms INTEGER,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (session_id) REFERENCES conversation_sessions(id) ON DELETE CASCADE\n);\n\n-- API ì‚¬ìš©ëŸ‰ í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS api_usage (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    date TEXT NOT NULL,\n    api_key_id TEXT,\n    requests INTEGER DEFAULT 0,\n    tokens INTEGER DEFAULT 0,\n    errors INTEGER DEFAULT 0,\n    avg_response_time REAL DEFAULT 0,\n    models JSON,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    UNIQUE(date, api_key_id)\n);\n\n-- ì—ì´ì „íŠ¸ ì‚¬ìš© ë¡œê·¸ í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS agent_usage_logs (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,\n    user_id TEXT,\n    session_id TEXT,\n    agent_id TEXT NOT NULL,\n    query TEXT,\n    response_preview TEXT,\n    response_time_ms INTEGER,\n    tokens_used INTEGER,\n    success INTEGER DEFAULT 1,\n    error_message TEXT,\n    FOREIGN KEY (user_id) REFERENCES users(id),\n    FOREIGN KEY (session_id) REFERENCES conversation_sessions(id)\n);\n\n-- ì—ì´ì „íŠ¸ í”¼ë“œë°± í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS agent_feedback (\n    id TEXT PRIMARY KEY,\n    agent_id TEXT NOT NULL,\n    user_id TEXT,\n    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),\n    comment TEXT,\n    query TEXT,\n    response TEXT,\n    tags JSON,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (user_id) REFERENCES users(id)\n);\n\n-- ì»¤ìŠ¤í…€ ì—ì´ì „íŠ¸ í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS custom_agents (\n    id TEXT PRIMARY KEY,\n    name TEXT NOT NULL,\n    description TEXT,\n    system_prompt TEXT NOT NULL,\n    keywords JSON,\n    category TEXT,\n    emoji TEXT DEFAULT 'ğŸ¤–',\n    temperature REAL,\n    max_tokens INTEGER,\n    created_by TEXT,\n    enabled INTEGER DEFAULT 1,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (created_by) REFERENCES users(id)\n);\n\n-- ì‹œìŠ¤í…œ ê°ì‚¬ ë¡œê·¸ í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS audit_logs (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,\n    action TEXT NOT NULL,\n    user_id TEXT,\n    resource_type TEXT,\n    resource_id TEXT,\n    details JSON,\n    ip_address TEXT,\n    user_agent TEXT\n);\n\n-- ì•Œë¦¼ íˆìŠ¤í† ë¦¬ í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS alert_history (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    type TEXT NOT NULL,\n    severity TEXT NOT NULL,\n    title TEXT NOT NULL,\n    message TEXT,\n    data JSON,\n    acknowledged INTEGER DEFAULT 0,\n    acknowledged_by TEXT,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    acknowledged_at DATETIME\n);\n\n-- ì¸ë±ìŠ¤\nCREATE INDEX IF NOT EXISTS idx_messages_session ON conversation_messages(session_id);\nCREATE INDEX IF NOT EXISTS idx_messages_created ON conversation_messages(created_at);\nCREATE INDEX IF NOT EXISTS idx_usage_date ON api_usage(date);\nCREATE INDEX IF NOT EXISTS idx_agent_logs_agent ON agent_usage_logs(agent_id);\nCREATE INDEX IF NOT EXISTS idx_agent_logs_time ON agent_usage_logs(timestamp);\nCREATE INDEX IF NOT EXISTS idx_feedback_agent ON agent_feedback(agent_id);\nCREATE INDEX IF NOT EXISTS idx_audit_action ON audit_logs(action);\nCREATE INDEX IF NOT EXISTS idx_audit_time ON audit_logs(timestamp);\nCREATE INDEX IF NOT EXISTS idx_users_username ON users(username);\nCREATE INDEX IF NOT EXISTS idx_users_email ON users(email);\nCREATE INDEX IF NOT EXISTS idx_sessions_user ON conversation_sessions(user_id);\n\n-- ğŸ”’ ì¶”ê°€ ì¸ë±ìŠ¤ (ì„±ëŠ¥ ìµœì í™”)\nCREATE INDEX IF NOT EXISTS idx_sessions_updated ON conversation_sessions(updated_at);\nCREATE INDEX IF NOT EXISTS idx_users_created ON users(created_at);\nCREATE INDEX IF NOT EXISTS idx_sessions_created ON conversation_sessions(created_at);\nCREATE INDEX IF NOT EXISTS idx_custom_agents_enabled ON custom_agents(enabled);\nCREATE INDEX IF NOT EXISTS idx_alert_severity ON alert_history(severity);\nCREATE INDEX IF NOT EXISTS idx_alert_created ON alert_history(created_at);\n\n-- ============================================\n-- ğŸ§  ì¥ê¸° ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œ í…Œì´ë¸”\n-- ============================================\n\n-- ì‚¬ìš©ì ë©”ëª¨ë¦¬ í…Œì´ë¸” (ì„¸ì…˜ ê°„ ê¸°ì–µ)\nCREATE TABLE IF NOT EXISTS user_memories (\n    id TEXT PRIMARY KEY,\n    user_id TEXT NOT NULL,\n    category TEXT NOT NULL CHECK(category IN ('preference', 'fact', 'project', 'relationship', 'skill', 'context')),\n    key TEXT NOT NULL,\n    value TEXT NOT NULL,\n    importance REAL DEFAULT 0.5,\n    access_count INTEGER DEFAULT 0,\n    last_accessed DATETIME,\n    source_session_id TEXT,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    expires_at DATETIME,\n    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n    FOREIGN KEY (source_session_id) REFERENCES conversation_sessions(id),\n    UNIQUE(user_id, category, key)\n);\n\n-- ë©”ëª¨ë¦¬ íƒœê·¸ í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS memory_tags (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    memory_id TEXT NOT NULL,\n    tag TEXT NOT NULL,\n    FOREIGN KEY (memory_id) REFERENCES user_memories(id) ON DELETE CASCADE,\n    UNIQUE(memory_id, tag)\n);\n\n-- ë©”ëª¨ë¦¬ ì¸ë±ìŠ¤\nCREATE INDEX IF NOT EXISTS idx_memories_user ON user_memories(user_id);\nCREATE INDEX IF NOT EXISTS idx_memories_category ON user_memories(category);\nCREATE INDEX IF NOT EXISTS idx_memories_importance ON user_memories(importance DESC);\nCREATE INDEX IF NOT EXISTS idx_memories_accessed ON user_memories(last_accessed DESC);\nCREATE INDEX IF NOT EXISTS idx_memory_tags_tag ON memory_tags(tag);\n\n-- ============================================\n-- ğŸ” Deep Research í…Œì´ë¸”\n-- ============================================\n\n-- ë¦¬ì„œì¹˜ ì„¸ì…˜ í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS research_sessions (\n    id TEXT PRIMARY KEY,\n    user_id TEXT,\n    topic TEXT NOT NULL,\n    status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'running', 'completed', 'failed', 'cancelled')),\n    depth TEXT DEFAULT 'standard' CHECK(depth IN ('quick', 'standard', 'deep')),\n    progress INTEGER DEFAULT 0,\n    summary TEXT,\n    key_findings JSON,\n    sources JSON,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    completed_at DATETIME,\n    FOREIGN KEY (user_id) REFERENCES users(id)\n);\n\n-- ë¦¬ì„œì¹˜ ë‹¨ê³„ í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS research_steps (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    session_id TEXT NOT NULL,\n    step_number INTEGER NOT NULL,\n    step_type TEXT NOT NULL,\n    query TEXT,\n    result TEXT,\n    sources JSON,\n    status TEXT DEFAULT 'pending',\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (session_id) REFERENCES research_sessions(id) ON DELETE CASCADE\n);\n\nCREATE INDEX IF NOT EXISTS idx_research_user ON research_sessions(user_id);\nCREATE INDEX IF NOT EXISTS idx_research_status ON research_sessions(status);\nCREATE INDEX IF NOT EXISTS idx_research_steps_session ON research_steps(session_id);\n\n-- ============================================\n-- ğŸª Custom Agent ë§ˆì¼“í”Œë ˆì´ìŠ¤ í…Œì´ë¸”\n-- ============================================\n\n-- ì—ì´ì „íŠ¸ ë§ˆì¼“í”Œë ˆì´ìŠ¤ í…Œì´ë¸” (ê³µìœ ëœ ì—ì´ì „íŠ¸)\nCREATE TABLE IF NOT EXISTS agent_marketplace (\n    id TEXT PRIMARY KEY,\n    agent_id TEXT NOT NULL,\n    author_id TEXT NOT NULL,\n    title TEXT NOT NULL,\n    description TEXT,\n    long_description TEXT,\n    category TEXT,\n    tags JSON,\n    icon TEXT DEFAULT 'ğŸ¤–',\n    banner_url TEXT,\n    price REAL DEFAULT 0,\n    is_free INTEGER DEFAULT 1,\n    is_featured INTEGER DEFAULT 0,\n    is_verified INTEGER DEFAULT 0,\n    downloads INTEGER DEFAULT 0,\n    rating_avg REAL DEFAULT 0,\n    rating_count INTEGER DEFAULT 0,\n    version TEXT DEFAULT '1.0.0',\n    changelog TEXT,\n    status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'approved', 'rejected', 'suspended')),\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    published_at DATETIME,\n    FOREIGN KEY (agent_id) REFERENCES custom_agents(id),\n    FOREIGN KEY (author_id) REFERENCES users(id)\n);\n\n-- ì—ì´ì „íŠ¸ ë¦¬ë·° í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS agent_reviews (\n    id TEXT PRIMARY KEY,\n    marketplace_id TEXT NOT NULL,\n    user_id TEXT NOT NULL,\n    rating INTEGER NOT NULL CHECK(rating >= 1 AND rating <= 5),\n    title TEXT,\n    content TEXT,\n    helpful_count INTEGER DEFAULT 0,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (marketplace_id) REFERENCES agent_marketplace(id) ON DELETE CASCADE,\n    FOREIGN KEY (user_id) REFERENCES users(id),\n    UNIQUE(marketplace_id, user_id)\n);\n\n-- ì—ì´ì „íŠ¸ ì„¤ì¹˜ ê¸°ë¡\nCREATE TABLE IF NOT EXISTS agent_installations (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    marketplace_id TEXT NOT NULL,\n    user_id TEXT NOT NULL,\n    installed_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    uninstalled_at DATETIME,\n    FOREIGN KEY (marketplace_id) REFERENCES agent_marketplace(id),\n    FOREIGN KEY (user_id) REFERENCES users(id),\n    UNIQUE(marketplace_id, user_id)\n);\n\nCREATE INDEX IF NOT EXISTS idx_marketplace_category ON agent_marketplace(category);\nCREATE INDEX IF NOT EXISTS idx_marketplace_featured ON agent_marketplace(is_featured);\nCREATE INDEX IF NOT EXISTS idx_marketplace_downloads ON agent_marketplace(downloads DESC);\nCREATE INDEX IF NOT EXISTS idx_marketplace_rating ON agent_marketplace(rating_avg DESC);\nCREATE INDEX IF NOT EXISTS idx_reviews_marketplace ON agent_reviews(marketplace_id);\nCREATE INDEX IF NOT EXISTS idx_installations_user ON agent_installations(user_id);\n\n-- ============================================\n-- ğŸ“ Canvas í˜‘ì—… ë„êµ¬ í…Œì´ë¸”\n-- ============================================\n\n-- Canvas ë¬¸ì„œ í…Œì´ë¸”\nCREATE TABLE IF NOT EXISTS canvas_documents (\n    id TEXT PRIMARY KEY,\n    user_id TEXT NOT NULL,\n    session_id TEXT,\n    title TEXT NOT NULL,\n    doc_type TEXT DEFAULT 'document' CHECK(doc_type IN ('document', 'code', 'diagram', 'table')),\n    content TEXT,\n    language TEXT,\n    version INTEGER DEFAULT 1,\n    is_shared INTEGER DEFAULT 0,\n    share_token TEXT UNIQUE,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (user_id) REFERENCES users(id),\n    FOREIGN KEY (session_id) REFERENCES conversation_sessions(id)\n);\n\n-- Canvas ë²„ì „ íˆìŠ¤í† ë¦¬\nCREATE TABLE IF NOT EXISTS canvas_versions (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    document_id TEXT NOT NULL,\n    version INTEGER NOT NULL,\n    content TEXT NOT NULL,\n    change_summary TEXT,\n    created_by TEXT,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (document_id) REFERENCES canvas_documents(id) ON DELETE CASCADE,\n    FOREIGN KEY (created_by) REFERENCES users(id)\n);\n\n-- Canvas AI ìˆ˜ì • ìš”ì²­\nCREATE TABLE IF NOT EXISTS canvas_ai_edits (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    document_id TEXT NOT NULL,\n    instruction TEXT NOT NULL,\n    original_content TEXT,\n    modified_content TEXT,\n    accepted INTEGER,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (document_id) REFERENCES canvas_documents(id) ON DELETE CASCADE\n);\n\nCREATE INDEX IF NOT EXISTS idx_canvas_user ON canvas_documents(user_id);\nCREATE INDEX IF NOT EXISTS idx_canvas_session ON canvas_documents(session_id);\nCREATE INDEX IF NOT EXISTS idx_canvas_shared ON canvas_documents(is_shared);\nCREATE INDEX IF NOT EXISTS idx_canvas_versions_doc ON canvas_versions(document_id);\n\n-- ============================================\n-- ğŸ”— ì™¸ë¶€ ì„œë¹„ìŠ¤ í†µí•© í…Œì´ë¸”\n-- ============================================\n\n-- ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ê²°\nCREATE TABLE IF NOT EXISTS external_connections (\n    id TEXT PRIMARY KEY,\n    user_id TEXT NOT NULL,\n    service_type TEXT NOT NULL CHECK(service_type IN ('google_drive', 'notion', 'github', 'slack', 'dropbox')),\n    access_token TEXT,\n    refresh_token TEXT,\n    token_expires_at DATETIME,\n    account_email TEXT,\n    account_name TEXT,\n    metadata JSON,\n    is_active INTEGER DEFAULT 1,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n    UNIQUE(user_id, service_type)\n);\n\n-- ì™¸ë¶€ íŒŒì¼ ì°¸ì¡°\nCREATE TABLE IF NOT EXISTS external_files (\n    id TEXT PRIMARY KEY,\n    connection_id TEXT NOT NULL,\n    external_id TEXT NOT NULL,\n    file_name TEXT NOT NULL,\n    file_type TEXT,\n    file_size INTEGER,\n    web_url TEXT,\n    last_synced DATETIME,\n    cached_content TEXT,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (connection_id) REFERENCES external_connections(id) ON DELETE CASCADE,\n    UNIQUE(connection_id, external_id)\n);\n\nCREATE INDEX IF NOT EXISTS idx_connections_user ON external_connections(user_id);\nCREATE INDEX IF NOT EXISTS idx_connections_service ON external_connections(service_type);\nCREATE INDEX IF NOT EXISTS idx_external_files_connection ON external_files(connection_id);\n`;\n\n/**\n * ì‚¬ìš©ì ì •ë³´ ì¸í„°í˜ì´ìŠ¤\n */\nexport interface User {\n    /** ì‚¬ìš©ì ê³ ìœ  ID (UUID) */\n    id: string;\n    /** ë¡œê·¸ì¸ìš© ì‚¬ìš©ìëª… (ê³ ìœ ) */\n    username: string;\n    /** í•´ì‹œëœ ë¹„ë°€ë²ˆí˜¸ */\n    password_hash: string;\n    /** ì´ë©”ì¼ ì£¼ì†Œ (ì„ íƒ) */\n    email?: string;\n    /** ì‚¬ìš©ì ì—­í•  */\n    role: 'admin' | 'user' | 'guest';\n    /** ê³„ì • ìƒì„± ì‹œê° */\n    created_at: string;\n    /** ë§ˆì§€ë§‰ ì •ë³´ ìˆ˜ì • ì‹œê° */\n    updated_at: string;\n    /** ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê° */\n    last_login?: string;\n    /** ê³„ì • í™œì„±í™” ìƒíƒœ */\n    is_active: boolean;\n}\n\n/**\n * ëŒ€í™” ì„¸ì…˜ ì¸í„°í˜ì´ìŠ¤\n * #12 ê°œì„ : any â†’ êµ¬ì²´ì  íƒ€ì…\n */\nexport interface ConversationSession {\n    /** ì„¸ì…˜ ê³ ìœ  ID */\n    id: string;\n    /** ì†Œìœ  ì‚¬ìš©ì ID */\n    user_id?: string;\n    /** ì„¸ì…˜ ì œëª© */\n    title: string;\n    /** ìƒì„± ì‹œê° */\n    created_at: string;\n    /** ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê° */\n    updated_at: string;\n    /** ì¶”ê°€ ë©”íƒ€ë°ì´í„° (JSON) */\n    metadata?: Record<string, unknown>;\n}\n\n/**\n * ëŒ€í™” ë©”ì‹œì§€ ì¸í„°í˜ì´ìŠ¤\n */\nexport interface ConversationMessage {\n    /** ë©”ì‹œì§€ ê³ ìœ  ID (ìë™ ì¦ê°€) */\n    id: number;\n    /** ì†Œì† ì„¸ì…˜ ID */\n    session_id: string;\n    /** ë©”ì‹œì§€ ì—­í•  */\n    role: 'user' | 'assistant' | 'system';\n    /** ë©”ì‹œì§€ ë‚´ìš© */\n    content: string;\n    /** ì‚¬ìš©ëœ LLM ëª¨ë¸ */\n    model?: string;\n    /** ì‘ë‹µí•œ ì—ì´ì „íŠ¸ ID */\n    agent_id?: string;\n    /** ì‚¬ê³  ê³¼ì • (Thinking) */\n    thinking?: string;\n    /** ì‚¬ìš©ëœ í† í° ìˆ˜ */\n    tokens?: number;\n    /** ì‘ë‹µ ì‹œê°„ (ë°€ë¦¬ì´ˆ) */\n    response_time_ms?: number;\n    /** ìƒì„± ì‹œê° */\n    created_at: string;\n}\n\n// ============================================\n// ğŸ§  ì¥ê¸° ë©”ëª¨ë¦¬ ì¸í„°í˜ì´ìŠ¤\n// ============================================\n\n/**\n * ë©”ëª¨ë¦¬ ì¹´í…Œê³ ë¦¬ íƒ€ì…\n * \n * - `preference`: ì‚¬ìš©ì ì„ í˜¸ë„ (ì–¸ì–´, ìŠ¤íƒ€ì¼ ë“±)\n * - `fact`: ì‚¬ì‹¤ ì •ë³´ (ì§ì—…, ê±°ì£¼ì§€ ë“±)\n * - `project`: ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ ì •ë³´\n * - `relationship`: ê´€ê³„ ì •ë³´ (ë™ë£Œ, íšŒì‚¬ ë“±)\n * - `skill`: ë³´ìœ  ê¸°ìˆ /ì—­ëŸ‰\n * - `context`: ë§¥ë½ ì •ë³´\n */\nexport type MemoryCategory = 'preference' | 'fact' | 'project' | 'relationship' | 'skill' | 'context';\n\n/**\n * ì‚¬ìš©ì ë©”ëª¨ë¦¬ ì¸í„°í˜ì´ìŠ¤\n * \n * ì„¸ì…˜ ê°„ ìœ ì§€ë˜ëŠ” ì¥ê¸° ë©”ëª¨ë¦¬ í•­ëª©ì…ë‹ˆë‹¤.\n */\nexport interface UserMemory {\n    /** ë©”ëª¨ë¦¬ ê³ ìœ  ID */\n    id: string;\n    /** ì†Œìœ  ì‚¬ìš©ì ID */\n    user_id: string;\n    /** ë©”ëª¨ë¦¬ ì¹´í…Œê³ ë¦¬ */\n    category: MemoryCategory;\n    /** ë©”ëª¨ë¦¬ í‚¤ (ì¹´í…Œê³ ë¦¬ ë‚´ ê³ ìœ ) */\n    key: string;\n    /** ë©”ëª¨ë¦¬ ê°’ */\n    value: string;\n    /** ì¤‘ìš”ë„ (0.0 ~ 1.0) */\n    importance: number;\n    /** ì ‘ê·¼ íšŸìˆ˜ */\n    access_count: number;\n    /** ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê° */\n    last_accessed?: string;\n    /** ì›ë³¸ ì„¸ì…˜ ID */\n    source_session_id?: string;\n    /** ìƒì„± ì‹œê° */\n    created_at: string;\n    /** ìˆ˜ì • ì‹œê° */\n    updated_at: string;\n    /** ë§Œë£Œ ì‹œê° */\n    expires_at?: string;\n    /** ì—°ê´€ íƒœê·¸ ëª©ë¡ */\n    tags?: string[];\n}\n\n// ============================================\n// ğŸ” Deep Research ì¸í„°í˜ì´ìŠ¤\n// ============================================\n\n/**\n * ë¦¬ì„œì¹˜ ìƒíƒœ íƒ€ì…\n */\nexport type ResearchStatus = 'pending' | 'running' | 'completed' | 'failed' | 'cancelled';\n\n/**\n * ë¦¬ì„œì¹˜ ê¹Šì´ íƒ€ì…\n * \n * - `quick`: ë¹ ë¥¸ ê²€ìƒ‰ (1-2ë¶„)\n * - `standard`: í‘œì¤€ ê²€ìƒ‰ (5-10ë¶„)\n * - `deep`: ì‹¬ì¸µ ê²€ìƒ‰ (15ë¶„ ì´ìƒ)\n */\nexport type ResearchDepth = 'quick' | 'standard' | 'deep';\n\n/**\n * ë¦¬ì„œì¹˜ ì„¸ì…˜ ì¸í„°í˜ì´ìŠ¤\n */\nexport interface ResearchSession {\n    /** ì„¸ì…˜ ê³ ìœ  ID */\n    id: string;\n    /** ìš”ì²­ ì‚¬ìš©ì ID */\n    user_id?: string;\n    /** ë¦¬ì„œì¹˜ ì£¼ì œ */\n    topic: string;\n    /** í˜„ì¬ ìƒíƒœ */\n    status: ResearchStatus;\n    /** ê²€ìƒ‰ ê¹Šì´ */\n    depth: ResearchDepth;\n    /** ì§„í–‰ë¥  (0-100) */\n    progress: number;\n    /** ìµœì¢… ìš”ì•½ */\n    summary?: string;\n    /** í•µì‹¬ ë°œê²¬ ì‚¬í•­ ëª©ë¡ */\n    key_findings?: string[];\n    /** ì°¸ê³  ì¶œì²˜ ëª©ë¡ (#12 ê°œì„ : any â†’ êµ¬ì²´ì  íƒ€ì…) */\n    sources?: Array<{ url?: string; title?: string; snippet?: string; [key: string]: unknown }>;\n    /** ìƒì„± ì‹œê° */\n    created_at: string;\n    /** ìˆ˜ì • ì‹œê° */\n    updated_at: string;\n    /** ì™„ë£Œ ì‹œê° */\n    completed_at?: string;\n}\n\n/**\n * ë¦¬ì„œì¹˜ ë‹¨ê³„ ì¸í„°í˜ì´ìŠ¤\n */\nexport interface ResearchStep {\n    /** ë‹¨ê³„ ê³ ìœ  ID */\n    id: number;\n    /** ì†Œì† ì„¸ì…˜ ID */\n    session_id: string;\n    /** ë‹¨ê³„ ë²ˆí˜¸ */\n    step_number: number;\n    /** ë‹¨ê³„ ìœ í˜• (search, analyze, summarize ë“±) */\n    step_type: string;\n    /** ê²€ìƒ‰ ì¿¼ë¦¬ */\n    query?: string;\n    /** ë‹¨ê³„ ê²°ê³¼ */\n    result?: string;\n    /** ì´ ë‹¨ê³„ì˜ ì¶œì²˜ (#12 ê°œì„ ) */\n    sources?: Array<{ url?: string; title?: string; snippet?: string; [key: string]: unknown }>;\n    /** ë‹¨ê³„ ìƒíƒœ */\n    status: string;\n    /** ìƒì„± ì‹œê° */\n    created_at: string;\n}\n\n// ============================================\n// ğŸª Agent ë§ˆì¼“í”Œë ˆì´ìŠ¤ ì¸í„°í˜ì´ìŠ¤\n// ============================================\n\nexport type MarketplaceStatus = 'pending' | 'approved' | 'rejected' | 'suspended';\n\nexport interface MarketplaceAgent {\n    id: string;\n    agent_id: string;\n    author_id: string;\n    title: string;\n    description?: string;\n    long_description?: string;\n    category?: string;\n    tags?: string[];\n    icon: string;\n    banner_url?: string;\n    price: number;\n    is_free: boolean;\n    is_featured: boolean;\n    is_verified: boolean;\n    downloads: number;\n    rating_avg: number;\n    rating_count: number;\n    version: string;\n    changelog?: string;\n    status: MarketplaceStatus;\n    created_at: string;\n    updated_at: string;\n    published_at?: string;\n}\n\nexport interface AgentReview {\n    id: string;\n    marketplace_id: string;\n    user_id: string;\n    rating: number;\n    title?: string;\n    content?: string;\n    helpful_count: number;\n    created_at: string;\n    updated_at: string;\n}\n\n// ============================================\n// ğŸ“ Canvas ì¸í„°í˜ì´ìŠ¤\n// ============================================\n\nexport type CanvasDocType = 'document' | 'code' | 'diagram' | 'table';\n\nexport interface CanvasDocument {\n    id: string;\n    user_id: string;\n    session_id?: string;\n    title: string;\n    doc_type: CanvasDocType;\n    content?: string;\n    language?: string;\n    version: number;\n    is_shared: boolean;\n    share_token?: string;\n    created_at: string;\n    updated_at: string;\n}\n\nexport interface CanvasVersion {\n    id: number;\n    document_id: string;\n    version: number;\n    content: string;\n    change_summary?: string;\n    created_by?: string;\n    created_at: string;\n}\n\n// ============================================\n// ğŸ”— ì™¸ë¶€ ì„œë¹„ìŠ¤ í†µí•© ì¸í„°í˜ì´ìŠ¤\n// ============================================\n\nexport type ExternalServiceType = 'google_drive' | 'notion' | 'github' | 'slack' | 'dropbox';\n\nexport interface ExternalConnection {\n    id: string;\n    user_id: string;\n    service_type: ExternalServiceType;\n    access_token?: string;\n    refresh_token?: string;\n    token_expires_at?: string;\n    account_email?: string;\n    account_name?: string;\n    metadata?: Record<string, unknown>;\n    is_active: boolean;\n    created_at: string;\n    updated_at: string;\n}\n\nexport interface ExternalFile {\n    id: string;\n    connection_id: string;\n    external_id: string;\n    file_name: string;\n    file_type?: string;\n    file_size?: number;\n    web_url?: string;\n    last_synced?: string;\n    cached_content?: string;\n    created_at: string;\n}\n\n/**\n * í†µí•© ë°ì´í„°ë² ì´ìŠ¤ í´ë˜ìŠ¤\n * \n * SQLite ê¸°ë°˜ì˜ í†µí•© ë°ì´í„° ì €ì¥ì†Œì…ë‹ˆë‹¤. better-sqlite3ë¥¼ ì‚¬ìš©í•˜ì—¬\n * ë™ê¸°ì‹ APIì™€ WAL ëª¨ë“œë¡œ ë†’ì€ ì„±ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.\n * \n * @class UnifiedDatabase\n * \n * @example\n * ```typescript\n * const db = new UnifiedDatabase('./data');\n * \n * // ì‚¬ìš©ì ê´€ë¦¬\n * db.createUser('id', 'username', 'hash', 'email@test.com');\n * const user = db.getUserByUsername('username');\n * \n * // ëŒ€í™” ê´€ë¦¬\n * db.createSession('session-1', user.id, 'ìƒˆ ëŒ€í™”');\n * db.addMessage('session-1', 'user', 'ì•ˆë…•í•˜ì„¸ìš”');\n * \n * // ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œ\n * db.createMemory({\n *   id: 'mem-1',\n *   userId: user.id,\n *   category: 'preference',\n *   key: 'language',\n *   value: 'Korean'\n * });\n * \n * db.close();\n * ```\n */\nexport class UnifiedDatabase {\n    /** better-sqlite3 ë°ì´í„°ë² ì´ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ */\n    private db: Database.Database;\n    \n    /** ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ê²½ë¡œ */\n    private dbPath: string;\n\n    /** #13 ê°œì„ : Prepared Statement ìºì‹œ */\n    private stmtCache: Map<string, Database.Statement> = new Map();\n\n    /**\n     * UnifiedDatabase ì¸ìŠ¤í„´ìŠ¤ ìƒì„±\n     * \n     * ì§€ì •ëœ ë””ë ‰í† ë¦¬ì— unified.db íŒŒì¼ì„ ìƒì„±í•˜ê±°ë‚˜ ì—´ê³ \n     * ìŠ¤í‚¤ë§ˆë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.\n     * \n     * @param dataDir - ë°ì´í„° ë””ë ‰í† ë¦¬ ê²½ë¡œ (ê¸°ë³¸ê°’: './data')\n     */\n    constructor(dataDir: string = './data') {\n        // ë””ë ‰í† ë¦¬ ìƒì„±\n        if (!fs.existsSync(dataDir)) {\n            fs.mkdirSync(dataDir, { recursive: true });\n        }\n\n        this.dbPath = path.join(dataDir, 'unified.db');\n        this.db = new Database(this.dbPath);\n        this.db.pragma('journal_mode = WAL');\n\n        // ìŠ¤í‚¤ë§ˆ ì´ˆê¸°í™”\n        this.initSchema();\n\n        console.log(`[UnifiedDB] ì´ˆê¸°í™” ì™„ë£Œ: ${this.dbPath}`);\n    }\n\n    /**\n     * ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì´ˆê¸°í™”\n     * @internal\n     */\n    private initSchema(): void {\n        this.db.exec(SCHEMA);\n    }\n\n    /**\n     * ì›ì‹œ ë°ì´í„°ë² ì´ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ íšë“\n     * \n     * ì§ì ‘ì ì¸ SQL ì¿¼ë¦¬ ì‹¤í–‰ì´ í•„ìš”í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.\n     * \n     * @returns better-sqlite3 Database ì¸ìŠ¤í„´ìŠ¤\n     */\n    getDatabase(): Database.Database {\n        return this.db;\n    }\n\n    /**\n     * #13 ê°œì„ : Prepared Statement ìºì‹±\n     * ë™ì¼ SQLì„ ë°˜ë³µ ì‹¤í–‰í•  ë•Œ prepare() ë¹„ìš© ì ˆê°\n     */\n    private cachedPrepare(sql: string): Database.Statement {\n        let stmt = this.stmtCache.get(sql);\n        if (!stmt) {\n            stmt = this.db.prepare(sql);\n            this.stmtCache.set(sql, stmt);\n        }\n        return stmt;\n    }\n\n    // ===== ì‚¬ìš©ì ê´€ë¦¬ =====\n\n    /**\n     * ìƒˆ ì‚¬ìš©ì ìƒì„±\n     * \n     * @param id - ì‚¬ìš©ì ê³ ìœ  ID\n     * @param username - ë¡œê·¸ì¸ìš© ì‚¬ìš©ìëª…\n     * @param passwordHash - í•´ì‹œëœ ë¹„ë°€ë²ˆí˜¸\n     * @param email - ì´ë©”ì¼ ì£¼ì†Œ (ì„ íƒ)\n     * @param role - ì—­í•  (ê¸°ë³¸ê°’: 'user')\n     * @returns SQLite ì‹¤í–‰ ê²°ê³¼\n     */\n    createUser(id: string, username: string, passwordHash: string, email?: string, role: string = 'user') {\n        const stmt = this.db.prepare(`\n            INSERT INTO users (id, username, password_hash, email, role)\n            VALUES (?, ?, ?, ?, ?)\n        `);\n        return stmt.run(id, username, passwordHash, email, role);\n    }\n\n    /**\n     * ì‚¬ìš©ìëª…ìœ¼ë¡œ ì‚¬ìš©ì ì¡°íšŒ\n     * \n     * @param username - ê²€ìƒ‰í•  ì‚¬ìš©ìëª…\n     * @returns ì‚¬ìš©ì ì •ë³´ ë˜ëŠ” undefined\n     */\n    getUserByUsername(username: string): User | undefined {\n        const stmt = this.cachedPrepare('SELECT * FROM users WHERE username = ?');\n        return stmt.get(username) as User | undefined;\n    }\n\n    /**\n     * IDë¡œ ì‚¬ìš©ì ì¡°íšŒ\n     * \n     * @param id - ì‚¬ìš©ì ID\n     * @returns ì‚¬ìš©ì ì •ë³´ ë˜ëŠ” undefined\n     */\n    getUserById(id: string): User | undefined {\n        const stmt = this.cachedPrepare('SELECT * FROM users WHERE id = ?');\n        return stmt.get(id) as User | undefined;\n    }\n\n    /**\n     * ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê° ì—…ë°ì´íŠ¸\n     * \n     * @param userId - ì‚¬ìš©ì ID\n     * @returns SQLite ì‹¤í–‰ ê²°ê³¼\n     */\n    updateLastLogin(userId: string) {\n        const stmt = this.cachedPrepare('UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?');\n        return stmt.run(userId);\n    }\n\n    /**\n     * ì „ì²´ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ\n     * \n     * @param limit - ìµœëŒ€ ì¡°íšŒ ìˆ˜ (ê¸°ë³¸ê°’: 50)\n     * @returns ì‚¬ìš©ì ë°°ì—´\n     */\n    getAllUsers(limit: number = 50): User[] {\n        const stmt = this.db.prepare('SELECT * FROM users ORDER BY created_at DESC LIMIT ?');\n        return stmt.all(limit) as User[];\n    }\n\n    // ===== ëŒ€í™” ê´€ë¦¬ =====\n\n    /**\n     * ìƒˆ ëŒ€í™” ì„¸ì…˜ ìƒì„±\n     * \n     * @param id - ì„¸ì…˜ ê³ ìœ  ID\n     * @param userId - ì†Œìœ  ì‚¬ìš©ì ID (ì„ íƒ)\n     * @param title - ì„¸ì…˜ ì œëª© (ê¸°ë³¸ê°’: 'ìƒˆ ëŒ€í™”')\n     * @param metadata - ì¶”ê°€ ë©”íƒ€ë°ì´í„° (ì„ íƒ)\n     * @returns SQLite ì‹¤í–‰ ê²°ê³¼\n     */\n    createSession(id: string, userId?: string, title?: string, metadata?: any) {\n        const stmt = this.db.prepare(`\n            INSERT INTO conversation_sessions (id, user_id, title, metadata)\n            VALUES (?, ?, ?, ?)\n        `);\n        return stmt.run(id, userId, title || 'ìƒˆ ëŒ€í™”', JSON.stringify(metadata || {}));\n    }\n\n    /**\n     * ëŒ€í™” ë©”ì‹œì§€ ì¶”ê°€\n     * \n     * @param sessionId - ì„¸ì…˜ ID\n     * @param role - ë©”ì‹œì§€ ì—­í•  ('user', 'assistant', 'system')\n     * @param content - ë©”ì‹œì§€ ë‚´ìš©\n     * @param options - ì¶”ê°€ ì˜µì…˜\n     * @param options.model - ì‚¬ìš©ëœ ëª¨ë¸ëª…\n     * @param options.agentId - ì‘ë‹µ ì—ì´ì „íŠ¸ ID\n     * @param options.thinking - ì‚¬ê³  ê³¼ì •\n     * @param options.tokens - ì‚¬ìš© í† í° ìˆ˜\n     * @param options.responseTimeMs - ì‘ë‹µ ì‹œê°„(ms)\n     * @returns SQLite ì‹¤í–‰ ê²°ê³¼\n     */\n    addMessage(sessionId: string, role: string, content: string, options?: {\n        model?: string;\n        agentId?: string;\n        thinking?: string;\n        tokens?: number;\n        responseTimeMs?: number;\n    }) {\n        const stmt = this.db.prepare(`\n            INSERT INTO conversation_messages \n            (session_id, role, content, model, agent_id, thinking, tokens, response_time_ms)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n        `);\n        return stmt.run(\n            sessionId, role, content,\n            options?.model, options?.agentId, options?.thinking,\n            options?.tokens, options?.responseTimeMs\n        );\n    }\n\n    getSessionMessages(sessionId: string, limit: number = 100): ConversationMessage[] {\n        const stmt = this.cachedPrepare(`SELECT * FROM conversation_messages WHERE session_id = ? ORDER BY created_at ASC LIMIT ?`);\n        return stmt.all(sessionId, limit) as ConversationMessage[];\n    }\n\n    getUserSessions(userId: string, limit: number = 50): ConversationSession[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM conversation_sessions \n            WHERE user_id = ? \n            ORDER BY updated_at DESC \n            LIMIT ?\n        `);\n        return stmt.all(userId, limit) as ConversationSession[];\n    }\n\n    getAllSessions(limit: number = 50): ConversationSession[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM conversation_sessions \n            ORDER BY updated_at DESC \n            LIMIT ?\n        `);\n        return stmt.all(limit) as ConversationSession[];\n    }\n\n    deleteSession(sessionId: string) {\n        const stmt = this.db.prepare('DELETE FROM conversation_sessions WHERE id = ?');\n        return stmt.run(sessionId);\n    }\n\n    // ===== API ì‚¬ìš©ëŸ‰ ê´€ë¦¬ =====\n\n    recordApiUsage(date: string, apiKeyId: string, requests: number, tokens: number, errors: number, avgResponseTime: number, models: any) {\n        const stmt = this.db.prepare(`\n            INSERT INTO api_usage (date, api_key_id, requests, tokens, errors, avg_response_time, models)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n            ON CONFLICT(date, api_key_id) DO UPDATE SET\n                requests = requests + excluded.requests,\n                tokens = tokens + excluded.tokens,\n                errors = errors + excluded.errors,\n                avg_response_time = (avg_response_time + excluded.avg_response_time) / 2,\n                models = excluded.models,\n                updated_at = CURRENT_TIMESTAMP\n        `);\n        return stmt.run(date, apiKeyId, requests, tokens, errors, avgResponseTime, JSON.stringify(models));\n    }\n\n    getDailyUsage(days: number = 7) {\n        const stmt = this.db.prepare(`\n            SELECT date, SUM(requests) as requests, SUM(tokens) as tokens, SUM(errors) as errors, AVG(avg_response_time) as avg_response_time\n            FROM api_usage\n            WHERE date >= date('now', '-' || ? || ' days')\n            GROUP BY date\n            ORDER BY date DESC\n        `);\n        return stmt.all(days);\n    }\n\n    // ===== ì—ì´ì „íŠ¸ ë¡œê·¸ =====\n\n    logAgentUsage(params: {\n        userId?: string;\n        sessionId?: string;\n        agentId: string;\n        query: string;\n        responsePreview?: string;\n        responseTimeMs?: number;\n        tokensUsed?: number;\n        success?: boolean;\n        errorMessage?: string;\n    }) {\n        const stmt = this.db.prepare(`\n            INSERT INTO agent_usage_logs \n            (user_id, session_id, agent_id, query, response_preview, response_time_ms, tokens_used, success, error_message)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n        `);\n        return stmt.run(\n            params.userId, params.sessionId, params.agentId,\n            params.query, params.responsePreview,\n            params.responseTimeMs, params.tokensUsed,\n            params.success !== false ? 1 : 0,\n            params.errorMessage\n        );\n    }\n\n    getAgentStats(agentId: string) {\n        const stmt = this.db.prepare(`\n            SELECT \n                COUNT(*) as total_requests,\n                SUM(CASE WHEN success = 1 THEN 1 ELSE 0 END) as successful_requests,\n                AVG(response_time_ms) as avg_response_time,\n                AVG(tokens_used) as avg_tokens\n            FROM agent_usage_logs\n            WHERE agent_id = ?\n        `);\n        return stmt.get(agentId);\n    }\n\n    // ===== ê°ì‚¬ ë¡œê·¸ =====\n\n    logAudit(params: {\n        action: string;\n        userId?: string;\n        resourceType?: string;\n        resourceId?: string;\n        details?: any;\n        ipAddress?: string;\n        userAgent?: string;\n    }) {\n        const stmt = this.db.prepare(`\n            INSERT INTO audit_logs \n            (action, user_id, resource_type, resource_id, details, ip_address, user_agent)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n        `);\n        return stmt.run(\n            params.action, params.userId, params.resourceType, params.resourceId,\n            JSON.stringify(params.details || {}), params.ipAddress, params.userAgent\n        );\n    }\n\n    getAuditLogs(limit: number = 100) {\n        const stmt = this.db.prepare(`\n            SELECT * FROM audit_logs ORDER BY timestamp DESC LIMIT ?\n        `);\n        return stmt.all(limit);\n    }\n\n    // ===== í†µê³„ =====\n\n    /**\n     * #2 ê°œì„ : tablesì™€ validTables ë¶ˆì¼ì¹˜ ìˆ˜ì • â†’ ë‹¨ì¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¡œ í†µí•©\n     * ëª¨ë“  í…Œì´ë¸”ì˜ í†µê³„ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.\n     */\n    getStats(): Record<string, number> {\n        // #2: ë‹¨ì¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ - ëª¨ë“  í…Œì´ë¸” í¬í•¨\n        const VALID_TABLES = [\n            'users', 'conversation_sessions', 'conversation_messages',\n            'api_usage', 'agent_usage_logs', 'agent_feedback',\n            'custom_agents', 'audit_logs', 'alert_history',\n            'user_memories', 'memory_tags',\n            'research_sessions', 'research_steps',\n            'agent_marketplace', 'agent_reviews', 'agent_installations',\n            'canvas_documents', 'canvas_versions', 'canvas_ai_edits',\n            'external_connections', 'external_files'\n        ] as const;\n\n        const stats: Record<string, number> = {};\n\n        for (const table of VALID_TABLES) {\n            // #2: const assertionìœ¼ë¡œ ì•ˆì „í•œ í…Œì´ë¸”ëª… ë³´ì¥ (ëŸ°íƒ€ì„ ì¸ì ì…˜ ë¶ˆê°€)\n            const stmt = this.db.prepare(`SELECT COUNT(*) as count FROM ${table}`);\n            const result = stmt.get() as { count: number };\n            stats[table] = result.count;\n        }\n\n        return stats;\n    }\n\n    // ============================================\n    // ğŸ§  ì¥ê¸° ë©”ëª¨ë¦¬ ê´€ë¦¬\n    // ============================================\n\n    /**\n     * ìƒˆ ë©”ëª¨ë¦¬ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸\n     * \n     * ë™ì¼í•œ (user_id, category, key) ì¡°í•©ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.\n     * \n     * @param params - ë©”ëª¨ë¦¬ ìƒì„± íŒŒë¼ë¯¸í„°\n     * @param params.id - ë©”ëª¨ë¦¬ ê³ ìœ  ID\n     * @param params.userId - ì†Œìœ  ì‚¬ìš©ì ID\n     * @param params.category - ë©”ëª¨ë¦¬ ì¹´í…Œê³ ë¦¬\n     * @param params.key - ë©”ëª¨ë¦¬ í‚¤\n     * @param params.value - ë©”ëª¨ë¦¬ ê°’\n     * @param params.importance - ì¤‘ìš”ë„ (0.0~1.0, ê¸°ë³¸ê°’: 0.5)\n     * @param params.sourceSessionId - ì›ë³¸ ì„¸ì…˜ ID\n     * @param params.expiresAt - ë§Œë£Œ ì‹œê°\n     * @param params.tags - ì—°ê´€ íƒœê·¸ ëª©ë¡\n     */\n    createMemory(params: {\n        id: string;\n        userId: string;\n        category: MemoryCategory;\n        key: string;\n        value: string;\n        importance?: number;\n        sourceSessionId?: string;\n        expiresAt?: string;\n        tags?: string[];\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO user_memories (id, user_id, category, key, value, importance, source_session_id, expires_at)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n            ON CONFLICT(user_id, category, key) DO UPDATE SET\n                value = excluded.value,\n                importance = excluded.importance,\n                updated_at = CURRENT_TIMESTAMP\n        `);\n        stmt.run(\n            params.id, params.userId, params.category, params.key, params.value,\n            params.importance || 0.5, params.sourceSessionId, params.expiresAt\n        );\n\n        // íƒœê·¸ ì¶”ê°€\n        if (params.tags && params.tags.length > 0) {\n            const tagStmt = this.db.prepare(`\n                INSERT OR IGNORE INTO memory_tags (memory_id, tag) VALUES (?, ?)\n            `);\n            for (const tag of params.tags) {\n                tagStmt.run(params.id, tag);\n            }\n        }\n    }\n\n    /**\n     * ì‚¬ìš©ì ë©”ëª¨ë¦¬ ì¡°íšŒ\n     * \n     * @param userId - ì‚¬ìš©ì ID\n     * @param options - í•„í„° ì˜µì…˜\n     * @param options.category - íŠ¹ì • ì¹´í…Œê³ ë¦¬ë§Œ ì¡°íšŒ\n     * @param options.limit - ìµœëŒ€ ì¡°íšŒ ìˆ˜ (ê¸°ë³¸ê°’: 50)\n     * @param options.minImportance - ìµœì†Œ ì¤‘ìš”ë„ í•„í„°\n     * @returns ë©”ëª¨ë¦¬ ë°°ì—´ (ì¤‘ìš”ë„ìˆœ ì •ë ¬)\n     */\n    getUserMemories(userId: string, options?: {\n        category?: MemoryCategory;\n        limit?: number;\n        minImportance?: number;\n    }): UserMemory[] {\n        let sql = `\n            SELECT m.*, GROUP_CONCAT(t.tag) as tags_str\n            FROM user_memories m\n            LEFT JOIN memory_tags t ON m.id = t.memory_id\n            WHERE m.user_id = ?\n        `;\n        const params: any[] = [userId];\n\n        if (options?.category) {\n            sql += ` AND m.category = ?`;\n            params.push(options.category);\n        }\n        if (options?.minImportance) {\n            sql += ` AND m.importance >= ?`;\n            params.push(options.minImportance);\n        }\n\n        sql += ` GROUP BY m.id ORDER BY m.importance DESC, m.last_accessed DESC LIMIT ?`;\n        params.push(options?.limit || 50);\n\n        const stmt = this.db.prepare(sql);\n        const results = stmt.all(...params) as any[];\n        \n        return results.map(r => ({\n            ...r,\n            tags: r.tags_str ? r.tags_str.split(',') : []\n        }));\n    }\n\n    /**\n     * ì§ˆë¬¸ê³¼ ê´€ë ¨ëœ ë©”ëª¨ë¦¬ ê²€ìƒ‰\n     * \n     * í‚¤ì›Œë“œ ê¸°ë°˜ìœ¼ë¡œ ê´€ë ¨ ë©”ëª¨ë¦¬ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.\n     * ê²€ìƒ‰ëœ ë©”ëª¨ë¦¬ì˜ ì ‘ê·¼ íšŸìˆ˜ê°€ ìë™ìœ¼ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.\n     * \n     * @param userId - ì‚¬ìš©ì ID\n     * @param query - ê²€ìƒ‰ ì§ˆë¬¸\n     * @param limit - ìµœëŒ€ ê²°ê³¼ ìˆ˜ (ê¸°ë³¸ê°’: 10)\n     * @returns ê´€ë ¨ ë©”ëª¨ë¦¬ ë°°ì—´ (ì¤‘ìš”ë„ìˆœ)\n     * \n     * @example\n     * ```typescript\n     * const memories = db.getRelevantMemories('user-1', 'í”„ë¡œì íŠ¸ ì§„í–‰ ìƒí™©');\n     * memories.forEach(m => console.log(`${m.key}: ${m.value}`));\n     * ```\n     */\n    getRelevantMemories(userId: string, query: string, limit: number = 10): UserMemory[] {\n        // ê°„ë‹¨í•œ í‚¤ì›Œë“œ ë§¤ì¹­ ê¸°ë°˜ ê²€ìƒ‰ (ì¶”í›„ ë²¡í„° ê²€ìƒ‰ìœ¼ë¡œ ê°œì„  ê°€ëŠ¥)\n        const keywords = query.toLowerCase().split(/\\s+/).filter(k => k.length > 2);\n        if (keywords.length === 0) return [];\n\n        const conditions = keywords.map(() => `(LOWER(m.key) LIKE ? OR LOWER(m.value) LIKE ?)`).join(' OR ');\n        const params: any[] = [userId];\n        keywords.forEach(k => {\n            params.push(`%${k}%`, `%${k}%`);\n        });\n        params.push(limit);\n\n        const sql = `\n            SELECT m.*, GROUP_CONCAT(t.tag) as tags_str\n            FROM user_memories m\n            LEFT JOIN memory_tags t ON m.id = t.memory_id\n            WHERE m.user_id = ? AND (${conditions})\n            GROUP BY m.id\n            ORDER BY m.importance DESC\n            LIMIT ?\n        `;\n\n        const stmt = this.db.prepare(sql);\n        const results = stmt.all(...params) as any[];\n\n        // ì ‘ê·¼ íšŸìˆ˜ ì—…ë°ì´íŠ¸\n        const updateStmt = this.db.prepare(`\n            UPDATE user_memories SET access_count = access_count + 1, last_accessed = CURRENT_TIMESTAMP\n            WHERE id = ?\n        `);\n        results.forEach(r => updateStmt.run(r.id));\n\n        return results.map(r => ({\n            ...r,\n            tags: r.tags_str ? r.tags_str.split(',') : []\n        }));\n    }\n\n    updateMemory(memoryId: string, updates: { value?: string; importance?: number }): void {\n        const sets: string[] = ['updated_at = CURRENT_TIMESTAMP'];\n        const params: any[] = [];\n\n        if (updates.value !== undefined) {\n            sets.push('value = ?');\n            params.push(updates.value);\n        }\n        if (updates.importance !== undefined) {\n            sets.push('importance = ?');\n            params.push(updates.importance);\n        }\n        params.push(memoryId);\n\n        const stmt = this.db.prepare(`UPDATE user_memories SET ${sets.join(', ')} WHERE id = ?`);\n        stmt.run(...params);\n    }\n\n    deleteMemory(memoryId: string): void {\n        const stmt = this.db.prepare('DELETE FROM user_memories WHERE id = ?');\n        stmt.run(memoryId);\n    }\n\n    deleteUserMemories(userId: string): void {\n        const stmt = this.db.prepare('DELETE FROM user_memories WHERE user_id = ?');\n        stmt.run(userId);\n    }\n\n    // ============================================\n    // ğŸ” Deep Research ê´€ë¦¬\n    // ============================================\n\n    createResearchSession(params: {\n        id: string;\n        userId?: string;\n        topic: string;\n        depth?: ResearchDepth;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO research_sessions (id, user_id, topic, depth)\n            VALUES (?, ?, ?, ?)\n        `);\n        stmt.run(params.id, params.userId, params.topic, params.depth || 'standard');\n    }\n\n    updateResearchSession(sessionId: string, updates: {\n        status?: ResearchStatus;\n        progress?: number;\n        summary?: string;\n        keyFindings?: string[];\n        sources?: any[];\n    }): void {\n        const sets: string[] = ['updated_at = CURRENT_TIMESTAMP'];\n        const params: any[] = [];\n\n        if (updates.status !== undefined) {\n            sets.push('status = ?');\n            params.push(updates.status);\n            if (updates.status === 'completed') {\n                sets.push('completed_at = CURRENT_TIMESTAMP');\n            }\n        }\n        if (updates.progress !== undefined) {\n            sets.push('progress = ?');\n            params.push(updates.progress);\n        }\n        if (updates.summary !== undefined) {\n            sets.push('summary = ?');\n            params.push(updates.summary);\n        }\n        if (updates.keyFindings !== undefined) {\n            sets.push('key_findings = ?');\n            params.push(JSON.stringify(updates.keyFindings));\n        }\n        if (updates.sources !== undefined) {\n            sets.push('sources = ?');\n            params.push(JSON.stringify(updates.sources));\n        }\n        params.push(sessionId);\n\n        const stmt = this.db.prepare(`UPDATE research_sessions SET ${sets.join(', ')} WHERE id = ?`);\n        stmt.run(...params);\n    }\n\n    addResearchStep(params: {\n        sessionId: string;\n        stepNumber: number;\n        stepType: string;\n        query?: string;\n        result?: string;\n        sources?: any[];\n        status?: string;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO research_steps (session_id, step_number, step_type, query, result, sources, status)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n        `);\n        stmt.run(\n            params.sessionId, params.stepNumber, params.stepType,\n            params.query, params.result,\n            params.sources ? JSON.stringify(params.sources) : null,\n            params.status || 'pending'\n        );\n    }\n\n    getResearchSession(sessionId: string): ResearchSession | undefined {\n        const stmt = this.db.prepare('SELECT * FROM research_sessions WHERE id = ?');\n        const result = stmt.get(sessionId) as any;\n        if (!result) return undefined;\n\n        return {\n            ...result,\n            key_findings: result.key_findings ? JSON.parse(result.key_findings) : [],\n            sources: result.sources ? JSON.parse(result.sources) : []\n        };\n    }\n\n    getResearchSteps(sessionId: string): ResearchStep[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM research_steps WHERE session_id = ? ORDER BY step_number\n        `);\n        return stmt.all(sessionId).map((r: any) => ({\n            ...r,\n            sources: r.sources ? JSON.parse(r.sources) : []\n        })) as ResearchStep[];\n    }\n\n    getUserResearchSessions(userId: string, limit: number = 20): ResearchSession[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM research_sessions WHERE user_id = ?\n            ORDER BY created_at DESC LIMIT ?\n        `);\n        return stmt.all(userId, limit).map((r: any) => ({\n            ...r,\n            key_findings: r.key_findings ? JSON.parse(r.key_findings) : [],\n            sources: r.sources ? JSON.parse(r.sources) : []\n        })) as ResearchSession[];\n    }\n\n    // ============================================\n    // ğŸª Agent ë§ˆì¼“í”Œë ˆì´ìŠ¤ ê´€ë¦¬\n    // ============================================\n\n    publishAgentToMarketplace(params: {\n        id: string;\n        agentId: string;\n        authorId: string;\n        title: string;\n        description?: string;\n        longDescription?: string;\n        category?: string;\n        tags?: string[];\n        icon?: string;\n        price?: number;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO agent_marketplace \n            (id, agent_id, author_id, title, description, long_description, category, tags, icon, price, is_free)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n        `);\n        stmt.run(\n            params.id, params.agentId, params.authorId, params.title,\n            params.description, params.longDescription, params.category,\n            params.tags ? JSON.stringify(params.tags) : null,\n            params.icon || 'ğŸ¤–',\n            params.price || 0,\n            (params.price || 0) === 0 ? 1 : 0\n        );\n    }\n\n    getMarketplaceAgents(options?: {\n        category?: string;\n        featured?: boolean;\n        status?: MarketplaceStatus;\n        search?: string;\n        limit?: number;\n        offset?: number;\n        sortBy?: 'downloads' | 'rating' | 'newest';\n    }): MarketplaceAgent[] {\n        let sql = 'SELECT * FROM agent_marketplace WHERE 1=1';\n        const params: any[] = [];\n\n        if (options?.status) {\n            sql += ' AND status = ?';\n            params.push(options.status);\n        } else {\n            sql += ' AND status = ?';\n            params.push('approved');\n        }\n\n        if (options?.category) {\n            sql += ' AND category = ?';\n            params.push(options.category);\n        }\n        if (options?.featured) {\n            sql += ' AND is_featured = 1';\n        }\n        if (options?.search) {\n            sql += ' AND (title LIKE ? OR description LIKE ?)';\n            params.push(`%${options.search}%`, `%${options.search}%`);\n        }\n\n        const sortColumn = options?.sortBy === 'rating' ? 'rating_avg' \n            : options?.sortBy === 'newest' ? 'created_at' \n            : 'downloads';\n        sql += ` ORDER BY ${sortColumn} DESC`;\n        sql += ` LIMIT ? OFFSET ?`;\n        params.push(options?.limit || 20, options?.offset || 0);\n\n        const stmt = this.db.prepare(sql);\n        return stmt.all(...params).map((r: any) => ({\n            ...r,\n            tags: r.tags ? JSON.parse(r.tags) : [],\n            is_free: !!r.is_free,\n            is_featured: !!r.is_featured,\n            is_verified: !!r.is_verified\n        })) as MarketplaceAgent[];\n    }\n\n    /**\n     * #18 ê°œì„ : ë‹¤ìš´ë¡œë“œ ìˆ˜ ê²½ìŸì¡°ê±´ ìˆ˜ì • â€” INSERT ì„±ê³µ ì‹œì—ë§Œ ì¹´ìš´íŠ¸ ì¦ê°€\n     * íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì›ìì„± ë³´ì¥\n     */\n    installAgent(marketplaceId: string, userId: string): void {\n        const installTransaction = this.db.transaction(() => {\n            const installStmt = this.db.prepare(`\n                INSERT OR IGNORE INTO agent_installations (marketplace_id, user_id)\n                VALUES (?, ?)\n            `);\n            const result = installStmt.run(marketplaceId, userId);\n\n            // #18: INSERTê°€ ì‹¤ì œë¡œ ìƒˆ í–‰ì„ ì¶”ê°€í•œ ê²½ìš°ì—ë§Œ ë‹¤ìš´ë¡œë“œ ìˆ˜ ì¦ê°€\n            if (result.changes > 0) {\n                const updateStmt = this.db.prepare(`\n                    UPDATE agent_marketplace SET downloads = downloads + 1 WHERE id = ?\n                `);\n                updateStmt.run(marketplaceId);\n            }\n        });\n        installTransaction();\n    }\n\n    addAgentReview(params: {\n        id: string;\n        marketplaceId: string;\n        userId: string;\n        rating: number;\n        title?: string;\n        content?: string;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO agent_reviews (id, marketplace_id, user_id, rating, title, content)\n            VALUES (?, ?, ?, ?, ?, ?)\n            ON CONFLICT(marketplace_id, user_id) DO UPDATE SET\n                rating = excluded.rating,\n                title = excluded.title,\n                content = excluded.content,\n                updated_at = CURRENT_TIMESTAMP\n        `);\n        stmt.run(params.id, params.marketplaceId, params.userId, params.rating, params.title, params.content);\n\n        // í‰ê·  í‰ì  ì—…ë°ì´íŠ¸\n        const updateStmt = this.db.prepare(`\n            UPDATE agent_marketplace SET \n                rating_avg = (SELECT AVG(rating) FROM agent_reviews WHERE marketplace_id = ?),\n                rating_count = (SELECT COUNT(*) FROM agent_reviews WHERE marketplace_id = ?)\n            WHERE id = ?\n        `);\n        updateStmt.run(params.marketplaceId, params.marketplaceId, params.marketplaceId);\n    }\n\n    getAgentReviews(marketplaceId: string, limit: number = 20): AgentReview[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM agent_reviews WHERE marketplace_id = ?\n            ORDER BY created_at DESC LIMIT ?\n        `);\n        return stmt.all(marketplaceId, limit) as AgentReview[];\n    }\n\n    getUserInstalledAgents(userId: string): MarketplaceAgent[] {\n        const stmt = this.db.prepare(`\n            SELECT m.* FROM agent_marketplace m\n            JOIN agent_installations i ON m.id = i.marketplace_id\n            WHERE i.user_id = ? AND i.uninstalled_at IS NULL\n            ORDER BY i.installed_at DESC\n        `);\n        return stmt.all(userId).map((r: any) => ({\n            ...r,\n            tags: r.tags ? JSON.parse(r.tags) : [],\n            is_free: !!r.is_free,\n            is_featured: !!r.is_featured,\n            is_verified: !!r.is_verified\n        })) as MarketplaceAgent[];\n    }\n\n    // ============================================\n    // ğŸ“ Canvas ë¬¸ì„œ ê´€ë¦¬\n    // ============================================\n\n    createCanvasDocument(params: {\n        id: string;\n        userId: string;\n        sessionId?: string;\n        title: string;\n        docType?: CanvasDocType;\n        content?: string;\n        language?: string;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO canvas_documents (id, user_id, session_id, title, doc_type, content, language)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n        `);\n        stmt.run(\n            params.id, params.userId, params.sessionId,\n            params.title, params.docType || 'document',\n            params.content, params.language\n        );\n    }\n\n    updateCanvasDocument(documentId: string, updates: {\n        title?: string;\n        content?: string;\n        changeSummary?: string;\n        updatedBy?: string;\n    }): void {\n        // í˜„ì¬ ë²„ì „ ê°€ì ¸ì˜¤ê¸°\n        const doc = this.getCanvasDocument(documentId);\n        if (!doc) return;\n\n        // ë²„ì „ íˆìŠ¤í† ë¦¬ì— ì €ì¥\n        if (updates.content !== undefined && doc.content !== updates.content) {\n            const versionStmt = this.db.prepare(`\n                INSERT INTO canvas_versions (document_id, version, content, change_summary, created_by)\n                VALUES (?, ?, ?, ?, ?)\n            `);\n            versionStmt.run(documentId, doc.version, doc.content, updates.changeSummary, updates.updatedBy);\n        }\n\n        // ë¬¸ì„œ ì—…ë°ì´íŠ¸\n        const sets: string[] = ['updated_at = CURRENT_TIMESTAMP'];\n        const params: any[] = [];\n\n        if (updates.title !== undefined) {\n            sets.push('title = ?');\n            params.push(updates.title);\n        }\n        if (updates.content !== undefined) {\n            sets.push('content = ?');\n            sets.push('version = version + 1');\n            params.push(updates.content);\n        }\n        params.push(documentId);\n\n        const stmt = this.db.prepare(`UPDATE canvas_documents SET ${sets.join(', ')} WHERE id = ?`);\n        stmt.run(...params);\n    }\n\n    getCanvasDocument(documentId: string): CanvasDocument | undefined {\n        const stmt = this.db.prepare('SELECT * FROM canvas_documents WHERE id = ?');\n        const result = stmt.get(documentId) as any;\n        if (!result) return undefined;\n\n        return {\n            ...result,\n            is_shared: !!result.is_shared\n        };\n    }\n\n    getCanvasDocumentByShareToken(shareToken: string): CanvasDocument | undefined {\n        const stmt = this.db.prepare('SELECT * FROM canvas_documents WHERE share_token = ? AND is_shared = 1');\n        const result = stmt.get(shareToken) as any;\n        if (!result) return undefined;\n\n        return {\n            ...result,\n            is_shared: !!result.is_shared\n        };\n    }\n\n    getUserCanvasDocuments(userId: string, limit: number = 50): CanvasDocument[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM canvas_documents WHERE user_id = ?\n            ORDER BY updated_at DESC LIMIT ?\n        `);\n        return stmt.all(userId, limit).map((r: any) => ({\n            ...r,\n            is_shared: !!r.is_shared\n        })) as CanvasDocument[];\n    }\n\n    getCanvasVersions(documentId: string): CanvasVersion[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM canvas_versions WHERE document_id = ?\n            ORDER BY version DESC\n        `);\n        return stmt.all(documentId) as CanvasVersion[];\n    }\n\n    shareCanvasDocument(documentId: string, shareToken: string): void {\n        const stmt = this.db.prepare(`\n            UPDATE canvas_documents SET is_shared = 1, share_token = ? WHERE id = ?\n        `);\n        stmt.run(shareToken, documentId);\n    }\n\n    unshareCanvasDocument(documentId: string): void {\n        const stmt = this.db.prepare(`\n            UPDATE canvas_documents SET is_shared = 0, share_token = NULL WHERE id = ?\n        `);\n        stmt.run(documentId);\n    }\n\n    recordCanvasAiEdit(params: {\n        documentId: string;\n        instruction: string;\n        originalContent?: string;\n        modifiedContent?: string;\n        accepted?: boolean;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO canvas_ai_edits (document_id, instruction, original_content, modified_content, accepted)\n            VALUES (?, ?, ?, ?, ?)\n        `);\n        stmt.run(\n            params.documentId, params.instruction,\n            params.originalContent, params.modifiedContent,\n            params.accepted ? 1 : 0\n        );\n    }\n\n    // ============================================\n    // ğŸ”— ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ê²° ê´€ë¦¬\n    // ============================================\n\n    /**\n     * #1 ê°œì„ : access_token/refresh_tokenì„ AES-256-GCMìœ¼ë¡œ ì•”í˜¸í™” ì €ì¥\n     */\n    createExternalConnection(params: {\n        id: string;\n        userId: string;\n        serviceType: ExternalServiceType;\n        accessToken?: string;\n        refreshToken?: string;\n        tokenExpiresAt?: string;\n        accountEmail?: string;\n        accountName?: string;\n        metadata?: Record<string, unknown>;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO external_connections \n            (id, user_id, service_type, access_token, refresh_token, token_expires_at, account_email, account_name, metadata)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n            ON CONFLICT(user_id, service_type) DO UPDATE SET\n                access_token = excluded.access_token,\n                refresh_token = excluded.refresh_token,\n                token_expires_at = excluded.token_expires_at,\n                account_email = excluded.account_email,\n                account_name = excluded.account_name,\n                metadata = excluded.metadata,\n                is_active = 1,\n                updated_at = CURRENT_TIMESTAMP\n        `);\n        stmt.run(\n            params.id, params.userId, params.serviceType,\n            // #1: í† í° ì•”í˜¸í™” ì €ì¥\n            params.accessToken ? encrypt(params.accessToken) : null,\n            params.refreshToken ? encrypt(params.refreshToken) : null,\n            params.tokenExpiresAt,\n            params.accountEmail, params.accountName,\n            params.metadata ? JSON.stringify(params.metadata) : null\n        );\n    }\n\n    /**\n     * #1 ê°œì„ : í† í° ë³µí˜¸í™”í•˜ì—¬ ë°˜í™˜\n     */\n    getUserConnections(userId: string): ExternalConnection[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM external_connections WHERE user_id = ? AND is_active = 1\n        `);\n        return stmt.all(userId).map((r: any) => ({\n            ...r,\n            // #1: í† í° ë³µí˜¸í™”\n            access_token: r.access_token ? decrypt(r.access_token) : undefined,\n            refresh_token: r.refresh_token ? decrypt(r.refresh_token) : undefined,\n            metadata: r.metadata ? JSON.parse(r.metadata) : null,\n            is_active: !!r.is_active\n        })) as ExternalConnection[];\n    }\n\n    /**\n     * #1 ê°œì„ : í† í° ë³µí˜¸í™”í•˜ì—¬ ë°˜í™˜\n     */\n    getConnection(userId: string, serviceType: ExternalServiceType): ExternalConnection | undefined {\n        const stmt = this.db.prepare(`\n            SELECT * FROM external_connections WHERE user_id = ? AND service_type = ? AND is_active = 1\n        `);\n        const result = stmt.get(userId, serviceType) as any;\n        if (!result) return undefined;\n\n        return {\n            ...result,\n            // #1: í† í° ë³µí˜¸í™”\n            access_token: result.access_token ? decrypt(result.access_token) : undefined,\n            refresh_token: result.refresh_token ? decrypt(result.refresh_token) : undefined,\n            metadata: result.metadata ? JSON.parse(result.metadata) : null,\n            is_active: !!result.is_active\n        };\n    }\n\n    /**\n     * #1 ê°œì„ : í† í° ì•”í˜¸í™”í•˜ì—¬ ì—…ë°ì´íŠ¸\n     */\n    updateConnectionTokens(connectionId: string, params: {\n        accessToken: string;\n        refreshToken?: string;\n        tokenExpiresAt?: string;\n    }): void {\n        const stmt = this.db.prepare(`\n            UPDATE external_connections SET \n                access_token = ?, refresh_token = ?, token_expires_at = ?, updated_at = CURRENT_TIMESTAMP\n            WHERE id = ?\n        `);\n        stmt.run(\n            encrypt(params.accessToken),\n            params.refreshToken ? encrypt(params.refreshToken) : null,\n            params.tokenExpiresAt,\n            connectionId\n        );\n    }\n\n    disconnectService(userId: string, serviceType: ExternalServiceType): void {\n        const stmt = this.db.prepare(`\n            UPDATE external_connections SET is_active = 0, updated_at = CURRENT_TIMESTAMP\n            WHERE user_id = ? AND service_type = ?\n        `);\n        stmt.run(userId, serviceType);\n    }\n\n    addExternalFile(params: {\n        id: string;\n        connectionId: string;\n        externalId: string;\n        fileName: string;\n        fileType?: string;\n        fileSize?: number;\n        webUrl?: string;\n        cachedContent?: string;\n    }): void {\n        const stmt = this.db.prepare(`\n            INSERT INTO external_files \n            (id, connection_id, external_id, file_name, file_type, file_size, web_url, cached_content, last_synced)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)\n            ON CONFLICT(connection_id, external_id) DO UPDATE SET\n                file_name = excluded.file_name,\n                file_type = excluded.file_type,\n                file_size = excluded.file_size,\n                web_url = excluded.web_url,\n                cached_content = excluded.cached_content,\n                last_synced = CURRENT_TIMESTAMP\n        `);\n        stmt.run(\n            params.id, params.connectionId, params.externalId,\n            params.fileName, params.fileType, params.fileSize,\n            params.webUrl, params.cachedContent\n        );\n    }\n\n    getExternalFiles(connectionId: string): ExternalFile[] {\n        const stmt = this.db.prepare(`\n            SELECT * FROM external_files WHERE connection_id = ?\n            ORDER BY last_synced DESC\n        `);\n        return stmt.all(connectionId) as ExternalFile[];\n    }\n\n    // ===== ìœ í‹¸ë¦¬í‹° =====\n\n    close(): void {\n        this.db.close();\n        console.log('[UnifiedDB] ì—°ê²° ì¢…ë£Œ');\n    }\n}\n\n/** ì‹±ê¸€í†¤ UnifiedDatabase ì¸ìŠ¤í„´ìŠ¤ */\nlet dbInstance: UnifiedDatabase | null = null;\n\n/**\n * UnifiedDatabase ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ íšë“\n * \n * ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì—­ì—ì„œ ë™ì¼í•œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ ê³µìœ í•©ë‹ˆë‹¤.\n * \n * @param dataDir - ë°ì´í„° ë””ë ‰í† ë¦¬ (ì²« í˜¸ì¶œ ì‹œì—ë§Œ ì‚¬ìš©)\n * @returns UnifiedDatabase ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤\n * \n * @example\n * ```typescript\n * const db = getUnifiedDatabase('./data');\n * // ì´í›„ í˜¸ì¶œì—ì„œëŠ” ë™ì¼ ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜\n * const sameDb = getUnifiedDatabase();\n * ```\n */\nexport function getUnifiedDatabase(dataDir?: string): UnifiedDatabase {\n    if (!dbInstance) {\n        dbInstance = new UnifiedDatabase(dataDir);\n    }\n    return dbInstance;\n}\n\n/**\n * ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ\n * \n * ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì‹œ í˜¸ì¶œí•˜ì—¬ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.\n * \n * @example\n * ```typescript\n * process.on('SIGINT', () => {\n *   closeDatabase();\n *   process.exit(0);\n * });\n * ```\n */\nexport function closeDatabase(): void {\n    if (dbInstance) {\n        dbInstance.close();\n        dbInstance = null;\n    }\n}\n"],"version":3}