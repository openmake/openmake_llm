{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/ollama/agent-loop.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/ollama/agent-loop.ts"],"sourcesContent":["/**\n * Ollama Cloud Multi-turn Tool Calling Agent Loop\n * \n * Í≥µÏãù Î¨∏ÏÑú Ï∞∏Í≥†: https://docs.ollama.com/capabilities/tool-calling#multi-turn-tool-calling-agent-loop\n * \n * Ïù¥ Î™®ÎìàÏùÄ OllamaÏùò Tool Calling Í∏∞Îä•ÏùÑ ÌôúÏö©Ìïú Agent LoopÎ•º Íµ¨ÌòÑÌï©ÎãàÎã§.\n * - Multi-turn ÎåÄÌôîÏóêÏÑú ÏûêÎèôÏúºÎ°ú ÎèÑÍµ¨Î•º Ìò∏Ï∂úÌïòÍ≥† Í≤∞Í≥ºÎ•º Îã§Ïãú LLMÏóê Ï†ÑÎã¨\n * - Streaming ÏßÄÏõêÏúºÎ°ú Ïã§ÏãúÍ∞Ñ ÏùëÎãµ Í∞ÄÎä•\n * - Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄÎ•º ÏúÑÌïú maxIterations ÏÑ§Ï†ï\n */\n\nimport { Ollama, Message, Tool, ToolCall, ChatResponse } from 'ollama';\nimport { ChatMessage, ToolDefinition, ThinkOption, UsageMetrics } from './types';\n\n/** Extended Message with optional thinking field (Ollama Native Thinking) */\ninterface MessageWithThinking extends Message { thinking?: string; }\nimport { getApiKeyManager } from './api-key-manager';\nimport { getConfig } from '../config';\n\nconst envConfig = getConfig();\n\n/** Tool execution function type ‚Äî takes parsed arguments, returns result */\ntype ToolFunction = (args: Record<string, unknown>) => unknown | Promise<unknown>;\n\n// Ollama Cloud Ìò∏Ïä§Ìä∏\nconst OLLAMA_CLOUD_HOST = 'https://ollama.com';\n\n/**\n * Agent Loop Ïã§Ìñâ ÏòµÏÖò\n */\nexport interface AgentLoopOptions {\n    /** ÏÇ¨Ïö©Ìï† Î™®Îç∏ Ïù¥Î¶Ñ */\n    model?: string;\n    /** Ï¥àÍ∏∞ Î©îÏãúÏßÄ Î™©Î°ù */\n    messages: ChatMessage[];\n    /** ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÎèÑÍµ¨ Ï†ïÏùò */\n    tools: ToolDefinition[];\n    /** ÎèÑÍµ¨ Ïù¥Î¶Ñ -> Ïã§Ìñâ Ìï®Ïàò Îß§Ìïë */\n    availableFunctions: Record<string, ToolFunction>;\n    /** Thinking Î™®Îìú ÌôúÏÑ±Ìôî */\n    think?: ThinkOption;\n    /** Ïä§Ìä∏Î¶¨Î∞ç Î™®Îìú */\n    stream?: boolean;\n    /** ÌÜ†ÌÅ∞ ÏΩúÎ∞± (Ïä§Ìä∏Î¶¨Î∞ç Ïãú) */\n    onToken?: (token: string, thinking?: string) => void;\n    /** ÎèÑÍµ¨ Ìò∏Ï∂ú ÏΩúÎ∞± */\n    onToolCall?: (name: string, args: unknown, result: unknown) => void;\n    /** ÏµúÎåÄ Î∞òÎ≥µ ÌöüÏàò (Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ) */\n    maxIterations?: number;\n}\n\n/**\n * Agent Loop Í≤∞Í≥º\n */\nexport interface AgentLoopResult {\n    /** ÏµúÏ¢Ö ÏùëÎãµ Î©îÏãúÏßÄ */\n    message: ChatMessage;\n    /** Ï†ÑÏ≤¥ ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ */\n    history: ChatMessage[];\n    /** Ìò∏Ï∂úÎêú ÎèÑÍµ¨ Î™©Î°ù */\n    toolCallsExecuted: Array<{\n        name: string;\n        arguments: unknown;\n        result: unknown;\n    }>;\n    /** ÏÇ¨Ïö©Îüâ Î©îÌä∏Î¶≠ */\n    metrics?: UsageMetrics;\n    /** Î∞òÎ≥µ ÌöüÏàò */\n    iterations: number;\n}\n\n/**\n * ChatMessageÎ•º Ollama Message ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò\n */\nfunction toOllamaMessage(msg: ChatMessage): Message {\n    const ollamaMsg: Message = {\n        role: msg.role as 'system' | 'user' | 'assistant' | 'tool',\n        content: msg.content\n    };\n\n    if (msg.images) {\n        ollamaMsg.images = msg.images as string[];\n    }\n\n    if (msg.tool_calls) {\n        ollamaMsg.tool_calls = msg.tool_calls.map(tc => ({\n            function: {\n                name: tc.function.name,\n                arguments: tc.function.arguments\n            }\n        }));\n    }\n\n    return ollamaMsg;\n}\n\n/**\n * Ollama MessageÎ•º ChatMessage ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò\n */\nfunction fromOllamaMessage(msg: Message): ChatMessage {\n    const chatMsg: ChatMessage = {\n        role: msg.role as 'system' | 'user' | 'assistant' | 'tool',\n        content: msg.content\n    };\n\n    if (msg.images) {\n        chatMsg.images = msg.images as string[];\n    }\n\n    if (msg.tool_calls && msg.tool_calls.length > 0) {\n        chatMsg.tool_calls = msg.tool_calls.map((tc, index) => ({\n            type: 'function' as const,\n            function: {\n                index,\n                name: tc.function.name,\n                arguments: tc.function.arguments as Record<string, unknown>\n            }\n        }));\n    }\n\n    return chatMsg;\n}\n\n/**\n * ToolDefinitionÏùÑ Ollama Tool ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò\n */\nfunction toOllamaTool(tool: ToolDefinition): Tool {\n    return {\n        type: 'function',\n        function: {\n            name: tool.function.name,\n            description: tool.function.description,\n            parameters: tool.function.parameters\n        }\n    };\n}\n\n/**\n * Ollama ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ± (Cloud ÏßÄÏõê)\n */\nfunction createOllamaClient(model: string): Ollama {\n    const apiKeyManager = getApiKeyManager();\n    const isCloud = model?.toLowerCase().endsWith(':cloud');\n\n    const host = isCloud ? OLLAMA_CLOUD_HOST : envConfig.ollamaBaseUrl;\n\n    const ollama = new Ollama({\n        host,\n        headers: apiKeyManager.getAuthHeaders()\n    });\n\n    console.log(`[AgentLoop] üåê Ollama ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ± - Ìò∏Ïä§Ìä∏: ${host}, Î™®Îç∏: ${model}`);\n\n    return ollama;\n}\n\n/**\n * Multi-turn Tool Calling Agent Loop Ïã§Ìñâ\n * \n * ÎèÑÍµ¨ Ìò∏Ï∂úÏù¥ ÏóÜÏùÑ ÎïåÍπåÏßÄ ÏûêÎèôÏúºÎ°ú ÎåÄÌôîÎ•º Ïù¥Ïñ¥Í∞ëÎãàÎã§.\n * \n * @example\n * ```typescript\n * const result = await runAgentLoop({\n *   model: 'gemini-3-flash-preview:cloud',\n *   messages: [{ role: 'user', content: 'ÏÑúÏö∏ ÎÇ†Ïî® ÏïåÎ†§Ï§ò' }],\n *   tools: [weatherTool],\n *   availableFunctions: { get_weather: getWeather },\n *   onToolCall: (name, args, result) => console.log(`Tool ${name}: ${result}`)\n * });\n * ```\n */\nexport async function runAgentLoop(options: AgentLoopOptions): Promise<AgentLoopResult> {\n    const {\n        model = envConfig.ollamaDefaultModel,\n        messages: initialMessages,\n        tools,\n        availableFunctions,\n        think = true,\n        stream = false,\n        onToken,\n        onToolCall,\n        maxIterations = 10\n    } = options;\n\n    const ollama = createOllamaClient(model);\n    const ollamaTools = tools.map(toOllamaTool);\n\n    // Î©îÏãúÏßÄ ÌûàÏä§ÌÜ†Î¶¨ Î≥µÏÇ¨\n    const messages: Message[] = initialMessages.map(toOllamaMessage);\n    const toolCallsExecuted: AgentLoopResult['toolCallsExecuted'] = [];\n    let iterations = 0;\n    let lastMetrics: UsageMetrics | undefined;\n\n    console.log(`[AgentLoop] üöÄ Agent Loop ÏãúÏûë - Î™®Îç∏: ${model}, ÎèÑÍµ¨: ${tools.length}Í∞ú`);\n\n    while (iterations < maxIterations) {\n        iterations++;\n        console.log(`[AgentLoop] üìç Î∞òÎ≥µ ${iterations}/${maxIterations}`);\n\n        let response: ChatResponse;\n\n        if (stream && onToken) {\n            // Ïä§Ìä∏Î¶¨Î∞ç Î™®Îìú\n            let content = '';\n            let thinking = '';\n            let toolCalls: ToolCall[] = [];\n\n            const streamResponse = await ollama.chat({\n                model,\n                messages,\n                tools: ollamaTools,\n                stream: true,\n                options: {\n                    // think ÏòµÏÖòÏùÄ model optionsÍ∞Ä ÏïÑÎãå Î≥ÑÎèÑÎ°ú Ï≤òÎ¶¨\n                }\n            });\n\n            for await (const chunk of streamResponse) {\n                // Thinking Ï≤òÎ¶¨\n                if ((chunk.message as MessageWithThinking)?.thinking) {\n                    thinking += (chunk.message as MessageWithThinking).thinking;\n                    onToken('', (chunk.message as MessageWithThinking).thinking!);\n                }\n\n                // Content Ï≤òÎ¶¨\n                if (chunk.message?.content) {\n                    content += chunk.message.content;\n                    onToken(chunk.message.content);\n                }\n\n                // Tool calls ÏàòÏßë\n                if (chunk.message?.tool_calls) {\n                    toolCalls = chunk.message.tool_calls;\n                }\n\n                // Î©îÌä∏Î¶≠ ÏàòÏßë\n                if (chunk.done) {\n                    lastMetrics = {\n                        total_duration: chunk.total_duration,\n                        load_duration: chunk.load_duration,\n                        prompt_eval_count: chunk.prompt_eval_count,\n                        prompt_eval_duration: chunk.prompt_eval_duration,\n                        eval_count: chunk.eval_count,\n                        eval_duration: chunk.eval_duration\n                    };\n                }\n            }\n\n            // Ïä§Ìä∏Î¶¨Î∞ç ÏôÑÎ£å ÌõÑ ÏùëÎãµ Íµ¨ÏÑ±\n            response = {\n                model,\n                created_at: new Date(),\n                message: {\n                    role: 'assistant',\n                    content,\n                    tool_calls: toolCalls.length > 0 ? toolCalls : undefined\n                },\n                done: true,\n                done_reason: toolCalls.length > 0 ? 'tool_calls' : 'stop',\n                total_duration: lastMetrics?.total_duration,\n                load_duration: lastMetrics?.load_duration,\n                prompt_eval_count: lastMetrics?.prompt_eval_count,\n                prompt_eval_duration: lastMetrics?.prompt_eval_duration,\n                eval_count: lastMetrics?.eval_count,\n                eval_duration: lastMetrics?.eval_duration\n            } as ChatResponse;\n\n            if (thinking) {\n                (response.message as MessageWithThinking).thinking = thinking;\n            }\n\n        } else {\n            // ÎπÑÏä§Ìä∏Î¶¨Î∞ç Î™®Îìú\n            response = await ollama.chat({\n                model,\n                messages,\n                tools: ollamaTools,\n                stream: false\n            });\n\n            lastMetrics = {\n                total_duration: response.total_duration,\n                load_duration: response.load_duration,\n                prompt_eval_count: response.prompt_eval_count,\n                prompt_eval_duration: response.prompt_eval_duration,\n                eval_count: response.eval_count,\n                eval_duration: response.eval_duration\n            };\n        }\n\n        // ÏùëÎãµ Î©îÏãúÏßÄÎ•º ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï∂îÍ∞Ä\n        messages.push(response.message);\n\n        // Thinking Î°úÍ∑∏\n        if ((response.message as MessageWithThinking)?.thinking) {\n            console.log(`[AgentLoop] üß† Thinking: ${(response.message as MessageWithThinking).thinking!.substring(0, 100)}...`);\n        }\n\n        // Content Î°úÍ∑∏\n        if (response.message.content) {\n            console.log(`[AgentLoop] üí¨ Content: ${response.message.content.substring(0, 100)}...`);\n        }\n\n        // Tool calls ÌôïÏù∏\n        const responsToolCalls = response.message.tool_calls ?? [];\n\n        if (responsToolCalls.length === 0) {\n            // ÎèÑÍµ¨ Ìò∏Ï∂ú ÏóÜÏùå - Î£®ÌîÑ Ï¢ÖÎ£å\n            console.log(`[AgentLoop] ‚úÖ ÎèÑÍµ¨ Ìò∏Ï∂ú ÏóÜÏùå - Î£®ÌîÑ Ï¢ÖÎ£å`);\n            break;\n        }\n\n        // ÎèÑÍµ¨ Ìò∏Ï∂ú Ï≤òÎ¶¨\n        for (const toolCall of responsToolCalls) {\n            const funcName = toolCall.function.name;\n            const funcArgs = toolCall.function.arguments;\n\n            console.log(`[AgentLoop] üîß ÎèÑÍµ¨ Ìò∏Ï∂ú: ${funcName}(${JSON.stringify(funcArgs)})`);\n\n            if (!(funcName in availableFunctions)) {\n                console.warn(`[AgentLoop] ‚ö†Ô∏è Ïïå Ïàò ÏóÜÎäî ÎèÑÍµ¨: ${funcName}`);\n                continue;\n            }\n\n            try {\n                // ÎèÑÍµ¨ Ïã§Ìñâ\n                const result = await availableFunctions[funcName](funcArgs);\n                const resultStr = typeof result === 'string' ? result : JSON.stringify(result);\n\n                console.log(`[AgentLoop] üì§ ÎèÑÍµ¨ Í≤∞Í≥º: ${resultStr.substring(0, 100)}...`);\n\n                // ÏΩúÎ∞± Ìò∏Ï∂ú\n                if (onToolCall) {\n                    onToolCall(funcName, funcArgs, result);\n                }\n\n                // Ïã§Ìñâ Í∏∞Î°ù Ï†ÄÏû•\n                toolCallsExecuted.push({\n                    name: funcName,\n                    arguments: funcArgs,\n                    result\n                });\n\n                // ÎèÑÍµ¨ Í≤∞Í≥ºÎ•º Î©îÏãúÏßÄÏóê Ï∂îÍ∞Ä\n                messages.push({\n                    role: 'tool',\n                    content: resultStr\n                });\n\n            } catch (error: unknown) {\n                console.error(`[AgentLoop] ‚ùå ÎèÑÍµ¨ Ïã§Ìñâ Ïò§Î•ò: ${(error instanceof Error ? error.message : String(error))}`);\n                messages.push({\n                    role: 'tool',\n                    content: `Error: ${(error instanceof Error ? error.message : String(error))}`\n                });\n            }\n        }\n    }\n\n    if (iterations >= maxIterations) {\n        console.warn(`[AgentLoop] ‚ö†Ô∏è ÏµúÎåÄ Î∞òÎ≥µ ÌöüÏàò(${maxIterations}) ÎèÑÎã¨`);\n    }\n\n    // ÏµúÏ¢Ö Í≤∞Í≥º Íµ¨ÏÑ±\n    const lastMessage = messages[messages.length - 1];\n    const history = messages.map(fromOllamaMessage);\n\n    console.log(`[AgentLoop] üèÅ Agent Loop ÏôÑÎ£å - Î∞òÎ≥µ: ${iterations}, ÎèÑÍµ¨ Ìò∏Ï∂ú: ${toolCallsExecuted.length}Í∞ú`);\n\n    return {\n        message: fromOllamaMessage(lastMessage),\n        history,\n        toolCallsExecuted,\n        metrics: lastMetrics,\n        iterations\n    };\n}\n\n/**\n * Îã®Ïùº ÎèÑÍµ¨ Ìò∏Ï∂ú Ïã§Ìñâ (Agent Loop ÏÇ¨Ïö©)\n * \n * Îã®ÏàúÌïú Îã®Ïùº ÎèÑÍµ¨ Ìò∏Ï∂ú ÏãúÎÇòÎ¶¨Ïò§Ïóê ÏÇ¨Ïö©Îê©ÎãàÎã§.\n */\nexport async function executeSingleToolCall(\n    model: string,\n    prompt: string,\n    tools: ToolDefinition[],\n    availableFunctions: Record<string, ToolFunction>,\n    options?: {\n        think?: ThinkOption;\n        onToken?: (token: string, thinking?: string) => void;\n    }\n): Promise<AgentLoopResult> {\n    return runAgentLoop({\n        model,\n        messages: [{ role: 'user', content: prompt }],\n        tools,\n        availableFunctions,\n        think: options?.think,\n        stream: !!options?.onToken,\n        onToken: options?.onToken,\n        maxIterations: 3  // Îã®Ïùº Ìò∏Ï∂úÏù¥ÎØÄÎ°ú Ï†ÅÏùÄ Î∞òÎ≥µ\n    });\n}\n\n/**\n * MCP ToolÏùÑ Ollama ToolÎ°ú Î≥ÄÌôòÌïòÎäî Ïñ¥ÎåëÌÑ∞\n */\nexport function mcpToolToOllamaTool(mcpTool: {\n    tool: {\n        name: string;\n        description: string;\n        inputSchema: Record<string, unknown>;\n    };\n}): ToolDefinition {\n    return {\n        type: 'function',\n        function: {\n            name: mcpTool.tool.name,\n            description: mcpTool.tool.description,\n            parameters: mcpTool.tool.inputSchema as ToolDefinition['function']['parameters']\n        }\n    };\n}\n\n/**\n * Ïó¨Îü¨ MCP ToolsÎ•º Ollama ToolsÎ°ú Î≥ÄÌôò\n */\nexport function mcpToolsToOllamaTools(mcpTools: Array<{\n    tool: {\n        name: string;\n        description: string;\n        inputSchema: Record<string, unknown>;\n    };\n}>): ToolDefinition[] {\n    return mcpTools.map(mcpToolToOllamaTool);\n}\n"],"version":3}