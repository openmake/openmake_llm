{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/cluster/config.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/cluster/config.ts"],"sourcesContent":["import * as fs from 'fs';\r\nimport * as path from 'path';\r\nimport { ClusterConfig, StaticNode } from './types';\r\n\r\nconst DEFAULT_CONFIG: ClusterConfig = {\r\n    name: 'ollama-cluster',\r\n    discoveryPort: 52415,\r\n    dashboardPort: 52416,\r\n    heartbeatInterval: 5000,\r\n    nodeTimeout: 15000,\r\n    nodes: []\r\n};\r\n\r\nconst CONFIG_FILENAME = '.ollama-cluster.json';\r\n\r\nexport function loadClusterConfig(): ClusterConfig {\r\n    // 설정 파일 찾기: 현재 디렉토리 -> 홈 디렉토리\r\n    const configPaths = [\r\n        path.resolve(process.cwd(), CONFIG_FILENAME),\r\n        path.resolve(__dirname, '../../', CONFIG_FILENAME),\r\n        path.resolve(process.env.HOME || process.env.USERPROFILE || '', CONFIG_FILENAME)\r\n    ];\r\n\r\n    for (const configPath of configPaths) {\r\n        if (fs.existsSync(configPath)) {\r\n            try {\r\n                const content = fs.readFileSync(configPath, 'utf-8');\r\n                const fileConfig = JSON.parse(content) as Partial<ClusterConfig>;\r\n                return { ...DEFAULT_CONFIG, ...fileConfig };\r\n            } catch (e) {\r\n                console.warn(`설정 파일 파싱 실패: ${configPath}`);\r\n            }\r\n        }\r\n    }\r\n\r\n    // 환경변수에서 정적 노드 추가\r\n    const envNodes = process.env.OLLAMA_CLUSTER_NODES;\r\n    if (envNodes) {\r\n        const nodes = parseNodesFromEnv(envNodes);\r\n        return { ...DEFAULT_CONFIG, nodes };\r\n    }\r\n\r\n    // .env 파일에서 OLLAMA_BASE_URL 사용\r\n    const baseUrl = process.env.OLLAMA_BASE_URL;\r\n    if (baseUrl) {\r\n        try {\r\n            const url = new URL(baseUrl);\r\n            const node: StaticNode = {\r\n                host: url.hostname,\r\n                port: parseInt(url.port) || 11434,\r\n                name: 'primary'\r\n            };\r\n            return { ...DEFAULT_CONFIG, nodes: [node] };\r\n        } catch (e) {\r\n            // URL 파싱 실패\r\n        }\r\n    }\r\n\r\n    return DEFAULT_CONFIG;\r\n}\r\n\r\nfunction parseNodesFromEnv(envNodes: string): StaticNode[] {\r\n    // 형식: \"host1:port1,host2:port2,...\"\r\n    return envNodes.split(',').map(nodeStr => {\r\n        const [host, portStr] = nodeStr.trim().split(':');\r\n        return {\r\n            host,\r\n            port: parseInt(portStr) || 11434\r\n        };\r\n    }).filter(n => n.host);\r\n}\r\n\r\nexport function saveClusterConfig(config: ClusterConfig, filePath?: string): void {\r\n    const targetPath = filePath || path.resolve(process.cwd(), CONFIG_FILENAME);\r\n    fs.writeFileSync(targetPath, JSON.stringify(config, null, 2), 'utf-8');\r\n}\r\n\r\nexport function createDefaultConfigFile(): string {\r\n    const configPath = path.resolve(process.cwd(), CONFIG_FILENAME);\r\n\r\n    // 기본 노드 설정: 환경변수 또는 빈 배열 사용\r\n    const defaultHost = process.env.OLLAMA_DEFAULT_HOST || 'localhost';\r\n    const defaultPort = parseInt(process.env.OLLAMA_DEFAULT_PORT || '11434');\r\n    const defaultNodeName = process.env.OLLAMA_DEFAULT_NODE_NAME || 'primary';\r\n\r\n    const defaultWithExample: ClusterConfig = {\r\n        ...DEFAULT_CONFIG,\r\n        nodes: defaultHost !== 'localhost' ? [\r\n            { host: defaultHost, port: defaultPort, name: defaultNodeName }\r\n        ] : [] // 환경변수 미설정 시 빈 배열 (사용자가 직접 설정)\r\n    };\r\n\r\n    saveClusterConfig(defaultWithExample, configPath);\r\n    return configPath;\r\n}\r\n"],"version":3}