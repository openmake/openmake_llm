{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/mcp/server-registry.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/mcp/server-registry.ts"],"sourcesContent":["/**\n * MCPServerRegistry — 서버 연결 관리자\n * DB에서 서버 설정을 로드하고, ExternalMCPClient 인스턴스를 관리하며,\n * ToolRouter에 도구를 등록/해제합니다.\n */\n\nimport { ExternalMCPClient } from './external-client';\nimport { ToolRouter } from './tool-router';\nimport type { MCPServerConfig, MCPConnectionStatus } from './types';\nimport type { UnifiedDatabase, MCPServerRow } from '../data/models/unified-database';\n\n/** MCPServerRow → MCPServerConfig 변환 */\nfunction rowToConfig(row: MCPServerRow): MCPServerConfig {\n    return {\n        id: row.id,\n        name: row.name,\n        transport_type: row.transport_type as MCPServerConfig['transport_type'],\n        command: row.command || undefined,\n        args: row.args || undefined,\n        env: row.env || undefined,\n        url: row.url || undefined,\n        enabled: row.enabled,\n        created_at: row.created_at,\n        updated_at: row.updated_at,\n    };\n}\n\nexport class MCPServerRegistry {\n    /** 활성 연결: serverId → ExternalMCPClient */\n    private connections: Map<string, ExternalMCPClient> = new Map();\n    private toolRouter: ToolRouter;\n\n    constructor(toolRouter: ToolRouter) {\n        this.toolRouter = toolRouter;\n    }\n\n    /**\n     * DB에서 enabled 서버를 로드하고 연결 시도\n     * 앱 초기화 시 한 번 호출\n     */\n    async initializeFromDB(db: UnifiedDatabase): Promise<void> {\n        try {\n            const servers = await db.getMcpServers();\n            const enabledServers = servers.filter(s => s.enabled);\n\n            console.log(`[MCPRegistry] Found ${enabledServers.length} enabled MCP servers in DB`);\n\n            for (const server of enabledServers) {\n                const config = rowToConfig(server);\n                try {\n                    await this.connectServer(config.id, config);\n                } catch (error) {\n                    const msg = error instanceof Error ? error.message : String(error);\n                    console.error(`[MCPRegistry] Failed to connect \"${config.name}\" during init:`, msg);\n                    // 초기화 실패는 전체를 중단하지 않음\n                }\n            }\n        } catch (error) {\n            console.error('[MCPRegistry] Failed to initialize from DB:', error);\n        }\n    }\n\n    /**\n     * 새 서버 등록 (DB 저장 + 연결)\n     */\n    async registerServer(config: MCPServerConfig, db: UnifiedDatabase): Promise<MCPConnectionStatus> {\n        // DB에 저장\n        await db.createMcpServer({\n            id: config.id,\n            name: config.name,\n            transport_type: config.transport_type,\n            command: config.command || null,\n            args: config.args || null,\n            env: config.env || null,\n            url: config.url || null,\n            enabled: config.enabled,\n        });\n\n        // 활성화 시 연결\n        if (config.enabled) {\n            try {\n                await this.connectServer(config.id, config);\n            } catch {\n                // 연결 실패해도 등록은 유지\n            }\n        }\n\n        return this.getServerStatus(config.id) || {\n            serverId: config.id,\n            serverName: config.name,\n            status: 'disconnected',\n            toolCount: 0,\n        };\n    }\n\n    /**\n     * 서버 등록 해제 (DB 삭제 + 연결 해제)\n     */\n    async unregisterServer(serverId: string, db: UnifiedDatabase): Promise<void> {\n        await this.disconnectServer(serverId);\n        await db.deleteMcpServer(serverId);\n    }\n\n    /**\n     * 서버에 연결하고 도구를 ToolRouter에 등록\n     */\n    async connectServer(serverId: string, config: MCPServerConfig): Promise<void> {\n        // 기존 연결이 있으면 먼저 해제\n        if (this.connections.has(serverId)) {\n            await this.disconnectServer(serverId);\n        }\n\n        const client = new ExternalMCPClient(config);\n        this.connections.set(serverId, client);\n\n        await client.connect();\n\n        // 연결 성공 시 도구를 ToolRouter에 등록\n        const tools = client.getTools();\n        this.toolRouter.registerExternalTools(\n            serverId,\n            config.name,\n            tools,\n            (name, args) => client.callTool(name, args)\n        );\n    }\n\n    /**\n     * 서버 연결 해제 및 도구 해제\n     */\n    async disconnectServer(serverId: string): Promise<void> {\n        const client = this.connections.get(serverId);\n        if (client) {\n            this.toolRouter.unregisterExternalTools(serverId);\n            await client.disconnect();\n            this.connections.delete(serverId);\n        }\n    }\n\n    /**\n     * 모든 서버 연결 해제 (graceful shutdown)\n     */\n    async disconnectAll(): Promise<void> {\n        const serverIds = [...this.connections.keys()];\n        console.log(`[MCPRegistry] Disconnecting all ${serverIds.length} external servers...`);\n\n        const results = await Promise.allSettled(\n            serverIds.map(id => this.disconnectServer(id))\n        );\n\n        const failures = results.filter(r => r.status === 'rejected');\n        if (failures.length > 0) {\n            console.warn(`[MCPRegistry] ${failures.length} server(s) failed to disconnect cleanly`);\n        }\n\n        console.log('[MCPRegistry] All external servers disconnected');\n    }\n\n    /**\n     * 모든 서버 연결 상태 반환\n     */\n    getAllStatuses(): MCPConnectionStatus[] {\n        const statuses: MCPConnectionStatus[] = [];\n        for (const client of this.connections.values()) {\n            statuses.push(client.getStatus());\n        }\n        return statuses;\n    }\n\n    /**\n     * 특정 서버 연결 상태 반환\n     */\n    getServerStatus(serverId: string): MCPConnectionStatus | undefined {\n        const client = this.connections.get(serverId);\n        return client?.getStatus();\n    }\n\n    /**\n     * 서버 ping\n     */\n    async pingServer(serverId: string): Promise<boolean> {\n        const client = this.connections.get(serverId);\n        if (!client) return false;\n        return client.ping();\n    }\n\n    /**\n     * 활성 연결 수\n     */\n    getConnectionCount(): number {\n        return this.connections.size;\n    }\n\n    /**\n     * 특정 서버의 ExternalMCPClient 반환 (테스트 등에서 사용)\n     */\n    getClient(serverId: string): ExternalMCPClient | undefined {\n        return this.connections.get(serverId);\n    }\n}\n"],"version":3}