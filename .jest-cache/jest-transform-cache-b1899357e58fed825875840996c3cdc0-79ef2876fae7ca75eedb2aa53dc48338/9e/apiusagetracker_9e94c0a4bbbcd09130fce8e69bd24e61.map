{"file":"/Volumes/MAC_APP/openmake_llm/backend/api/src/ollama/api-usage-tracker.ts","mappings":"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","names":[],"sources":["/Volumes/MAC_APP/openmake_llm/backend/api/src/ollama/api-usage-tracker.ts"],"sourcesContent":["/**\n * API Usage Tracker\n * üÜï ÏùºÍ∞Ñ/Ï£ºÍ∞Ñ API ÏÇ¨Ïö©Îüâ Ï∂îÏ†Å Î∞è ÌÜµÍ≥Ñ\n */\n\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { getApiKeyManager } from './api-key-manager';\nimport { getConfig } from '../config/env';\n\ninterface UsageRecord {\n    date: string;        // YYYY-MM-DD\n    requests: number;\n    tokens: number;\n    errors: number;\n    avgResponseTime: number;\n    models: Record<string, number>;  // Î™®Îç∏Î≥Ñ ÏÇ¨Ïö©Îüâ\n}\n\ninterface HourlyRecord {\n    hour: number;        // 0-23\n    requests: number;\n    tokens: number;\n}\n\ninterface DailyStats {\n    date: string;\n    totalRequests: number;\n    totalTokens: number;\n    totalErrors: number;\n    avgResponseTime: number;\n    hourlyBreakdown: HourlyRecord[];\n    modelUsage: Record<string, number>;\n}\n\ninterface WeeklyStats {\n    weekStart: string;\n    weekEnd: string;\n    totalRequests: number;\n    totalTokens: number;\n    totalErrors: number;\n    avgResponseTime: number;\n    dailyBreakdown: UsageRecord[];\n}\n\ninterface UsageData {\n    daily: Record<string, UsageRecord>;\n    lastUpdated: string;\n    // üÜï ÌÇ§Î≥Ñ ÏÇ¨Ïö©Îüâ Ï∂îÏ†Å\n    perKey?: Record<string, KeyUsageStats>;\n}\n\n// üÜï Í∞úÎ≥Ñ API ÌÇ§ ÏÇ¨Ïö©Îüâ ÌÜµÍ≥Ñ\ninterface KeyUsageStats {\n    keyId: string;       // ÌÇ§ ÏãùÎ≥ÑÏûê (Ïïû 8Ïûê)\n    totalRequests: number;\n    weeklyRequests: number;\n    hourlyRequests: number;\n    lastReset: string;   // ISO ÎÇ†Ïßú\n    lastHourReset: number; // ÏãúÍ∞Ñ (0-23)\n}\n\n// üÜï API ÏÇ¨Ïö©Îüâ ÌïúÍ≥Ñ ÏÑ§Ï†ï\ninterface QuotaLimits {\n    hourlyLimit: number;\n    weeklyLimit: number;\n    monthlyPremiumLimit: number;\n}\n\ninterface QuotaUsage {\n    used: number;\n    limit: number;\n    percentage: number;\n    remaining: number;\n}\n\n// üÜï Í∞úÎ≥Ñ ÌÇ§ Ìï†ÎãπÎüâ ÏÉÅÌÉú\ninterface KeyQuotaStatus {\n    keyId: string;\n    isActive: boolean;\n    hourly: QuotaUsage;\n    weekly: QuotaUsage;\n    isExhausted: boolean;\n}\n\ninterface QuotaStatus {\n    hourly: QuotaUsage;\n    weekly: QuotaUsage;\n    daily: QuotaUsage;\n    isOverLimit: boolean;\n    warningLevel: 'safe' | 'warning' | 'critical';\n    // üÜï Í∞úÎ≥Ñ ÌÇ§ ÏÉÅÌÉú\n    keys?: {\n        primary: KeyQuotaStatus;\n        secondary: KeyQuotaStatus;\n    };\n    activeKey?: string;\n}\n\n/**\n * üÜï ÌôòÍ≤ΩÎ≥ÄÏàòÏóêÏÑú Ìï†ÎãπÎüâ ÌïúÍ≥Ñ Î°úÎìú\n */\nfunction getQuotaLimits(): QuotaLimits {\n    const config = getConfig();\n    return {\n        hourlyLimit: config.ollamaHourlyLimit,\n        weeklyLimit: config.ollamaWeeklyLimit,\n        monthlyPremiumLimit: config.ollamaMonthlyPremiumLimit\n    };\n}\n\n/**\n * üÜï API ÌÇ§ ID ÏÉùÏÑ± (Ïïû 8Ïûê)\n */\nfunction getKeyId(key: string): string {\n    return key ? key.substring(0, 8) : 'unknown';\n}\n\nclass ApiUsageTracker {\n    private dataPath: string;\n    private data: UsageData;\n    private todayHourly: HourlyRecord[] = [];\n    private saveDebounceTimer: NodeJS.Timeout | null = null;\n\n    constructor(dataDir: string = './data') {\n        this.dataPath = path.join(dataDir, 'api-usage.json');\n        this.data = this.loadData();\n        this.initHourlyRecords();\n        console.log('[ApiUsageTracker] Ï¥àÍ∏∞ÌôîÎê®');\n    }\n\n    private loadData(): UsageData {\n        try {\n            if (fs.existsSync(this.dataPath)) {\n                const content = fs.readFileSync(this.dataPath, 'utf-8');\n                return JSON.parse(content);\n            }\n        } catch (error) {\n            console.error('[ApiUsageTracker] Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);\n        }\n        return { daily: {}, lastUpdated: new Date().toISOString() };\n    }\n\n    private saveData(): void {\n        // ÎîîÎ∞îÏö¥Ïä§Î°ú ÎÑàÎ¨¥ ÎπàÎ≤àÌïú Ï†ÄÏû• Î∞©ÏßÄ\n        if (this.saveDebounceTimer) {\n            clearTimeout(this.saveDebounceTimer);\n        }\n        this.saveDebounceTimer = setTimeout(() => {\n            try {\n                const dir = path.dirname(this.dataPath);\n                if (!fs.existsSync(dir)) {\n                    fs.mkdirSync(dir, { recursive: true });\n                }\n                this.data.lastUpdated = new Date().toISOString();\n                fs.writeFileSync(this.dataPath, JSON.stringify(this.data, null, 2));\n            } catch (error) {\n                console.error('[ApiUsageTracker] Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', error);\n            }\n        }, 1000);\n    }\n\n    private initHourlyRecords(): void {\n        this.todayHourly = Array.from({ length: 24 }, (_, hour) => ({\n            hour,\n            requests: 0,\n            tokens: 0\n        }));\n    }\n\n    private getToday(): string {\n        return new Date().toISOString().split('T')[0];\n    }\n\n    private ensureTodayRecord(): UsageRecord {\n        const today = this.getToday();\n        if (!this.data.daily[today]) {\n            this.data.daily[today] = {\n                date: today,\n                requests: 0,\n                tokens: 0,\n                errors: 0,\n                avgResponseTime: 0,\n                models: {}\n            };\n        }\n        return this.data.daily[today];\n    }\n\n    /**\n     * API ÏöîÏ≤≠ Í∏∞Î°ù\n     */\n    recordRequest(params: {\n        tokens?: number;\n        responseTime?: number;\n        model?: string;\n        error?: boolean;\n        apiKeyId?: string;  // üÜï API ÌÇ§ ÏãùÎ≥ÑÏûê\n        promptTokens?: number;\n        completionTokens?: number;\n        totalDuration?: number;\n        loadDuration?: number;\n        evalDuration?: number;\n        promptEvalDuration?: number;\n    }): void {\n        const record = this.ensureTodayRecord();\n        const hour = new Date().getHours();\n\n        record.requests++;\n        record.tokens += params.tokens || 0;\n\n        // üÜï ÏÉÅÏÑ∏ Î©îÌä∏Î¶≠ Ï†ÄÏû• (UsageRecordÏóê ÌïÑÎìú Ï∂îÍ∞Ä ÌïÑÏöî - Ïó¨Í∏∞ÏÑúÎäî Í∏∞Ï°¥ Íµ¨Ï°∞ ÌôúÏö© ÎòêÎäî ÌôïÏû•)\n        // Í∏∞Ï°¥ Íµ¨Ï°∞ Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï¥ total tokensÎäî Ïú†ÏßÄÌïòÎêò, ÎÇ¥Î∂ÄÏ†ÅÏúºÎ°ú ÏÉÅÏÑ∏ ÌïÑÎìúÎ•º Ï†ÄÏû•Ìï† Í≥µÍ∞ÑÏù¥ ÏûàÎã§Î©¥ Ï†ÄÏû•.\n        // ÌòÑÏû¨ UsageRecord Ïù∏ÌÑ∞ÌéòÏù¥Ïä§Îäî Í∞ÑÎã®ÌïòÎØÄÎ°ú, ÌôïÏû•ÌïòÍ±∞ÎÇò Î°úÍπÖÎßå ÏàòÌñâ.\n        // *Ïã§Ï†ú* Íµ¨ÌòÑÏóêÏÑúÎäî UsageRecord Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ ÌôïÏû•Ïù¥ ÌïÑÏöîÌï®.\n        if (params.promptTokens || params.completionTokens) {\n            // ÌôïÏû•Îêú Î°úÏßÅ: (ÏûÑÏãú) console log for verification\n            // Ï∂îÌõÑ UsageRecord Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ ÌôïÏû•ÏùÑ ÌÜµÌï¥ Ï†ÄÏû•\n        }\n\n        if (params.error) {\n            record.errors++;\n        }\n\n        // ÌèâÍ∑† ÏùëÎãµÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏\n        if (params.responseTime && !params.error) {\n            const prevTotal = record.avgResponseTime * (record.requests - 1);\n            record.avgResponseTime = Math.round((prevTotal + params.responseTime) / record.requests);\n        }\n\n        // Î™®Îç∏Î≥Ñ ÏÇ¨Ïö©Îüâ\n        if (params.model) {\n            record.models[params.model] = (record.models[params.model] || 0) + 1;\n        }\n\n        // ÏãúÍ∞ÑÎ≥Ñ Í∏∞Î°ù\n        this.todayHourly[hour].requests++;\n        this.todayHourly[hour].tokens += params.tokens || 0;\n\n        // üÜï ÌÇ§Î≥Ñ ÏÇ¨Ïö©Îüâ Í∏∞Î°ù\n        if (params.apiKeyId) {\n            this.recordKeyUsage(params.apiKeyId, hour);\n        }\n\n        this.saveData();\n    }\n\n    /**\n     * üÜï Í∞úÎ≥Ñ API ÌÇ§ ÏÇ¨Ïö©Îüâ Í∏∞Î°ù\n     */\n    private recordKeyUsage(keyId: string, currentHour: number): void {\n        if (!this.data.perKey) {\n            this.data.perKey = {};\n        }\n\n        const today = this.getToday();\n        let keyStats = this.data.perKey[keyId];\n\n        if (!keyStats) {\n            keyStats = {\n                keyId,\n                totalRequests: 0,\n                weeklyRequests: 0,\n                hourlyRequests: 0,\n                lastReset: today,\n                lastHourReset: currentHour\n            };\n            this.data.perKey[keyId] = keyStats;\n        }\n\n        // Ï£ºÍ∞Ñ Î¶¨ÏÖã Ï≤¥ÌÅ¨ (7Ïùº Í≤ΩÍ≥º Ïãú)\n        const lastResetDate = new Date(keyStats.lastReset);\n        const daysSinceReset = Math.floor((Date.now() - lastResetDate.getTime()) / (24 * 60 * 60 * 1000));\n        if (daysSinceReset >= 7) {\n            keyStats.weeklyRequests = 0;\n            keyStats.lastReset = today;\n        }\n\n        // ÏãúÍ∞Ñ Î¶¨ÏÖã Ï≤¥ÌÅ¨\n        if (keyStats.lastHourReset !== currentHour) {\n            keyStats.hourlyRequests = 0;\n            keyStats.lastHourReset = currentHour;\n        }\n\n        keyStats.totalRequests++;\n        keyStats.weeklyRequests++;\n        keyStats.hourlyRequests++;\n    }\n\n    /**\n     * üÜï Í∞úÎ≥Ñ ÌÇ§ Ìï†ÎãπÎüâ ÏÉÅÌÉú Ï°∞Ìöå\n     */\n    getKeyQuotaStatus(keyId: string, isActive: boolean): KeyQuotaStatus {\n        const limits = getQuotaLimits();\n        const keyStats = this.data.perKey?.[keyId];\n\n        const hourlyUsed = keyStats?.hourlyRequests || 0;\n        const weeklyUsed = keyStats?.weeklyRequests || 0;\n\n        return {\n            keyId,\n            isActive,\n            hourly: {\n                used: hourlyUsed,\n                limit: limits.hourlyLimit,\n                percentage: Math.round((hourlyUsed / limits.hourlyLimit) * 100),\n                remaining: Math.max(0, limits.hourlyLimit - hourlyUsed)\n            },\n            weekly: {\n                used: weeklyUsed,\n                limit: limits.weeklyLimit,\n                percentage: Math.round((weeklyUsed / limits.weeklyLimit) * 100),\n                remaining: Math.max(0, limits.weeklyLimit - weeklyUsed)\n            },\n            isExhausted: weeklyUsed >= limits.weeklyLimit || hourlyUsed >= limits.hourlyLimit\n        };\n    }\n\n    /**\n     * Ïò§Îäò ÌÜµÍ≥Ñ Ï°∞Ìöå\n     */\n    getTodayStats(): DailyStats {\n        const today = this.getToday();\n        const record = this.data.daily[today] || {\n            date: today,\n            requests: 0,\n            tokens: 0,\n            errors: 0,\n            avgResponseTime: 0,\n            models: {}\n        };\n\n        return {\n            date: today,\n            totalRequests: record.requests,\n            totalTokens: record.tokens,\n            totalErrors: record.errors,\n            avgResponseTime: record.avgResponseTime,\n            hourlyBreakdown: this.todayHourly,\n            modelUsage: record.models\n        };\n    }\n\n    /**\n     * ÏùºÍ∞Ñ ÌÜµÍ≥Ñ Ï°∞Ìöå (ÏµúÍ∑º NÏùº)\n     */\n    getDailyStats(days: number = 7): UsageRecord[] {\n        const result: UsageRecord[] = [];\n        const today = new Date();\n\n        for (let i = 0; i < days; i++) {\n            const date = new Date(today);\n            date.setDate(date.getDate() - i);\n            const dateStr = date.toISOString().split('T')[0];\n\n            if (this.data.daily[dateStr]) {\n                result.push(this.data.daily[dateStr]);\n            } else {\n                result.push({\n                    date: dateStr,\n                    requests: 0,\n                    tokens: 0,\n                    errors: 0,\n                    avgResponseTime: 0,\n                    models: {}\n                });\n            }\n        }\n\n        return result.reverse();  // Ïò§ÎûòÎêú ÏàúÏÑúÎ°ú Ï†ïÎ†¨\n    }\n\n    /**\n     * Ï£ºÍ∞Ñ ÌÜµÍ≥Ñ Ï°∞Ìöå\n     */\n    getWeeklyStats(): WeeklyStats {\n        const dailyStats = this.getDailyStats(7);\n        const weekStart = dailyStats[0]?.date || this.getToday();\n        const weekEnd = dailyStats[dailyStats.length - 1]?.date || this.getToday();\n\n        const totals = dailyStats.reduce((acc, day) => ({\n            requests: acc.requests + day.requests,\n            tokens: acc.tokens + day.tokens,\n            errors: acc.errors + day.errors,\n            responseTimeSum: acc.responseTimeSum + (day.avgResponseTime * day.requests),\n            requestsWithTime: acc.requestsWithTime + (day.avgResponseTime > 0 ? day.requests : 0)\n        }), { requests: 0, tokens: 0, errors: 0, responseTimeSum: 0, requestsWithTime: 0 });\n\n        return {\n            weekStart,\n            weekEnd,\n            totalRequests: totals.requests,\n            totalTokens: totals.tokens,\n            totalErrors: totals.errors,\n            avgResponseTime: totals.requestsWithTime > 0\n                ? Math.round(totals.responseTimeSum / totals.requestsWithTime)\n                : 0,\n            dailyBreakdown: dailyStats\n        };\n    }\n\n    /**\n     * Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ ÏöîÏïΩ\n     */\n    getSummary(): {\n        today: DailyStats;\n        weekly: WeeklyStats;\n        allTime: { totalRequests: number; totalTokens: number; totalErrors: number };\n        quota: QuotaStatus;\n    } {\n        const allRecords = Object.values(this.data.daily);\n        const allTime = allRecords.reduce((acc, day) => ({\n            totalRequests: acc.totalRequests + day.requests,\n            totalTokens: acc.totalTokens + day.tokens,\n            totalErrors: acc.totalErrors + day.errors\n        }), { totalRequests: 0, totalTokens: 0, totalErrors: 0 });\n\n        return {\n            today: this.getTodayStats(),\n            weekly: this.getWeeklyStats(),\n            allTime,\n            quota: this.getQuotaStatus()\n        };\n    }\n\n    /**\n     * üÜï ÌòÑÏû¨ ÏãúÍ∞Ñ ÏÇ¨Ïö©Îüâ Ï°∞Ìöå\n     */\n    getCurrentHourUsage(): number {\n        const hour = new Date().getHours();\n        return this.todayHourly[hour]?.requests || 0;\n    }\n\n    /**\n     * üÜï Ìï†ÎãπÎüâ(ÏøºÌÑ∞) ÏÉÅÌÉú Ï°∞Ìöå\n     */\n    getQuotaStatus(): QuotaStatus {\n        const limits = getQuotaLimits();\n        const todayStats = this.getTodayStats();\n\n        // üÜï Í∞úÎ≥Ñ ÌÇ§ ÏÉÅÌÉú Î®ºÏ†Ä Í≥ÑÏÇ∞\n        const keysStatus = this.getKeysQuotaStatus();\n\n        // üÜï Îëê ÌÇ§Ïùò ÏÇ¨Ïö©Îüâ Ìï©ÏÇ∞ (Í∞Å ÌÇ§Îäî Í∞úÎ≥Ñ 2500 ÌïúÎèÑ)\n        const primaryHourly = keysStatus.primary.hourly.used;\n        const secondaryHourly = keysStatus.secondary.hourly.used;\n        const primaryWeekly = keysStatus.primary.weekly.used;\n        const secondaryWeekly = keysStatus.secondary.weekly.used;\n\n        // üÜï Ï¥ù ÌïúÎèÑ = ÌÇ§ Í∞úÏàò * Í∞úÎ≥Ñ ÌïúÎèÑ\n        const totalHourlyLimit = limits.hourlyLimit * 2;  // 150 * 2 = 300\n        const totalWeeklyLimit = limits.weeklyLimit * 2;  // 2500 * 2 = 5000\n\n        const totalHourlyUsed = primaryHourly + secondaryHourly;\n        const totalWeeklyUsed = primaryWeekly + secondaryWeekly;\n\n        return {\n            hourly: {\n                used: totalHourlyUsed,\n                limit: totalHourlyLimit,\n                percentage: totalHourlyLimit > 0\n                    ? Math.round((totalHourlyUsed / totalHourlyLimit) * 100)\n                    : 0,\n                remaining: Math.max(0, totalHourlyLimit - totalHourlyUsed)\n            },\n            weekly: {\n                used: totalWeeklyUsed,\n                limit: totalWeeklyLimit,\n                percentage: totalWeeklyLimit > 0\n                    ? Math.round((totalWeeklyUsed / totalWeeklyLimit) * 100)\n                    : 0,\n                remaining: Math.max(0, totalWeeklyLimit - totalWeeklyUsed)\n            },\n            daily: {\n                used: todayStats.totalRequests,\n                limit: Math.round(totalWeeklyLimit / 7), // ÏùºÏùº Ï∂îÏ†ï ÌïúÍ≥Ñ (714)\n                percentage: totalWeeklyLimit > 0\n                    ? Math.round((todayStats.totalRequests / (totalWeeklyLimit / 7)) * 100)\n                    : 0,\n                remaining: Math.max(0, Math.round(totalWeeklyLimit / 7) - todayStats.totalRequests)\n            },\n            isOverLimit: totalWeeklyUsed >= totalWeeklyLimit,\n            warningLevel: this.calculateWarningLevelCombined(totalHourlyUsed, totalWeeklyUsed, totalHourlyLimit, totalWeeklyLimit),\n            // üÜï Í∞úÎ≥Ñ ÌÇ§ ÏÉÅÌÉú Ï∂îÍ∞Ä\n            keys: keysStatus,\n            activeKey: this.getActiveKeyId()\n        };\n    }\n\n    /**\n     * üÜï ÌÜµÌï© Í≤ΩÍ≥† Î†àÎ≤® Í≥ÑÏÇ∞\n     */\n    private calculateWarningLevelCombined(hourlyUsed: number, weeklyUsed: number, hourlyLimit: number, weeklyLimit: number): 'safe' | 'warning' | 'critical' {\n        const hourlyPercentage = (hourlyUsed / hourlyLimit) * 100;\n        const weeklyPercentage = (weeklyUsed / weeklyLimit) * 100;\n        const maxPercentage = Math.max(hourlyPercentage, weeklyPercentage);\n\n        if (maxPercentage >= 90) return 'critical';\n        if (maxPercentage >= 70) return 'warning';\n        return 'safe';\n    }\n\n    /**\n     * üÜï Î™®Îì† ÌÇ§Ïùò Ìï†ÎãπÎüâ ÏÉÅÌÉú Ï°∞Ìöå (4Í∞ú ÌÇ§ ÏßÄÏõê)\n     */\n    private getKeysQuotaStatus(): { primary: KeyQuotaStatus; secondary: KeyQuotaStatus } {\n        const cfg = getConfig();\n        const key1 = process.env.OLLAMA_API_KEY_1 || cfg.ollamaApiKeyPrimary;\n        const key2 = process.env.OLLAMA_API_KEY_2 || cfg.ollamaApiKeySecondary;\n\n        // ApiKeyManagerÏóêÏÑú ÌòÑÏû¨ ÌôúÏÑ± ÌÇ§ Ïù∏Îç±Ïä§ ÌôïÏù∏\n        let activeIndex = 0;\n        try {\n            activeIndex = getApiKeyManager().getStatus().activeKeyIndex;\n        } catch (e) {\n            // ignore\n        }\n\n        return {\n            primary: this.getKeyQuotaStatus(getKeyId(key1), activeIndex === 0),\n            secondary: this.getKeyQuotaStatus(getKeyId(key2), activeIndex === 1)\n        };\n    }\n\n    /**\n     * üÜï ÌòÑÏû¨ ÌôúÏÑ± ÌÇ§ ID Ï°∞Ìöå (4Í∞ú ÌÇ§ ÏßÄÏõê)\n     */\n    private getActiveKeyId(): string {\n        try {\n            const manager = getApiKeyManager();\n            return getKeyId(manager.getCurrentKey());\n        } catch (e) {\n            return 'unknown';\n        }\n    }\n\n    /**\n     * Í≤ΩÍ≥† Î†àÎ≤® Í≥ÑÏÇ∞\n     */\n    private calculateWarningLevel(hourlyUsage: number, weeklyUsage: number, limits: QuotaLimits): 'safe' | 'warning' | 'critical' {\n        const hourlyPercentage = (hourlyUsage / limits.hourlyLimit) * 100;\n        const weeklyPercentage = (weeklyUsage / limits.weeklyLimit) * 100;\n        const maxPercentage = Math.max(hourlyPercentage, weeklyPercentage);\n\n        if (maxPercentage >= 90) return 'critical';\n        if (maxPercentage >= 70) return 'warning';\n        return 'safe';\n    }\n\n    /**\n     * Ïò§ÎûòÎêú Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨ (90Ïùº Ïù¥ÏÉÅ)\n     */\n    cleanup(retentionDays: number = 90): void {\n        const cutoffDate = new Date();\n        cutoffDate.setDate(cutoffDate.getDate() - retentionDays);\n        const cutoff = cutoffDate.toISOString().split('T')[0];\n\n        let cleaned = 0;\n        for (const date of Object.keys(this.data.daily)) {\n            if (date < cutoff) {\n                delete this.data.daily[date];\n                cleaned++;\n            }\n        }\n\n        if (cleaned > 0) {\n            console.log(`[ApiUsageTracker] ${cleaned}ÏùºÏπò Ïò§ÎûòÎêú Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨Îê®`);\n            this.saveData();\n        }\n    }\n}\n\n// Ïã±Í∏ÄÌÜ§ Ïù∏Ïä§ÌÑ¥Ïä§\nlet tracker: ApiUsageTracker | null = null;\n\nexport function getApiUsageTracker(): ApiUsageTracker {\n    if (!tracker) {\n        tracker = new ApiUsageTracker();\n    }\n    return tracker;\n}\n\nexport { ApiUsageTracker, UsageRecord, DailyStats, WeeklyStats, HourlyRecord, QuotaStatus };\n"],"version":3}