<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ - OpenMake.Ai</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/design-tokens.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layout.css">
    <style>
        .form-wrapper { max-width:480px; margin:0 auto; }
        .form-card { background:var(--bg-card); border:1px solid var(--border-light); border-radius:var(--radius-lg); padding:var(--space-6); }
        .form-card h2 { margin:0 0 var(--space-5); color:var(--text-primary); text-align:center; font-size:1.3rem; }
        .form-group { margin-bottom:var(--space-4); }
        .form-group label { display:block; margin-bottom:var(--space-2); color:var(--text-secondary); font-size:var(--font-size-sm); font-weight:var(--font-weight-semibold); }
        .input-wrap { position:relative; }
        .input-wrap input { width:100%; padding:var(--space-3); padding-right:44px; background:var(--bg-secondary); border:1px solid var(--border-light); border-radius:var(--radius-md); color:var(--text-primary); font-size:14px; box-sizing:border-box; }
        .input-wrap input:focus { outline:none; border-color:var(--accent-primary); }
        .toggle-pw { position:absolute; right:12px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:16px; padding:0; }
        .strength-bar { height:4px; background:var(--bg-tertiary); border-radius:2px; margin-top:var(--space-2); overflow:hidden; }
        .strength-fill { height:100%; border-radius:2px; transition:width .3s, background .3s; }
        .strength-label { font-size:12px; margin-top:var(--space-1); }
        .strength-weak { color:var(--danger); }
        .strength-medium { color:var(--warning); }
        .strength-strong { color:var(--success); }
        .rules-list { margin-top:var(--space-2); list-style:none; padding:0; }
        .rules-list li { font-size:12px; color:var(--text-muted); padding:2px 0; display:flex; align-items:center; gap:var(--space-2); }
        .rules-list li.pass { color:var(--success); }
        .rules-list li.fail { color:var(--text-muted); }
        .rule-icon { width:14px; text-align:center; }
        .btn-submit { width:100%; padding:var(--space-3); background:var(--accent-primary); color:#fff; border:none; border-radius:var(--radius-md); cursor:pointer; font-size:15px; font-weight:var(--font-weight-bold); margin-top:var(--space-4); transition:opacity .2s; }
        .btn-submit:disabled { opacity:0.5; cursor:not-allowed; }
        .btn-submit:not(:disabled):hover { opacity:0.9; }
        .back-link { display:block; text-align:center; margin-top:var(--space-4); color:var(--text-muted); font-size:var(--font-size-sm); text-decoration:none; }
        .back-link:hover { color:var(--accent-primary); }
        .toast { position:fixed; bottom:20px; right:20px; padding:var(--space-3) var(--space-5); border-radius:var(--radius-md); color:#fff; z-index:2000; opacity:0; transition:opacity .3s; }
        .toast.show { opacity:1; } .toast.success { background:var(--success); } .toast.error { background:var(--danger); }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar" id="sidebar"></aside>
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <main class="main-content">
            <header class="page-header">
                <button class="mobile-menu-btn" onclick="toggleMobileSidebar(event)">&#9776;</button>
                <h1>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h1>
            </header>
            <div class="content-area">
                <div class="form-wrapper">
                    <div class="form-card">
                        <h2>ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
                        <form id="pwForm" autocomplete="off">
                            <div class="form-group">
                                <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                                <div class="input-wrap">
                                    <input type="password" id="currentPw" required placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                                    <button type="button" class="toggle-pw" onclick="toggleVis('currentPw', this)">ğŸ‘ï¸</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                                <div class="input-wrap">
                                    <input type="password" id="newPw" required placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" oninput="checkStrength()">
                                    <button type="button" class="toggle-pw" onclick="toggleVis('newPw', this)">ğŸ‘ï¸</button>
                                </div>
                                <div class="strength-bar"><div class="strength-fill" id="strengthFill" style="width:0"></div></div>
                                <div class="strength-label" id="strengthLabel"></div>
                                <ul class="rules-list" id="rulesList">
                                    <li class="fail" id="rule-len"><span class="rule-icon">âœ—</span> ìµœì†Œ 8ì ì´ìƒ</li>
                                    <li class="fail" id="rule-case"><span class="rule-icon">âœ—</span> ëŒ€ì†Œë¬¸ì í¬í•¨</li>
                                    <li class="fail" id="rule-num"><span class="rule-icon">âœ—</span> ìˆ«ì í¬í•¨</li>
                                    <li class="fail" id="rule-special"><span class="rule-icon">âœ—</span> íŠ¹ìˆ˜ë¬¸ì í¬í•¨</li>
                                </ul>
                            </div>
                            <div class="form-group">
                                <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                                <div class="input-wrap">
                                    <input type="password" id="confirmPw" required placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥" oninput="checkMatch()">
                                    <button type="button" class="toggle-pw" onclick="toggleVis('confirmPw', this)">ğŸ‘ï¸</button>
                                </div>
                                <div class="strength-label" id="matchLabel"></div>
                            </div>
                            <button type="submit" class="btn-submit" id="submitBtn" disabled>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                        </form>
                        <a href="/settings.html" class="back-link">â† ì„¤ì •ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="toast" class="toast"></div>
    <script src="/js/components/sidebar.js"></script>
    <script>
        function authFetch(url, opts = {}) {
            const token = localStorage.getItem('authToken');
            opts.headers = { ...(opts.headers || {}), 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
            return fetch(url, opts);
        }
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            t.textContent = msg; t.className = `toast ${type} show`;
            setTimeout(() => t.classList.remove('show'), 2500);
        }
        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

        // ë¡œê·¸ì¸ í™•ì¸
        if (!localStorage.getItem('authToken')) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login.html';
        }

        function toggleVis(id, btn) {
            const inp = document.getElementById(id);
            if (inp.type === 'password') { inp.type = 'text'; btn.textContent = 'ğŸ™ˆ'; }
            else { inp.type = 'password'; btn.textContent = 'ğŸ‘ï¸'; }
        }

        const rules = {
            len: pw => pw.length >= 8,
            case: pw => /[a-z]/.test(pw) && /[A-Z]/.test(pw),
            num: pw => /\d/.test(pw),
            special: pw => /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pw)
        };

        function checkStrength() {
            const pw = document.getElementById('newPw').value;
            let score = 0;
            for (const [key, fn] of Object.entries(rules)) {
                const pass = fn(pw);
                const el = document.getElementById('rule-' + key);
                el.className = pass ? 'pass' : 'fail';
                el.querySelector('.rule-icon').textContent = pass ? 'âœ“' : 'âœ—';
                if (pass) score++;
            }

            const fill = document.getElementById('strengthFill');
            const label = document.getElementById('strengthLabel');
            if (pw.length === 0) {
                fill.style.width = '0';
                label.textContent = '';
                label.className = 'strength-label';
            } else if (score <= 1) {
                fill.style.width = '25%'; fill.style.background = 'var(--danger)';
                label.textContent = 'ì•½í•¨'; label.className = 'strength-label strength-weak';
            } else if (score <= 3) {
                fill.style.width = '60%'; fill.style.background = 'var(--warning)';
                label.textContent = 'ë³´í†µ'; label.className = 'strength-label strength-medium';
            } else {
                fill.style.width = '100%'; fill.style.background = 'var(--success)';
                label.textContent = 'ê°•í•¨'; label.className = 'strength-label strength-strong';
            }
            checkMatch();
        }

        function checkMatch() {
            const pw = document.getElementById('newPw').value;
            const confirm = document.getElementById('confirmPw').value;
            const label = document.getElementById('matchLabel');
            const allRulesPass = Object.values(rules).every(fn => fn(pw));
            const match = pw === confirm && confirm.length > 0;

            if (confirm.length === 0) { label.textContent = ''; }
            else if (match) { label.textContent = 'âœ“ ì¼ì¹˜í•©ë‹ˆë‹¤'; label.className = 'strength-label strength-strong'; }
            else { label.textContent = 'âœ— ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'; label.className = 'strength-label strength-weak'; }

            document.getElementById('submitBtn').disabled = !(allRulesPass && match && document.getElementById('currentPw').value.length > 0);
        }

        document.getElementById('currentPw').addEventListener('input', checkMatch);

        document.getElementById('pwForm').addEventListener('submit', async e => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'ë³€ê²½ ì¤‘...';

            try {
                const res = await authFetch('/api/auth/password', {
                    method: 'PUT',
                    body: JSON.stringify({
                        currentPassword: document.getElementById('currentPw').value,
                        newPassword: document.getElementById('newPw').value
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    setTimeout(() => window.location.href = '/settings.html', 2000);
                } else {
                    showToast(data.error || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨', 'error');
                    btn.disabled = false;
                    btn.textContent = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½';
                }
            } catch (err) {
                console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì˜¤ë¥˜:', err);
                showToast('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                btn.disabled = false;
                btn.textContent = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½';
            }
        });
    </script>
</body>
</html>
