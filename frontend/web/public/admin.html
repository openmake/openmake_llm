<!DOCTYPE html>
<html lang="ko" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - OpenMake.Ai</title>
    <link rel="icon" type="image/png" href="/logo.png">

    <!-- í†µí•© ë””ìì¸ ì‹œìŠ¤í…œ -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/design-tokens.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/pages/dashboard.css">

    <style>
        /* Admin-specific styles */
        .badge-admin {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .badge-user {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .badge-guest {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .badge-active {
            background: var(--success-light);
            color: var(--success);
        }

        .badge-inactive {
            background: var(--danger-light);
            color: var(--danger);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            color: white;
            font-size: var(--font-size-sm);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <button class="mobile-menu-btn" onclick="toggleMobileSidebar()"><span></span><span></span><span></span></button>
        <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>
        <nav class="sidebar" id="sidebar"></nav>

        <div class="main-content">
            <div class="page-content">
                <div class="container container-xl">
                    <header class="page-header">
                        <div>
                            <h1 class="page-title page-title-gradient">ğŸ‘¥ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
                            <p class="page-subtitle">ì‚¬ìš©ì ë° ëŒ€í™” ê´€ë¦¬</p>
                        </div>
                        <div class="page-actions">
                            <a href="/" class="btn btn-secondary">â† ì±„íŒ…ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                        </div>
                    </header>

                    <div class="tabs" style="margin-bottom: var(--space-6); width: fit-content;">
                        <button class="tab active" onclick="switchTab('users')">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>
                        <button class="tab" onclick="switchTab('conversations')">ğŸ’¬ ëŒ€í™” ê¸°ë¡</button>
                        <button class="tab" onclick="switchTab('stats')">ğŸ“Š í†µê³„</button>
                    </div>

                    <!-- Stats Cards -->
                    <div class="dashboard-grid" style="margin-bottom: var(--space-8);">
                        <div class="metric-card card">
                            <div class="metric-card-value" id="statTotalUsers">0</div>
                            <div class="text-muted text-sm">ì´ ì‚¬ìš©ì</div>
                        </div>
                        <div class="metric-card card">
                            <div class="metric-card-value" id="statActiveUsers">0</div>
                            <div class="text-muted text-sm">í™œì„± ì‚¬ìš©ì</div>
                        </div>
                        <div class="metric-card card">
                            <div class="metric-card-value" id="statAdmins">0</div>
                            <div class="text-muted text-sm">ê´€ë¦¬ì</div>
                        </div>
                        <div class="metric-card card">
                            <div class="metric-card-value" id="statTodayQueries">0</div>
                            <div class="text-muted text-sm">ì˜¤ëŠ˜ ì§ˆë¬¸</div>
                        </div>
                    </div>

                    <!-- Users Panel -->
                    <div id="usersPanel" class="panel active">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">ì‚¬ìš©ì ëª©ë¡</span>
                                <button class="btn btn-primary btn-sm" onclick="showAddUserModal()">+ ì‚¬ìš©ì ì¶”ê°€</button>
                            </div>
                            <div class="search-bar" style="margin-bottom: var(--space-4);">
                                <select id="filterRole" class="form-select" style="width: auto;" onchange="loadUsers()">
                                    <option value="">ëª¨ë“  ì—­í• </option>
                                    <option value="admin">ê´€ë¦¬ì</option>
                                    <option value="user">ì¼ë°˜ ì‚¬ìš©ì</option>
                                    <option value="guest">ê²ŒìŠ¤íŠ¸</option>
                                </select>
                                <input type="text" id="filterSearch" class="form-input" style="max-width: 300px;"
                                    placeholder="ì´ë©”ì¼ ê²€ìƒ‰..." onkeyup="debounceSearch()">
                            </div>
                            <div class="table-container" style="border: none;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>ì´ë©”ì¼</th>
                                            <th>ì—­í• </th>
                                            <th>ìƒíƒœ</th>
                                            <th>ê°€ì…ì¼</th>
                                            <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                                            <th>ì‘ì—…</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersList"></tbody>
                                </table>
                            </div>
                            <div class="pagination flex justify-center gap-2 mt-4" id="usersPagination"></div>
                        </div>
                    </div>

                    <!-- Conversations Panel -->
                    <div id="conversationsPanel" class="panel" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">ëŒ€í™” ê¸°ë¡</span>
                                <button class="btn btn-secondary btn-sm" onclick="exportCSV()">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
                            </div>
                            <div class="search-bar" style="margin-bottom: var(--space-4);">
                                <input type="date" id="filterDate" class="form-input" style="width: auto;"
                                    onchange="loadConversations()">
                                <select id="filterConvRole" class="form-select" style="width: auto;"
                                    onchange="loadConversations()">
                                    <option value="">ëª¨ë“  ì—­í• </option>
                                    <option value="user">ì‚¬ìš©ìë§Œ</option>
                                    <option value="assistant">AI ì‘ë‹µë§Œ</option>
                                </select>
                                <input type="text" id="filterConvSearch" class="form-input" style="max-width: 300px;"
                                    placeholder="ê²€ìƒ‰ì–´..." onkeyup="debounceConvSearch()">
                            </div>
                            <div class="table-container" style="border: none;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>ì‹œê°„</th>
                                            <th>ì—­í• </th>
                                            <th>ë‚´ìš©</th>
                                            <th>ëª¨ë¸</th>
                                        </tr>
                                    </thead>
                                    <tbody id="conversationsList"></tbody>
                                </table>
                            </div>
                            <div class="pagination flex justify-center gap-2 mt-4" id="convPagination"></div>
                        </div>
                    </div>

                    <!-- Stats Panel -->
                    <div id="statsPanel" class="panel" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">ì‹œìŠ¤í…œ í†µê³„</span>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">ìƒì„¸ í†µê³„ ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="editModalTitle">ì‚¬ìš©ì í¸ì§‘</h3>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label class="form-label">ì´ë©”ì¼</label>
                    <input type="email" id="editEmail" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">ë¹„ë°€ë²ˆí˜¸ (ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥)</label>
                    <input type="password" id="editPassword" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
                </div>
                <div class="form-group">
                    <label class="form-label">ì—­í• </label>
                    <select id="editRole" class="form-select">
                        <option value="user">ì¼ë°˜ ì‚¬ìš©ì</option>
                        <option value="admin">ê´€ë¦¬ì</option>
                        <option value="guest">ê²ŒìŠ¤íŠ¸</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ìƒíƒœ</label>
                    <select id="editActive" class="form-select">
                        <option value="1">í™œì„±</option>
                        <option value="0">ë¹„í™œì„±</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveUser()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script src="/js/components/sidebar.js"></script>
    <script>
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let usersPage = 1;
        let convPage = 1;
        const pageSize = 20;
        let searchTimeout;

        async function checkAuth() {
             if (!authToken) { window.location.href = '/login.html'; return false; }
             try {
                 const res = await authFetch('/api/auth/me');
                 const data = await res.json();
                 const payload = data.data || data;
                 if (!res.ok || !payload.user) throw new Error('ì¸ì¦ ì‹¤íŒ¨');
                 currentUser = payload.user;
                if (currentUser.role !== 'admin') {
                    showToast('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
                    setTimeout(() => window.location.href = '/', 1500);
                    return false;
                }
                return true;
            } catch (e) {
                window.location.href = '/login.html';
                return false;
            }
        }

        async function authFetch(url, options = {}) {
            return fetch(url, {
                ...options,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}`, ...(options.headers || {}) }
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}Panel`).style.display = 'block';
        }

        async function loadUsers() {
             const role = document.getElementById('filterRole').value;
             const search = document.getElementById('filterSearch').value;
             try {
                 const params = new URLSearchParams({ page: usersPage, limit: pageSize, ...(role && { role }), ...(search && { search }) });
                 const res = await authFetch(`/api/admin/users?${params}`);
                 const data = await res.json();
                 const payload = data.data || data;
                 renderUsers(payload.users || []);
                 renderPagination('usersPagination', payload.total || 0, usersPage, (p) => { usersPage = p; loadUsers(); });
             } catch (e) { showToast('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', 'error'); }
         }

        function renderUsers(users) {
            const tbody = document.getElementById('usersList');
            if (users.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted p-4">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>'; return; }
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${escapeHtml(u.email)}</td>
                    <td><span class="badge badge-${u.role}">${getRoleName(u.role)}</span></td>
                    <td><span class="badge ${u.is_active ? 'badge-active' : 'badge-inactive'}">${u.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}</span></td>
                    <td>${formatDate(u.created_at)}</td>
                    <td>${u.last_login ? formatDate(u.last_login) : '-'}</td>
                    <td class="flex gap-2">
                        <button class="btn btn-secondary btn-sm" onclick="editUser(${u.id})">í¸ì§‘</button>
                        ${u.id !== currentUser.id ? `<button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">ì‚­ì œ</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function getRoleName(role) { return { admin: 'ê´€ë¦¬ì', user: 'ì‚¬ìš©ì', guest: 'ê²ŒìŠ¤íŠ¸' }[role] || role; }

        async function loadUserStats() {
             try {
                 const res = await authFetch('/api/admin/users/stats');
                 const stats = await res.json();
                 const payload = stats.data || stats;
                 document.getElementById('statTotalUsers').textContent = payload.total_users || 0;
                 document.getElementById('statActiveUsers').textContent = payload.active_users || 0;
                 document.getElementById('statAdmins').textContent = payload.admins || 0;
             } catch (e) { }
             try {
                 const res = await authFetch('/api/admin/stats');
                 if (res.ok) { const data = await res.json(); const payload2 = data.data || data; document.getElementById('statTodayQueries').textContent = payload2.today_queries || 0; }
             } catch (e) { }
         }

        function showAddUserModal() {
            document.getElementById('editModalTitle').textContent = 'ìƒˆ ì‚¬ìš©ì ì¶”ê°€';
            document.getElementById('editUserId').value = '';
            document.getElementById('editEmail').value = '';
            document.getElementById('editPassword').value = '';
            document.getElementById('editRole').value = 'user';
            document.getElementById('editActive').value = '1';
            document.getElementById('editUserModal').classList.add('active');
        }

         async function editUser(id) {
             try {
                 const res = await authFetch(`/api/admin/users?search=`);
                 const data = await res.json();
                 const payload = data.data || data;
                 const user = (payload.users || []).find(u => u.id === id);
                 if (!user) { showToast('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
                document.getElementById('editModalTitle').textContent = 'ì‚¬ìš©ì í¸ì§‘';
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editEmail').value = user.email;
                document.getElementById('editPassword').value = '';
                document.getElementById('editRole').value = user.role;
                document.getElementById('editActive').value = user.is_active ? '1' : '0';
                document.getElementById('editUserModal').classList.add('active');
            } catch (e) { showToast('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨', 'error'); }
        }

        async function saveUser() {
            const id = document.getElementById('editUserId').value;
            const email = document.getElementById('editEmail').value;
            const password = document.getElementById('editPassword').value;
            const role = document.getElementById('editRole').value;
            const is_active = document.getElementById('editActive').value === '1';
            if (!email) { showToast('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
            try {
                if (id) {
                    await authFetch(`/api/admin/users/${id}`, { method: 'PUT', body: JSON.stringify({ email, role, is_active }) });
                    showToast('ì‚¬ìš©ì ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                } else {
                    if (!password || password.length < 6) { showToast('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤', 'error'); return; }
                    await authFetch('/api/auth/register', { method: 'POST', body: JSON.stringify({ email, password }) });
                    showToast('ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                }
                closeModal(); loadUsers(); loadUserStats();
            } catch (e) { showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error'); }
        }

         async function deleteUser(id) {
             if (!confirm('ì •ë§ ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
             try {
                 const res = await authFetch(`/api/admin/users/${id}`, { method: 'DELETE' });
                 const data = await res.json();
                 if (res.ok) { showToast('ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success'); loadUsers(); loadUserStats(); }
                 else { 
                     const errorMsg = (data.error && typeof data.error === 'object') ? data.error.message : data.error;
                     showToast(errorMsg || 'ì‚­ì œ ì‹¤íŒ¨', 'error');
                 }
             } catch (e) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
         }

        function closeModal() { document.getElementById('editUserModal').classList.remove('active'); }

        function debounceSearch() { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { usersPage = 1; loadUsers(); }, 300); }

         async function loadConversations() {
             const date = document.getElementById('filterDate').value;
             const role = document.getElementById('filterConvRole').value;
             const search = document.getElementById('filterConvSearch').value;
             try {
                 const params = new URLSearchParams({ page: convPage, limit: pageSize, ...(date && { date }), ...(role && { role }), ...(search && { search }) });
                 const res = await authFetch(`/api/admin/conversations?${params}`);
                 const data = await res.json();
                 const payload = data.data || data;
                 renderConversations(payload.conversations || []);
                 renderPagination('convPagination', payload.total || 0, convPage, (p) => { convPage = p; loadConversations(); });
             } catch (e) { showToast('ëŒ€í™” ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨', 'error'); }
         }

        function renderConversations(conversations) {
            const tbody = document.getElementById('conversationsList');
            if (conversations.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted p-4">ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>'; return; }
            tbody.innerHTML = conversations.map(c => `
                <tr>
                    <td>${formatDateTime(c.created_at)}</td>
                    <td><span class="badge ${c.role === 'user' ? 'badge-user' : 'badge-info'}">${c.role}</span></td>
                    <td style="max-width:400px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(c.content?.substring(0, 100) || '')}</td>
                    <td class="text-muted text-sm">${c.model || '-'}</td>
                </tr>
            `).join('');
        }

        function debounceConvSearch() { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { convPage = 1; loadConversations(); }, 300); }
        function exportCSV() { window.open('/api/admin/conversations/export?format=csv', '_blank'); }

        function renderPagination(containerId, total, currentPage, onPageChange) {
            const totalPages = Math.ceil(total / pageSize);
            const container = document.getElementById(containerId);
            if (totalPages <= 1) { container.innerHTML = ''; return; }
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'} btn-sm" onclick="(${onPageChange.toString()})(${i})">${i}</button>`;
            }
            container.innerHTML = html;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return `${formatDate(dateStr)} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Init
        (async () => {
            if (await checkAuth()) { loadUsers(); loadUserStats(); loadConversations(); }
        })();
    </script>
</body>

</html>