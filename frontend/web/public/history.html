<!DOCTYPE html>
<html lang="ko" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>ëŒ€í™” íˆìŠ¤í† ë¦¬ - OpenMake.Ai</title>
    <link rel="icon" type="image/png" href="/logo.png">

    <!-- í†µí•© ë””ìì¸ ì‹œìŠ¤í…œ -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/design-tokens.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layout.css">

    <style>
        .session-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: var(--space-3);
        }

        .session-card:hover {
            border-color: var(--accent-primary);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-title {
            font-weight: var(--font-weight-semibold);
        }

        .session-meta {
            display: flex;
            gap: var(--space-4);
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            margin-top: var(--space-2);
        }

        .session-preview {
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid var(--border-light);
            color: var(--text-muted);
            font-size: var(--font-size-sm);
            line-height: 1.5;
        }

        .messages-panel {
            display: none;
            margin-top: var(--space-4);
            padding: var(--space-4);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .messages-panel.show {
            display: block;
        }

        .message {
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            border-radius: var(--radius-md);
        }

        .message.user {
            background: var(--accent-primary-light);
        }

        .message.assistant {
            background: var(--bg-tertiary);
        }

        .message-role {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            margin-bottom: var(--space-1);
            text-transform: uppercase;
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <button class="mobile-menu-btn" onclick="toggleMobileSidebar()"><span></span><span></span><span></span></button>
        <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>
        <nav class="sidebar" id="sidebar"></nav>

        <div class="main-content">
            <div class="page-content">
                <div class="container container-xl">
                    <header class="page-header">
                        <div>
                            <h1 class="page-title page-title-gradient">ğŸ“œ ëŒ€í™” íˆìŠ¤í† ë¦¬</h1>
                            <p class="page-subtitle">ì´ì „ ëŒ€í™” ê¸°ë¡ ì¡°íšŒ</p>
                        </div>
                        <div class="page-actions">
                            <button class="btn btn-secondary" onclick="exportHistory()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
                            <button class="btn btn-primary" onclick="loadSessions()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                    </header>

                    <div class="search-bar" style="margin-bottom: var(--space-6);">
                        <input type="date" id="filterDate" class="form-input" style="width: auto;"
                            onchange="loadSessions()">
                        <input type="text" id="searchQuery" class="form-input" style="max-width: 300px;"
                            placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." onkeyup="debounceSearch()">
                        <select id="sortOrder" class="form-select" style="width: auto;" onchange="loadSessions()">
                            <option value="desc">ìµœì‹ ìˆœ</option>
                            <option value="asc">ì˜¤ë˜ëœìˆœ</option>
                        </select>
                    </div>

                    <div id="sessionsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ”„</div>
                            <div class="empty-state-title">ëŒ€í™” ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/components/sidebar.js"></script>
    <script>
        const API_BASE = window.location.origin;
        let allSessions = [];
        let searchTimeout;

        // ì¸ì¦ ì²´í¬
        (function checkAuthAccess() {
            const authToken = localStorage.getItem('authToken');
            const isGuest = localStorage.getItem('isGuest') === 'true';
            if (!authToken || isGuest) {
                alert('ì´ í˜ì´ì§€ëŠ” ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login.html';
            }
        })();

        async function loadSessions() {
            const list = document.getElementById('sessionsList');
            // ë¡œë”© í‘œì‹œê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            if (!allSessions.length) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”„</div><div class="empty-state-title">ëŒ€í™” ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>';
            }

            try {
                // ğŸ”‘ ì¸ì¦ í—¤ë” ì¶”ê°€ (ê´€ë¦¬ì/ì‚¬ìš©ì ì¸ì¦ ì „ë‹¬)
                const authToken = localStorage.getItem('authToken');
                const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};

                const res = await fetch('/api/chat/sessions?limit=100', { headers });
                const data = await res.json();
                const payload = data.data || data;

                if (data.success) {
                    allSessions = payload.sessions;
                    renderSessions();
                } else {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><div class="empty-state-title">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div></div>';
                }
            } catch (e) {
                console.error('ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:', e);
                list.innerHTML = '<div class="empty-state"><div class="empty-state-title">ì„œë²„ ì—°ê²° ì˜¤ë¥˜</div></div>';
            }
        }

        function renderSessions() {
            const list = document.getElementById('sessionsList');
            const query = document.getElementById('searchQuery').value.toLowerCase();
            const dateFilter = document.getElementById('filterDate').value;
            const sortOrder = document.getElementById('sortOrder').value; // 'desc' or 'asc'

            let filtered = allSessions.filter(s => {
                // ê²€ìƒ‰ í•„í„° (ì œëª©)
                if (query && !s.title.toLowerCase().includes(query)) return false;
                // ë‚ ì§œ í•„í„°
                if (dateFilter) {
                    const sDate = new Date(s.createdAt).toISOString().split('T')[0];
                    if (sDate !== dateFilter) return false;
                }
                return true;
            });

            // ì •ë ¬
            filtered.sort((a, b) => {
                const timeA = new Date(a.updatedAt || a.createdAt).getTime();
                const timeB = new Date(b.updatedAt || b.createdAt).getTime();
                return sortOrder === 'desc' ? timeB - timeA : timeA - timeB;
            });

            if (filtered.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-title">ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div></div>';
                return;
            }

            list.innerHTML = filtered.map(s => `
                <div class="session-card" onclick="goToSession('${s.id}')">
                    <div class="session-header">
                        <span class="session-title">${escapeHtml(s.title || 'ìƒˆ ëŒ€í™”')}</span>
                        <span class="session-meta">${formatDate(s.updatedAt || s.createdAt)}</span>
                    </div>
                    <div class="session-meta">
                        <span>ğŸ’¬ ${s.model || 'Unknown Model'}</span>
                    </div>
                    ${s.preview ? `<div class="session-preview">${escapeHtml(s.preview)}</div>` : ''}
                </div>
            `).join('');
        }

        function goToSession(id) {
            // ë©”ì¸ ì±„íŒ… í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ë©° ì„¸ì…˜ ID ì „ë‹¬
            window.location.href = `/?sessionId=${id}`;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(renderSessions, 300); // API ì¬í˜¸ì¶œ ëŒ€ì‹  ë Œë”ë§ë§Œ ê°±ì‹ 
        }

        function exportHistory() {
            if (allSessions.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allSessions, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "chat_history.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        loadSessions();
    </script>
</body>

</html>