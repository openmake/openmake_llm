<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>분석 대시보드 - OpenMake.Ai</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/design-tokens.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layout.css">
    <style>
        .dash-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:var(--space-4); margin-bottom:var(--space-5); }
        .dash-card { background:var(--bg-card); border:1px solid var(--border-light); border-radius:var(--radius-lg); padding:var(--space-5); }
        .dash-card h3 { margin:0 0 var(--space-3); color:var(--text-primary); font-size:1rem; }
        .health-badge { display:inline-block; padding:var(--space-1) var(--space-3); border-radius:var(--radius-md); font-size:var(--font-size-sm); font-weight:var(--font-weight-bold); }
        .health-healthy { background:var(--success); color:#fff; }
        .health-degraded { background:var(--warning); color:#000; }
        .health-critical { background:var(--danger); color:#fff; }
        .metric-row { display:flex; justify-content:space-between; padding:var(--space-2) 0; border-bottom:1px solid var(--border-light); font-size:var(--font-size-sm); }
        .metric-row:last-child { border-bottom:none; }
        .metric-label { color:var(--text-muted); }
        .metric-value { color:var(--text-primary); font-weight:var(--font-weight-semibold); }
        .section-title { font-size:1.1rem; font-weight:var(--font-weight-semibold); color:var(--text-primary); margin:var(--space-5) 0 var(--space-4); }
        .data-table { width:100%; border-collapse:collapse; background:var(--bg-card); border:1px solid var(--border-light); border-radius:var(--radius-lg); overflow:hidden; }
        .data-table th, .data-table td { padding:var(--space-3) var(--space-4); text-align:left; border-bottom:1px solid var(--border-light); font-size:var(--font-size-sm); }
        .data-table th { background:var(--bg-tertiary); color:var(--text-secondary); font-weight:var(--font-weight-semibold); }
        .data-table td { color:var(--text-primary); }
        .data-table tr:last-child td { border-bottom:none; }
        .cost-big { font-size:1.8rem; font-weight:var(--font-weight-bold); color:var(--accent-primary); }
        .cost-label { font-size:var(--font-size-sm); color:var(--text-muted); margin-top:var(--space-1); }
        .peak-bar { height:8px; background:var(--bg-tertiary); border-radius:4px; overflow:hidden; margin-top:var(--space-1); }
        .peak-fill { height:100%; background:var(--accent-primary); border-radius:4px; }
        .refresh-info { font-size:var(--font-size-sm); color:var(--text-muted); text-align:right; margin-bottom:var(--space-3); }
        .empty-state { text-align:center; padding:var(--space-8); color:var(--text-muted); }
        .loading { text-align:center; padding:var(--space-6); color:var(--text-muted); }
        .toast { position:fixed; bottom:20px; right:20px; padding:var(--space-3) var(--space-5); border-radius:var(--radius-md); color:#fff; z-index:2000; opacity:0; transition:opacity .3s; }
        .toast.show { opacity:1; } .toast.success { background:var(--success); } .toast.error { background:var(--danger); }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar" id="sidebar"></aside>
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <main class="main-content">
            <header class="page-header">
                <button class="mobile-menu-btn" onclick="toggleMobileSidebar(event)">&#9776;</button>
                <h1>분석 대시보드</h1>
            </header>
            <div class="content-area">
                <div class="refresh-info" id="refreshInfo">마지막 업데이트: -</div>

                <!-- 시스템 건강 + 비용 -->
                <div class="dash-grid">
                    <div class="dash-card">
                        <h3>시스템 상태</h3>
                        <div id="healthSection"><div class="loading">로딩 중...</div></div>
                    </div>
                    <div class="dash-card">
                        <h3>비용 분석</h3>
                        <div id="costSection"><div class="loading">로딩 중...</div></div>
                    </div>
                    <div class="dash-card">
                        <h3>피드백 통계</h3>
                        <div id="feedbackSection"><div class="loading">로딩 중...</div></div>
                    </div>
                </div>

                <!-- 에이전트 성능 -->
                <h3 class="section-title">에이전트 성능</h3>
                <div id="agentTable"><div class="loading">로딩 중...</div></div>

                <!-- 사용자 행동 -->
                <h3 class="section-title">사용자 행동 분석</h3>
                <div class="dash-grid">
                    <div class="dash-card">
                        <h3>피크 시간대</h3>
                        <div id="peakHours"><div class="loading">로딩 중...</div></div>
                    </div>
                    <div class="dash-card">
                        <h3>인기 쿼리</h3>
                        <div id="topQueries"><div class="loading">로딩 중...</div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="toast" class="toast"></div>
    <script src="/js/components/sidebar.js"></script>
    <script>
        function authFetch(url, opts = {}) {
            const token = localStorage.getItem('authToken');
            opts.headers = { ...(opts.headers || {}), 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
            return fetch(url, opts);
        }
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            t.textContent = msg; t.className = `toast ${type} show`;
            setTimeout(() => t.classList.remove('show'), 2500);
        }
        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function fmtNum(n) { return n != null ? Number(n).toLocaleString('ko-KR') : '-'; }

        function renderHealth(usage) {
            const today = usage.today || {};
            const errorRate = today.totalRequests > 0 ? ((today.totalErrors / today.totalRequests) * 100).toFixed(1) : '0';
            let status = 'healthy', label = '정상';
            if (errorRate > 10) { status = 'critical'; label = '위험'; }
            else if (errorRate > 5 || today.avgResponseTime > 5000) { status = 'degraded'; label = '주의'; }

            document.getElementById('healthSection').innerHTML = `
                <div style="margin-bottom:var(--space-3)"><span class="health-badge health-${status}">${label}</span></div>
                 <div class="metric-row"><span class="metric-label">업타임</span><span class="metric-value">${usage.uptime || 0}초</span></div>
                <div class="metric-row"><span class="metric-label">에러율</span><span class="metric-value">${errorRate}%</span></div>
                <div class="metric-row"><span class="metric-label">평균 응답</span><span class="metric-value">${Math.round(today.avgResponseTime || 0)}ms</span></div>
                <div class="metric-row"><span class="metric-label">오늘 요청</span><span class="metric-value">${fmtNum(today.totalRequests)}</span></div>
            `;
        }

        function renderCost(usage) {
            const weekly = usage.weekly || {};
            const costPerToken = 0.000001;
            const dailyCost = ((usage.today?.totalTokens || 0) * costPerToken).toFixed(4);
            const weeklyCost = ((weekly.totalTokens || 0) * costPerToken).toFixed(4);
            const monthlyCost = ((weeklyCost / 7) * 30).toFixed(3);

            document.getElementById('costSection').innerHTML = `
                <div class="cost-big">$${weeklyCost}</div>
                <div class="cost-label">주간 비용</div>
                <div class="metric-row" style="margin-top:var(--space-3)"><span class="metric-label">일간</span><span class="metric-value">$${dailyCost}</span></div>
                <div class="metric-row"><span class="metric-label">월간 예상</span><span class="metric-value">$${monthlyCost}</span></div>
            `;
        }

        function renderFeedback(data) {
            const el = document.getElementById('feedbackSection');
            if (!data || !data.data) { el.innerHTML = '<div style="color:var(--text-muted)">데이터 없음</div>'; return; }
            const d = data.data;
            el.innerHTML = `
                <div class="metric-row"><span class="metric-label">총 피드백</span><span class="metric-value">${fmtNum(d.totalFeedbacks || d.total || 0)}</span></div>
                <div class="metric-row"><span class="metric-label">평균 평점</span><span class="metric-value">${(d.avgRating || 0).toFixed(1)}/5.0</span></div>
                <div class="metric-row"><span class="metric-label">양호 비율</span><span class="metric-value">${(d.positiveRate || 0).toFixed(0)}%</span></div>
            `;
        }

        function renderAgentTable(data) {
            const el = document.getElementById('agentTable');
            const metrics = data?.data?.metrics || data?.data?.summary || [];
            if (!metrics || (Array.isArray(metrics) && metrics.length === 0)) {
                el.innerHTML = '<div class="empty-state">에이전트 성능 데이터가 없습니다.</div>';
                return;
            }
            const rows = Array.isArray(metrics) ? metrics : Object.entries(metrics).map(([k, v]) => ({ agentId: k, ...v }));
            el.innerHTML = `<table class="data-table">
                <thead><tr><th>에이전트</th><th>요청 수</th><th>평균 응답</th><th>성공률</th></tr></thead>
                <tbody>${rows.map(r => `<tr>
                    <td>${esc(r.agentId || r.name || '-')}</td>
                    <td>${fmtNum(r.totalRequests || r.requests || 0)}</td>
                    <td>${Math.round(r.avgResponseTime || 0)}ms</td>
                    <td>${(r.successRate || 0).toFixed(1)}%</td>
                </tr>`).join('')}</tbody>
            </table>`;
        }

        function renderPeakHours(hours) {
            const el = document.getElementById('peakHours');
            if (!hours || hours.length === 0) { el.innerHTML = '<div style="color:var(--text-muted)">데이터 없음</div>'; return; }
            const max = Math.max(...hours.map(h => h.requests), 1);
            el.innerHTML = hours.slice(0, 6).map(h => `
                <div style="margin-bottom:var(--space-2)">
                    <div class="metric-row"><span class="metric-label">${h.hour}시</span><span class="metric-value">${fmtNum(h.requests)}건</span></div>
                    <div class="peak-bar"><div class="peak-fill" style="width:${(h.requests/max*100)}%"></div></div>
                </div>
            `).join('');
        }

        function renderTopQueries(queries) {
            const el = document.getElementById('topQueries');
            if (!queries || queries.length === 0) { el.innerHTML = '<div style="color:var(--text-muted)">데이터 없음</div>'; return; }
            el.innerHTML = queries.slice(0, 8).map((q, i) => `
                <div class="metric-row"><span class="metric-label">${i+1}. ${esc(q.query.substring(0, 40))}</span><span class="metric-value">${q.count}회</span></div>
            `).join('');
        }

        async function loadData() {
            try {
                const [usageRes, metricsRes, feedbackRes] = await Promise.all([
                    authFetch('/api/usage'),
                    authFetch('/api/agents-monitoring/metrics'),
                    authFetch('/api/agents/feedback/stats')
                ]);
                const usage = await usageRes.json();
                const metrics = await metricsRes.json();
                const feedback = await feedbackRes.json();

                if (usage.success) {
                    renderHealth(usage.data);
                    renderCost(usage.data);
                }
                renderAgentTable(metrics);
                renderFeedback(feedback);

                // 사용자 행동은 별도 API가 없으므로 빈 상태 표시
                renderPeakHours([]);
                renderTopQueries([]);

                document.getElementById('refreshInfo').textContent = `마지막 업데이트: ${new Date().toLocaleTimeString('ko-KR')}`;
            } catch (err) {
                console.error('분석 데이터 로드 실패:', err);
                showToast('데이터 로드 실패', 'error');
            }
        }

        loadData();
        setInterval(loadData, 60000);
    </script>
</body>
</html>
