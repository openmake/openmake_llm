<!DOCTYPE html>
<html lang="ko" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>ì„¤ì • - OpenMake.Ai</title>
    <link rel="icon" type="image/png" href="/logo.png">

    <!-- í†µí•© ë””ìì¸ ì‹œìŠ¤í…œ -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/design-tokens.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layout.css">

    <style>
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4) 0;
            border-bottom: 1px solid var(--border-light);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-info h4 {
            font-size: var(--font-size-base);
            margin-bottom: var(--space-1);
        }

        .setting-info p {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border-default);
            border-radius: 26px;
            transition: 0.4s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.4s;
        }

        .toggle input:checked+.toggle-slider {
            background: var(--success);
        }

        .toggle input:checked+.toggle-slider:before {
            transform: translateX(22px);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-4);
        }

        .info-item {
            background: var(--bg-secondary);
            padding: var(--space-4);
            border-radius: var(--radius-md);
        }

        .info-label {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: var(--space-1);
        }

        .info-value {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <button class="mobile-menu-btn" onclick="toggleMobileSidebar()"><span></span><span></span><span></span></button>
        <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>
        <nav class="sidebar" id="sidebar"></nav>

        <div class="main-content">
            <div class="page-content">
                <div class="container container-md">
                    <header class="page-header">
                        <div>
                            <h1 class="page-title page-title-gradient">âš™ï¸ ì„¤ì •</h1>
                            <p class="page-subtitle">ì•± í™˜ê²½ ë° AI ëª¨ë¸ ì„¤ì •</p>
                        </div>
                    </header>

                    <div class="card" style="margin-bottom: var(--space-6);">
                        <div class="card-header"><span class="card-title">ğŸ¨ ì™¸ê´€</span></div>
                        <div class="card-body">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>í…Œë§ˆ</h4>
                                    <p>ì•±ì˜ ìƒ‰ìƒ í…Œë§ˆë¥¼ ì„ íƒí•©ë‹ˆë‹¤</p>
                                </div>
                                <select id="themeSelect" class="form-select" style="width: auto; min-width: 180px;"
                                    onchange="setTheme(this.value)">
                                    <option value="dark">ë‹¤í¬ ëª¨ë“œ</option>
                                    <option value="light">ë¼ì´íŠ¸ ëª¨ë“œ</option>
                                    <option value="system">ì‹œìŠ¤í…œ ì„¤ì •</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>ì–¸ì–´</h4>
                                    <p>ì¸í„°í˜ì´ìŠ¤ ì–¸ì–´ë¥¼ ì„ íƒí•©ë‹ˆë‹¤</p>
                                </div>
                                <select id="langSelect" class="form-select" style="width: auto; min-width: 180px;">
                                    <option value="ko">í•œêµ­ì–´</option>
                                    <option value="en">English</option>
                                    <option value="ja">æ—¥æœ¬èª</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: var(--space-6);">
                        <div class="card-header"><span class="card-title">ğŸ¤– AI ëª¨ë¸</span></div>
                        <div class="card-body">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>ê¸°ë³¸ ëª¨ë¸</h4>
                                    <p>ì±„íŒ…ì— ì‚¬ìš©í•  AI ëª¨ë¸ì„ ì„ íƒí•©ë‹ˆë‹¤</p>
                                </div>
                                <select id="modelSelect" class="form-select" style="width: auto; min-width: 200px;">
                                    <option value="openmake_llm_auto">OpenMake LLM Auto</option>
                                    <option value="openmake_llm">OpenMake LLM</option>
                                    <option value="openmake_llm_pro">OpenMake LLM Pro</option>
                                    <option value="openmake_llm_fast">OpenMake LLM Fast</option>
                                    <option value="openmake_llm_think">OpenMake LLM Think</option>
                                    <option value="openmake_llm_code">OpenMake LLM Code</option>
                                    <option value="openmake_llm_vision">OpenMake LLM Vision</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>Sequential Thinking</h4>
                                    <p>Chain-of-Thought ì¶”ë¡  í™œì„±í™”</p>
                                </div>
                                <label class="toggle"><input type="checkbox" checked id="thinkingToggle"><span
                                        class="toggle-slider"></span></label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>ì›¹ ê²€ìƒ‰</h4>
                                    <p>ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ ê¸°ëŠ¥ í™œì„±í™”</p>
                                </div>
                                <label class="toggle"><input type="checkbox" checked id="webSearchToggle"><span
                                        class="toggle-slider"></span></label>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: var(--space-6);">
                        <div class="card-header"><span class="card-title">ğŸ’¾ ë°ì´í„°</span></div>
                        <div class="card-body">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>ëŒ€í™” ê¸°ë¡ ì €ì¥</h4>
                                    <p>ëŒ€í™” ë‚´ìš©ì„ ì„œë²„ì— ì €ì¥í•©ë‹ˆë‹¤</p>
                                </div>
                                <label class="toggle"><input type="checkbox" checked id="saveHistoryToggle"><span
                                        class="toggle-slider"></span></label>
                            </div>
                            <div style="display: flex; gap: var(--space-3); margin-top: var(--space-4);">
                                <button class="btn btn-secondary" onclick="exportData()">ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
                                <button class="btn btn-danger" onclick="clearHistory()">ğŸ—‘ï¸ ê¸°ë¡ ì‚­ì œ</button>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: var(--space-6);">
                        <div class="card-header"><span class="card-title">â„¹ï¸ ì‹œìŠ¤í…œ ì •ë³´</span></div>
                        <div class="card-body">
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">ë²„ì „</div>
                                    <div class="info-value" id="sysVersion">ë¡œë”©...</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">ì„œë²„ ìƒíƒœ</div>
                                    <div class="info-value" id="sysStatus">í™•ì¸ ì¤‘...</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">í™œì„± ë…¸ë“œ</div>
                                    <div class="info-value" id="sysNodes">-</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
                                    <div class="info-value" id="sysLastUpdate">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: var(--space-3);">
                        <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ ì„¤ì • ì €ì¥</button>
                        <button class="btn btn-secondary" onclick="resetSettings()">â†©ï¸ ì´ˆê¸°í™”</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/components/sidebar.js"></script>
    <script>
        // ê´€ë¦¬ì í™•ì¸ í—¬í¼
        function isAdmin() {
            const savedUser = localStorage.getItem('user');
            if (!savedUser) return false;
            try {
                const user = JSON.parse(savedUser);
                return user.role === 'admin' || user.role === 'administrator';
            } catch (e) { return false; }
        }

        async function loadModels() {
            const modelSelect = document.getElementById('modelSelect');

            // ğŸ”’ ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ëª¨ë¸ ì´ë¦„ ìˆ¨ê¹€
            if (!isAdmin()) {
                modelSelect.innerHTML = '<option value="openmake_llm_auto">OpenMake LLM Auto</option>';
                modelSelect.disabled = true;
                modelSelect.style.cursor = 'default';
                return;
            }

            try {
                const response = await fetch('/api/models');
                if (response.ok) {
                    const rawData = await response.json();
                    const data = rawData.data || rawData;
                    if (data.models && data.models.length > 0) {
                        const savedModel = localStorage.getItem('selectedModel');
                        const defaultModel = data.defaultModel || 'openmake_llm_auto';

                        modelSelect.innerHTML = data.models.map(model => {
                            const modelId = model.modelId || model.name;
                            const displayName = model.name;
                            const desc = model.description || '';
                            const isSelected = savedModel ? modelId === savedModel : modelId === defaultModel;
                            return `<option value="${modelId}" ${isSelected ? 'selected' : ''}>${displayName}${desc ? ' â€” ' + desc : ''}</option>`;
                        }).join('');
                    }
                }
            } catch (e) {
                console.error('ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨:', e);
                const savedModel = localStorage.getItem('selectedModel');
                if (savedModel) modelSelect.innerHTML = `<option value="${savedModel}">${savedModel}</option>`;
            }
        }

        async function loadSystemInfo() {
            try {
                const res = await fetch('/health');
                if (res.ok) {
                    const json = await res.json();
                    const d = json.data || json;
                    const verEl = document.getElementById('sysVersion');
                    const statusEl = document.getElementById('sysStatus');
                    const nodesEl = document.getElementById('sysNodes');
                    const updateEl = document.getElementById('sysLastUpdate');
                    if (verEl) verEl.textContent = 'v' + (d.version || '?');
                    if (statusEl) {
                        statusEl.textContent = 'â— ' + (d.status === 'healthy' ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸');
                        statusEl.style.color = d.status === 'healthy' ? 'var(--success)' : 'var(--error)';
                    }
                    if (nodesEl && d.cluster) {
                        nodesEl.textContent = d.cluster.onlineNodes + '/' + d.cluster.totalNodes + ' (' + d.cluster.totalModels + ' ëª¨ë¸)';
                    }
                    if (updateEl && d.build && d.build.gitDate) {
                        updateEl.textContent = d.build.gitDate;
                    }
                }
            } catch (e) { console.warn('ì‹œìŠ¤í…œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', e); }
        }

        async function initSettings() { await loadModels(); loadSettings(); loadSystemInfo(); }

        function setTheme(theme) { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); }

        function saveSettings() {
            setTheme(document.getElementById('themeSelect').value);
            localStorage.setItem('selectedModel', document.getElementById('modelSelect').value);
            const mcpSettings = JSON.parse(localStorage.getItem('mcpSettings') || '{}');
            mcpSettings.thinking = document.getElementById('thinkingToggle').checked;
            mcpSettings.webSearch = document.getElementById('webSearchToggle').checked;
            localStorage.setItem('mcpSettings', JSON.stringify(mcpSettings));
            localStorage.setItem('generalSettings', JSON.stringify({ lang: document.getElementById('langSelect').value, saveHistory: document.getElementById('saveHistoryToggle').checked }));
            alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function loadSettings() {
            const theme = localStorage.getItem('theme') || 'dark';
            document.getElementById('themeSelect').value = theme;
            setTheme(theme);
            const selectedModel = localStorage.getItem('selectedModel');
            if (selectedModel && [...document.getElementById('modelSelect').options].some(o => o.value === selectedModel)) document.getElementById('modelSelect').value = selectedModel;
            const savedMcp = localStorage.getItem('mcpSettings');
            if (savedMcp) { const mcp = JSON.parse(savedMcp); document.getElementById('thinkingToggle').checked = mcp.thinking !== false; document.getElementById('webSearchToggle').checked = mcp.webSearch === true; }
            const savedGeneral = localStorage.getItem('generalSettings');
            if (savedGeneral) { const general = JSON.parse(savedGeneral); document.getElementById('langSelect').value = general.lang || 'ko'; document.getElementById('saveHistoryToggle').checked = general.saveHistory !== false; }
        }

        function resetSettings() { if (confirm('ëª¨ë“  ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { localStorage.removeItem('theme'); localStorage.removeItem('selectedModel'); localStorage.removeItem('mcpSettings'); localStorage.removeItem('generalSettings'); location.reload(); } }
        function exportData() { alert('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.'); }
        function clearHistory() { if (confirm('ëª¨ë“  ëŒ€í™” ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) alert('ëŒ€í™” ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); }

        initSettings();
    </script>
</body>

</html>