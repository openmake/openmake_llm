<!DOCTYPE html>
<html lang="ko" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>í†µí•© ì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ - OpenMake</title>
    <link rel="icon" type="image/png" href="/logo.png">

    <!-- í†µí•© ë””ìì¸ ì‹œìŠ¤í…œ -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/design-tokens.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/pages/dashboard.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        /* í† í° ëª¨ë‹ˆí„°ë§ ì „ìš© ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .cost-display {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-primary);
            text-align: center;
            margin: 10px 0;
        }

        .cost-currency {
            font-size: 1rem;
            opacity: 0.7;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.safe {
            background: var(--success);
        }

        .progress-fill.warning {
            background: var(--warning);
        }

        .progress-fill.critical {
            background: var(--danger);
        }

        .chart-container-custom {
            position: relative;
            height: 250px;
            width: 100%;
        }

        .key-item {
            padding: 12px;
            border-radius: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .key-item.active {
            border-color: var(--success);
            background: rgba(var(--success-rgb), 0.05);
            /* ê·¼ì‚¬ì¹˜ */
        }

        .key-item.warning {
            border-color: var(--warning);
        }

        .monitoring-section {
            margin-top: var(--space-8);
        }

        .card-icon {
            font-size: 1.2rem;
            margin-left: auto;
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar"></nav>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <div class="page-content">
                <div class="container container-xl">
                    <header class="page-header">
                        <div>
                            <h1 class="page-title page-title-gradient">ğŸ“Š í†µí•© ì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ</h1>
                            <p class="page-subtitle" id="lastUpdated">ì‹œìŠ¤í…œ ìƒíƒœ ë° API í† í° ëª¨ë‹ˆí„°ë§</p>
                        </div>
                        <div class="page-actions">
                            <button class="btn btn-primary" onclick="loadAllData()">
                                ğŸ”„ ìƒˆë¡œê³ ì¹¨
                            </button>
                        </div>
                    </header>

                    <!-- 1. System Metrics (ê¸°ì¡´) -->
                    <div class="dashboard-grid">
                        <div class="metric-card card">
                            <div class="metric-card-header">
                                <span class="metric-card-title">ì‹œìŠ¤í…œ ì—…íƒ€ì„</span>
                                <span class="status-dot online"></span>
                            </div>
                            <div class="metric-card-value" id="uptime">0ì‹œê°„</div>
                        </div>

                        <div class="metric-card card">
                            <div class="metric-card-header">
                                <span class="metric-card-title">ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰</span>
                            </div>
                            <div class="metric-card-value" id="memoryUsage">0 MB</div>
                            <div class="metric-card-change" id="memoryBadgeSpan"><span class="badge badge-success"
                                    id="memoryBadge">ì •ìƒ</span></div>
                        </div>

                        <div class="metric-card card">
                            <div class="metric-card-header">
                                <span class="metric-card-title">í™œì„± ì—°ê²°</span>
                            </div>
                            <div class="metric-card-value" id="activeConnections">0</div>
                        </div>

                        <div class="metric-card card">
                            <div class="metric-card-header">
                                <span class="metric-card-title">ì˜¤ëŠ˜ ìš”ì²­</span>
                            </div>
                            <div class="metric-card-value" id="todayRequests">0</div>
                            <div class="metric-card-change" id="todayTokens">0 í† í°</div>
                        </div>
                    </div>

                    <!-- 2. API Key Monitoring (ì‹ ê·œ) -->
                    <div class="monitoring-section">
                        <div class="section-header">
                            <span class="section-icon">ğŸ”</span>
                            <span class="section-title">API í‚¤ ìƒíƒœ ë° ëª¨ë‹ˆí„°ë§</span>
                        </div>

                        <div class="dashboard-grid">
                            <!-- API Keys Status -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">API í‚¤ ë¡œí…Œì´ì…˜</span>
                                    <span class="card-icon">ğŸ”‘</span>
                                </div>
                                <div id="keyStatusContainer" style="padding: 10px;">
                                    <div class="text-muted">ë¡œë”© ì¤‘...</div>
                                </div>
                                <div class="card-footer"
                                    style="padding: 10px; border-top: 1px solid var(--border-light);">
                                    <button class="btn btn-sm btn-outline" onclick="resetKeys()" style="width: 100%;">í‚¤
                                        ìƒíƒœ ë¦¬ì…‹</button>
                                </div>
                            </div>

                            <!-- Cost Tracker -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">ì˜¤ëŠ˜ ì˜ˆìƒ ë¹„ìš©</span>
                                    <span class="card-icon">ğŸ’°</span>
                                </div>
                                <div class="card-body"
                                    style="display: flex; flex-direction: column; justify-content: center; height: 150px;">
                                    <div class="cost-display">
                                        <span class="cost-currency">$</span>
                                        <span id="todayCost">0.0000</span>
                                    </div>
                                    <div class="text-center text-muted text-sm" id="costDetails">
                                        ë°ì´í„° ì§‘ê³„ ì¤‘...
                                    </div>
                                </div>
                            </div>

                            <!-- Quota Status -->
                            <div class="card" style="grid-column: span 2;">
                                <div class="card-header">
                                    <span class="card-title">í• ë‹¹ëŸ‰ í˜„í™©</span>
                                    <span class="badge" id="quotaWarningBadge">ì •ìƒ</span>
                                </div>
                                <div id="quotaSection" class="card-body"
                                    style="display: flex; flex-direction: column; gap: 15px;">
                                    <!-- ë¡œë”© ì¤‘ -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Usage Charts (ì‹ ê·œ - Chart.js) -->
                    <div class="monitoring-section">
                        <div class="grid-2">
                            <!-- Hourly Chart -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">ì‹œê°„ë³„ ìš”ì²­ (ì˜¤ëŠ˜)</span>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container-custom">
                                        <canvas id="hourlyChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Daily Chart -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">ì¼ê°„ íŠ¸ë˜í”½ (ìµœê·¼ 7ì¼)</span>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container-custom">
                                        <canvas id="dailyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Cluster Nodes (ê¸°ì¡´) -->
                    <div class="monitoring-section" style="margin-bottom: 50px;">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">í´ëŸ¬ìŠ¤í„° ë…¸ë“œ ì •ë³´</span>
                            </div>
                            <div class="node-grid" id="nodesContainer" style="padding: var(--space-4);">
                                <div class="text-muted text-center">ë…¸ë“œ ì •ë³´ ë¡œë”© ì¤‘...</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Component -->
    <script src="/js/components/sidebar.js"></script>

    <script>
        // ì „ì—­ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
        let hourlyChart = null;
        let dailyChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            // 1. ì´ˆê¸° ë¡œë“œ
            loadAllData();

            // 2. ì£¼ê¸°ì  ê°±ì‹ 
            const interval = setInterval(loadAllData, 30000); // 30ì´ˆ

            window.addEventListener('beforeunload', () => {
                clearInterval(interval);
            });
        });

        // í†µí•© ë°ì´í„° ë¡œë“œ
        async function loadAllData() {
            updateTime();
            await Promise.all([
                loadSystemMetrics(),    // ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ (ê¸°ì¡´)
                loadMonitoringData()    // í† í° ëª¨ë‹ˆí„°ë§ + ì°¨íŠ¸ + ë¹„ìš© (ì‹ ê·œ)
            ]);
        }

        function updateTime() {
            document.getElementById('lastUpdated').textContent =
                `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString()}`;
        }

        // --- System Metrics Logic ---
        async function loadSystemMetrics() {
            try {
                const response = await fetch('/api/metrics');
                const rawData = await response.json();
                // api-response í‘œì¤€ í˜•ì‹: rawData.data ì•ˆì— ì‹¤ì œ ë°ì´í„°
                const data = rawData.data || rawData;

                if (data.system) {
                    const uptime = Math.floor(data.system.uptime);
                    const hours = Math.floor(uptime / 3600);
                    const minutes = Math.floor((uptime % 3600) / 60);
                    document.getElementById('uptime').textContent = `${hours}ì‹œê°„ ${minutes}ë¶„`;

                    const memoryMB = Math.round(data.system.memoryUsage.heapUsed / 1024 / 1024);
                    document.getElementById('memoryUsage').textContent = `${memoryMB} MB`;

                    const badge = document.querySelector('#memoryBadge');
                    if (badge) {
                        badge.className = memoryMB > 500 ? 'badge badge-warning' : 'badge badge-success';
                        badge.textContent = memoryMB > 500 ? 'ì£¼ì˜' : 'ì •ìƒ';
                    }

                    document.getElementById('activeConnections').textContent = data.system.activeConnections || 0;
                }

                if (data.cluster && data.cluster.nodes) {
                    const nodesContainer = document.getElementById('nodesContainer');
                    const nodes = data.cluster.nodes;
                    if (nodes.length === 0) {
                        nodesContainer.innerHTML = `<p class="text-muted text-center">ë“±ë¡ëœ ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤</p>`;
                    } else {
                        nodesContainer.innerHTML = nodes.map(node => `
                            <div class="node-card">
                                <div class="node-header">
                                    <span class="node-name">${node.name || node.id}</span>
                                    <span class="status-dot ${node.status === 'online' ? 'online' : 'offline'}"></span>
                                </div>
                                <div class="node-stats">
                                    <span class="text-muted">${node.latency ? node.latency + 'ms' : '-'}</span>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // --- Token Monitoring Logic ---
        async function loadMonitoringData() {
            await Promise.all([
                loadKeyStatus(),
                loadQuotaStatus(),
                loadSummary(),
                loadCosts(),
                loadHourlyChart(),
                loadDailyChart()
            ]);
        }

        // API í‚¤ ìƒíƒœ
        async function loadKeyStatus() {
            try {
                const res = await fetch('/api/monitoring/keys');
                const rawData = await res.json();
                const data = rawData.data || rawData;

                const container = document.getElementById('keyStatusContainer');
                container.innerHTML = data.keys.map(key => `
                    <div class="key-item ${key.isActive ? 'active' : ''} ${key.failCount > 0 ? 'warning' : ''}">
                        <div>
                            <div style="font-weight: 600; font-size: 0.9rem;">Key ${key.index}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${key.keyId}</div>
                        </div>
                        <div style="text-align: right;">
                             <span class="badge ${key.isActive ? 'badge-success' : (key.failCount > 0 ? 'badge-warning' : 'badge')}">
                                ${key.isActive ? 'í™œì„±' : (key.failCount > 0 ? `ì‹¤íŒ¨ ${key.failCount}` : 'ëŒ€ê¸°')}
                             </span>
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        // í• ë‹¹ëŸ‰ ìƒíƒœ
        async function loadQuotaStatus() {
            try {
                const res = await fetch('/api/monitoring/quota');
                const rawData = await res.json();
                const data = rawData.data || rawData;

                const container = document.getElementById('quotaSection');

                // ì‹œê°„, ì£¼ê°„, ì¼ê°„ (ìˆœì„œëŒ€ë¡œ)
                const items = [
                    { label: 'ì‹œê°„ë‹¹', data: data.hourly },
                    { label: 'ì¼ê°„ (ì¶”ì •)', data: data.daily },
                    { label: 'ì£¼ê°„', data: data.weekly }
                ];

                container.innerHTML = items.map(item => `
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span class="text-sm font-medium">${item.label} (${item.data.used}/${item.data.limit})</span>
                            <span class="text-sm font-bold">${item.data.percentage}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${getProgressClass(item.data.percentage)}" 
                                 style="width: ${Math.min(item.data.percentage, 100)}%"></div>
                        </div>
                    </div>
                `).join('');

                // ê²½ê³  ë°°ì§€
                const badge = document.getElementById('quotaWarningBadge');
                badge.className = `badge ${data.warningLevel === 'safe' ? 'badge-success' : data.warningLevel === 'warning' ? 'badge-warning' : 'badge-danger'}`;
                badge.textContent = data.warningLevel === 'safe' ? 'ì •ìƒ' : (data.warningLevel === 'warning' ? 'ì£¼ì˜' : 'ìœ„í—˜');

            } catch (e) { console.error(e); }
        }

        // í†µê³„ ìš”ì•½ (ì˜¤ëŠ˜)
        async function loadSummary() {
            try {
                const res = await fetch('/api/monitoring/summary');
                const rawData = await res.json();
                const data = rawData.data || rawData;

                document.getElementById('todayRequests').textContent = data.today.totalRequests.toLocaleString();
                document.getElementById('todayTokens').textContent = `${formatTokens(data.today.totalTokens)} í† í°`;
            } catch (e) { console.error(e); }
        }

        // ë¹„ìš©
        async function loadCosts() {
            try {
                const res = await fetch('/api/monitoring/costs');
                const rawData = await res.json();
                const data = rawData.data || rawData;

                document.getElementById('todayCost').textContent = data.today.totalCost.toFixed(4);
                document.getElementById('costDetails').textContent =
                    `ìš”ì²­: ${data.today.totalRequests}íšŒ | í† í°: ${formatTokens(data.today.totalTokens)}`;
            } catch (e) { console.error(e); }
        }

        // ì‹œê°„ë³„ ì°¨íŠ¸
        async function loadHourlyChart() {
            try {
                const res = await fetch('/api/monitoring/usage/hourly');
                const rawData = await res.json();
                const data = rawData.data || rawData;
                const ctx = document.getElementById('hourlyChart').getContext('2d');

                if (hourlyChart) hourlyChart.destroy();

                hourlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'ìš”ì²­ ìˆ˜',
                            data: data.datasets.requests,
                            backgroundColor: 'rgba(137, 180, 250, 0.6)',
                            borderColor: 'rgba(137, 180, 250, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: getChartOptions()
                });
            } catch (e) { console.error(e); }
        }

        // ì¼ê°„ ì°¨íŠ¸
        async function loadDailyChart() {
            try {
                const res = await fetch('/api/monitoring/usage/daily?days=7');
                const rawData = await res.json();
                const data = rawData.data || rawData;
                const ctx = document.getElementById('dailyChart').getContext('2d');

                if (dailyChart) dailyChart.destroy();

                dailyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'ìš”ì²­ ìˆ˜',
                                data: data.datasets.requests,
                                borderColor: 'rgba(137, 180, 250, 1)',
                                backgroundColor: 'rgba(137, 180, 250, 0.2)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'ì—ëŸ¬',
                                data: data.datasets.errors,
                                borderColor: 'rgba(243, 139, 168, 1)',
                                backgroundColor: 'rgba(243, 139, 168, 0.2)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: getChartOptions()
                });
            } catch (e) { console.error(e); }
        }

        // ì°¨íŠ¸ ì˜µì…˜ ê³µí†µ
        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false } // ê¹”ë”í•˜ê²Œ ë ˆì „ë“œ ìˆ¨ê¹€
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#a6adc8' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#a6adc8' }
                    }
                }
            };
        }

        // í‚¤ ë¦¬ì…‹
        async function resetKeys() {
            if (!confirm('ëª¨ë“  API í‚¤ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                await fetch('/api/monitoring/keys/reset', { method: 'POST' });
                alert('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadKeyStatus();
            } catch (e) { alert('ì‹¤íŒ¨: ' + e.message); }
        }

        // ìœ í‹¸ë¦¬í‹°
        function getProgressClass(percentage) {
            if (percentage >= 90) return 'critical';
            if (percentage >= 70) return 'warning';
            return 'safe';
        }

        function formatTokens(tokens) {
            if (tokens >= 1000000) return (tokens / 1000000).toFixed(1) + 'M';
            if (tokens >= 1000) return (tokens / 1000).toFixed(1) + 'K';
            return tokens.toString();
        }
    </script>
</body>

</html>