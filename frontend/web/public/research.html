<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>딥 리서치 - OpenMake.Ai</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/design-tokens.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layout.css">
    <style>
        .new-research { background:var(--bg-card); border:1px solid var(--border-light); border-radius:var(--radius-lg); padding:var(--space-5); margin-bottom:var(--space-5); display:flex; gap:var(--space-3); align-items:flex-end; flex-wrap:wrap; }
        .new-research .form-group { flex:1; min-width:200px; margin:0; }
        .new-research label { display:block; margin-bottom:var(--space-2); color:var(--text-secondary); font-size:var(--font-size-sm); font-weight:var(--font-weight-semibold); }
        .new-research input, .new-research select { width:100%; padding:var(--space-3); background:var(--bg-secondary); border:1px solid var(--border-light); border-radius:var(--radius-md); color:var(--text-primary); box-sizing:border-box; }
        .btn-primary { padding:var(--space-3) var(--space-5); background:var(--accent-primary); color:#fff; border:none; border-radius:var(--radius-md); cursor:pointer; font-weight:var(--font-weight-semibold); white-space:nowrap; }
        .session-list { display:flex; flex-direction:column; gap:var(--space-4); }
        .session-card { background:var(--bg-card); border:1px solid var(--border-light); border-radius:var(--radius-lg); padding:var(--space-5); cursor:pointer; transition:border-color .2s; }
        .session-card:hover { border-color:var(--accent-primary); }
        .session-card h3 { margin:0 0 var(--space-2); color:var(--text-primary); }
        .session-meta { display:flex; gap:var(--space-3); align-items:center; flex-wrap:wrap; font-size:var(--font-size-sm); color:var(--text-muted); }
        .badge { display:inline-block; padding:2px 10px; border-radius:var(--radius-md); font-size:11px; font-weight:var(--font-weight-semibold); }
        .badge-pending { background:var(--bg-tertiary); color:var(--text-muted); }
        .badge-running { background:var(--accent-primary); color:#fff; animation:pulse 1.5s infinite; }
        .badge-completed { background:var(--success); color:#fff; }
        .badge-failed { background:var(--danger); color:#fff; }
        .badge-cancelled { background:var(--warning); color:#000; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.6} }
        .progress-bar { height:6px; background:var(--bg-tertiary); border-radius:3px; margin-top:var(--space-2); overflow:hidden; }
        .progress-fill { height:100%; background:var(--accent-primary); border-radius:3px; transition:width .3s; }
        .empty-state { text-align:center; padding:var(--space-8); color:var(--text-muted); }
        .empty-state h2 { color:var(--text-secondary); margin-bottom:var(--space-3); }

        .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; justify-content:center; align-items:center; }
        .modal-overlay.open { display:flex; }
        .modal { background:var(--bg-card); border:1px solid var(--border-light); border-radius:var(--radius-lg); width:90%; max-width:700px; max-height:90vh; overflow-y:auto; padding:var(--space-6); }
        .modal h2 { margin:0 0 var(--space-4); color:var(--text-primary); }
        .detail-section { margin-bottom:var(--space-5); }
        .detail-section h3 { color:var(--text-secondary); font-size:var(--font-size-sm); margin-bottom:var(--space-2); text-transform:uppercase; letter-spacing:.5px; }
        .detail-section p, .detail-section li { color:var(--text-primary); line-height:1.6; }
        .detail-section ul { padding-left:var(--space-5); }
        .steps-timeline { border-left:2px solid var(--border-light); padding-left:var(--space-5); }
        .step-item { margin-bottom:var(--space-4); position:relative; }
        .step-item::before { content:''; position:absolute; left:calc(-1 * var(--space-5) - 5px); top:4px; width:8px; height:8px; border-radius:50%; background:var(--accent-primary); }
        .step-num { font-weight:var(--font-weight-semibold); color:var(--accent-primary); }
        .step-type { background:var(--bg-tertiary); padding:2px 8px; border-radius:var(--radius-md); font-size:11px; color:var(--text-secondary); }
        .step-result { background:var(--bg-secondary); padding:var(--space-3); border-radius:var(--radius-md); margin-top:var(--space-2); font-size:var(--font-size-sm); color:var(--text-secondary); max-height:120px; overflow-y:auto; white-space:pre-wrap; }
        .modal-actions { display:flex; gap:var(--space-3); justify-content:flex-end; margin-top:var(--space-5); }
        .modal-actions button { padding:var(--space-2) var(--space-4); border:none; border-radius:var(--radius-md); cursor:pointer; font-weight:var(--font-weight-semibold); }
        .btn-secondary { background:var(--bg-tertiary); color:var(--text-primary); border:1px solid var(--border-light) !important; }
        .btn-danger { background:var(--danger); color:#fff; }
        .toast { position:fixed; bottom:20px; right:20px; padding:var(--space-3) var(--space-5); border-radius:var(--radius-md); color:#fff; z-index:2000; opacity:0; transition:opacity .3s; }
        .toast.show { opacity:1; } .toast.success { background:var(--success); } .toast.error { background:var(--danger); }
        .loading { text-align:center; padding:var(--space-6); color:var(--text-muted); }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar" id="sidebar"></aside>
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <main class="main-content">
            <header class="page-header">
                <button class="mobile-menu-btn" onclick="toggleMobileSidebar(event)">&#9776;</button>
                <h1>딥 리서치</h1>
            </header>
            <div class="content-area">
                <div class="new-research">
                    <div class="form-group" style="flex:3"><label>연구 주제</label><input type="text" id="topic" placeholder="연구하고 싶은 주제를 입력하세요..."></div>
                    <div class="form-group" style="flex:1"><label>깊이</label>
                        <select id="depth"><option value="quick">빠른 검색</option><option value="standard" selected>표준</option><option value="deep">심층</option></select>
                    </div>
                    <button class="btn-primary" onclick="createSession()">연구 시작</button>
                </div>
                <div id="sessionList" class="session-list"><div class="loading">불러오는 중...</div></div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <h2 id="detailTitle">연구 상세</h2>
            <div id="detailContent"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeDetail()">닫기</button>
                <button class="btn-danger" id="btnDeleteSession" onclick="deleteSession()">삭제</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script src="/js/components/sidebar.js"></script>
    <script>
        function authFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            const headers = { 'Content-Type': 'application/json', ...(token ? { 'Authorization': 'Bearer ' + token } : {}), ...options.headers };
            return fetch(url, { ...options, headers }).then(r => r.json());
        }
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            t.textContent = msg; t.className = 'toast ' + type + ' show';
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

        const statusLabels = { pending:'대기중', running:'진행중', completed:'완료', failed:'실패', cancelled:'취소됨' };
        const depthLabels = { quick:'빠른 검색', standard:'표준', deep:'심층' };
        let currentSessionId = null;

        async function loadSessions() {
            try {
                const res = await authFetch('/api/research/sessions');
                const sessions = res.data || res || [];
                const el = document.getElementById('sessionList');
                if (!sessions.length) {
                    el.innerHTML = '<div class="empty-state"><h2>연구 세션이 없습니다</h2><p>위에서 주제를 입력하고 연구를 시작하세요.</p></div>';
                    return;
                }
                el.innerHTML = sessions.map(s => `
                    <div class="session-card" onclick="openSession('${s.id}')">
                        <h3>${esc(s.topic)}</h3>
                        <div class="session-meta">
                            <span class="badge badge-${s.status}">${statusLabels[s.status] || s.status}</span>
                            <span>${depthLabels[s.depth] || s.depth}</span>
                            <span>${new Date(s.created_at).toLocaleDateString('ko')}</span>
                        </div>
                        ${s.progress > 0 ? `<div class="progress-bar"><div class="progress-fill" style="width:${s.progress}%"></div></div>` : ''}
                    </div>`).join('');
            } catch (e) { showToast('세션 로드 실패', 'error'); }
        }

        async function createSession() {
            const topic = document.getElementById('topic').value.trim();
            if (!topic) { showToast('주제를 입력하세요', 'error'); return; }
            try {
                await authFetch('/api/research/sessions', { method: 'POST', body: JSON.stringify({ topic, depth: document.getElementById('depth').value }) });
                document.getElementById('topic').value = '';
                showToast('연구가 시작되었습니다');
                loadSessions();
            } catch (e) { showToast('생성 실패', 'error'); }
        }

        async function openSession(id) {
            currentSessionId = id;
            document.getElementById('detailModal').classList.add('open');
            document.getElementById('detailContent').innerHTML = '<div class="loading">불러오는 중...</div>';
            try {
                const res = await authFetch('/api/research/sessions/' + id);
                const s = res.data || res;
                const stepsRes = await authFetch('/api/research/sessions/' + id + '/steps');
                const steps = stepsRes.data || stepsRes || [];

                document.getElementById('detailTitle').textContent = s.topic;
                let html = `
                    <div class="session-meta" style="margin-bottom:var(--space-4)">
                        <span class="badge badge-${s.status}">${statusLabels[s.status] || s.status}</span>
                        <span>${depthLabels[s.depth] || s.depth}</span>
                        <span>진행률: ${s.progress || 0}%</span>
                    </div>`;
                if (s.summary) html += `<div class="detail-section"><h3>요약</h3><p>${esc(s.summary)}</p></div>`;
                const findings = s.key_findings || [];
                if (findings.length) html += `<div class="detail-section"><h3>주요 발견</h3><ul>${findings.map(f => '<li>' + esc(f) + '</li>').join('')}</ul></div>`;
                const sources = s.sources || [];
                if (sources.length) html += `<div class="detail-section"><h3>출처</h3><ul>${sources.map(src => '<li>' + esc(typeof src === 'string' ? src : JSON.stringify(src)) + '</li>').join('')}</ul></div>`;
                if (steps.length) {
                    html += `<div class="detail-section"><h3>연구 단계</h3><div class="steps-timeline">`;
                    html += steps.map(st => `
                        <div class="step-item">
                            <span class="step-num">#${st.step_number}</span> <span class="step-type">${esc(st.step_type)}</span>
                            ${st.query ? `<div style="color:var(--text-secondary);margin-top:var(--space-1)">${esc(st.query)}</div>` : ''}
                            ${st.result ? `<div class="step-result">${esc(st.result)}</div>` : ''}
                        </div>`).join('');
                    html += '</div></div>';
                }
                document.getElementById('detailContent').innerHTML = html;
            } catch (e) { document.getElementById('detailContent').innerHTML = '<div class="empty-state"><p>로드 실패</p></div>'; }
        }

        function closeDetail() { document.getElementById('detailModal').classList.remove('open'); }

        async function deleteSession() {
            if (!currentSessionId || !confirm('이 연구 세션을 삭제하시겠습니까?')) return;
            try {
                await authFetch('/api/research/sessions/' + currentSessionId, { method: 'DELETE' });
                showToast('세션이 삭제되었습니다'); closeDetail(); loadSessions();
            } catch (e) { showToast('삭제 실패', 'error'); }
        }

        document.getElementById('topic').addEventListener('keydown', e => { if (e.key === 'Enter') createSession(); });
        loadSessions();
    </script>
</body>
</html>
